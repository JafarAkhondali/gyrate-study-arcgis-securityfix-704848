(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-7f51cf1f","chunk-342283ac","chunk-792b91aa","chunk-546fd515","chunk-479b5802","chunk-aa6dbf6a","chunk-2d222178","chunk-2d0a2d38"],{"0024":function(e,t,i){"use strict";var r=i("a4ee"),a=(i("c120"),i("e92d"),i("cea0"),i("59b2")),n=i("d386"),s=(i("e041"),i("8eed"),i("f402"),i("6a0e")),o=i("a9ab");let c=class extends s["a"]{constructor(e){super(e),this.geometries=null,this.outSpatialReference=null,this.transformation=null,this.transformForward=null}toJSON(){const e=this.geometries.map((function(e){return e.toJSON()})),t=this.geometries[0],i={};return i.outSR=this.outSpatialReference.wkid||JSON.stringify(this.outSpatialReference.toJSON()),i.inSR=t.spatialReference.wkid||JSON.stringify(t.spatialReference.toJSON()),i.geometries=JSON.stringify({geometryType:Object(o["c"])(t),geometries:e}),this.transformation&&(i.transformation=this.transformation.wkid||JSON.stringify(this.transformation)),null!=this.transformForward&&(i.transformForward=this.transformForward),i}};Object(r["a"])([Object(a["b"])()],c.prototype,"geometries",void 0),Object(r["a"])([Object(a["b"])({json:{read:{source:"outSR"}}})],c.prototype,"outSpatialReference",void 0),Object(r["a"])([Object(a["b"])()],c.prototype,"transformation",void 0),Object(r["a"])([Object(a["b"])()],c.prototype,"transformForward",void 0),c=Object(r["a"])([Object(n["a"])("esri.tasks.support.ProjectParameters")],c);var l=c;t["a"]=l},"002c":function(e,t,i){"use strict";i.d(t,"a",(function(){return y}));var r=i("b2b2"),a=i("38a4"),n=i("0b2d"),s=i("e431"),o=i("8188"),c=i("0fc4"),l=i("7577"),h=i("4261"),d=i("f091"),u=i("caf7"),p=i("2df1"),f=i("2e0f"),m=i("0eb9"),b=i("a6c9"),g=i("1e2c"),v=i("dd63");class y{constructor(e){this.view=null,this._geometry=null,this._size=3,this._color=Object(c["d"])(1,0,1,1),this._pixelSnappingEnabled=!0,this._primitive="square",this._outlineSize=1,this._outlineColor=Object(c["d"])(1,1,1,1),this._elevationInfo=null,this.resources=new v["a"]({view:e.view,createResources:e=>this.createResources(e),recreateGeometry:(e,t)=>(e.geometry=this.recreateGeometry(t,e.material),Object(r["k"])(e.geometry)?[e.geometry]:[])});let t=!0;for(const i in e)i in this?"attached"===i?t=e[i]:this[i]=e[i]:console.error("Cannot set unknown property",i);this.attached=t}destroy(){this.resources.destroy()}get visible(){return this.resources.visible}set visible(e){this.resources.visible=e}get attached(){return this.resources.attached}set attached(e){this.resources.attached=e}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.resources.recreateGeometry()}get size(){return this._size}set size(e){if(e!==this._size){const t=this.preferredTextureSize;this._size=e,t<this.preferredTextureSize?Object(r["k"])(this.resources)&&this.resources.recreate():this.updateSizeAttribute()}}get color(){return this._color}set color(e){Object(l["g"])(e,this._color)||(Object(l["c"])(this._color,e),this.updateMaterial())}get pixelSnappingEnabled(){return this._pixelSnappingEnabled}set pixelSnappingEnabled(e){this._pixelSnappingEnabled!==e&&(this._pixelSnappingEnabled=e,this.updateMaterial())}get primitive(){return this._primitive}set primitive(e){this._primitive!==e&&(this._primitive=e,Object(r["k"])(this.resources)&&this.resources.recreate())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this.updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){Object(l["g"])(e,this._outlineColor)||(Object(l["c"])(this._outlineColor,e),this.updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.resources&&this.resources.recreateGeometry()}updateMaterial(){const e=this.resources.resources;Object(r["j"])(e)||e.material.setParameterValues(this.materialParameters(e.texture.id))}updateSizeAttribute(){const e=this.resources.resources,t=this.resources.object;if(Object(r["j"])(e)||Object(r["j"])(t))return;const i=e.geometry;if(Object(r["j"])(i))return;const a=i.getMutableAttribute("size").data,n=this.geometrySize;a[0]=n,a[1]=n,t.geometryVertexAttrsUpdated(0)}materialParameters(e){return{color:this._color,textureIsSignedDistanceField:!0,distanceFieldBoundingBox:_,occlusionTest:!1,outlineColor:this._outlineColor,outlineSize:this._outlineSize,textureId:e,polygonOffset:!1,shaderPolygonOffset:0,drawInSecondSlot:!0,depthEnabled:!1,pixelSnappingEnabled:this.pixelSnappingEnabled}}get geometrySize(){return this._size/O}recreateGeometry(e,t){const i=this.createRenderGeometry();return Object(r["k"])(i)&&e.addGeometry(i,t),i}createResources(e){const t=this.createTexture(),i=new p["a"](this.materialParameters(t.id)),a=this.recreateGeometry(e,i);return{material:i,texture:t,geometry:a,forEach(e){e(t),e(i),Object(r["k"])(this.geometry)&&e(this.geometry)}}}get preferredTextureSize(){return Object(a["d"])(Object(a["o"])(2*this.geometrySize),16,128)}createTexture(){const e=this.preferredTextureSize;return new g["a"](Object(b["f"])(this._primitive,e,e*O),{mipmap:!1,wrap:{s:33071,t:33071},width:e,height:e,components:4,noUnpackFlip:!0})}calculateMapBounds(e){if(Object(r["j"])(this.resources.resources)||Object(r["j"])(this.resources.resources.geometry))return!1;const t=this.resources.resources.geometry.vertexAttributes.get("position");return Object(o["y"])(t.data,this.view.renderCoordsHelper.spatialReference,x,this.view.spatialReference),Object(h["n"])(e,x),!0}createRenderGeometry(){const e=this.geometry;if(Object(r["j"])(e))return null;const{renderCoordsHelper:t,elevationProvider:i}=this.view,a=Object(f["e"])(e,i,m["a"].fromElevationInfo(this.elevationInfo),t),n=Object(s["x"])(d["d"].get(),e.x,e.y,a),c=d["d"].get();Object(o["y"])(n,e.spatialReference,c,t.spatialReference);const l=this.geometrySize;return u["a"].createPointGeometry(null,c,null,[l,l],[0,0,0,1])}}const O=.5,_=[O/2,O/2,1-O/2,1-O/2],x=Object(n["e"])()},"008c":function(e,t,i){"use strict";i.d(t,"a",(function(){return C})),i.d(t,"b",(function(){return j})),i.d(t,"c",(function(){return o})),i.d(t,"d",(function(){return T})),i.d(t,"e",(function(){return P})),i.d(t,"f",(function(){return A})),i.d(t,"g",(function(){return R}));var r=i("a9ab");const a=(e,t,i)=>[t,i],n=(e,t,i)=>[t,i,e[2]],s=(e,t,i)=>[t,i,e[2],e[3]];function o(e){return e?{originPosition:"upper-left"===e.originPosition?"upperLeft":"lower-left"===e.originPosition?"lowerLeft":e.originPosition,scale:e.tolerance?[e.tolerance,e.tolerance]:[1,1],translate:e.extent?[e.extent.xmin,e.extent.ymax]:[0,0]}:null}function c({scale:e,translate:t},i){return Math.round((i-t[0])/e[0])}function l({scale:e,translate:t},i){return Math.round((t[1]-i)/e[1])}function h(e,t,i){const r=[];let a,n,s,o;for(let h=0;h<i.length;h++){const d=i[h];h>0?(s=c(e,d[0]),o=l(e,d[1]),s===a&&o===n||(r.push(t(d,s-a,o-n)),a=s,n=o)):(a=c(e,d[0]),n=l(e,d[1]),r.push(t(d,a,n)))}return r.length>0?r:null}function d(e,t,i,r){return h(e,i?r?s:n:r?n:a,t)}function u(e,t,i,r){const o=[],c=i?r?s:n:r?n:a;for(let a=0;a<t.length;a++){const i=h(e,c,t[a]);i&&i.length>=3&&o.push(i)}return o.length?o:null}function p(e,t,i,r){const o=[],c=i?r?s:n:r?n:a;for(let a=0;a<t.length;a++){const i=h(e,c,t[a]);i&&i.length>=2&&o.push(i)}return o.length?o:null}function f({scale:e,translate:t},i){return i*e[0]+t[0]}function m({scale:e,translate:t},i){return t[1]-i*e[1]}function b(e,t,i){const r=new Array(i.length);if(!i.length)return r;const[a,n]=e.scale;let s=f(e,i[0][0]),o=m(e,i[0][1]);r[0]=t(i[0],s,o);for(let c=1;c<i.length;c++){const e=i[c];s+=e[0]*a,o-=e[1]*n,r[c]=t(e,s,o)}return r}function g(e,t,i){const r=new Array(i.length);for(let a=0;a<i.length;a++)r[a]=b(e,t,i[a]);return r}function v(e,t,i,r){return b(e,i?r?s:n:r?n:a,t)}function y(e,t,i,r){return g(e,i?r?s:n:r?n:a,t)}function O(e,t,i,r){return g(e,i?r?s:n:r?n:a,t)}function _(e,t,i,r,a){return t.xmin=c(e,i.xmin),t.ymin=l(e,i.ymin),t.xmax=c(e,i.xmax),t.ymax=l(e,i.ymax),t!==i&&(r&&(t.zmin=i.zmin,t.zmax=i.zmax),a&&(t.mmin=i.mmin,t.mmax=i.mmax)),t}function x(e,t,i,r,a){return t.points=d(e,i.points,r,a),t}function j(e,t,i,r,a){return t.x=c(e,i.x),t.y=l(e,i.y),t!==i&&(r&&(t.z=i.z),a&&(t.m=i.m)),t}function w(e,t,i,r,a){const n=u(e,i.rings,r,a);return n?(t.rings=n,t):null}function S(e,t,i,r,a){const n=p(e,i.paths,r,a);return n?(t.paths=n,t):null}function C(e,t){return e&&t?Object(r["f"])(t)?j(e,{},t,!1,!1):Object(r["h"])(t)?S(e,{},t,!1,!1):Object(r["g"])(t)?w(e,{},t,!1,!1):Object(r["e"])(t)?x(e,{},t,!1,!1):Object(r["d"])(t)?_(e,{},t,!1,!1):null:null}function T(e,t,i,r,a){return t.points=v(e,i.points,r,a),t}function P(e,t,i,r,a){return t.x=f(e,i.x),t.y=m(e,i.y),t!==i&&(r&&(t.z=i.z),a&&(t.m=i.m)),t}function A(e,t,i,r,a){return t.rings=O(e,i.rings,r,a),t}function R(e,t,i,r,a){return t.paths=y(e,i.paths,r,a),t}},"025c":function(e,t,i){"use strict";i.d(t,"a",(function(){return o})),i.d(t,"b",(function(){return c}));var r=i("b2b2"),a=i("a915"),n=i("f408"),s=i("1a54");class o{constructor(e,t,i,r=null){this.elevationInfo=e,this.defaultZ=t,this.view=i,this.excludeGraphics=r}screenToMap(e){if(Object(r["k"])(this.defaultZ))return this.view.sceneIntersectionHelper.intersectElevationFromScreen(Object(a["g"])(e.x,e.y),this.elevationInfo,this.defaultZ,this.excludeGraphics);const t=this.view.sceneIntersectionHelper.intersectElevationFromScreen(Object(a["g"])(e.x,e.y),this.elevationInfo,0,this.excludeGraphics);return Object(r["k"])(t)&&(t.z=void 0),t}mapToScreen(e){const t=Object(s["k"])(e.x,e.y,Object(n["a"])(this.view,e,this.elevationInfo),e.spatialReference);return this.view.toScreen(t)}}class c{constructor(e,t,i=[]){this.view=e,this.elevationInfo=t,this.exclude=i}screenToMap(e){const t=this.view.toMap(e,{exclude:this.exclude});return Object(r["k"])(t)&&(t.z=Object(n["f"])(t,this.view,this.elevationInfo)),t}mapToScreen(e){let t=e;return Object(r["k"])(this.elevationInfo)&&(t=Object(s["k"])(e.x,e.y,Object(n["a"])(this.view,e,this.elevationInfo),e.spatialReference)),this.view.toScreen(t)}}},"0310":function(e,t,i){"use strict";i.d(t,"a",(function(){return E})),i.d(t,"b",(function(){return M}));var r=i("3886"),a=i("4db9"),n=i("690a"),s=i("d272"),o=i("d047"),c=i("be24"),l=i("ebd5"),h=i("17b0"),d=i("c6d7"),u=i("d017"),p=i("bd75"),f=i("5d5f"),m=i("d539"),b=i("dfaf"),g=i("a7d7"),v=i("17ca"),y=i("c332"),O=i("b09a"),_=i("6cb2"),x=i("6d5b"),j=i("7d11"),w=i("7e21"),S=i("0d7a"),C=i("7088"),T=i("ea4b"),P=i("aab5"),A=i("d56e"),R=i("3626");function M(e){const t=new n["a"],i=t.vertex.code,M=t.fragment.code;return t.include(A["a"],{name:"Default Material Shader",output:e.output}),t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("camPos","vec3").add("localOrigin","vec3"),t.include(O["a"]),t.varyings.add("vpos","vec3"),t.include(c["a"],e),t.include(m["a"],e),t.include(h["a"],e),0!==e.output&&7!==e.output||(t.include(y["a"],e),t.include(a["a"],{linearDepth:!1}),0===e.normalType&&e.offsetBackfaces&&t.include(v["a"]),t.include(S["a"],e),t.include(j["a"],e),e.instancedColor&&t.attributes.add("instanceColor","vec4"),t.varyings.add("localvpos","vec3"),t.include(b["a"],e),t.include(p["a"],e),t.include(_["a"],e),t.include(x["a"],e),t.vertex.uniforms.add("externalColor","vec4"),t.varyings.add("vcolorExt","vec4"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),i.add(r["a"]`
      void main(void) {
        forwardNormalizedVertexColor();
        vcolorExt = externalColor;
        ${e.instancedColor?"vcolorExt *= instanceColor;":""}
        vcolorExt *= vvColor();
        vcolorExt *= getSymbolColor();
        forwardColorMixMode();

        if (vcolorExt.a < ${r["a"].float(l["c"])}) {
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        }
        else {
          vpos = calculateVPos();
          localvpos = vpos - view[3].xyz;
          vpos = subtractOrigin(vpos);
          ${0===e.normalType?r["a"]`
          vNormalWorld = dpNormal(vvLocalNormal(normalModel()));`:""}
          vpos = addVerticalOffset(vpos, localOrigin);
          ${e.vertexTangets?"vTangent = dpTransformVertexTangent(tangent);":""}
          gl_Position = transformPosition(proj, view, vpos);
          ${0===e.normalType&&e.offsetBackfaces?"gl_Position = offsetBackfacingClipPosition(gl_Position, vpos, vNormalWorld, camPos);":""}
        }

        ${e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
        forwardLinearDepth();
        forwardTextureCoordinates();
      }
    `)),7===e.output&&(t.include(s["a"],e),t.include(l["a"],e),e.multipassTerrainEnabled&&(t.fragment.include(o["a"]),t.include(d["b"],e)),t.fragment.uniforms.add("camPos","vec3").add("localOrigin","vec3").add("opacity","float").add("layerOpacity","float"),e.hasColorTexture&&t.fragment.uniforms.add("tex","sampler2D"),t.fragment.include(R["a"]),M.add(r["a"]`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
        ${e.hasColorTexture?r["a"]`
        vec4 texColor = texture2D(tex, vuv0);
        ${e.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
        discardOrAdjustAlpha(texColor);`:r["a"]`vec4 texColor = vec4(1.0);`}
        ${e.attributeColor?r["a"]`
        float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:r["a"]`
        float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));
        `}
        gl_FragColor = vec4(opacity_);
      }
    `)),0===e.output&&(t.include(s["a"],e),t.include(T["a"],e),t.include(C["a"],e),t.include(l["a"],e),e.receiveShadows&&t.include(u["a"],e),e.multipassTerrainEnabled&&(t.fragment.include(o["a"]),t.include(d["b"],e)),t.fragment.uniforms.add("camPos","vec3").add("localOrigin","vec3").add("ambient","vec3").add("diffuse","vec3").add("opacity","float").add("layerOpacity","float"),e.hasColorTexture&&t.fragment.uniforms.add("tex","sampler2D"),t.include(g["b"],e),t.include(f["a"],e),t.fragment.include(R["a"]),t.include(P["a"],e),M.add(r["a"]`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
        ${e.hasColorTexture?r["a"]`
        vec4 texColor = texture2D(tex, vuv0);
        ${e.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
        discardOrAdjustAlpha(texColor);`:r["a"]`vec4 texColor = vec4(1.0);`}
        shadingParams.viewDirection = normalize(vpos - camPos);
        ${3===e.normalType?r["a"]`
        vec3 normal = screenDerivativeNormal(localvpos);`:r["a"]`
        shadingParams.normalView = vNormalWorld;
        vec3 normal = shadingNormal(shadingParams);`}
        ${1===e.pbrMode?"applyPBRFactors();":""}
        float ssao = evaluateAmbientOcclusionInverse();
        ssao *= getBakedOcclusion();

        float additionalAmbientScale = _oldHeuristicLighting(vpos + localOrigin);
        vec3 additionalLight = ssao * lightingMainIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;
        ${e.receiveShadows?"float shadow = readShadowMap(vpos, linearDepth);":1===e.viewingMode?"float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);":"float shadow = 0.0;"}
        vec3 matColor = max(ambient, diffuse);
        ${e.attributeColor?r["a"]`
        vec3 albedo_ = mixExternalColor(vColor.rgb * matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
        float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:r["a"]`
        vec3 albedo_ = mixExternalColor(matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
        float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));
        `}
        ${e.hasNormalTexture?r["a"]`
              mat3 tangentSpace = ${e.vertexTangets?"computeTangentSpace(normal);":"computeTangentSpace(normal, vpos, vuv0);"}
              vec3 shadedNormal = computeTextureNormal(tangentSpace, vuv0);`:"vec3 shadedNormal = normal;"}
        ${1===e.pbrMode||2===e.pbrMode?1===e.viewingMode?r["a"]`vec3 normalGround = normalize(vpos + localOrigin);`:r["a"]`vec3 normalGround = vec3(0.0, 0.0, 1.0);`:r["a"]``}
        ${1===e.pbrMode||2===e.pbrMode?r["a"]`
            float additionalAmbientIrradiance = additionalAmbientIrradianceFactor * lightingMainIntensity[2];
            vec3 shadedColor = evaluateSceneLightingPBR(shadedNormal, albedo_, shadow, 1.0 - ssao, additionalLight, shadingParams.viewDirection, normalGround, mrr, emission, additionalAmbientIrradiance);`:"vec3 shadedColor = evaluateSceneLighting(shadedNormal, albedo_, shadow, 1.0 - ssao, additionalLight);"}
        gl_FragColor = highlightSlice(vec4(shadedColor, opacity_), vpos);
        ${e.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),t.include(w["a"],e),t}var E=Object.freeze({__proto__:null,build:M})},"040b":function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i("3886");function a(e,t){1===t.viewingMode?e.vertex.code.add(r["a"]`
      vec3 getLocalUp(in vec3 pos, in vec3 origin) {
          return normalize(pos + origin);
      }
    `):e.vertex.code.add(r["a"]`
      vec3 getLocalUp(in vec3 pos, in vec3 origin) {
          return vec3(0.0, 0.0, 1.0); // WARNING: up-axis dependent code
      }
    `),1===t.viewingMode?e.vertex.code.add(r["a"]`
        mat3 getTBNMatrix(in vec3 n) {
            vec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));
            vec3 b = normalize(cross(n, t));
            return mat3(t, b, n);
        }
    `):e.vertex.code.add(r["a"]`
        mat3 getTBNMatrix(in vec3 n) {
            vec3 t = vec3(1.0, 0.0, 0.0);
            vec3 b = normalize(cross(n, t));
            return mat3(t, b, n);
        }
    `)}},"0480":function(e,t,i){"use strict";i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return s}));var r=i("55e6"),a=i("fc00");function n(e,t){return t.push(e.buffer),{buffer:e.buffer,layout:o(e.layout)}}function s(e){return c(e.layout).createView(e.buffer)}function o(e){const t=new Array;return e.fields.forEach((e,i)=>{const r={...e,constructor:h(e.constructor)};t.push([i,r])}),{stride:e.stride,fields:t,fieldNames:e.fieldNames}}function c(e){const t=Object(a["a"])();return t.stride=e.stride,t.fieldNames=e.fieldNames,e.fields.forEach(e=>t.fields.set(e[0],{...e[1],constructor:d(e[1].constructor)})),t}const l=[r["a"],r["m"],r["u"],r["C"],r["f"],r["h"],r["b"],r["n"],r["v"],r["D"],r["g"],r["i"],r["l"],r["t"],r["B"],r["J"],r["j"],r["r"],r["z"],r["H"],r["k"],r["s"],r["A"],r["I"],r["e"],r["q"],r["y"],r["G"],r["c"],r["o"],r["w"],r["E"],r["d"],r["p"],r["x"],r["F"]];function h(e){return`${e.ElementType}_${e.ElementCount}`}function d(e){return u.get(e)}const u=new Map;l.forEach(e=>u.set(h(e),e))},"0494":function(e,t,i){"use strict";i.d(t,"a",(function(){return a})),i.d(t,"b",(function(){return c}));var r=i("b2b2");class a{constructor(e,t,i=2048){this.text=e,this._parameters=t,this.maxSize=i,this._lineWidths=new Array,this._renderPixelRatio=null,this._displayWidth=null,this.key=`${this._parameters.key}--${e}`,this._lines=e.split(/\r?\n/),this._lineHeight=this.computeLineHeight()}get displayWidth(){return this._ensureTextWidth()}get displayHeight(){return this._lineHeight*this._lines.length}get renderedWidth(){return Math.round(this.displayWidth*this.renderPixelRatio)}get renderedHeight(){return Math.round(this.displayHeight*this.renderPixelRatio)}get renderedLineHeight(){return Math.round(this._lineHeight*this.renderPixelRatio)}get renderedFontSize(){return this._parameters.definition.size*this.renderPixelRatio}get renderedHaloSize(){return this._parameters.haloSize*this.renderPixelRatio}get renderPixelRatio(){if(Object(r["j"])(this._renderPixelRatio)){const e=this._parameters.definition.pixelRatio;this.maxSize>0?this._renderPixelRatio=Math.min(e,Math.min(this.maxSize/(this.displayWidth*e),this.maxSize/(this.displayHeight*e))):this._renderPixelRatio=e}return this._renderPixelRatio}getLineXOffset(e){return Math.round((this.renderedWidth-this._lineWidths[e]*this.renderPixelRatio)/2)}render(e,t=0,i=0){const r=this.renderedLineHeight,a=this.renderedHaloSize,o=n(e.textAlign,this.renderedWidth)+a,c=a+s;e.save(),a>0&&this.renderHalo(e,o,c,t,i),this.setFontProperties(e,this.renderedFontSize),i+=c,t+=o;for(let n=0;n<this._lines.length;++n){e.globalCompositeOperation="destination-out",e.fillStyle="rgb(0, 0, 0)";const a=this._lines[n],s=this.getLineXOffset(n);e.fillText(a,t+s,i),e.globalCompositeOperation="source-over",e.fillStyle=this._parameters.fillStyle,e.fillText(a,t+this.getLineXOffset(n),i),i+=r}e.restore()}renderHalo(e,t,i,r,a){const n=this.renderedWidth,s=this.renderedHeight,o=c(l,Math.max(n,h),Math.max(s,h)),d=o.getContext("2d");d.clearRect(0,0,n,s),this.setFontProperties(d,this.renderedFontSize),d.fillStyle=this._parameters.haloStyle,d.strokeStyle=this._parameters.haloStyle;const u=this.renderedHaloSize<3;d.lineJoin=u?"miter":"round",u?this.renderHaloEmulated(d,t,i):this.renderHaloNative(d,t,i),e.globalAlpha=this._parameters.definition.halo.color[3],e.drawImage(o,0,0,n,s,r,a,n,s),e.globalAlpha=1}renderHaloEmulated(e,t,i){const r=this.renderedLineHeight,a=this.renderedHaloSize;for(let n=0;n<this._lines.length;++n){const s=this._lines[n],c=this.getLineXOffset(n);for(const[r,n]of o)e.fillText(s,t+c+a*r,i+a*n);i+=r}}renderHaloNative(e,t,i){const r=this.renderedLineHeight,a=this.renderedHaloSize;for(let n=0;n<this._lines.length;++n){const s=2*a,o=this._lines[n],c=this.getLineXOffset(n),l=5,h=.1;for(let r=0;r<l;r++){const a=1-(l-1)*h+r*h;e.lineWidth=a*s,e.strokeText(o,t+c,i)}i+=r}}setFontProperties(e,t){const i=this._parameters.definition.font,r=`${i.style} ${i.weight} ${t}px ${i.family}, sans-serif`;e.font=r,e.textAlign="left",e.textBaseline="top"}_ensureTextWidth(){if(Object(r["k"])(this._displayWidth))return this._displayWidth;const e=c(l,h,h).getContext("2d");this.setFontProperties(e,this._parameters.definition.size);let t=0,i=2*this._parameters.haloSize;this._lineWidths.length=0;const a=this._parameters.definition.font;("italic"===a.style||"oblique"===a.style||"string"==typeof a.weight&&("bold"===a.weight||"bolder"===a.weight)||"number"==typeof a.weight&&a.weight>600)&&(i+=.3*e.measureText("A").width);for(const r of this._lines){const a=Math.round(e.measureText(r).width+i);this._lineWidths.push(a),t=Math.max(t,a)}return this._displayWidth=t,this._displayWidth}computeLineHeight(){const e=1.275*this._parameters.definition.size;return Math.ceil(e+2*this._parameters.haloSize)+s}}function n(e,t){return"center"===e?.5*t:"right"===e?t:0}const s=1,o=[];{const e=16;for(let t=0;t<360;t+=360/e)o.push([Math.cos(Math.PI*t/180),Math.sin(Math.PI*t/180)])}function c(e,t,i){return e.canvas||(e.canvas=document.createElement("canvas")),e.canvas.width=t,e.canvas.height=i,e.canvas}const l={canvas:null},h=512},"0bde":function(e,t,i){"use strict";var r=i("b2b2"),a=i("ecd7"),n=i("8a44"),s=i("0b2d"),o=i("e431"),c=i("d0ac"),l=i("1153");class h{constructor(e,t){this._objectToBoundingSphere=e,this._maximumObjectsPerNode=10,this._maximumDepth=20,this._degenerateObjects=new Set,this._root=new d,this._objectCount=0,t&&(void 0!==t.maximumObjectsPerNode&&(this._maximumObjectsPerNode=t.maximumObjectsPerNode),void 0!==t.maximumDepth&&(this._maximumDepth=t.maximumDepth))}get bounds(){return this._root.bounds}get halfSize(){return this._root.halfSize}get root(){return this._root.node}get maximumObjectsPerNode(){return this._maximumObjectsPerNode}get maximumDepth(){return this._maximumDepth}get objectCount(){return this._objectCount}destroy(){this._degenerateObjects.clear(),d.clearPool(),w[0]=null,R.prune(),V.prune()}add(e,t=e.length){this._objectCount+=t,this._grow(e,t);const i=d.acquire();for(let r=0;r<t;r++){const t=e[r];this._isDegenerate(t)?this._degenerateObjects.add(t):(i.init(this._root),this._add(t,i))}d.release(i)}remove(e,t=null){this._objectCount-=e.length;const i=d.acquire();for(const a of e){const e=Object(r["k"])(t)?t:c["h"].copy(this._objectToBoundingSphere(a),M);O(e[3])?(i.init(this._root),this._remove(a,e,i)):this._degenerateObjects.delete(a)}d.release(i),this._shrink()}update(e,t){if(!O(t[3])&&this._isDegenerate(e))return;const i=S(e);this.remove(i,t),this.add(i)}forEachAlongRay(e,t,i){const r=c["g"].wrap(e,t);this._forEachNode(this._root,e=>{if(!this._intersectsNode(r,e))return!1;const t=e.node;return t.terminals.forAll(e=>{this._intersectsObject(r,e)&&i(e)}),null!==t.residents&&t.residents.forAll(e=>{this._intersectsObject(r,e)&&i(e)}),!0})}forEachAlongRayWithVerticalOffset(e,t,i,r){const a=c["g"].wrap(e,t);this._forEachNode(this._root,e=>{if(!this._intersectsNodeWithOffset(a,e,r))return!1;const t=e.node;return t.terminals.forAll(e=>{this._intersectsObjectWithOffset(a,e,r)&&i(e)}),null!==t.residents&&t.residents.forAll(e=>{this._intersectsObjectWithOffset(a,e,r)&&i(e)}),!0})}forEach(e){this._forEachNode(this._root,t=>{const i=t.node;return i.terminals.forAll(e),null!==i.residents&&i.residents.forAll(e),!0}),this._degenerateObjects.forEach(e)}forEachDegenerateObject(e){this._degenerateObjects.forEach(e)}findClosest(e,t,i,r,a){return this._findClosest(e,"front-to-back"===t?1:-1,i,r,a)}forEachInDepthRange(e,t,i,r,a,n,s,o){this._forEachInDepthRange(e,t,"front-to-back"===i?1:-1,r,a,n,s,o)}forEachNode(e){this._forEachNode(this._root,t=>e(t.node,t.bounds,t.halfSize))}_intersectsNode(e,t){return f(t.bounds,2*-t.halfSize,P),f(t.bounds,2*t.halfSize,A),Object(l["k"])(e.origin,e.direction,P,A)}_intersectsNodeWithOffset(e,t,i){return f(t.bounds,2*-t.halfSize,P),f(t.bounds,2*t.halfSize,A),i.applyToMinMax(P,A),Object(l["k"])(e.origin,e.direction,P,A)}_intersectsObject(e,t){const i=this._objectToBoundingSphere(t);return!(i[3]>0)||c["h"].intersectsRay(i,e)}_intersectsObjectWithOffset(e,t,i){const r=this._objectToBoundingSphere(t);return!(r[3]>0)||c["h"].intersectsRay(i.applyToBoundingSphere(r),e)}_forEachNode(e,t){let i=d.acquire().init(e);const r=[i];for(;0!==r.length;){if(i=r.pop(),t(i)&&!i.isLeaf())for(let e=0;e<i.node.children.length;e++)i.node.children[e]&&r.push(d.acquire().init(i).advance(e));d.release(i)}}_forEachNodeDepthOrdered(e,t,i,r=1){let a=d.acquire().init(e);const n=[a];for(g(i,r,k);0!==n.length;){if(a=n.pop(),t(a)&&!a.isLeaf())for(let e=7;e>=0;--e){const t=k[e];t>=a.node.children.length||a.node.children[t]&&n.push(d.acquire().init(a).advance(t))}d.release(a)}}_findClosest(e,t,i,r,a){let n=1/0,s=1/0,l=null;const h=v(e,t);let d=0;const u=a=>{if(++d,r&&!r(a))return;const o=this._objectToBoundingSphere(a);if(i&&m(o,i))return;const h=y(e,t,c["h"].getCenter(o)),u=h-o[3],p=h+o[3];u<n&&(n=u,s=p,l=a)};return this._forEachNodeDepthOrdered(this._root,r=>{if(null!=a&&d>=a)return!1;if(i&&m(r.bounds,i))return!1;if(Object(o["f"])(T,h,r.halfSize),Object(o["g"])(T,T,r.bounds),y(e,t,T)>s)return!1;const n=r.node;return n.terminals.forAll(e=>{u(e)}),null!==n.residents&&n.residents.forAll(e=>{u(e)}),!0},e,t),l}_forEachInDepthRange(e,t,i,r,a,n,s,l){let h=-1/0,d=1/0;const u={setRange:e=>{1===i?(h=Math.max(h,e.near),d=Math.min(d,e.far)):(h=Math.max(h,-e.far),d=Math.min(d,-e.near))}};u.setRange(r);const p=y(t,i,e),f=v(t,i),b=v(t,-1*i);let g=0;const O=e=>{if(++g,s&&!s(e))return;const r=this._objectToBoundingSphere(e),o=c["h"].getCenter(r),l=y(t,i,o)-p,f=l-r[3],b=l+r[3];f>d||b<h||n&&m(r,n)||a(e,u)};this._forEachNodeDepthOrdered(this._root,e=>{if(null!=l&&g>=l)return!1;if(n&&m(e.bounds,n))return!1;if(Object(o["f"])(T,f,e.halfSize),Object(o["g"])(T,T,e.bounds),y(t,i,T)-p>d)return!1;if(Object(o["f"])(T,b,e.halfSize),Object(o["g"])(T,T,e.bounds),y(t,i,T)-p<h)return!1;const r=e.node;return r.terminals.forAll(e=>{O(e)}),null!==r.residents&&r.residents.forAll(e=>{O(e)}),!0},t,i)}_remove(e,t,i){R.clear();const r=i.advanceTo(t,(e,t)=>{R.push(e.node),R.push(t)})?i.node.terminals:i.node.residents;if(r.removeUnordered(e),0===r.length)for(let a=R.length-2;a>=0;a-=2){const e=R.data[a],t=R.data[a+1];if(!this._purge(e,t))break}}_nodeIsEmpty(e){if(0!==e.terminals.length)return!1;if(null!==e.residents)return 0===e.residents.length;for(let t=0;t<e.children.length;t++)if(e.children[t])return!1;return!0}_purge(e,t){return t>=0&&(e.children[t]=null),!!this._nodeIsEmpty(e)&&(null===e.residents&&(e.residents=new n["a"]({shrink:!0})),!0)}_add(e,t){t.advanceTo(this._objectToBoundingSphere(e))?t.node.terminals.push(e):(t.node.residents.push(e),t.node.residents.length>this._maximumObjectsPerNode&&t.depth<this._maximumDepth&&this._split(t))}_split(e){const t=e.node.residents;e.node.residents=null;for(let i=0;i<t.length;i++){const r=d.acquire().init(e);this._add(t.getItemAt(i),r),d.release(r)}}_grow(e,t){if(0!==t&&(b(e,t,e=>this._objectToBoundingSphere(e),E),O(E[3])&&!this._fitsInsideTree(E)))if(this._nodeIsEmpty(this._root.node))c["h"].copy(E,this._root.bounds),this._root.halfSize=1.25*E[3];else{const e=this._rootBoundsForRootAsSubNode(E);this._placingRootViolatesMaxDepth(e)?this._rebuildTree(E,e):this._growRootAsSubNode(e),d.release(e)}}_rebuildTree(e,t){Object(o["l"])(D,t.bounds),D[3]=t.halfSize,b([e,D],2,e=>e,I);const i=d.acquire().init(this._root);this._root.initFrom(null,I,1.25*I[3]),this._forEachNode(i,e=>(this.add(e.node.terminals.data,e.node.terminals.length),null!==e.node.residents&&this.add(e.node.residents.data,e.node.residents.length),!0)),d.release(i)}_placingRootViolatesMaxDepth(e){const t=Math.log(e.halfSize/this._root.halfSize)*Math.LOG2E;let i=0;return this._forEachNode(this._root,e=>(i=Math.max(i,e.depth),i+t<=this._maximumDepth)),i+t>this._maximumDepth}_rootBoundsForRootAsSubNode(e){const t=e[3],i=e;let r=-1/0;const a=this._root.bounds,n=this._root.halfSize;for(let s=0;s<3;s++){const e=a[s]-n-(i[s]-t),o=i[s]+t-(a[s]+n),c=Math.max(0,Math.ceil(e/(2*n))),l=Math.max(0,Math.ceil(o/(2*n)))+1,h=2**Math.ceil(Math.log(c+l)*Math.LOG2E);r=Math.max(r,h),L[s].min=c,L[s].max=l}for(let s=0;s<3;s++){let e=L[s].min,t=L[s].max;const i=(r-(e+t))/2;e+=Math.ceil(i),t+=Math.floor(i);const o=a[s]-n-e*n*2;C[s]=o+(t+e)*n}return C[3]=r*n*j,d.acquire().initFrom(null,C,r*n,0)}_growRootAsSubNode(e){const t=this._root.node;Object(o["l"])(E,this._root.bounds),E[3]=this._root.halfSize,this._root.init(e),e.advanceTo(E,null,!0),e.node.children=t.children,e.node.residents=t.residents,e.node.terminals=t.terminals}_shrink(){for(;;){const e=this._findShrinkIndex();if(-1===e)break;this._root.advance(e),this._root.depth=0}}_findShrinkIndex(){if(0!==this._root.node.terminals.length||this._root.isLeaf())return-1;let e=null;const t=this._root.node.children;let i=0,r=0;for(;r<t.length&&null==e;)i=r++,e=t[i];for(;r<t.length;)if(t[r++])return-1;return i}_isDegenerate(e){return!O(this._objectToBoundingSphere(e)[3])}_fitsInsideTree(e){const t=this._root.bounds,i=this._root.halfSize;return e[3]<=i&&e[0]>=t[0]-i&&e[0]<=t[0]+i&&e[1]>=t[1]-i&&e[1]<=t[1]+i&&e[2]>=t[2]-i&&e[2]<=t[2]+i}}class d{constructor(){this.bounds=c["h"].create(),this.halfSize=0,this.initFrom(null,null,0,0)}init(e){return this.initFrom(e.node,e.bounds,e.halfSize,e.depth)}initFrom(e,t,i,a=this.depth){return this.node=Object(r["k"])(e)?e:d.createEmptyNode(),Object(r["k"])(t)&&c["h"].copy(t,this.bounds),this.halfSize=i,this.depth=a,this}advance(e){let t=this.node.children[e];t||(t=d.createEmptyNode(),this.node.children[e]=t),this.node=t,this.halfSize/=2,this.depth++;const i=_[e];return this.bounds[0]+=i[0]*this.halfSize,this.bounds[1]+=i[1]*this.halfSize,this.bounds[2]+=i[2]*this.halfSize,this.bounds[3]=this.halfSize*j,this}advanceTo(e,t,i=!1){for(;;){if(this.isTerminalFor(e))return t&&t(this,-1),!0;if(this.isLeaf()){if(!i)return t&&t(this,-1),!1;this.node.residents=null}const r=this._childIndex(e);t&&t(this,r),this.advance(r)}}isLeaf(){return null!=this.node.residents}isTerminalFor(e){return e[3]>this.halfSize/2}_childIndex(e){const t=this.bounds;return(t[0]<e[0]?1:0)+(t[1]<e[1]?2:0)+(t[2]<e[2]?4:0)}static createEmptyNode(){return{children:[null,null,null,null,null,null,null,null],terminals:new n["a"]({shrink:!0}),residents:new n["a"]({shrink:!0})}}static acquire(){return d._pool.acquire()}static release(e){d._pool.release(e)}static clearPool(){d._pool.prune()}}function u(e,t){e[0]=Math.min(e[0],t[0]-t[3]),e[1]=Math.min(e[1],t[1]-t[3]),e[2]=Math.min(e[2],t[2]-t[3])}function p(e,t){e[0]=Math.max(e[0],t[0]+t[3]),e[1]=Math.max(e[1],t[1]+t[3]),e[2]=Math.max(e[2],t[2]+t[3])}function f(e,t,i){i[0]=e[0]+t,i[1]=e[1]+t,i[2]=e[2]+t}function m(e,t){return!c["d"].intersectsSphere(t,e)}function b(e,t,i,r){if(1===t){const t=i(e[0]);c["h"].copy(t,r)}else{P[0]=1/0,P[1]=1/0,P[2]=1/0,A[0]=-1/0,A[1]=-1/0,A[2]=-1/0;for(let r=0;r<t;r++){const t=i(e[r]);O(t[3])&&(u(P,t),p(A,t))}Object(o["j"])(r,P,A,.5),r[3]=Math.max(A[0]-P[0],A[1]-P[1],A[2]-P[2])/2}}function g(e,t,i){if(!V.length)for(let r=0;r<8;++r)V.push({index:0,distance:0});for(let r=0;r<8;++r){const i=_[r];V.data[r].index=r,V.data[r].distance=y(e,t,i)}V.sort((e,t)=>e.distance-t.distance);for(let r=0;r<8;++r)i[r]=V.data[r].index}function v(e,t){let i=1/0,r=null;for(let a=0;a<8;++a){const n=y(e,t,x[a]);n<i&&(i=n,r=x[a])}return r}function y(e,t,i){return t*(e[0]*i[0]+e[1]*i[1]+e[2]*i[2])}function O(e){return!isNaN(e)&&e!==-1/0&&e!==1/0&&e>0}d._pool=new a["a"](d);const _=[Object(s["g"])(-1,-1,-1),Object(s["g"])(1,-1,-1),Object(s["g"])(-1,1,-1),Object(s["g"])(1,1,-1),Object(s["g"])(-1,-1,1),Object(s["g"])(1,-1,1),Object(s["g"])(-1,1,1),Object(s["g"])(1,1,1)],x=[Object(s["g"])(-1,-1,-1),Object(s["g"])(-1,-1,1),Object(s["g"])(-1,1,-1),Object(s["g"])(-1,1,1),Object(s["g"])(1,-1,-1),Object(s["g"])(1,-1,1),Object(s["g"])(1,1,-1),Object(s["g"])(1,1,1)],j=Math.sqrt(3),w=[null];function S(e){return w[0]=e,w}const C=c["h"].create(),T=Object(s["e"])(),P=Object(s["e"])(),A=Object(s["e"])(),R=new n["a"],M=c["h"].create(),E=c["h"].create(),D=c["h"].create(),I=c["h"].create(),L=[{min:0,max:0},{min:0,max:0},{min:0,max:0}],V=new n["a"],k=[0,0,0,0,0,0,0,0];t["a"]=h},"0c9d":function(e,t,i){"use strict";i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return d})),i.d(t,"c",(function(){return l})),i.d(t,"d",(function(){return h})),i.d(t,"e",(function(){return s})),i.d(t,"f",(function(){return o}));var r=i("2ebb"),a=i("fc00");const n=Object(a["a"])().vec3f("position").u16("componentIndex").u16("u16padding"),s=Object(a["a"])().vec2u8("sideness"),o=Object(r["a"])(s),c=Object(a["a"])().vec3f("position0").vec3f("position1").u16("componentIndex").u8("variantOffset",{glNormalized:!0}).u8("variantStroke").u8("variantExtension",{glNormalized:!0}).u8("u8padding",{glPadding:!0}).u16("u16padding",{glPadding:!0}),l=c.clone().vec3f("normal"),h=c.clone().vec3f("normalA").vec3f("normalB"),d={position0:0,position1:1,componentIndex:2,variantOffset:4,variantStroke:5,variantExtension:6,normal:7,normalA:7,normalB:8,sideness:9}},"0ca15":function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));class r{constructor(e){this.gain=e}update(e){if(this.hasLastValue){const t=this.computeDelta(e);this.updateDelta(t)}this.lastValue=e}reset(){this.lastValue=void 0,this.filteredDelta=void 0}get hasLastValue(){return void 0!==this.lastValue}get hasFilteredDelta(){return void 0!==this.filteredDelta}computeDelta(e){return e-this.lastValue}updateDelta(e){this.hasFilteredDelta?this.filteredDelta=(1-this.gain)*this.filteredDelta+this.gain*e:this.filteredDelta=e}}},"0cb9":function(e,t,i){"use strict";i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return o})),i.d(t,"c",(function(){return s}));var r=i("b2b2"),a=i("1a54");class n{constructor(e,t=null,i=0){this.array=e,this.spatialReference=t,this.offset=i}}function s(e){return"array"in e}function o(e,t,i="ground"){if(Object(a["j"])(t))return e.getElevation(t.x,t.y,t.z||0,t.spatialReference,i);if(s(t)){let a=t.offset;return e.getElevation(t.array[a++],t.array[a++],t.array[a]||0,Object(r["u"])(t.spatialReference,e.spatialReference),i)}return e.getElevation(t[0],t[1],t[2]||0,e.spatialReference,i)}},"0d7a":function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i("3886"),a=i("7cb4");function n(e,t){const i=e.fragment;i.uniforms.add("normalTexture","sampler2D"),i.uniforms.add("normalTextureSize","vec2"),t.vertexTangets?(e.attributes.add("tangent","vec4"),e.varyings.add("vTangent","vec4"),2===t.doubleSidedMode?i.code.add(r["a"]`
      mat3 computeTangentSpace(vec3 normal) {
        float tangentHeadedness = gl_FrontFacing ? vTangent.w : -vTangent.w;
        vec3 tangent = normalize(gl_FrontFacing ? vTangent.xyz : -vTangent.xyz);
        vec3 bitangent = cross(normal, tangent) * tangentHeadedness;
        return mat3(tangent, bitangent, normal);
      }
    `):i.code.add(r["a"]`
      mat3 computeTangentSpace(vec3 normal) {
        float tangentHeadedness = vTangent.w;
        vec3 tangent = normalize(vTangent.xyz);
        vec3 bitangent = cross(normal, tangent) * tangentHeadedness;
        return mat3(tangent, bitangent, normal);
      }
    `)):(e.extensions.add("GL_OES_standard_derivatives"),i.code.add(r["a"]`
    mat3 computeTangentSpace(vec3 normal, vec3 pos, vec2 st) {

      vec3 Q1 = dFdx(pos);
      vec3 Q2 = dFdy(pos);

      vec2 stx = dFdx(st);
      vec2 sty = dFdy(st);

      float det = stx.t * sty.s - sty.t * stx.s;

      vec3 T = stx.t * Q2 - sty.t * Q1; // compute tangent
      T = T - normal * dot(normal, T); // orthogonalize tangent
      T *= inversesqrt(max(dot(T,T), 1.e-10)); // "soft" normalize - goes to 0 when T goes to 0
      vec3 B = sign(det) * cross(normal, T); // assume normal is normalized, B has the same lenght as B
      return mat3(T, B, normal); // T and B go to 0 when the tangent space is not well defined by the uv coordinates
    }
  `)),0!==t.attributeTextureCoordinates&&(e.include(a["a"],t),i.code.add(r["a"]`
    vec3 computeTextureNormal(mat3 tangentSpace, vec2 uv) {
      vtc.uv = uv;
      ${t.supportsTextureAtlas?"vtc.size = normalTextureSize;":""}
      vec3 rawNormal = textureLookup(normalTexture, vtc).rgb * 2.0 - 1.0;
      return tangentSpace * rawNormal;
    }
  `))}},"0d96":function(e,t,i){"use strict";i.d(t,"a",(function(){return r})),i.d(t,"b",(function(){return j})),i.d(t,"c",(function(){return y})),i.d(t,"d",(function(){return O}));var r,a=i("02f1"),n=i("0fc4"),s=i("3349"),o=i("3886"),c=i("690a"),l=i("4377"),h=i("7c1d"),d=i("d272"),u=i("2f98"),p=i("d0cb"),f=i("501b"),m=i("7079"),b=i("6a07"),g=i("be24"),v=i("ebd5");function y(e){const t=new c["a"],i=e.signedDistanceFieldEnabled;if(t.include(h["a"]),t.include(p["a"],e),t.include(d["a"],e),6===e.output)return t.include(m["b"],e),t;t.include(u["a"]),t.fragment.include(f["a"]),t.fragment.include(l["a"]),t.include(g["a"],e),t.varyings.add("vcolor","vec4"),t.varyings.add("vtc","vec2"),t.varyings.add("vsize","vec2"),e.binaryHighlightOcclusionEnabled&&t.varyings.add("voccluded","float"),t.vertex.uniforms.add("screenOffset","vec2").add("anchorPos","vec2").add("textureCoordinateScaleFactor","vec2").add("materialColor","vec4"),i&&t.vertex.uniforms.add("outlineColor","vec4"),e.screenSizePerspectiveEnabled&&t.vertex.uniforms.add("screenSizePerspective","vec4"),(e.debugDrawBorder||e.binaryHighlightOcclusionEnabled)&&t.varyings.add("debugBorderCoords","vec4"),t.attributes.add("uv0","vec2"),t.attributes.add("color","vec4"),t.attributes.add("size","vec2"),t.attributes.add("auxpos2","vec4"),t.vertex.code.add(o["a"]`
    void main(void) {
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);

      if (rejectBySlice(projectAux.posModel)) {
        // Project outside of clip plane
        gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
        return;
      }
      vec2 inputSize;
      ${e.screenSizePerspectiveEnabled?o["a"]`
      inputSize = screenSizePerspectiveScaleVec2(size, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspective);
      vec2 screenOffsetScaled = screenSizePerspectiveScaleVec2(screenOffset, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
         `:o["a"]`
      inputSize = size;
      vec2 screenOffsetScaled = screenOffset;`}

      ${e.vvSize?"inputSize *= vvScale(auxpos2).xx;":""}

      vec2 combinedSize = inputSize * pixelRatio;
      vec4 quadOffset = vec4(0.0);

      ${e.occlusionTestEnabled||e.binaryHighlightOcclusionEnabled?"bool visible = testVisibilityHUD(posProj);":""}

      ${e.binaryHighlightOcclusionEnabled?"voccluded = visible ? 0.0 : 1.0;":""}
    `);const r=o["a"]`
      vec2 uv01 = floor(uv0);
      vec2 uv = uv0 - uv01;
      quadOffset.xy = ((uv01 - anchorPos) * 2.0 * combinedSize + screenOffsetScaled) / viewport.zw * posProj.w;
  `,a=e.pixelSnappingEnabled?i?o["a"]`
  posProj = alignToPixelOrigin(posProj, viewport.zw) + quadOffset;`:o["a"]`
  posProj += quadOffset;
  if (inputSize.x == size.x) {
    posProj = alignToPixelOrigin(posProj, viewport.zw);
  }`:o["a"]`posProj += quadOffset;`;t.vertex.code.add(o["a"]`
      ${e.occlusionTestEnabled?"if (visible) {":""}
      ${r}
      ${e.vvColor?"vcolor = vvGetColor(auxpos2, vvColorValues, vvColorColors) * materialColor;":"vcolor = color / 255.0 * materialColor;"}

      bool alphaDiscard = vcolor.a < ${o["a"].float(v["c"])};
      ${i?`alphaDiscard = alphaDiscard && outlineColor.a < ${o["a"].float(v["c"])};`:""}
      if (alphaDiscard) {
        // "early discard" if both symbol color (= fill) and outline color (if applicable) are transparent
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      } else {
        ${a}
        gl_Position = posProj;
      }

      vtc = uv * textureCoordinateScaleFactor;

      ${e.debugDrawBorder?"debugBorderCoords = vec4(uv01, 1.5 / combinedSize);":""}
      vsize = inputSize;
      ${e.occlusionTestEnabled?o["a"]`} else { vtc = vec2(0.0);
        ${e.debugDrawBorder?"debugBorderCoords = vec4(0.5, 0.5, 1.5 / combinedSize);}":"}"}`:""}
    }
    `),t.fragment.uniforms.add("tex","sampler2D"),i&&(t.fragment.uniforms.add("outlineColor","vec4"),t.fragment.uniforms.add("outlineSize","float"));const n=e.debugDrawBorder?o["a"]`(isBorder > 0.0 ? 0.0 : ${o["a"].float(v["b"])})`:o["a"].float(v["b"]),s=o["a"]`
    ${e.debugDrawBorder?o["a"]`
      float isBorder = float(any(lessThan(debugBorderCoords.xy, debugBorderCoords.zw)) || any(greaterThan(debugBorderCoords.xy, 1.0 - debugBorderCoords.zw)));`:""}

    ${i?o["a"]`
      vec4 fillPixelColor = vcolor;

      // Attempt to sample texel centers to avoid that thin cross outlines
      // disappear with large symbol sizes.
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/7058#issuecomment-603041
      const float txSize = 128.0;
      const float texelSize = 1.0 / txSize;
      // Calculate how much we have to add/subtract to/from each texel to reach the size of an onscreen pixel
      vec2 scaleFactor = (vsize - txSize) * texelSize;
      vec2 samplePos = vtc + (vec2(1.0, -1.0) * texelSize) * scaleFactor;

      // Get distance and map it into [-0.5, 0.5]
      float d = rgba2float(texture2D(tex, samplePos)) - 0.5;

      // Distance in output units (i.e. pixels)
      float dist = d * vsize.x;

      // Create smooth transition from the icon into its outline
      float fillAlphaFactor = clamp(0.5 - dist, 0.0, 1.0);
      fillPixelColor.a *= fillAlphaFactor;

      if (outlineSize > 0.25) {
        vec4 outlinePixelColor = outlineColor;
        float clampedOutlineSize = min(outlineSize, 0.5*vsize.x);

        // Create smooth transition around outline
        float outlineAlphaFactor = clamp(0.5 - (abs(dist) - 0.5*clampedOutlineSize), 0.0, 1.0);
        outlinePixelColor.a *= outlineAlphaFactor;

        if (
          outlineAlphaFactor + fillAlphaFactor < ${n} ||
          fillPixelColor.a + outlinePixelColor.a < ${o["a"].float(v["c"])}
        ) {
          discard;
        }

        // perform un-premultiplied over operator (see https://en.wikipedia.org/wiki/Alpha_compositing#Description)
        float compositeAlpha = outlinePixelColor.a + fillPixelColor.a * (1.0 - outlinePixelColor.a);
        vec3 compositeColor = vec3(outlinePixelColor) * outlinePixelColor.a +
          vec3(fillPixelColor) * fillPixelColor.a * (1.0 - outlinePixelColor.a);

        gl_FragColor = vec4(compositeColor, compositeAlpha);
      } else {
        if (fillAlphaFactor < ${n}) {
          discard;
        }

        gl_FragColor = premultiplyAlpha(fillPixelColor);
      }

      // visualize SDF:
      // gl_FragColor = vec4(clamp(-dist/vsize.x*2.0, 0.0, 1.0), clamp(dist/vsize.x*2.0, 0.0, 1.0), 0.0, 1.0);
      `:o["a"]`
          vec4 texColor = texture2D(tex, vtc, -0.5);
          if (texColor.a < ${n}) {
            discard;
          }
          gl_FragColor = texColor * premultiplyAlpha(vcolor);
          `}

    ${e.debugDrawBorder?o["a"]`gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 1.0, 1.0), isBorder);`:""}
  `;return 7===e.output&&t.fragment.code.add(o["a"]`
      void main() {
        ${s}
        gl_FragColor = vec4(gl_FragColor.a);
      }
      `),0===e.output&&t.fragment.code.add(o["a"]`
    void main() {
      ${s}
      ${e.FrontFacePass?"gl_FragColor.rgb /= gl_FragColor.a;":""}
    }
    `),4===e.output&&(t.include(b["a"]),t.fragment.code.add(o["a"]`
    void main() {
      ${s}
      ${e.binaryHighlightOcclusionEnabled?o["a"]`
          if (voccluded == 1.0) {
            gl_FragColor = vec4(1.0, 1.0, 0.0, 1.0);
          } else {
            gl_FragColor = vec4(1.0, 0.0, 1.0, 1.0);
          }`:"outputHighlight();"}
    }
    `)),t}function O(e,t=x){return e.textureIsSignedDistanceField?_(e.anchorPos,e.distanceFieldBoundingBox,t):Object(s["c"])(t,e.anchorPos),t}function _(e,t,i){i[0]=e[0]*(t[2]-t[0])+t[0],i[1]=e[1]*(t[3]-t[1])+t[1]}!function(e){function t(e,t,i){e.setUniform4fv("materialColor",t.color),t.textureIsSignedDistanceField&&(t.outlineColor[3]<=0||t.outlineSize<=0?(e.setUniform4fv("outlineColor",n["b"]),e.setUniform1f("outlineSize",0)):(e.setUniform4fv("outlineColor",t.outlineColor),e.setUniform1f("outlineSize",t.outlineSize))),e.setUniform2f("screenOffset",2*t.screenOffset[0]*i,2*t.screenOffset[1]*i),e.setUniform2fv("anchorPos",O(t))}e.bindUniforms=t}(r||(r={}));const x=Object(a["b"])();var j=Object.freeze({__proto__:null,build:y,get HUDMaterial(){return r},calculateAnchorPosForRendering:O})},"0e88":function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i("b2b2");class a{constructor(e){this.technique=e,this.refCount=0,this.refZeroFrame=0}}class n{constructor(e){this._context=e,this._perConstructorInstances=new Map,this._frameCounter=0,this._keepAliveFrameCount=1200}get viewingMode(){return this._context.viewingMode}get constructionContext(){return this._context}dispose(){this._perConstructorInstances.forEach(e=>e.forEach(e=>e.technique.dispose())),this._perConstructorInstances.clear()}acquire(e,t){const i=t.key;let r=this._perConstructorInstances.get(e);r||(r=new Map,this._perConstructorInstances.set(e,r));let n=r.get(i);return void 0===n&&(n=new a(new e(this._context,t)),r.set(i,n)),++n.refCount,n.technique}acquireAndReleaseExisting(e,t,i){return Object(r["j"])(i)?this.acquire(e,t):t.key===i.key&&i instanceof e?i:(this.release(i),this.acquire(e,t))}release(e){if(Object(r["j"])(e))return;const t=this._perConstructorInstances.get(e.constructor).get(e.key);t.refCount-=1,0===t.refCount&&(t.refZeroFrame=this._frameCounter)}frameUpdate(){this._frameCounter++,this._perConstructorInstances.forEach((e,t)=>{e.forEach((t,i)=>{0===t.refCount&&t.refZeroFrame+this._keepAliveFrameCount<this._frameCounter&&(t.technique.dispose(),e.delete(i))}),0===e.size&&this._perConstructorInstances.delete(t)})}getProgramsUsingUniform(e){return this._context.commonUniformStore.getPrograms(e)}async hotReload(){const e=new Array;this._perConstructorInstances.forEach((t,i)=>{const r=async(e,t)=>{const i=t.shader;i&&(await i.reload(),e.forEach(e=>{e.technique.reload(this._context)}))};e.push(r(t,i))}),await Promise.all(e)}}},"0eb9":function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));var r=i("b2b2"),a=i("8076"),n=i("e9d6");class s{constructor(){this._meterUnitOffset=0,this._renderUnitOffset=0,this._unit="meters",this._metersPerElevationInfoUnit=1,this._featureExpressionInfoContext=null,this.centerPointInElevationSR=null,this.mode=null}get featureExpressionInfoContext(){return this._featureExpressionInfoContext}get meterUnitOffset(){return this._meterUnitOffset}get unit(){return this._unit}set unit(e){this._unit=e,this._metersPerElevationInfoUnit=Object(a["a"])(e)}reset(){this.mode=null,this._meterUnitOffset=0,this._renderUnitOffset=0,this._featureExpressionInfoContext=null,this.unit="meters"}set offsetMeters(e){this._meterUnitOffset=e,this._renderUnitOffset=0}set offsetElevationInfoUnits(e){this._meterUnitOffset=e*this._metersPerElevationInfoUnit,this._renderUnitOffset=0}addOffsetRenderUnits(e){this._renderUnitOffset+=e}geometryZWithOffset(e,t){const i=this.calculateOffsetRenderUnits(t);return null!=this.featureExpressionInfoContext?i:e+i}calculateOffsetRenderUnits(e){let t=this._meterUnitOffset;const i=this.featureExpressionInfoContext;return null!=i&&(t+=Object(n["e"])(i)*this._metersPerElevationInfoUnit),t/e.unitInMeters+this._renderUnitOffset}setFromElevationInfo(e){this.mode=e.mode,this.unit=Object(a["c"])(e.unit)?e.unit:"meters",this.offsetElevationInfoUnits=Object(r["u"])(e.offset,0)}updateFeatureExpressionInfoContext(e,t,i){if(Object(r["j"])(e))return void(this._featureExpressionInfoContext=null);const a=e&&e.arcade;a&&Object(r["k"])(t)&&Object(r["k"])(i)?(this._featureExpressionInfoContext=Object(n["a"])(e),Object(n["g"])(this._featureExpressionInfoContext,Object(n["d"])(a.modules,t,i))):this._featureExpressionInfoContext=e}static fromElevationInfo(e){const t=new s;return Object(r["k"])(e)&&t.setFromElevationInfo(e),t}}},"0f94":function(e,t,i){"use strict";i.d(t,"a",(function(){return p})),i.d(t,"b",(function(){return u})),i.d(t,"c",(function(){return f})),i.d(t,"d",(function(){return m})),i.d(t,"e",(function(){return o})),i.d(t,"f",(function(){return d})),i.d(t,"g",(function(){return l})),i.d(t,"h",(function(){return h}));var r=i("38a4"),a=i("02f1"),n=i("3349");function s(e,t){return e[0]*t[1]-e[1]*t[0]}function o(e,t,i){const r=(t[0]-e[0])*(i[1]-e[1])-(t[1]-e[1])*(i[0]-e[0]);return Math.abs(r)/Object(n["i"])(t,i)}function c(e,t,i){const r=Object(n["g"])(i,t)/Object(n["q"])(i);return Object(n["a"])(e,i,r)}function l(e,t,i,r,a=i){return Object(n["d"])(g,r,i),Object(n["d"])(y,t,a),c(O,y,g),Object(n["h"])(e,a,O)}function h(e,t,i,r){Object(n["d"])(g,r,i),Object(n["d"])(y,t,i);const a=Object(n["g"])(g,y)/Object(n["q"])(g);return a>0?Object(n["p"])(e,i,g,a):Object(n["c"])(e,i)}function d(e,t,i,r){Object(n["d"])(g,t,i);const a=r/Object(n["l"])(g);return Object(n["p"])(e,i,g,a)}function u(e,t){return l(y,t,e.start,e.end),Object(r["g"])(y[0],t[0])&&Object(r["g"])(y[1],t[1])?[Object(a["c"])(t)]:[]}function p(e,t,i){return d(y,i,e,t),Object(r["g"])(y[0],i[0])&&Object(r["g"])(y[1],i[1])?[Object(a["c"])(i)]:[]}function f(e,t){const i=e.start,r=e.end,a=t.start,o=t.end,c=Object(n["d"])(g,r,i),l=Object(n["d"])(v,o,a),h=s(c,l);if(Math.abs(h)<=b)return[];const d=Object(n["d"])(y,i,a),u=s(l,d)/h,p=s(c,d)/h;if(u>=0){if(p>=0||1===t.type)return[Object(n["p"])(O,i,c,u)]}else if(1===e.type&&(p>=0||1===t.type))return[Object(n["p"])(O,i,c,u)];return[]}function m(e,t,i){const r=[],a=Object(n["d"])(g,e.end,e.start),s=Object(n["d"])(v,e.start,t),o=Object(n["q"])(a),c=2*Object(n["g"])(a,s),l=c*c-4*o*(Object(n["q"])(s)-i*i);if(0===l){const t=-c/(2*o);(1===e.type||t>=0)&&r.push(Object(n["p"])(O,e.start,a,t))}else if(l>0){const t=Math.sqrt(l),i=(-c+t)/(2*o);(1===e.type||i>=0)&&r.push(Object(n["p"])(O,e.start,a,i));const s=(-c-t)/(2*o);(1===e.type||s>=0)&&r.push(Object(n["p"])(y,e.start,a,s))}return r}const b=1e-6,g=Object(a["b"])(),v=Object(a["b"])(),y=Object(a["b"])(),O=Object(a["b"])()},"11d8":function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i("55f0");class a extends r["a"]{constructor(e=3,t=.01,i=.95,r=12){super(e,t,i,r)}add(e,t){if(this.value.hasLastValue){const t=this.value.lastValue;let i=e-t;for(;i>Math.PI;)i-=2*Math.PI;for(;i<-Math.PI;)i+=2*Math.PI;e=t+i}super.add(e,t)}}},1381:function(e,t,i){"use strict";i.d(t,"a",(function(){return g}));var r=i("c649"),a=i("4ae5"),n=i("521c"),s=(i("e06a"),i("4cac")),o=i("a915"),c=i("db52"),l=i("4dc9"),h=(i("1fd7"),i("8d60")),d=i("0b2d"),u=i("02f1"),p=i("3349"),f=i("7779"),m=i("c9fb"),b=i("65a7");class g extends b["a"]{visualizeIntersectionPoint(e,t){return this._visualizeSnappingIndicator({geometry:new a["a"]({x:e.intersectionPoint[0],y:e.intersectionPoint[1],spatialReference:t.coordinateHelper.spatialReference}),symbol:O,context:t})}visualizePoint(e,t){return this._visualizeSnappingIndicator({geometry:new a["a"]({x:e.point[0],y:e.point[1],spatialReference:t.coordinateHelper.spatialReference}),symbol:_,context:t})}visualizeLine(e,t){return this._visualizeSnappingIndicator({geometry:new n["a"]({paths:[[e.lineStart,e.lineEnd]],spatialReference:t.coordinateHelper.spatialReference}),symbol:x,context:t})}visualizeParallelSign(e,t){return this._visualizeSnappingIndicator({geometry:new n["a"]({paths:[[e.lineStart,e.lineEnd]],spatialReference:t.coordinateHelper.spatialReference}),symbol:j,context:t})}visualizeRightAngleQuad(e,t){return this._visualizeSnappingIndicator({geometry:new n["a"]({paths:[[e.previousVertex,e.centerVertex,e.nextVertex]],spatialReference:t.coordinateHelper.spatialReference}),symbol:T(e),context:t})}_visualizeSnappingIndicator(e){const{geometry:t,symbol:i,context:a}=e,n=new h["a"]({geometry:t,symbol:i});return a.view.graphics.add(n),Object(r["c"])(()=>{a.view.graphics.remove(n)})}}const v=f["a"].main.toArray(),y=[...f["a"].main.toRgb(),100],O=new l["a"]({outline:new c["a"]({width:1.5,color:v}),size:15,color:[0,0,0,0]}),_=new l["a"]({outline:{width:.5,color:[0,0,0,1]},size:10,color:v}),x=new s["a"]({data:{type:"CIMSymbolReference",symbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",enable:!0,capStyle:"Butt",joinStyle:"Round",miterLimit:10,width:Object(o["i"])(m["a"].lineHintWidthTarget),color:v}]}}}),j=new s["a"]({data:{type:"CIMSymbolReference",symbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMVectorMarker",enable:!0,anchorPoint:{x:0,y:-1,z:0},anchorPointUnits:"Relative",size:5,markerPlacement:{type:"CIMMarkerPlacementOnLine",placePerPart:!0,angleToLine:!0,relativeTo:"LineMiddle"},frame:{xmin:-5,ymin:-1.5,xmax:5,ymax:1.5},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{rings:[[[7,0],[-7,0],[-7,1.5],[7,1.5]]]},symbol:{type:"CIMPolygonSymbol",symbolLayers:[{type:"CIMSolidFill",enable:!0,color:v}]}}],scaleSymbolsProportionally:!0,respectFrame:!0},{type:"CIMVectorMarker",enable:!0,anchorPoint:{x:0,y:1,z:0},anchorPointUnits:"Relative",size:5,markerPlacement:{type:"CIMMarkerPlacementOnLine",placePerPart:!0,angleToLine:!0,relativeTo:"LineMiddle"},frame:{xmin:-5,ymin:-1.5,xmax:5,ymax:1.5},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{rings:[[[7,0],[-7,0],[-7,-1.5],[7,-1.5]]]},symbol:{type:"CIMPolygonSymbol",symbolLayers:[{type:"CIMSolidFill",enable:!0,color:v}]}}],scaleSymbolsProportionally:!0,respectFrame:!0}]}}}),w=e=>new s["a"]({data:{type:"CIMSymbolReference",symbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMVectorMarker",enable:!0,anchorPoint:{x:.5,y:.5,z:0},anchorPointUnits:"Relative",size:Object(o["i"])(m["a"].rightAngleHintSize),rotation:e,markerPlacement:{type:"CIMMarkerPlacementOnVertices",placePerPart:!0,angleToLine:!0,placeOnEndPoints:!1},frame:{xmin:-5,ymin:-5,xmax:5,ymax:5},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{paths:[[[5,-5],[-5,-5],[-5,5],[5,5],[5,-5]]]},symbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",enable:!0,capStyle:"Butt",joinStyle:"Round",miterLimit:10,width:Object(o["i"])(m["a"].rightAngleHintOutlineSize),color:v},{type:"CIMSolidFill",enable:!0,color:y}]}}],scaleSymbolsProportionally:!0,respectFrame:!0}]}}}),S=w(45),C=w(225),T=(()=>{const e=Object(u["b"])(),t=Object(u["b"])(),i=Object(d["e"])();return r=>(Object(p["d"])(e,r.centerVertex,r.previousVertex),Object(p["d"])(t,r.nextVertex,r.previousVertex),Object(p["f"])(i,e,t),i[2]<0?S:C)})()},"157c":function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i("34f2");class a extends r["a"]{constructor(e,t,i,r){super(e),this.dx=t,this.dy=i,this.dz=r}move(e,t,i,r){this.helper.addDelta(e.pos,t,i,r)}apply(e){this.move(e,this.dx,this.dy,this.dz)}undo(e){this.move(e,-this.dx,-this.dy,-this.dz)}canAccumulate(e){return e instanceof a}accumulate(e,t){this.move(e,t.dx,t.dy,t.dz)}accumulateParams(e){this.dx+=e.dx,this.dy+=e.dy,this.dz+=e.dz}}},"15ec":function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i("e041"),a=i("0224");function n(e){return{origin:"portal-item",url:Object(r["J"])(e.itemUrl),portal:e.portal||a["a"].getDefault(),portalItem:e,readResourcePaths:[]}}},1666:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i("32ed");i("fb2c"),i("8c4b");function a(e,t,i){const r=e.length,a=new Array(r),o=new Array(r),c=new Array(r);let l=0,h=0,d=0,u=0;for(let n=0;n<r;++n)u+=e[n].length;const p=new Float64Array(3*u);let f=0;for(let m=r-1;m>=0;m--){const u=e[m],b=1===i&&s(u);if(b&&1!==r)a[l++]=u;else{let e=u.length;for(let t=0;t<l;++t)e+=a[t].length;const i={index:f,pathLengths:new Array(l+1),count:e,holeIndices:new Array(l)};i.pathLengths[0]=u.length,u.length>0&&(c[d++]={index:f,count:u.length}),f=b?n(u,u.length-1,-1,p,f,u.length,t):n(u,0,1,p,f,u.length,t);for(let r=0;r<l;++r){const e=a[r];i.holeIndices[r]=f,i.pathLengths[r+1]=e.length,e.length>0&&(c[d++]={index:f,count:e.length}),f=n(e,0,1,p,f,e.length,t)}l=0,i.count>0&&(o[h++]=i)}}for(let s=0;s<l;++s){const e=a[s];e.length>0&&(c[d++]={index:f,count:e.length}),f=n(e,0,1,p,f,e.length,t)}return h<r&&(o.length=h),d<r&&(c.length=d),{position:p,polygons:o,outlines:c}}function n(e,t,i,r,a,n,s){a*=3;for(let o=0;o<n;++o){const n=e[t];r[a++]=n[0],r[a++]=n[1],r[a++]=s?n[2]:0,t+=i}return a/3}function s(e){return!Object(r["g"])(e,!1,!1)}},"171c":function(e,t,i){"use strict";var r=i("b2b2"),a=i("38a4"),n=i("a915"),s=i("0b2d"),o=i("e431"),c=i("680b"),l=i("d791"),h=i("afe1"),d=i("02f1"),u=i("0fc4"),p=i("3349"),f=i("7577"),m=i("2047"),b=i("d0ac"),g=i("1153");class v{constructor(e=null,t=null,i=null){this._viewUp=Object(s["e"])(),this._viewForward=Object(s["e"])(),this._viewRight=Object(s["e"])(),this._ray=b["g"].createWrapper(),this._viewport=Object(u["d"])(0,0,1,1),this._padding=Object(u["d"])(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=Object(d["f"])(1,1e3),this._viewDirty=!0,this._viewMatrix=Object(h["b"])(),this._projectionDirty=!0,this._projectionMatrix=Object(h["b"])(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=Object(h["b"])(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=Object(h["b"])(),this._frustumDirty=!0,this._frustum=b["d"].create(),this._fullViewport=Object(u["c"])(),this.pixelRatio=1,this.relativeElevation=0,this._eye=Object(r["k"])(e)?Object(s["d"])(e):Object(s["e"])(),this._center=Object(r["k"])(t)?Object(s["d"])(t):Object(s["e"])(),this._up=Object(r["k"])(i)?Object(s["d"])(i):Object(s["g"])(0,0,1)}get eye(){return this._eye}set eye(e){this._compareAndSetView(e,this._eye)}get center(){return this._center}set center(e){this._compareAndSetView(e,this._center)}get ray(){return this._ray.origin=this.eye,this._ray.direction||(this._ray.direction=Object(s["e"])()),Object(o["k"])(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(e){this._compareAndSetView(e,this._up)}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(e){Object(l["c"])(this._viewMatrix,e),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),this._viewForward}get viewUp(){return this._ensureViewClean(),this._viewUp}get viewRight(){return this._ensureViewClean(),this._viewRight}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(e){this._nearFar[0]!==e&&(this._nearFar[0]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get far(){return this._nearFar[1]}set far(e){this._nearFar[1]!==e&&(this._nearFar[1]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get viewport(){return this._viewport}set viewport(e){this.x=e[0],this.y=e[1],this.width=e[2],this.height=e[3]}get x(){return this._viewport[0]}set x(e){e+=this._padding[3],this._viewport[0]!==e&&(this._viewport[0]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get y(){return this._viewport[1]}set y(e){e+=this._padding[2],this._viewport[1]!==e&&(this._viewport[1]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get width(){return this._viewport[2]}set width(e){this._viewport[2]!==e&&(this._viewport[2]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get height(){return this._viewport[3]}set height(e){this._viewport[3]!==e&&(this._viewport[3]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get fullWidth(){return this._viewport[2]+this._padding[1]+this._padding[3]}set fullWidth(e){this.width=e-(this._padding[1]+this._padding[3])}get fullHeight(){return this._viewport[3]+this._padding[0]+this._padding[2]}set fullHeight(e){this.height=e-(this._padding[0]+this._padding[2])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[3],this._fullViewport[1]=this._viewport[1]-this._padding[2],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get aspect(){return this.width/this.height}get padding(){return this._padding}set padding(e){this._padding[0]===e[0]&&this._padding[1]===e[1]&&this._padding[2]===e[2]&&this._padding[3]===e[3]||(this._viewport[0]+=e[3]-this._padding[3],this._viewport[1]+=e[2]-this._padding[2],this._viewport[2]-=e[1]+e[3]-(this._padding[1]+this._padding[3]),this._viewport[3]-=e[0]+e[2]-(this._padding[0]+this._padding[2]),Object(f["c"])(this._padding,e),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get viewProjectionMatrix(){return this._viewProjectionDirty&&(Object(l["m"])(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){if(this._projectionDirty){const e=this.width,t=this.height,i=this.near*Math.tan(this.fovY/2),r=i*this.aspect;Object(l["h"])(this._projectionMatrix,-r*(1+2*this._padding[3]/e),r*(1+2*this._padding[1]/e),-i*(1+2*this._padding[2]/t),i*(1+2*this._padding[0]/t),this.near,this.far),this._projectionDirty=!1}return this._projectionMatrix}set projectionMatrix(e){Object(l["c"])(this._projectionMatrix,e),this._projectionDirty=!1,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fov(){return this._fov}set fov(e){this._fov=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return Object(g["b"])(this._fov,this.width,this.height)}set fovX(e){this._fov=Object(g["d"])(e,this.width,this.height),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return Object(g["c"])(this._fov,this.width,this.height)}set fovY(e){this._fov=Object(g["e"])(e,this.width,this.height),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return Object(o["p"])(this._center,this._eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&(Object(l["a"])(this._viewInverseTransposeMatrix,this.viewMatrix),Object(l["b"])(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(e){const t=2*e-1;return 2*this.near*this.far/(this.far+this.near-t*(this.far-this.near))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return this.relativeElevation&&this.relativeElevation>=0}copyFrom(e){const t=e;return Object(o["l"])(this._eye,t._eye),Object(o["l"])(this._center,t._center),Object(o["l"])(this._up,t._up),Object(f["c"])(this._viewport,t._viewport),Object(f["c"])(this._padding,t._padding),Object(p["c"])(this._nearFar,t._nearFar),this._fov=t._fov,this.relativeElevation=e.relativeElevation,this._viewDirty=t._viewDirty,this._viewDirty||(Object(l["c"])(this._viewMatrix,t._viewMatrix),Object(o["l"])(this._viewRight,t._viewRight),Object(o["l"])(this._viewUp,t._viewUp),Object(o["l"])(this._viewForward,t._viewForward)),t._projectionDirty?this._projectionDirty=!0:(Object(l["c"])(this._projectionMatrix,t._projectionMatrix),this._projectionDirty=!1),this._viewProjectionDirty=!0,this._frustumDirty=t._frustumDirty,this._frustumDirty||(b["d"].copy(t._frustum,this._frustum),this._frustumDirty=!1),t._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:(Object(l["c"])(this._viewInverseTransposeMatrix,t._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),Object(f["c"])(this._fullViewport,t._fullViewport),this.pixelRatio=e.pixelRatio,this}copyViewFrom(e){this.eye=e.eye,this.center=e.center,this.up=e.up}clone(){return(new v).copyFrom(this)}equals(e){return Object(o["r"])(this._eye,e._eye)&&Object(o["r"])(this._center,e._center)&&Object(o["r"])(this._up,e._up)&&Object(f["g"])(this._viewport,e._viewport)&&Object(f["g"])(this._padding,e._padding)&&Object(p["k"])(this._nearFar,e._nearFar)&&this._fov===e._fov&&this.pixelRatio===e.pixelRatio&&this.relativeElevation===e.relativeElevation}almostEquals(e){if(this.pixelRatio!==e.pixelRatio||Math.abs(e.fov-this._fov)>=.001)return!1;const t=5e-4,i=1-1e-10;Object(o["w"])(_,e.eye,e.center),Object(o["w"])(x,this._eye,this._center);const r=Object(o["i"])(_,x),a=Object(o["z"])(_),n=Object(o["z"])(x);return r*r>=i*a*n&&Object(o["A"])(e.eye,this._eye)<Math.max(a,n)*t*t&&Object(f["i"])(e.padding,this._padding)<.5&&Object(f["i"])(e.viewport,this._viewport)<.5}markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}computeRenderPixelSizeAt(e){return this.computeRenderPixelSizeAtDist(this.viewDirectionDistance(e))}computeRenderPixelSizeAtDist(e){return e*this.perRenderPixelRatio}computeScreenPixelSizeAt(e){return this.computeScreenPixelSizeAtDist(this.viewDirectionDistance(e))}viewDirectionDistance(e){return Math.abs(Object(m["c"])(this.viewForward,Object(o["k"])(_,e,this._eye)))}computeScreenPixelSizeAtDist(e){return e*this.perScreenPixelRatio}computeDistanceFromRadius(e,t){return e/Math.tan(Math.min(this.fovX,this.fovY)/(2*(t||1)))}getScreenCenter(e=Object(n["g"])()){return e[0]=(this.padding[3]+this.width/2)/this.pixelRatio,e[1]=(this.padding[0]+this.height/2)/this.pixelRatio,e}getRenderCenter(e,t=.5,i=.5){return e||(e=Object(n["e"])()),e[0]=this.padding[3]+this.width*t,e[1]=this.padding[2]+this.height*i,e.length>2&&(e[2]=.5),e}setGLViewport(e){const t=this.viewport,i=this.padding;e.setViewport(t[0]-i[3],t[1]-i[2],t[2]+i[1]+i[3],t[3]+i[0]+i[2])}applyProjection(e,t,i=!1){e!==y&&Object(o["l"])(y,e),y[3]=1,i&&(t[2]=-y[2]),Object(f["m"])(y,y,this.projectionMatrix),Object(o["f"])(y,y,1/Math.abs(y[3]));const r=this.fullViewport;return t[0]=Object(a["l"])(0,r[0]+r[2],.5+.5*y[0]),t[1]=Object(a["l"])(0,r[1]+r[3],.5+.5*y[1]),i||(t[2]=.5*(y[2]+1)),t}projectToScreen(e,t){return this.projectToRenderScreen(e,j),this.renderToScreen(j,t)}projectToRenderScreen(e,t){if(y[0]=e[0],y[1]=e[1],y[2]=e[2],y[3]=1,Object(f["m"])(y,y,this.viewProjectionMatrix),0===y[3])return null;Object(o["f"])(y,y,1/Math.abs(y[3]));const i=this.fullViewport;return"x"in t?(t.x=Object(a["l"])(0,i[0]+i[2],.5+.5*y[0]),t.y=Object(a["l"])(0,i[1]+i[3],.5+.5*y[1])):(t[0]=Object(a["l"])(0,i[0]+i[2],.5+.5*y[0]),t[1]=Object(a["l"])(0,i[1]+i[3],.5+.5*y[1]),t.length>2&&(t[2]=.5*(y[2]+1))),t}unprojectFromScreen(e,t){return this.unprojectFromRenderScreen(this.screenToRender(e,j),t)}unprojectFromRenderScreen(e,t){if(Object(l["m"])(O,this.projectionMatrix,this.viewMatrix),!Object(l["a"])(O,O))return null;const i=this.fullViewport;return y[0]=2*(e[0]-i[0])/i[2]-1,y[1]=2*(e[1]-i[1])/i[3]-1,y[2]=2*e[2]-1,y[3]=1,Object(f["m"])(y,y,O),0===y[3]?null:(t[0]=y[0]/y[3],t[1]=y[1]/y[3],t[2]=y[2]/y[3],t)}constrainWindowSize(e,t,i,r=1){const a=e*this.pixelRatio,n=t*this.pixelRatio,s=Math.max(a-i*r/2,0),o=Math.max(this.fullHeight-n-i/2,0),c=-Math.min(a-i*r/2,0),l=-Math.min(this.fullHeight-n-i/2,0);return[s,o,i*r-c- -Math.min(this.fullWidth-a-i*r/2,0),i-l- -Math.min(n-i/2,0)]}computeUp(e){1===e?this.computeUpGlobal():this.computeUpLocal()}screenToRender(e,t){const i=e[0]*this.pixelRatio,r=this.fullHeight-e[1]*this.pixelRatio;return t[0]=i,t[1]=r,t}renderToScreen(e,t){const i=e[0]/this.pixelRatio,r=(this.fullHeight-e[1])/this.pixelRatio;return t[0]=i,t[1]=r,t}computeUpGlobal(){Object(o["k"])(_,this.center,this.eye);const e=Object(o["q"])(this.center);e<1?(Object(o["x"])(this.up,0,0,1),this.markViewDirty()):Math.abs(Object(o["i"])(_,this.center))>.9999*Object(o["q"])(_)*e||(Object(o["h"])(this.up,_,this.center),Object(o["h"])(this.up,this.up,_),Object(o["s"])(this.up,this.up),this.markViewDirty())}computeUpLocal(){Object(c["h"])(_,this.eye,this.center),Math.abs(_[2])<=.9999&&(Object(o["f"])(_,_,_[2]),Object(o["x"])(this.up,-_[0],-_[1],1-_[2]),Object(o["s"])(this.up,this.up),this.markViewDirty())}_compareAndSetView(e,t){Object(o["r"])(e,t)||(Object(o["l"])(t,e),this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0)}_recomputeFrustum(){this._frustumDirty&&(b["d"].fromMatrix(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&(Object(l["l"])(this._viewMatrix,this._eye,this._center,this._up),Object(o["x"])(this._viewForward,-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10]),Object(o["x"])(this._viewUp,this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9]),Object(o["x"])(this._viewRight,this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8]),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}}const y=Object(u["c"])(),O=Object(h["b"])(),_=Object(s["e"])(),x=Object(s["e"])(),j=Object(n["e"])();t["a"]=v},"173c":function(e,t,i){"use strict";i.r(t);var r=i("a4ee"),a=i("debd"),n=(i("c120"),i("7ffa")),s=i("e92d"),o=(i("cea0"),i("59b2")),c=i("afcf"),l=i("d386"),h=i("09db"),d=i("ce50"),u=i("e041"),p=(i("8eed"),i("f402"),i("f4cc")),f=i("5996"),m=i("3af1"),b=i("2eab"),g=i("a6a3"),v=i("e694"),y=i("b911"),O=i("3d59"),_=i("997b"),x=i("0db5"),j=i("5a62"),w=i("dff3"),S=i("9651"),C=i("b485");function T(e){const t={lossy:"UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",lossless:"UklGRhoAAABXRUJQVlA4TA0AAAAvAAAAEAcQERGIiP4HAA==",alpha:"UklGRkoAAABXRUJQVlA4WAoAAAAQAAAAAAAAAAAAQUxQSAwAAAARBxAR/Q9ERP8DAABWUDggGAAAABQBAJ0BKgEAAQAAAP4AAA3AAP7mtQAAAA==",animation:"UklGRlIAAABXRUJQVlA4WAoAAAASAAAAAAAAAAAAQU5JTQYAAAD/////AABBTk1GJgAAAAAAAAAAAAAAAAAAAGQAAABWUDhMDQAAAC8AAAAQBxAREYiI/gcA"};return new Promise(i=>{const r=new Image;r.onload=()=>{r.onload=r.onerror=null,i(r.width>0&&r.height>0)},r.onerror=()=>{r.onload=r.onerror=null,i(!1)},r.src="data:image/webp;base64,"+t[e]})}const P=s["a"].getLogger("esri.layers.support.SpriteSource"),A=1.15;class R{constructor(e,t,i,r){this.baseURL=e,this.devicePixelRatio=t,this.maxTextureSize=i,this._spriteImageFormat=r,this._isRetina=!1,this._spritesData={},this.image=null,this.width=null,this.height=null,this.loadStatus="not-loaded"}get spriteNames(){const e=[];for(const t in this._spritesData)e.push(t);return e.sort(),e}getSpriteInfo(e){return this._spritesData[e]}async load(e){if(this.baseURL){this.loadStatus="loading";try{await this._loadSprites(e),this.loadStatus="loaded"}catch{this.loadStatus="failed"}}else this.loadStatus="failed"}_loadSprites(e){this._isRetina=this.devicePixelRatio>A;const t=Object(u["J"])(this.baseURL),i=t.query?"?"+Object(u["D"])(t.query):"",r=this._isRetina?"@2x":"",a=`${t.path}${r}.${this._spriteImageFormat}${i}`,n=`${t.path}${r}.json${i}`;return Promise.all([Object(b["default"])(n,e),Object(b["default"])(a,{responseType:"image",...e})]).then(([e,i])=>{const r=Object.keys(e.data);if(!r||0===r.length||1===r.length&&"_ssl"===r[0]||!i||!i.data)return this._spritesData=this.image=null,this.width=this.height=0,Promise.resolve(null);this._spritesData=e.data;const a=i.data,n=Math.max(this.maxTextureSize,4096);if(a.width>n||a.height>n){const e=`Sprite resource for style ${t.path} is bigger than the maximum allowed of ${n} pixels}`;throw P.error(e),new d["a"]("SpriteSource",e)}this.width=a.width,this.height=a.height;const s=document.createElement("canvas"),o=s.getContext("2d");s.width=a.width,s.height=a.height,o.drawImage(a,0,0,a.width,a.height);const c=o.getImageData(0,0,a.width,a.height),l=new Uint8Array(c.data);let h;for(let t=0;t<l.length;t+=4)h=l[t+3]/255,l[t]=l[t]*h,l[t+1]=l[t+1]*h,l[t+2]=l[t+2]*h;this.image=l})}}var M=R,E=i("1325"),D=i("ab68"),I=i("2582");class L{constructor(e,t,i){this.tileMapURL="",this.tilemapCache=null,this.parsedUrl=null,this.tileInfo=null,this.capabilities=null,this.tileIndex=null,this.fullExtent=null,this.name=e,this.sourceUrl=t,t&&(this.parsedUrl=Object(u["J"])(this.sourceUrl));const r=this.parsedUrl.path,a=this.parsedUrl.query?"?"+Object(u["D"])(this.parsedUrl.query):"",s=Object(n["a"])(i),o=s.tiles;t&&o.forEach((e,t)=>{Object(u["s"])(e)||(o[t]=Object(u["y"])(r,e)+a)}),this.tileServers=o,i.tileMap&&(this.tileMapURL=Object(u["y"])(t,i.tileMap));const c=i.capabilities&&i.capabilities.split(",").map(e=>e.toLowerCase().trim()),l=!!i.exportTilesAllowed,h=!!c&&-1!==c.indexOf("tilemap"),d=l&&i.hasOwnProperty("maxExportTilesCount")?i.maxExportTilesCount:0;this.capabilities={operations:{supportsExportTiles:l,supportsTileMap:h},exportTiles:l?{maxExportTilesCount:+d}:null},this.tileInfo=Object(D["a"])(s.tileInfo,s,null,{ignoreMinMaxLOD:!0}),h&&(this.type="vector-tile",this.tilemapCache=new S["a"]({layer:this}),this.tilemapCache&&(this.tileIndex=new I["a"](this.tilemapCache))),this.fullExtent=m["a"].fromJSON(i.fullExtent)}getRefKey(e,t){return this.tileIndex?this.tileIndex.dataKey(e,t):Promise.resolve(e)}getSourceTileUrl(e,t,i){let r=this.tileServers[t%this.tileServers.length];return r=r.replace(/\{z\}/gi,e.toString()).replace(/\{y\}/gi,t.toString()).replace(/\{x\}/gi,i.toString()),r}isCompatibleWith(e){const t=this.tileInfo,i=e.tileInfo;if(!t.spatialReference.equals(i.spatialReference))return!1;if(!t.origin.equals(i.origin))return!1;if(Math.round(t.dpi)!==Math.round(i.dpi))return!1;const r=t.lods,a=i.lods,n=Math.min(r.length,a.length);for(let s=0;s<n;s++){const e=r[s],t=a[s];if(e.level!==t.level||Math.round(e.scale)!==Math.round(t.scale))return!1}return!0}}var V=L;const k=E["a"].defaults&&E["a"].defaults.io.corsEnabledServers;async function F(e,t){const i={source:null,sourceBase:null,sourceUrl:null,validatedSource:null,style:null,styleBase:null,styleUrl:null,sourceNameToSource:{},primarySourceName:"",spriteFormat:"png"},[r,a]="string"==typeof e?[e,null]:[null,e.jsonUrl],n=r?Object(u["J"])(r):null;await G(i,"esri",e,a,t);const s={layerDefinition:i.validatedSource,url:r,parsedUrl:n,serviceUrl:i.sourceUrl,style:i.style,styleUrl:i.styleUrl,spriteUrl:i.style.sprite&&U(i.styleBase,i.style.sprite),spriteFormat:i.spriteFormat,glyphsUrl:i.style.glyphs&&U(i.styleBase,i.style.glyphs),sourceNameToSource:i.sourceNameToSource,primarySourceName:i.primarySourceName};return z(s.spriteUrl),z(s.glyphsUrl),s}function z(e){if(!e)return;const t=Object(u["m"])(e);k&&-1===k.indexOf(t)&&k.push(t)}function U(...e){let t;for(let i=0;i<e.length;++i)if(Object(u["v"])(e[i])){if(t){const r=t.split("://")[0];t=r+":"+e[i].trim()}}else t=Object(u["s"])(e[i])?e[i]:Object(u["y"])(t,e[i]);return Object(u["H"])(t)}async function G(e,t,i,r,a){let n,s,o;if(Object(p["w"])(a),"string"==typeof i){const e=Object(u["C"])(i);z(e);const t=Object(u["J"])(e);o=await Object(b["default"])(t.path,{query:{f:"json"},responseType:"json",...a}),n=e,s=e}else o={data:i},n=i.jsonUrl||null,s=r;const c=o.data;return o.ssl&&(n&&(n=n.replace(/^http:/i,"https:")),s&&(s=s.replace(/^http:/i,"https:"))),B(c)?(e.styleUrl=n||null,N(e,c,s,a)):H(c)?e.sourceUrl?q(e,c,s,!1,t,a):(e.sourceUrl=n||null,q(e,c,s,!0,t,a)):Promise.reject("You must specify the URL or the JSON for a service or for a style.")}function B(e){return!!e.sources}function H(e){return!B(e)}async function N(e,t,i,r){const a=i?Object(u["F"])(i):u["f"];e.styleBase=a,e.style=t,e.styleUrl&&z(e.styleUrl),t["sprite-format"]&&"webp"===t["sprite-format"].toLowerCase()&&(e.spriteFormat="webp");const n=[];if(t.sources&&t.sources.esri){const i=t.sources.esri;i.url?await G(e,"esri",U(a,i.url),void 0,r):n.push(G(e,"esri",i,a,r))}for(const s of Object.keys(t.sources))"esri"!==s&&"vector"===t.sources[s].type&&(t.sources[s].url?n.push(G(e,s,U(a,t.sources[s].url),void 0,r)):t.sources[s].tiles&&n.push(G(e,s,t.sources[s],a,r)));await Promise.all(n)}async function q(e,t,i,r,a,n){const s=i?Object(u["H"])(i)+"/":u["f"],o=W(t,s),c=new V(a,s,o);if(!r&&e.primarySourceName in e.sourceNameToSource){const t=e.sourceNameToSource[e.primarySourceName];if(!t.isCompatibleWith(c))return Promise.resolve();null!=c.fullExtent&&(null!=t.fullExtent?t.fullExtent.union(c.fullExtent):t.fullExtent=c.fullExtent.clone()),t.tileInfo.lods.length<c.tileInfo.lods.length&&(t.tileInfo=c.tileInfo)}if(r?(e.sourceBase=s,e.source=t,e.validatedSource=o,e.primarySourceName=a,e.sourceUrl&&z(e.sourceUrl)):z(s),e.sourceNameToSource[a]=c,!e.style)return null==t.defaultStyles?Promise.reject():"string"==typeof t.defaultStyles?G(e,"",U(s,t.defaultStyles,"root.json"),void 0,n):G(e,"",t.defaultStyles,U(s,"root.json"),n)}function W(e,t){if(e.hasOwnProperty("tileInfo"))return e;const i={xmin:-20037507.067161843,ymin:-20037507.067161843,xmax:20037507.067161843,ymax:20037507.067161843,spatialReference:{wkid:102100}},r=512;let a=78271.51696400007,n=295828763.7957775;const s=[],o=e.hasOwnProperty("minzoom")?parseFloat(e.minzoom):0,c=e.hasOwnProperty("maxzoom")?parseFloat(e.maxzoom):22;for(let l=0;l<=c;l++)l>=o&&s.push({level:l,scale:n,resolution:a}),a/=2,n/=2;for(const l of e.tiles)z(U(t,l));return{capabilities:"TilesOnly",initialExtent:i,fullExtent:i,minScale:0,maxScale:0,tiles:e.tiles,tileInfo:{rows:r,cols:r,dpi:96,format:"pbf",origin:{x:-20037508.342787,y:20037508.342787},lods:s,spatialReference:{wkid:102100}}}}var Z=i("15ec"),$=i("1cb4");const Q=1e-6;function X(e,t){if(e===t)return!0;if(!e&&null!=t)return!1;if(null!=e&&!t)return!1;if(!e.spatialReference.equals(t.spatialReference)||e.dpi!==t.dpi)return!1;const i=e.origin,r=t.origin;if(Math.abs(i.x-r.x)>=Q||Math.abs(i.y-r.y)>=Q)return!1;let a,n;e.lods[0].scale>t.lods[0].scale?(a=e,n=t):(n=e,a=t);for(let s=a.lods[0].scale;s>=n.lods[n.lods.length-1].scale-Q;s/=2)if(Math.abs(s-n.lods[0].scale)<Q)return!0;return!1}function Y(e,t){if(e===t)return e;if(!e&&null!=t)return t;if(null!=e&&!t)return e;const i=e.size[0],r=e.format,a=e.dpi,n={x:e.origin.x,y:e.origin.y},s=e.spatialReference.toJSON(),o=e.lods[0].scale>t.lods[0].scale?e.lods[0]:t.lods[0],c=e.lods[e.lods.length-1].scale<=t.lods[t.lods.length-1].scale?e.lods[e.lods.length-1]:t.lods[t.lods.length-1],l=o.scale,h=o.resolution,d=c.scale,u=[];let p=l,f=h,m=0;for(;p>d;)u.push({level:m,resolution:f,scale:p}),m++,p/=2,f/=2;return new w["a"]({size:[i,i],dpi:a,format:r||"pbf",origin:n,lods:u,spatialReference:s})}var K=i("901e"),J=i("b2af");let ee=class extends(Object(_["a"])(Object(j["a"])(Object(C["a"])(Object(O["a"])(Object(y["a"])(Object(x["a"])(Object(v["a"])(g["a"])))))))){constructor(...e){super(...e),this._spriteSourceMap=new Map,this.currentStyleInfo=null,this.style=null,this.isReference=null,this.operationalLayerType="VectorTileLayer",this.type="vector-tile",this.url=null}normalizeCtorArgs(e,t){return"string"==typeof e?{url:e,...t}:e}destroy(){this._spriteSourceMap.clear()}async prefetchResources(e){await this.loadSpriteSource(a["a"].devicePixelRatio||1,e)}load(e){const t=this.loadFromPortal({supportedTypes:["Vector Tile Service"],supportsData:!1},e).then(async()=>{if(!this.portalItem||!this.portalItem.id)return;const t=this.portalItem.itemUrl+"/resources/styles/root.json";(await Object(b["default"])(t,{...e,query:{f:"json"}})).data&&this.read({url:t},Object(Z["a"])(this.portalItem))}).then(()=>this._loadStyle(e),()=>this._loadStyle(e));return this.addResolvingPromise(t),Promise.resolve(this)}get attributionDataUrl(){const e=this.currentStyleInfo,t=e&&e.serviceUrl&&Object(u["J"])(e.serviceUrl);return t?this._getDefaultAttribution(t.path):null}get capabilities(){const e=this._getPrimarySource();return e?e.capabilities:{operations:{supportsExportTiles:!1,supportsTileMap:!1},exportTiles:null}}get fullExtent(){const e=this._getPrimarySource();return e?e.fullExtent:null}get parsedUrl(){return this.serviceUrl?Object(u["J"])(this.serviceUrl):null}get serviceUrl(){return this.currentStyleInfo&&this.currentStyleInfo.serviceUrl||null}get spatialReference(){return this.tileInfo&&this.tileInfo.spatialReference||null}get styleUrl(){return this.currentStyleInfo&&this.currentStyleInfo.styleUrl||null}writeStyleUrl(e,t){e&&Object(u["v"])(e)&&(e="https:"+e),t.styleUrl=e}get tileIndexType(){const e=this._getPrimarySource();return e?e.type:""}get tileIndexUrl(){const e=this._getPrimarySource();return e?e.tileMapURL:""}get tileInfo(){var e;const t=[];for(const r in this.sourceNameToSource)t.push(this.sourceNameToSource[r]);let i=(null==(e=this._getPrimarySource())?void 0:e.tileInfo)||new w["a"];if(t.length>1)for(let r=0;r<t.length;r++)X(i,t[r].tileInfo)&&(i=Y(i,t[r].tileInfo));return i}get tilemapCache(){const e=this._getPrimarySource();return e&&e.capabilities.operations.supportsTileMap?e.tilemapCache:null}get tileServers(){const e=this._getPrimarySource();return e?e.tileServers:[]}readVersion(e,t){return t.version?parseFloat(t.version):parseFloat(t.currentVersion)}get compatibleTileInfo256(){return $["a"].create256x256CompatibleTileInfo(this.tileInfo)}get compatibleTileInfo512(){return $["a"].create512x512CompatibleTileInfo(this.tileInfo)}async loadSpriteSource(e=1,t){if(!this._spriteSourceMap.has(e)){const i=Object(J["a"])(),r=new M(this.styleRepository.sprite,e,i.maxTextureSize,this.currentStyleInfo.spriteFormat);await r.load(t),this._spriteSourceMap.set(e,r)}return Promise.resolve(this._spriteSourceMap.get(e))}async loadStyle(e,t){const i=e||this.style||this.url;if(this._loadingPromise&&"string"==typeof i&&this.url===i&&!Object(p["o"])(this._abortController))return this._loadingPromise;const r=this._abortController;r&&r.abort();const a=Object(p["e"])();return this._loadingPromise=new Promise((e,r)=>{const n={signal:a.signal};this._spriteSourceMap.clear(),this._getSourceAndStyle(i,n).then(e,r),Object(p["r"])(t,()=>{a.abort()})}),this._abortController=a,this._loadingPromise}getStyleLayerId(e){return this.styleRepository.getStyleLayerId(e)}getStyleLayerIndex(e){return this.styleRepository.getStyleLayerIndex(e)}getPaintProperties(e){return Object(n["a"])(this.styleRepository.getPaintProperties(e))}setPaintProperties(e,t){const i=this.styleRepository.isPainterDataDriven(e);this.styleRepository.setPaintProperties(e,t);const r=this.styleRepository.isPainterDataDriven(e);this.emit("paint-change",{layerName:e,paint:t,isDataDriven:i||r})}getStyleLayer(e){return Object(n["a"])(this.styleRepository.getStyleLayer(e))}setStyleLayer(e,t){this.styleRepository.setStyleLayer(e,t),this.emit("style-layer-change",{layer:e,index:t})}deleteStyleLayer(e){this.styleRepository.deleteStyleLayer(e),this.emit("delete-style-layer",{layerName:e})}getLayoutProperties(e){return Object(n["a"])(this.styleRepository.getLayoutProperties(e))}setLayoutProperties(e,t){this.styleRepository.setLayoutProperties(e,t),this.emit("layout-change",{layer:e,layout:t})}setStyleLayerVisibility(e,t){this.styleRepository.setStyleLayerVisibility(e,t),this.emit("style-layer-visibility-change",{layer:e,visibility:t})}getStyleLayerVisibility(e){return this.styleRepository.getStyleLayerVisibility(e)}getTileUrl(e,t,i){let r=this.tileServers[t%this.tileServers.length];return r=r.replace(/\{z\}/gi,e.toString()).replace(/\{y\}/gi,t.toString()).replace(/\{x\}/gi,i.toString()),r}write(e,t){return t&&t.origin&&!this.styleUrl?(t.messages&&t.messages.push(new d["a"]("vectortilelayer:unsupported",`VectorTileLayer (${this.title}, ${this.id}) with style defined by JSON only are not supported`,{layer:this})),null):super.write(e,t)}async _getSourceAndStyle(e,t){if(!e)throw new Error("invalid style!");const i=await F(e,t);"webp"===i.spriteFormat&&(await T("lossy")||(i.spriteFormat="png")),this._set("currentStyleInfo",{...i}),"string"==typeof e?(this.url=e,this.style=null):(this.url=null,this.style=e),this._set("sourceNameToSource",i.sourceNameToSource),this._set("primarySourceName",i.primarySourceName),this._set("styleRepository",new K["a"](i.style,i)),this.read(i.layerDefinition,{origin:"service"}),this.emit("load-style",{})}_getDefaultAttribution(e){const t=e.match(/^https?:\/\/(?:basemaps|basemapsbeta|basemapsdev)(?:-api)?\.arcgis\.com(\/[^\/]+)?\/arcgis\/rest\/services\/([^\/]+(\/[^\/]+)*)\/vectortileserver/i),i=["OpenStreetMap_v2","OpenStreetMap_Daylight_v2","OpenStreetMap_Export_v2","OpenStreetMap_FTS_v2","OpenStreetMap_GCS_v2","World_Basemap","World_Basemap_v2","World_Basemap_Export_v2","World_Basemap_GCS_v2","World_Basemap_WGS84","World_Contours_v2"];if(!t)return;const r=t[2]&&t[2].toLowerCase();if(!r)return;const a=t[1]||"";for(const n of i)if(n.toLowerCase().indexOf(r)>-1)return Object(u["C"])(`//static.arcgis.com/attribution/Vector${a}/${n}`)}_getPrimarySource(){return this.sourceNameToSource&&this.primarySourceName in this.sourceNameToSource?this.sourceNameToSource[this.primarySourceName]:null}async _loadStyle(e){return this._loadingPromise?this._loadingPromise:this.loadStyle(null,e)}};Object(r["a"])([Object(o["b"])({readOnly:!0})],ee.prototype,"attributionDataUrl",null),Object(r["a"])([Object(o["b"])({type:["show","hide"]})],ee.prototype,"listMode",void 0),Object(r["a"])([Object(o["b"])({readOnly:!0,dependsOn:["sourceNameToSource","primarySourceName"],json:{read:!1}})],ee.prototype,"capabilities",null),Object(r["a"])([Object(o["b"])({readOnly:!0})],ee.prototype,"currentStyleInfo",void 0),Object(r["a"])([Object(o["b"])({json:{read:!1},readOnly:!0,type:m["a"]})],ee.prototype,"fullExtent",null),Object(r["a"])([Object(o["b"])()],ee.prototype,"style",void 0),Object(r["a"])([Object(o["b"])({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],ee.prototype,"isReference",void 0),Object(r["a"])([Object(o["b"])({type:["VectorTileLayer"]})],ee.prototype,"operationalLayerType",void 0),Object(r["a"])([Object(o["b"])({readOnly:!0})],ee.prototype,"parsedUrl",null),Object(r["a"])([Object(o["b"])({readOnly:!0})],ee.prototype,"serviceUrl",null),Object(r["a"])([Object(o["b"])({type:f["a"],readOnly:!0})],ee.prototype,"spatialReference",null),Object(r["a"])([Object(o["b"])({readOnly:!0})],ee.prototype,"styleRepository",void 0),Object(r["a"])([Object(o["b"])({readOnly:!0})],ee.prototype,"sourceNameToSource",void 0),Object(r["a"])([Object(o["b"])({readOnly:!0})],ee.prototype,"primarySourceName",void 0),Object(r["a"])([Object(o["b"])({type:String,readOnly:!0,json:{write:{ignoreOrigin:!0},origins:{"web-document":{write:{ignoreOrigin:!0,isRequired:!0}}}}})],ee.prototype,"styleUrl",null),Object(r["a"])([Object(h["a"])(["portal-item","web-document"],"styleUrl")],ee.prototype,"writeStyleUrl",null),Object(r["a"])([Object(o["b"])({json:{read:!1},readOnly:!0})],ee.prototype,"tileIndexType",null),Object(r["a"])([Object(o["b"])({json:{read:!1},readOnly:!0})],ee.prototype,"tileIndexUrl",null),Object(r["a"])([Object(o["b"])({json:{read:!1,origins:{service:{read:!1}}},readOnly:!0,type:w["a"]})],ee.prototype,"tileInfo",null),Object(r["a"])([Object(o["b"])({json:{read:!1},readOnly:!0,type:S["a"]})],ee.prototype,"tilemapCache",null),Object(r["a"])([Object(o["b"])({json:{read:!1},readOnly:!0})],ee.prototype,"tileServers",null),Object(r["a"])([Object(o["b"])({json:{read:!1},readOnly:!0,value:"vector-tile"})],ee.prototype,"type",void 0),Object(r["a"])([Object(o["b"])({json:{origins:{"web-document":{read:{source:"styleUrl"}},"portal-item":{read:{source:"url"}}},write:!1,read:!1}})],ee.prototype,"url",void 0),Object(r["a"])([Object(o["b"])({readOnly:!0})],ee.prototype,"version",void 0),Object(r["a"])([Object(c["a"])("version",["version","currentVersion"])],ee.prototype,"readVersion",null),Object(r["a"])([Object(o["b"])({readOnly:!0})],ee.prototype,"compatibleTileInfo256",null),Object(r["a"])([Object(o["b"])({readOnly:!0})],ee.prototype,"compatibleTileInfo512",null),ee=Object(r["a"])([Object(l["a"])("esri.layers.VectorTileLayer")],ee);var te=ee;t["default"]=te},1797:function(e,t,i){"use strict";i.d(t,"a",(function(){return l})),i.d(t,"b",(function(){return c}));var r=i("b2b2"),a=i("b50f"),n=i("f4cc"),s=i("57dc"),o=(i("e06a"),i("9305"));class c{constructor(e,t){this.spatialReference=e,this.view=t}getElevation(e,t,i){return this.view.elevationProvider.getElevation(e,t,0,this.spatialReference,i)}async queryElevation(e,t,i,r,a){return this.view.elevationProvider.queryElevation(e,t,0,this.spatialReference,a,i,r)}}class l{constructor(e,t,i,r){this.spatialReference=t,this._getElevationQueryProvider=i,this._queries=new Array,this._queryOptions={...r,ignoreInvisibleLayers:!0},this._frameTask=e.registerTask(o["b"].ELEVATION_QUERY,()=>this._update(),()=>this._queries.length>0)}destroy(){this._frameTask.remove()}queryElevation(e,t,i,r=0){return new Promise((s,o)=>{const c={x:e,y:t,minDemResolution:r,result:{resolve:s,reject:o},signal:i};this._queries.push(c),Object(n["r"])(i,()=>{Object(a["k"])(this._queries,c),o(Object(n["f"])())})})}_update(){const e=this._queries;this._queries=[];const t=this._getElevationQueryProvider();if(!t)return void e.forEach(e=>e.result.reject());const i=e.map(e=>[e.x,e.y]),a=e.reduce((e,t)=>Math.min(e,t.minDemResolution),1/0),o=new s["a"]({points:i,spatialReference:this.spatialReference}),c=e.length>1&&e.some(e=>!!e.signal)?Object(n["e"])():null,l=Object(r["k"])(c)?c.signal:e[0].signal;if(Object(r["k"])(c)){let t=0;e.forEach(i=>Object(n["r"])(i.signal,()=>{t++,i.result.reject(Object(n["f"])()),t===e.length&&c.abort()}))}const h={...this._queryOptions,minDemResolution:a,signal:l};t.queryElevation(o,h).then(t=>{e.forEach((e,i)=>{Object(r["k"])(e.signal)&&e.signal.aborted?e.result.reject(Object(n["f"])()):e.result.resolve(t.geometry.points[i][2])})}).catch(t=>{e.forEach(e=>e.result.reject(t))})}get test(){const e=this;return{update:()=>e._queries.length>0&&e._update()}}}},"17ca":function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i("3886");function a(e){e.vertex.code.add(r["a"]`
    vec4 offsetBackfacingClipPosition(vec4 posClip, vec3 posWorld, vec3 normalWorld, vec3 camPosWorld) {
      vec3 camToVert = posWorld - camPosWorld;

      bool isBackface = dot(camToVert, normalWorld) > 0.0;
      if (isBackface) {
        posClip.z += 0.0000003 * posClip.w;
      }
      return posClip;
    }
  `)}},"191a":function(e,t,i){"use strict";var r=i("b2b2"),a=i("d791"),n=i("28eb"),s=i("afe1"),o=i("2ebb"),c=i("1153"),l=i("7ce4"),h=i("8539"),d=i("0fa6"),u=i("b623"),p=i("38a4");class f{constructor(e){null==e?e=16:e<65536&&(e=Object(p["o"])(e)),this._array=new Float32Array(e),this._size=0}resize(e,t){if(this._size=e,this._size>this._array.length){let e=this._array.length||1;for(;e<this._size;)e*=2;const i=new Float32Array(e);return t&&i.set(this._array),this._array=i,!0}const i=2*this._size;if(i<=this._array.length){let e=this._array.length;for(;e>=i;)e=Math.floor(e/2);const r=new Float32Array(e);return t&&r.set(this._array.subarray(0,e)),this._array=r,!0}return!1}append(e){const t=this._size;this.resize(this._size+e.length,!0),this._array.set(e,t)}erase(e,t){for(let i=e;i<t;++i)this._array[i]=0}get array(){return this._array}get size(){return this._size}}var m=i("a445");class b{constructor(e,t,i,r,n,o){this.from=e,this.to=t,this.isVisible=i,this.hasHighlights=r,this.hasOccludees=n,this.transformation=o,null!=o&&(this.transformationNormal=Object(s["c"])(o),Object(a["a"])(this.transformationNormal,this.transformationNormal),Object(a["b"])(this.transformationNormal,this.transformationNormal))}}function g(e){return e.sort((e,t)=>e.from===t.from?e.to>t.to?1:e.to<t.to?-1:0:e.from>t.from?1:e.from<t.from?-1:0)}function v(e,t){return e.first+e.count>=t.from}function y(e,t){const i=e=>({first:e.from,count:e.to-e.from});if(0===e.length)return void e.push(i(t));const r=e[e.length-1];if(v(r,t)){const e=t.from-r.first+t.to-t.from;r.count=e}else e.push(i(t))}var O=i("b852");class _{constructor(e,t,i){this.type="MergedRenderer",this._dataByOrigin=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._rctx=e,this._material=i,this._materialRep=t,this._glMaterials=Object(u["a"])(this._material,this._materialRep),this._bufferWriter=i.createBufferWriter()}dispose(){Object(u["f"])(this._material,this._materialRep),this._dataByOrigin&&(this._dataByOrigin.forEach(e=>{e.vao.dispose(!0),e.vao=null}),this._dataByOrigin.clear(),this._dataByOrigin=null),this._glMaterials&&(this._glMaterials.forEach(e=>{e&&e.dispose()}),this._glMaterials.clear(),this._glMaterials=null)}get isEmpty(){return 0===this._dataByOrigin.size}get hasHighlights(){return this._hasHighlights}get hasOccludees(){return this._hasOccludees}get hasWater(){return!this.isEmpty&&Object(n["b"])(this._glMaterials,e=>e instanceof m["a"])}get rendersOccluded(){return!this.isEmpty&&1!==this._material.renderOccluded}modify(e){this.updateGeometries(e.updates),this.addAndRemoveGeometries(e.adds,e.removes),this.updateRenderCommands()}addAndRemoveGeometries(e,t){const i=this._bufferWriter,r=i.vertexBufferLayout,a=r.stride/4,n=this._dataByOrigin,s=x(n,i,e,t);s.forEach((e,t)=>{s.delete(t);const i=e.optimalCount,o=e.sparseCount;let l=n.get(t);if(null==l)Object(c["a"])(i>0),l=this.createData(r,i,e.origin),n.set(t,l);else if(0===i)return l.vao.dispose(!0),l.vao=null,void n.delete(t);const h=i<e.sparseCount/2,d=h?i:o,u=w,p=l.buffer.size,f=l.buffer.array,m=l.buffer.resize(d,!1);h||m?this.removeAndRebuild(l,e.toRemove,a,f,u):e.toRemove.length>0?(this.removeByErasing(l,e.toRemove,a,u),e.toAdd.length>0&&(u.end=p)):(u.begin=p,u.end=p);const b=S;Object(c["m"])(b,-e.origin[0],-e.origin[1],-e.origin[2]),this.append(l,e.toAdd,a,b,u);const g=l.vao.vertexBuffers.geometry;if(g.byteSize!==l.buffer.array.buffer.byteLength)g.setData(l.buffer.array);else{const{begin:e,end:t}=u;if(e<t){const i=l.buffer.array,r=4,a=e*r,n=t*r;g.setSubData(i,a,a,n)}}l.drawCommandsDirty=!0})}updateGeometries(e){const t=this._bufferWriter,i=t.vertexBufferLayout.stride/4;for(const r of e){const e=r.updateType,a=r.renderGeometry,n=this._dataByOrigin.get(a.origin.id),s=n&&n.instances.get(a.id);if(!s)return;if(1&e&&(s.isVisible=a.instanceParameters.visible),9&e){const e=a.instanceParameters.visible;s.hasHighlights=!!a.instanceParameters.highlights&&e}if(16&e&&(s.hasOccludees=!!a.instanceParameters.occludees),6&e){const e=n.buffer.array,r=n.vao;Object(u["c"])(a,C,T),t.write({transformation:C,invTranspTransformation:T},a.data,t.vertexBufferLayout.createView(e.buffer),s.from),Object(c["a"])(s.from+t.elementCount(a.data)===s.to,"material VBO layout has changed"),r.vertexBuffers.geometry.setSubData(e,s.from*i*4,s.from*i*4,s.to*i*4)}n.drawCommandsDirty=!0}}updateRenderCommands(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach(e=>{e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,Object(n["b"])(e.instances,t=>(t.isVisible?(t.hasHighlights&&(this._hasHighlights=!0,e.hasHighlights=!0),t.hasOccludees&&(this._hasOccludees=!0,e.hasOccludees=!0)):e.hasHiddenInstances=!0,e.hasHiddenInstances&&e.hasHighlights&&e.hasOccludees))});const e=e=>{if(e.drawCommandsDefault=null,e.drawCommandsHighlight=null,e.drawCommandsOccludees=null,e.drawCommandsShadowHighlightRest=null,e.stats={default:0,highlight:0,occludees:0,shadowHighlightRest:0},0===e.instances.size)return;if(!j(e)){const t=4*e.buffer.size/Object(h["d"])(e.vao.layout.geometry);return e.drawCommandsDefault=[{first:0,count:t}],void(e.stats={default:t,highlight:0,occludees:0,shadowHighlightRest:0})}const t=g([...e.instances.values()]);e.drawCommandsDefault=[],e.drawCommandsHighlight=[],e.drawCommandsOccludees=[],e.drawCommandsShadowHighlightRest=[];for(const r of t)r.isVisible&&(r.hasOccludees?y(e.drawCommandsOccludees,r):y(e.drawCommandsDefault,r),r.hasHighlights?y(e.drawCommandsHighlight,r):y(e.drawCommandsShadowHighlightRest,r));const i=e=>{let t=0;for(const i of e)t+=i.count;return t/3};e.stats={default:i(e.drawCommandsDefault),highlight:i(e.drawCommandsHighlight),occludees:i(e.drawCommandsOccludees),shadowHighlightRest:i(e.drawCommandsShadowHighlightRest)}};this._dataByOrigin.forEach(t=>{t.drawCommandsDirty&&(e(t),t.drawCommandsDirty=!1)})}updateLogic(e){return this._material.update(e)}render(e,t,i,a){const n=this._rctx,s=this._glMaterials.get(t.pass),o=5===t.pass||7===t.pass,c=6===t.pass,l=!(o||c);let h=e;if(3===t.pass&&null===h&&(h=22),!s||2!==s.ensureResources(n)||null!=h&&!s.beginSlot(h)||o&&!this._hasHighlights)return!1;s.ensureParameters(i);const d=s.getTechnique(),u=s.getPipelineState(h,!1);n.setPipelineState(u),s.bind(n,i);let p=!1;return this._dataByOrigin.forEach(e=>{if(Object(r["j"])(e.drawCommandsDefault)&&Object(r["j"])(e.drawCommandsHighlight)&&Object(r["j"])(e.drawCommandsOccludees)&&Object(r["j"])(e.drawCommandsShadowHighlightRest))return;if(o&&!e.hasHighlights)return;i.origin=e.origin,d.bindDraw(i),d.ensureAttributeLocations(e.vao),n.bindVAO(e.vao);const t=d.primitiveType;let f=o?e.drawCommandsHighlight:c&&j(e)?e.drawCommandsShadowHighlightRest:e.drawCommandsDefault;const m=o?e.stats.highlight:c&&j(e)?e.stats.shadowHighlightRest:e.stats.default;if(Object(r["k"])(f)&&(this.renderCommands(n,t,f),Object(O["b"])(f.length,m,a),p=!0),l&&(f=e.drawCommandsOccludees,Object(r["k"])(f))){const i=s.getPipelineState(h,!0);n.setPipelineState(i),this.renderCommands(n,t,f),n.setPipelineState(u),Object(O["b"])(f.length,e.stats.occludees,a),p=!0}}),p}renderCommands(e,t,i){for(let r=0;r<i.length;r++)e.drawArrays(t,i[r].first,i[r].count)}createData(e,t,i){return{instances:new Map,vao:new d["a"](this._rctx,this._material.vertexAttributeLocations,{geometry:Object(o["a"])(e)},{geometry:l["a"].createVertex(this._rctx,35044)}),buffer:new f(t),optimalCount:0,origin:i,hasHiddenInstances:!1,hasHighlights:!1,hasOccludees:!1,drawCommandsDirty:!1,drawCommandsDefault:null,drawCommandsOccludees:null,drawCommandsHighlight:null,drawCommandsShadowHighlightRest:null,stats:{default:0,highlight:0,occludees:0,shadowHighlightRest:0}}}removeAndRebuild(e,t,i,r,a){for(const h of t){const t=h.id,r=e.instances.get(t);e.optimalCount-=(r.to-r.from)*i,e.instances.delete(t)}let n=0;const s=e.buffer.array;a.begin=0,a.end=0;let o=-1,c=-1,l=0;e.instances.forEach(e=>{const t=e.from*i,a=e.to*i,h=a-t;o!==c&&c!==t?(s.set(r.subarray(o,c),l),l+=c-o,o=t):-1===o&&(o=t),c=a,e.from=n/i,n+=h,e.to=n/i}),o!==c&&s.set(r.subarray(o,c),l),a.end=n}removeByErasing(e,t,i,r){r.begin=1/0,r.end=-1/0;let a=-1,n=-1;for(const s of t){const t=s.id,o=e.instances.get(t),c=o.from*i,l=o.to*i;a!==n&&n!==c?(e.buffer.erase(a,n),a=c):-1===a&&(a=c),n=l,e.instances.delete(t),e.optimalCount-=l-c,c<r.begin&&(r.begin=c),l>r.end&&(r.end=l)}a!==n&&e.buffer.erase(a,n)}append(e,t,i,n,s){const o=this._bufferWriter;for(const l of t){const t=Object(r["k"])(l.transformation)?Object(a["m"])(C,n,l.transformation):n;Object(a["a"])(T,t),Object(a["b"])(T,T);const h=s.end;o.write({transformation:t,invTranspTransformation:T},l.data,o.vertexBufferLayout.createView(e.buffer.array.buffer),s.end/i);const d=o.elementCount(l.data)*i,u=h+d;Object(c["a"])(null==e.instances.get(l.id));const p=l.instanceParameters.visible,f=!!l.instanceParameters.highlights&&p,m=!!l.instanceParameters.occludees,g=new b(h/i,u/i,p,f,m);e.instances.set(l.id,g),e.optimalCount+=d,s.end+=d}}get test(){return{material:this._material,glMaterials:this._glMaterials}}}function x(e,t,i,r){const a=new Map,n=t.vertexBufferLayout.stride/4,s=(i,r)=>{const s=i.origin,o=e.get(s.id);let c=a.get(s.id);null==c&&(c={optimalCount:null==o?0:o.optimalCount,sparseCount:null==o?0:o.buffer.size,toAdd:[],toRemove:[],origin:s.vec3},a.set(s.id,c));const l=t.elementCount(i.data)*n;r?(c.optimalCount+=l,c.sparseCount+=l,c.toAdd.push(i)):(c.optimalCount-=l,c.toRemove.push(i))};for(const o of i)s(o,!0);for(const o of r)s(o,!1);return a}function j(e){return e.hasOccludees||e.hasHighlights||e.hasHiddenInstances}const w={begin:0,end:0},S=Object(s["b"])(),C=Object(s["b"])(),T=Object(s["b"])();t["a"]=_},1962:function(e,t,i){"use strict";i.d(t,"a",(function(){return m})),i.d(t,"b",(function(){return f}));var r=i("3886"),a=i("4db9"),n=i("690a"),s=i("4377"),o=i("d272"),c=i("d047"),l=i("6a07"),h=i("ebd5"),d=i("c6d7"),u=i("c2d1"),p=i("6d5b");function f(e){const t=new n["a"],i=1===e.output;return t.include(a["a"],{linearDepth:i}),t.include(p["a"],e),t.vertex.uniforms.add("proj","mat4").add("view","mat4"),t.attributes.add("position","vec3"),t.varyings.add("vpos","vec3"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),i&&(t.include(u["a"],e),t.vertex.uniforms.add("cameraNearFar","vec2"),t.varyings.add("linearDepth","float")),t.vertex.code.add(r["a"]`
    void main(void) {
      vpos = position;
      forwardNormalizedVertexColor();
      ${e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
      gl_Position = ${i?r["a"]`transformPositionWithDepth(proj, view, vpos, cameraNearFar, linearDepth);`:r["a"]`transformPosition(proj, view, vpos);`}
    }
  `),t.include(o["a"],e),t.fragment.include(s["a"]),e.multipassTerrainEnabled&&(t.fragment.include(c["a"]),t.include(d["b"],e)),t.fragment.uniforms.add("eColor","vec4"),4===e.output&&t.include(l["a"]),t.fragment.code.add(r["a"]`
  void main() {
    discardBySlice(vpos);
    ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
    vec4 color = ${e.attributeColor?"vColor * eColor;":"eColor;"}

    if (color.a < ${r["a"].float(h["c"])}) {
      discard;
    }

    ${7===e.output?r["a"]`gl_FragColor = vec4(color.a);`:""}

    ${0===e.output?r["a"]`gl_FragColor = highlightSlice(color, vpos); ${e.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
    ${4===e.output?r["a"]`outputHighlight();`:""};
    ${1===e.output?r["a"]`outputDepth(linearDepth);`:""};
  }
  `),t}var m=Object.freeze({__proto__:null,build:f})},"1a54":function(e,t,i){"use strict";i.d(t,"a",(function(){return p})),i.d(t,"b",(function(){return m})),i.d(t,"c",(function(){return S})),i.d(t,"d",(function(){return C})),i.d(t,"e",(function(){return x})),i.d(t,"f",(function(){return g})),i.d(t,"g",(function(){return T})),i.d(t,"h",(function(){return f})),i.d(t,"i",(function(){return w})),i.d(t,"j",(function(){return b})),i.d(t,"k",(function(){return O})),i.d(t,"l",(function(){return j}));i("c120");var r=i("a21b"),a=i("b2b2"),n=i("5996"),s=i("74e2"),o=i("f2e0"),c=i("9180"),l=i("a1f3"),h=i("f0b9"),d=i("4261"),u=i("008c");i("3563");class p{constructor(e,t,i){this.uid=e,this.geometry=t,this.attributes=i,this.visible=!0,this.objectId=null,this.centroid=null}}function f(e){return Object(a["k"])(e.geometry)}class m{constructor(){this.exceededTransferLimit=!1,this.features=[],this.fields=[],this.hasM=!1,this.hasZ=!1,this.geometryType=null,this.objectIdFieldName=null,this.globalIdFieldName=null,this.geometryProperties=null,this.geohashFieldName=null,this.spatialReference=null,this.transform=null}}function b(e){return"point"===e.type}function g(e){const t=s["a"].fromJSON(e.geometryType),i=n["a"].fromJSON(e.spatialReference),r=e.transform,a=e.features.map(a=>{const n=v(a,t,i,e.objectIdFieldName),s=n.geometry;if(s&&r)switch(s.type){case"point":n.geometry=Object(u["e"])(r,s,s,s.hasZ,s.hasM);break;case"multipoint":n.geometry=Object(u["d"])(r,s,s,s.hasZ,s.hasM);break;case"polygon":n.geometry=Object(u["f"])(r,s,s,s.hasZ,s.hasM);break;case"polyline":n.geometry=Object(u["g"])(r,s,s,s.hasZ,s.hasM)}return n});return{geometryType:t,features:a,spatialReference:i,fields:e.fields?e.fields.map(e=>l["a"].fromJSON(e)):null,objectIdFieldName:e.objectIdFieldName,globalIdFieldName:e.globalIdFieldName,geohashFieldName:e.geohashFieldName,geometryProperties:e.geometryProperties,hasZ:e.hasZ,hasM:e.hasM,exceededTransferLimit:e.exceededTransferLimit,transform:null}}function v(e,t,i,r){return{uid:Object(o["b"])(),objectId:r&&e.attributes?e.attributes[r]:null,attributes:e.attributes,geometry:y(e.geometry,t,i),visible:!0}}function y(e,t,i){if(!e)return null;switch(t){case"point":{const t=e;return{x:t.x,y:t.y,z:t.z,m:t.m,hasZ:null!=t.z,hasM:null!=t.m,type:"point",spatialReference:i}}case"polyline":{const t=e;return{paths:t.paths,hasZ:!!t.hasZ,hasM:!!t.hasM,type:"polyline",spatialReference:i}}case"polygon":{const t=e;return{rings:t.rings,hasZ:!!t.hasZ,hasM:!!t.hasM,type:"polygon",spatialReference:i}}case"multipoint":{const t=e;return{points:t.points,hasZ:!!t.hasZ,hasM:!!t.hasM,type:"multipoint",spatialReference:i}}}}function O(e,t,i,r){return{x:e,y:t,z:i,hasZ:null!=i,hasM:!1,spatialReference:r,type:"point"}}function _(e){if(Object(a["j"])(e))return 0;let t=32;switch(e.type){case"point":t+=42;break;case"polyline":case"polygon":{let i=0;const r=2+(e.hasZ?1:0)+(e.hasM?1:0),a="polyline"===e.type?e.paths:e.rings;for(const e of a)i+=e.length;t+=8*i*r+64,t+=128*i,t+=34,t+=32*(a.length+1);break}case"multipoint":{const i=2+(e.hasZ?1:0)+(e.hasM?1:0),r=e.points.length;t+=8*r*i+64,t+=128*r,t+=34,t+=32;break}case"extent":t+=98,e.hasM&&(t+=32),e.hasZ&&(t+=32);break;case"mesh":t+=Object(r["a"])(e.vertexAttributes.position),t+=Object(r["a"])(e.vertexAttributes.normal),t+=Object(r["a"])(e.vertexAttributes.uv),t+=Object(r["a"])(e.vertexAttributes.tangent)}return t}function x(e){let t=32;return t+=Object(h["a"])(e.attributes),t+=3,t+=8+_(e.geometry),t}function j(e){if(Object(a["j"])(e))return 0;switch(e.type){case"point":return 1;case"polyline":{let t=0;for(const i of e.paths)t+=i.length;return t}case"polygon":{let t=0;for(const i of e.rings)t+=i.length;return t}case"multipoint":return e.points.length;case"extent":return 2;case"mesh":{const t=e.vertexAttributes&&e.vertexAttributes.position;return t?t.length/3:0}default:return}}function w(e){if(!e)return!1;switch(e.type){case"extent":case"point":return!0;case"polyline":for(const t of e.paths)if(t.length>0)return!0;return!1;case"polygon":for(const t of e.rings)if(t.length>0)return!0;return!1;case"multipoint":return e.points.length>0;case"mesh":return e.vertexAttributes&&e.vertexAttributes.position&&e.vertexAttributes.position.length>0;default:return}}function S(e,t){switch(Object(d["k"])(t),"mesh"===e.type&&(e=e.extent),e.type){case"point":t[0]=t[3]=e.x,t[1]=t[4]=e.y,e.hasZ&&(t[2]=t[5]=e.z);break;case"polyline":for(let i=0;i<e.paths.length;i++)Object(d["o"])(t,e.paths[i],e.hasZ);break;case"polygon":for(let i=0;i<e.rings.length;i++)Object(d["o"])(t,e.rings[i],e.hasZ);break;case"multipoint":Object(d["o"])(t,e.points,e.hasZ);break;case"extent":t[0]=e.xmin,t[1]=e.ymin,t[3]=e.xmax,t[4]=e.ymax,null!=e.zmin&&(t[2]=e.zmin),null!=e.zmax&&(t[5]=e.zmax)}}function C(e,t){switch(Object(c["n"])(t),"mesh"===e.type&&(e=e.extent),e.type){case"point":t[0]=t[2]=e.x,t[1]=t[3]=e.y;break;case"polyline":for(let i=0;i<e.paths.length;i++)Object(c["r"])(t,e.paths[i]);break;case"polygon":for(let i=0;i<e.rings.length;i++)Object(c["r"])(t,e.rings[i]);break;case"multipoint":Object(c["r"])(t,e.points);break;case"extent":t[0]=e.xmin,t[1]=e.ymin,t[2]=e.xmax,t[3]=e.ymax}}function T(e,t){return null!=e.objectId?e.objectId:e.attributes&&t?e.attributes[t]:null}Object(d["h"])(),Object(c["l"])()},"1a64":function(e,t,i){"use strict";i.d(t,"a",(function(){return X}));var r=i("e92d"),a=i("38bf"),n=i("b2b2"),s=i("9ef0"),o=i("a915"),c=i("0278"),l=i("35b3"),h=i("ba58"),d=i("2e0f"),u=i("74df"),p=i("0eb9"),f=i("7b96"),m=i("a803"),b=i("7f60"),g=i("5241"),v=i("738e"),y=i("fc00"),O=i("d7f7"),_=i("5957"),x=i("a4ee"),j=i("c3a4"),w=i("ca98"),S=i("da35"),C=i("fa1e"),T=i("8e37"),P=i("189c"),A=i("8e97"),R=i("7c51"),M=i("d272"),E=i("d0cb"),D=i("9617"),I=i("17b0"),L=i("a5b5");class V extends w["a"]{initializeProgram(e){const t=V.shader.get(),i=this.configuration,r=t.build({occlusionTestEnabled:i.occlusionTestEnabled,verticalOffsetEnabled:i.verticalOffset,screenSizePerspectiveEnabled:i.screenSizePerspective,depthHudEnabled:i.depthHudEnabled,depthHudAlignStartEnabled:i.depthHudAlignStartEnabled,screenCenterOffsetUnitsEnabled:i.screenCenterOffsetUnitsEnabled,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!0,viewingMode:e.viewingMode,isDraped:!1,multipassGeometryEnabled:i.multipassGeometryEnabled});return new T["a"](e.rctx,r.generateSource("vertex"),r.generateSource("fragment"),C["a"])}bindPass(e,t,i){A["a"].bindProjectionMatrix(this.program,i.camera.projectionMatrix),L["a"].bindUniforms(this.program,t,i.camera.pixelRatio||1),I["a"].bindUniforms(this.program,t,i),E["a"].bindUniforms(this.program,i),this.program.setUniform2fv("cameraNearFar",i.camera.nearFar),this.program.setUniform2fv("inverseViewport",i.inverseViewport),Object(D["a"])(this.program,e,i),this.program.setUniform1i("hudVisibilityTexture",4),e.bindTexture(i.hudVisibilityTexture,4),this.program.setUniform1f("cameraGroundRelative",i.camera.aboveGround?1:-1),this.program.setUniform1f("polygonOffset",t.shaderPolygonOffset),A["a"].bindViewport(this.program,i),this.program.setUniform1f("perDistancePixelRatio",Math.tan(i.camera.fovY/2)/(i.camera.fullViewport[2]/2)),this.program.setUniformMatrix4fv("viewNormal",i.camera.viewInverseTransposeMatrix),this.program.setUniform2f("pixelToNDC",2/i.camera.fullViewport[2],2/i.camera.fullViewport[3]);const r=i.camera.pixelRatio||1;this.program.setUniform1f("lineSize",Math.ceil(t.size)*r),Object(R["a"])(t.screenSizePerspective,this.program,"screenSizePerspectiveAlignment")}bindDraw(e){A["a"].bindView(this.program,e),A["a"].bindCamPosition(this.program,e.origin,e.camera.viewInverseTransposeMatrix),M["a"].bindUniformsWithOrigin(this.program,this.configuration,e)}setPipelineState(e){const t=e?519:513;return this.configuration.depthHudEnabled?Object(P["e"])({depthTest:{func:t},depthWrite:P["d"]}):Object(P["e"])({blending:Object(P["f"])(1,770,771,771),depthTest:{func:t},colorWrite:P["c"]})}initializePipeline(){return this.setPipelineState(this.configuration.multipassGeometryEnabled)}}V.shader=new j["a"](L["b"],()=>i.e("chunk-2d0efcae").then(i.bind(null,"9a2b")));class k extends S["a"]{constructor(){super(...arguments),this.occlusionTestEnabled=!0,this.verticalOffset=!1,this.screenSizePerspective=!1,this.depthHudEnabled=!1,this.depthHudAlignStartEnabled=!1,this.screenCenterOffsetUnitsEnabled=0,this.slicePlaneEnabled=!1,this.multipassGeometryEnabled=!1}}Object(x["a"])([Object(S["b"])()],k.prototype,"occlusionTestEnabled",void 0),Object(x["a"])([Object(S["b"])()],k.prototype,"verticalOffset",void 0),Object(x["a"])([Object(S["b"])()],k.prototype,"screenSizePerspective",void 0),Object(x["a"])([Object(S["b"])()],k.prototype,"depthHudEnabled",void 0),Object(x["a"])([Object(S["b"])()],k.prototype,"depthHudAlignStartEnabled",void 0),Object(x["a"])([Object(S["b"])({count:2})],k.prototype,"screenCenterOffsetUnitsEnabled",void 0),Object(x["a"])([Object(S["b"])()],k.prototype,"slicePlaneEnabled",void 0),Object(x["a"])([Object(S["b"])()],k.prototype,"multipassGeometryEnabled",void 0);class F extends l["a"]{constructor(e){super(e,U),this.techniqueConfig=new k,this._uniqueMaterialIdentifier=F.uniqueMaterialIdentifier(this.params)}get uniqueMaterialIdentifier(){return this._uniqueMaterialIdentifier}dispose(){}getGLMaterial(e){return 0===e.output?new z(e):void 0}getPassParameters(){return this.params}getTechniqueConfig(e,t){return this.techniqueConfig.occlusionTestEnabled=this.params.occlusionTest,this.techniqueConfig.verticalOffset=!!this.params.verticalOffset,this.techniqueConfig.screenSizePerspective=!!this.params.screenSizePerspective,this.techniqueConfig.depthHudEnabled=e,this.techniqueConfig.depthHudAlignStartEnabled=!!this.params.depthHUDAlignStart,this.techniqueConfig.screenCenterOffsetUnitsEnabled="screen"===this.params.centerOffsetUnits?1:0,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.multipassGeometryEnabled=!!t&&t.multipassGeometryEnabled,this.techniqueConfig}intersect(){}createBufferWriter(){return new H}validateParameterValues(e){const t=F.uniqueMaterialIdentifier(e);t!==this._uniqueMaterialIdentifier&&(this._uniqueMaterialIdentifier=t)}static uniqueMaterialIdentifier(e){return JSON.stringify({screenOffset:e.screenOffset||[0,0],centerOffsetUnits:e.centerOffsetUnits||"world"})}}class z extends O["a"]{constructor(e){super(e),this.isRenderSlot=!0,this.updateParameters()}updateParameters(e){this.technique=this.techniqueRep.acquireAndReleaseExisting(V,this.material.getTechniqueConfig(!1,e),this.technique),this.depthTechnique=this.techniqueRep.acquireAndReleaseExisting(V,this.material.getTechniqueConfig(!0,e),this.depthTechnique)}beginSlot(e){switch(e){case 20:return this.isRenderSlot=!0,!0;case 21:return this.isRenderSlot=!1,!0}return!1}getTechnique(){return this.isRenderSlot?this.technique:this.depthTechnique}ensureParameters(e){this.updateParameters(e)}bind(e,t){const i=this.getTechnique();e.bindProgram(i.program),i.bindPass(e,this.material.getPassParameters(),t)}}const U={verticalOffset:null,screenSizePerspective:null,screenOffset:[0,0],color:[0,0,0,1],size:1,borderColor:null,occlusionTest:!1,shaderPolygonOffset:1e-5,depthHUDAlignStart:!1,centerOffsetUnits:"world",slicePlaneEnabled:!1,...l["b"]},G=Object(y["a"])().vec3f("position").vec3f("normal").vec2f("uv0").vec4f("auxpos1"),B=[Object(v["b"])(0,0),Object(v["b"])(1,0),Object(v["b"])(0,1),Object(v["b"])(1,0),Object(v["b"])(1,1),Object(v["b"])(0,1)];class H{constructor(){this.vertexBufferLayout=G}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return 6*e.indices.get("position").length}write(e,t,i,r){Object(_["e"])(t.indices.get("position"),t.vertexAttributes.get("position").data,e.transformation,i.position,r,6),Object(_["d"])(t.indices.get("normal"),t.vertexAttributes.get("normal").data,e.invTranspTransformation,i.normal,r,6),Object(_["a"])(t.indices.get("auxpos1"),t.vertexAttributes.get("auxpos1").data,i.auxpos1,r,6);for(let a=0;a<B.length;++a)i.uv0.setVec(r+a,B[a])}}class N extends b["a"]{constructor(e,t){super(e,null,t,$),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){this._material=new F(this.materialParameters),this._context.stage.add(this._material)}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}perInstanceMaterialParameters(e){const t=this.materialParameters;return t.screenOffset=e.screenOffset||[0,0],t.centerOffsetUnits=e.centerOffsetUnits||"world",t}get materialParameters(){const e=this.symbol,t=e.callout,i=Object(n["k"])(t.color)?s["a"].toUnitRGBA(t.color):[0,0,0,0];i[3]*=this._getLayerOpacity();const r=Object(o["h"])(t.size||0);let a=null;if(e.verticalOffset){const{screenLength:t,minWorldLength:i,maxWorldLength:r}=e.verticalOffset;a={screenLength:Object(o["h"])(t),minWorldLength:i||0,maxWorldLength:null!=r?r:1/0}}const c=Object(n["k"])(t.border)&&Object(n["k"])(t.border.color)?s["a"].toUnitRGBA(t.border.color):null,h="object"===e.symbolLayers.getItemAt(0).type,d=!h,u=h?0:void 0,p="label-3d"===e.type;return{color:i,size:r,verticalOffset:a,screenSizePerspective:this._context.screenSizePerspectiveEnabled?this._context.sharedResources.screenSizePerspectiveSettings:null,screenOffset:[0,0],centerOffsetUnits:"world",borderColor:c,occlusionTest:d,shaderPolygonOffset:u,depthHUDAlignStart:p,slicePlaneEnabled:this._context.slicePlaneEnabled,renderOccluded:l["b"].renderOccluded}}_defaultElevationInfoNoZ(){return Z}createGraphics3DGraphic(e){const t=e.renderingInfo,i=e.graphic,r=this.setGraphicElevationContext(i,new p["a"],t.elevationOffset||0),a=t.symbol,s="on-the-ground"===this._elevationContext.mode&&("cim"===a.type||!a.symbolLayers.some(e=>"object"===e.type||"text"===e.type));if("label-3d"!==a.type&&s)return null;const o=Object(h["a"])(i.geometry);return Object(n["j"])(o)?null:this._createAs3DShape(o,r,t,i.uid)}layerOpacityChanged(){return Object(n["j"])(this._material)||this._material.setParameterValues(this.materialParameters),!0}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,a=Object(d["d"])(N.elevationModeChangeTypes,i,r);return a!==d["a"].UPDATE||e.forEach(e=>{const i=t(e);Object(n["k"])(i)&&this.updateGraphicElevationContext(e.graphic,i)}),a}slicePlaneEnabledChanged(){return Object(n["j"])(this._material)||this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}setGraphicElevationContext(e,t,i=0){const r=super.setGraphicElevationContext(e,t);return r.addOffsetRenderUnits(i),r}updateGraphicElevationContext(e,t){this.setGraphicElevationContext(e,t.elevationContext,t.metadata.elevationOffset),t.needsElevationUpdates=Object(d["f"])(t.elevationContext.mode)}updateGeometry(e,t){return!1}computeComplexity(){return{primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:m["e"].memory}}createVertexData(e){const{translation:t,centerOffset:i}=e;return[["position",t?{size:3,data:[t[0],t[1],t[2]],exclusive:!0}:{size:3,data:[0,0,0],exclusive:!0}],["normal",{size:3,data:[0,0,1],exclusive:!0}],["auxpos1",i?{size:4,data:[i[0],i[1],i[2],i[3]],exclusive:!0}:{size:4,data:[0,0,0,1],exclusive:!0}]]}_getOrCreateMaterial(e){const t=this.perInstanceMaterialParameters(e),i=F.uniqueMaterialIdentifier(t);if(Object(n["k"])(this._material)&&i===this._material.uniqueMaterialIdentifier)return{material:this._material,isUnique:!1};if(e.materialCollection){let r=e.materialCollection.get(i);return Object(n["j"])(r)&&(r=new F(t),e.materialCollection.add(i,r)),{material:r,isUnique:!1}}return{material:new F(t),isUnique:!0}}_createAs3DShape(e,t,i,r){const a=[new c["a"](this.createVertexData(i),W,1)],n=this._getOrCreateMaterial(i),s=Object(g["a"])(this._context,e,a,[n.material],null,null,t,this._context.layer.uid,r);if(null===s)return null;const o=u["b"],l=new f["a"](this,s.object,a,n.isUnique?[n.material]:null,null,o,t);return l.metadata={elevationOffset:i.elevationOffset||0},l.alignedSampledElevation=s.sampledElevation,l.needsElevationUpdates=Object(d["f"])(t.mode),Object(g["b"])(l,e,this._context.elevationProvider),l}}N.elevationModeChangeTypes={definedChanged:d["a"].UPDATE,staysOnTheGround:d["a"].UPDATE,onTheGroundChanged:d["a"].RECREATE};const q=new Uint16Array([0]),W=[["position",q],["normal",q],["auxpos1",q]],Z={mode:"relative-to-ground",offset:0},$={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1};const Q=r["a"].getLogger("esri.views.3d.layers.graphics.Graphics3DCalloutSymbolLayerFactory");function X(e,t){if(!Object(a["d"])(e))return Q.error("Graphics3DCalloutSymbolLayerFactory#make",`symbol of type '${e.type}' does not support callouts`),null;if(!e.callout)return null;const i=Y[e.callout.type];return i?new i(e,t):(Q.error("Graphics3DCalloutSymbolLayerFactory#make","unknown or unsupported callout type "+e.callout.type),null)}const Y={line:N}},"1a9a":function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i("c514");class a{constructor(e,t,i,r,a,n,s,o){this.createQuery=e,this.resultAvailable=t,this.getResult=i,this.disjoint=r,this.beginTimeElapsed=a,this.endTimeElapsed=n,this.createTimestamp=s,this.timestampBits=o}}function n(e,t){if(t.disjointTimerQuery)return null;let i=e.getExtension("EXT_disjoint_timer_query_webgl2");return i&&Object(r["a"])(e)?new a(()=>e.createQuery(),t=>e.getQueryParameter(t,e.QUERY_RESULT_AVAILABLE),t=>e.getQueryParameter(t,e.QUERY_RESULT),()=>e.getParameter(i.GPU_DISJOINT_EXT),t=>e.beginQuery(i.TIME_ELAPSED_EXT,t),()=>e.endQuery(i.TIME_ELAPSED_EXT),e=>i.queryCounterEXT(e,i.TIMESTAMP_EXT),()=>e.getQuery(i.TIMESTAMP_EXT,i.QUERY_COUNTER_BITS_EXT)):(i=e.getExtension("EXT_disjoint_timer_query"),i?new a(()=>i.createQueryEXT(),e=>i.getQueryObjectEXT(e,i.QUERY_RESULT_AVAILABLE_EXT),e=>i.getQueryObjectEXT(e,i.QUERY_RESULT_EXT),()=>e.getParameter(i.GPU_DISJOINT_EXT),e=>i.beginQueryEXT(i.TIME_ELAPSED_EXT,e),()=>i.endQueryEXT(i.TIME_ELAPSED_EXT),e=>i.queryCounterEXT(e,i.TIMESTAMP_EXT),()=>i.getQueryEXT(i.TIMESTAMP_EXT,i.QUERY_COUNTER_BITS_EXT)):null)}},"1af8":function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i("3886");function a(e,t){const i=e.vertex;switch(t.mode){case 1:i.code.add(r["a"]`
        #define discardShortEdges(unpackedAttributes, lineLengthPixels) { if (lineLengthPixels <= 3.0) { gl_Position = vec4(10.0, 10.0, 10.0, 1.0); return; }}
      `);break;case 2:i.code.add(r["a"]`
        #define discardShortEdges(unpackedAttributes, lineLengthPixels) { if (unpackedAttributes.type <= 0.0 && lineLengthPixels <= 3.0) { gl_Position = vec4(10.0, 10.0, 10.0, 1.0); return; }}
      `);break;case 0:i.code.add(r["a"]`
        #define discardShortEdges(unpackedAttributes, lineLengthPixels) {}
      `)}}},"1cb4":function(e,t,i){"use strict";var r=i("50e6"),a=i("dff3");class n{constructor(e,t){this.lockedSchemaPixelSize=e,this.isGCS=t}getLevelRowColumn(e){return this.isGCS?[e[0],e[1]>>1,e[2]>>1]:256===this.lockedSchemaPixelSize&&e[0]>0?[e[0]-1,e[1]>>1,e[2]>>1]:e}adjustLevel(e){return this.isGCS?e:256===this.lockedSchemaPixelSize?e>0?e-1:0:e}getShift(e,t){let i=0,r=0;return(256===this.lockedSchemaPixelSize||this.isGCS)&&(e[2]%2&&(i=t),e[1]%2&&(r=t)),[i,r]}getScale(e){if(this.isGCS){if(512===this.lockedSchemaPixelSize)return 4}else if(256===this.lockedSchemaPixelSize&&0===e)return 1;return 2}static create256x256CompatibleTileInfo(e){if(!e)return null;if(256===e.size[0]&&256===e.size[1])return e;const t=256,i=e.spatialReference.isGeographic,n=[],s=e.lods.length;for(let a=0;a<s;a++){const t=e.lods[a],s=i?t.resolution:2*t.resolution;n.push(new r["a"]({level:t.level,scale:t.scale,resolution:s}))}return new a["a"]({size:[t,t],dpi:e.dpi,format:e.format,compressionQuality:e.compressionQuality,origin:e.origin,spatialReference:e.spatialReference,lods:n})}static create512x512CompatibleTileInfo(e){if(!e)return null;if(256===e.size[0]||256===e.size[1])return null;const t=512,i=[],n=e.lods.length;for(let a=0;a<n;a++){const t=e.lods[a],n=.5*t.resolution;i.push(new r["a"]({level:t.level,scale:t.scale,resolution:n}))}return new a["a"]({size:[t,t],dpi:e.dpi,format:e.format,compressionQuality:e.compressionQuality,origin:e.origin,spatialReference:e.spatialReference,lods:i})}}t["a"]=n},"1dc3":function(e,t,i){"use strict";i.r(t);var r=i("a4ee"),a=(i("c120"),i("e92d"),i("cea0"),i("59b2")),n=i("d386"),s=i("ce50"),o=(i("e041"),i("8eed"),i("f402"),i("66af")),c=i("45e3"),l=i("365a");let h=class extends(Object(c["a"])(Object(o["a"])(l["a"]))){initialize(){const e=this.get("view.map.allLayers"),t=e&&e.includes(this.layer),i=this.get("view.map.ground.layers"),r=i&&i.includes(this.layer);if(t&&!r){const e=new s["a"]("layerview:elevation-layer-only","3D elevation layer '"+this.layer.id+"' can only be added in the map ground");this.addResolvingPromise(Promise.reject(e))}this._addTilingSchemeMatchPromise()}};Object(r["a"])([Object(a["b"])({readOnly:!0,aliasOf:"layer.fullExtent"})],h.prototype,"fullExtent",void 0),Object(r["a"])([Object(a["b"])()],h.prototype,"layer",void 0),Object(r["a"])([Object(a["b"])({readOnly:!0,aliasOf:"layer.tileInfo"})],h.prototype,"tileInfo",void 0),h=Object(r["a"])([Object(n["a"])("esri.views.3d.layers.ElevationLayerView3D")],h);var d=h;t["default"]=d},"1f1c":function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));class r{constructor(e){this.vertexHandle=null,this.excludeFeature=null,this.visualizer=null,this.geometry=e.geometry,this.elevationInfo=e.elevationInfo,this.pointer=e.pointer,this.vertexHandle=e.vertexHandle,this.excludeFeature=e.excludeFeature,this.visualizer=e.visualizer}get coordinateHelper(){return this.geometry.editGeometry.coordinateHelper}}},"21ed":function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i("3886");function a(e,t){const i=e.vertex;switch(i.code.add(r["a"]`
  #define VERTEX_DISCARD_CUTOFF (1.0 - 1.0 / 255.0)
  `),t.vertexDiscardMode){case 0:i.code.add(r["a"]`
        #define vertexDiscardByOpacity(_opacity_) {}
      `);break;case 2:i.code.add(r["a"]`
        #define vertexDiscardByOpacity(_opacity_) { if (_opacity_ >  VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }
      `);break;case 1:i.code.add(r["a"]`
        #define vertexDiscardByOpacity(_opacity_) { if (_opacity_ <= VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }
      `)}}},2245:function(e,t,i){"use strict";i.d(t,"a",(function(){return C}));var r=i("0b2d"),a=i("e431"),n=i("38a4"),s=i("2bc9");function o(e,t,i){(i=i||e).length=e.length;for(let r=0;r<e.length;r++)i[r]=e[r]*t[r];return i}function c(e,t,i){(i=i||e).length=e.length;for(let r=0;r<e.length;r++)i[r]=e[r]*t;return i}function l(e,t,i){(i=i||e).length=e.length;for(let r=0;r<e.length;r++)i[r]=e[r]+t[r];return i}function h(e){return(e+1)*(e+1)}function d(e){return Object(n["d"])(Math.floor(Math.sqrt(e)-1),0,2)}function u(e,t,i){const r=e[0],a=e[1],n=e[2],s=i||[];return s.length=h(t),t>=0&&(s[0]=.28209479177),t>=1&&(s[1]=.4886025119*r,s[2]=.4886025119*n,s[3]=.4886025119*a),t>=2&&(s[4]=1.09254843059*r*a,s[5]=1.09254843059*a*n,s[6]=.31539156525*(3*n*n-1),s[7]=1.09254843059*r*n,s[8]=.54627421529*(r*r-a*a)),s}function p(e,t){const i=h(e),r=t||{r:[],g:[],b:[]};r.r.length=r.g.length=r.b.length=i;for(let a=0;a<i;a++)r.r[a]=r.g[a]=r.b[a]=0;return r}function f(e,t){const i=d(t.r.length);for(const r of e)Object(a["u"])(x,r.direction),u(x,i,O),o(O,j),c(O,r.intensity[0],_),l(t.r,_),c(O,r.intensity[1],_),l(t.g,_),c(O,r.intensity[2],_),l(t.b,_);return t}function m(e,t){u(x,0,O);for(const i of e)t.r[0]+=O[0]*j[0]*i.intensity[0]*4*Math.PI,t.g[0]+=O[0]*j[0]*i.intensity[1]*4*Math.PI,t.b[0]+=O[0]*j[0]*i.intensity[2]*4*Math.PI;return t}function b(e,t,i){p(t,i.sphericalHarmonics.sh),Object(a["x"])(i.main.intensity,0,0,0);let r=!1;const n=g,o=v,c=y;n.length=0,o.length=0,c.length=0;for(const l of e)l instanceof s["c"]&&!r?(Object(a["l"])(i.main.direction,l.direction),i.main.intensity[0]=l.intensity[0],i.main.intensity[1]=l.intensity[1],i.main.intensity[2]=l.intensity[2],i.main.castShadows=l.castShadows,r=!0):l instanceof s["c"]||l instanceof s["b"]?n.push(l):l instanceof s["a"]?o.push(l):l instanceof s["d"]&&c.push(l);f(n,i.sphericalHarmonics.sh),m(o,i.sphericalHarmonics.sh);for(const a of c)l(i.sphericalHarmonics.sh.r,a.sh.r),l(i.sphericalHarmonics.sh.g,a.sh.g),l(i.sphericalHarmonics.sh.b,a.sh.b)}const g=[],v=[],y=[],O=[0],_=[0],x=Object(r["e"])(),j=[3.141593,2.094395,2.094395,2.094395,.785398,.785398,.785398,.785398,.785398],w=Object(r["e"])(),S=.4;class C{constructor(){this._renderLighting={main:{intensity:Object(r["e"])(),direction:Object(r["g"])(1,0,0),castShadows:!1},sphericalHarmonics:{sh:{r:[0],g:[0],b:[0]}}},this._shOrder=2,this._oldSunlight={direction:Object(r["e"])(),ambient:{color:Object(r["e"])(),intensity:0},diffuse:{color:Object(r["e"])(),intensity:0}}}setLightDirectionUniform(e){e.setUniform3fv("lightingMainDirection",this._renderLighting.main.direction)}setUniforms(e,t=!1){if(t){const t=(1-this._info.groundLightingFactor)*(1-this._info.globalFactor);e.setUniform1f("lightingFixedFactor",t)}else e.setUniform1f("lightingFixedFactor",0);e.setUniform1f("lightingGlobalFactor",this._info.globalFactor),this.setLightDirectionUniform(e),e.setUniform3fv("lightingMainIntensity",this._renderLighting.main.intensity),e.setUniform1f("ambientBoostFactor",S);const i=this._renderLighting.sphericalHarmonics.sh;0===this._shOrder?e.setUniform3f("lightingAmbientSH0",i.r[0],i.g[0],i.b[0]):1===this._shOrder?(e.setUniform4f("lightingAmbientSH_R",i.r[0],i.r[1],i.r[2],i.r[3]),e.setUniform4f("lightingAmbientSH_G",i.g[0],i.g[1],i.g[2],i.g[3]),e.setUniform4f("lightingAmbientSH_B",i.b[0],i.b[1],i.b[2],i.b[3])):2===this._shOrder&&(e.setUniform3f("lightingAmbientSH0",i.r[0],i.g[0],i.b[0]),e.setUniform4f("lightingAmbientSH_R1",i.r[1],i.r[2],i.r[3],i.r[4]),e.setUniform4f("lightingAmbientSH_G1",i.g[1],i.g[2],i.g[3],i.g[4]),e.setUniform4f("lightingAmbientSH_B1",i.b[1],i.b[2],i.b[3],i.b[4]),e.setUniform4f("lightingAmbientSH_R2",i.r[5],i.r[6],i.r[7],i.r[8]),e.setUniform4f("lightingAmbientSH_G2",i.g[5],i.g[6],i.g[7],i.g[8]),e.setUniform4f("lightingAmbientSH_B2",i.b[5],i.b[6],i.b[7],i.b[8]))}set(e){this._info=e,b(e.lights,this._shOrder,this._renderLighting),Object(a["u"])(this._oldSunlight.direction,this._renderLighting.main.direction);const t=1/Math.PI;this._oldSunlight.ambient.color[0]=.282095*this._renderLighting.sphericalHarmonics.sh.r[0]*t,this._oldSunlight.ambient.color[1]=.282095*this._renderLighting.sphericalHarmonics.sh.g[0]*t,this._oldSunlight.ambient.color[2]=.282095*this._renderLighting.sphericalHarmonics.sh.b[0]*t,this._oldSunlight.ambient.intensity=1,this._oldSunlight.diffuse.color[0]=this._renderLighting.main.intensity[0]*t,this._oldSunlight.diffuse.color[1]=this._renderLighting.main.intensity[1]*t,this._oldSunlight.diffuse.color[2]=this._renderLighting.main.intensity[2]*t,this._oldSunlight.diffuse.intensity=1;const i=Object(a["l"])(w,this._oldSunlight.diffuse.color);Object(a["f"])(i,i,S*this._info.globalFactor),Object(a["g"])(this._oldSunlight.ambient.color,this._oldSunlight.ambient.color,i)}get globalFactor(){return this._info.globalFactor}get old(){return this._oldSunlight}}},2258:function(e,t,i){"use strict";function r(e,t,i){return t.flatten(({sublayers:e})=>e).length!==e.length||(!!e.some(e=>e.originIdOf("minScale")>i||e.originIdOf("maxScale")>i||e.originIdOf("renderer")>i||e.originIdOf("labelingInfo")>i||e.originIdOf("opacity")>i||e.originIdOf("labelsVisible")>i||e.originIdOf("source")>i)||!n(e,t))}function a(e,t,i){return!!e.some(e=>{const t=e.source;return!(!t||"map-layer"===t.type&&t.mapLayerId===e.id&&(!t.gdbVersion||t.gdbVersion===i.gdbVersion))||e.originIdOf("renderer")>2||e.originIdOf("labelingInfo")>2||e.originIdOf("opacity")>2||e.originIdOf("labelsVisible")>2})||!n(e,t)}function n(e,t){if(!e||!e.length)return!0;const i=t.slice().reverse().flatten(({sublayers:e})=>e&&e.toArray().reverse()).map(e=>e.id).toArray();if(e.length>i.length)return!1;let r=0;const a=i.length;for(const{id:n}of e){for(;r<a&&i[r]!==n;)r++;if(r>=a)return!1}return!0}function s(e){return!!e&&e.some(e=>null!=e.minScale||e.layerDefinition&&null!=e.layerDefinition.minScale)}i.d(t,"a",(function(){return a})),i.d(t,"b",(function(){return s})),i.d(t,"c",(function(){return r}))},2273:function(e,t,i){"use strict";i.r(t),i.d(t,"work",(function(){return S})),i.d(t,"wrappedWork",(function(){return w}));var r=i("8c4b"),a=i("0c9d"),n=i("7e0c"),s=i("0480");function o(e,t,i){const r=t/3,a=new Uint32Array(i+1),n=new Uint32Array(i+1),s=(e,t)=>{e<t?a[e+1]++:n[t+1]++};for(let g=0;g<r;g++){const t=e[3*g],i=e[3*g+1],r=e[3*g+2];s(t,i),s(i,r),s(r,t)}let o=0,c=0;for(let g=0;g<i;g++){const e=a[g+1],t=n[g+1];a[g+1]=o,n[g+1]=c,o+=e,c+=t}const l=new Uint32Array(6*r),h=a[i],d=(e,t,i)=>{if(e<t){const r=a[e+1]++;l[2*r]=t,l[2*r+1]=i}else{const r=n[t+1]++;l[2*h+2*r]=e,l[2*h+2*r+1]=i}};for(let g=0;g<r;g++){const t=e[3*g],i=e[3*g+1],r=e[3*g+2];d(t,i,g),d(i,r,g),d(r,t,g)}const u=(e,t)=>{const i=2*e,r=t-e;for(let a=1;a<r;a++){const e=l[i+2*a],t=l[i+2*a+1];let r=a-1;for(;r>=0&&l[i+2*r]>e;r--)l[i+2*r+2]=l[i+2*r],l[i+2*r+3]=l[i+2*r+1];l[i+2*r+2]=e,l[i+2*r+3]=t}};for(let g=0;g<i;g++)u(a[g],a[g+1]),u(h+n[g],h+n[g+1]);const p=new Int32Array(3*r),f=(t,i)=>t===e[3*i]?0:t===e[3*i+1]?1:t===e[3*i+2]?2:-1,m=(e,t)=>{const i=f(e,t);p[3*t+i]=-1},b=(e,t,i,r)=>{const a=f(e,t);p[3*t+a]=r;const n=f(i,r);p[3*r+n]=t};for(let g=0;g<i;g++){let e=a[g];const t=a[g+1];let i=n[g];const r=n[g+1];for(;e<t&&i<r;){const t=l[2*e],r=l[2*h+2*i];t===r?(b(g,l[2*e+1],r,l[2*h+2*i+1]),e++,i++):t<r?(m(g,l[2*e+1]),e++):(m(r,l[2*h+2*i+1]),i++)}for(;e<t;)m(g,l[2*e+1]),e++;for(;i<r;)m(l[2*h+2*i],l[2*h+2*i+1]),i++}return p}var c=i("a21b"),l=i("b50f"),h=i("38a4"),d=i("0b2d"),u=i("e431"),p=i("680b");const f=-1;function m(e,t,i,r=j){const a=e.vertices.position,n=e.vertices.componentIndex,s=Object(h["f"])(r.anglePlanar),o=Object(h["f"])(r.angleSignificantEdge),d=Math.cos(o),p=Math.cos(s),m=_.edge,x=m.position0,w=m.position1,S=m.faceNormal0,C=m.faceNormal1,T=O(e),P=y(e),A=P.length/4,R=t.allocate(A);let M=0;const E=A,D=i.allocate(E);let I=0,L=0,V=0;const k=Object(l["j"])(0,A),F=new Float32Array(A);Object(c["b"])(F,(e,t,i)=>{a.getVec(P[4*t+0],x),a.getVec(P[4*t+1],w),i[t]=Object(u["p"])(x,w)}),k.sort((e,t)=>F[t]-F[e]);const z=new Array,U=new Array;for(let c=0;c<A;c++){const e=k[c],r=F[e],o=P[4*e+0],l=P[4*e+1],h=P[4*e+2],y=P[4*e+3],O=y===f;if(a.getVec(o,x),a.getVec(l,w),O)Object(u["x"])(S,T[3*h+0],T[3*h+1],T[3*h+2]),Object(u["l"])(C,S),m.componentIndex=n.get(o),m.cosAngle=Object(u["i"])(S,C);else{if(Object(u["x"])(S,T[3*h+0],T[3*h+1],T[3*h+2]),Object(u["x"])(C,T[3*y+0],T[3*y+1],T[3*y+2]),m.componentIndex=n.get(o),m.cosAngle=Object(u["i"])(S,C),g(m,p))continue;m.cosAngle<-.9999&&Object(u["l"])(C,S)}L+=r,V++,O||b(m,d)?(t.write(R,M++,m),z.push(r)):v(m,s)&&(i.write(D,I++,m),U.push(r))}const G=new Float32Array(z.reverse()),B=new Float32Array(U.reverse());return{regular:{instancesData:t.trim(R,M),lodInfo:{lengths:G}},silhouette:{instancesData:i.trim(D,I),lodInfo:{lengths:B}},averageEdgeLength:L/V}}function b(e,t){return e.cosAngle<t}function g(e,t){return e.cosAngle>t}function v(e,t){const i=Object(h["b"])(e.cosAngle),r=_.fwd,a=_.ortho;return Object(p["h"])(r,e.position1,e.position0),i*(Object(u["i"])(Object(u["h"])(a,e.faceNormal0,e.faceNormal1),r)>0?-1:1)>t}function y(e){const t=e.faces.length/3,i=e.faces,r=e.neighbors;let a=0;for(let o=0;o<t;o++){const e=r[3*o+0],t=r[3*o+1],n=r[3*o+2],s=i[3*o+0],c=i[3*o+1],l=i[3*o+2];a+=e===f||s<c?1:0,a+=t===f||c<l?1:0,a+=n===f||l<s?1:0}const n=new Int32Array(4*a);let s=0;for(let o=0;o<t;o++){const e=r[3*o+0],t=r[3*o+1],a=r[3*o+2],c=i[3*o+0],l=i[3*o+1],h=i[3*o+2];(e===f||c<l)&&(n[s++]=c,n[s++]=l,n[s++]=o,n[s++]=e),(t===f||l<h)&&(n[s++]=l,n[s++]=h,n[s++]=o,n[s++]=t),(a===f||h<c)&&(n[s++]=h,n[s++]=c,n[s++]=o,n[s++]=a)}return n}function O(e){const t=e.faces.length/3,i=e.vertices.position,r=e.faces,a=x.v0,n=x.v1,s=x.v2,o=new Float32Array(3*t);for(let c=0;c<t;c++){const e=r[3*c+0],t=r[3*c+1],l=r[3*c+2];i.getVec(e,a),i.getVec(t,n),i.getVec(l,s),Object(u["k"])(n,n,a),Object(u["k"])(s,s,a),Object(u["h"])(a,n,s),Object(u["s"])(a,a),o[3*c+0]=a[0],o[3*c+1]=a[1],o[3*c+2]=a[2]}return o}const _={edge:{position0:Object(d["e"])(),position1:Object(d["e"])(),faceNormal0:Object(d["e"])(),faceNormal1:Object(d["e"])(),componentIndex:0,cosAngle:0},ortho:Object(d["e"])(),fwd:Object(d["e"])()},x={v0:Object(d["e"])(),v1:Object(d["e"])(),v2:Object(d["e"])()},j={anglePlanar:4,angleSignificantEdge:35};async function w(e){const t=C(e),i=S(t),r=[t.data.buffer];return{result:T(i,r),transferList:r}}function S(e){const t=P(e.data,e.skipDeduplicate,e.indices,e.indicesLength);return A.updateSettings(e.writerSettings),R.updateSettings(e.writerSettings),m(t,A,R)}function C(e){return{data:a["a"].createView(e.dataBuffer),indices:"Uint32Array"===e.indicesType?new Uint32Array(e.indicesBuffer):"Uint16Array"===e.indicesType?new Uint16Array(e.indicesBuffer):void 0,indicesLength:e.indicesLength,writerSettings:e.writerSettings,skipDeduplicate:e.skipDeduplicate}}function T(e,t){return t.push(e.regular.lodInfo.lengths.buffer),t.push(e.silhouette.lodInfo.lengths.buffer),{regular:{instancesData:Object(s["a"])(e.regular.instancesData,t),lodInfo:{lengths:e.regular.lodInfo.lengths.buffer}},silhouette:{instancesData:Object(s["a"])(e.silhouette.instancesData,t),lodInfo:{lengths:e.silhouette.lodInfo.lengths.buffer}},averageEdgeLength:e.averageEdgeLength}}function P(e,t,i,n){if(t)return{faces:i,facesLength:n,neighbors:o(i,n,e.count),vertices:e};const s=Object(r["a"])(e.buffer,e.stride/4,{originalIndices:i,originalIndicesLength:n}),c=o(s.indices,n,s.uniqueCount);return{faces:s.indices,facesLength:s.indices.length,neighbors:c,vertices:a["a"].createView(s.buffer)}}const A=new n["a"],R=new n["b"]},"229e":function(e,t,i){"use strict";i.d(t,"a",(function(){return Ve})),i.d(t,"b",(function(){return Ue})),i.d(t,"c",(function(){return ke})),i.d(t,"d",(function(){return Ge})),i.d(t,"e",(function(){return Fe})),i.d(t,"f",(function(){return ze})),i.d(t,"g",(function(){return Be}));var r=i("5ef2"),a=i("ae0b");class n{constructor(e){this._color=Object(r["b"])(),this._key=e}get key(){return this._key}get type(){return 7&this._key}defines(){return[]}getStride(){return this._layoutInfo||this._buildAttributesInfo(),this._stride}getAttributeLocations(){return this._locations||this._buildAttributesInfo(),this._locations}getLayoutInfo(){return this._layoutInfo||this._buildAttributesInfo(),this._layoutInfo}getEncodingInfos(){return this._propertyEncodingInfo||this._buildAttributesInfo(),this._propertyEncodingInfo}getUniforms(){return this._uniforms||this._buildAttributesInfo(),this._uniforms}getShaderHeader(){return this._shaderHeader||this._buildAttributesInfo(),this._shaderHeader}getShaderMain(){return this._shaderMain||this._buildAttributesInfo(),this._shaderMain}setDataUniforms(e,t,i,r){const a=this.getUniforms();for(const n in a){const s=a[n];switch(s.type){case"float":e.setUniform1f(s.name,s.getValue(i,t,r));break;case"vec2":e.setUniform2fv(s.name,s.getValue(i,t,r));break;case"vec4":{const a=s.getValue(i,t,r),n=a[3];this._color[0]=n*a[0],this._color[1]=n*a[1],this._color[2]=n*a[2],this._color[3]=n,e.setUniform4fv(s.name,this._color)}}}}encodeAttributes(e,t,i){const r=this.attributesInfo(),a=this.getEncodingInfos(),n=[];for(const o of Object.keys(a)){var s;const c=a[o],{type:l,precisionFactor:h,isLayout:d}=r[o],u=d?i.getLayoutProperty(o):i.getPaintProperty(o),p=null==(s=u.interpolator)?void 0:s.getInterpolationRange(t);let f=0;for(const i of c){i.dataIndex>=n.length&&n.push(0);const r=u.getValue(p?p[f]:t,e);switch(l){case 0:n[i.dataIndex]|=this._encodeByte(r*(h||1),8*i.offset);break;case 1:n[i.dataIndex]|=this._encodeByte(r*(h||1)+128,8*i.offset);break;case 2:n[i.dataIndex]=this._encodeColor(r);break;default:throw new Error("Unsupported encoding type")}++f}}return n}getAtributeState(e){let t=0;const i=3+2*e;return t|=this._bit(i),t|=this._bit(i+1)<<1,t}_buildAttributesInfo(){const e=[],t={},i={};let r=-1;const a=this.attributesInfo(),s=this.attributes();let o=-1;for(const u of s){++o;const s=this.getAtributeState(o);if(0===s)continue;const c=a[u],l=[];t[u]=l;const h=c.type;for(let t=0;t<s;++t){const{dataType:t,bytesPerElement:a,count:s,normalized:o}=n._encodingInfo[h],c=t<<2|s;let d=i[c];d&&4!==d.offset||(++r,i[c]=d={dataIndex:r,offset:0},e.push({location:-1,name:"a_data_"+r,count:4/a,type:t,normalized:o})),l.push({dataIndex:d.dataIndex,offset:d.offset}),d.offset+=a*s}}this._buildVertexBufferLayout(e);const c={};let l=0;const h=this._layoutInfo.geometry;for(const n of h)c[n.name]=l++;const d=this._layoutInfo.opacity;if(d)for(const n of d)c[n.name]=l++;this._buildShaderInfo(e,t),this._propertyEncodingInfo=t,this._locations=c}_buildVertexBufferLayout(e){const t={},i=this.geometryInfo();let r=i[0].stride;if(0===e.length)t.geometry=i;else{const a=[];let n=r;r+=4*e.length;for(const e of i){const t={...e};t.stride=r,a.push(t)}for(const t of e)a.push({name:t.name,count:t.count,type:t.type,offset:n,stride:r,normalized:t.normalized||!1,divisor:0}),n+=s(t.type)*t.count;t.geometry=a}this.opacityInfo()&&(t.opacity=this.opacityInfo()),this._layoutInfo=t,this._stride=r}_buildShaderInfo(e,t){let i="\n",r="\n";const a=[];for(const n of e)i+=`attribute ${this._getType(n.count)} ${n.name};\n`;const s=this.attributes(),o=this.attributesInfo();let c=-1;for(const l of s){++c;const{name:e,type:s,precisionFactor:h,isLayout:d}=o[l],u=h&&1!==h?" * "+1/h:"",{bytesPerElement:p,count:f}=n._encodingInfo[s],m=e=>{const t=2===s?"":`[${e.offset/p}]`;return`a_data_${e.dataIndex}${t}`};switch(this.getAtributeState(c)){case 0:{const t=this._getType(f),n="u_"+e;a.push({name:n,type:t,getValue:(e,t)=>d?e.getLayoutValue(l,t):e.getPaintValue(l,t)}),i+=`uniform ${t} ${n};\n`,r+=`${t} ${e} = ${n};\n`}break;case 1:{const i=m(t[l][0]);r+=`${this._getType(f)} ${e} = ${i}${u};\n`}break;case 2:{const n="u_t_"+e;a.push({name:n,type:"float",getValue:(e,t,i)=>(d?e.getLayoutProperty(l):e.getPaintProperty(l)).interpolator.interpolationUniformValue(i,t)}),i+=`uniform float ${n};\n`;const s=m(t[l][0]),o=m(t[l][1]);r+=`${this._getType(f)} ${e} = mix(${s}${u}, ${o}${u}, ${n});\n`}}}this._shaderHeader=i,this._shaderMain=r,this._uniforms=a}_bit(e){return(this._key&1<<e)>>e}_getType(e){switch(e){case 1:return"float";case 2:return"vec2";case 4:return"vec4"}throw new Error("Invalid count")}_encodeColor(e){const t=255*e[3];return a["a"].i8888to32(e[0]*t,e[1]*t,e[2]*t,t)}_encodeByte(e,t){return(255&e)<<t}}n._encodingInfo=[{dataType:5121,bytesPerElement:1,count:1,normalized:!1},{dataType:5121,bytesPerElement:1,count:1,normalized:!1},{dataType:5121,bytesPerElement:1,count:4,normalized:!0}];const s=e=>{switch(e){case 5126:case 5124:case 5125:return 4;case 5122:case 5123:return 2;case 5120:case 5121:return 1}};class o extends n{constructor(e){super(e)}geometryInfo(){return o.GEOMETRY_LAYOUT}opacityInfo(){return null}attributes(){return o.ATTRIBUTES}attributesInfo(){return o.ATTRIBUTES_INFO}}o.ATTRIBUTES=[],o.GEOMETRY_LAYOUT=[{name:"a_pos",count:2,type:5120,offset:0,stride:2,normalized:!1,divisor:0}],o.ATTRIBUTES_INFO={};class c extends n{constructor(e){super(e)}geometryInfo(){return c.GEOMETRY_LAYOUT}opacityInfo(){return null}attributes(){return c.ATTRIBUTES}attributesInfo(){return c.ATTRIBUTES_INFO}}c.ATTRIBUTES=["circle-radius","circle-color","circle-opacity","circle-stroke-width","circle-stroke-color","circle-stroke-opacity","circle-blur"],c.GEOMETRY_LAYOUT=[{name:"a_pos",count:2,type:5122,offset:0,stride:4,normalized:!1,divisor:0}],c.ATTRIBUTES_INFO={"circle-radius":{name:"radius",type:0},"circle-color":{name:"color",type:2},"circle-opacity":{name:"opacity",type:0,precisionFactor:100},"circle-stroke-width":{name:"stroke_width",type:0,precisionFactor:4},"circle-stroke-color":{name:"stroke_color",type:2},"circle-stroke-opacity":{name:"stroke_opacity",type:0,precisionFactor:100},"circle-blur":{name:"blur",type:0,precisionFactor:32}};class l extends n{constructor(e){super(e)}geometryInfo(){return l.GEOMETRY_LAYOUT}opacityInfo(){return null}attributes(){return l.ATTRIBUTES}attributesInfo(){return l.ATTRIBUTES_INFO}}l.ATTRIBUTES=["fill-color","fill-opacity"],l.GEOMETRY_LAYOUT=[{name:"a_pos",count:2,type:5122,offset:0,stride:4,normalized:!1,divisor:0}],l.ATTRIBUTES_INFO={"fill-color":{name:"color",type:2},"fill-opacity":{name:"opacity",type:0,precisionFactor:100}};class h extends n{constructor(e,t){super(e),this.usefillColor=t}geometryInfo(){return h.GEOMETRY_LAYOUT}opacityInfo(){return null}attributes(){return this.usefillColor?h.ATTRIBUTES_FILL:h.ATTRIBUTES_OUTLINE}attributesInfo(){return this.usefillColor?h.ATTRIBUTES_INFO_FILL:h.ATTRIBUTES_INFO_OUTLINE}}h.ATTRIBUTES_OUTLINE=["fill-outline-color","fill-opacity"],h.ATTRIBUTES_FILL=["fill-color","fill-opacity"],h.GEOMETRY_LAYOUT=[{name:"a_pos",count:2,type:5122,offset:0,stride:8,normalized:!1,divisor:0},{name:"a_offset",count:2,type:5120,offset:4,stride:8,normalized:!1,divisor:0},{name:"a_xnormal",count:2,type:5120,offset:6,stride:8,normalized:!1,divisor:0}],h.ATTRIBUTES_INFO_OUTLINE={"fill-outline-color":{name:"color",type:2},"fill-opacity":{name:"opacity",type:0,precisionFactor:100}},h.ATTRIBUTES_INFO_FILL={"fill-color":{name:"color",type:2},"fill-opacity":{name:"opacity",type:0,precisionFactor:100}};class d extends n{constructor(e){super(e)}geometryInfo(){return d.GEOMETRY_LAYOUT}opacityInfo(){return null}attributes(){return d.ATTRIBUTES}attributesInfo(){return d.ATTRIBUTES_INFO}}d.ATTRIBUTES=["line-blur","line-color","line-gap-width","line-offset","line-opacity","line-width"],d.GEOMETRY_LAYOUT=[{name:"a_pos",count:2,type:5122,offset:0,stride:12,normalized:!1,divisor:0},{name:"a_offsetAndNormal",count:4,type:5120,offset:4,stride:12,normalized:!1,divisor:0},{name:"a_accumulatedDistance",count:2,type:5123,offset:8,stride:12,normalized:!1,divisor:0}],d.ATTRIBUTES_INFO={"line-width":{name:"width",type:0,precisionFactor:2},"line-gap-width":{name:"gap_width",type:0,precisionFactor:2},"line-offset":{name:"offset",type:1,precisionFactor:2},"line-color":{name:"color",type:2},"line-opacity":{name:"opacity",type:0,precisionFactor:100},"line-blur":{name:"blur",type:0,precisionFactor:4}};const u=[{name:"a_pos",count:2,type:5122,offset:0,stride:16,normalized:!1,divisor:0},{name:"a_vertexOffset",count:2,type:5122,offset:4,stride:16,normalized:!1,divisor:0},{name:"a_texAngleRange",count:4,type:5121,offset:8,stride:16,normalized:!1,divisor:0},{name:"a_levelInfo",count:4,type:5121,offset:12,stride:16,normalized:!1,divisor:0}],p=[{name:"a_opacityInfo",count:1,type:5121,offset:0,stride:1,normalized:!1,divisor:0}];class f extends n{constructor(e){super(e)}geometryInfo(){return u}opacityInfo(){return p}attributes(){return f.ATTRIBUTES}attributesInfo(){return f.ATTRIBUTES_INFO}}f.ATTRIBUTES=["icon-color","icon-opacity","icon-halo-blur","icon-halo-color","icon-halo-width","icon-size"],f.ATTRIBUTES_INFO={"icon-color":{name:"color",type:2},"icon-opacity":{name:"opacity",type:0,precisionFactor:100},"icon-halo-color":{name:"halo_color",type:2},"icon-halo-width":{name:"halo_width",type:0,precisionFactor:4},"icon-halo-blur":{name:"halo_blur",type:0,precisionFactor:4},"icon-size":{name:"size",type:0,precisionFactor:32,isLayout:!0}};class m extends n{constructor(e){super(e)}geometryInfo(){return u}opacityInfo(){return p}attributes(){return m.ATTRIBUTES}attributesInfo(){return m.ATTRIBUTES_INFO}}m.ATTRIBUTES=["text-color","text-opacity","text-halo-blur","text-halo-color","text-halo-width","text-size"],m.ATTRIBUTES_INFO={"text-color":{name:"color",type:2},"text-opacity":{name:"opacity",type:0,precisionFactor:100},"text-halo-color":{name:"halo_color",type:2},"text-halo-width":{name:"halo_width",type:0,precisionFactor:4},"text-halo-blur":{name:"halo_blur",type:0,precisionFactor:4},"text-size":{name:"size",type:0,isLayout:!0}};var b=i("9ef0");const g={kind:"null"},v={kind:"number"},y={kind:"string"},O={kind:"boolean"},_={kind:"color"},x={kind:"object"},j={kind:"value"};function w(e,t){return{kind:"array",itemType:e,n:t}}const S=[g,v,y,O,_,x,w(j)];function C(e){if("array"===e.kind){const t=C(e.itemType);return"number"==typeof e.n?`array<${t}, ${e.n}>`:"value"===e.itemType.kind?"array":`array<${t}>`}return e.kind}function T(e){if(null===e)return g;if("string"==typeof e)return y;if("boolean"==typeof e)return O;if("number"==typeof e)return v;if(e instanceof b["a"])return _;if(Array.isArray(e)){let t;for(const i of e){const e=T(i);if(t){if(t!==e){t=j;break}}else t=e}return w(t||j,e.length)}return"object"==typeof e?x:j}function P(e,t){if("array"===t.kind)return"array"===e.kind&&(0===e.n&&"value"===e.itemType.kind||P(e.itemType,t.itemType))&&("number"!=typeof t.n||t.n===e.n);if("value"===t.kind)for(const i of S)if(P(e,i))return!0;return t.kind===e.kind}function A(e){if(null===e)return"";const t=typeof e;return"string"===t?e:"number"===t||"boolean"===t?String(e):e instanceof b["a"]?e.toString():JSON.stringify(e)}var R=i("d329"),M=i("0554"),E=i("3b19");class D{constructor(e){this.parent=e,this.vars={}}add(e,t){this.vars[e]=t}get(e){return this.vars[e]?this.vars[e]:this.parent?this.parent.get(e):null}}class I{constructor(){this.type=j}static parse(e){if(e.length>1)throw new Error('"id" does not expect arguments');return new I}evaluate(e,t){return e.id||null}}class L{constructor(){this.type=y}static parse(e){if(e.length>1)throw new Error('"geometry-type" does not expect arguments');return new L}evaluate(e,t){switch(e.type){case 1:return"Point";case 2:return"LineString";case 3:return"Polygon";default:return null}}}class V{constructor(){this.type=x}static parse(e){if(e.length>1)throw new Error('"properties" does not expect arguments');return new V}evaluate(e,t){return e.values}}class k{constructor(){this.type=v}static parse(e){if(e.length>1)throw new Error('"zoom" does not expect arguments');return new k}evaluate(e,t){return t}}class F{constructor(e,t,i){this.lhs=e,this.rhs=t,this.compare=i,this.type=O}static parse(e,t,i){if(3!==e.length&&4!==e.length)throw new Error(`"${e[0]}" expects 2 or 3 arguments`);if(4===e.length)throw new Error(`"${e[0]}" collator not supported`);return new F(Te(e[1],t),Te(e[2],t),i)}evaluate(e,t){return this.compare(this.lhs.evaluate(e,t),this.rhs.evaluate(e,t))}}class z extends F{static parse(e,t){return F.parse(e,t,(e,t)=>e===t)}}class U extends F{static parse(e,t){return F.parse(e,t,(e,t)=>e!==t)}}class G extends F{static parse(e,t){return F.parse(e,t,(e,t)=>e<t)}}class B extends F{static parse(e,t){return F.parse(e,t,(e,t)=>e<=t)}}class H extends F{static parse(e,t){return F.parse(e,t,(e,t)=>e>t)}}class N extends F{static parse(e,t){return F.parse(e,t,(e,t)=>e>=t)}}class q{constructor(e){this.arg=e,this.type=O}static parse(e,t){if(2!==e.length)throw new Error('"!" expects 1 argument');return new q(Te(e[1],t))}evaluate(e,t){return!this.arg.evaluate(e,t)}}class W{constructor(e){this.args=e,this.type=O}static parse(e,t){const i=[];for(let r=1;r<e.length;r++)i.push(Te(e[r],t));return new W(i)}evaluate(e,t){for(const i of this.args)if(!i.evaluate(e,t))return!1;return!0}}class Z{constructor(e){this.args=e,this.type=O}static parse(e,t){const i=[];for(let r=1;r<e.length;r++)i.push(Te(e[r],t));return new Z(i)}evaluate(e,t){for(const i of this.args)if(i.evaluate(e,t))return!0;return!1}}class ${constructor(e){this.args=e,this.type=O}static parse(e,t){const i=[];for(let r=1;r<e.length;r++)i.push(Te(e[r],t));return new $(i)}evaluate(e,t){for(const i of this.args)if(i.evaluate(e,t))return!1;return!0}}class Q{constructor(e,t,i){this.type=e,this.args=t,this.fallback=i}static parse(e,t,i){if(e.length<4)throw new Error('"case" expects at least 3 arguments');if(e.length%2==1)throw new Error('"case" expects an odd number of arguments');let r;const a=[];for(let s=1;s<e.length-1;s+=2){const n=Te(e[s],t),o=Te(e[s+1],t,i);r||(r=o.type),a.push({condition:n,output:o})}const n=Te(e[e.length-1],t,i);return r||(r=n.type),new Q(r,a,n)}evaluate(e,t){for(const i of this.args)if(i.condition.evaluate(e,t))return i.output.evaluate(e,t);return this.fallback.evaluate(e,t)}}class X{constructor(e,t){this.type=e,this.args=t}static parse(e,t){if(e.length<2)throw new Error('"coalesce" expects at least 1 argument');let i;const r=[];for(let a=1;a<e.length;a++){const n=Te(e[a],t);i||(i=n.type),r.push(n)}return new X(i,r)}evaluate(e,t){for(const i of this.args){const r=i.evaluate(e,t);if(null!==r)return r}return null}}class Y{constructor(e,t,i,r,a){this.type=e,this.input=t,this.labels=i,this.outputs=r,this.fallback=a}static parse(e,t){if(e.length<3)throw new Error('"match" expects at least 3 arguments');if(e.length%2==0)throw new Error('"case" expects an even number of arguments');let i;const r=Te(e[1],t),a=[],n={};let s;for(let o=2;o<e.length-1;o+=2){let r=e[o];Array.isArray(r)||(r=[r]);for(const e of r){const t=typeof e;if("string"!==t&&"number"!==t)throw new Error('"match" requires string or number literal as labels');if(s){if(t!==s)throw new Error('"match" requires labels to have the same type')}else s=t;n[e]=a.length}const c=Te(e[o+1],t);i||(i=c.type),a.push(c)}return new Y(i,r,n,a,Te(e[e.length-1],t))}evaluate(e,t){const i=this.input.evaluate(e,t);return(this.outputs[this.labels[i]]||this.fallback).evaluate(e,t)}}class K{constructor(e,t,i,r,a){this.operator=e,this.type=t,this.interpolation=i,this.input=r,this.stops=a}static parse(e,t,i){const r=e[0];if(e.length<5)throw new Error(`"${r}" expects at least 4 arguments`);const a=e[1];if(!Array.isArray(a)||0===a.length)throw new Error(`"${a}" is not a valid interpolation`);switch(a[0]){case"linear":if(1!==a.length)throw new Error("Linear interpolation cannot have parameters");break;case"exponential":if(2!==a.length||"number"!=typeof a[1])throw new Error("Exponential interpolation requires one numeric argument");break;case"cubic-bezier":if(5!==a.length)throw new Error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1");for(let e=1;e<5;e++){const t=a[e];if("number"!=typeof t||t<0||t>1)throw new Error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1")}break;default:throw new Error(`"${e[0]}" unknown interpolation type "${a[0]}"`)}if(e.length%2!=1)throw new Error(`"${r}" expects an even number of arguments`);const n=Te(e[2],t,v);let s;"interpolate-hcl"===r||"interpolate-lab"===r?s=_:i&&"value"!==i.kind&&(s=i);const o=[];for(let c=3;c<e.length;c+=2){const i=e[c];if("number"!=typeof i)throw new Error(`"${r}" requires stop inputs as literal numbers`);if(o.length&&o[o.length-1][0]>=i)throw new Error(`"${r}" requires strictly ascending stop inputs`);const a=Te(e[c+1],t,s);s||(s=a.type),o.push([i,a])}if(s&&s!==_&&s!==v&&("array"!==s.kind||s.itemType!==v))throw new Error(`"${r}" cannot interpolate type ${C(s)}`);return new K(r,s,a,n,o)}evaluate(e,t){const i=this.stops;if(1===i.length)return i[0][1].evaluate(e,t);const r=this.input.evaluate(e,t);if(r<=i[0][0])return i[0][1].evaluate(e,t);if(r>=i[i.length-1][0])return i[i.length-1][1].evaluate(e,t);let a=0;for(;++a<i.length&&!(r<i[a][0]););const n=i[a-1][0],s=i[a][0],o=K.interpolationRatio(this.interpolation,r,n,s),c=i[a-1][1].evaluate(e,t),l=i[a][1].evaluate(e,t);if("interpolate"===this.operator){if("array"===this.type.kind&&Array.isArray(c)&&Array.isArray(l))return c.map((e,t)=>Object(E["e"])(e,l[t],o));if("color"===this.type.kind&&c instanceof b["a"]&&l instanceof b["a"]){const e=new b["a"](c),t=new b["a"](l);return new b["a"]([Object(E["e"])(e.r,t.r,o),Object(E["e"])(e.g,t.g,o),Object(E["e"])(e.b,t.b,o),Object(E["e"])(e.a,t.a,o)])}if("number"===this.type.kind&&"number"==typeof c&&"number"==typeof l)return Object(E["e"])(c,l,o);throw new Error(`"${this.operator}" cannot interpolate type ${C(this.type)}`)}if("interpolate-hcl"===this.operator){const e=Object(R["d"])(c),t=Object(R["d"])(l),i=t.h-e.h,r=Object(R["e"])({h:e.h+o*(i>180||i<-180?i-360*Math.round(i/360):i),c:Object(E["e"])(e.c,t.c,o),l:Object(E["e"])(e.l,t.l,o)});return new b["a"]({a:Object(E["e"])(c.a,l.a,o),...r})}if("interpolate-lab"===this.operator){const e=Object(R["c"])(c),t=Object(R["c"])(l),i=Object(R["e"])({l:Object(E["e"])(e.l,t.l,o),a:Object(E["e"])(e.a,t.a,o),b:Object(E["e"])(e.b,t.b,o)});return new b["a"]({a:Object(E["e"])(c.a,l.a,o),...i})}throw new Error(`Unexpected operator "${this.operator}"`)}interpolationUniformValue(e,t){const i=this.stops;if(1===i.length)return 0;if(e>=i[i.length-1][0])return 0;let r=0;for(;++r<i.length&&!(e<i[r][0]););const a=i[r-1][0],n=i[r][0];return K.interpolationRatio(this.interpolation,t,a,n)}getInterpolationRange(e){const t=this.stops;if(1===t.length){const e=t[0][0];return[e,e]}const i=t[t.length-1][0];if(e>=i)return[i,i];let r=0;for(;++r<t.length&&!(e<t[r][0]););return[t[r-1][0],t[r][0]]}static interpolationRatio(e,t,i,r){let a=0;return"linear"===e[0]?a=K.exponentialInterpolationRatio(t,1,i,r):"exponential"===e[0]?a=K.exponentialInterpolationRatio(t,e[1],i,r):"cubic-bezier"===e[0]&&(a=Object(M["c"])(e[1],e[2],e[3],e[4])(K.exponentialInterpolationRatio(t,1,i,r),1e-5)),a<0?a=0:a>1&&(a=1),a}static exponentialInterpolationRatio(e,t,i,r){const a=r-i;if(0===a)return 0;const n=e-i;return 1===t?n/a:(t**n-1)/(t**a-1)}}class J{constructor(e,t,i){this.type=e,this.input=t,this.stops=i}static parse(e,t){if(e.length<5)throw new Error('"step" expects at least 4 arguments');if(e.length%2!=1)throw new Error('"step" expects an even number of arguments');const i=Te(e[1],t,v);let r;const a=[];a.push([-1/0,Te(e[2],t)]);for(let n=3;n<e.length;n+=2){const i=e[n];if("number"!=typeof i)throw new Error('"step" requires stop inputs as literal numbers');if(a.length&&a[a.length-1][0]>=i)throw new Error('"step" requires strictly ascending stop inputs');const s=Te(e[n+1],t);r||(r=s.type),a.push([i,s])}return new J(r,i,a)}evaluate(e,t){const i=this.stops;if(1===i.length)return i[0][1].evaluate(e,t);const r=this.input.evaluate(e,t);let a=0;for(;++a<i.length&&!(r<i[a][0]););return this.stops[a-1][1].evaluate(e,t)}}class ee{constructor(e,t){this.type=e,this.output=t}static parse(e,t,i){if(e.length<4)throw new Error('"let" expects at least 3 arguments');if(e.length%2==1)throw new Error('"let" expects an odd number of arguments');const r=new D(t);for(let n=1;n<e.length-1;n+=2){const i=e[n];if("string"!=typeof i)throw new Error('"let" requires a string to define variable names - found '+i);r.add(i,Te(e[n+1],t))}const a=Te(e[e.length-1],r,i);return new ee(a.type,a)}evaluate(e,t){return this.output.evaluate(e,t)}}class te{constructor(e,t){this.type=e,this.output=t}static parse(e,t,i){if(2!==e.length||"string"!=typeof e[1])throw new Error('"var" requires just one literal string argument');const r=t.get(e[1]);if(!r)throw new Error(e[1]+' must be defined before being used in a "var" expression');return new te(i||j,r)}evaluate(e,t){return this.output.evaluate(e,t)}}class ie{constructor(e,t,i){this.type=e,this.index=t,this.array=i}static parse(e,t){if(3!==e.length)throw new Error('"at" expects 2 arguments');const i=Te(e[1],t,v),r=Te(e[2],t);return new ie(r.type.itemType,i,r)}evaluate(e,t){const i=this.index.evaluate(e,t),r=this.array.evaluate(e,t);if(i<0||i>=r.length)throw new Error('"at" index out of bounds');if(i!==Math.floor(i))throw new Error('"at" index must be an integer');return r[i]}}class re{constructor(e,t){this.key=e,this.obj=t,this.type=j}static parse(e,t){let i,r;switch(e.length){case 2:return i=Te(e[1],t),new re(i);case 3:return i=Te(e[1],t),r=Te(e[2],t),new re(i,r);default:throw new Error('"get" expects 1 or 2 arguments')}}evaluate(e,t){const i=this.key.evaluate(e,t);return this.obj?this.obj.evaluate(e,t)[i]:e.values[i]}}class ae{constructor(e,t){this.key=e,this.obj=t,this.type=O}static parse(e,t){let i,r;switch(e.length){case 2:return i=Te(e[1],t),new ae(i);case 3:return i=Te(e[1],t),r=Te(e[2],t),new ae(i,r);default:throw new Error('"has" expects 1 or 2 arguments')}}evaluate(e,t){const i=this.key.evaluate(e,t);return this.obj?i in this.obj.evaluate(e,t):void 0!==e.values[i]}}class ne{constructor(e,t){this.key=e,this.vals=t,this.type=O}static parse(e,t){if(3!==e.length)throw new Error('"in" expects 2 arguments');return new ne(Te(e[1],t),Te(e[2],t))}evaluate(e,t){const i=this.key.evaluate(e,t);return-1!==this.vals.evaluate(e,t).indexOf(i)}}class se{constructor(e,t,i){this.item=e,this.array=t,this.from=i,this.type=v}static parse(e,t){if(e.length<3||e.length>4)throw new Error('"index-of" expects 3 or 4 arguments');const i=Te(e[1],t),r=Te(e[2],t);if(4===e.length){const a=Te(e[3],t,v);return new se(i,r,a)}return new se(i,r)}evaluate(e,t){const i=this.item.evaluate(e,t),r=this.array.evaluate(e,t);if(this.from){const a=this.from.evaluate(e,t);if(a!==Math.floor(a))throw new Error('"index-of" index must be an integer');return r.indexOf(i,a)}return r.indexOf(i)}}class oe{constructor(e){this.arg=e,this.type=v}static parse(e,t){if(2!==e.length)throw new Error('"length" expects 2 arguments');const i=Te(e[1],t);return new oe(i)}evaluate(e,t){const i=this.arg.evaluate(e,t);if("string"==typeof i)return i.length;if(Array.isArray(i))return i.length;throw new Error('"length" expects string or array')}}class ce{constructor(e,t,i,r){this.type=e,this.array=t,this.from=i,this.to=r}static parse(e,t){if(e.length<3||e.length>4)throw new Error('"slice" expects 2 or 3 arguments');const i=Te(e[1],t),r=Te(e[2],t,v);if(r.type!==v)throw new Error('"slice" index must return a number');if(4===e.length){const a=Te(e[3],t,v);if(a.type!==v)throw new Error('"slice" index must return a number');return new ce(i.type,i,r,a)}return new ce(i.type,i,r)}evaluate(e,t){const i=this.array.evaluate(e,t);if(!Array.isArray(i)&&"string"!=typeof i)throw new Error('"slice" input must be an array or a string');const r=this.from.evaluate(e,t);if(r<0||r>=i.length)throw new Error('"slice" index out of bounds');if(r!==Math.floor(r))throw new Error('"slice" index must be an integer');if(this.to){const a=this.to.evaluate(e,t);if(a<0||a>=i.length)throw new Error('"slice" index out of bounds');if(a!==Math.floor(a))throw new Error('"slice" index must be an integer');return i.slice(r,a)}return i.slice(r)}}class le{constructor(){this.type=O}static parse(e){if(1!==e.length)throw new Error('"has-id" expects no arguments');return new le}evaluate(e,t){return void 0!==e.id}}class he{constructor(e,t){this.args=e,this.calculate=t,this.type=v}static parse(e,t,i){const r=e.slice(1).map(e=>Te(e,t));return new he(r,i)}evaluate(e,t){let i;return this.args&&(i=this.args.map(i=>i.evaluate(e,t))),this.calculate(i)}}class de extends he{static parse(e,t){switch(e.length){case 2:return he.parse(e,t,e=>-e[0]);case 3:return he.parse(e,t,e=>e[0]-e[1]);default:throw new Error('"-" expects 1 or 2 arguments')}}}class ue extends he{static parse(e,t){return he.parse(e,t,e=>{let t=1;for(const i of e)t*=i;return t})}}class pe extends he{static parse(e,t){if(3===e.length)return he.parse(e,t,e=>e[0]/e[1]);throw new Error('"/" expects 2 arguments')}}class fe extends he{static parse(e,t){if(3===e.length)return he.parse(e,t,e=>e[0]%e[1]);throw new Error('"%" expects 2 arguments')}}class me extends he{static parse(e,t){if(3===e.length)return he.parse(e,t,e=>e[0]**e[1]);throw new Error('"^" expects 1 or 2 arguments')}}class be extends he{static parse(e,t){return he.parse(e,t,e=>{let t=0;for(const i of e)t+=i;return t})}}class ge{constructor(e,t){this.args=e,this.calculate=t,this.type=v}static parse(e,t){const i=e.slice(1).map(e=>Te(e,t));return new ge(i,ge.ops[e[0]])}evaluate(e,t){let i;return this.args&&(i=this.args.map(i=>i.evaluate(e,t))),this.calculate(i)}}ge.ops={abs:e=>Math.abs(e[0]),acos:e=>Math.acos(e[0]),asin:e=>Math.asin(e[0]),atan:e=>Math.atan(e[0]),ceil:e=>Math.ceil(e[0]),cos:e=>Math.cos(e[0]),e:()=>Math.E,floor:e=>Math.floor(e[0]),ln:e=>Math.log(e[0]),ln2:()=>Math.LN2,log10:e=>Math.log(e[0])/Math.LN10,log2:e=>Math.log(e[0])/Math.LN2,max:e=>Math.max(...e),min:e=>Math.min(...e),pi:()=>Math.PI,round:e=>Math.round(e[0]),sin:e=>Math.sin(e[0]),sqrt:e=>Math.sqrt(e[0]),tan:e=>Math.tan(e[0])};class ve{constructor(e){this.args=e,this.type=y}static parse(e,t){return new ve(e.slice(1).map(e=>Te(e,t)))}evaluate(e,t){return this.args.map(i=>i.evaluate(e,t)).join("")}}class ye{constructor(e,t){this.arg=e,this.calculate=t,this.type=y}static parse(e,t){if(2!==e.length)throw new Error(e[0]+" expects 1 argument");const i=Te(e[1],t);return new ye(i,ye.ops[e[0]])}evaluate(e,t){return this.calculate(this.arg.evaluate(e,t))}}ye.ops={downcase:e=>e.toLowerCase(),upcase:e=>e.toUpperCase()};class Oe{constructor(e){this.args=e,this.type=_}static parse(e,t){if(4!==e.length)throw new Error('"rgb" expects 3 arguments');const i=e.slice(1).map(e=>Te(e,t));return new Oe(i)}evaluate(e,t){const i=this._validate(this.args[0].evaluate(e,t)),r=this._validate(this.args[1].evaluate(e,t)),a=this._validate(this.args[2].evaluate(e,t));return new b["a"]({r:i,g:r,b:a})}_validate(e){if("number"!=typeof e||e<0||e>255)throw new Error(e+": invalid color component");return Math.round(e)}}class _e{constructor(e){this.args=e,this.type=_}static parse(e,t){if(5!==e.length)throw new Error('"rgba" expects 4 arguments');const i=e.slice(1).map(e=>Te(e,t));return new _e(i)}evaluate(e,t){const i=this._validate(this.args[0].evaluate(e,t)),r=this._validate(this.args[1].evaluate(e,t)),a=this._validate(this.args[2].evaluate(e,t)),n=this._validateAlpha(this.args[3].evaluate(e,t));return new b["a"]({r:i,g:r,b:a,a:n})}_validate(e){if("number"!=typeof e||e<0||e>255)throw new Error(e+": invalid color component");return Math.round(e)}_validateAlpha(e){if("number"!=typeof e||e<0||e>1)throw new Error(e+": invalid alpha color component");return e}}class xe{constructor(e){this.color=e,this.type=w(v,4)}static parse(e,t){if(2!==e.length)throw new Error('"to-rgba" expects 1 argument');const i=Te(e[1],t);return new xe(i)}evaluate(e,t){return new b["a"](this.color.evaluate(e,t)).toRgba()}}class je{constructor(e,t){this.type=e,this.args=t}static parse(e,t){const i=e[0];if(e.length<2)throw new Error(i+" expects at least one argument");let r,a=1;if("array"===i){if(e.length>2){switch(e[1]){case"string":r=y;break;case"number":r=v;break;case"boolean":r=O;break;default:throw new Error('"array" type argument must be string, number or boolean')}a++}else r=j;let t;if(e.length>3){if(t=e[2],null!==t&&("number"!=typeof t||t<0||t!==Math.floor(t)))throw new Error('"array" length argument must be a positive integer literal');a++}r=w(r,t)}else switch(i){case"string":r=y;break;case"number":r=v;break;case"boolean":r=O;break;case"object":r=x}const n=[];for(;a<e.length;a++){const i=Te(e[a],t);n.push(i)}return new je(r,n)}evaluate(e,t){let i;for(const r of this.args){const a=r.evaluate(e,t);if(i=T(a),P(i,this.type))return a}throw new Error(`Expected ${C(this.type)} but got ${C(i)}`)}}class we{constructor(e,t){this.type=e,this.args=t}static parse(e,t){const i=e[0],r=we.types[i];if(r===O||r===y){if(2!==e.length)throw new Error(i+" expects one argument")}else if(e.length<2)throw new Error(i+" expects at least one argument");const a=[];for(let n=1;n<e.length;n++){const i=Te(e[n],t);a.push(i)}return new we(r,a)}evaluate(e,t){if(this.type===O)return Boolean(this.args[0].evaluate(e,t));if(this.type===y)return A(this.args[0].evaluate(e,t));if(this.type===v){for(const i of this.args){const r=Number(i.evaluate(e,t));if(!isNaN(r))return r}return null}if(this.type===_){for(const i of this.args)try{const r=we.toColor(i.evaluate(e,t));if(r instanceof b["a"])return r}catch{}return null}}static toBoolean(e){return Boolean(e)}static toString(e){return A(e)}static toNumber(e){const t=Number(e);if(isNaN(t))throw new Error(`"${e}" is not a number`);return t}static toColor(e){if(e instanceof b["a"])return e;if("string"==typeof e){const t=b["a"].fromString(e);if(t)return t;throw new Error(`"${e}" is not a color`)}if(Array.isArray(e))return b["a"].fromArray(e);throw new Error(`"${e}" is not a color`)}}we.types={"to-boolean":O,"to-color":_,"to-number":v,"to-string":y};class Se{constructor(e){this.val=e,this.type=T(e)}static parse(e){if(2!==e.length)throw new Error('"literal" expects 1 argument');return new Se(e[1])}evaluate(e,t){return this.val}}class Ce{constructor(e){this.arg=e,this.type=y}static parse(e,t){if(2!==e.length)throw new Error('"typeof" expects 1 argument');return new Ce(Te(e[1],t))}evaluate(e,t){return C(T(this.arg.evaluate(e,t)))}}function Te(e,t,i){const r=typeof e;if("string"===r||"boolean"===r||"number"===r||null===e){if(i)switch(i.kind){case"string":"string"!==r&&(e=we.toString(e));break;case"number":"number"!==r&&(e=we.toNumber(e));break;case"color":e=we.toColor(e)}e=["literal",e]}if(!Array.isArray(e)||0===e.length)throw new Error("Expression must be a non empty array");const a=e[0];if("string"!=typeof a)throw new Error("First element of expression must be a string");const n=Pe[a];if(void 0===n)throw new Error(`Invalid expression operator "${a}"`);if(!n)throw new Error(`Unimplemented expression operator "${a}"`);return n.parse(e,t,i)}const Pe={array:je,boolean:je,collator:null,format:null,image:null,literal:Se,number:je,"number-format":null,object:je,string:je,"to-boolean":we,"to-color":we,"to-number":we,"to-string":we,typeof:Ce,accumulated:null,"feature-state":null,"geometry-type":L,id:I,"line-progress":null,properties:V,at:ie,get:re,has:ae,in:ne,"index-of":se,length:oe,slice:ce,"!":q,"!=":U,"<":G,"<=":B,"==":z,">":H,">=":N,all:W,any:Z,case:Q,coalesce:X,match:Y,within:null,interpolate:K,"interpolate-hcl":K,"interpolate-lab":K,step:J,let:ee,var:te,concat:ve,downcase:ye,"is-supported-script":null,"resolved-locale":null,upcase:ye,rgb:Oe,rgba:_e,"to-rgba":xe,"-":de,"*":ue,"/":pe,"%":fe,"^":me,"+":be,abs:ge,acos:ge,asin:ge,atan:ge,ceil:ge,cos:ge,e:ge,floor:ge,ln:ge,ln2:ge,log10:ge,log2:ge,max:ge,min:ge,pi:ge,round:ge,sin:ge,sqrt:ge,tan:ge,zoom:k,"heatmap-density":null,"has-id":le,none:$};class Ae{constructor(e){this._expression=e}filter(e,t){if(!this._expression)return!0;try{return this._expression.evaluate(e,t)}catch(i){return console.log(i.message),!0}}static createFilter(e){if(!e)return null;this.isLegacyFilter(e)&&(e=this.convertLegacyFilter(e));try{const t=Te(e,null,O);return new Ae(t)}catch(t){return console.log(t.message),null}}static isLegacyFilter(e){if(!Array.isArray(e))return!0;if(0===e.length)return!0;switch(e[0]){case"==":case"!=":case">":case"<":case">=":case"<=":return 3===e.length&&"string"==typeof e[1]&&!Array.isArray(e[2]);case"in":return e.length>=3&&"string"==typeof e[1]&&!Array.isArray(e[2]);case"!in":return!0;case"any":case"all":for(let t=1;t<e.length;t++)if(!this.isLegacyFilter(e[1]))return!1;return!0;case"none":return!0;case"has":return 2===e.length&&("$id"===e[1]||"$type"===e[1]);case"!has":return!0;default:return!1}}static convertLegacyFilter(e){if(!Array.isArray(e)||0===e.length)return!0;const t=e[0];if(1===e.length)return"any"!==t;switch(t){case"==":return Ae.convertComparison("==",e[1],e[2]);case"!=":return Ae.negate(Ae.convertComparison("==",e[1],e[2]));case">":case"<":case">=":case"<=":return Ae.convertComparison(t,e[1],e[2]);case"in":return Ae.convertIn(e[1],e.slice(2));case"!in":return Ae.negate(Ae.convertIn(e[1],e.slice(2)));case"any":case"all":case"none":return Ae.convertCombining(t,e.slice(1));case"has":return Ae.convertHas(e[1]);case"!has":return Ae.negate(Ae.convertHas(e[1]));default:throw new Error("Unexpected legacy filter.")}}static convertComparison(e,t,i){switch(t){case"$type":return[e,["geometry-type"],i];case"$id":return[e,["id"],i];default:return[e,["get",t],i]}}static convertIn(e,t){switch(e){case"$type":return["in",["geometry-type"],["literal",t]];case"$id":return["in",["id"],["literal",t]];default:return["in",["get",e],["literal",t]]}}static convertHas(e){switch(e){case"$type":return!0;case"$id":return["has-id"];default:return["has",e]}}static convertCombining(e,t){return[e].concat(t.map(this.convertLegacyFilter))}static negate(e){return["!",e]}}var Re=Ae;class Me{}Me.backgroundLayoutDefinition={visibility:{type:"enum",values:["visible","none"],default:0}},Me.fillLayoutDefinition={visibility:{type:"enum",values:["visible","none"],default:0}},Me.lineLayoutDefinition={visibility:{type:"enum",values:["visible","none"],default:0},"line-cap":{type:"enum",values:["butt","round","square"],default:0},"line-join":{type:"enum",values:["bevel","round","miter"],default:2},"line-miter-limit":{type:"number",default:2},"line-round-limit":{type:"number",default:1.05}},Me.symbolLayoutDefinition={visibility:{type:"enum",values:["visible","none"],default:0},"symbol-avoid-edges":{type:"boolean",default:!1},"symbol-placement":{type:"enum",values:["point","line","line-center"],default:0},"symbol-sort-key":{type:"number",default:-1},"symbol-spacing":{type:"number",minimum:1,default:250},"icon-allow-overlap":{type:"boolean",default:!1},"icon-anchor":{type:"enum",values:["center","left","right","top","bottom","top-left","top-right","bottom-left","bottom-right"],default:0},"icon-ignore-placement":{type:"boolean",default:!1},"icon-image":{type:"string"},"icon-keep-upright":{type:"boolean",default:!1},"icon-offset":{type:"array",value:"number",length:2,default:[0,0]},"icon-optional":{type:"boolean",default:!1},"icon-padding":{type:"number",minimum:0,default:2},"icon-rotate":{type:"number",default:0},"icon-rotation-alignment":{type:"enum",values:["map","viewport","auto"],default:2},"icon-size":{type:"number",minimum:0,default:1},"text-allow-overlap":{type:"boolean",default:!1},"text-anchor":{type:"enum",values:["center","left","right","top","bottom","top-left","top-right","bottom-left","bottom-right"],default:0},"text-field":{type:"string"},"text-font":{type:"array",value:"string",default:["Open Sans Regular","Arial Unicode MS Regular"]},"text-ignore-placement":{type:"boolean",default:!1},"text-justify":{type:"enum",values:["auto","left","center","right"],default:2},"text-keep-upright":{type:"boolean",default:!0},"text-letter-spacing":{type:"number",default:0},"text-line-height":{type:"number",default:1.2},"text-max-angle":{type:"number",minimum:0,default:45},"text-max-width":{type:"number",minimum:0,default:10},"text-offset":{type:"array",value:"number",length:2,default:[0,0]},"text-optional":{type:"boolean",default:!1},"text-padding":{type:"number",minimum:0,default:2},"text-rotate":{type:"number",default:0},"text-rotation-alignment":{type:"enum",values:["map","viewport","auto"],default:2},"text-size":{type:"number",minimum:0,default:16},"text-transform":{type:"enum",values:["none","uppercase","lowercase"],default:0},"text-writing-mode":{type:"array",value:"enum",values:["horizontal","vertical"],default:[0]}},Me.circleLayoutDefinition={visibility:{type:"enum",values:["visible","none"],default:0}},Me.backgroundPaintDefinition={"background-color":{type:"color",default:[0,0,0,1]},"background-opacity":{type:"number",minimum:0,maximum:1,default:1},"background-pattern":{type:"string"}},Me.fillPaintDefinition={"fill-antialias":{type:"boolean",default:!0},"fill-color":{type:"color",default:[0,0,0,1]},"fill-opacity":{type:"number",minimum:0,maximum:1,default:1},"fill-outline-color":{type:"color",default:[0,0,0,0]},"fill-pattern":{type:"string"},"fill-translate":{type:"array",value:"number",length:2,default:[0,0]},"fill-translate-anchor":{type:"enum",values:["map","viewport"],default:0}},Me.linePaintDefinition={"line-blur":{type:"number",minimum:0,default:0},"line-color":{type:"color",default:[0,0,0,1]},"line-dasharray":{type:"array",value:"number",default:[]},"line-gap-width":{type:"number",minimum:0,default:0},"line-offset":{type:"number",default:0},"line-opacity":{type:"number",minimum:0,maximum:1,default:1},"line-pattern":{type:"string"},"line-translate":{type:"array",value:"number",length:2,default:[0,0]},"line-translate-anchor":{type:"enum",values:["map","viewport"],default:0},"line-width":{type:"number",minimum:0,default:1}},Me.symbolPaintDefinition={"icon-color":{type:"color",default:[0,0,0,1]},"icon-halo-blur":{type:"number",minimum:0,default:0},"icon-halo-color":{type:"color",default:[0,0,0,0]},"icon-halo-width":{type:"number",minimum:0,default:0},"icon-opacity":{type:"number",minimum:0,maximum:1,default:1},"icon-translate":{type:"array",value:"number",length:2,default:[0,0]},"icon-translate-anchor":{type:"enum",values:["map","viewport"],default:0},"text-color":{type:"color",default:[0,0,0,1]},"text-halo-blur":{type:"number",minimum:0,default:0},"text-halo-color":{type:"color",default:[0,0,0,0]},"text-halo-width":{type:"number",minimum:0,default:0},"text-opacity":{type:"number",minimum:0,maximum:1,default:1},"text-translate":{type:"array",value:"number",length:2,default:[0,0]},"text-translate-anchor":{type:"enum",values:["map","viewport"],default:0}},Me.rasterPaintDefinition={"raster-opacity":{type:"number",minimum:0,maximum:1,default:1},"raster-hue-rotate":{type:"number",default:0},"raster-brightness-min":{type:"number",minimum:0,maximum:1,default:0},"raster-brightness-max":{type:"number",minimum:0,maximum:1,default:1},"raster-saturation":{type:"number",minimum:-1,maximum:1,default:0},"raster-contrast":{type:"number",minimum:-1,maximum:1,default:0},"raster-fade-duration":{type:"number",minimum:0,default:300}},Me.circlePaintDefinition={"circle-blur":{type:"number",minimum:0,default:0},"circle-color":{type:"color",default:[0,0,0,1]},"circle-opacity":{type:"number",minimum:0,maximum:1,default:1},"circle-radius":{type:"number",minimum:0,default:5},"circle-stroke-color":{type:"color",default:[0,0,0,1]},"circle-stroke-opacity":{type:"number",minimum:0,maximum:1,default:1},"circle-stroke-width":{type:"number",minimum:0,default:0},"circle-translate":{type:"array",value:"number",length:2,default:[0,0]},"circle-translate-anchor":{type:"enum",values:["map","viewport"],default:0}};class Ee{constructor(e,t){let i;switch(this.isDataDriven=!1,this.interpolator=null,e.type){case"number":case"color":i=!0;break;case"array":i="number"===e.value;break;default:i=!1}if(null==t&&(t=e.default),Array.isArray(t)&&t.length>0&&Pe[t[0]]){const i={number:v,color:_,string:y,boolean:O,enum:y};try{const r="array"===e.type?w(i[e.value]||j,e.length):i[e.type],a=Te(t,null,r);this.getValue=this._buildExpression(a,e),this.isDataDriven=!0,a instanceof K&&a.input instanceof k&&(this.interpolator=a)}catch(a){console.log(a.message),this.getValue=this._buildSimple(e.default)}return}i&&"interval"===t.type&&(i=!1);const r=t&&t.stops&&t.stops.length>0;if(r)for(const n of t.stops)n[1]=this._validate(n[1],e);if(this.isDataDriven=!!t&&!!t.property,this.isDataDriven)if(void 0!==t.default&&(t.default=this._validate(t.default,e)),r)switch(t.type){case"identity":this.getValue=this._buildIdentity(t,e);break;case"categorical":this.getValue=this._buildCategorical(t,e);break;default:this.getValue=i?this._buildInterpolate(t,e):this._buildInterval(t,e)}else this.getValue=this._buildIdentity(t,e);else r?this.getValue=i?this._buildZoomInterpolate(t):this._buildZoomInterval(t):(t=this._validate(t,e),this.getValue=this._buildSimple(t))}_validate(e,t){if("number"===t.type){if(e<t.minimum)return t.minimum;if(e>t.maximum)return t.maximum}else"color"===t.type?e=Ee._parseColor(e):"enum"===t.type?"string"==typeof e&&(e=t.values.indexOf(e)):"array"===t.type&&"enum"===t.value?e=e.map(i=>"string"==typeof e?t.values.indexOf(i):i):"string"===t.type&&(e=A(e));return e}_buildSimple(e){return()=>e}_buildExpression(e,t){return(i,r)=>{try{const a=e.evaluate(r,i);return void 0===a?t.default:this._validate(a,t)}catch(a){return console.log(a.message),t.default}}}_buildIdentity(e,t){return(i,r)=>{let a;return r&&(a=r.values[e.property]),void 0!==a?this._validate(a,t):void 0!==e.default?e.default:t.default}}_buildCategorical(e,t){return(i,r)=>{let a;return r&&(a=r.values[e.property]),a=this._categorical(a,e.stops),void 0!==a?a:void 0!==e.default?e.default:t.default}}_buildInterval(e,t){return(i,r)=>{let a;return r&&(a=r.values[e.property]),"number"==typeof a?this._interval(a,e.stops):void 0!==e.default?e.default:t.default}}_buildInterpolate(e,t){return(i,r)=>{let a;return r&&(a=r.values[e.property]),"number"==typeof a?this._interpolate(a,e.stops,e.base||1):void 0!==e.default?e.default:t.default}}_buildZoomInterpolate(e){return t=>this._interpolate(t,e.stops,e.base||1)}_buildZoomInterval(e){return t=>this._interval(t,e.stops)}_categorical(e,t){const i=t.length;for(let r=0;r<i;r++)if(t[r][0]===e)return t[r][1]}_interval(e,t){const i=t.length;let r=0;for(let a=0;a<i&&t[a][0]<=e;a++)r=a;return t[r][1]}_interpolate(e,t,i){let r,a;const n=t.length;for(let s=0;s<n;s++){const i=t[s];if(!(i[0]<=e)){a=i;break}r=i}if(r&&a){const t=a[0]-r[0],n=e-r[0],s=1===i?n/t:(i**n-1)/(i**t-1);if(Array.isArray(r[1])){const e=r[1],t=a[1],i=[];for(let r=0;r<e.length;r++)i.push(Object(E["e"])(e[r],t[r],s));return i}return Object(E["e"])(r[1],a[1],s)}return r?r[1]:a?a[1]:void 0}static _isEmpty(e){for(const t in e)if(e.hasOwnProperty(t))return!1;return!0}static _parseColor(e){return Array.isArray(e)?e:("string"==typeof e&&(e=new b["a"](e)),e instanceof b["a"]?this._isEmpty(e)?void 0:b["a"].toUnitRGBA(e):e)}}var De=Ee,Ie=i("8c81");class Le{constructor(e,t,i,r){switch(this.type=e,this.typeName=t.type,this.id=t.id,this.source=t.source,this.sourceLayer=t["source-layer"],this.minzoom=t.minzoom,this.maxzoom=t.maxzoom,this.filter=t.filter,this.layout=t.layout,this.paint=t.paint,this.z=i,this.uid=r,e){case 0:this._layoutDefinition=Me.backgroundLayoutDefinition,this._paintDefinition=Me.backgroundPaintDefinition;break;case 1:this._layoutDefinition=Me.fillLayoutDefinition,this._paintDefinition=Me.fillPaintDefinition;break;case 2:this._layoutDefinition=Me.lineLayoutDefinition,this._paintDefinition=Me.linePaintDefinition;break;case 3:this._layoutDefinition=Me.symbolLayoutDefinition,this._paintDefinition=Me.symbolPaintDefinition;break;case 4:this._layoutDefinition=Me.circleLayoutDefinition,this._paintDefinition=Me.circlePaintDefinition}this._layoutProperties=this._parseLayout(this.layout),this._paintProperties=this._parsePaint(this.paint)}getFeatureFilter(){return void 0!==this._featureFilter?this._featureFilter:this._featureFilter=Re.createFilter(this.filter)}getLayoutProperty(e){return this._layoutProperties[e]}getPaintProperty(e){return this._paintProperties[e]}getLayoutValue(e,t,i){let r;const a=this._layoutProperties[e];return a&&(r=a.getValue(t,i)),void 0===r&&(r=this._layoutDefinition[e].default),r}getPaintValue(e,t,i){let r;const a=this._paintProperties[e];return a&&(r=a.getValue(t,i)),void 0===r&&(r=this._paintDefinition[e].default),r}isPainterDataDriven(){const e=this._paintProperties;if(e)for(const t in e)if(e[t].isDataDriven)return!0;return!1}_parseLayout(e){const t={};for(const i in e){const r=this._layoutDefinition[i];r&&(t[i]=new De(r,e[i]))}return t}_parsePaint(e){const t={};for(const i in e){const r=this._paintDefinition[i];r&&(t[i]=new De(r,e[i]))}return t}computeAttributesKey(e,t){let i=0,r=0;for(const a of t){const e="icon-size"===a||"text-size"===a?this.getLayoutProperty(a):this.getPaintProperty(a);r|=(null!=e&&e.interpolator?2:null!=e&&e.isDataDriven?1:0)<<i,i+=2}return r<<3|e}}class Ve extends Le{constructor(e,t,i,r){super(e,t,i,r),this.backgroundMaterial=new o(this.computeAttributesKey(0,o.ATTRIBUTES))}}class ke extends Le{constructor(e,t,i,r){super(e,t,i,r);const a=this.getPaintProperty("fill-color"),n=this.getPaintProperty("fill-opacity"),s=this.getPaintProperty("fill-pattern");this.hasDataDrivenColor=null==a?void 0:a.isDataDriven,this.hasDataDrivenOpacity=null==n?void 0:n.isDataDriven,this.hasDataDrivenFill=this.hasDataDrivenColor||this.hasDataDrivenOpacity||(null==s?void 0:s.isDataDriven);const o=this.getPaintProperty("fill-outline-color");this.outlineUsesFillColor=!o,this.hasDataDrivenOutlineColor=null==o?void 0:o.isDataDriven,this.hasDataDrivenOutline=o?o.isDataDriven:!!a&&a.isDataDriven,this.hasDataDrivenOutline=(o?this.hasDataDrivenOutlineColor:this.hasDataDrivenColor)||this.hasDataDrivenOpacity,this.fillMaterial=new l(this.computeAttributesKey(1,l.ATTRIBUTES)),this.outlineMaterial=new h(this.computeAttributesKey(2,this.outlineUsesFillColor?h.ATTRIBUTES_FILL:h.ATTRIBUTES_OUTLINE),this.outlineUsesFillColor)}}class Fe extends Le{constructor(e,t,i,r){var a,n,s,o,c,l,h;super(e,t,i,r),this.lineMaterial=new d(this.computeAttributesKey(3,d.ATTRIBUTES)),this.hasDataDrivenLine=(null==(a=this.getPaintProperty("line-blur"))?void 0:a.isDataDriven)||(null==(n=this.getPaintProperty("line-color"))?void 0:n.isDataDriven)||(null==(s=this.getPaintProperty("line-gap-width"))?void 0:s.isDataDriven)||(null==(o=this.getPaintProperty("line-offset"))?void 0:o.isDataDriven)||(null==(c=this.getPaintProperty("line-opacity"))?void 0:c.isDataDriven)||(null==(l=this.getPaintProperty("line-pattern"))?void 0:l.isDataDriven)||(null==(h=this.getPaintProperty("line-width"))?void 0:h.isDataDriven);let u=t.paint["line-width"];u||(u=Me.linePaintDefinition["line-width"].default);const p=this.getPaintProperty("line-width");this.isThinLine=!(null!=p&&p.isDataDriven)&&"number"==typeof u&&u<Ie["D"]}}class ze extends Le{constructor(e,t,i,r){var a,n,s,o,c,l,h,d,u,p,b,g;super(e,t,i,r),this.iconMaterial=new f(this.computeAttributesKey(4,f.ATTRIBUTES)),this.textMaterial=new m(this.computeAttributesKey(6,m.ATTRIBUTES)),this.hasDataDrivenIcon=(null==(a=this.getPaintProperty("icon-color"))?void 0:a.isDataDriven)||(null==(n=this.getPaintProperty("icon-halo-blur"))?void 0:n.isDataDriven)||(null==(s=this.getPaintProperty("icon-halo-color"))?void 0:s.isDataDriven)||(null==(o=this.getPaintProperty("icon-halo-width"))?void 0:o.isDataDriven)||(null==(c=this.getPaintProperty("icon-opacity"))?void 0:c.isDataDriven)||(null==(l=this.getLayoutProperty("icon-size"))?void 0:l.isDataDriven),this.hasDataDrivenText=(null==(h=this.getPaintProperty("text-color"))?void 0:h.isDataDriven)||(null==(d=this.getPaintProperty("text-halo-blur"))?void 0:d.isDataDriven)||(null==(u=this.getPaintProperty("text-halo-color"))?void 0:u.isDataDriven)||(null==(p=this.getPaintProperty("text-halo-width"))?void 0:p.isDataDriven)||(null==(b=this.getPaintProperty("text-opacity"))?void 0:b.isDataDriven)||(null==(g=this.getLayoutProperty("text-size"))?void 0:g.isDataDriven)}}class Ue extends Le{constructor(e,t,i,r){super(e,t,i,r),this.circleMaterial=new c(this.computeAttributesKey(5,c.ATTRIBUTES))}}class Ge{constructor(e,t,i){var r,a,n,s,o;let c;this.allowOverlap=e.getLayoutValue("icon-allow-overlap",t),this.ignorePlacement=e.getLayoutValue("icon-ignore-placement",t),this.keepUpright=e.getLayoutValue("icon-keep-upright",t),this.optional=e.getLayoutValue("icon-optional",t),this.rotationAlignment=e.getLayoutValue("icon-rotation-alignment",t),2===this.rotationAlignment&&(this.rotationAlignment=i?0:1),c=e.getLayoutProperty("icon-anchor"),null!=(r=c)&&r.isDataDriven?this._anchorProp=c:this.anchor=e.getLayoutValue("icon-anchor",t),c=e.getLayoutProperty("icon-offset"),null!=(a=c)&&a.isDataDriven?this._offsetProp=c:this.offset=e.getLayoutValue("icon-offset",t),c=e.getLayoutProperty("icon-padding"),null!=(n=c)&&n.isDataDriven?this._paddingProp=c:this.padding=e.getLayoutValue("icon-padding",t),c=e.getLayoutProperty("icon-rotate"),null!=(s=c)&&s.isDataDriven?this._rotateProp=c:this.rotate=e.getLayoutValue("icon-rotate",t),c=e.getLayoutProperty("icon-size"),null!=(o=c)&&o.isDataDriven?this._sizeProp=c:this.size=e.getLayoutValue("icon-size",t)}update(e,t){this._anchorProp&&(this.anchor=this._anchorProp.getValue(e,t)),this._offsetProp&&(this.offset=this._offsetProp.getValue(e,t)),this._paddingProp&&(this.padding=this._paddingProp.getValue(e,t)),this._rotateProp&&(this.rotate=this._rotateProp.getValue(e,t)),this._sizeProp&&(this.size=this._sizeProp.getValue(e,t))}}class Be{constructor(e,t,i){var r,a,n,s,o,c,l,h,d,u,p;let f;this.allowOverlap=e.getLayoutValue("text-allow-overlap",t),this.ignorePlacement=e.getLayoutValue("text-ignore-placement",t),this.keepUpright=e.getLayoutValue("text-keep-upright",t),this.optional=e.getLayoutValue("text-optional",t),this.rotationAlignment=e.getLayoutValue("text-rotation-alignment",t),2===this.rotationAlignment&&(this.rotationAlignment=i?0:1),f=e.getLayoutProperty("text-anchor"),null!=(r=f)&&r.isDataDriven?this._anchorProp=f:this.anchor=e.getLayoutValue("text-anchor",t),f=e.getLayoutProperty("text-justify"),null!=(a=f)&&a.isDataDriven?this._justifyProp=f:this.justify=e.getLayoutValue("text-justify",t),f=e.getLayoutProperty("text-letter-spacing"),null!=(n=f)&&n.isDataDriven?this._letterSpacingProp=f:this.letterSpacing=e.getLayoutValue("text-letter-spacing",t),f=e.getLayoutProperty("text-line-height"),null!=(s=f)&&s.isDataDriven?this._lineHeightProp=f:this.lineHeight=e.getLayoutValue("text-line-height",t),f=e.getLayoutProperty("text-max-angle"),null!=(o=f)&&o.isDataDriven?this._maxAngleProp=f:this.maxAngle=e.getLayoutValue("text-max-angle",t),f=e.getLayoutProperty("text-max-width"),null!=(c=f)&&c.isDataDriven?this._maxWidthProp=f:this.maxWidth=e.getLayoutValue("text-max-width",t),f=e.getLayoutProperty("text-offset"),null!=(l=f)&&l.isDataDriven?this._offsetProp=f:this.offset=e.getLayoutValue("text-offset",t),f=e.getLayoutProperty("text-padding"),null!=(h=f)&&h.isDataDriven?this._paddingProp=f:this.padding=e.getLayoutValue("text-padding",t),f=e.getLayoutProperty("text-rotate"),null!=(d=f)&&d.isDataDriven?this._rotateProp=f:this.rotate=e.getLayoutValue("text-rotate",t),f=e.getLayoutProperty("text-size"),null!=(u=f)&&u.isDataDriven?this._sizeProp=f:this.size=e.getLayoutValue("text-size",t),f=e.getLayoutProperty("text-writing-mode"),null!=(p=f)&&p.isDataDriven?this._writingModeProp=f:this.writingMode=e.getLayoutValue("text-writing-mode",t)}update(e,t){this._anchorProp&&(this.anchor=this._anchorProp.getValue(e,t)),this._justifyProp&&(this.justify=this._justifyProp.getValue(e,t)),this._letterSpacingProp&&(this.letterSpacing=this._letterSpacingProp.getValue(e,t)),this._lineHeightProp&&(this.lineHeight=this._lineHeightProp.getValue(e,t)),this._maxAngleProp&&(this.maxAngle=this._maxAngleProp.getValue(e,t)),this._maxWidthProp&&(this.maxWidth=this._maxWidthProp.getValue(e,t)),this._offsetProp&&(this.offset=this._offsetProp.getValue(e,t)),this._paddingProp&&(this.padding=this._paddingProp.getValue(e,t)),this._rotateProp&&(this.rotate=this._rotateProp.getValue(e,t)),this._sizeProp&&(this.size=this._sizeProp.getValue(e,t)),this._writingModeProp&&(this.writingMode=this._writingModeProp.getValue(e,t))}}},"22f5":function(e,t,i){"use strict";i.d(t,"a",(function(){return g})),i.d(t,"b",(function(){return x}));var r=i("b2b2"),a=i("e92d"),n=i("ce50"),s=i("f4cc"),o=i("2eab"),c=i("792b"),l=i("0b2d"),h=i("549a"),d=i("4261"),u=i("2db0"),p=i("0278"),f=i("dbad"),m=i("1e2c");const b=a["a"].getLogger("esri.views.3d.layers.graphics.objectResourceUtils");async function g(e,t){const i=await v(e,t);return{resource:i,textures:await w(i.textureDefinitions,t)}}async function v(e,t){const i=Object(r["k"])(t)&&t.streamDataRequester;if(i)return y(e,i,t);const a=await Object(c["d"])(Object(o["default"])(e,Object(r["t"])(t)));if(!0===a.ok)return a.value.data;Object(s["v"])(a.error),O(a.error)}async function y(e,t,i){const r=await Object(c["d"])(t.request(e,"json",i));if(!0===r.ok)return r.value;Object(s["v"])(r.error),O(r.error.details.url)}function O(e){throw new n["a"]("","Request for object resource failed: "+e)}function _(e){const t=e.params,i=t.topology;let r=!0;switch(t.vertexAttributes||(b.warn("Geometry must specify vertex attributes"),r=!1),t.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{const e=t.faces;if(e){if(t.vertexAttributes)for(const i in t.vertexAttributes){const t=e[i];t&&t.values?(null!=t.valueType&&"UInt32"!==t.valueType&&(b.warn(`Unsupported indexed geometry indices type '${t.valueType}', only UInt32 is currently supported`),r=!1),null!=t.valuesPerElement&&1!==t.valuesPerElement&&(b.warn(`Unsupported indexed geometry values per element '${t.valuesPerElement}', only 1 is currently supported`),r=!1)):(b.warn(`Indexed geometry does not specify face indices for '${i}' attribute`),r=!1)}}else b.warn("Indexed geometries must specify faces"),r=!1;break}default:b.warn(`Unsupported topology '${i}'`),r=!1}e.params.material||(b.warn("Geometry requires material"),r=!1);const a=e.params.vertexAttributes;for(const n in a)a[n].values||(b.warn("Geometries with externally defined attributes are not yet supported"),r=!1);return r}function x(e,t){const i=[],a=[],n=[],s=[],o=e.resource,c=h["a"].parse(o.version||"1.0","wosr");T.validate(c);const d=o.model.name,u=o.model.geometries,b=o.materialDefinitions,g=e.textures;let v=0;const y=new Map;for(let h=0;h<u.length;h++){const e=u[h];if(!_(e))continue;const o=C(e),c=e.params.vertexAttributes,d=[];for(const t in c){const e=c[t],i=e.values;d.push([t,{data:i,size:e.valuesPerElement,exclusive:!0}])}const O=[];if("PerAttributeArray"!==e.params.topology){const t=e.params.faces;for(const e in t)O.push([e,new Uint32Array(t[e].values)])}const x=g&&g[o.texture];if(x&&!y.has(o.texture)){const{image:e,params:t}=x,i=new m["a"](e,t);s.push(i),y.set(o.texture,i)}const j=y.get(o.texture),w=j?j.id:void 0;let T=n[o.material]?n[o.material][o.texture]:null;if(!T){const e=b[o.material.substring(o.material.lastIndexOf("/")+1)].params;1===e.transparency&&(e.transparency=0);const i=x&&x.alphaChannelUsage,a=e.transparency>0||"transparency"===i||"maskAndTransparency"===i,s={ambient:Object(l["f"])(e.diffuse),diffuse:Object(l["f"])(e.diffuse),opacity:1-(e.transparency||0),transparent:a,textureAlphaMode:x?S(x.alphaChannelUsage):void 0,textureAlphaCutoff:.33,textureId:w,initTextureTransparent:!0,doubleSided:!0,cullFace:0,colorMixMode:e.externalColorMixMode||"tint",textureAlphaPremultiplied:!0};Object(r["k"])(t)&&t.materialParamsMixin&&Object.assign(s,t.materialParamsMixin),T=new f["b"](s),n[o.material]||(n[o.material]={}),n[o.material][o.texture]=T}a.push(T);const P=new p["a"](d,O);v+=O.position?O.position.length:0,i.push(P)}return{name:d,stageResources:{textures:s,materials:a,geometries:i},pivotOffset:o.model.pivotOffset,boundingBox:j(i),numberOfVertices:v,lodThreshold:null}}function j(e){const t=Object(d["k"])();return e.forEach(e=>{const i=e.boundingInfo;Object(r["k"])(i)&&(Object(d["r"])(t,i.getBBMin()),Object(d["r"])(t,i.getBBMax()))}),t}async function w(e,t){const i=[];for(const s in e){const a=e[s],n=a.images[0].data;if(!n){b.warn("Externally referenced texture data is not yet supported");continue}const o=a.encoding+";base64,"+n,c="/textureDefinitions/"+s,l={noUnpackFlip:!0,wrap:{s:10497,t:10497},preMultiplyAlpha:!0},h=Object(r["k"])(t)&&t.disableTextures?Promise.resolve(null):Object(u["a"])(o,t);i.push(h.then(e=>({refId:c,image:e,params:l,alphaChannelUsage:"rgba"===a.channels?a.alphaChannelUsage||"transparency":"none"})))}const a=await Promise.all(i),n={};for(const r of a)n[r.refId]=r;return n}function S(e){switch(e){case"mask":return 2;case"maskAndTransparency":return 3;case"none":return 1;case"transparency":default:return 0}}function C(e){const t=e.params;return{id:1,material:t.material,texture:t.texture,region:t.texture}}const T=new h["a"](1,2,"wosr")},"240c":function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));i("c120");var r=i("b2b2"),a=i("b48e"),n=i("f408");function s(e){var t;if("graphics"!==(null==(t=e.layer)?void 0:t.type))return 1;const i=e.geometry;if(Object(r["j"])(i))return 2;switch(i.type){case"polygon":if(i instanceof a["a"])return 3;break;case"polyline":break;case"point":case"multipoint":case"extent":case"mesh":default:return 3}return"on-the-ground"!==Object(n["e"])(e)&&Object(n["g"])(e)?4:0}},"243f":function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));i("c120");var r=i("b2b2"),a=i("f408");function n(e){var t;if("graphics"!==(null==(t=e.layer)?void 0:t.type))return 1;if(Object(r["j"])(e.geometry))return 2;switch(e.geometry.type){case"polygon":case"point":case"polyline":break;case"multipoint":case"extent":case"mesh":default:return 3}return"on-the-ground"!==Object(a["e"])(e)&&Object(a["g"])(e)?4:0}},2582:function(e,t,i){"use strict";var r=i("f4cc"),a=i("9651"),n=i("ae54");class s{constructor(e){if(e instanceof a["a"])this._tilemapCache=e;else{if(!e||!("index"in e))throw new Error("Invalid tilemap!");this._tilemap=e.index}}dataKey(e,t){if(this._tilemapCache){const{level:i,row:a,col:s}=e,o=new n["a"](e);return this._tilemapCache.fetchAvailabilityUpsample(i,a,s,o,t).then(()=>(o.world=e.world,o)).catch(e=>{if(Object(r["n"])(e))throw e;return null})}return this._getIndexedDataKey(e)}forEach(e,t,i,r,a){this._callback=a,this._maxLevel=t+e,this._forEach(this._tilemap,t,i,r)}_forEach(e,t,i,r){0!==e&&(this._callback(t,i,r),t!==this._maxLevel&&"object"==typeof e&&(this._forEach(e[0],t+1,2*i,2*r),this._forEach(e[1],t+1,2*i,2*r+1),this._forEach(e[2],t+1,2*i+1,2*r),this._forEach(e[3],t+1,2*i+1,2*r+1)))}_getIndexedDataKey(e){const t=[e];if(e.level<0||e.row<0||e.col<0||e.row>>e.level>0||e.col>>e.level>0)return Promise.resolve(null);let i=e;for(;0!==i.level;)i=new n["a"](i.level-1,i.row>>1,i.col>>1,i.world),t.push(i);let r,a,s=this._tilemap,o=t.pop();if(1===s)return Promise.resolve(o);for(;t.length;)if(r=t.pop(),a=(1&r.col)+((1&r.row)<<1),s){if(0===s[a]){o=null;break}if(1===s[a]){o=r;break}o=r,s=s[a]}return Promise.resolve(o)}}t["a"]=s},2650:function(e,t,i){"use strict";i.r(t);var r=i("a4ee"),a=(i("c120"),i("b2b2")),n=(i("e92d"),i("59b2")),s=i("1a3e"),o=i("afcf"),c=i("d386"),l=i("09db"),h=i("ce50"),d=i("e041"),u=(i("8eed"),i("f402"),i("5996")),p=(i("e06a"),i("2eab")),f=i("a6a3"),m=i("e694"),b=i("54b4"),g=i("22f4"),v=i("b911"),y=i("3d59"),O=i("997b"),_=i("8b28"),x=i("0db5"),j=i("8e17"),w=i("5a62"),S=i("9096"),C=i("b485"),T=i("303f"),P=i("e9d0"),A=i("d409");const R=["Canvas/World_Dark_Gray_Base","Canvas/World_Dark_Gray_Reference","Canvas/World_Light_Gray_Base","Canvas/World_Light_Gray_Reference","Elevation/World_Hillshade","Elevation/World_Hillshade_Dark","Ocean/World_Ocean_Base","Ocean/World_Ocean_Reference","Ocean_Basemap","Reference/World_Boundaries_and_Places","Reference/World_Boundaries_and_Places_Alternate","Reference/World_Transportation","World_Imagery","World_Street_Map","World_Topo_Map"];let M=class extends(Object(O["a"])(Object(A["a"])(Object(w["a"])(Object(j["a"])(Object(v["a"])(Object(x["a"])(Object(C["a"])(Object(T["a"])(Object(y["a"])(Object(m["a"])(Object(S["b"])(Object(_["a"])(f["a"]))))))))))))){constructor(...e){super(...e),this.listMode="show",this.isReference=null,this.operationalLayerType="ArcGISTiledMapServiceLayer",this.resampling=!0,this.sourceJSON=null,this.spatialReference=null,this.path=null,this.sublayers=null,this.type="tile",this.url=null}normalizeCtorArgs(e,t){return"string"==typeof e?{url:e,...t}:e}load(e){const t=Object(a["k"])(e)?e.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["Map Service"]},e).then(()=>this._fetchService(t),()=>this._fetchService(t))),Promise.resolve(this)}get attributionDataUrl(){var e;const t=null==(e=this.parsedUrl)?void 0:e.path.toLowerCase();return t&&this._getDefaultAttribution(this._getMapName(t))}readSpatialReference(e,t){return(e=e||t.tileInfo&&t.tileInfo.spatialReference)&&u["a"].fromJSON(e)}writeSublayers(e,t,i,r){if(!this.loaded||!e)return;const a=e.slice().reverse().flatten(({sublayers:e})=>e&&e.toArray().reverse()).toArray(),n=[],s={writeSublayerStructure:!1,...r};a.forEach(e=>{const t=e.write({},s);n.push(t)}),n.some(e=>Object.keys(e).length>1)&&(t.layers=n)}get tileServers(){return this._getDefaultTileServers(this.parsedUrl.path)}castTileServers(e){return Array.isArray(e)?e.map(e=>Object(d["J"])(e).path):null}fetchTile(e,t,i,r={}){const{signal:a,timestamp:n}=r,s=this.getTileUrl(e,t,i),o={responseType:"image",signal:a};return null!=n&&(o.query={_ts:r.timestamp}),Object(p["default"])(s,o).then(e=>e.data)}getTileUrl(e,t,i){const r=!this.tilemapCache&&this.supportsBlankTile,a=Object(d["D"])({...this.parsedUrl.query,blankTile:!r&&null,...this.customParameters}),n=this.tileServers;return`${n&&n.length?n[t%n.length]:this.parsedUrl.path}/tile/${e}/${t}/${i}${a?"?"+a:""}`}_fetchService(e){return new Promise((t,i)=>{if(this.sourceJSON){if(null!=this.sourceJSON.bandCount&&null!=this.sourceJSON.pixelSizeX)throw new h["a"]("tile-layer:unsupported-url","use ImageryTileLayer to open a tiled image service");return void t({data:this.sourceJSON})}if(!this.parsedUrl)throw new h["a"]("tile-layer:undefined-url","layer's url is not defined");const r=Object(b["e"])(this.parsedUrl.path);if(Object(a["k"])(r)&&"ImageServer"===r.serverType)throw new h["a"]("tile-layer:unsupported-url","use ImageryTileLayer to open a tiled image service");Object(p["default"])(this.parsedUrl.path,{query:{f:"json",...this.parsedUrl.query,...this.customParameters},responseType:"json",signal:e}).then(t,i)}).then(t=>{if(t.ssl&&(this.url=this.url.replace(/^http:/i,"https:")),this.sourceJSON=t.data,this.read(t.data,{origin:"service",url:this.parsedUrl}),10.1===this.version&&!Object(b["c"])(this.url))return this._fetchServerVersion(this.url,e).then(e=>{this.read({currentVersion:e})}).catch(()=>{})})}_fetchServerVersion(e,t){if(!Object(b["b"])(e))return Promise.reject();const i=e.replace(/(.*\/rest)\/.*/i,"$1")+"/info";return Object(p["default"])(i,{query:{f:"json",...this.customParameters},responseType:"json",signal:t}).then(e=>{if(e.data&&e.data.currentVersion)return e.data.currentVersion;throw new h["a"]("tile-layer:version-not-available")})}_getMapName(e){const t=e.match(/^(?:https?:)?\/\/(server\.arcgisonline\.com|services\.arcgisonline\.com|ibasemaps-api\.arcgis\.com)\/arcgis\/rest\/services\/([^\/]+(\/[^\/]+)*)\/mapserver/i);return t&&t[2]}_getDefaultAttribution(e){if(!e)return;let t;e=e.toLowerCase();for(let i=0,r=R.length;i<r;i++)if(t=R[i],t.toLowerCase().indexOf(e)>-1)return Object(d["z"])("//static.arcgis.com/attribution/"+t)}_getDefaultTileServers(e){const t=-1!==e.search(/^(?:https?:)?\/\/server\.arcgisonline\.com/i),i=-1!==e.search(/^(?:https?:)?\/\/services\.arcgisonline\.com/i);return t||i?[e,e.replace(t?/server\.arcgisonline/i:/services\.arcgisonline/i,t?"services.arcgisonline":"server.arcgisonline")]:[]}};Object(r["a"])([Object(n["b"])({readOnly:!0})],M.prototype,"attributionDataUrl",null),Object(r["a"])([Object(n["b"])({type:["show","hide","hide-children"]})],M.prototype,"listMode",void 0),Object(r["a"])([Object(n["b"])({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],M.prototype,"isReference",void 0),Object(r["a"])([Object(n["b"])({readOnly:!0,type:["ArcGISTiledMapServiceLayer"]})],M.prototype,"operationalLayerType",void 0),Object(r["a"])([Object(n["b"])({type:Boolean})],M.prototype,"resampling",void 0),Object(r["a"])([Object(n["b"])()],M.prototype,"sourceJSON",void 0),Object(r["a"])([Object(n["b"])({type:u["a"]})],M.prototype,"spatialReference",void 0),Object(r["a"])([Object(o["a"])("spatialReference",["spatialReference","tileInfo"])],M.prototype,"readSpatialReference",null),Object(r["a"])([Object(n["b"])({type:String,json:{origins:{"web-scene":{read:!0,write:!0}},read:!1}})],M.prototype,"path",void 0),Object(r["a"])([Object(n["b"])({readOnly:!0})],M.prototype,"sublayers",void 0),Object(r["a"])([Object(l["a"])("sublayers",{layers:{type:[P["a"]]}})],M.prototype,"writeSublayers",null),Object(r["a"])([Object(n["b"])({json:{read:!1,write:!1}})],M.prototype,"popupEnabled",void 0),Object(r["a"])([Object(n["b"])()],M.prototype,"tileServers",null),Object(r["a"])([Object(s["a"])("tileServers")],M.prototype,"castTileServers",null),Object(r["a"])([Object(n["b"])({readOnly:!0,json:{read:!1}})],M.prototype,"type",void 0),Object(r["a"])([Object(n["b"])(g["n"])],M.prototype,"url",void 0),M=Object(r["a"])([Object(c["a"])("esri.layers.TileLayer")],M);var E=M;t["default"]=E},"27df":function(e,t,i){"use strict";i.d(t,"a",(function(){return p}));var r=i("ce6d"),a=i("6ae9"),n=i("b2b2");class s{constructor(e,t,i){this.editGeometry=e,this.component=t,this.pos=i,this.addedVertex=null,this.originalEdge=null,this.left=null,this.right=null}apply(){let e="redo";if(Object(n["j"])(this.addedVertex)&&(e="apply",this.addedVertex=new a["d"](this.component)),0===this.component.vertices.length)this.component.vertices.push(this.addedVertex),this.addedVertex.pos=this.pos,this.addedVertex.index=0;else{const e=Object(n["t"])(this.component.getLastVertex());let t=null;e.right&&(this.originalEdge=e.right,t=this.originalEdge.right,this.component.edges.splice(this.component.edges.indexOf(this.originalEdge),1)),this.component.vertices.push(this.addedVertex),this.addedVertex.pos=this.pos,Object(n["j"])(this.left)&&(this.left=new a["b"](this.component,e,this.addedVertex)),this.component.edges.push(this.left),e.right=this.left,Object(n["k"])(this.originalEdge)&&Object(n["k"])(t)&&(Object(n["j"])(this.right)&&(this.right=new a["b"](this.component,this.addedVertex,t)),this.component.edges.push(this.right),t.left=this.right),this.component.updateVertexIndex(this.addedVertex,e.index+1)}const t={addedVertices:[this.addedVertex],operation:e};this.editGeometry.emit("change",t)}undo(){if(Object(n["j"])(this.addedVertex))return null;this.component.vertices.splice(this.component.vertices.indexOf(this.addedVertex),1),Object(n["k"])(this.left)&&(this.component.edges.splice(this.component.edges.indexOf(this.left),1),this.left.left.right=null),Object(n["k"])(this.right)&&(this.component.edges.splice(this.component.edges.indexOf(this.right),1),this.right.right.left=null),Object(n["k"])(this.originalEdge)&&(this.component.edges.push(this.originalEdge),this.originalEdge.left.right=this.originalEdge,this.originalEdge.right.left=this.originalEdge),Object(n["k"])(this.left)?this.component.updateVertexIndex(this.left.left,this.left.left.index):this.component.updateVertexIndex(this.addedVertex,0);const e={removedVertices:[this.addedVertex],operation:"undo"};this.editGeometry.emit("change",e)}accumulate(e){return!1}}var o=i("34f2");class c{constructor(e,t,i=0){this.editGeometry=e,this.removedVertices=null,this._minNumberOfVertices=0,this.vertices=t,this._minNumberOfVertices=i}apply(){let e="redo";null==this.removedVertices?(this.removedVertices=[],this.vertices.forEach(e=>{const t=this._removeVertex(e);Object(n["k"])(t)&&this.removedVertices.push(t)}),e="apply"):this.removedVertices.forEach(e=>{this._redoRemoveVertex(e)});const t={removedVertices:this.vertices,operation:e};this.editGeometry.emit("change",t)}undo(){this.removedVertices.forEach(e=>{this._undoRemoveVertex(e)});const e={addedVertices:this.vertices,operation:"undo"};this.editGeometry.emit("change",e)}accumulate(e){return!1}_removeVertex(e){const t=e.component;if(t.vertices.length<=this._minNumberOfVertices)return null;const i={removedVertex:e,createdEdge:null},r=e.left,n=e.right;return t.vertices.splice(t.vertices.indexOf(e),1),r&&(t.edges.splice(t.edges.indexOf(r),1),r.left.right=null),n&&(t.edges.splice(t.edges.indexOf(n),1),n.right.left=null),0===e.index&&n&&this.vertices.length>0&&t.swapVertices(t.vertices.indexOf(n.right),0),r&&n&&(i.createdEdge=new a["b"](t,r.left,n.right),t.edges.push(i.createdEdge)),n&&t.updateVertexIndex(n.right,n.right.index-1),i}_redoRemoveVertex(e){console.warn("redo remove vertex not implemented yet")}_undoRemoveVertex(e){const t=e.removedVertex,i=e.removedVertex.component,r=t.left,a=t.right;e.createdEdge&&i.edges.splice(i.edges.indexOf(e.createdEdge),1),i.vertices.push(t),r&&(i.edges.push(r),r.left.right=r),a&&(i.edges.push(a),a.right.left=a),i.updateVertexIndex(t,t.index)}}class l{constructor(e,t,i){this.editGeometry=e,this.edge=t,this.t=i,this.createdVertex=null,this.left=null,this.right=null}apply(){let e="redo";const t=this.edge,i=t.component,r=t.component.data,s=t.left,o=t.right;i.edges.splice(i.edges.indexOf(t),1),Object(n["j"])(this.createdVertex)&&(e="apply",this.createdVertex=new a["d"](t.component)),i.vertices.push(this.createdVertex),this.createdVertex.pos=r.coordinateHelper.lerp(t.left.pos,t.right.pos,this.t,r.coordinateHelper.createNew()),Object(n["j"])(this.left)&&(this.left=new a["b"](i,s,this.createdVertex)),this.left.left.left?i.edges.push(this.left):i.edges.unshift(this.left),s.right=this.left,Object(n["j"])(this.right)&&(this.right=new a["b"](i,this.createdVertex,o)),i.edges.push(this.right),o.left=this.right,i.updateVertexIndex(this.createdVertex,s.index+1);const c={addedVertices:[this.createdVertex],operation:e};this.editGeometry.emit("change",c)}undo(){if(Object(n["j"])(this.createdVertex)||Object(n["j"])(this.left)||Object(n["j"])(this.right))return null;const e=this.edge,t=e.component,i=this.createdVertex.left,r=this.createdVertex.right,a=i.left,s=r.right;t.vertices.splice(t.vertices.indexOf(this.createdVertex),1),t.edges.splice(t.edges.indexOf(this.left),1),t.edges.splice(t.edges.indexOf(this.right),1),this.edge.left.left?t.edges.push(this.edge):t.edges.unshift(this.edge),a.right=e,s.left=e,t.updateVertexIndex(a,a.index);const o={removedVertices:[this.createdVertex],operation:"undo"};this.editGeometry.emit("change",o)}accumulate(e){return!1}}var h=i("157c"),d=i("e1e0"),u=i("fbd0");class p extends r["a"]{constructor(e,t){super(),this.editGeometry=e,this.type=t,this._geometry=null,this._dirty=!0,this._listener=this.editGeometry.on("change",e=>{e.addedVertices&&this.emit("vertex-add",{type:"vertex-add",vertices:e.addedVertices,operation:e.operation}),e.removedVertices&&this.emit("vertex-remove",{type:"vertex-remove",vertices:e.removedVertices,operation:e.operation}),e.updatedVertices&&this.emit("vertex-update",{type:"vertex-update",vertices:e.updatedVertices,operation:e.operation}),this._dirty=!0})}destroy(){this._listener.remove()}splitEdge(e,t){const i=new l(this.editGeometry,e,t);return this.editGeometry.apply(i),i}updateVertices(e,t,i=1){const r=new o["b"](this.editGeometry,e,t);return this.editGeometry.apply(r,i),r}moveVertices(e,t,i,r,a=1){return this.updateVertices(e,new h["a"](this.editGeometry.coordinateHelper,t,i,r),a)}scaleVertices(e,t,i,r,a,n=1,s=0){return this.updateVertices(e,new u["a"](this.editGeometry.coordinateHelper,t,i,r,a,s),n)}rotateVertices(e,t,i,r=1,a=0){return this.updateVertices(e,new d["a"](this.editGeometry.coordinateHelper,t,i,a),r)}removeVertices(e){let t=0;switch(this.type){case"point":t=1;break;case"polyline":t=2;break;case"polygon":t=3}const i=new c(this.editGeometry,e,t);return this.editGeometry.apply(i),i}appendVertex(e){if(0===this.editGeometry.components.length)return null;const t=new s(this.editGeometry,this.editGeometry.components[0],e);return this.editGeometry.apply(t),t}canRemoveVertex(){let e=0;switch(this.type){case"point":e=1;break;case"polyline":e=2;break;case"polygon":e=3}return this.editGeometry.components[0].vertices.length>e}undo(){return this.editGeometry.undo()}get canUndo(){return this.editGeometry.canUndo}redo(){return this.editGeometry.redo()}get canRedo(){return this.editGeometry.canRedo}get geometry(){if(this._dirty){switch(this.type){case"point":this._geometry=this.editGeometry.toPoint();break;case"polyline":this._geometry=this.editGeometry.toPolyline();break;case"polygon":this._geometry=this.editGeometry.toPolygon()}this._dirty=!1}return this._geometry}}},"2aa2":function(e,t,i){"use strict";i.d(t,"a",(function(){return r})),i.d(t,"b",(function(){return a}));const r=(()=>{const e=new Array;return e[0]=10,e[1]=10,e[2]=10,e[3]=10,e[4]=5,e})(),a=30},"2aad":function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i("3886");function a(e){e.attributes.add("position","vec2"),e.varyings.add("uv","vec2"),e.vertex.code.add(r["a"]`
    void main(void) {
      gl_Position = vec4(position, 0.0, 1.0);
      uv = position * 0.5 + vec2(0.5);
    }
  `)}},"2b60":function(e,t,i){"use strict";i.d(t,"a",(function(){return l}));var r=i("b2b2"),a=i("ce50"),n=i("e041"),s=i("f4cc"),o=i("2eab"),c=i("792b");class l{constructor(e){this.streamDataRequester=e}async loadJSON(e,t){return this.load("json",e,t)}async loadBinary(e,t){return Object(n["u"])(e)?(Object(s["w"])(t),Object(n["j"])(e)):this.load("binary",e,t)}async loadImage(e,t){return this.load("image",e,t)}async load(e,t,i){if(Object(r["j"])(this.streamDataRequester))return(await Object(o["default"])(t,{responseType:h[e]})).data;const n=await Object(c["d"])(this.streamDataRequester.request(t,e,i));if(!0===n.ok)return n.value;throw Object(s["v"])(n.error),new a["a"]("","Request for resource failed: "+n.error)}}const h={image:"image",binary:"array-buffer",json:"json"}},"2bc9":function(e,t,i){"use strict";i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return n})),i.d(t,"c",(function(){return a})),i.d(t,"d",(function(){return o}));var r=i("0b2d");class a{constructor(e=Object(r["e"])(),t=Object(r["g"])(.57735,.57735,.57735),i=!0){this.intensity=e,this.direction=t,this.castShadows=i}}class n{constructor(e=Object(r["e"])(),t=Object(r["g"])(.57735,.57735,.57735)){this.intensity=Object(r["e"])(),this.direction=Object(r["e"])(),this.intensity=e,this.direction=t}}class s{constructor(e=Object(r["e"])()){this.intensity=e}}class o{constructor(){this.sh={r:[0],g:[0],b:[0]}}}},"2df1":function(e,t,i){"use strict";i.d(t,"a",(function(){return Q}));var r=i("b2b2"),a=i("38a4"),n=i("a915"),s=i("0b2d"),o=i("e431"),c=i("d791"),l=i("9180"),h=i("dae5"),d=i("afe1"),u=i("02f1"),p=i("1c92"),f=i("3349"),m=i("fc00"),b=i("1153"),g=i("1038"),v=i("b623"),y=i("da1c");function O(e){return e instanceof Float32Array&&e.length>=16}function _(e){return Array.isArray(e)&&e.length>=16}function x(e){return O(e)||_(e)}var j=i("68af"),w=i("7c51"),S=i("35b3"),C=i("5957"),T=i("0d96"),P=i("a4ee"),A=i("c3a4"),R=i("ca98"),M=i("da35"),E=i("fa1e"),D=i("8e37"),I=i("189c"),L=i("8e97"),V=i("d272"),k=i("2f98"),F=i("d0cb"),z=i("9617"),U=i("7079"),G=i("6a07"),B=i("be24"),H=i("17b0"),N=i("7438");class q extends R["a"]{initializeProgram(e){const t=q.shader.get(),i=this.configuration,r=t.build({output:i.output,FrontFacePass:2===i.transparencyPassType,viewingMode:e.viewingMode,occlusionTestEnabled:i.occlusionTestEnabled,signedDistanceFieldEnabled:i.sdf,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!0,debugDrawBorder:i.debugDrawBorder,binaryHighlightOcclusionEnabled:i.binaryHighlightOcclusion,screenCenterOffsetUnitsEnabled:i.screenCenterOffsetUnitsEnabled,screenSizePerspectiveEnabled:i.screenSizePerspective,verticalOffsetEnabled:i.verticalOffset,pixelSnappingEnabled:i.pixelSnappingEnabled,vvSize:i.vvSize,vvColor:i.vvColor,vvInstancingEnabled:!1,isDraped:i.isDraped,multipassGeometryEnabled:i.multipassGeometryEnabled});return new D["a"](e.rctx,r.generateSource("vertex"),r.generateSource("fragment"),E["a"])}bindPass(e,t,i){L["a"].bindProjectionMatrix(this.program,i.camera.projectionMatrix),this.program.setUniform1f("cameraGroundRelative",i.camera.aboveGround?1:-1),this.program.setUniform1f("perDistancePixelRatio",Math.tan(i.camera.fovY/2)/(i.camera.fullViewport[2]/2)),this.program.setUniformMatrix4fv("viewNormal",i.camera.viewInverseTransposeMatrix),this.program.setUniform1f("polygonOffset",t.shaderPolygonOffset),H["a"].bindUniforms(this.program,t,i),k["a"].bindUniforms(this.program,t),this.program.setUniform1f("pixelRatio",i.camera.pixelRatio||1),L["a"].bindViewport(this.program,i),6===this.configuration.output?(U["a"].bindUniforms(this.program),this.program.setUniform2fv("cameraNearFar",i.camera.nearFar),this.program.setUniform2fv("inverseViewport",i.inverseViewport),Object(z["a"])(this.program,e,i)):(F["a"].bindUniforms(this.program,i),T["a"].bindUniforms(this.program,t,i.camera.pixelRatio||1),B["a"].bindUniforms(this.program,t),this.configuration.occlusionTestEnabled&&F["a"].bindVisibilityTexture(e,this.program,i)),4===this.configuration.output&&G["a"].bindOutputHighlight(e,this.program,i)}bindDraw(e){L["a"].bindView(this.program,e),L["a"].bindCamPosition(this.program,e.origin,e.camera.viewInverseTransposeMatrix),V["a"].bindUniformsWithOrigin(this.program,this.configuration,e)}setPipelineState(e){const t=this.configuration,i=3===e,r=2===e,a=515,n=this.configuration.polygonOffsetEnabled&&W,s=(i||r)&&4!==t.output?(t.depthEnabled||6===t.output)&&I["d"]:null;return Object(I["e"])({blending:0===t.output||7===t.output||4===t.output?i?Z:Object(N["a"])(e):null,depthTest:{func:a},depthWrite:s,colorWrite:I["c"],polygonOffset:n})}initializePipeline(){return this.setPipelineState(this.configuration.transparencyPassType)}get primitiveType(){return 6===this.configuration.output?0:4}}q.shader=new A["a"](T["b"],()=>i.e("chunk-2d0db7d8").then(i.bind(null,"6fa3")));const W={factor:0,units:-4},Z=Object(I["g"])(1,771);class $ extends M["a"]{constructor(){super(...arguments),this.output=0,this.occlusionTestEnabled=!0,this.sdf=!1,this.vvSize=!1,this.vvColor=!1,this.verticalOffset=!1,this.screenSizePerspective=!1,this.screenCenterOffsetUnitsEnabled=0,this.debugDrawBorder=!0,this.binaryHighlightOcclusion=!0,this.slicePlaneEnabled=!1,this.polygonOffsetEnabled=!1,this.depthEnabled=!0,this.transparencyPassType=3,this.pixelSnappingEnabled=!0,this.isDraped=!1,this.multipassGeometryEnabled=!1}}Object(P["a"])([Object(M["b"])({count:8})],$.prototype,"output",void 0),Object(P["a"])([Object(M["b"])()],$.prototype,"occlusionTestEnabled",void 0),Object(P["a"])([Object(M["b"])()],$.prototype,"sdf",void 0),Object(P["a"])([Object(M["b"])()],$.prototype,"vvSize",void 0),Object(P["a"])([Object(M["b"])()],$.prototype,"vvColor",void 0),Object(P["a"])([Object(M["b"])()],$.prototype,"verticalOffset",void 0),Object(P["a"])([Object(M["b"])()],$.prototype,"screenSizePerspective",void 0),Object(P["a"])([Object(M["b"])({count:2})],$.prototype,"screenCenterOffsetUnitsEnabled",void 0),Object(P["a"])([Object(M["b"])()],$.prototype,"debugDrawBorder",void 0),Object(P["a"])([Object(M["b"])()],$.prototype,"binaryHighlightOcclusion",void 0),Object(P["a"])([Object(M["b"])()],$.prototype,"slicePlaneEnabled",void 0),Object(P["a"])([Object(M["b"])()],$.prototype,"polygonOffsetEnabled",void 0),Object(P["a"])([Object(M["b"])()],$.prototype,"depthEnabled",void 0),Object(P["a"])([Object(M["b"])({count:4})],$.prototype,"transparencyPassType",void 0),Object(P["a"])([Object(M["b"])()],$.prototype,"pixelSnappingEnabled",void 0),Object(P["a"])([Object(M["b"])()],$.prototype,"isDraped",void 0),Object(P["a"])([Object(M["b"])()],$.prototype,"multipassGeometryEnabled",void 0);class Q extends S["a"]{constructor(e){super(e,ye),this.techniqueConfig=new $}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.verticalOffset=!!this.params.verticalOffset,this.techniqueConfig.screenSizePerspective=!!this.params.screenSizePerspective,this.techniqueConfig.screenCenterOffsetUnitsEnabled="screen"===this.params.centerOffsetUnits?1:0,this.techniqueConfig.polygonOffsetEnabled=this.params.polygonOffset,this.techniqueConfig.isDraped=this.params.isDraped,this.techniqueConfig.occlusionTestEnabled=this.params.occlusionTest,this.techniqueConfig.pixelSnappingEnabled=this.params.pixelSnappingEnabled,this.techniqueConfig.sdf=this.params.textureIsSignedDistanceField,this.techniqueConfig.vvSize=!!this.params.vvSizeEnabled,this.techniqueConfig.vvColor=!!this.params.vvColorEnabled,0===e&&(this.techniqueConfig.debugDrawBorder=!!this.params.debugDrawBorder),4===e&&(this.techniqueConfig.binaryHighlightOcclusion=this.params.binaryHighlightOcclusion),this.techniqueConfig.depthEnabled=this.params.depthEnabled,this.techniqueConfig.transparencyPassType=t?t.transparencyPassType:3,this.techniqueConfig.multipassGeometryEnabled=!!t&&t.multipassGeometryEnabled,this.techniqueConfig}intersect(e,t,i,r,a,n,s,o,c){c?this.intersectDrapedHudGeometry(e,n,s,o):this.intersectHudGeometry(e,t,i,r,s,o)}intersectDrapedHudGeometry(e,t,i,a){const n=e.vertexAttributes.get("position"),s=e.vertexAttributes.get("size"),o=this.params,c=Object(T["d"])(o);let l=1,h=1;if(Object(r["k"])(a)){const e=a(fe);l=e[0],h=e[5]}l*=e.screenToWorldRatio,h*=e.screenToWorldRatio;const d=be*e.screenToWorldRatio;for(let r=0;r<n.data.length/n.size;r++){const a=r*n.size,u=n.data[a],p=n.data[a+1],f=r*s.size;let m;ge[0]=s.data[f]*l,ge[1]=s.data[f+1]*h,o.textureIsSignedDistanceField&&(m=o.outlineSize*e.screenToWorldRatio/2),te(t,u,p,ge,d,m,o,c)&&i()}}intersectHudGeometry(e,t,i,a,n,l){if(!a.options.selectionMode||!a.options.hud)return;if(Object(v["e"])(t))return;const h=this.params;let d=1,u=1;if(Object(p["f"])(le,i),Object(r["k"])(l)){const e=l(fe);d=e[0],u=e[5],ee(le)}const f=e.vertexAttributes.get("position"),m=e.vertexAttributes.get("size"),g=e.vertexAttributes.get("normal"),O=e.vertexAttributes.get("auxpos1");Object(b["a"])(f.size>=3);const _=a.point,x=a.camera,j=Object(T["d"])(h);d*=x.pixelRatio,u*=x.pixelRatio;const w="screen"===this.params.centerOffsetUnits;for(let r=0;r<f.data.length/f.size;r++){const e=r*f.size;Object(o["x"])(ae,f.data[e],f.data[e+1],f.data[e+2]),Object(o["n"])(ae,ae,i);const t=r*m.size;ge[0]=m.data[t]*d,ge[1]=m.data[t+1]*u,Object(o["n"])(ae,ae,x.viewMatrix);const l=r*O.size;if(Object(o["x"])(ue,O.data[l+0],O.data[l+1],O.data[l+2]),!w&&(ae[0]+=ue[0],ae[1]+=ue[1],0!==ue[2])){const e=ue[2];Object(o["s"])(ue,ae),Object(o["k"])(ae,ae,Object(o["f"])(ue,ue,e))}const p=r*g.size;if(Object(o["x"])(ne,g.data[p],g.data[p+1],g.data[p+2]),this.normalAndViewAngle(ne,le,x,pe),this.applyVerticalOffsetTransformationView(ae,pe,x,ie),x.applyProjection(ae,se),se[0]>-1){let e=Math.floor(se[0])+this.params.screenOffset[0],t=Math.floor(se[1])+this.params.screenOffset[1];w&&(e+=ue[0],0!==ue[1]&&(t+=Object(y["b"])(ue[1],ie.factorAlignment))),Object(y["a"])(ge,ie.factor,ge);const i=me*x.pixelRatio;let r;if(h.textureIsSignedDistanceField&&(r=h.outlineSize*x.pixelRatio/2),te(_,e,t,ge,i,r,h,j)){const e=a.ray;if(Object(o["n"])(ce,ae,Object(c["a"])(de,x.viewMatrix)),se[0]=_[0],se[1]=_[1],x.unprojectFromRenderScreen(se,ae)){const t=Object(s["e"])();Object(o["l"])(t,e.direction);const i=1/Object(o["q"])(t);Object(o["f"])(t,t,i),n(Object(o["p"])(e.origin,ae)*i,t,-1,1,!0,ce)}}}}}computeAttachmentOrigin(e,t){const i=e.vertexAttributes;if(!i)return!1;const r=i.get("position"),a=e.indices.get("position");return Object(g["b"])(r,a,t)}createBufferWriter(){return new _e(this)}normalAndViewAngle(e,t,i,r){return x(t)&&(t=Object(p["f"])(he,t)),Object(o["y"])(r.normal,e,t),Object(o["n"])(r.normal,r.normal,i.viewInverseTransposeMatrix),r.cosAngle=Object(o["i"])(oe,ve),r}updateScaleInfo(e,t,i){const r=this.params;r.screenSizePerspective?Object(y["e"])(i,t,r.screenSizePerspective,e.factor):(e.factor.scale=1,e.factor.factor=0,e.factor.minPixelSize=0,e.factor.paddingPixels=0),r.screenSizePerspectiveAlignment?Object(y["e"])(i,t,r.screenSizePerspectiveAlignment,e.factorAlignment):(e.factorAlignment.factor=e.factor.factor,e.factorAlignment.scale=e.factor.scale,e.factorAlignment.minPixelSize=e.factor.minPixelSize,e.factorAlignment.paddingPixels=e.factor.paddingPixels)}applyShaderOffsetsView(e,t,i,r,a,n,s){const o=this.normalAndViewAngle(t,i,a,pe);return this.applyVerticalGroundOffsetView(e,o,a,s),this.applyVerticalOffsetTransformationView(s,o,a,n),this.applyPolygonOffsetView(s,o,r[3],a,s),this.applyCenterOffsetView(s,r,s),s}applyShaderOffsetsNDC(e,t,i,a,n){return this.applyCenterOffsetNDC(e,t,i,a),Object(r["k"])(n)&&Object(o["l"])(n,a),this.applyPolygonOffsetNDC(a,t,i,a),a}applyPolygonOffsetView(e,t,i,r,n){const s=r.aboveGround?1:-1;let c=Object(a["s"])(i);0===c&&(c=s);const l=s*c;if(this.params.shaderPolygonOffset<=0)return Object(o["l"])(n,e);const h=Object(a["d"])(Math.abs(t.cosAngle),.01,1),d=1-Math.sqrt(1-h*h)/h/r.viewport[2];return Object(o["f"])(n,e,l>0?d:1/d),n}applyVerticalGroundOffsetView(e,t,i,r){const a=Object(o["q"])(e),n=i.aboveGround?1:-1,s=.5*i.computeRenderPixelSizeAtDist(a),c=Object(o["f"])(ae,t.normal,n*s);return Object(o["g"])(r,e,c),r}applyVerticalOffsetTransformationView(e,t,i,r){const a=this.params;if(!a.verticalOffset||!a.verticalOffset.screenLength){if(a.screenSizePerspective||a.screenSizePerspectiveAlignment){const i=Object(o["q"])(e);this.updateScaleInfo(r,i,t.cosAngle)}else r.factor.scale=1,r.factorAlignment.scale=1;return e}const n=Object(o["q"])(e),s=a.screenSizePerspectiveAlignment||a.screenSizePerspective,c=Object(w["l"])(i,n,a.verticalOffset,t.cosAngle,s);return this.updateScaleInfo(r,n,t.cosAngle),Object(o["f"])(t.normal,t.normal,c),Object(o["g"])(e,e,t.normal)}applyCenterOffsetView(e,t,i){const r="screen"!==this.params.centerOffsetUnits;return i!==e&&Object(o["l"])(i,e),r&&(i[0]+=t[0],i[1]+=t[1],t[2]&&(Object(o["s"])(ne,i),Object(o["g"])(i,i,Object(o["f"])(ne,ne,t[2])))),i}applyCenterOffsetNDC(e,t,i,r){const a="screen"!==this.params.centerOffsetUnits;return r!==e&&Object(o["l"])(r,e),a||(r[0]+=t[0]/i.fullWidth*2,r[1]+=t[1]/i.fullHeight*2),r}applyPolygonOffsetNDC(e,t,i,r){const n=this.params.shaderPolygonOffset;if(e!==r&&Object(o["l"])(r,e),n){const e=i.aboveGround?1:-1,s=e*Object(a["s"])(t[3]);r[2]-=(s||e)*n}return r}getGLMaterial(e){return 0===e.output||7===e.output?new Y(e):4===e.output?new K(e):void 0}calculateRelativeScreenBounds(e,t,i=Object(l["l"])()){return J(this.params,e,t,i),i[2]=i[0]+e[0],i[3]=i[1]+e[1],i}}class X extends j["a"]{constructor(e){super({...e,...e.material.params}),this.updateParameters()}beginSlot(e){return e===(this.material.params.drawInSecondSlot?19:18)}updateParameters(e){this.updateTexture(this.material.params.textureId),this.selectProgram(e)}selectProgram(e){this.technique=this.techniqueRep.acquireAndReleaseExisting(q,this.material.getTechniqueConfig(this.output,e),this.technique)}ensureParameters(e){this.updateParameters(e)}bind(e,t){e.bindProgram(this.technique.program),this.bindTexture(e,this.technique.program),this.bindTextureScale(e,this.technique.program),this.technique.bindPass(e,this.material.params,t)}}class Y extends X{constructor(e){super(e),this.isOcclusionSlot=!1}beginSlot(e){const t=this.material.params.drawInSecondSlot?19:18;return this.material.params.occlusionTest?(this.isOcclusionSlot=12===e,12===e||e===t):(this.isOcclusionSlot=!1,e===t)}getTechnique(){return this.isOcclusionSlot?this.occlusionTechnique:this.technique}selectProgram(e){this.technique=this.techniqueRep.acquireAndReleaseExisting(q,this.material.getTechniqueConfig(this.output,e),this.technique),this.occlusionTechnique=this.techniqueRep.acquireAndReleaseExisting(q,this.material.getTechniqueConfig(6,e),this.occlusionTechnique)}bind(e,t){const i=this.getTechnique();e.bindProgram(i.program),this.isOcclusionSlot||(this.bindTexture(e,i.program),this.bindTextureScale(e,i.program)),i.bindPass(e,this.material.params,t)}}class K extends X{constructor(e){super({...e,output:4})}}function J(e,t,i,r=re){return Object(f["c"])(r,e.anchorPos),r[0]*=-t[0],r[1]*=-t[1],r[0]+=e.screenOffset[0]*i,r[1]+=e.screenOffset[1]*i,r}function ee(e){const t=e[0],i=e[1],r=e[2],a=e[3],n=e[4],s=e[5],o=e[6],c=e[7],l=e[8],h=1/Math.sqrt(t*t+i*i+r*r),d=1/Math.sqrt(a*a+n*n+s*s),u=1/Math.sqrt(o*o+c*c+l*l);return e[0]=t*h,e[1]=i*h,e[2]=r*h,e[3]=a*d,e[4]=n*d,e[5]=s*d,e[6]=o*u,e[7]=c*u,e[8]=l*u,e}function te(e,t,i,r,a,n,s,o){let c=t-a-(o[0]>0?r[0]*o[0]:0),l=c+r[0]+2*a,h=i-a-(o[1]>0?r[1]*o[1]:0),d=h+r[1]+2*a;if(s.textureIsSignedDistanceField){const e=s.distanceFieldBoundingBox;c+=r[0]*e[0],h+=r[1]*e[1],l-=r[0]*(1-e[2]),d-=r[1]*(1-e[3]),c-=n,l+=n,h-=n,d+=n}return e[0]>c&&e[0]<l&&e[1]>h&&e[1]<d}const ie={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}},re=Object(u["b"])(),ae=Object(s["e"])(),ne=Object(s["e"])(),se=Object(n["e"])(),oe=Object(s["e"])(),ce=Object(s["e"])(),le=Object(h["a"])(),he=Object(h["a"])(),de=Object(d["b"])(),ue=Object(s["e"])(),pe={normal:oe,cosAngle:0},fe=Object(d["b"])(),me=1,be=2,ge=[0,0],ve=Object(s["g"])(0,0,1),ye={texCoordScale:[1,1],occlusionTest:!0,binaryHighlightOcclusion:!0,drawInSecondSlot:!1,color:[1,1,1,1],outlineColor:[1,1,1,1],outlineSize:0,textureIsSignedDistanceField:!1,distanceFieldBoundingBox:null,vvSizeEnabled:!1,vvSizeMinSize:[1,1,1],vvSizeMaxSize:[100,100,100],vvSizeOffset:[0,0,0],vvSizeFactor:[1,1,1],vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],screenOffset:[0,0],verticalOffset:null,screenSizePerspective:null,screenSizePerspectiveAlignment:null,slicePlaneEnabled:!1,anchorPos:Object(u["f"])(.5,.5),shaderPolygonOffset:1e-5,polygonOffset:!1,textureId:null,centerOffsetUnits:"world",depthEnabled:!0,pixelSnappingEnabled:!0,debugDrawBorder:!1,isDraped:!1,...S["b"]},Oe=Object(m["a"])().vec3f("position").vec3f("normal").vec2f("uv0").vec4u8("color").vec2f("size").vec4f("auxpos1").vec4f("auxpos2");class _e{constructor(e){this.material=e,this.vertexBufferLayout=Oe}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return 6*e.indices.get("position").length}write(e,t,i,r){Object(C["e"])(t.indices.get("position"),t.vertexAttributes.get("position").data,e.transformation,i.position,r,6),Object(C["d"])(t.indices.get("normal"),t.vertexAttributes.get("normal").data,e.invTranspTransformation,i.normal,r,6);{const e=t.vertexAttributes.get("uv0").data;let a,n,s,o;if(null==e||e.length<4){const e=this.material.params;a=0,n=0,s=e.texCoordScale[0],o=e.texCoordScale[1]}else a=e[0],n=e[1],s=e[2],o=e[3];s=Math.min(1.99999,s+1),o=Math.min(1.99999,o+1);const c=t.indices.get("position").length,l=i.uv0;let h=r;for(let t=0;t<c;++t)l.set(h,0,a),l.set(h,1,n),h+=1,l.set(h,0,s),l.set(h,1,n),h+=1,l.set(h,0,s),l.set(h,1,o),h+=1,l.set(h,0,s),l.set(h,1,o),h+=1,l.set(h,0,a),l.set(h,1,o),h+=1,l.set(h,0,a),l.set(h,1,n),h+=1}Object(C["b"])(t.indices.get("color"),t.vertexAttributes.get("color").data,4,i.color,r,6);{const e=t.indices.get("size"),a=t.vertexAttributes.get("size").data,n=e.length,s=i.size;let o=r;for(let t=0;t<n;++t){const i=a[2*e[t]],r=a[2*e[t]+1];for(let e=0;e<6;++e)s.set(o,0,i),s.set(o,1,r),o+=1}}t.indices.get("auxpos1")&&t.vertexAttributes.get("auxpos1")&&Object(C["a"])(t.indices.get("auxpos1"),t.vertexAttributes.get("auxpos1").data,i.auxpos1,r,6),t.indices.get("auxpos2")&&t.vertexAttributes.get("auxpos2")&&Object(C["a"])(t.indices.get("auxpos2"),t.vertexAttributes.get("auxpos2").data,i.auxpos2,r,6)}}},"2e0f":function(e,t,i){"use strict";i.d(t,"a",(function(){return r})),i.d(t,"b",(function(){return v})),i.d(t,"c",(function(){return p})),i.d(t,"d",(function(){return m})),i.d(t,"e",(function(){return f})),i.d(t,"f",(function(){return b})),i.d(t,"g",(function(){return g}));var r,a=i("6c97"),n=i("b2b2"),s=i("0b2d"),o=i("d791"),c=i("8188"),l=i("afe1"),h=i("1a54"),d=i("0cb9"),u=i("ba58");function p(e,t,i,r,a,n,s,o,l,h,d){const u=w[d.mode];let p,f,m=0;if(Object(c["q"])(e,t,i,r,l.spatialReference,a,o))return u.requiresAlignment(d)?(m=u.applyElevationAlignmentBuffer(r,a,n,s,o,l,h,d),p=n,f=s):(p=r,f=a),Object(c["q"])(p,l.spatialReference,f,n,h.spatialReference,s,o)?m:void 0}function f(e,t,i,r,s){const o=(Object(h["j"])(e)?e.z:Object(d["c"])(e)?e.array[e.offset+2]:e[2])||0;switch(i.mode){case"on-the-ground":{const i=Object(n["u"])(Object(d["b"])(t,e,"ground"),0);return s&&(s.verticalDistanceToGround=0,s.sampledElevation=i),i}case"relative-to-ground":{const a=Object(n["u"])(Object(d["b"])(t,e,"ground"),0),c=i.geometryZWithOffset(o,r);return s&&(s.verticalDistanceToGround=c,s.sampledElevation=a),c+a}case"relative-to-scene":{const a=Object(n["u"])(Object(d["b"])(t,e,"scene"),0),c=i.geometryZWithOffset(o,r);return s&&(s.verticalDistanceToGround=c,s.sampledElevation=a),c+a}case"absolute-height":{const a=i.geometryZWithOffset(o,r);if(s){const i=Object(n["u"])(Object(d["b"])(t,e,"ground"),0);s.verticalDistanceToGround=a-i,s.sampledElevation=i}return a}default:return Object(a["a"])(i.mode),0}}function m(e,t,i){return null==t||null==i?e.definedChanged:"on-the-ground"===t&&"on-the-ground"===i?e.staysOnTheGround:t===i||"on-the-ground"!==t&&"on-the-ground"!==i?r.UPDATE:e.onTheGroundChanged}function b(e){return"relative-to-ground"===e||"relative-to-scene"===e}function g(e){return"absolute-height"!==e}function v(e,t,i,r,a){const n=f(t,i,a,r,C);Object(u["j"])(e,C.verticalDistanceToGround);const s=C.sampledElevation,l=Object(o["c"])(S,e.transformation);return T[0]=t.x,T[1]=t.y,T[2]=n,Object(c["d"])(t.spatialReference,T,l,r.spatialReference)?e.transformation=l:console.warn("Could not locate symbol object properly, it might be misplaced"),s}function y(e,t,i,r,a,s){let o=0;const c=s.spatialReference;t*=3,r*=3;for(let l=0;l<a;++l){const a=e[t+0],l=e[t+1],h=e[t+2],d=Object(n["u"])(s.getElevation(a,l,h,c,"ground"),0);o+=d,i[r+0]=a,i[r+1]=l,i[r+2]=d,t+=3,r+=3}return o/a}function O(e,t,i,r,a,s,o,c){let l=0;const h=c.calculateOffsetRenderUnits(o),d=c.featureExpressionInfoContext,u=s.spatialReference;t*=3,r*=3;for(let p=0;p<a;++p){const a=e[t+0],o=e[t+1],c=e[t+2],p=Object(n["u"])(s.getElevation(a,o,c,u,"ground"),0);l+=p,i[r+0]=a,i[r+1]=o,i[r+2]=null==d?c+p+h:p+h,t+=3,r+=3}return l/a}function _(e,t,i,r,a,s,o,c){let l=0;const h=c.calculateOffsetRenderUnits(o),d=c.featureExpressionInfoContext,u=s.spatialReference;t*=3,r*=3;for(let p=0;p<a;++p){const a=e[t+0],o=e[t+1],c=e[t+2],p=Object(n["u"])(s.getElevation(a,o,c,u,"scene"),0);l+=p,i[r+0]=a,i[r+1]=o,i[r+2]=null==d?c+p+h:p+h,t+=3,r+=3}return l/a}function x(e){const t=e.meterUnitOffset,i=e.featureExpressionInfoContext;return 0!==t||null!=i}function j(e,t,i,r,a,n,s,o){const c=o.calculateOffsetRenderUnits(s),l=o.featureExpressionInfoContext;t*=3,r*=3;for(let h=0;h<a;++h){const a=e[t+0],n=e[t+1],s=e[t+2];i[r+0]=a,i[r+1]=n,i[r+2]=null==l?s+c:c,t+=3,r+=3}return 0}!function(e){e[e.NONE=0]="NONE",e[e.UPDATE=1]="UPDATE",e[e.RECREATE=2]="RECREATE"}(r||(r={}));const w={"absolute-height":{applyElevationAlignmentBuffer:j,requiresAlignment:x},"on-the-ground":{applyElevationAlignmentBuffer:y,requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:O,requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:_,requiresAlignment:()=>!0}},S=Object(l["b"])(),C={verticalDistanceToGround:0,sampledElevation:0},T=Object(s["e"])()},"2eb0":function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i("3886");function a(e){e.fragment.uniforms.add("u_colormap","sampler2D"),e.fragment.uniforms.add("u_colormapOffset","float"),e.fragment.uniforms.add("u_colormapMaxIndex","float"),e.fragment.code.add(r["a"]`
    vec4 colormap(vec4 currentPixel, bool isFloat) {
      // colormap is only applicable to integer data but could be already normalized to 0-1 float
      float clrIndex = isFloat ? currentPixel.r - u_colormapOffset : currentPixel.r * 255.0 - u_colormapOffset;
      vec4 result;
      // handle no data and out of range pixels
      if (currentPixel.a == 0.0 || clrIndex > u_colormapMaxIndex) {
        result = vec4(0.0, 0.0, 0.0, 0.0);
      } else {
        // colormap lookup
        vec2 clrPosition = vec2((clrIndex + 0.5) / (u_colormapMaxIndex + 1.0), 0.0);
        vec4 color = texture2D(u_colormap, clrPosition);
        result = vec4(color.rgb, 1.0) * color.a * u_opacity;
      }
      return result;
    }
  `)}},"2ebb":function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));const r={divisor:0};function a(e,t={}){t={...r,...t};const i=e.stride;return e.fieldNames.filter(t=>{const i=e.fields.get(t).optional;return!(i&&i.glPadding)}).map(r=>{const a=e.fields.get(r),s=a.constructor.ElementCount,o=n(a.constructor.ElementType),c=a.offset,l=!(!a.optional||!a.optional.glNormalized);return{name:r,stride:i,count:s,type:o,offset:c,normalized:l,divisor:t.divisor}})}function n(e){const t=s[e];if(t)return t;throw new Error("BufferType not supported in WebGL")}const s={u8:5121,u16:5123,u32:5125,i8:5120,i16:5122,i32:5124,f32:5126}},"2ec5":function(e,t,i){"use strict";i.d(t,"a",(function(){return g})),i.d(t,"b",(function(){return u})),i.d(t,"c",(function(){return h})),i.d(t,"d",(function(){return f})),i.d(t,"e",(function(){return v})),i.d(t,"f",(function(){return d})),i.d(t,"g",(function(){return s})),i.d(t,"h",(function(){return l})),i.d(t,"i",(function(){return c})),i.d(t,"j",(function(){return o})),i.d(t,"k",(function(){return m})),i.d(t,"l",(function(){return b})),i.d(t,"m",(function(){return p}));var r=i("38a4"),a=i("9180"),n=i("ee83");const s=[0,1],o=64,c=512,l=2.5,h=Object(r["e"])(r["a"]/10),d=2,u=4,p=Object(a["l"])();n["a"].WebMercatorAuxiliarySphere.getExtent(0,0,0,p);const f=Object(a["l"])([-180,-90,180,90]),m="Cannot extend surface to encompass all layers because it would result in too many root tiles.",b="Surface extent is too large for tile resolution at level 0.",g="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAIAAADTED8xAAAACXBIWXMAAAsTAAALEwEAmpwYAAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAA2JJREFUeNrs3d1O20AQgFFvRJInQLQBhHj/h0JVW34El1yQ2F73DVq3jTys55zrqUBbPrErZUSZ+vcOsto4AjK76Lqu1vr8+G3mPzjc3D/+eJj/Bcz/cd75R80fbu79BsAVCAQAAgABgABAACAAEAAIAAQAAgABQPOKfQAy83Ho+HnnHzXv49B4A4AAQAAgABAACAAEAAIAAYAAQAAgABAANM4+AKnZB4ifd/5R8/YB8AYAAYAAQAAgABAACAAEAAIAAYAAQAAgAGicfQBSsw8QP+/8o+btA+ANAAIAAYAAQAAgABAACAAEAAIAAYAAQADQOPsApGYfIH7e+UfN2wfAGwAEAAIAAYAAQAAgABAACAAEAAIAAXA201QdggAggH0AUrMPED8/jsPL03fns/y8fQC8AUAAIAAQAAgABAACAAGAAEAAIAAQAAgAGmcfgNTsA8TP2weImrcPgDcACAAEAAIAAYAAQAAgABAACAAEAAIAAUDj7AOQmn2A+Hn7AFHz9gHwBgABgABAACAAEAAIAAQAAgABgABgNS4cAf9pu9u3O1+m/n2aplKK/0j+TX86/tVP5+eZ3+729gFIfwWyDxA7bx8gat4+ANkJAAGAAEAAIAAQAAgABAACAAGAAEAAIABonn0AUrMPED9vHyBq3j4A3gAgABAACAAEAAIAAYAAQAAgABAA51VrdQgCAAHAsuwDkJp9gPj5vj+9vvx0PsvP2wfAGwAEAAIAAYAAQAAgABAACAAEAAIAAYAAoHH2AUjNPkD8vH2AqHn7AHgDgABAACAAEAAIAAQAAgABgABAACAAEAA0zj4AqdkHiJ+3DxA1bx8AbwAQACQ0DL0AyKuOowBwBYKUSikCIHUBAsAVCAQAAgABgABAALBy9gFIzT5A/Lx9gKj5y6trVyC8AUAAIAAQAAgAVq90Pg5N5gA2AsAVCAQAAgABgABAALB29gFIzT5A/Lx9gKj5q6+3rkB4A4AAQAAgABAACADWzB/IIHsCAsAVCARAlKlWhyAAEAAIABZjH4DU7APEz5+OH2+vT85n+fkvhztXILwBQAAgABAACAAEAGtWigBIHcBGALgCgQBAACAAyPMO9nHosxuHodZx5vB2t691HIdh/nx/Os7/Zsz/fvgXAAAA//8DAF1P1hM2ICMfAAAAAElFTkSuQmCC",v=5},"2f00":function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i("3886");function a(e){e.attributes.add("position","vec2"),e.attributes.add("uv0","vec2"),e.vertex.uniforms.add("u_scale","float"),e.vertex.uniforms.add("u_offset","vec2"),e.varyings.add("v_texcoord","vec2"),e.vertex.code.add(r["a"]`
    void main(void) {
      v_texcoord = uv0 * u_scale + u_offset;
      gl_Position = vec4(position, 0.0, 1.0);
    }
  `)}},"303f":function(e,t,i){"use strict";i.d(t,"a",(function(){return f}));var r=i("a4ee"),a=(i("c120"),i("e92d"),i("cea0"),i("59b2")),n=i("afcf"),s=i("d386"),o=i("e041"),c=(i("8eed"),i("f402"),i("f4cc")),l=i("5996"),h=i("3af1"),d=i("2eab"),u=i("549a"),p=i("22f4");const f=e=>{let t=class extends e{constructor(){super(...arguments),this.capabilities=void 0,this.copyright=null,this.fullExtent=null,this.legendEnabled=!0,this.spatialReference=null,this.version=null}readCapabilities(e,t){const i=t.capabilities&&t.capabilities.split(",").map(e=>e.toLowerCase().trim());if(!i)return{operations:{supportsQuery:!1,supportsExportMap:!1,supportsExportTiles:!1,supportsTileMap:!1},exportMap:null,exportTiles:null};const r=this.type,a=-1!==i.indexOf("query"),n=-1!==i.indexOf("map"),s=!!t.exportTilesAllowed,o=-1!==i.indexOf("tilemap"),c="tile"!==r&&!!t.supportsDynamicLayers,l="tile"!==r&&(!t.tileInfo||c),h="tile"!==r&&(!t.tileInfo||c),d="tile"!==r,p=!!t.cimVersion&&u["a"].parse(t.cimVersion).since(1,4);return{operations:{supportsQuery:a,supportsExportMap:n,supportsExportTiles:s,supportsTileMap:o},exportMap:n?{supportsArcadeExpressionForLabeling:p,supportsSublayersChanges:d,supportsDynamicLayers:c,supportsSublayerVisibility:l,supportsSublayerDefinitionExpression:h}:null,exportTiles:s?{maxExportTilesCount:+t.maxExportTilesCount}:null}}readVersion(e,t){let i=t.currentVersion;return i||(i=t.hasOwnProperty("capabilities")||t.hasOwnProperty("tables")?10:t.hasOwnProperty("supportedImageFormatTypes")?9.31:9.3),i}async fetchSublayerInfo(e,t){return await this.fetchAllLayersAndTables(t),this._allLayersAndTablesMap.get(e)}async fetchAllLayersAndTables(e){await this.load(e),this._allLayersAndTablesPromise||(this._allLayersAndTablesPromise=Object(d["default"])(Object(o["J"])(this.url).path+"/layers",{responseType:"json",query:{f:"json",...this.customParameters}}).then(e=>{this._allLayersAndTablesMap=new Map;for(const t of e.data.layers)this._allLayersAndTablesMap.set(t.id,t);return{result:e.data}},e=>({error:e})));const t=await this._allLayersAndTablesPromise;if(Object(c["w"])(e),"result"in t)return t.result;throw t.error}};return Object(r["a"])([Object(a["b"])({readOnly:!0})],t.prototype,"capabilities",void 0),Object(r["a"])([Object(n["a"])("service","capabilities",["capabilities","exportTilesAllowed","maxExportTilesCount","supportsDynamicLayers","tileInfo"])],t.prototype,"readCapabilities",null),Object(r["a"])([Object(a["b"])({json:{read:{source:"copyrightText"}}})],t.prototype,"copyright",void 0),Object(r["a"])([Object(a["b"])({type:h["a"]})],t.prototype,"fullExtent",void 0),Object(r["a"])([Object(a["b"])(p["c"])],t.prototype,"id",void 0),Object(r["a"])([Object(a["b"])({type:Boolean,json:{origins:{service:{read:{enabled:!1}}},read:{source:"showLegend"},write:{target:"showLegend"}}})],t.prototype,"legendEnabled",void 0),Object(r["a"])([Object(a["b"])(p["j"])],t.prototype,"popupEnabled",void 0),Object(r["a"])([Object(a["b"])({type:l["a"]})],t.prototype,"spatialReference",void 0),Object(r["a"])([Object(a["b"])()],t.prototype,"version",void 0),Object(r["a"])([Object(n["a"])("version",["currentVersion","capabilities","tables","supportedImageFormatTypes"])],t.prototype,"readVersion",null),t=Object(r["a"])([Object(s["a"])("esri.layers.mixins.ArcGISMapService")],t),t}},3111:function(e,t,i){"use strict";i.d(t,"a",(function(){return o})),i.d(t,"b",(function(){return s}));var r=i("3886"),a=i("690a"),n=i("7c1d");function s(){const e=new a["a"];return e.attributes.add("position","vec3"),e.attributes.add("color","vec4"),e.attributes.add("size","float"),e.varyings.add("vcolor","vec4"),e.varyings.add("vsize","float"),e.vertex.uniforms.add("transform","mat4").add("viewport","vec4").add("pixelRatio","float"),e.include(n["a"]),e.vertex.code.add(r["a"]`
    void main(void) {
      vec4 posProj = transform * vec4(position, 0);
      gl_Position = alignToPixelCenter(posProj, viewport.zw);
      vcolor = color / 1.2;
      vsize = size * 5.0 * pixelRatio;
      gl_PointSize = vsize;
    }
  `),e.fragment.code.add(r["a"]`
    void main() {
      float cap = 0.7;
      float scale = 1.0 / cap;
      float helper = clamp(length(abs(gl_PointCoord - vec2(0.5))), 0.0, cap);
      float alpha = clamp((cap - helper) * scale, 0.0, 1.0);
      float intensity = alpha * alpha * alpha;
      if (vsize < 3.0) {
        intensity *= 0.5;
      }
      gl_FragColor = vec4(vcolor.xyz, intensity);
    }
  `),e}var o=Object.freeze({__proto__:null,build:s})},"33e2":function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i("3886"),a=i("d981");function n(e){e.fragment.uniforms.add("texWaveNormal","sampler2D"),e.fragment.uniforms.add("texWavePerturbation","sampler2D"),e.fragment.uniforms.add("waveParams","vec4"),e.fragment.uniforms.add("waveDirection","vec2"),e.include(a["b"]),e.fragment.code.add(r["a"]`
      const vec2  FLOW_JUMP = vec2(6.0/25.0, 5.0/24.0);

      vec2 textureDenormalized2D(sampler2D _tex, vec2 _uv) {
        return 2.0 * texture2D(_tex, _uv).rg - 1.0;
      }

      float sampleNoiseTexture(vec2 _uv) {
        return texture2D(texWavePerturbation, _uv).b;
      }

      vec3 textureDenormalized3D(sampler2D _tex, vec2 _uv) {
        return 2.0 * texture2D(_tex, _uv).rgb - 1.0;
      }

      float computeProgress(vec2 uv, float time) {
        return fract(time);
      }

      float computeWeight(vec2 uv, float time) {
        float progress = computeProgress(uv, time);
        return 1.0 - abs(1.0 - 2.0 * progress);
      }

      vec3 computeUVPerturbedWeigth(sampler2D texFlow, vec2 uv, float time, float phaseOffset) {
        float flowStrength = waveParams[2];
        float flowOffset = waveParams[3];

        vec2 flowVector = textureDenormalized2D(texFlow, uv) * flowStrength;

        float progress = computeProgress(uv, time + phaseOffset);
        float weight = computeWeight(uv, time + phaseOffset);

        vec2 result = uv;
        result -= flowVector * (progress + flowOffset);
        result += phaseOffset;
        result += (time - progress) * FLOW_JUMP;

        return vec3(result, weight);
      }

      const float TIME_NOISE_TEXTURE_REPEAT = 0.3737;
      const float TIME_NOISE_STRENGTH = 7.77;

      vec3 getWaveLayer(sampler2D _texNormal, sampler2D _dudv, vec2 _uv, vec2 _waveDir, float time) {
        float waveStrength = waveParams[0];

        // overall directional shift in uv's for directional wave movement for
        // now we do a hard coded scale for wave speed such that a unit length
        // direction is not too fast.
        vec2 waveMovement = time * -_waveDir;

        float timeNoise = sampleNoiseTexture(_uv * TIME_NOISE_TEXTURE_REPEAT) * TIME_NOISE_STRENGTH;

        // compute two perturbed uvs and blend weights
        // then sample the wave normals at the two positions and blend
        vec3 uv_A = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.0);
        vec3 uv_B = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.5);

        vec3 normal_A = textureDenormalized3D(_texNormal, uv_A.xy) * uv_A.z;
        vec3 normal_B = textureDenormalized3D(_texNormal, uv_B.xy) * uv_B.z;

        // logic to flatten the wave pattern
        // scale xy components of the normal, then adjust z (up) component
        vec3 mixNormal = normalize(normal_A + normal_B);
        mixNormal.xy *= waveStrength;
        mixNormal.z = sqrt(1.0 - dot(mixNormal.xy, mixNormal.xy));

        return mixNormal;
      }

      vec4 getSurfaceNormalAndFoam(vec2 _uv, float _time) {
        float waveTextureRepeat = waveParams[1];
        vec3 normal = getWaveLayer(texWaveNormal, texWavePerturbation, _uv * waveTextureRepeat, waveDirection, _time);
        float foam  = normals2FoamIntensity(normal, waveParams[0]);
        return vec4(normal, foam);
      }
    `)}!function(e){function t(e,t){e.setUniform1i("texWaveNormal",0),e.setUniform1i("texWavePerturbation",1),e.setUniform4f("waveParams",t.waveStrength,t.waveTextureRepeat,t.flowStrength,t.flowOffset),e.setUniform2f("waveDirection",t.waveDirection[0]*t.waveVelocity,t.waveDirection[1]*t.waveVelocity)}e.bindUniforms=t}(n||(n={}))},"34f2":function(e,t,i){"use strict";i.d(t,"a",(function(){return a})),i.d(t,"b",(function(){return r}));class r{constructor(e,t,i){this.editGeometry=e,this.vertices=t,this.operation=i,this.undone=!1}apply(){this.vertices.forEach(e=>this.operation.apply(e)),this.editGeometry.components.forEach(e=>e.unnormalizeVertexPositions());const e={updatedVertices:this.vertices,operation:this.undone?"redo":"apply"};this.editGeometry.emit("change",e)}undo(){this.vertices.forEach(e=>{this.operation.undo(e)});const e={updatedVertices:this.vertices,operation:"undo"};this.editGeometry.emit("change",e),this.undone=!0}canAccumulate(e){if(this.undone)return!1;if(e.vertices.length!==this.vertices.length)return!1;for(let t=0;t<e.vertices.length;++t)if(e.vertices[t]!==this.vertices[t])return!1;return this.operation.canAccumulate(e.operation)}accumulate(e){if(e instanceof r&&this.canAccumulate(e)){this.vertices.forEach(t=>this.operation.accumulate(t,e.operation)),this.operation.accumulateParams(e.operation),this.editGeometry.components.forEach(e=>e.unnormalizeVertexPositions());const t={updatedVertices:this.vertices,operation:"apply"};return this.editGeometry.emit("change",t),!0}return!1}}class a{constructor(e){this.helper=e}}},3510:function(e,t,i){"use strict";i.d(t,"a",(function(){return l}));var r=i("b2b2"),a=i("f4cc"),n=i("9305"),s=i("3563"),o=i("1f1c"),c=i("c20d");class l{constructor(){this.next=new c["a"]}createSnapDragEventPipelineStep({predicate:e=(()=>!0),cancel:t,snappingManager:i,snappingContext:l}){if(Object(r["j"])(i))return e=>e;let h=null,d=null;const u=()=>{h=Object(r["a"])(h),i.doneSnapping(),Object(r["k"])(d)&&d.frameTask.remove(),d=null};return t.next(e=>(u(),e)),this.next=new c["a"],t=>{if(!e(t))return t;if(h=Object(r["a"])(h),"start"===t.action){const e="3d"===i.view.type?i.view.resourceController.scheduler.registerTask(n["b"].SNAPPING,t=>Object(r["t"])(e).processQueue(t),()=>!1):n["a"];d={context:new o["a"]({geometry:l.geometry,elevationInfo:l.elevationInfo,pointer:l.pointer,vertexHandle:Object(r["k"])(t.info)?t.info.handle:null,excludeFeature:l.excludeFeature,visualizer:l.visualizer}),originalPos:Object(r["k"])(t.snapOrigin)?l.coordinateHelper.createDehydratedPoint(t.snapOrigin):t.mapStart,frameTask:e}}if(Object(r["k"])(d)){const e=d.context.coordinateHelper.createDehydratedPoint(d.context.coordinateHelper.fromArray([d.originalPos.x,d.originalPos.y,d.originalPos.z]));e.x+=t.mapEnd.x-t.mapStart.x,e.y+=t.mapEnd.y-t.mapStart.y;const r=t.mapStart.x-d.originalPos.x,n=t.mapStart.y-d.originalPos.y,o={...t,action:"udpate"},c=d.context,l=i.update(e,d.context);if(t.mapEnd.x=l.x+r,t.mapEnd.y=l.y+n,"end"!==t.action){const t=d.frameTask;h=Object(a["i"])(async a=>{const h=await t.schedule(()=>i.snap(e,c,a),a);if(h.valid){const e=await t.schedule(()=>h.apply(),a);Object(s["b"])(e,l)||(o.mapEnd.x=e.x+r,o.mapEnd.y=e.y+n,this.next.execute(o))}})}}return"end"===t.action&&u(),t}}}},3544:function(e,t,i){"use strict";i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return s})),i.d(t,"c",(function(){return o}));i("c120");var r=i("b2b2"),a=(i("9f8b"),i("1956"),i("a1ff"));i("d267");class n{constructor(){this.cache=new Map}dispose(){this.cache.forEach(e=>{Object(r["k"])(e.texture)&&(e.texture.dispose(),e.texture=null)}),this.cache.clear()}acquire(e){if(Object(r["j"])(e))return null;const t=this.patternId(e),i=this.cache.get(t);if(i)return i.refCount++,i.bind;const n=2,s=this.patternToTextureData(e,2),o=s.length/n,c={refCount:1,texture:null,bind:(e,t)=>(Object(r["j"])(c.texture)&&(c.texture=new a["a"](e,{width:s.length,height:1,internalFormat:6406,pixelFormat:6406,dataType:5121,wrapMode:33071},s)),e.bindTexture(c.texture,t),o)};return this.cache.set(t,c),c.bind}release(e){if(Object(r["j"])(e))return;const t=this.patternId(e),i=this.cache.get(t);i&&(i.refCount--,0===i.refCount&&(Object(r["k"])(i.texture)&&i.texture.dispose(),this.cache.delete(t)))}swap(e,t){const i=this.acquire(t);return this.release(e),i}patternId(e){return e.join(",")}patternToTextureData(e,t){const i=e.reduce((e,t)=>e+t)*t,r=new Uint8Array(i);let a=!0,n=0;for(const s of e){for(let e=0;e<s*t;e++)r[n++]=a?255:0;a=!a}return r}}function s(e){return Object(r["j"])(e)?e:e.slice()}function o(e){return[e,e]}},3563:function(e,t,i){"use strict";i.d(t,"a",(function(){return f})),i.d(t,"b",(function(){return s}));i("c120");var r=i("b2b2");function a(e,t){if(e===t)return!0;if(null==e||null==t)return!1;if(e.length!==t.length)return!1;for(let i=0;i<e.length;i++){const r=e[i],a=t[i];if(r.length!==a.length)return!1;for(let e=0;e<r.length;e++)if(r[e]!==a[e])return!1}return!0}function n(e,t){if(e===t)return!0;if(null==e||null==t)return!1;if(e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(!a(e[i],t[i]))return!1;return!0}function s(e,t){return!!d(e.spatialReference,t.spatialReference)&&e.x===t.x&&e.y===t.y&&e.z===t.z&&e.m===t.m}function o(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!d(e.spatialReference,t.spatialReference)&&n(e.paths,t.paths)}function c(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!d(e.spatialReference,t.spatialReference)&&n(e.rings,t.rings)}function l(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!d(e.spatialReference,t.spatialReference)&&a(e.points,t.points)}function h(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!d(e.spatialReference,t.spatialReference)&&e.xmin===t.xmin&&e.ymin===t.ymin&&e.zmin===t.zmin&&e.xmax===t.xmax&&e.ymax===t.ymax&&e.zmax===t.zmax}function d(e,t){return e===t||e&&t&&e.equals(t)}function u(e,t){if(e===t)return!0;if(Object(r["j"])(e)||Object(r["j"])(t))return!1;if(e.type!==t.type)return!1;switch(e.type){case"point":return s(e,t);case"extent":return h(e,t);case"polyline":return o(e,t);case"polygon":return c(e,t);case"multipoint":return l(e,t);case"mesh":return!1;default:return}}function p(e,t){if(e===t)return!0;if(!e||!t)return!1;const i=Object.keys(e),r=Object.keys(t);if(i.length!==r.length)return!1;for(const a of i)if(e[a]!==t[a])return!1;return!0}function f(e,t){return e===t||null!=e&&null!=t&&e.objectId===t.objectId&&!!u(e.geometry,t.geometry)&&!!p(e.attributes,t.attributes)}},3626:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i("3886"),a=i("4377");function n(e){e.include(a["a"]),e.code.add(r["a"]`
    vec3 mixExternalColor(vec3 internalColor, vec3 textureColor, vec3 externalColor, int mode) {
      // workaround for artifacts in OSX using Intel Iris Pro
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/10475
      vec3 internalMixed = internalColor * textureColor;
      vec3 allMixed = internalMixed * externalColor;

      if (mode == ${r["a"].int(1)}) {
        return allMixed;
      }
      else if (mode == ${r["a"].int(2)}) {
        return internalMixed;
      }
      else if (mode == ${r["a"].int(3)}) {
        return externalColor;
      }
      else {
        // tint (or something invalid)
        float vIn = rgb2v(internalMixed);
        vec3 hsvTint = rgb2hsv(externalColor);
        vec3 hsvOut = vec3(hsvTint.x, hsvTint.y, vIn * hsvTint.z);
        return hsv2rgb(hsvOut);
      }
    }

    float mixExternalOpacity(float internalOpacity, float textureOpacity, float externalOpacity, int mode) {
      // workaround for artifacts in OSX using Intel Iris Pro
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/10475
      float internalMixed = internalOpacity * textureOpacity;
      float allMixed = internalMixed * externalOpacity;

      if (mode == ${r["a"].int(2)}) {
        return internalMixed;
      }
      else if (mode == ${r["a"].int(3)}) {
        return externalOpacity;
      }
      else {
        // multiply or tint (or something invalid)
        return allMixed;
      }
    }
  `)}},"365a":function(e,t,i){"use strict";var r=i("a4ee"),a=(i("c120"),i("e92d")),n=(i("cea0"),i("59b2")),s=i("d386"),o=(i("e041"),i("8eed"),i("f402"),i("fc29")),c=i("ce6d"),l=i("a5d8"),h=i("fab3"),d=i("9096");let u=class extends(Object(d["b"])(Object(l["a"])(Object(h["b"])(c["a"].EventedMixin(o["a"]))))){constructor(e){super(e),this.layer=null,this.parent=null}initialize(){this.when().catch(e=>{if("layerview:create-error"!==e.name){const t=this.layer&&this.layer.id||"no id",i=this.layer&&this.layer.title||"no title";throw a["a"].getLogger(this.declaredClass).error("#resolve()",`Failed to resolve layer view (layer title: '${i}', id: '${t}')`,e),e}})}get fullOpacity(){const e=e=>null==e?1:e;return e(this.get("layer.opacity"))*e(this.get("parent.fullOpacity"))}get suspended(){return!this.canResume()}get suspendInfo(){return this.getSuspendInfo()}get legendEnabled(){return!this.suspended&&!0===this.layer.legendEnabled}get updating(){return!!(this.updatingHandles&&this.updatingHandles.updating||this.isUpdating())}get visible(){return!0===this.get("layer.visible")}set visible(e){void 0!==e?this._override("visible",e):this._clearOverride("visible")}canResume(){return!this.get("parent.suspended")&&this.get("view.ready")&&this.get("layer.loaded")&&this.visible||!1}getSuspendInfo(){const e=this.parent&&this.parent.suspended?this.parent.suspendInfo:{},t=this;return t.view&&t.view.ready||(e.viewNotReady=!0),this.layer&&this.layer.loaded||(e.layerNotLoaded=!0),this.visible||(e.layerInvisible=!0),e}isUpdating(){return!1}};Object(r["a"])([Object(n["b"])()],u.prototype,"fullOpacity",null),Object(r["a"])([Object(n["b"])()],u.prototype,"layer",void 0),Object(r["a"])([Object(n["b"])()],u.prototype,"parent",void 0),Object(r["a"])([Object(n["b"])({readOnly:!0})],u.prototype,"suspended",null),Object(r["a"])([Object(n["b"])({readOnly:!0})],u.prototype,"suspendInfo",null),Object(r["a"])([Object(n["b"])({readOnly:!0})],u.prototype,"legendEnabled",null),Object(r["a"])([Object(n["b"])({type:Boolean,readOnly:!0})],u.prototype,"updating",null),Object(r["a"])([Object(n["b"])()],u.prototype,"visible",null),u=Object(r["a"])([Object(s["a"])("esri.views.layers.LayerView")],u);var p=u;t["a"]=p},"36df":function(e,t,i){"use strict";i.d(t,"a",(function(){return l})),i.d(t,"b",(function(){return c}));var r=i("3886"),a=i("690a"),n=i("d047"),s=i("2aad"),o=i("58c2");function c(e){const t=new a["a"];return t.include(s["a"]),1===e.output&&(t.fragment.include(n["a"]),t.fragment.code.add(r["a"]`
      #ifndef RADIUS
        #define RADIUS `+e.radius+"\n      #endif\n    "),t.fragment.uniforms.add("normalMap","sampler2D").add("depthMap","sampler2D").add("tex","sampler2D").add("blurSize","vec2").add("g_BlurFalloff","float").add("projScale","float").add("nearFar","vec2").add("zScale","vec2"),t.fragment.code.add(r["a"]`
      float blurFunction(vec2 uv, float r, float center_d, inout float w_total, float sharpness) {
        float c = texture2D(tex, uv).r;
        float d = linearDepthFromTexture(depthMap, uv, nearFar);

        float ddiff = d - center_d;

        float w = exp(-r*r*g_BlurFalloff - ddiff*ddiff*sharpness);

        w_total += w;

        return w*c;
      }

      void main(void) {
        float b = 0.0;
        float w_total = 0.0;

        float center_d = linearDepthFromTexture(depthMap, uv, nearFar);

        float sharpness = -0.05 * projScale/(center_d*zScale.x+zScale.y);
        for (int r = -RADIUS; r <= RADIUS; ++r) {
          float rf = float(r);
          vec2 uvOffset = uv + rf*blurSize;
          b += blurFunction(uvOffset, rf, center_d, w_total, sharpness);
        }

        gl_FragColor = vec4(b/w_total);
      }
    `)),0===e.output&&(t.fragment.include(n["a"]),t.include(o["a"]),t.fragment.uniforms.add("projMatrixInv","mat4").add("normalMap","sampler2D").add("depthMap","sampler2D").add("intensity","float").add("projScale","float").add("radius","float").add("nearFar","vec2").add("screenDimensions","vec2").add("rnmScale","vec2").add("rnm","sampler2D"),t.fragment.code.add(r["a"]`
      #ifndef SAMPLES
        #define SAMPLES `+e.samples+"\n      #endif\n      uniform vec3 pSphere[SAMPLES]; //tap position\n    "),t.fragment.code.add(r["a"]`
      float fallOffFunction(float vv, float vn, float bias) {
        float radius2 = radius * radius;

        // A: From the HPG12 paper
        // Note large epsilon to avoid overdarkening within cracks
        // return float(vv < radius2) * max((vn - bias) / (epsilon + vv), 0.0) * radius2 * 0.6;

        // B: Smoother transition to zero (lowers contrast, smoothing out corners). [Recommended]
        float f = max(radius2 - vv, 0.0); return f * f * f * max(vn-bias, 0.0);

        // C: Medium contrast (which looks better at high radii), no division.  Note that the
        // contribution still falls off with radius^2, but we've adjusted the rate in a way that is
        // more computationally efficient and happens to be aesthetically pleasing.
        // return 4.0 * max(1.0 - vv * invRadius2, 0.0) * max(vn - bias, 0.0);

        // D: Low contrast, no division operation
        // return 2.0 * float(vv < radius * radius) * max(vn - bias, 0.0);
      }
    `),t.fragment.code.add(r["a"]`
      float aoValueFromPositionsAndNormal(vec3 C, vec3 n_C, vec3 Q) {
        vec3 v = Q - C;
        float vv = dot(v, v);
        float vn = dot(normalize(v), n_C);
        return fallOffFunction(vv, vn, 0.1);
      }
    `),t.fragment.code.add(r["a"]`
      void main(void) {
        //Hash function used in the HPG12 AlchemyAO paper
        //Not supported in WebGL -> using texture lookup as in old SSAO shader instead
        //ivec2 ssC = ivec2(gl_FragCoord.xy);
        //float randomPatternRotationAngle = float((3 * ssC.x ^ ssC.y + ssC.x * ssC.y) * 10);
        vec3 fres = normalize((texture2D(rnm, uv * rnmScale).xyz * 2.0) - vec3(1.0));

        float currentPixelDepth = linearDepthFromTexture(depthMap, uv, nearFar);

        if (-currentPixelDepth>nearFar.y || -currentPixelDepth<nearFar.x) {
          gl_FragColor = vec4(0.0);
          return;
        }

        vec3 currentPixelPos = reconstructPosition(gl_FragCoord.xy,currentPixelDepth);

        // get the normal of current fragment
        vec4 norm4 = texture2D(normalMap, uv);
        vec3 norm = vec3(-1.0) + 2.0 * norm4.xyz;
        bool isTerrain = norm4.w<0.5;

        float sum = .0;

        vec4 occluderFragment;
        vec3 ray;

        vec3 tapPixelPos;

        // note: the factor 2.0 should not be necessary, but makes ssao much nicer.
        // bug or deviation from CE somewhere else?
        float ps = projScale/(2.0*currentPixelPos.z*zScale.x+zScale.y);

        for(int i = 0; i < SAMPLES; ++i) {
          // get a vector (randomized inside of a sphere with radius 1.0) from a texture and reflect it
          //float ssR;
          //vec2 unitOffset = tapLocation(i, randomPatternRotationAngle, ssR);
          // get the depth of the occluder fragment
          //vec2 offset = vec2(-unitOffset*radius*ssR*ps);

          vec2 unitOffset = reflect(pSphere[i], fres).xy;
          vec2 offset = vec2(-unitOffset*radius*ps);

          //don't use current or very nearby samples
          if ( abs(offset.x)<2.0 || abs(offset.y)<2.0) continue;

          vec2 tc = vec2(gl_FragCoord.xy + offset);
          if (tc.x < 0.0 || tc.y < 0.0 || tc.x > screenDimensions.x || tc.y > screenDimensions.y) continue;
          vec2 tcTap = tc/screenDimensions;
          float occluderFragmentDepth = linearDepthFromTexture(depthMap, tcTap, nearFar);

          if (isTerrain) {
            bool isTerrainTap = texture2D(normalMap, tcTap).w<0.5;
            if (isTerrainTap) {
              continue;
            }
          }

          tapPixelPos = reconstructPosition(tc, occluderFragmentDepth);

          sum+= aoValueFromPositionsAndNormal(currentPixelPos, norm, tapPixelPos);
        }

        // output the result

        float A = max(1.0-sum*intensity/float(SAMPLES),0.0);

        // Anti-tone map to reduce contrast and drag dark region farther
        // (x^0.2 + 1.2 * x^4)/2.2
        A = (pow(A, 0.2) + 1.2 * A*A*A*A) / 2.2;

        //gl_FragColor = vec4(norm/2.0+0.5, 1.0);
        //gl_FragColor = vec4(-currentPixelDepth/1000.0);
        //gl_FragColor = vec4(tapPixelPos.x/100.0);
        gl_FragColor = vec4(A);
      }
    `)),t}var l=Object.freeze({__proto__:null,build:c})},3745:function(e,t,i){"use strict";var r=i("b2b2"),a=i("ecd7"),n=i("1219"),s=i("792b"),o=i("0b2d"),c=i("e431"),l=i("9180"),h=i("8188"),d=i("6655"),u=i("02f1"),p=i("f0b9"),f=i("3349"),m=i("4261"),b=i("1a54"),g=i("e9d6");const v=new a["a"](Array,e=>Object(m["C"])(e,m["c"]),null,10,5),y=Object(l["l"])();class O{constructor(e,t,i,a,n){this._labelGraphics=new Array,this._auxiliaryGraphics=new Array,this._visibilityFlags=_(2,4),this._featureExpressionFeature=null,this._optimizedGeometry={geometry:null,hasZ:!1,hasM:!1},this._extent=null,this.isElevationSource=!1,++t.referenced,this.graphics3DSymbol=t,this.graphic=e,this._graphics=i,this._featureExpressionFeature=n?Object(g["d"])(n,e,a):null;for(const s of this._graphics)Object(r["k"])(s)&&(this.isElevationSource=this.isElevationSource||s.isElevationSource)}get labelGraphics(){return this._labelGraphics}get extent(){return this._extent}initialize(e,t,i){this._layer=t,this._stage=e,this.forEachSymbolLayerGraphic(r=>{r.initialize(e,t,i),r.setVisibility(this.isVisible())})}destroy(){this.forEachSymbolLayerGraphic(e=>e.destroy()),this._graphics=null,this._auxiliaryGraphics=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null}get destroyed(){return null==this._graphics}clearLabelGraphics(){this.forEachLabelGraphic(e=>e.destroy()),this._labelGraphics.length=0}addLabelGraphic(e,t,i){this._labelGraphics.push(e),e.initialize(t,i),e.setVisibility(this.isVisible(1))}addAuxiliaryGraphic(e){this._auxiliaryGraphics.push(e),this._layer&&(e.initialize(this._stage,this._layer),e.setVisibility(this.isVisible()))}get isDraped(){let e=!1;return this.forEachSymbolLayerGraphic(t=>{"draped"===t.type&&(e=!0)}),e}isVisible(e=0,t){for(let i=0;i<=e;i++){const e=this._visibilityFlags[i];for(let i=0;i<e.length;++i)if(!1===e[i]&&i!==t)return!1}return!0}hasVisibilityFlag(e,t){return null!=this._visibilityFlags[t][e]}setVisibilityFlag(e,t,i){const r=this.isVisible(i);this._visibilityFlags[i][e]=t;const a=this.isVisible(i);if(r===a)return!1;if(1===i)this.forEachLabelGraphic(e=>e.setVisibility(a));else{this.forEachSymbolLayerGraphic(e=>e.setVisibility(a));const e=this.isVisible(1);this.forEachLabelGraphic(t=>t.setVisibility(e))}return!0}clearVisibilityFlag(e,t=0){return this.setVisibilityFlag(e,void 0,t)}getBSRadius(){let e=0;return this.forEachSymbolLayerGraphic(t=>{e=Math.max(e,t.getBSRadius())}),e}getCenterObjectSpace(e=Object(o["e"])()){if(0===this._graphics.length)return Object(c["x"])(e,0,0,0),e;const t=this._graphics[0];return Object(r["k"])(t)?t.getCenterObjectSpace(e):e}computeExtent(e){if(!this._extent){const t=this.graphic.geometry;if(Object(r["j"])(t))return!1;this._extent=Object(l["l"])(),Object(b["d"])(t,this._extent);const i=t.spatialReference;if(!i.equals(e)&&!Object(h["o"])(this._extent,i,this._extent,e))return this._extent=null,!1}return!0}getAsOptimizedGeometry(e,t){return this._optimizedGeometry.geometry&&this._optimizedGeometry.hasZ===e&&this._optimizedGeometry.hasM===t||(this._optimizedGeometry.geometry=this._convertGraphicToOptimizedGeometry(this.graphic,e,t),this._optimizedGeometry.hasZ=e,this._optimizedGeometry.hasM=t),this._optimizedGeometry.geometry}_convertGraphicToOptimizedGeometry(e,t,i){let r=e.geometry;return"mesh"!==r.type&&"extent"!==r.type||(r=n["a"].fromExtent("mesh"===r.type?r.extent:r)),Object(d["d"])(r,t,i)}get usedMemory(){let e=Object(p["a"])(this.graphic.attributes);return this.forEachSymbolLayerGraphic(t=>{const i=t.graphics3DSymbolLayer.complexity;if(Object(r["j"])(i))return;const a="draped"===t.type?i.memory.draped:i.memory;e+=a.bytesPerFeature,a.bytesPerCoordinate&&(e+=Object(b["l"])(this.graphic.geometry)*a.bytesPerCoordinate)}),e}computeAttachmentOrigin(){const e={render:{origin:Object(o["e"])(),num:0},draped:{origin:Object(u["b"])(),num:0}};for(const t of this._graphics)Object(r["j"])(t)||t.computeAttachmentOrigin(e);return e.render.num&&Object(c["f"])(e.render.origin,e.render.origin,1/e.render.num),e.draped.num&&Object(f["a"])(e.draped.origin,e.draped.origin,1/e.draped.num),e}async getProjectedBoundingBox(e,t,i,a,n){return n||(n={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),n.boundingBox?Object(m["k"])(n.boundingBox):n.boundingBox=Object(m["k"])(),n.requiresDrapedElevation=!1,await Object(s["b"])(this._graphics,async s=>{if(Object(r["j"])(s))return;const o="draped"===s.type?t:e,c=v.acquire(),l=await s.getProjectedBoundingBox(o,i,n.screenSpaceObjects,a,c);isFinite(l[2])&&isFinite(l[5])||(n.requiresDrapedElevation=!0),l&&Object(m["m"])(n.boundingBox,c),v.release(c)}),Object(m["d"])(n.boundingBox)||Object(l["c"])(Object(m["G"])(n.boundingBox,y))?n:null}needsElevationUpdates(){for(const e of this._graphics)if(Object(r["k"])(e)&&("object3d"===e.type||"lod-instance"===e.type)&&e.needsElevationUpdates)return!0;for(const e of this._labelGraphics)if(e&&e.needsElevationUpdates)return!0;return!1}alignWithElevation(e,t,i){this.forEachRenderedGraphic(r=>{"object3d"!==r.type&&"lod-instance"!==r.type||r.alignWithElevation(e,t,this._featureExpressionFeature,i)})}addObjectStateSet(e,t){this.forEachSymbolLayerGraphic(i=>i.addObjectState(e,t))}removeObjectState(e){this.forEachSymbolLayerGraphic(t=>t.removeObjectState(e))}forEachGraphicList(e,t){e.forEach(e=>e&&t(e))}forEachSymbolLayerGraphic(e){this.forEachGraphicList(this._graphics,e),this.forEachGraphicList(this._auxiliaryGraphics,e)}forEachLabelGraphic(e){this.forEachGraphicList(this._labelGraphics,e)}forEachRenderedGraphic(e){this.forEachSymbolLayerGraphic(e),this.forEachLabelGraphic(e)}}function _(e,t){const i=new Array(e);for(let r=0;r<i.length;r++)i[r]=new Array(t);return i}t["a"]=O},3748:function(e,t,i){"use strict";i.d(t,"a",(function(){return I}));var r=i("b2b2"),a=i("e92d"),n=i("a915"),s=i("0b2d"),o=i("e431"),c=i("3349"),l=i("55e6"),h=i("d0ac"),d=i("1153"),u=i("1038"),p=i("b623"),f=i("d7f7"),m=i("7c51"),b=i("35b3"),g=i("5957"),v=i("8675"),y=i("a4ee"),O=i("c3a4"),_=i("ca98"),x=i("da35"),j=i("fa1e"),w=i("8e37"),S=i("189c"),C=i("8e97"),T=i("d272"),P=i("6a07"),A=i("87b7"),R=i("713b");class M extends _["a"]{constructor(e,t){super(e,t),this.stipplePattern=null,this.stippleTextureBind=null,this.stippleTextureRepository=e.stippleTextureRepository}initializeProgram(e){const t=M.shader.get(),i=this.configuration,r=t.build({output:i.output,attributeColor:i.vertexColors,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,stippleEnabled:i.stippleEnabled,stippleOffColorEnabled:i.stippleOffColorEnabled,stippleUVMaxEnabled:!1,stippleIntegerRepeatsEnabled:i.stippleIntegerRepeatsEnabled});return new w["a"](e.rctx,r.generateSource("vertex"),r.generateSource("fragment"),j["a"])}dispose(){super.dispose(),this.stippleTextureRepository.release(this.stipplePattern),this.stipplePattern=null,this.stippleTextureBind=null}bindPass(e,t,i){if(C["a"].bindProjectionMatrix(this.program,i.camera.projectionMatrix),this.stipplePattern!==t.stipplePattern){const e=t.stipplePattern;this.stippleTextureBind=this.stippleTextureRepository.swap(this.stipplePattern,e),this.stipplePattern=e}if(this.configuration.stippleEnabled){const t=Object(r["k"])(this.stippleTextureBind)?this.stippleTextureBind(e,0)*i.camera.pixelRatio:1;this.program.setUniform1i("stipplePatternTexture",0),this.program.setUniform1f("stipplePatternPixelSizeInv",1/t),this.program.setUniform2f("ndcToPixel",i.camera.fullViewport[2]/2,i.camera.fullViewport[3]/2)}if(this.program.setUniform4fv("constantColor",t.color),this.program.setUniform1f("alphaCoverage",Math.min(1,t.width*i.camera.pixelRatio)),this.configuration.stippleOffColorEnabled){const e=Object(r["t"])(t.stippleOffColor);this.program.setUniform4f("stippleOffColor",e[0],e[1],e[2],e.length>3?e[3]:1)}4===this.configuration.output&&P["a"].bindOutputHighlight(e,this.program,i)}bindDraw(e){C["a"].bindView(this.program,e),T["a"].bindUniformsWithOrigin(this.program,this.configuration,e)}initializePipeline(){const e=this.configuration,t=Object(S["f"])(770,1,771,771),i=(t,i=null,r=null)=>Object(S["e"])({blending:i,depthTest:A["b"],depthWrite:r,colorWrite:S["c"],stencilWrite:e.sceneHasOcludees?A["j"]:null,stencilTest:e.sceneHasOcludees?t?A["f"]:A["e"]:null});return 0===e.output?(this._occludeePipelineState=i(!0,e.transparent||e.stippleEnabled?t:null,S["d"]),i(!1,e.transparent||e.stippleEnabled?t:null,S["d"])):i(!1)}get primitiveType(){return 1}getPipelineState(e){return e?this._occludeePipelineState:this.pipeline}}M.shader=new O["a"](R["a"],()=>i.e("chunk-2d20f1b1").then(i.bind(null,"b1e1")));class E extends x["a"]{constructor(){super(...arguments),this.output=0,this.slicePlaneEnabled=!1,this.vertexColors=!1,this.transparent=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stippleIntegerRepeatsEnabled=!1,this.sceneHasOcludees=!1}}Object(y["a"])([Object(x["b"])({count:8})],E.prototype,"output",void 0),Object(y["a"])([Object(x["b"])()],E.prototype,"slicePlaneEnabled",void 0),Object(y["a"])([Object(x["b"])()],E.prototype,"vertexColors",void 0),Object(y["a"])([Object(x["b"])()],E.prototype,"transparent",void 0),Object(y["a"])([Object(x["b"])()],E.prototype,"stippleEnabled",void 0),Object(y["a"])([Object(x["b"])()],E.prototype,"stippleOffColorEnabled",void 0),Object(y["a"])([Object(x["b"])()],E.prototype,"stippleIntegerRepeatsEnabled",void 0),Object(y["a"])([Object(x["b"])()],E.prototype,"sceneHasOcludees",void 0);const D=a["a"].getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial");class I extends b["a"]{constructor(e){super(e,k),this.techniqueConfig=new E}getTechniqueConfig(e){this.techniqueConfig.output=e,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.vertexColors=this.params.vertexColors,this.techniqueConfig.transparent=this.params.color[3]<1||this.params.width<1;const t=Object(r["k"])(this.params.stipplePattern);return this.techniqueConfig.stippleEnabled=t,this.techniqueConfig.stippleOffColorEnabled=t&&Object(r["k"])(this.params.stippleOffColor),this.techniqueConfig.stippleIntegerRepeatsEnabled=t&&this.params.stippleIntegerRepeats,this.techniqueConfig.sceneHasOcludees=this.params.sceneHasOcludees,this.techniqueConfig}getPassParameters(){return this.params}intersect(e,t,i,r,a,n,s,o,c){c?Object(m["h"])(e,r,n,1,s):this.intersectLineGeometry(e,t,i,r,s)}intersectLineGeometry(e,t,i,r,a){if(!r.options.selectionMode||Object(p["e"])(t))return;if(!Object(d["g"])(i))return void D.error("intersection assumes a translation-only matrix");const n=e.vertexAttributes.get("position").data,s=r.camera,l=$;Object(c["c"])(l,r.point);const u=2;Object(o["x"])(Q[0],l[0]-u,l[1]+u,0),Object(o["x"])(Q[1],l[0]+u,l[1]+u,0),Object(o["x"])(Q[2],l[0]+u,l[1]-u,0),Object(o["x"])(Q[3],l[0]-u,l[1]-u,0);for(let o=0;o<4;o++)if(!s.unprojectFromRenderScreen(Q[o],X[o]))return;h["f"].fromPoints(s.eye,X[0],X[1],Y),h["f"].fromPoints(s.eye,X[1],X[2],K),h["f"].fromPoints(s.eye,X[2],X[3],J),h["f"].fromPoints(s.eye,X[3],X[0],ee);let f=Number.MAX_VALUE;for(let c=0;c<n.length-5;c+=3){if(F[0]=n[c]+i[12],F[1]=n[c+1]+i[13],F[2]=n[c+2]+i[14],z[0]=n[c+3]+i[12],z[1]=n[c+4]+i[13],z[2]=n[c+5]+i[14],h["f"].signedDistance(Y,F)<0&&h["f"].signedDistance(Y,z)<0||h["f"].signedDistance(K,F)<0&&h["f"].signedDistance(K,z)<0||h["f"].signedDistance(J,F)<0&&h["f"].signedDistance(J,z)<0||h["f"].signedDistance(ee,F)<0&&h["f"].signedDistance(ee,z)<0)continue;if(s.projectToRenderScreen(F,B),s.projectToRenderScreen(z,H),B[2]<0&&H[2]>0){Object(o["k"])(U,F,z);const e=s.frustum,t=-h["f"].signedDistance(e[4],F)/Object(o["i"])(U,h["f"].normal(e[4]));Object(o["f"])(U,U,t),Object(o["g"])(F,F,U),s.projectToRenderScreen(F,B)}else if(B[2]>0&&H[2]<0){Object(o["k"])(U,z,F);const e=s.frustum,t=-h["f"].signedDistance(e[4],z)/Object(o["i"])(U,h["f"].normal(e[4]));Object(o["f"])(U,U,t),Object(o["g"])(z,z,U),s.projectToRenderScreen(z,H)}else if(B[2]<0&&H[2]<0)continue;B[2]=0,H[2]=0;const e=h["e"].distance2(h["e"].fromPoints(B,H,W),l);e<f&&(f=e,Object(o["l"])(N,F),Object(o["l"])(q,z))}const m=r.rayBeginPoint,b=r.rayEndPoint;if(f<u*u){let e=Number.MAX_VALUE;if(h["e"].closestLineSegmentPoint(h["e"].fromPoints(N,q,W),h["e"].fromPoints(m,b,Z),G)){Object(o["k"])(G,G,m);const t=Object(o["q"])(G);Object(o["f"])(G,G,1/t),e=t/Object(o["p"])(m,b)}a(e,G)}}computeAttachmentOrigin(e,t){const i=e.vertexAttributes;if(!i)return!1;const r=i.get("position");return Object(u["a"])(r,null,!1,t)}createBufferWriter(){const e=this.params.vertexColors?v["b"]:v["c"];return Object(r["j"])(this.params.stipplePattern)?new v["a"](e):new V(e.clone().vec3f("auxpos1"))}getGLMaterial(e){return 0===e.output||4===e.output?new L(e):void 0}}class L extends f["a"]{constructor(e){super(e),this.updateParameters()}updateParameters(){this.technique=this.techniqueRep.acquireAndReleaseExisting(M,this.material.getTechniqueConfig(this.output),this.technique)}beginSlot(e){return 3===e}_updateOccludeeState(e){e.hasOccludees!==this.material.params.sceneHasOcludees&&(this.material.setParameterValues({sceneHasOcludees:e.hasOccludees}),this.updateParameters())}ensureParameters(e){0===this.output&&this._updateOccludeeState(e)}bind(e,t){e.bindProgram(this.technique.program),this.technique.bindPass(e,this.material.getPassParameters(),t)}getPipelineState(e,t){return this.technique.getPipelineState(t)}}class V{constructor(e){this.vertexBufferLayout=e}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get("position").length}write(e,t,i,r){Object(g["c"])(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,i,r),this.writeAuxpos1(e,t,i,r)}writeAuxpos1(e,t,i,r){const a=i.getField("auxpos1",l["u"]),n=t.indices.get("position"),s=t.vertexAttributes.get("position").data,o=e.transformation,c=a.typedBufferStride,h=a.typedBuffer;r*=c;for(let l=0;l<n.length;l+=2){const e=3*n[l],t=s[e],i=s[e+1],a=s[e+2],d=o[0]*t+o[4]*i+o[8]*a+o[12],u=o[1]*t+o[5]*i+o[9]*a+o[13],p=o[2]*t+o[6]*i+o[10]*a+o[14];for(let n=0;n<2;++n)h[r]=d,h[r+1]=u,h[r+2]=p,r+=c}}}const k={color:[1,1,1,1],vertexColors:!1,slicePlaneEnabled:!1,width:1,stipplePattern:null,stippleIntegerRepeats:!1,stippleOffColor:null,sceneHasOcludees:!1,...b["b"]},F=Object(s["e"])(),z=Object(s["e"])(),U=Object(s["e"])(),G=Object(s["e"])(),B=Object(n["e"])(),H=Object(n["e"])(),N=Object(s["e"])(),q=Object(s["e"])(),W=h["e"].create(),Z=h["e"].create(),$=Object(s["e"])(),Q=[Object(n["e"])(),Object(n["e"])(),Object(n["e"])(),Object(n["e"])()],X=[Object(s["e"])(),Object(s["e"])(),Object(s["e"])(),Object(s["e"])()],Y=h["f"].create(),K=h["f"].create(),J=h["f"].create(),ee=h["f"].create()},"377b":function(e,t,i){"use strict";i.d(t,"a",(function(){return c}));i("c120");var r=i("8e37"),a=i("7ce4"),n=i("a1ff"),s=i("0fa6"),o=i("d267");async function c(e){const t=new Image;if(t.src="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='5' height='5' version='1.1' viewBox='0 0 5 5' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='5' height='5' fill='%23f00' fill-opacity='.5'/%3E%3C/svg%3E%0A",t.width=5,t.height=5,await t.decode(),!e.gl)return!0;const i=new o["a"](e,{colorTarget:0,depthStencilTarget:0},{target:3553,wrapMode:33071,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1}),c=a["a"].createVertex(e,35044,new Uint16Array([0,0,1,0,0,1,1,1])),l=new s["a"](e,{a_pos:0},{geometry:[{name:"a_pos",count:2,type:5123,offset:0,stride:4,normalized:!1}]},{geometry:c}),h=new r["a"](e,"\n  precision highp float;\n\n  attribute vec2 a_pos;\n  varying vec2 v_uv;\n\n  void main() {\n    v_uv = a_pos;\n    gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);\n  }\n  ","\n  precision highp float;\n\n  varying vec2 v_uv;\n  uniform sampler2D u_texture;\n\n  void main() {\n    gl_FragColor = texture2D(u_texture, v_uv);\n  }\n  ",{a_pos:0});e.bindProgram(h);const d=new n["a"](e,{dataType:5121,pixelFormat:6408,preMultiplyAlpha:!1,wrapMode:33071,samplingMode:9729},t);e.bindTexture(d,0),h.setUniform1i("u_texture",0);const u=e.getBoundFramebufferObject(),{x:p,y:f,width:m,height:b}=e.getViewport();e.bindFramebuffer(i),e.setViewport(0,0,1,1),e.bindVAO(l),e.drawArrays(5,0,4);const g=new Uint8Array(4);return i.readPixels(0,0,1,1,6408,5121,g),h.dispose(),l.dispose(!1),c.dispose(),i.dispose(),d.dispose(),e.setViewport(p,f,m,b),e.bindFramebuffer(u),t.src="",255===g[0]}},"3af9":function(e,t,i){"use strict";i.d(t,"a",(function(){return j}));var r=i("a4ee"),a=(i("c120"),i("7ffa")),n=i("b2b2"),s=(i("e92d"),i("cea0"),i("59b2")),o=i("d386"),c=i("ce50"),l=(i("e041"),i("8eed"),i("f402"),i("b50f")),h=i("f4cc"),d=i("fc29"),u=i("2eab"),p=i("9305"),f=i("1153");class m{constructor(e){this.client=e,this._cancelled=!1,this.size=0,this.duration=0}}class b{constructor(e){this.typeWorkerQuota=e,this.tasks=new Array,this.numWorkers=0,this.statistics=new g}}class g{constructor(){this.requests=0,this.size=0,this.duration=0,this.speed=0}}class v{constructor(e,t,i,r){this._workerFunc=e,this._callbackFunc=t,this._maxTotalNumWorkers=i,this._totalNumWorkers=0,this._clients=r.map(e=>new b(e))}hasQuota(e){const t=this._clients[e];return!!t&&(this._totalNumWorkers<this._maxTotalNumWorkers||t.numWorkers+t.tasks.length<t.typeWorkerQuota)}push(e){const t=this._clients[e.client];t&&(this._totalNumWorkers<this._maxTotalNumWorkers?(t.numWorkers++,this._totalNumWorkers++,this._workerFunc(e,(e,t)=>this._taskCallback(e,t))):t.tasks.push(e))}cancel(e){this._taskFinished(e),e._cancelled=!0}destroy(){this._clients.length=0}_taskFinished(e){const t=this._clients[e.client];this._totalNumWorkers--,t.numWorkers--,t.statistics.requests++,t.statistics.size+=e.size||0,t.statistics.duration+=e.duration||0,t.statistics.speed=t.statistics.duration>0?t.statistics.size/t.statistics.duration:0,Object(f["a"])(t.numWorkers>=0),this._next()}_next(){for(const e of this._clients)if(e&&e.numWorkers<e.typeWorkerQuota&&this._processQueue(e))return;for(const e of this._clients)if(e&&this._processQueue(e))return}_processQueue(e){for(;e.tasks.length>0;)if(this._workerFunc(e.tasks.shift(),(e,t)=>this._taskCallback(e,t)))return e.numWorkers++,this._totalNumWorkers++,!0;return!1}_taskCallback(e,t){e._cancelled||(this._callbackFunc(e,t),this._taskFinished(e))}getStatsForType(e){const t=this._clients[e];return t?{quota:t.typeWorkerQuota,workers:t.numWorkers,queueSize:t.tasks.length,requestStats:t.statistics}:null}get test(){const e=this;return{set workerFunc(t){e._workerFunc=t}}}}class y extends m{constructor(e,t,i,r,a){super(r),this.url=e,this.options=t,this.docType=i,this.key=a,this.result=null,this.status=1,this.request=null,this.abortController=null,this.resolvers=new Array,this.startTime=0}}var O=y;let _=class extends d["a"]{constructor(){super(...arguments),this.tasks=new Map,this.onLoadQueue=new Array,this.doneQueue=new Array,this.updating=!1}setup(e,t,i){this.loadQueue=new v((e,t)=>this.startLoading(e,t),(e,t)=>this.doneLoadingCallback(e,t),e,t),i&&(this.taskHandle=i.registerTask(p["b"].STREAM_DATA_LOADER,e=>this.update(e),()=>this.doneQueue.length>0||this.onLoadQueue.length>0))}destroy(){this.taskHandle&&(this.taskHandle.remove(),this.taskHandle=null),this.tasks.forEach(e=>{e.abortController&&e.abortController.abort()}),this.loadQueue.destroy(),this.loadQueue=null,this.onLoadQueue=null,this.doneQueue=null,this.tasks=null}hasDownloadSlots(e){return this.loadQueue.hasQuota(e)}request(e,t,i,r={}){const a=Object(h["h"])();a.__signal=Object(n["k"])(r)?r.signal:null;const s=this.createOrUpdateTask(e,t,i,r,a);return Object(h["r"])(r,()=>this.cancelRequest(s,a)),a.promise}createTask(e,t,i,r,a,n){const s=new O(e,t,i,r,a);return this.updateTask(s,n),this.tasks.set(a,s),1===this.tasks.size&&this._set("updating",!0),this.loadQueue.push(s),s}cancelRequest(e,t){Object(l["l"])(e.resolvers,t),t.reject(Object(h["f"])()),0===e.resolvers.length&&(2===e.status&&(e.status=4,this.loadQueue.cancel(e),e.abortController.abort(),e.request=null,e.abortController=null),e.status=4,this.tasks.delete(e.key),0===this.tasks.size&&this._set("updating",!1))}taskKey(e,t,i){return`${e}:${t}:${i}`}updateTask(e,t){e.resolvers.push(t)}createOrUpdateTask(e,t,i,r,a){const s=Object(n["k"])(r)&&r.uid||e,o=this.taskKey(s,t,i),c=this.tasks.get(o);return c?(this.updateTask(c,a),c):this.createTask(e,r,t,i,o,a)}doneLoadingCallback(e,t){this.loadQueue&&(Object(f["a"])(2===e.status),e.status=3,this.taskHandle?this.doneQueue.push({task:e,err:t}):this.doneLoading(e,t))}update(e){for(;!e.done&&this.onLoadQueue.length>0;){const t=this.onLoadQueue.shift();Object(h["w"])(t.task.abortController),t.task.abortController=null,t.callback(t.task),e.madeProgress()}for(;!e.done&&this.doneQueue.length>0;){const t=this.doneQueue.shift();3!==t.task.status&&(t.err=t.err||Object(h["f"])()),this.doneLoading(t.task,t.err),e.madeProgress()}}doneLoading(e,t){let i=e.result instanceof HTMLImageElement?0:e.resolvers.length;for(const r of e.resolvers)if(t)Object(h["n"])(t)?r.reject(t):r.reject(new c["a"]("stream-data-loader:request-error",`Failed to request resource at '${e.url}'. ${t}`,{url:e.url,error:t}));else{--i;const t=i<=0?e.result:Object(a["a"])(e.result);r.resolve(t)}this.tasks.delete(e.key),0===this.tasks.size&&this._set("updating",!1)}startLoading(e,t){if(4===e.status)return!1;let i,r;switch(e.startTime=performance.now(),e.status=2,e.docType){case"binary":r="array-buffer",i=0;break;case"image":r="image";break;case"image+type":r="array-buffer";break;default:r="json"}e.abortController=Object(h["e"])();const a=e.abortController.signal;e.request=Object(u["default"])(e.url,{...e.options,responseType:r,timeout:i,signal:a});let n=()=>{};const s=i=>{e.duration=performance.now()-e.startTime,e.size=i instanceof ArrayBuffer?i.byteLength:e.size||0,e.result=i,this.taskHandle?this.onLoadQueue.push({callback:t,task:e}):(e.abortController=null,t(e))},o=i=>{2===e.status&&t(e,i),n()};return"image+type"!==e.docType?(e.request.then(e=>s(e.data),o),!0):(e.request.then(t=>{const c=t.data,l=x(c);if(r="image",e.size=c.byteLength,"unknown"===l)return e.request=Object(u["default"])(e.url,{responseType:r,timeout:i,signal:a}),void e.request.then(e=>s(e.data),o);const h=new Blob([c],{type:l}),d=window.URL.createObjectURL(h);n=()=>window.URL.revokeObjectURL(d),e.request=Object(u["default"])(d,{responseType:r,timeout:i,signal:a}),e.request.then(e=>s(new j(e.data,l,n)),o)},o),!0)}get test(){return{loadQueue:this.loadQueue}}};function x(e){if(e.byteLength<2)return"unknown";const t=new Uint8Array(e,0,e.byteLength);return 137===t[0]&&80===t[1]?"image/png":71===t[0]&&73===t[1]?"image/gif":66===t[0]&&77===t[1]?"image/bmp":255===t[0]&&216===t[1]?"image/jpeg":"unknown"}Object(r["a"])([Object(s["b"])({readOnly:!0})],_.prototype,"updating",void 0),_=Object(r["a"])([Object(o["a"])("esri.views.3d.support.StreamDataLoader")],_);class j{constructor(e,t,i){this.image=e,this.type=t,this.release=i}get isOpaque(){return"image/jpeg"===this.type}}var w=_;t["b"]=w},"3b19":function(e,t,i){"use strict";i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return o})),i.d(t,"c",(function(){return r})),i.d(t,"d",(function(){return a})),i.d(t,"e",(function(){return u})),i.d(t,"f",(function(){return d})),i.d(t,"g",(function(){return l})),i.d(t,"h",(function(){return h}));const r=Number.POSITIVE_INFINITY,a=Math.PI,n=2*a,s=128/a,o=a/180,c=1/Math.LN2;function l(e,t){return(e%=t)>=0?e:e+t}function h(e){return l(e*s,256)}function d(e){return Math.log(e)*c}function u(e,t,i){return e*(1-i)+t*i}},"3c3b":function(e,t,i){"use strict";i.d(t,"a",(function(){return U}));var r=i("b2b2"),a=i("afe1"),n=i("e92d"),s=i("ce50");const o=n["a"].getLogger("esri.views.3d.glTF");class c{error(e){throw new s["a"]("gltf-loader-error",e)}errorUnsupported(e){throw new s["a"]("gltf-loader-unsupported-feature",e)}errorUnsupportedIf(e,t){e&&this.errorUnsupported(t)}assert(e,t){e||this.error(t)}warn(e){o.warn(e)}warnUnsupported(e){this.warn("[Unsupported Feature] "+e)}warnUnsupportedIf(e,t){e&&this.warnUnsupported(t)}}function l(e={}){return{color:[1,1,1],opacity:1,alphaMode:"OPAQUE",alphaCutoff:.5,doubleSided:!1,castShadows:!0,receiveShadows:!0,receiveAmbientOcclustion:!0,textureColor:null,textureNormal:null,textureOcclusion:null,textureEmissive:null,textureMetallicRoughness:null,emissiveFactor:[0,0,0],metallicFactor:1,roughnessFactor:1,colorMixMode:"multiply",...e}}function h(e,t={}){return{data:e,parameters:{wrap:{s:10497,t:10497,...t.wrap},noUnpackFlip:!0,mipmap:!1,...t}}}var d=i("6c97"),u=i("e041"),p=i("549a"),f=i("d791"),m=i("b139"),b=i("55e6"),g=i("04f0");class v{constructor(e){this.data=e,this.offset4=0,this.dataUint32=new Uint32Array(this.data,0,Math.floor(this.data.byteLength/4))}readUint32(){const e=this.offset4;return this.offset4+=1,this.dataUint32[e]}readUint8Array(e){const t=4*this.offset4;return this.offset4+=e/4,new Uint8Array(this.data,t,e)}remainingBytes(){return this.data.byteLength-4*this.offset4}}const y={baseColorFactor:[1,1,1,1],metallicFactor:1,roughnessFactor:1},O={pbrMetallicRoughness:y,emissiveFactor:[0,0,0],alphaMode:"OPAQUE",alphaCutoff:.5,doubleSided:!1},_={ESRI_externalColorMixMode:"tint"},x=(e={})=>{const t={...y,...e.pbrMetallicRoughness},i=j({..._,...e.extras});return{...O,...e,pbrMetallicRoughness:t,extras:i}};function j(e){switch(e.ESRI_externalColorMixMode){case"multiply":case"tint":case"ignore":case"replace":break;default:Object(d["a"])(e.ESRI_externalColorMixMode),e.ESRI_externalColorMixMode="tint"}return e}const w={magFilter:9729,minFilter:9987,wrapS:10497,wrapT:10497},S=e=>({...w,...e});function C(e){let t,i;return e.replace(/^(.*\/)?([^/]*)$/,(e,r,a)=>(t=r||"",i=a||"","")),{dirPart:t,filePart:i}}var T=i("7cfb");const P={MAGIC:1179937895,CHUNK_TYPE_JSON:1313821514,CHUNK_TYPE_BIN:5130562,MIN_HEADER_LENGTH:20};class A{constructor(e,t,i,r,a){this.context=e,this.errorContext=t,this.uri=i,this.json=r,this.glbBuffer=a,this.bufferCache=new Map,this.textureCache=new Map,this.materialCache=new Map,this.nodeParentMap=new Map,this.nodeTransformCache=new Map,this.baseUri=C(this.uri).dirPart,this.checkVersionSupported(),this.checkRequiredExtensionsSupported(),t.errorUnsupportedIf(null==r.scenes,"Scenes must be defined."),t.errorUnsupportedIf(null==r.meshes,"Meshes must be defined"),t.errorUnsupportedIf(null==r.nodes,"Nodes must be defined."),this.computeNodeParents()}static async load(e,t,i,r){if(Object(u["u"])(i)){const r=Object(u["i"])(i);if("model/gltf-binary"!==r.mediaType)try{const a=JSON.parse(r.isBase64?atob(r.data):r.data);return new A(e,t,i,a)}catch{}const a=Object(u["j"])(i);if(A.isGLBData(a))return this.fromGLBData(e,t,i,a)}if(i.endsWith(".gltf")){const a=await e.loadJSON(i,r);return new A(e,t,i,a)}const a=await e.loadBinary(i,r);if(A.isGLBData(a))return this.fromGLBData(e,t,i,a);const n=await e.loadJSON(i,r);return new A(e,t,i,n)}static isGLBData(e){const t=new v(e);return t.remainingBytes()>=4&&t.readUint32()===P.MAGIC}static async fromGLBData(e,t,i,r){const a=await A.parseGLBData(t,r);return new A(e,t,i,a.json,a.binaryData)}static async parseGLBData(e,t){const i=new v(t);e.assert(i.remainingBytes()>=12,"GLB binary data is insufficiently large.");const r=i.readUint32(),a=i.readUint32(),n=i.readUint32();e.assert(r===P.MAGIC,"Magic first 4 bytes do not fit to expected GLB value."),e.assert(t.byteLength>=n,"GLB binary data is smaller than header specifies."),e.errorUnsupportedIf(2!==a,"An unsupported GLB container version was detected. Only version 2 is supported.");let s,o,c=0;for(;i.remainingBytes()>=8;){const t=i.readUint32(),r=i.readUint32();0===c?(e.assert(r===P.CHUNK_TYPE_JSON,"First GLB chunk must be JSON."),e.assert(t>=0,"No JSON data found."),s=await V(i.readUint8Array(t))):1===c?(e.errorUnsupportedIf(r!==P.CHUNK_TYPE_BIN,"Second GLB chunk expected to be BIN."),o=i.readUint8Array(t)):e.warnUnsupported("More than 2 GLB chunks detected. Skipping."),c+=1}return s||e.error("No GLB JSON chunk detected."),{json:s,binaryData:o}}async getBuffer(e,t){const i=this.json.buffers[e],r=this.errorContext;if(null==i.uri)return r.assert(null!=this.glbBuffer,"GLB buffer not present"),this.glbBuffer;let a=this.bufferCache.get(e);if(!a){const n=await this.context.loadBinary(this.resolveUri(i.uri),t);a=new Uint8Array(n),this.bufferCache.set(e,a),r.assert(a.byteLength===i.byteLength,"Buffer byte lengths should match.")}return a}async getAccessor(e,t){const i=this.json.accessors[e],r=this.errorContext;r.errorUnsupportedIf(null==i.bufferView,"Some accessor does not specify a bufferView."),r.errorUnsupportedIf(i.type in["MAT2","MAT3","MAT4"],`AttributeType ${i.type} is not supported`);const a=this.json.bufferViews[i.bufferView],n=await this.getBuffer(a.buffer,t),s=D[i.type],o=I[i.componentType],c=s*o,l=a.byteStride||c;return{raw:n.buffer,byteStride:l,byteOffset:n.byteOffset+(a.byteOffset||0)+(i.byteOffset||0),entryCount:i.count,isDenselyPacked:l===c,componentCount:s,componentByteSize:o,componentType:i.componentType,min:i.min,max:i.max,normalized:!!i.normalized}}async getIndexData(e,t){if(null==e.indices)return null;const i=await this.getAccessor(e.indices,t);if(i.isDenselyPacked)switch(i.componentType){case 5121:return new Uint8Array(i.raw,i.byteOffset,i.entryCount);case 5123:return new Uint16Array(i.raw,i.byteOffset,i.entryCount);case 5125:return new Uint32Array(i.raw,i.byteOffset,i.entryCount)}else switch(i.componentType){case 5121:return Object(T["a"])(this.wrapAccessor(b["l"],i));case 5123:return Object(T["a"])(this.wrapAccessor(b["j"],i));case 5125:return Object(T["a"])(this.wrapAccessor(b["k"],i))}}async getPositionData(e,t){const i=this.errorContext;i.errorUnsupportedIf(null==e.attributes.POSITION,"No POSITION vertex data found.");const r=await this.getAccessor(e.attributes.POSITION,t);return i.errorUnsupportedIf(5126!==r.componentType,"Expected type FLOAT for POSITION vertex attribute, but found "+F[r.componentType]),i.errorUnsupportedIf(3!==r.componentCount,"POSITION vertex attribute must have 3 components, but found "+r.componentCount.toFixed()),this.wrapAccessor(b["u"],r)}async getNormalData(e,t){const i=this.errorContext;i.assert(null!=e.attributes.NORMAL,"No NORMAL vertex data found.");const r=await this.getAccessor(e.attributes.NORMAL,t);return i.errorUnsupportedIf(5126!==r.componentType,"Expected type FLOAT for NORMAL vertex attribute, but found "+F[r.componentType]),i.errorUnsupportedIf(3!==r.componentCount,"NORMAL vertex attribute must have 3 components, but found "+r.componentCount.toFixed()),this.wrapAccessor(b["u"],r)}async getTangentData(e,t){const i=this.errorContext;i.assert(null!=e.attributes.TANGENT,"No TANGENT vertex data found.");const r=await this.getAccessor(e.attributes.TANGENT,t);return i.errorUnsupportedIf(5126!==r.componentType,"Expected type FLOAT for TANGENT vertex attribute, but found "+F[r.componentType]),i.errorUnsupportedIf(4!==r.componentCount,"TANGENT vertex attribute must have 4 components, but found "+r.componentCount.toFixed()),new b["C"](r.raw,r.byteOffset,r.byteStride,r.byteOffset+r.byteStride*r.entryCount)}async getTextureCoordinates(e,t){const i=this.errorContext;i.assert(null!=e.attributes.TEXCOORD_0,"No TEXCOORD_0 vertex data found.");const r=await this.getAccessor(e.attributes.TEXCOORD_0,t);return i.errorUnsupportedIf(2!==r.componentCount,"TEXCOORD_0 vertex attribute must have 2 components, but found "+r.componentCount.toFixed()),5126===r.componentType?this.wrapAccessor(b["m"],r):(i.errorUnsupportedIf(!r.normalized,"Integer component types are only supported for a normalized accessor for TEXCOORD_0."),L(r))}async getVertexColors(e,t){const i=this.errorContext;i.assert(null!=e.attributes.COLOR_0,"No COLOR_0 vertex data found.");const r=await this.getAccessor(e.attributes.COLOR_0,t);if(i.errorUnsupportedIf(4!==r.componentCount&&3!==r.componentCount,"COLOR_0 attribute must have 3 or 4 components, but found "+r.componentCount.toFixed()),4===r.componentCount){if(5126===r.componentType)return this.wrapAccessor(b["C"],r);if(5121===r.componentType)return this.wrapAccessor(b["J"],r);if(5123===r.componentType)return this.wrapAccessor(b["H"],r)}else if(3===r.componentCount){if(5126===r.componentType)return this.wrapAccessor(b["u"],r);if(5121===r.componentType)return this.wrapAccessor(b["B"],r);if(5123===r.componentType)return this.wrapAccessor(b["z"],r)}i.errorUnsupported("Unsupported component type for COLOR_0 attribute: "+F[r.componentType])}hasPositions(e){return void 0!==e.attributes.POSITION}hasNormals(e){return void 0!==e.attributes.NORMAL}hasVertexColors(e){return void 0!==e.attributes.COLOR_0}hasTextureCoordinates(e){return void 0!==e.attributes.TEXCOORD_0}hasTangents(e){return void 0!==e.attributes.TANGENT}async getMaterial(e,t,i){const r=this.errorContext;let a=this.materialCache.get(e.material);if(!a){const n=null!=e.material?x(this.json.materials[e.material]):x(),s=n.pbrMetallicRoughness,o=this.hasVertexColors(e);let c,l,h,d,u;s.baseColorTexture&&(r.errorUnsupportedIf(0!==(s.baseColorTexture.texCoord||0),"Only TEXCOORD with index 0 is supported."),c=await this.getTexture(s.baseColorTexture.index,t)),n.normalTexture&&(0!==(n.normalTexture.texCoord||0)?r.warnUnsupported("Only TEXCOORD with index 0 is supported for the normal map texture."):l=await this.getTexture(n.normalTexture.index,t)),n.occlusionTexture&&i&&(0!==(n.occlusionTexture.texCoord||0)?r.warnUnsupported("Only TEXCOORD with index 0 is supported for the occlusion texture."):h=await this.getTexture(n.occlusionTexture.index,t)),n.emissiveTexture&&i&&(0!==(n.emissiveTexture.texCoord||0)?r.warnUnsupported("Only TEXCOORD with index 0 is supported for the emissive texture."):d=await this.getTexture(n.emissiveTexture.index,t)),s.metallicRoughnessTexture&&i&&(0!==(s.metallicRoughnessTexture.texCoord||0)?r.warnUnsupported("Only TEXCOORD with index 0 is supported for the metallicRoughness texture."):u=await this.getTexture(s.metallicRoughnessTexture.index,t));const p=null!=e.material?e.material:-1;a={alphaMode:n.alphaMode,alphaCutoff:n.alphaCutoff,color:s.baseColorFactor,doubleSided:!!n.doubleSided,colorTexture:c,normalTexture:l,name:n.name,id:p,occlusionTexture:h,emissiveTexture:d,emissiveFactor:n.emissiveFactor,metallicFactor:s.metallicFactor,roughnessFactor:s.roughnessFactor,metallicRoughnessTexture:u,vertexColors:o,ESRI_externalColorMixMode:n.extras.ESRI_externalColorMixMode}}return a}async getTexture(e,t){const i=this.errorContext,r=this.json.textures[e],a=S(null!=r.sampler?this.json.samplers[r.sampler]:{});i.errorUnsupportedIf(null==r.source,"Source is expected to be defined for a texture.");const n=this.json.images[r.source];let s=this.textureCache.get(e);if(!s){let r;if(n.uri)r=await this.context.loadImage(this.resolveUri(n.uri),t);else{i.errorUnsupportedIf(null==n.bufferView,"Image bufferView must be defined."),i.errorUnsupportedIf(null==n.mimeType,"Image mimeType must be defined.");const e=this.json.bufferViews[n.bufferView],a=await this.getBuffer(e.buffer,t);i.errorUnsupportedIf(null!=e.byteStride,"byteStride not supported for image buffer"),r=await k(new Uint8Array(a.buffer,a.byteOffset+(e.byteOffset||0),e.byteLength),n.mimeType)}s={data:r,wrapS:a.wrapS,wrapT:a.wrapT,minFilter:a.minFilter,name:n.name,id:e},this.textureCache.set(e,s)}return s}getNodeTransform(e){if(void 0===e)return M;let t=this.nodeTransformCache.get(e);if(!t){const i=this.getNodeTransform(this.getNodeParent(e)),r=this.json.nodes[e];r.matrix?t=Object(f["m"])(Object(a["b"])(),i,r.matrix):r.translation||r.rotation||r.scale?(t=Object(a["c"])(i),r.translation&&Object(f["t"])(t,t,r.translation),r.rotation&&(E[3]=Object(g["c"])(E,r.rotation),Object(f["r"])(t,t,E[3],E)),r.scale&&Object(f["s"])(t,t,r.scale)):t=i,this.nodeTransformCache.set(e,t)}return t}wrapAccessor(e,t){return new e(t.raw,t.byteOffset,t.byteStride,t.byteOffset+t.byteStride*(t.entryCount-1)+t.componentByteSize*t.componentCount)}resolveUri(e){return Object(u["z"])(e,this.baseUri)}getNodeParent(e){return this.nodeParentMap.get(e)}checkVersionSupported(){const e=p["a"].parse(this.json.asset.version,"glTF");R.validate(e)}checkRequiredExtensionsSupported(){const e=this.json,t=this.errorContext;e.extensionsRequired&&0!==e.extensionsRequired.length&&t.errorUnsupported("gltf loader was not able to load unsupported feature. Required extensions: "+e.extensionsRequired.join(", "))}computeNodeParents(){this.json.nodes.forEach((e,t)=>{e.children&&e.children.forEach(e=>{this.nodeParentMap.set(e,t)})})}}const R=new p["a"](2,0,"glTF"),M=Object(f["k"])(Object(a["b"])(),Math.PI/2),E=Object(m["a"])(),D={SCALAR:1,VEC2:2,VEC3:3,VEC4:4},I={5120:1,5121:1,5122:2,5123:2,5126:4,5125:4};function L(e){switch(e.componentType){case 5120:return new b["q"](e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);case 5121:return new b["t"](e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);case 5122:return new b["o"](e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);case 5123:return new b["r"](e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);case 5125:return new b["s"](e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);case 5126:return new b["m"](e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);default:return void Object(d["a"])(e.componentType)}}async function V(e){return new Promise((t,i)=>{const r=new Blob([e]),a=new FileReader;a.onload=()=>{const e=a.result;t(JSON.parse(e))},a.onerror=e=>{i(e)},a.readAsText(r)})}async function k(e,t){return new Promise((i,r)=>{const a=new Blob([e],{type:t}),n=URL.createObjectURL(a),s=new Image;s.addEventListener("load",()=>{URL.revokeObjectURL(n),"decode"in s?s.decode().then(()=>i(s),()=>i(s)):i(s)}),s.addEventListener("error",e=>{URL.revokeObjectURL(n),r(e)}),s.src=n})}const F={5120:"BYTE",5121:"UNSIGNED_BYTE",5122:"SHORT",5123:"UNSIGNED_SHORT",5125:"UNSIGNED_INT",5126:"FLOAT"};let z=0;async function U(e,t,i={},n=!0){const s=await A.load(e,Z,t,i),o="gltf_"+z++,c={lods:[],materials:new Map,textures:new Map,meta:B(s)},l=!(!s.json.asset.extras||"symbolResource"!==s.json.asset.extras.ESRI_type);return await H(s,async(e,t,l,h)=>{const d=void 0!==e.mode?e.mode:4,u=G(d);if(Object(r["j"])(u))return void Z.warnUnsupported("Unsupported primitive mode ("+Q[d]+"). Skipping primitive.");if(!s.hasPositions(e))return void Z.warn("Skipping primitive without POSITION vertex attribute.");const p=await s.getMaterial(e,i,n),f={transform:Object(a["c"])(t),attributes:{position:await s.getPositionData(e,i),normal:null,texCoord0:null,color:null,tangent:null},indices:await s.getIndexData(e,i),primitiveType:u,material:q(c,p,o)};s.hasNormals(e)&&(f.attributes.normal=await s.getNormalData(e,i)),s.hasTangents(e)&&(f.attributes.tangent=await s.getTangentData(e,i)),s.hasTextureCoordinates(e)&&(f.attributes.texCoord0=await s.getTextureCoordinates(e,i)),s.hasVertexColors(e)&&(f.attributes.color=await s.getVertexColors(e,i));let m=null;Object(r["k"])(c.meta)&&Object(r["k"])(c.meta.ESRI_lod)&&"screenSpaceRadius"===c.meta.ESRI_lod.metric&&(m=c.meta.ESRI_lod.thresholds[l]),c.lods[l]=c.lods[l]||{parts:[],name:h,lodThreshold:m},c.lods[l].parts.push(f)}),{model:c,meta:{isEsriSymbolResource:l,uri:s.uri},customMeta:{}}}function G(e){switch(e){case 4:case 5:case 6:return e;default:return null}}function B(e){const t=e.json;let i=null;return t.nodes.forEach(e=>{const t=e.extras;Object(r["k"])(t)&&(t.ESRI_proxyEllipsoid||t.ESRI_lod)&&(i=t)}),i}async function H(e,t){const i=e.json,r=i.scenes[i.scene||0].nodes,a=r.length>1;for(const s of r){const e=i.nodes[s],t=[n(s,0)];if(N(e)&&!a){const i=e.extensions.MSFT_lod.ids;t.push(...i.map((e,t)=>n(e,t+1)))}await Promise.all(t)}async function n(r,a){const s=i.nodes[r],o=e.getNodeTransform(r);if(Z.warnUnsupportedIf(null!=s.weights,"Morph targets are not supported."),null!=s.mesh){const e=i.meshes[s.mesh];for(const i of e.primitives)await t(i,o,a,e.name)}for(const e of s.children||[])await n(e,a)}}function N(e){return e.extensions&&e.extensions.MSFT_lod&&Array.isArray(e.extensions.MSFT_lod.ids)}function q(e,t,i){const r=t=>{const r=`${i}_tex_${t&&t.id}${t&&t.name?"_"+t.name:""}`;if(t&&!e.textures.has(r)){const i=h(t.data,{wrap:{s:W(t.wrapS),t:W(t.wrapT)},mipmap:$.some(e=>e===t.minFilter),noUnpackFlip:!0});e.textures.set(r,i)}return r},a=`${i}_mat_${t.id}_${t.name}`;if(!e.materials.has(a)){const i=l({color:[t.color[0],t.color[1],t.color[2]],opacity:t.color[3],alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided,colorMixMode:t.ESRI_externalColorMixMode,textureColor:t.colorTexture?r(t.colorTexture):void 0,textureNormal:t.normalTexture?r(t.normalTexture):void 0,textureOcclusion:t.occlusionTexture?r(t.occlusionTexture):void 0,textureEmissive:t.emissiveTexture?r(t.emissiveTexture):void 0,textureMetallicRoughness:t.metallicRoughnessTexture?r(t.metallicRoughnessTexture):void 0,emissiveFactor:[t.emissiveFactor[0],t.emissiveFactor[1],t.emissiveFactor[2]],metallicFactor:t.metallicFactor,roughnessFactor:t.roughnessFactor});e.materials.set(a,i)}return a}function W(e){if(33071===e||33648===e||10497===e)return e;Z.error("Unexpected TextureSampler WrapMode: "+e)}const Z=new c,$=[9987,9985],Q=["POINTS","LINES","LINE_LOOP","LINE_STRIP","TRIANGLES","TRIANGLE_STRIP","TRIANGLE_FAN"]},"3e44":function(e,t,i){"use strict";i.d(t,"a",(function(){return o})),i.d(t,"b",(function(){return s}));var r=i("3886"),a=i("690a"),n=i("2aad");function s(){const e=new a["a"];return e.include(n["a"]),e.fragment.uniforms.add("tex","sampler2D"),e.fragment.uniforms.add("color","vec4"),e.fragment.code.add(r["a"]`
    void main() {
      vec4 texColor = texture2D(tex, uv);
      gl_FragColor = texColor * color;
    }
  `),e}var o=Object.freeze({__proto__:null,build:s})},"40b6":function(e,t,i){"use strict";i.d(t,"a",(function(){return u})),i.d(t,"b",(function(){return d})),i.d(t,"c",(function(){return p})),i.d(t,"d",(function(){return h}));var r=i("ce50"),a=i("5996"),n=(i("4ae5"),i("1219"),i("521c"),i("e06a"),i("8048")),s=i("d636");function o(e){if(!e)return null;if(e.isGeographic&&e.wkid){const t=s["c"][e.wkid];if(t)return t}if(e.wkt){const t=s["a"].exec(e.wkt);if(!t||2!==t.length)return null;const i=t[1].split(",");if(!i||i.length<3)return null;const r=parseFloat(i[1]),a=parseFloat(i[2]);return isNaN(r)||isNaN(a)?null:{a:r,f:0===a?0:1/a}}return null}function c(e){return"b"in e&&"eSq"in e&&"radius"in e}function l(e){const t=o(e||a["a"].WGS84);if(c(t))return t;const i=t.a*(1-t.f);return Object.assign(t,{b:i,eSq:1-(i/t.a)**2,radius:(2*t.a+i)/3,densificationRatio:1e4/((2*t.a+i)/3)})}function h(e){return null!==o(e)}function d(e,t="meters"){const i=e,a=e;if(!i&&!a)throw new r["a"]("geodesic-lengths:invalid-geometries","the input geometries type is not supported");if(i?i.some(e=>!h(e.spatialReference)):a.some(e=>!h(e.spatialReference)))throw new r["a"]("geodesic-lengths:invalid-spatial-reference","the input geometries spatial reference is not supported");const s=[];for(let r=0;r<e.length;r++){const i=e[r],{spatialReference:a}=i,o="polyline"===i.type?i.paths:i.rings;let c=0;for(let e=0;e<o.length;e++){const t=o[e];let i=0;for(let e=1;e<t.length;e++){const r=t[e-1][0],n=t[e][0],s=t[e-1][1],o=t[e][1];if(s!==o||r!==n){const e={distance:null};p(e,[r,s],[n,o],a),i+=e.distance}}c+=i}c=Object(n["c"])(c,"meters",t),s.push(c)}return s}function u(e,t,i,r,a){const n=t[0],o=t[1],c=n*s["d"],h=o*s["d"],d=i*s["d"],{a:u,b:p,f:f}=l(a),m=Math.sin(d),b=Math.cos(d),g=(1-f)*Math.tan(h),v=1/Math.sqrt(1+g*g),y=g*v,O=Math.atan2(g,b),_=v*m,x=_*_,j=1-x,w=j*(u*u-p*p)/(p*p),S=1+w/16384*(4096+w*(w*(320-175*w)-768)),C=w/1024*(256+w*(w*(74-47*w)-128));let T,P,A,R,M=r/(p*S),E=2*Math.PI;for(;Math.abs(M-E)>1e-12;)A=Math.cos(2*O+M),T=Math.sin(M),P=Math.cos(M),R=C*T*(A+C/4*(P*(2*A*A-1)-C/6*A*(4*T*T-3)*(4*A*A-3))),E=M,M=r/(p*S)+R;const D=y*T-v*P*b,I=Math.atan2(y*P+v*T*b,(1-f)*Math.sqrt(x+D*D)),L=Math.atan2(T*m,v*P-y*T*b),V=f/16*j*(4+f*(4-3*j)),k=I/s["d"],F=(c+(L-(1-V)*f*_*(M+V*T*(A+V*P*(2*A*A-1)))))/s["d"];return e[0]=F,e[1]=k,e}function p(e,t,i,r){const a=t[0]*s["d"],n=t[1]*s["d"],o=i[0]*s["d"],c=i[1]*s["d"],{a:h,b:d,f:u,radius:p}=l(r),f=o-a,m=Math.atan((1-u)*Math.tan(n)),b=Math.atan((1-u)*Math.tan(c)),g=Math.sin(m),v=Math.cos(m),y=Math.sin(b),O=Math.cos(b);let _,x,j,w,S,C,T,P,A,R,M=1e3,E=f;do{if(T=Math.sin(E),P=Math.cos(E),j=Math.sqrt(O*T*(O*T)+(v*y-g*O*P)*(v*y-g*O*P)),0===j)return e.distance=0,e.azimuth=void 0,e.reverseAzimuth=void 0,e;S=g*y+v*O*P,C=Math.atan2(j,S),A=v*O*T/j,x=1-A*A,w=S-2*g*y/x,isNaN(w)&&(w=0),R=u/16*x*(4+u*(4-3*x)),_=E,E=f+(1-R)*u*A*(C+R*j*(w+R*S*(2*w*w-1)))}while(Math.abs(E-_)>1e-12&&--M>0);if(0===M){const t=p,i=Math.acos(Math.sin(n)*Math.sin(c)+Math.cos(n)*Math.cos(c)*Math.cos(o-a))*t,r=o-a,l=Math.sin(r)*Math.cos(c),h=Math.cos(n)*Math.sin(c)-Math.sin(n)*Math.cos(c)*Math.cos(r),d=Math.atan2(l,h);return e.azimuth=d/s["d"],e.distance=i,e.reverseAzimuth=void 0,e}const D=x*(h*h-d*d)/(d*d),I=D/1024*(256+D*(D*(74-47*D)-128)),L=d*(1+D/16384*(4096+D*(D*(320-175*D)-768)))*(C-I*j*(w+I/4*(S*(2*w*w-1)-I/6*w*(4*j*j-3)*(4*w*w-3)))),V=Math.atan2(O*Math.sin(E),v*y-g*O*Math.cos(E)),k=Math.atan2(v*Math.sin(E),v*y*Math.cos(E)-g*O);return e.azimuth=V/s["d"],e.distance=L,e.reverseAzimuth=k/s["d"],e}},4261:function(e,t,i){"use strict";i.d(t,"a",(function(){return U})),i.d(t,"b",(function(){return z})),i.d(t,"c",(function(){return G})),i.d(t,"d",(function(){return f})),i.d(t,"e",(function(){return y})),i.d(t,"f",(function(){return j})),i.d(t,"g",(function(){return x})),i.d(t,"h",(function(){return s})),i.d(t,"i",(function(){return b})),i.d(t,"j",(function(){return v})),i.d(t,"k",(function(){return E})),i.d(t,"l",(function(){return k})),i.d(t,"m",(function(){return c})),i.d(t,"n",(function(){return d})),i.d(t,"o",(function(){return p})),i.d(t,"p",(function(){return u})),i.d(t,"q",(function(){return l})),i.d(t,"r",(function(){return h})),i.d(t,"s",(function(){return I})),i.d(t,"t",(function(){return o})),i.d(t,"u",(function(){return P})),i.d(t,"v",(function(){return g})),i.d(t,"w",(function(){return w})),i.d(t,"x",(function(){return S})),i.d(t,"y",(function(){return V})),i.d(t,"z",(function(){return _})),i.d(t,"A",(function(){return C})),i.d(t,"B",(function(){return T})),i.d(t,"C",(function(){return M})),i.d(t,"D",(function(){return R})),i.d(t,"E",(function(){return A})),i.d(t,"F",(function(){return O})),i.d(t,"G",(function(){return D})),i.d(t,"H",(function(){return m})),i.d(t,"I",(function(){return F}));var r=i("b2b2"),a=(i("3af1"),i("9180"));function n(e){return e}function s(e=G){return n([e[0],e[1],e[2],e[3],e[4],e[5]])}function o(e,t,i,r,a,n,o=s()){return o[0]=e,o[1]=t,o[2]=i,o[3]=r,o[4]=a,o[5]=n,o}function c(e,t){e[0]=Math.min(e[0],t[0]),e[1]=Math.min(e[1],t[1]),e[2]=Math.min(e[2],t[2]),e[3]=Math.max(e[3],t[3]),e[4]=Math.max(e[4],t[4]),e[5]=Math.max(e[5],t[5])}function l(e,t){e[0]=Math.min(e[0],t[0]),e[1]=Math.min(e[1],t[1]),e[3]=Math.max(e[3],t[2]),e[4]=Math.max(e[4],t[3])}function h(e,t){e[0]=Math.min(e[0],t[0]),e[1]=Math.min(e[1],t[1]),e[2]=Math.min(e[2],t[2]),e[3]=Math.max(e[3],t[0]),e[4]=Math.max(e[4],t[1]),e[5]=Math.max(e[5],t[2])}function d(e,t,i=0,r=t.length/3){let a=e[0],n=e[1],s=e[2],o=e[3],c=e[4],l=e[5];for(let h=0;h<r;h++)a=Math.min(a,t[i+3*h]),n=Math.min(n,t[i+3*h+1]),s=Math.min(s,t[i+3*h+2]),o=Math.max(o,t[i+3*h]),c=Math.max(c,t[i+3*h+1]),l=Math.max(l,t[i+3*h+2]);e[0]=a,e[1]=n,e[2]=s,e[3]=o,e[4]=c,e[5]=l}function u(e,t,i,r){e[0]=Math.min(e[0],e[0]+t),e[3]=Math.max(e[3],e[3]+t),e[1]=Math.min(e[1],e[1]+i),e[4]=Math.max(e[4],e[4]+i),e[2]=Math.min(e[2],e[2]+r),e[5]=Math.max(e[5],e[5]+r)}function p(e,t,i){const r=t.length;let a=e[0],n=e[1],s=e[2],o=e[3],c=e[4],l=e[5];if(i)for(let h=0;h<r;h++){const e=t[h];a=Math.min(a,e[0]),n=Math.min(n,e[1]),s=Math.min(s,e[2]),o=Math.max(o,e[0]),c=Math.max(c,e[1]),l=Math.max(l,e[2])}else for(let h=0;h<r;h++){const e=t[h];a=Math.min(a,e[0]),n=Math.min(n,e[1]),o=Math.max(o,e[0]),c=Math.max(c,e[1])}e[0]=a,e[1]=n,e[2]=s,e[3]=o,e[4]=c,e[5]=l}function f(e){for(let t=0;t<6;t++)if(!isFinite(e[t]))return!1;return!0}function m(e){return e[0]>=e[3]?0:e[3]-e[0]}function b(e){return e[1]>=e[4]?0:e[4]-e[1]}function g(e){return e[2]>=e[5]?0:e[5]-e[2]}function v(e){const t=m(e),i=g(e),r=b(e);return Math.sqrt(t*t+i*i+r*r)}function y(e,t=[0,0,0]){return t[0]=e[0]+m(e)/2,t[1]=e[1]+b(e)/2,t[2]=e[2]+g(e)/2,t}function O(e,t=[0,0,0]){return t[0]=m(e),t[1]=b(e),t[2]=g(e),t}function _(e){return Math.max(m(e),g(e),b(e))}function x(e,t){return t[0]>=e[0]&&t[1]>=e[1]&&t[2]>=e[2]&&t[0]<=e[3]&&t[1]<=e[4]&&t[2]<=e[5]}function j(e,t){return t[0]>=e[0]&&t[1]>=e[1]&&t[2]>=e[2]&&t[3]<=e[3]&&t[4]<=e[4]&&t[5]<=e[5]}function w(e,t){return Math.max(t[0],e[0])<=Math.min(t[3],e[3])&&Math.max(t[1],e[1])<=Math.min(t[4],e[4])&&Math.max(t[2],e[2])<=Math.min(t[5],e[5])}function S(e,t){return!!Object(r["j"])(t)||w(e,t)}function C(e,t,i,r,a=e){return a[0]=e[0]+t,a[1]=e[1]+i,a[2]=e[2]+r,a[3]=e[3]+t,a[4]=e[4]+i,a[5]=e[5]+r,a}function T(e,t,i=e){const r=e[0]+m(e)/2,a=e[1]+b(e)/2,n=e[2]+g(e)/2;return i[0]=r+(e[0]-r)*t,i[1]=a+(e[1]-a)*t,i[2]=n+(e[2]-n)*t,i[3]=r+(e[3]-r)*t,i[4]=a+(e[4]-a)*t,i[5]=n+(e[5]-n)*t,i}function P(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function A(e,t,i=e){return i[0]=t[0],i[1]=t[1],i[2]=t[2],i!==e&&(i[3]=e[3],i[4]=e[4],i[5]=e[5]),i}function R(e,t,i=e){return i[3]=t[0],i[4]=t[1],i[5]=t[2],i!==e&&(i[0]=e[0],i[1]=e[1],i[2]=e[2]),e}function M(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e}function E(e){return e?M(e,U):s(U)}function D(e,t){return t||(t=Object(a["l"])()),t[0]=e[0],t[1]=e[1],t[2]=e[3],t[3]=e[4],t}function I(e,t){return e[0]=t[0],e[1]=t[1],e[2]=Number.NEGATIVE_INFINITY,e[3]=t[2],e[4]=t[3],e[5]=Number.POSITIVE_INFINITY,e}function L(e){return 6===e.length}function V(e){return 0===m(e)&&0===b(e)&&0===g(e)}function k(e,t,i){if(Object(r["j"])(e)||Object(r["j"])(t))return e===t;if(!L(e)||!L(t))return!1;if(i){for(let r=0;r<e.length;r++)if(!i(e[r],t[r]))return!1}else for(let r=0;r<e.length;r++)if(e[r]!==t[r])return!1;return!0}function F(e,t,i,r,a,n){return o(e,t,i,r,a,n,B)}const z=n([-1/0,-1/0,-1/0,1/0,1/0,1/0]),U=n([1/0,1/0,1/0,-1/0,-1/0,-1/0]),G=n([0,0,0,0,0,0]),B=s()},"43e0":function(e,t,i){"use strict";i.d(t,"a",(function(){return p})),i.d(t,"b",(function(){return u})),i.d(t,"c",(function(){return f})),i.d(t,"d",(function(){return l})),i.d(t,"e",(function(){return d}));var r=i("02f1"),a=i("3349"),n=i("c9fb"),s=i("6706"),o=i("0f94");class c{constructor(e){this.coordinateHelper=e}}class l extends c{constructor(e,t){super(e),this.point=t}objectEqual(e){return e instanceof l&&Object(s["d"])(this.point,e.point)}check(e){return Object(a["j"])(e,this.point)<n["a"].pointThreshold}closestTo(){return this.coordinateHelper.clone(this.point)}intersect(e){const t=[];return e instanceof h?t.push(...Object(o["b"])({start:e.start,end:e.end,type:e instanceof u?1:0},this.point)):e instanceof f&&t.push(...Object(o["a"])(e.center,e.radius,this.point)),t.map(t=>new p(this.coordinateHelper,t,this,e))}}class h extends c{constructor(e,t,i){super(e),this.start=t,this.end=i}objectEqual(e){return e instanceof h&&Object(s["d"])(this.start,e.start)&&Object(s["d"])(this.end,e.end)}intersect(e){const t=[];return e instanceof l?t.push(...Object(o["b"])({start:this.start,end:this.end,type:this instanceof u?1:0},e.point)):e instanceof h?t.push(...Object(o["c"])({start:this.start,end:this.end,type:this instanceof u?1:0},{start:e.start,end:e.end,type:e instanceof u?1:0})):e instanceof f&&t.push(...Object(o["d"])({start:this.start,end:this.end,type:this instanceof u?1:0},e.center,e.radius)),t.map(t=>new p(this.coordinateHelper,t,this,e))}}class d extends h{constructor(e,t,i){super(e,t,i),this.dir=Object(r["b"])(),this.p=Object(r["b"])()}objectEqual(e){return e instanceof d&&super.objectEqual(e)}check(e){return Object(a["d"])(this.dir,this.end,this.start),Object(a["d"])(this.p,e,this.start),Object(a["g"])(this.dir,this.p)>=0&&Object(o["e"])(e,this.start,this.end)<n["a"].pointOnLineThreshold}closestTo(e){const t=this.coordinateHelper.clone(e);return Object(o["h"])(t,e,this.start,this.end),t}}class u extends h{constructor(e,t,i){super(e,t,i)}objectEqual(e){return e instanceof u&&super.objectEqual(e)}check(e){return Object(o["e"])(e,this.start,this.end)<n["a"].pointOnLineThreshold}closestTo(e){const t=this.coordinateHelper.clone(e);return Object(o["g"])(t,e,this.start,this.end),t}}class p extends c{constructor(e,t,i,r){super(e),this.intersection=t,this.first=i,this.second=r}objectEqual(e){return e instanceof p&&this.first.objectEqual(e.first)&&this.second.objectEqual(e.second)}check(){return!1}closestTo(e){const t=this.coordinateHelper.clone(e);return Object(a["c"])(t,this.intersection),t}intersect(){return[]}}class f extends c{constructor(e,t,i){super(e),this.center=t,this.radius=i}objectEqual(e){return e instanceof f&&this.center[0]===e.center[0]&&this.center[1]===e.center[1]&&this.radius===e.radius}check(){return!1}closestTo(e){const t=this.coordinateHelper.clone(e);return Object(o["f"])(t,e,this.center,this.radius),t}intersect(e){const t=[];return e instanceof h?t.push(...Object(o["d"])({start:e.start,end:e.end,type:e instanceof u?1:0},this.center,this.radius)):e instanceof l&&t.push(...Object(o["a"])(this.center,this.radius,e.point)),t.map(t=>new p(this.coordinateHelper,t,this,e))}}},"45a1":function(e,t,i){"use strict";i.d(t,"a",(function(){return g}));var r=i("b2b2"),a=i("0b2d"),n=i("e431"),s=i("af40"),o=i("d791"),c=i("afe1"),l=i("7577"),h=i("5ef2"),d=i("f091"),u=i("0278"),p=i("caf7"),f=i("86ba"),m=i("d36e"),b=i("5fae");class g extends b["a"]{constructor(e){super(e),this._handles=new s["a"],this._quadMaterial=null,this._outlineMaterial=null,this._maxSize=0,this._position=Object(a["e"])(),this._up=Object(a["e"])(),this._right=Object(a["e"])(),this._renderOccluded=4,this._color=Object(h["c"])(1,0,0,1),this._outlineColor=Object(h["c"])(0,0,0,1),this._outlineSize=0,this._size=32,this._outlineRenderOccluded=16,this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateQuadMaterial())}get color(){return this._color}set color(e){Object(l["c"])(this._color,e),this._updateQuadMaterial()}get outlineColor(){return this._outlineColor}set outlineColor(e){Object(l["c"])(this._outlineColor,e),this._updateOutlineMaterial()}get outlineSize(){return this._outlineSize}set outlineSize(e){const t=0===this._outlineSize!=(0===e);this._outlineSize=e,t?this.recreateGeometry():this._updateOutlineMaterial()}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this._updateTransform())}get outlineRenderOccluded(){return this._outlineRenderOccluded}set outlineRenderOccluded(e){this._outlineRenderOccluded=e,this._updateOutlineMaterial()}set geometry({previous:e,center:t,next:i}){this._maxSize=Math.min(Object(n["p"])(t,e),Object(n["p"])(t,i))/3,Object(n["s"])(this._up,Object(n["k"])(this._up,e,t)),Object(n["s"])(this._right,Object(n["k"])(this._right,i,t)),Object(n["l"])(this._position,t),this.recreateGeometry()}createExternalResources(){this._quadMaterial=new m["a"](this.quadMaterialParameters),this._outlineMaterial=new f["a"](this.outlineMaterialParameters),this._handles.add(this.view.state.watch("camera",()=>this._updateTransform()))}destroyExternalResources(){this._quadMaterial=null,this._outlineMaterial=null,this._handles.removeAll()}forEachExternalMaterial(e){e(this._quadMaterial),e(this._outlineMaterial)}createGeometries(e){this._createQuadGeometry(e),this._createOutlineGeometry(e),this._updateTransform(e)}_createQuadGeometry(e){const t=this._quadGeometryData(this._up,this._right);e.addGeometry(t,this._quadMaterial)}_createOutlineGeometry(e){if(0===this._outlineSize)return;const t=Object(n["g"])(d["d"].get(),this._up,this._right),i=p["a"].createPolylineGeometry([this._up,t,this._right]);e.addGeometry(i,this._outlineMaterial)}_updateTransform(e=this.object){const t=this.view.state.camera,i=this._size*t.computeScreenPixelSizeAt(this._position),a=Math.min(this._maxSize,i);Object(o["i"])(v),Object(o["t"])(v,v,this._position),Object(o["s"])(v,v,[a,a,a]),Object(r["k"])(e)&&(e.transformation=v)}_quadGeometryData(e,t){const i=Object(n["g"])(d["d"].get(),e,t);return new u["a"]([["position",{size:3,data:[0,0,0,...t,...e,...i],exclusive:!0}]],[["position",new Uint16Array([0,1,2,1,2,3])]])}get quadMaterialParameters(){return{color:this._color,transparent:!0,writeDepth:!1,polygonOffset:!0,renderOccluded:this._renderOccluded}}_updateQuadMaterial(){this._quadMaterial&&this._quadMaterial.setParameterValues(this.quadMaterialParameters)}get outlineMaterialParameters(){return{color:this._outlineColor,width:this._outlineSize,renderOccluded:this._outlineRenderOccluded}}_updateOutlineMaterial(){this._outlineMaterial&&this._outlineMaterial.setParameterValues(this.outlineMaterialParameters)}}const v=Object(c["b"])()},"45e3":function(e,t,i){"use strict";i.d(t,"a",(function(){return h}));var r=i("a4ee"),a=(i("c120"),i("e92d"),i("cea0"),i("59b2")),n=i("d386"),s=i("ce50"),o=(i("e041"),i("8eed"),i("f402"),i("3795")),c=i("8b9d"),l=i("9ee2");const h=e=>{let t=class extends e{get imageFormatIsOpaque(){return!1}get isOpaque(){return this.fullOpacity>=1&&this.imageFormatIsOpaque}get dataLevelRange(){const e=this.tileInfo.lods,t=e[0].scale,i=e[e.length-1].scale;return this.levelRangeFromScaleRange(t,i)}get displayLevelRange(){const e=this.tileInfo.lods,t=this.layer.minScale||e[0].scale,i=this.layer.maxScale||e[e.length-1].scale,r=this.levelRangeFromScaleRange(t,i);return this.layer.maxScale&&r.maxLevel++,r}getTileUrl(e,t,i){return this.layer.getTileUrl(e,t,i)}_addTilingSchemeMatchPromise(){const e=this._getTileInfoSupportError(this.tileInfo,this.layer.fullExtent);if(e)this.addResolvingPromise(Promise.reject(e));else{const e=Object(o["m"])(this.view,"basemapTerrain.tilingSchemeLocked").then(()=>{const e=this.view.basemapTerrain.tilingScheme,t=this._getTileInfoCompatibilityError(this.tileInfo,e);if(t)throw t});this.addResolvingPromise(e)}}_getTileInfoSupportError(e,t){const i=Object(c["a"])(e,t,this.view.spatialReference,this.view.basemapTerrain.manifold);if(i){const e={layer:this.layer,error:i};let t;switch(i.name){case"tilingscheme:local-gcs-not-supported":t=new s["a"]("layerview:local-gcs-not-supported","Geographic coordinate systems are not supported in local scenes",e);break;case"tilingscheme:spatial-reference-mismatch":case"tilingscheme:global-unsupported-spatial-reference":t=new s["a"]("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",e);break;default:t=new s["a"]("layerview:tiling-scheme-unsupported","The tiling scheme of this layer is not supported by SceneView",e)}return t}return null}_getTileInfoCompatibilityError(e,t){return t.compatibleWith(e)?null:new s["a"]("layerview:tiling-scheme-incompatible","The tiling scheme of this layer is incompatible with the tiling scheme of the surface")}levelRangeFromScaleRange(e,t){const i={minLevel:0,maxLevel:1/0},r=this.view&&this.view.basemapTerrain&&this.view.basemapTerrain.tilingScheme;if(!r)return i;const a=r.levels[0],n=e=>{const t=Math.log(a.scale/e)/Math.LN2;return.5-Math.abs(.5-t%1)<1e-9?Math.round(t):Math.ceil(t)};return null!=e&&e>0&&(i.minLevel=Math.max(0,n(e))),null!=t&&t>0&&(i.maxLevel=Math.max(0,n(t))),i}isUpdating(){return!!(this.view&&this.view.basemapTerrain&&this.view.basemapTerrain.updating)}};return Object(r["a"])([Object(a["b"])({readOnly:!0})],t.prototype,"imageFormatIsOpaque",null),Object(r["a"])([Object(a["b"])({readOnly:!0})],t.prototype,"updating",void 0),Object(r["a"])([Object(a["b"])(l["a"])],t.prototype,"updatingProgress",void 0),Object(r["a"])([Object(a["b"])(l["b"])],t.prototype,"updatingProgressValue",void 0),Object(r["a"])([Object(a["b"])({readOnly:!0})],t.prototype,"fullExtent",void 0),Object(r["a"])([Object(a["b"])({readOnly:!0})],t.prototype,"isOpaque",null),Object(r["a"])([Object(a["b"])({readOnly:!0})],t.prototype,"dataLevelRange",null),Object(r["a"])([Object(a["b"])({readOnly:!0})],t.prototype,"displayLevelRange",null),Object(r["a"])([Object(a["b"])()],t.prototype,"layer",void 0),Object(r["a"])([Object(a["b"])({readOnly:!0})],t.prototype,"tileInfo",void 0),t=Object(r["a"])([Object(n["a"])("esri.views.3d.layers.TiledLayerView3D")],t),t}},4772:function(e,t,i){"use strict";i.d(t,"a",(function(){return u}));var r=i("a4ee"),a=(i("c120"),i("e92d"),i("cea0"),i("59b2")),n=i("d386"),s=(i("e041"),i("8eed"),i("f402"),i("f4cc")),o=i("fc29"),c=i("4e5e"),l=i("b2b2"),h=i("2c4f");class d{constructor(){this._isToolEditable=!0,this._manipulators=new h["a"],this._nextManipulatorId=0,this._resourceContexts={manipulator3D:{}},this._attached=!1}set isToolEditable(e){this._isToolEditable=e}get length(){return this._manipulators.length}add(e,t=0){return this.addMany([e],t)[0]}addMany(e,t=0){return e.map(e=>{const i=this._nextManipulatorId++,r={id:i,manipulator:e,visibilityPredicate:t,attached:!1};return this._manipulators.add(r),this._attached&&this._updateManipulatorAttachment(r),i})}remove(e){if("number"==typeof e){const t=e;for(let e=0;e<this._manipulators.length;e++)if(this._manipulators.getItemAt(e).id===t){const t=this._manipulators.splice(e,1)[0];return this._detachManipulator(t),t.id}return null}const t=e;for(let i=0;i<this._manipulators.length;i++)if(this._manipulators.getItemAt(i).manipulator===t){const e=this._manipulators.splice(i,1)[0];return this._detachManipulator(e),e.id}return null}removeAll(){this._manipulators.forEach(e=>{this._detachManipulator(e)}),this._manipulators.removeAll()}attach(){this._manipulators.forEach(e=>{this._updateManipulatorAttachment(e)}),this._attached=!0}detach(){this._manipulators.forEach(e=>{this._detachManipulator(e)}),this._attached=!1}destroy(){this._manipulators.forEach(({manipulator:e})=>{e.destroy&&e.destroy()}),this._manipulators.destroy(),this._resourceContexts=null}on(e,t){return this._manipulators.on(e,e=>{t(e)})}forEach(e){for(const t of this._manipulators.items)e(t)}some(e){return this._manipulators.items.some(e)}toArray(){const e=[];return this.forEach(t=>e.push(t.manipulator)),e}intersect(e,t){let i=null,r=Number.MAX_VALUE;return this._manipulators.forEach(({id:a,manipulator:n,attached:s})=>{if(!s||!n.interactive)return;const o=n.intersectionDistance(e,t);Object(l["k"])(o)&&o<r&&(r=o,i={id:a,manipulator:n})}),i}findById(e){if(Object(l["j"])(e))return null;for(const t of this._manipulators.items)if(e===t.id)return t.manipulator;return null}_updateManipulatorAttachment(e){this._isManipulatorItemVisible(e)?this._attachManipulator(e):this._detachManipulator(e)}_attachManipulator(e){e.attached||(e.manipulator.attach&&e.manipulator.attach(this._resourceContexts),e.attached=!0)}_detachManipulator(e){if(!e.attached)return;const t=e.manipulator;t.grabbing=!1,t.dragging=!1,t.hovering=!1,t.selected=!1,t.detach&&t.detach(this._resourceContexts),e.attached=!1}_isManipulatorItemVisible(e){return 2===e.visibilityPredicate||(this._isToolEditable?0===e.visibilityPredicate:1===e.visibilityPredicate)}}let u=class extends o["a"]{constructor(e){super(e),this.attached=!1,this.created=!1,this.completed=!1,this.manipulators=new d,this.deferCreation=!1,this._editableFlags=new Array,this._creationResolver=Object(s["h"])()}get active(){return null!=this.view&&this.view.activeTool===this}get isSupported(){return!0}set visible(e){this._set("visible",e),e||Object(c["d"])(this,!1),this.attached&&(e?this._show():this._hide())}get editable(){return this.hasEditableFlag(0)}set editable(e){this.setEditableFlag(0,e)}attach(){!this.attached&&this.isSupported&&(this.manipulators.attach(),this.onAttach(),this.visible&&this.onShow(),this._set("attached",!0))}detach(){this.attached&&(this.onHide(),this.onDetach(),this.manipulators.detach(),this._set("attached",!1))}handleInputEvent(e){this.attached&&this.onInputEvent(e)}handleInputEventAfter(e){this.attached&&this.onInputEventAfter(e)}destroy(){this.manipulators.destroy(),this._set("view",null),this._set("created",!1),this._set("completed",!1)}setEditableFlag(e,t){this._editableFlags[e]=t,this.manipulators.isToolEditable=this._editableFlags.every(e=>null==e||e),this._updateManipulatorAttachment(),0===e&&this.notifyChange("editable"),this.onEditableChange()}hasEditableFlag(e){const t=this._editableFlags[e];return null==t||t}when(){return this._creationResolver.promise}rejectCreation(e){this._creationResolver.reject(e)}initialize(){this.deferCreation||this.complete()}onAttach(){}onDetach(){}onShow(){}onHide(){}onEditableChange(){}onInputEvent(e){}onInputEventAfter(e){}get internallyEditable(){return this.hasEditableFlag(0)&&this.hasEditableFlag(1)}create(){this.created||(this._set("created",!0),this._creationResolver.resolve(this))}complete(){this.create(),this._set("completed",!0)}_show(){this._updateManipulatorAttachment(),this.onShow()}_hide(){this._updateManipulatorAttachment(),this.onHide()}_updateManipulatorAttachment(){this.attached&&this.visible?this.manipulators.attach():this.manipulators.detach()}};Object(r["a"])([Object(a["b"])({constructOnly:!0})],u.prototype,"view",void 0),Object(r["a"])([Object(a["b"])({readOnly:!0})],u.prototype,"active",null),Object(r["a"])([Object(a["b"])({value:!0})],u.prototype,"visible",null),Object(r["a"])([Object(a["b"])({value:!0})],u.prototype,"editable",null),Object(r["a"])([Object(a["b"])({readOnly:!0})],u.prototype,"attached",void 0),Object(r["a"])([Object(a["b"])({readOnly:!0})],u.prototype,"created",void 0),Object(r["a"])([Object(a["b"])({readOnly:!0})],u.prototype,"completed",void 0),Object(r["a"])([Object(a["b"])({readOnly:!0})],u.prototype,"manipulators",void 0),Object(r["a"])([Object(a["b"])({constructOnly:!0})],u.prototype,"deferCreation",void 0),u=Object(r["a"])([Object(n["a"])("esri.views.interactive.InteractiveToolBase")],u)},"49a0":function(e,t,i){"use strict";i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return n}));var r=i("8048");const a=96;function n(e,t){const i=t||e.extent,n=e.width,s=Object(r["e"])(i&&i.spatialReference);return i&&n?i.width/n*s*r["i"]*a:0}function s(e,t){return e/(Object(r["e"])(t)*r["i"]*a)}},"4aea":function(e,t,i){"use strict";i.d(t,"a",(function(){return a})),i.d(t,"b",(function(){return r}));const r=["freehand","hybrid","click"],a="click"},"4b49":function(e,t,i){"use strict";i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return o}));var r=i("b2b2"),a=i("0b2d"),n=i("8188");function s(e,t,i){if(null==e||Object(r["j"])(i))return!1;let a=!0;return c[0]=null!=e.xmin?e.xmin:0,c[1]=null!=e.ymin?e.ymin:0,c[2]=null!=e.zmin?e.zmin:0,a=a&&Object(n["q"])(c,e.spatialReference,0,t,i,0,1),c[0]=null!=e.xmax?e.xmax:0,c[1]=null!=e.ymax?e.ymax:0,c[2]=null!=e.zmax?e.zmax:0,a=a&&Object(n["q"])(c,e.spatialReference,0,t,i,3,1),null==e.xmin&&(t[0]=-1/0),null==e.ymin&&(t[1]=-1/0),null==e.zmin&&(t[2]=-1/0),null==e.xmax&&(t[3]=1/0),null==e.ymax&&(t[4]=1/0),null==e.zmax&&(t[5]=1/0),a}function o(e,t,i){if(null==e)return!1;let r=!0;return c[0]=null!=e.xmin?e.xmin:0,c[1]=null!=e.ymin?e.ymin:0,c[2]=null!=e.zmin?e.zmin:0,r=r&&Object(n["q"])(c,e.spatialReference,0,c,i,0,1),t[0]=c[0],t[1]=c[1],c[0]=null!=e.xmax?e.xmax:0,c[1]=null!=e.ymax?e.ymax:0,c[2]=null!=e.zmax?e.zmax:0,r=r&&Object(n["q"])(c,e.spatialReference,0,c,i,0,1),t[2]=c[0],t[3]=c[1],null==e.xmin&&(t[0]=-1/0),null==e.ymin&&(t[1]=-1/0),null==e.xmax&&(t[2]=1/0),null==e.ymax&&(t[3]=1/0),r}const c=Object(a["e"])()},"4c96":function(e,t,i){"use strict";function r(e,t,i){const r=e.typedBuffer,a=e.typedBufferStride,n=t.typedBuffer,s=t.typedBufferStride,o=i?i.count:t.count;let c=(i&&i.dstIndex?i.dstIndex:0)*a,l=(i&&i.srcIndex?i.srcIndex:0)*s;for(let h=0;h<o;++h)r[c]=n[l],r[c+1]=n[l+1],r[c+2]=n[l+2],c+=a,l+=s}i.d(t,"a",(function(){return r}));Object.freeze({__proto__:null,copy:r})},"4e47":function(e,t,i){"use strict";i.d(t,"a",(function(){return c}));var r=i("0b2d"),a=i("e431"),n=i("0ca15"),s=i("b33e");class o extends s["a"]{constructor(e,t,i,r,a){super(e,t,i),this.sceneVelocity=r,this.direction=a}value(e){return super.valueFromInitialVelocity(this.sceneVelocity,e)}}class c{constructor(e=300,t=12,i=.84){this.minimumInitialVelocity=e,this.stopVelocity=t,this.friction=i,this.enabled=!0,this.time=new n["a"](.6),this.screen=[new n["a"](.4),new n["a"](.4)],this.scene=[new n["a"](.6),new n["a"](.6),new n["a"](.6)],this.tmpDirection=Object(r["e"])()}add(e,t,i){if(this.enabled){if(this.time.hasLastValue&&this.time.computeDelta(i)<.015)return;this.screen[0].update(e[0]),this.screen[1].update(e[1]),this.scene[0].update(t[0]),this.scene[1].update(t[1]),this.scene[2].update(t[2]),this.time.update(i)}}reset(){this.screen[0].reset(),this.screen[1].reset(),this.scene[0].reset(),this.scene[1].reset(),this.scene[2].reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.screen[0].hasFilteredDelta)return null;const e=this.screen[0].filteredDelta,t=this.screen[1].filteredDelta,i=Math.sqrt(e*e+t*t)/this.time.filteredDelta;return Math.abs(i)<this.minimumInitialVelocity?null:this.createMomentum(i,this.stopVelocity,this.friction)}createMomentum(e,t,i){Object(a["x"])(this.tmpDirection,this.scene[0].filteredDelta,this.scene[1].filteredDelta,this.scene[2].filteredDelta);const r=Object(a["q"])(this.tmpDirection);r>0&&Object(a["f"])(this.tmpDirection,this.tmpDirection,1/r);const n=r/this.time.filteredDelta;return new o(e,t,i,n,this.tmpDirection)}}},5015:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i("f4cc"),a=i("2db0");async function n(e){const t=i.e("chunk-2d0c191a").then(i.bind(null,"4734")),n=i.e("chunk-2d207f46").then(i.bind(null,"a375")),s=Object(a["a"])((await t).default,{signal:e}),o=Object(a["a"])((await n).default,{signal:e}),c={mask:await s,overlay:await o};return Object(r["w"])(e),c}},5211:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i("3886");function a(e){e.extensions.add("GL_EXT_shader_texture_lod"),e.extensions.add("GL_OES_standard_derivatives"),e.fragment.code.add(r["a"]`
    #ifndef GL_EXT_shader_texture_lod
      float calcMipMapLevel(const vec2 ddx, const vec2 ddy) {
        float deltaMaxSqr = max(dot(ddx, ddx), dot(ddy, ddy));
        return max(0.0, 0.5 * log2(deltaMaxSqr));
      }
    #endif

    vec4 textureAtlasLookup(sampler2D texture, vec2 textureSize, vec2 textureCoordinates, vec4 atlasRegion) {
      //[umin, vmin, umax, vmax]
      vec2 atlasScale = atlasRegion.zw - atlasRegion.xy;
      vec2 uvAtlas = fract(textureCoordinates) * atlasScale + atlasRegion.xy;

      // calculate derivative of continuous texture coordinate
      // to avoid mipmapping artifacts caused by manual wrapping in shader
      // clamp the derivatives to avoid discoloring when zooming out.
      float maxdUV = 0.125; // Emprirically tuned compromise between discoloring and aliasing noise.
      vec2 dUVdx = clamp(dFdx(textureCoordinates), -maxdUV, maxdUV) * atlasScale;
      vec2 dUVdy = clamp(dFdy(textureCoordinates), -maxdUV, maxdUV) * atlasScale;

      #ifdef GL_EXT_shader_texture_lod
        return texture2DGradEXT(texture, uvAtlas, dUVdx, dUVdy);
      #else
        // use bias to compensate for difference in automatic vs desired mipmap level
        vec2 dUVdxAuto = dFdx(uvAtlas);
        vec2 dUVdyAuto = dFdy(uvAtlas);
        float mipMapLevel = calcMipMapLevel(dUVdx * textureSize, dUVdy * textureSize);
        float autoMipMapLevel = calcMipMapLevel(dUVdxAuto * textureSize, dUVdyAuto * textureSize);

        return texture2D(texture, uvAtlas, mipMapLevel - autoMipMapLevel);
      #endif
    }
  `)}},5241:function(e,t,i){"use strict";i.d(t,"a",(function(){return f})),i.d(t,"b",(function(){return m})),i.d(t,"c",(function(){return g})),i.d(t,"d",(function(){return b}));var r=i("b2b2"),a=i("32ed"),n=i("0b2d"),s=i("8188"),o=i("afe1"),c=i("4261"),l=i("1a54"),h=i("5a22"),d=i("ba58"),u=i("2e0f");const p=Object(n["e"])();function f(e,t,i,a,n,l,d,f,m,b){const g=i?i.length:0,v=e.clippingExtent;if(Object(s["t"])(t,p,e.elevationProvider.spatialReference),Object(r["k"])(v)&&!Object(c["g"])(v,p))return null;const y=e.renderCoordsHelper.spatialReference;Object(s["t"])(t,p,y);const O=e.localOriginFactory.getOrigin(p),_=new h["a"]({castShadow:!1,metadata:{layerUid:f,graphicUid:m,usesVerticalDistanceToGround:!0}});for(let r=0;r<g;r++){const e=n?n[r]:o["a"];_.addGeometry(i[r],a[r],e,l,O,b)}return{object:_,sampledElevation:Object(u["b"])(_,t,e.elevationProvider,e.renderCoordsHelper,d)}}function m(e,t,i){const r=e.elevationContext,a=i.spatialReference;Object(s["t"])(t,p,a),r.centerPointInElevationSR=Object(l["k"])(p[0],p[1],t.hasZ?p[2]:0,a)}function b(e){switch(e.type){case"point":return e;case"polygon":case"extent":return Object(d["a"])(e);case"polyline":{const t=e.paths[0];if(!t||0===t.length)return null;const i=Object(a["f"])(t,Object(a["e"])(t)/2);return Object(l["k"])(i[0],i[1],i[2],e.spatialReference)}case"mesh":return e.extent.center}return null}function g(e,t,i,r,a){const n=new Float64Array(3*e.length),s=new Float64Array(n.length);e.forEach((e,t)=>{n[3*t+0]=e[0],n[3*t+1]=e[1],n[3*t+2]=e.length>2?e[2]:0});const o=Object(u["c"])(n,t,0,s,0,n,0,n.length/3,i,r,a),c=null!=o;return{numVertices:e.length,position:n,mapPosition:s,projectionSuccess:c,sampledElevation:o}}},"53f8":function(e,t,i){"use strict";i.r(t);var r=i("a4ee"),a=(i("c120"),i("b2b2")),n=(i("e92d"),i("cea0")),s=i("59b2"),o=i("afcf"),c=i("d386"),l=i("09db"),h=i("ce50"),d=(i("e041"),i("8eed"),i("92ef")),u=(i("f402"),i("f4cc")),p=i("3af1"),f=i("2eab"),m=i("1853"),b=i("a6a3"),g=i("658b"),v=i("e694"),y=i("22f4"),O=i("b911"),_=i("3d59"),x=i("997b"),j=i("8b28"),w=i("0db5"),S=i("8e17"),C=i("5a62"),T=i("601a"),P=i("9096"),A=i("49a0"),R=i("303f"),M=i("e9d0"),E=i("2258"),D=i("d409"),I=i("70ce");let L=class extends(Object(x["a"])(Object(T["a"])(Object(C["a"])(Object(S["a"])(Object(D["a"])(Object(R["a"])(Object(_["a"])(Object(O["a"])(Object(w["a"])(Object(v["a"])(Object(j["a"])(Object(P["b"])(b["a"]))))))))))))){constructor(...e){super(...e),this.alwaysRefetch=!1,this.dpi=96,this.gdbVersion=null,this.imageFormat="png24",this.imageMaxHeight=2048,this.imageMaxWidth=2048,this.imageTransparency=!0,this.isReference=null,this.labelsVisible=!1,this.operationalLayerType="ArcGISMapServiceLayer",this.sourceJSON=null,this.sublayers=null,this.type="map-image",this.url=null}normalizeCtorArgs(e,t){return"string"==typeof e?{url:e,...t}:e}load(e){const t=Object(a["k"])(e)?e.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["Map Service"]},e).then(()=>this._fetchService(t),()=>this._fetchService(t))),Promise.resolve(this)}readImageFormat(e,t){const i=t.supportedImageFormatTypes;return i&&i.indexOf("PNG32")>-1?"png32":"png24"}writeSublayers(e,t,i,r){if(!this.loaded||!e)return;const a=e.slice().reverse().flatten(({sublayers:e})=>e&&e.toArray().reverse()).toArray();let n=!1;if(this.capabilities&&this.capabilities.operations.supportsExportMap&&this.capabilities.exportMap.supportsDynamicLayers){const e=Object(d["d"])(r.origin);if(3===e){const e=this.createSublayersForOrigin("service").sublayers;n=Object(E["c"])(a,e,2)}else if(e>3){const e=this.createSublayersForOrigin("portal-item");n=Object(E["c"])(a,e.sublayers,Object(d["d"])(e.origin))}}const s=[],o={writeSublayerStructure:n,...r};let c=n;a.forEach(e=>{const t=e.write({},o);s.push(t),c=c||"user"===e.originOf("visible")}),s.some(e=>Object.keys(e).length>1)&&(t.layers=s),c&&(t.visibleLayers=a.filter(e=>e.visible).map(e=>e.id))}createExportImageParameters(e,t,i,r){const a=r&&r.pixelRatio||1;e&&this.version>=10&&(e=e.clone().shiftCentralMeridian());const n=new I["a"]({layer:this,scale:Object(A["b"])({extent:e,width:t})*a}),s=n.toJSON();n.destroy();const o=!r||!r.rotation||this.version<10.3?{}:{rotation:-r.rotation},c=e&&e.spatialReference,l=c.wkid||JSON.stringify(c.toJSON());s.dpi*=a;const h={};if(null!=r&&r.timeExtent){const{start:e,end:t}=r.timeExtent.toJSON();h.time=e&&t&&e===t?""+e:`${null==e?"null":e},${null==t?"null":t}`}else this.timeInfo&&!this.timeInfo.hasLiveData&&(h.time="null,null");return{bbox:e&&e.xmin+","+e.ymin+","+e.xmax+","+e.ymax,bboxSR:l,imageSR:l,size:t+","+i,...s,...o,...h}}async fetchImage(e,t,i,r){const a={responseType:"image"};r&&r.timestamp&&(a.query={...a.query,_ts:r.timestamp}),r&&r.signal&&(a.signal=r.signal),this.customParameters&&Object.keys(this.customParameters).length&&(a.query={...this.customParameters,...a.query});const n=this.parsedUrl.path+"/export",s={...this.parsedUrl.query,...this.createExportImageParameters(e,t,i,r),f:"image",_ts:this.alwaysRefetch?Date.now():null};return null==s.dynamicLayers||this.capabilities.exportMap.supportsDynamicLayers?(a.query?a.query={...s,...a.query}:a.query=s,Object(f["default"])(n,a).then(e=>e.data).catch(e=>{if(Object(u["n"])(e))throw e;throw new h["a"]("mapimagelayer:image-fetch-error","Unable to load image: "+n,{error:e})})):Promise.reject(new h["a"]("mapimagelayer:dynamiclayer-not-supported",`service ${this.url} doesn't support dynamic layers, which is required to be able to change the sublayer's order, rendering, labeling or source.`,{query:s}))}async fetchRecomputedExtents(e={}){const t={...e,query:{returnUpdates:!0,f:"json"}},{data:i}=await Object(f["default"])(this.url,t),{extent:r,fullExtent:a,timeExtent:n}=i,s=r||a;return{fullExtent:s&&p["a"].fromJSON(s),timeExtent:n&&g["a"].fromJSON({start:n[0],end:n[1]})}}loadAll(){return Object(m["a"])(this,e=>{e(this.allSublayers)})}async _fetchService(e){if(this.sourceJSON)return void this.read(this.sourceJSON,{origin:"service",url:this.parsedUrl});const{data:t,ssl:i}=await Object(f["default"])(this.parsedUrl.path,{query:{f:"json",...this.parsedUrl.query,...this.customParameters},signal:e});i&&(this.url=this.url.replace(/^http:/i,"https:")),this.sourceJSON=t,this.read(t,{origin:"service",url:this.parsedUrl})}};Object(r["a"])([Object(s["b"])()],L.prototype,"alwaysRefetch",void 0),Object(r["a"])([Object(s["b"])()],L.prototype,"dpi",void 0),Object(r["a"])([Object(s["b"])()],L.prototype,"gdbVersion",void 0),Object(r["a"])([Object(s["b"])()],L.prototype,"imageFormat",void 0),Object(r["a"])([Object(o["a"])("imageFormat",["supportedImageFormatTypes"])],L.prototype,"readImageFormat",null),Object(r["a"])([Object(s["b"])({json:{origins:{service:{read:{source:"maxImageHeight"}}}}})],L.prototype,"imageMaxHeight",void 0),Object(r["a"])([Object(s["b"])({json:{origins:{service:{read:{source:"maxImageWidth"}}}}})],L.prototype,"imageMaxWidth",void 0),Object(r["a"])([Object(s["b"])()],L.prototype,"imageTransparency",void 0),Object(r["a"])([Object(s["b"])({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],L.prototype,"isReference",void 0),Object(r["a"])([Object(s["b"])({json:{read:!1,write:!1}})],L.prototype,"labelsVisible",void 0),Object(r["a"])([Object(s["b"])({type:["ArcGISMapServiceLayer"]})],L.prototype,"operationalLayerType",void 0),Object(r["a"])([Object(s["b"])({json:{read:!1,write:!1}})],L.prototype,"popupEnabled",void 0),Object(r["a"])([Object(s["b"])()],L.prototype,"sourceJSON",void 0),Object(r["a"])([Object(s["b"])({json:{write:{ignoreOrigin:!0}}})],L.prototype,"sublayers",void 0),Object(r["a"])([Object(l["a"])("sublayers",{layers:{type:[M["a"]]},visibleLayers:{type:[n["a"]]}})],L.prototype,"writeSublayers",null),Object(r["a"])([Object(s["b"])({type:["show","hide","hide-children"]})],L.prototype,"listMode",void 0),Object(r["a"])([Object(s["b"])({json:{read:!1},readOnly:!0,value:"map-image"})],L.prototype,"type",void 0),Object(r["a"])([Object(s["b"])(y["n"])],L.prototype,"url",void 0),L=Object(r["a"])([Object(c["a"])("esri.layers.MapImageLayer")],L);var V=L;t["default"]=V},"549a":function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i("ce50");class a{constructor(e,t,i=""){this.major=e,this.minor=t,this._context=i}lessThan(e,t){return this.major<e||e===this.major&&this.minor<t}since(e,t){return!this.lessThan(e,t)}validate(e){if(this.major!==e.major){const t=this._context&&this._context+":",i=this._context&&this._context+" ";throw new r["a"](t+"unsupported-version",`Required major ${i}version is '${this.major}', but got '\${version.major}.\${version.minor}'`,{version:e})}}clone(){return new a(this.major,this.minor,this._context)}static parse(e,t=""){const[i,n]=e.split("."),s=/^\s*\d+\s*$/;if(!i||!i.match||!i.match(s))throw new r["a"]((t&&t+":")+"invalid-version","Expected major version to be a number, but got '${version}'",{version:e});if(!n||!n.match||!n.match(s))throw new r["a"]((t&&t+":")+"invalid-version","Expected minor version to be a number, but got '${version}'",{version:e});const o=parseInt(i,10),c=parseInt(n,10);return new a(o,c,t)}}},5501:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i("3886");function a(e,t){e.varyings.add("vtc","vec2"),e.vertex.uniforms.add("texOffsetAndScale","vec4"),e.fragment.uniforms.add("tex","sampler2D"),e.fragment.uniforms.add("compositeBackground","bool"),e.fragment.uniforms.add("textureOpacity","float"),e.fragment.uniforms.add("baseOpacity","float"),t.textureFadingEnabled&&(e.vertex.uniforms.add("nextTexOffsetAndScale","vec4"),e.varyings.add("nvtc","vec2"),e.fragment.uniforms.add("texNext","sampler2D"),e.fragment.uniforms.add("textureFadeFactor","float")),e.vertex.code.add(r["a"]`
  void forwardTextureCoordinates(in vec2 uv) {
    vtc = uv * texOffsetAndScale.zw + texOffsetAndScale.xy;
    ${t.textureFadingEnabled?r["a"]`nvtc = uv * nextTexOffsetAndScale.zw + nextTexOffsetAndScale.xy;`:r["a"]``}
  }
  `),t.useGrid?(e.fragment.code.add(r["a"]`
    float lineFactorAtPosition(float value) {
      float pos = value * 129.0;
      if(pos < 0.5 || pos > 128.5) {
        return 1.0;
      }

      pos = pos + 0.5;
      float modulo = mod(pos, 16.0);
      return modulo <= 2.0 ?  1.0 - abs(modulo - 1.0) : 0.0;
    }

    float lineFactorAtUV(vec2 uv) {
      return max(lineFactorAtPosition(uv.x), lineFactorAtPosition(uv.y));
    }

    float lineFactor(vec2 uv) {
      vec2 offset = fwidth(uv) * 0.25;
      return (lineFactorAtUV(vec2(uv.x + offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x + offset.x, uv.y - offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y - offset.y))) / 4.0;
    }
    `),e.fragment.code.add(r["a"]`
    vec4 getTileColor() {
      vec4 color = ${t.textureFadingEnabled?r["a"]`textureFadeFactor < 1.0 ? mix(texture2D(texNext, nvtc), texture2D(tex, vtc), textureFadeFactor) : texture2D(tex, vtc);`:r["a"]`texture2D(tex, vtc);`};
      if(!compositeBackground) {
        return color;
      }

      float line = lineFactor(vtc) * 0.1 + 0.9;
      vec4 gridColor = vec4(1.0, 0.972, 0.918, 1.0) * line * baseOpacity;
      float alpha = textureOpacity * color.a;
      return mix(gridColor, color, alpha);
    }`)):t.hasBackgroundColor?(e.fragment.uniforms.add("backgroundColor","vec4"),e.fragment.code.add(r["a"]`
    vec4 getTileColor() {
      vec4 color = ${t.textureFadingEnabled?r["a"]`textureFadeFactor < 1.0 ? mix(texture2D(texNext, nvtc), texture2D(tex, vtc), textureFadeFactor) : texture2D(tex, vtc);`:r["a"]`texture2D(tex, vtc);`};
      float alpha = textureOpacity * color.a;
      return compositeBackground ? mix(backgroundColor * baseOpacity, color, alpha) : color;
    }`)):e.fragment.code.add(r["a"]`
    vec4 getTileColor() {
      return ${t.textureFadingEnabled?r["a"]`textureFadeFactor < 1.0 ? mix(texture2D(texNext, nvtc), texture2D(tex, vtc), textureFadeFactor) : texture2D(tex, vtc);`:r["a"]`texture2D(tex, vtc);`}
  }
  `)}},"55f0":function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));var r=i("38a4"),a=i("0ca15"),n=i("b33e");class s{constructor(e=2.5,t=.01,i=.95,r=12){this.minimumInitialVelocity=e,this.stopVelocity=t,this.friction=i,this.maxVelocity=r,this.enabled=!0,this.value=new a["a"](.8),this.time=new a["a"](.3)}add(e,t){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(t)<.01)return;if(this.value.hasFilteredDelta){const t=this.value.computeDelta(e);this.value.filteredDelta*t<0&&this.value.reset()}}this.time.update(t),this.value.update(e)}}reset(){this.value.reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.value.hasFilteredDelta)return null;let e=this.value.filteredDelta/this.time.filteredDelta;return e=Object(r["d"])(e,-this.maxVelocity,this.maxVelocity),Math.abs(e)<this.minimumInitialVelocity?null:this.createMomentum(e,this.stopVelocity,this.friction)}createMomentum(e,t,i){return new n["a"](e,t,i)}}},5686:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i("3886");function a(e,t){e.varyings.add("tbnTangent","vec3"),e.varyings.add("tbnBiTangent","vec3"),1===t.viewingMode?e.vertex.code.add(r["a"]`
      void forwardVertexTangent(vec3 n) {
        tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), n));
        tbnBiTangent = normalize(cross(n, tbnTangent));
      }
    `):e.vertex.code.add(r["a"]`
      void forwardVertexTangent(vec3 n) {
        tbnTangent = vec3(1.0, 0.0, 0.0);
        tbnBiTangent = normalize(cross(n, tbnTangent));
      }
    `),e.fragment.code.add(r["a"]`
      mat3 getTBNMatrix(vec3 n) {
        return mat3(tbnTangent, tbnBiTangent, n);
      }
    `)}},"56d6":function(e,t,i){"use strict";i.d(t,"a",(function(){return o})),i.d(t,"b",(function(){return s}));var r=i("3886"),a=i("690a"),n=i("9e77");function s(e){const t=new a["a"];return t.include(n["a"],e),t.vertex.uniforms.add("uModelViewMatrix","mat4"),t.vertex.uniforms.add("uProjectionMatrix","mat4"),t.attributes.add("start","vec3"),t.attributes.add("end","vec3"),t.attributes.add("up","vec3"),t.attributes.add("extrude","vec2"),t.varyings.add("uv","vec2"),t.varyings.add("vViewStart","vec3"),t.varyings.add("vViewEnd","vec3"),t.varyings.add("vViewPlane","vec4"),t.vertex.uniforms.add("glowWidth","float"),t.vertex.uniforms.add("pixelToNDC","vec2"),t.vertex.code.add(r["a"]`
  void main() {
    vec3 pos = mix(start, end, extrude.x);

    vec4 viewPos = uModelViewMatrix * vec4(pos, 1);
    vec4 projPos = uProjectionMatrix * viewPos;
    vec2 ndcPos = projPos.xy / projPos.w;

    vec3 viewUp = (uModelViewMatrix * vec4(extrude.y * up, 0)).xyz;
    vec4 projPosUp = uProjectionMatrix * vec4(viewPos.xyz + viewUp, 1);
    vec2 projExtrudeDir = normalize(projPosUp.xy / projPosUp.w - ndcPos);

    vec2 lxy = abs(sign(projExtrudeDir) - ndcPos);
    ndcPos += length(lxy) * projExtrudeDir;

    vec3 worldPlaneNormal = normalize(cross(up, normalize(end - start)));
    vec3 viewPlaneNormal = (uModelViewMatrix * vec4(worldPlaneNormal, 0)).xyz;

    vViewStart = (uModelViewMatrix * vec4(start, 1)).xyz;
    vViewEnd = (uModelViewMatrix * vec4(end, 1)).xyz;
    vViewPlane = vec4(viewPlaneNormal, -dot(viewPlaneNormal, vViewStart));

    // Add enough padding in the X screen space direction for glow
    float xPaddingPixels = sign(dot(viewPlaneNormal, viewPos.xyz)) * (extrude.x * 2.0 - 1.0) * glowWidth;
    ndcPos.x += xPaddingPixels * pixelToNDC.x;

    uv = ndcPos * 0.5 + 0.5;
    gl_Position = vec4(ndcPos, 0, 1);
  }
  `),t.fragment.uniforms.add("globalAlpha","float"),t.fragment.uniforms.add("perScreenPixelRatio","float"),t.fragment.code.add(r["a"]`
  float planeDistancePixels(vec4 plane, vec3 pos, vec3 start, vec3 end) {
    vec3 origin = mix(start, end, 0.5);
    vec3 basis = end - origin;
    vec3 posAtOrigin = pos - origin;

    float x = dot(normalize(basis), posAtOrigin);
    float y = dot(plane.xyz, posAtOrigin);

    float dx = max(abs(x) - length(basis), 0.0);
    float dy = y;

    float dist = length(vec2(dx, dy));

    float width = fwidth(y);
    float maxPixelDistance = length(pos) * perScreenPixelRatio * 2.0;
    float pixelDist = dist / min(width, maxPixelDistance);
    return abs(pixelDist);
  }

  void main() {
    vec3 pos;
    vec3 normal;
    float depthDiscontinuityAlpha;

    if (!laserlineReconstructFromDepth(pos, normal, depthDiscontinuityAlpha)) {
      discard;
    }

    float distance = planeDistancePixels(vViewPlane, pos, vViewStart, vViewEnd);

    vec4 color = laserlineProfile(distance);
    float alpha = 1.0 - smoothstep(0.995, 0.999, abs(dot(normal, vViewPlane.xyz)));

    gl_FragColor = laserlineOutput(color * alpha * depthDiscontinuityAlpha);
  }
  `),t}var o=Object.freeze({__proto__:null,build:s})},5715:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));i("c120");var r=i("e92d"),a=i("6706"),n=i("7dcb");r["a"].getLogger("esri.views.interactive.snapping.hints.RightAngleSnappingHint");class s extends n["a"]{constructor(e,t,i){super(),this.previousVertex=e,this.centerVertex=t,this.nextVertex=i}equals(e){return e instanceof s&&Object(a["d"])(this.previousVertex,e.previousVertex)&&Object(a["d"])(this.centerVertex,e.centerVertex)&&Object(a["d"])(this.nextVertex,e.nextVertex)}}},"572a":function(e,t,i){"use strict";i.d(t,"a",(function(){return g})),i.d(t,"b",(function(){return b}));var r=i("3886"),a=i("4db9"),n=i("690a"),s=i("d272"),o=i("6a07"),c=i("c2d1"),l=i("040b"),h=i("ea4b"),d=i("d56e"),u=i("5686"),p=i("cd26"),f=i("b4c2"),m=i("5501");function b(e){const t=new n["a"];if(t.include(d["a"],{name:"Terrain Shader",output:e.output}),t.include(f["a"]),t.attributes.add("position","vec3"),t.attributes.add("uv0","vec2"),t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("origin","vec3").add("skirtScale","float"),0===e.output){t.include(a["a"],{linearDepth:!1}),t.include(l["a"],e),t.include(m["a"],e);const i=0!==e.overlayMode,n=2===e.overlayMode;i&&t.include(p["a"],{pbrMode:3,useCustomDTRExponentForWater:!1,ssrEnabled:e.ssrEnabled,highStepCount:e.highStepCount}),n&&t.include(u["a"],e),t.varyings.add("vnormal","vec3"),t.varyings.add("vpos","vec3"),t.vertex.uniforms.add("viewNormal","mat4"),e.receiveShadows&&t.varyings.add("linearDepth","float"),e.tileBorders&&t.varyings.add("vuv","vec2"),e.atmosphere&&(t.vertex.uniforms.add("lightingMainDirection","vec3"),t.varyings.add("wnormal","vec3"),t.varyings.add("wlight","vec3")),e.screenSizePerspective&&(t.vertex.uniforms.add("screenSizePerspective","vec4"),t.varyings.add("screenSizeDistanceToCamera","float"),t.varyings.add("screenSizeCosAngle","float")),t.vertex.code.add(r["a"]`
      void main(void) {
        vpos = position;
        vnormal = getLocalUp(vpos, origin);

        vec2 uv = uv0;
        vpos = applySkirts(uv, vpos, vnormal, skirtScale);
        ${e.atmosphere?r["a"]`
        wnormal = (viewNormal * vec4(normalize(vpos + origin), 1.0)).xyz;
        wlight = (view  * vec4(-lightingMainDirection, 1.0)).xyz;`:""}
        ${e.tileBorders?r["a"]`vuv = uv;`:""}
        ${e.screenSizePerspective?r["a"]`
        vec3 viewPos = (view * vec4(vpos, 1.0)).xyz;
        screenSizeDistanceToCamera = length(viewPos);
        vec3 viewSpaceNormal = (viewNormal * vec4(normalize(vpos + origin), 1.0)).xyz;
        screenSizeCosAngle = abs(viewSpaceNormal.z);`:""}
        gl_Position = transformPosition(proj, view, vpos);
        ${e.receiveShadows?r["a"]`linearDepth = gl_Position.w;`:""}
        forwardTextureCoordinates(uv);
        ${i?r["a"]`setOverlayVTC(uv);`:""}
        ${n?r["a"]`forwardVertexTangent(vnormal);`:r["a"]``}
      }
    `),t.extensions.add("GL_OES_standard_derivatives"),t.extensions.add("GL_EXT_shader_texture_lod"),t.include(s["a"],e),t.include(h["a"],e),t.fragment.uniforms.add("camPos","vec3").add("viewDirection","vec3").add("ssaoTex","sampler2D").add("viewportPixelSz","vec4").add("opacity","float"),e.screenSizePerspective&&t.fragment.uniforms.add("screenSizePerspective","vec4"),n&&(t.fragment.uniforms.add("ovInnerWaterTex","sampler2D"),t.fragment.uniforms.add("ovOuterWaterTex","sampler2D"),t.fragment.uniforms.add("view","mat4")),t.fragment.code.add(r["a"]`
      const vec3 ambient = vec3(0.2, 0.2, 0.2);
      const vec3 diffuse = vec3(0.8, 0.8, 0.8);
      const float diffuseHardness = 2.5;
      const float sliceOpacity = 0.2;

      float lum(vec3 c) {
        float max = max(max(c.r, c.g), c.b);
        float min = min(min(c.r, c.g), c.b);
        return (min + max) * 0.5;
      }
      `),e.atmosphere&&t.fragment.code.add(r["a"]`
      vec3 atmosphere(vec3 lightPos, vec3 normal, vec3 view) {
        vec3 surfaceColor   = vec3(0.0);
        vec3 fuzzySpecColor = vec3(1.0);
        vec3 subColor       = vec3(0.0);
        float rollOff       = 1.0;

        vec3 Ln = normalize(lightPos);
        vec3 Nn = normalize(normal);
        vec3 Hn = normalize(view + Ln);

        float ldn = dot(Ln, Nn);
        float diffComp = max(0.0, ldn);
        // clamp necessary here because values might cause flickering: #21549
        float vdn = clamp(1.0 - dot(view, Nn), 0.0, 1.0);
        float ndv = dot(view, Ln);

        vec3 diffContrib = surfaceColor * diffComp;
        float subLamb = max(0.0, smoothstep(-rollOff, 1.0, ldn) - smoothstep(0.0, 1.0, ldn));

        vec3 subContrib = subLamb * subColor;
        vec3 vecColor = vec3(vdn);

        vec3 diffuseContrib = (subContrib + diffContrib);
        vec3 specularContrib = (vecColor * fuzzySpecColor);

        return (diffContrib + specularContrib) * rollOff;
      }
      `),t.fragment.code.add(r["a"]`
      void main() {
        ${e.receiveShadows?r["a"]`float shadow = readShadowMap(vpos, linearDepth);`:r["a"]`float shadow = 0.0;`}
        float vndl = dot(normalize(vnormal), -lightingMainDirection);
        float k = smoothstep(0.0, 1.0, clamp(vndl*diffuseHardness, 0.0, 1.0));
        vec3 d = (1.0 - shadow/1.8) * diffuse * k;

        float ssao = viewportPixelSz.w < .0 ? 1.0 : texture2D(ssaoTex, (gl_FragCoord.xy - viewportPixelSz.xy) * viewportPixelSz.zw).a;
        vec4 tileColor = getTileColor() * opacity;
        ${i?r["a"]`
            vec4 overlayColorOpaque = getOverlayColor(ovInnerColorTex, ovOuterColorTex, vtcOverlay);
            vec4 overlayColor = overlayOpacity * overlayColorOpaque;
            vec4 groundColor = tileColor;
            tileColor = tileColor * (1.0 - overlayColor.a) + overlayColor;`:""}
        if (rejectBySlice(vpos)) {
          tileColor *= sliceOpacity;
        }
        vec3 atm = vec3(0.0);
        ${e.atmosphere?r["a"]`
            float ndotl = max(0.0, min(1.0, vndl));
            atm = atmosphere(wlight, wnormal, -viewDirection);
            atm *= max(0.0, min(1.0, (1.0-lum(tileColor.rgb)*1.5))); //avoid atmosphere on bright base maps
            atm *= max(0.0, min(1.0, ndotl*2.0)); // avoid atmosphere on dark side of the globe
            atm *= tileColor.a; // premultiply with tile alpha`:""}
        vec3 albedo = atm + tileColor.rgb;
        vec3 normal = normalize(vnormal);

        // heuristic shading function used in the old terrain, now used to add ambient lighting
        float additionalAmbientScale = smoothstep(0.0, 1.0, clamp(vndl*2.5, 0.0, 1.0));
        vec3 additionalLight = ssao * lightingMainIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;

        gl_FragColor = vec4(evaluateSceneLightingExt(normal, albedo, shadow, 1.0 - ssao, additionalLight), tileColor.a);
        ${n?r["a"]`
            vec4 overlayWaterMask = getOverlayColor(ovInnerWaterTex, ovOuterWaterTex, vtcOverlay);
            float waterNormalLength = length(overlayWaterMask);
            if (waterNormalLength > 0.95) {
              mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, vnormal);
              vec4 waterOverlayColor = vec4(overlayColor.w > 0.0 ? overlayColorOpaque.xyz/overlayColor.w : vec3(1.0), overlayColor.w);
              vec4 viewPosition = view*vec4(vpos, 1.0);
              vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vpos - camPos), shadow, vnormal, tbnMatrix, viewPosition.xyz);
              vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
              // un-gamma the ground color to mix in linear space
              gl_FragColor = mix(groundColor, waterColorNonLinear, waterColorLinear.w);
            }`:""}
        ${e.screenSizePerspective?r["a"]`
          float perspectiveScale = screenSizePerspectiveScaleFloat(1.0, screenSizeCosAngle, screenSizeDistanceToCamera, screenSizePerspective);
          if (perspectiveScale <= 0.25) {
            gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 0.0, 1.0), perspectiveScale * 4.0);
          }
          else if (perspectiveScale <= 0.5) {
            gl_FragColor = mix(gl_FragColor, vec4(0.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.25) * 4.0);
          }
          else if (perspectiveScale >= 0.99) {
            gl_FragColor = mix(gl_FragColor, vec4(0.0, 1.0, 0.0, 1.0), 0.2);
          }
          else {
            gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.5) * 2.0);
          }`:""}
        ${e.tileBorders?r["a"]`
            vec2 dVuv = fwidth(vuv);
            vec2 edgeFactors = smoothstep(vec2(0.0), 1.5 * dVuv, min(vuv, 1.0 - vuv));
            float edgeFactor = 1.0 - min(edgeFactors.x, edgeFactors.y);
            gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 0.0, 1.0), edgeFactor);`:""}
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
      }
    `)}return 1!==e.output&&3!==e.output||(t.include(a["a"],{linearDepth:!0}),t.include(c["a"],{output:e.output}),t.include(l["a"],e),t.varyings.add("linearDepth","float"),t.vertex.uniforms.add("nearFar","vec2"),t.vertex.code.add(r["a"]`
        void main(void) {
          vec3 normal = getLocalUp(position, origin);
          vec2 uv = uv0;
          vec3 vpos = applySkirts(uv, position, normal.xyz, skirtScale);

          gl_Position = transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);
        }
    `),t.fragment.code.add(r["a"]`
        void main() {
          outputDepth(linearDepth);
        }
    `)),2===e.output&&(t.include(a["a"],{linearDepth:!1}),t.include(l["a"],e),t.varyings.add("vnormal","vec3"),t.varyings.add("vpos","vec3"),t.vertex.uniforms.add("viewNormal","mat4"),t.vertex.code.add(r["a"]`
        void main(void) {
          vec3 normal = getLocalUp(position, origin);
          vec2 uv = uv0;
          vpos = applySkirts(uv, position, normal, skirtScale);

          gl_Position = transformPosition(proj, view, vpos);
          vnormal = normalize((viewNormal * vec4(normal, 1.0)).xyz);
        }
    `),t.fragment.code.add(r["a"]`
        void main() {
          vec3 normal = normalize(vnormal);
          if (gl_FrontFacing == false) {
            normal = -normal;
          }
          gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 0.0);
        }
    `)),4===e.output&&(t.include(a["a"],{linearDepth:!1}),t.include(l["a"],e),t.include(p["a"],{pbrMode:0}),t.vertex.code.add(r["a"]`
          void main() {
            vec3 vnormal = getLocalUp(position, origin);
            vec2 uv = uv0;
            vec3 vpos = applySkirts(uv, position, vnormal, skirtScale);
            setOverlayVTC(uv);

            gl_Position = transformPosition(proj, view, vpos);
          }
      `),t.include(o["a"]),t.fragment.code.add(r["a"]`
        void main() {
          vec4 overlayColor = getCombinedOverlayColor();

          if (overlayColor.a == 0.0) {
            gl_FragColor = vec4(0.0);
            return;
          }

          outputHighlight();
        }
      `)),t}var g=Object.freeze({__proto__:null,build:b})},5876:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i("3886");function a(e){e.vertex.code.add(r["a"]`
    vec4 decodeSymbolColor(vec4 symbolColor, out int colorMixMode) {
      float symbolAlpha = 0.0;

      const float maxTint = 85.0;
      const float maxReplace = 170.0;
      const float scaleAlpha = 3.0;

      if (symbolColor.a > maxReplace) {
        colorMixMode = ${r["a"].int(1)};
        symbolAlpha = scaleAlpha * (symbolColor.a - maxReplace);
      } else if (symbolColor.a > maxTint) {
        colorMixMode = ${r["a"].int(3)};
        symbolAlpha = scaleAlpha * (symbolColor.a - maxTint);
      } else if (symbolColor.a > 0.0) {
        colorMixMode = ${r["a"].int(4)};
        symbolAlpha = scaleAlpha * symbolColor.a;
      } else {
        colorMixMode = ${r["a"].int(1)};
        symbolAlpha = 0.0;
      }

      return vec4(symbolColor.r, symbolColor.g, symbolColor.b, symbolAlpha);
    }
  `)}},"58c2":function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i("3886");function a(e){e.fragment.uniforms.add("projInfo","vec4"),e.fragment.uniforms.add("zScale","vec2"),e.fragment.code.add(r["a"]`
    vec3 reconstructPosition(vec2 fragCoord, float depth) {
      return vec3((fragCoord * projInfo.xy + projInfo.zw) * (zScale.x * depth + zScale.y), depth);
    }
  `)}},"5d07":function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));var r=i("3886"),a=i("ee2c"),n=i("b3a9");function s(e,t){const i=e.vertex;switch(e.include(n["a"],t),a["a"].usesSketchLogic(t)&&i.uniforms.add("uStrokesAmplitude","float"),t.mode){case 0:i.code.add(r["a"]`
        float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
          return 0.0;
        }
      `);break;case 1:i.code.add(r["a"]`
        float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
          return uStrokesAmplitude;
        }
      `);break;case 2:i.code.add(r["a"]`
        float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
          float type = unpackedAttributes.type;

          if (type <= 0.0) {
            return uStrokesAmplitude;
          }
          else {
            return 0.0;
          }
        }
      `)}}},"5d5f":function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));var r=i("3886"),a=i("c51b");function n(e){const t=e.fragment.code;t.add(r["a"]`
    vec3 evaluateDiffuseIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float NdotNG)
    {
      return ((1.0 - NdotNG) * ambientGround + (1.0 + NdotNG) * ambientSky) * 0.5;
    }
    `),t.add(r["a"]`
    float integratedRadiance(float cosTheta2, float roughness)
    {
      return (cosTheta2 - 1.0) / (cosTheta2 * (1.0 - roughness * roughness) - 1.0);
    }
    `),t.add(r["a"]`
    vec3 evaluateSpecularIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float RdotNG, float roughness)
    {
      float cosTheta2 = 1.0 - RdotNG * RdotNG;
      float intRadTheta = integratedRadiance(cosTheta2, roughness);

      // Calculate the integrated directional radiance of the ground and the sky
      float ground = RdotNG < 0.0 ? 1.0 - intRadTheta : 1.0 + intRadTheta;
      float sky = 2.0 - ground;
      return (ground * ambientGround + sky * ambientSky) * 0.5;
    }
    `)}function s(e,t){const i=e.fragment.code;e.include(a["a"]),3===t.pbrMode||4===t.pbrMode?(i.add(r["a"]`
    struct PBRShadingWater
    {
        float NdotL;   // cos angle between normal and light direction
        float NdotV;   // cos angle between normal and view direction
        float NdotH;   // cos angle between normal and half vector
        float VdotH;   // cos angle between view direction and half vector
        float LdotH;   // cos angle between light direction and half vector
        float VdotN;   // cos angle between view direction and normal vector
    };

    float dtrExponent = ${t.useCustomDTRExponentForWater?"2.2":"2.0"};
    `),i.add(r["a"]`
    vec3 fresnelReflection(float angle, vec3 f0, float f90) {
      return f0 + (f90 - f0) * pow(1.0 - angle, 5.0);
    }
    `),i.add(r["a"]`
    float normalDistributionWater(float NdotH, float roughness)
    {
      float r2 = roughness * roughness;
      float NdotH2 = NdotH * NdotH;
      float denom = pow((NdotH2 * (r2 - 1.0) + 1.0), dtrExponent) * PI;
      return r2 / denom;
    }
    `),i.add(r["a"]`
    float geometricOcclusionKelemen(float LoH)
    {
        return 0.25 / (LoH * LoH);
    }
    `),i.add(r["a"]`
    vec3 brdfSpecularWater(in PBRShadingWater props, float roughness, vec3 F0, float F0Max)
    {
      vec3  F = fresnelReflection(props.VdotH, F0, F0Max);
      float dSun = normalDistributionWater(props.NdotH, roughness);
      float V = geometricOcclusionKelemen(props.LdotH);

      float diffusionSunHaze = mix(roughness + 0.045, roughness + 0.385, 1.0 - props.VdotH);
      float strengthSunHaze  = 1.2;
      float dSunHaze = normalDistributionWater(props.NdotH, diffusionSunHaze)*strengthSunHaze;

      return ((dSun + dSunHaze) * V) * F;
    }

    vec3 tonemapACES(const vec3 x) {
      return (x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14);
    }
    `)):1!==t.pbrMode&&2!==t.pbrMode||(e.include(n),i.add(r["a"]`
    struct PBRShadingInfo
    {
        float NdotL;                  // cos angle between normal and light direction
        float NdotV;                  // cos angle between normal and view direction
        float NdotH;                  // cos angle between normal and half vector
        float VdotH;                  // cos angle between view direction and half vector
        float LdotH;                  // cos angle between view light direction and half vector
        float NdotNG;                 // cos angle between normal and normal of the ground
        float RdotNG;                 // cos angle between view direction reflected of the normal and normal of the ground
        float NdotAmbDir;             // cos angle between view direction and the fill light in ambient illumination
        float NdotH_Horizon;          // cos angle between normal and half vector defined with horizon illumination
        vec3 skyRadianceToSurface;         // integrated radiance of the sky based on the surface roughness (used for specular reflection)
        vec3 groundRadianceToSurface;      // integrated radiance of the ground based on the surface roughness (used for specular reflection)
        vec3 skyIrradianceToSurface;       // irradiance of the sky (used for diffuse reflection)
        vec3 groundIrradianceToSurface;    // irradiance of the ground (used for diffuse reflection)

        float averageAmbientRadiance;      // average ambient radiance used to deduce black level in gamut mapping
        float ssao;                   // ssao coefficient
        vec3 albedoLinear;            // linear color of the albedo
        vec3 f0;                      // fresnel value at normal incident light
        vec3 f90;                     // fresnel value at 90o of incident light

        vec3 diffuseColor;            // diffuse color of the material used in environment illumination
        float metalness;              // metalness of the material
        float roughness;              // roughness of the material
    };
    `),i.add(r["a"]`
    float normalDistribution(float NdotH, float roughness)
    {
        float a = NdotH * roughness;
        float b = roughness / (1.0 - NdotH * NdotH + a * a);
        return b * b * INV_PI;
    }
    `),i.add(r["a"]`
    const vec4 c0 = vec4(-1.0, -0.0275, -0.572,  0.022);
    const vec4 c1 = vec4( 1.0,  0.0425,  1.040, -0.040);
    const vec2 c2 = vec2(-1.04, 1.04);

    vec2 prefilteredDFGAnalytical(float roughness, float NdotV) {
        vec4 r = roughness * c0 + c1;
        float a004 = min(r.x * r.x, exp2(-9.28 * NdotV)) * r.x + r.y;
        return c2 * a004 + r.zw;
    }
    `),i.add(r["a"]`
    vec3 evaluateEnvironmentIllumination(PBRShadingInfo inputs) {
      vec3 indirectDiffuse = evaluateDiffuseIlluminationHemisphere(inputs.groundIrradianceToSurface, inputs.skyIrradianceToSurface, inputs.NdotNG);
      vec3 indirectSpecular = evaluateSpecularIlluminationHemisphere(inputs.groundRadianceToSurface, inputs.skyRadianceToSurface, inputs.RdotNG, inputs.roughness);

      // From diffuse illumination calculate reflected color
      vec3 diffuseComponent = inputs.diffuseColor * indirectDiffuse * INV_PI;

      // From specular illumination calculate reflected color
      vec2 dfg = prefilteredDFGAnalytical(inputs.roughness, inputs.NdotV);
      vec3 specularColor = inputs.f0 * dfg.x + inputs.f90 * dfg.y;
      vec3 specularComponent = specularColor * indirectSpecular;

      return (diffuseComponent + specularComponent);
    }
    `),i.add(r["a"]`
    float gamutMapChanel(float x, vec2 p){
      return (x < p.x) ? mix(0.0, p.y, x/p.x) : mix(p.y, 1.0, (x - p.x) / (1.0 - p.x) );
    }`),i.add(r["a"]`
    vec3 blackLevelSoftCompression(vec3 inColor, PBRShadingInfo inputs){
      vec3 outColor;
      vec2 p = vec2(0.02 * (inputs.averageAmbientRadiance), 0.0075 * (inputs.averageAmbientRadiance));
      outColor.x = gamutMapChanel(inColor.x, p) ;
      outColor.y = gamutMapChanel(inColor.y, p) ;
      outColor.z = gamutMapChanel(inColor.z, p) ;
      return outColor;
    }
    `))}},"5e2a":function(e,t,i){"use strict";i.d(t,"a",(function(){return v})),i.d(t,"b",(function(){return b})),i.d(t,"c",(function(){return g}));var r=i("3886"),a=i("690a"),n=i("d272"),s=i("d047"),o=i("c6d7"),c=i("6fcc"),l=i("c3a3"),h=i("c332f"),d=i("1af8"),u=i("ee2c"),p=i("b3a9"),f=i("5d07"),m=i("de47");const b={position0:0,position1:1,componentIndex:2,packedAttributes:3,variantOffset:4,variantStroke:5,variantExtension:6,normal:7,normalA:7,normalB:8,sideness:9};function g(e){const t=new a["a"],i=t.vertex,b=t.fragment;return e.legacy&&i.uniforms.add("uModel","mat4"),e.antialiasing&&(i.code.add(r["a"]`
      #define ANTIALIASING 1
    `),b.code.add(r["a"]`
      #define ANTIALIASING 1
    `)),t.include(c["a"],e),t.include(f["a"],e),t.include(u["a"],e),t.include(p["a"],e),t.include(m["a"],e),t.include(n["a"],e),t.include(h["a"],e),t.include(l["a"],e),t.include(d["a"],e),t.varyings.add("vColor","vec4"),t.varyings.add("vRadius","float"),t.varyings.add("vPosition","vec3"),t.varyings.add("vWorldPosition","vec3"),t.varyings.add("vViewPos","vec3"),t.varyings.add("vLineLengthPixels","float"),t.varyings.add("vSizeFalloffFactor","float"),i.uniforms.add("uPixelToNDC","vec2"),i.uniforms.add("uNDCToPixel","vec2"),i.uniforms.add("uPixelRatio","float"),t.attributes.add("position0","vec3"),t.attributes.add("position1","vec3"),t.attributes.add("variantOffset","float"),t.attributes.add("variantStroke","float"),t.attributes.add("variantExtension","float"),i.code.add(r["a"]`
    const float opaqueCutoff = 1.0 / 255.0;

    void calculateGeometricOutputs(vec3 viewPosV0, vec3 viewPosV1, vec3 worldPosV0, vec3 worldPosV1, vec3 worldNormal, UnpackedAttributes unpackedAttributes) {
      vec2 sideness = unpackedAttributes.sideness;
      vec2 sidenessNorm = unpackedAttributes.sidenessNorm;

      vWorldPosition = mix(worldPosV0, worldPosV1, sidenessNorm.y).xyz;

      vec3 viewPos = mix(viewPosV0, viewPosV1, sidenessNorm.y);
      vViewPos = viewPos;

      vec4 projPosV0 = projFromViewPosition(viewPosV0);
      vec4 projPosV1 = projFromViewPosition(viewPosV1);
      vec4 projPos = projFromViewPosition(viewPos);

      vec3 screenSpaceLineNDC = (projPosV1.xyz / projPosV1.w - projPosV0.xyz / projPosV0.w);
      vec2 screenSpaceLinePixels = screenSpaceLineNDC.xy * uNDCToPixel;
      float lineLengthPixels = length(screenSpaceLinePixels);

      float dzPerPixel = screenSpaceLineNDC.z / lineLengthPixels;
      vec2 screenSpaceDirection = screenSpaceLinePixels / lineLengthPixels;
      vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x) * sideness.x;

      float falloffFactor = distanceBasedPerspectiveFactor(-viewPos.z) * uPixelRatio;
      float lineWidthPixels = unpackedAttributes.lineWidthPixels * falloffFactor;

      float extensionLengthPixels = calculateExtensionLength(unpackedAttributes.extensionLengthPixels, lineLengthPixels) * falloffFactor;
      float lineAmplitudePixels = calculateLineAmplitude(unpackedAttributes) * uPixelRatio;

      vSizeFalloffFactor = falloffFactor;

      float lineWidthAndAmplitudePixels = lineWidthPixels + lineAmplitudePixels + lineAmplitudePixels;
      float extendedLineLengthPixels = lineLengthPixels + extensionLengthPixels + extensionLengthPixels;

    #ifdef ANTIALIASING
      const float aaPaddingPixels = 1.0;

      // Line size with padding
      float halfAAPaddedLineWidthAndAmplitudePixels = lineWidthAndAmplitudePixels * 0.5 + aaPaddingPixels;
      float aaPaddedRoundedCapSizePixels = lineWidthPixels * 0.5 + aaPaddingPixels;
    #else /* ANTIALIASING */

      // Even if there is no AA, we still want to do proper <1px rendering,
      // so we effectively clamp the pixel sizes to minimum of 1px and compute
      // coverage in the fragment shader
      float halfAAPaddedLineWidthAndAmplitudePixels = max(lineWidthAndAmplitudePixels, 1.0) * 0.5;
      float aaPaddedRoundedCapSizePixels = max(lineWidthPixels, 1.0) * 0.5;
    #endif /* ANTIALIASING */

      // Half line width in NDC including padding for anti aliasing
      vec2 halfAAPaddedLineWidthAndAmplitudeNDC = halfAAPaddedLineWidthAndAmplitudePixels * uPixelToNDC;
      vec2 aaPaddedRoundedCapSizeNDC = aaPaddedRoundedCapSizePixels * uPixelToNDC;
      vec2 extensionLengthNDC = extensionLengthPixels * uPixelToNDC;

      // Compute screen space position of vertex, offsetting for line size and end caps
      vec2 ndcOffset = (
          screenSpaceDirection * sideness.y * (aaPaddedRoundedCapSizeNDC + extensionLengthNDC)
        + perpendicularScreenSpaceDirection * halfAAPaddedLineWidthAndAmplitudeNDC
      );

      projPos.xy += ndcOffset * projPos.w;
      projPos.z += (dzPerPixel * (aaPaddedRoundedCapSizePixels + extensionLengthPixels)) * sideness.y * projPos.w;

      projPos = adjustProjectedPosition(projPos, worldNormal, 1.0 + max((lineWidthAndAmplitudePixels - 1.0) * 0.5, 0.0));

      // Line length with end caps
      float aaPaddedLineWithCapsLengthPixels = extendedLineLengthPixels + aaPaddedRoundedCapSizePixels + aaPaddedRoundedCapSizePixels;

      float pixelPositionAlongLine = aaPaddedLineWithCapsLengthPixels * sidenessNorm.y - aaPaddedRoundedCapSizePixels;

      // Position in pixels with origin at first vertex of line segment
      vPosition = vec3(
        halfAAPaddedLineWidthAndAmplitudePixels * sideness.x,
        pixelPositionAlongLine,
        pixelPositionAlongLine / extendedLineLengthPixels
      );

      // The line width radius in pixels
      vRadius = lineWidthPixels * 0.5;
      vLineLengthPixels = extendedLineLengthPixels;

      // discard edges below a certain length threshold
      discardShortEdges(unpackedAttributes, lineLengthPixels);

      gl_Position = projPos;
    }

    void main() {
      ComponentData component = readComponentData();
      UnpackedAttributes unpackedAttributes = unpackAttributes(component);

      vec3 worldPosV0 = worldFromModelPosition(position0);
      vec3 worldPosV1 = worldFromModelPosition(position1);
      vec3 viewPosV0 = viewFromModelPosition(position0);
      vec3 viewPosV1 = viewFromModelPosition(position1);

      // Component color
      vColor = component.color;

      // Discard fully transparent edges
      if (vColor.a < opaqueCutoff) {
        gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
        return;
      }

      if (discardNonSilhouetteEdges(viewPosV0, worldPosV0)) {
        return;
      }

      // General geometric computation for all types of edges
      calculateGeometricOutputs(viewPosV0, viewPosV1, worldPosV0, worldPosV1, worldNormal(), unpackedAttributes);

      // Specific computation for different edge styles
      calculateStyleOutputs(unpackedAttributes);
    }
  `),e.multipassTerrainEnabled&&(t.fragment.include(s["a"]),t.include(o["b"],e)),t.fragment.code.add(r["a"]`
    vec2 lineWithCapsDistance(float radius, vec2 position, float lineLength) {
      float lineOffset = calculateLineOffset();
      float positionX = position.x - lineOffset;

      if (radius < 1.0) {
        // Handle this specifically for subpixel sizes:
        // 1. Compute correct coverage (note coverage is computed by
        //    0.5 - dist, so we make sure that that will lead to correct
        //    subpixel coverage
        // 2. Ignore rounded caps
        float coverageX = clamp(min(radius, positionX + 0.5) - max(-radius, positionX - 0.5), 0.0, 1.0);
        float coverageY = clamp(min(lineLength, position.y + 0.5) - max(0.0, position.y - 0.5), 0.0, 1.0);

        float coverage = min(coverageX, coverageY);

        return vec2(0.5 - coverage, 0.0);
      }
      else {
        // Between -radius -> 0 for start cap, 0 for line, 0 -> radius
        float positionOnCap = position.y - clamp(position.y, 0.0, lineLength);

        vec2 lineToPosition = vec2(positionX, positionOnCap);
        return vec2(length(lineToPosition) - radius, positionOnCap / radius);
      }
    }

    void main() {
      ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, vViewPos.z);":""}
      float radius = vRadius * calculateLinePressure();

      vec2 distance = lineWithCapsDistance(radius, vPosition.xy, vLineLengthPixels);
      float coverage = clamp(0.5 - distance.x, 0.0, 1.0);

      discardByCoverage(radius, coverage);
      discardBySlice(vWorldPosition);

      float alpha = vColor.a * coverage;

      gl_FragColor = vec4(vColor.rgb, alpha);

    }
  `),t}var v=Object.freeze({__proto__:null,attributeLocations:b,build:g})},"5e82":function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i("f4cc");class a{constructor(){this._abortController=null,this._loadStatus=0,this._loadError=null,this._loader=null,this.logger=null}get loadStatus(){return this._loadStatus}load(e,t){return 1===this._loadStatus?(e&&e(),this._loader):2===this._loadStatus?(t&&t(this._loadError),this._loader):(this._loader||(this._abortController=Object(r["e"])(),this._loader=this.doLoad(this._abortController.signal).then(()=>{this._abortController=null,this._loadStatus=1},e=>{throw this._loadError=e,this._abortController=null,this._loadStatus=2,!Object(r["n"])(e)&&this.logger&&e.message&&this.logger.warn(e.message),e})),this._loader.then(e,t).catch(()=>{}),this._loader)}abortLoad(){this._abortController?(this._abortController.abort(),this._abortController=null):0===this._loadStatus&&(this._loadStatus=2),this._loader=null}}},"5fae":function(e,t,i){"use strict";i.d(t,"a",(function(){return l}));var r=i("b2b2"),a=i("d791"),n=i("afe1"),s=i("5a22"),o=i("748f"),c=i("f53a");class l extends c["a"]{constructor(e){super(e.view),this._resources=null,this._transform=Object(n["b"])()}get object(){return Object(r["k"])(this._resources)?this._resources.object:null}get transform(){return this._transform}set transform(e){Object(a["c"])(this._transform,e),Object(r["k"])(this._resources)&&(this._resources.object.transformation=this._transform,this._resources.layer.commit())}recreate(){this.attached&&this.createResources()}recreateGeometry(){if(Object(r["j"])(this._resources))return;const e=this._resources.object,t=this.view._stage;t.removeMany(e.geometries),e.removeAllGeometries(),this.createGeometries(e),this.visible||e.setVisible(this.visible),t.addMany(e.geometries),this._resources.layer.commit()}createResources(){this.destroyResources();const e=this.view._stage;if(!e)return;const t=new o["a"]({isPickable:!1});e.add(t);const i=new s["a"]({castShadow:!1});i.transformation=this._transform,this.createExternalResources(),this.createGeometries(i),e.addMany(i.geometries),this.forEachExternalMaterial(t=>e.add(t)),e.add(i),t.add(i),t.commit(),this.visible||(i.setVisible(!1),t.commit()),this._resources={layer:t,object:i}}destroyResources(){const e=this.view._stage;!Object(r["j"])(this._resources)&&e&&(e.remove(this._resources.object),e.remove(this._resources.layer),this.forEachExternalMaterial(t=>{e.remove(t),t.dispose()}),e.removeMany(this._resources.object.geometries),this._resources.object.dispose(),this.destroyExternalResources(),this._resources=null)}updateVisibility(e){Object(r["j"])(this._resources)||(this._resources.object.setVisible(e),this._resources.layer.commit())}}},6061:function(e,t,i){"use strict";i.d(t,"a",(function(){return u}));var r=i("b2b2"),a=i("e431"),n=i("680b"),s=i("d791"),o=i("afe1"),c=i("0fc4"),l=i("1038"),h=i("bea9"),d=i("b623");class u{constructor(e,t,i=null,r=null,a,n,s,o,l){this.data=e,this.material=t,this.layerUid=i,this.graphicUid=r,this.boundingSphere=Object(c["c"])(),this.instanceParameters={highlights:null,occludees:null,visible:!0},this.shaderTransformationDirty=!0,this.boundingInfo=a,this.material=t,this.origin=null,this.transformation=null,this.calculateShaderTransformation=s,n&&this.updateTransformation(n,o),this.castShadow=l}updateTransformation(e,t){this.transformation=e,this.shaderTransformationDirty=!0,this.computeBoundingSphere(e,t,this.boundingSphere)}shaderTransformationChanged(){this.shaderTransformationDirty=!0}computeBoundingSphere(e,t,i){Object(r["j"])(this.boundingInfo)||(t=t||Object(n["j"])(e),Object(a["n"])(i,this.boundingInfo.getCenter(),e),i[3]=this.boundingInfo.getBSRadius()*t)}get hasShaderTransformation(){return Object(r["k"])(this.calculateShaderTransformation)}get primitiveType(){return this.data.primitiveType}getShaderTransformation(){return Object(r["j"])(this.calculateShaderTransformation)?Object(r["u"])(this.transformation,o["a"]):(this.shaderTransformationDirty&&(this.shaderTransformation||(this.shaderTransformation=Object(o["b"])()),Object(s["c"])(this.shaderTransformation,this.calculateShaderTransformation(Object(r["u"])(this.transformation,o["a"]))),this.shaderTransformationDirty=!1),this.shaderTransformation)}computeAttachmentOrigin(e){if(this.material.computeAttachmentOrigin)return!!this.material.computeAttachmentOrigin(this,e)&&(Object(r["k"])(this.transformation)&&Object(a["n"])(e,e,this.transformation),!0);const t=this.indices.get("position"),i=this.vertexAttributes.get("position");return!!Object(l["c"])(i,t,e)&&(Object(r["k"])(this.transformation)&&Object(a["n"])(e,e,this.transformation),!0)}get indices(){return this.data.indices}get vertexAttributes(){return this.data.vertexAttributes}addHighlight(){const e=new h["a"](0),t=this.instanceParameters;return t.highlights=Object(d["b"])(t.highlights,e),e}removeHighlight(e){const t=this.instanceParameters;t.highlights=Object(d["g"])(t.highlights,e)}}},6316:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));var r=i("3886"),a=i("bc40"),n=i("7d11");function s(e,t){const i=e.fragment;0===t.doubleSidedMode?i.code.add(r["a"]`
      vec3 _adjustDoublesided(vec3 normal) {
        return normal;
      }
    `):1===t.doubleSidedMode?(e.include(a["a"],t),i.uniforms.add("uTransform_ViewFromCameraLocal_T","vec3"),i.code.add(r["a"]`
      vec3 _adjustDoublesided(vec3 normal) {
        vec3 viewDir = vPositionWorldCameraRelative + uTransform_ViewFromCameraLocal_T;
        return dot(normal, viewDir) > 0.0 ? -normal : normal;
      }
    `)):2===t.doubleSidedMode&&i.code.add(r["a"]`
      vec3 _adjustDoublesided(vec3 normal) {
        return gl_FrontFacing ? normal : -normal;
      }
    `),0===t.normalType||1===t.normalType?(e.include(n["a"],t),i.code.add(r["a"]`
      vec3 shadingNormalWorld() {
        return _adjustDoublesided(normalize(vNormalWorld));
      }

      vec3 shadingNormal_view() {
        vec3 normal = normalize(vNormalView);
        return gl_FrontFacing ? normal : -normal;
      }
    `)):3===t.normalType?(e.extensions.add("GL_OES_standard_derivatives"),e.include(a["a"],t),i.code.add(r["a"]`
      vec3 shadingNormalWorld() {
        return normalize(cross(
          dFdx(vPositionWorldCameraRelative),
          dFdy(vPositionWorldCameraRelative)
        ));
      }

      vec3 shadingNormal_view() {
        return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view)));
      }
    `)):2===t.normalType&&(1===t.viewingMode?(e.include(a["a"],t),i.code.add(r["a"]`
        vec3 shadingNormalWorld() {
          return normalize(positionWorld());
        }
      `)):2===t.viewingMode&&i.code.add(r["a"]`
        vec3 shadingNormalWorld() {
          return vec3(0.0, 0.0, 1.0);
        }
      `),e.extensions.add("GL_OES_standard_derivatives"),i.code.add(r["a"]`
      vec3 shadingNormal_view() {
        return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view))).xyz;
      }
    `))}},6339:function(e,t,i){"use strict";var r=i("b2b2"),a=i("f4cc"),n=i("792b"),s=i("7b96"),o=i("5e82"),c=i("a803"),l=i("3745"),h=i("e92d"),d=i("ce50"),u=i("0b2d"),p=i("e431"),f=i("d791"),m=i("8188"),b=i("dae5"),g=i("afe1"),v=i("fb2c"),y=i("1c92"),O=i("55e6"),_=i("668b"),x=i("4261"),j=i("0cb9"),w=i("0278"),S=i("5a22"),C=i("6611"),T=i("ba58"),P=i("2e0f"),A=i("0eb9"),R=i("ec13"),M=i("7f60"),E=i("d1ac"),D=i("3af1"),I=i("1219"),L=(i("e06a"),i("1666")),V=i("7585");function k(e){const t=[["position",e.indices]],i=[["position",{size:3,data:e.attributeData.position,exclusive:!0}]];return Object(r["k"])(e.attributeData.color)&&(i.push(["color",{size:4,data:e.attributeData.color,exclusive:!0}]),t.push(["color",new Uint32Array(e.indices.length)])),Object(r["k"])(e.attributeData.uvMapSpace)&&(i.push(["uvMapSpace",{size:4,data:e.attributeData.uvMapSpace,exclusive:!0}]),t.push(["uvMapSpace",e.indices])),Object(r["k"])(e.attributeData.boundingRect)&&(i.push(["boundingRect",{size:9,data:e.attributeData.boundingRect,exclusive:!0}]),t.push(["boundingRect",e.indices])),Object(r["k"])(e.attributeData.mapPosition)&&(i.push(["mapPos",{size:3,data:e.attributeData.mapPosition,exclusive:!0}]),t.push(["mapPos",e.indices])),new w["a"](i,t)}function F(e){const t=[["position",e.indices],["uv0",e.indices]],i=[["position",{size:3,data:e.attributeData.position,exclusive:!0}],["uv0",{size:2,data:e.attributeData.uv0,exclusive:!0}]];return Object(r["k"])(e.attributeData.mapPosition)&&(i.push(["mapPos",{size:3,data:e.attributeData.mapPosition,exclusive:!0}]),t.push(["mapPos",e.indices])),new w["a"](i,t)}function z(e){switch(e.type){case"extent":if(e instanceof D["a"])return I["a"].fromExtent(e);break;case"polygon":return e}return null}function U(e,t,i,r){const a=Object(L["a"])(e.rings,e.hasZ,1),n=new Float64Array(a.position.length),s=Object(P["c"])(a.position,e.spatialReference,0,n,0,a.position,0,a.position.length/3,t,i,r),o=null!=s;return{position:a.position,mapPosition:n,polygons:H(a.polygons,a.position,n),outlines:B(a.outlines,a.position,n),projectionSuccess:o,sampledElevation:s}}function G(e,t){const i=Object(L["a"])(e.rings,!1,1),r=Object(m["q"])(i.position,e.spatialReference,0,i.position,t,0,i.position.length/3);for(let a=2;a<i.position.length;a+=3)i.position[a]=V["a"];return{position:i.position,polygons:H(i.polygons,i.position),outlines:B(i.outlines,i.position),projectionSuccess:r}}function B(e,t,i){const r=new Array;for(const{index:a,count:n}of e){if(n<=1)continue;const e=3*a,s=e+3*n;r.push({index:a,count:n,position:t.subarray(e,s),mapPosition:i?i.subarray(e,s):void 0})}return r}function H(e,t,i){const r=new Array;for(const{index:a,count:n,holeIndices:s,pathLengths:o}of e){if(n<=1)continue;const e=3*a,c=e+3*n,l=s.map(e=>e-a);r.push({index:a,count:n,holeIndices:l,pathLengths:o,position:t.subarray(e,c),mapPosition:i?i.subarray(e,c):void 0})}return r}var N=i("dbad");const q=["polygon","extent"];class W extends M["a"]{constructor(e,t,i,r){super(e,t,i,r),this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const e=Object(T["k"])(this._getSymbolSize());if(e)throw new d["a"]("graphics3dextrudesymbollayer:invalid-size",e)}const e=Object(r["i"])(this.symbolLayer,"material","color"),t=this._getCombinedOpacityAndColor(e),i=Object(u["f"])(t),a=t[3],n={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:i,ambient:i,opacity:a,transparent:a<1||this.needsDrivenTransparentPass,vertexColors:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0};this._material=new N["b"](n),this._bottomMaterial=new N["b"]({...n,cullFace:2}),this._context.stage.add(this._material),this._context.stage.add(this._bottomMaterial)}destroy(){super.destroy(),this._material&&(this._context.stage.remove(this._material),this._context.stage.remove(this._bottomMaterial))}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,q,this.symbolLayer.type))return null;const i=this._getVertexOpacityAndColor(e.renderingInfo,255),r=this.setGraphicElevationContext(t,new A["a"]);return this._createAs3DShape(t,e.renderingInfo,i,r,t.uid)}layerOpacityChanged(e,t){const i=Object(r["i"])(this.symbolLayer,"material","color"),a=this._getCombinedOpacity(i),n=a<1||this.needsDrivenTransparentPass;this._material.setParameterValues({opacity:a,transparent:n}),this._bottomMaterial.setParameterValues({opacity:a,transparent:n});const s=this._getLayerOpacity();return e.forEach(e=>{const i=t(e);Object(r["k"])(i)&&i.layerOpacityChanged(s,this._context.isAsync)}),!0}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,P["g"])}slicePlaneEnabledChanged(e,t){return this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),this._bottomMaterial.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),e.forEach(e=>{const i=t(e);Object(r["k"])(i)&&i.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){return this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._bottomMaterial.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}pixelRatioChanged(){return!0}_getExtrusionSize(e){let t;var i;return t=e.size&&this._drivenProperties.size?null!=(i=Object(E["a"])(e.size,2))?i:0:this._getSymbolSize(),t/=this._context.renderCoordsHelper.unitInMeters,t}_getSymbolSize(){var e;return null!=(e=this.symbolLayer.size)?e:1}_createAs3DShape(e,t,i,a,n){const o=z(e.geometry);if(Object(r["j"])(o))return null;const c=U(o,this._context.elevationProvider,this._context.renderCoordsHelper,a);if(this._logGeometryCreationWarnings(c,o.rings,"rings","ExtrudeSymbol3DLayer"),0===o.rings.length||!o.rings.some(e=>e.length>0))return null;const l=Object(T["a"])(o);if(Object(r["j"])(l))return null;const h=new Array,d=new Array,p=new Array,j=Object(x["h"])(),w=Object(g["b"])(),C=Object(u["e"])(),A=1===this._context.renderCoordsHelper.viewingMode;A||this._context.renderCoordsHelper.worldUpAtPosition(null,C),Object(m["d"])(o.spatialReference,[l.x,l.y,0],w,this._context.renderCoordsHelper.spatialReference);const M=Object(g["b"])();Object(f["a"])(M,w);const E=Object(b["a"])();Object(y["k"])(E,M);const{polygons:D,mapPosition:I,position:L}=c,V=L.length/3,k=new Float64Array(3*V*6),F=new Float64Array(3*V*6),G=new Float64Array(3*V*6),B=new Float64Array(1*V*6);let H=0;for(let r=0;r<D.length;++r){const e=D[r],a=e.count;if(this._context.clippingExtent&&(Object(x["k"])(j),Object(x["n"])(j,e.mapPosition),!Object(x["x"])(j,this._context.clippingExtent)))continue;const n=Object(v["b"])(e.mapPosition,e.holeIndices,3);if(0===n.length)continue;const s=3*a*2+n.length,o=new Uint32Array(s),c=new Uint32Array(n.length),l=6*a,u=3*k.BYTES_PER_ELEMENT,f=new O["v"](k.buffer,H*u,u,(H+l)*u),m=3*F.BYTES_PER_ELEMENT,b=new O["v"](F.buffer,H*m,m,(H+l)*m),y=new Float64Array(G.buffer,3*H*G.BYTES_PER_ELEMENT,3*l),w=new Float64Array(B.buffer,1*H*B.BYTES_PER_ELEMENT,1*l),S=this._getExtrusionSize(t);Z(L,I,n,e,f.typedBuffer,y,b.typedBuffer,w,0,o,c,S,C,A),Object(_["c"])(f,f,M),Object(_["a"])(b,b,E),H+=6*a;const T=this._createExtrudeGeometry(o,o.length-c.length,{positions:f.typedBuffer,elevation:y,normals:b.typedBuffer,heights:w},i);h.push(T),d.push(this._material),p.push(g["a"]);const P=this._createExtrudeGeometry(c,0,{positions:f.typedBuffer,elevation:y,normals:b.typedBuffer,heights:w},i);h.push(P),d.push(this._bottomMaterial),p.push(g["a"])}if(0===h.length)return null;const N=new S["a"]({geometries:h,materials:d,transformations:p,metadata:{layerUid:this._context.layer.uid,graphicUid:n,isElevationSource:!0}});N.transformation=w;const q=ne,W=Object(R["a"])(this.symbolLayer,{opacity:this._getLayerOpacity()}),$=Object(r["k"])(W)?{baseMaterial:this._material,edgeMaterials:[W],properties:{mergeGeometries:!0,slicePlaneEnabled:this._context.slicePlaneEnabled}}:null,Q=new s["a"](this,N,h,null,null,q,a,$);return Q.alignedSampledElevation=c.sampledElevation,Q.needsElevationUpdates=Object(P["g"])(a.mode),Q}_createExtrudeGeometry(e,t,i,r){const a=new Uint32Array(e.length),n=[["position",{size:3,data:i.positions,exclusive:!0}],["normal",{size:3,data:i.normals,exclusive:!0}],["color",{size:4,data:r,exclusive:!0}],["size",{size:1,data:i.heights,exclusive:!0}]],s=[["position",e],["normal",e],["color",a]];return i.elevation&&(n.push(["mapPos",{size:3,data:i.elevation}]),s.push(["mapPos",e])),new w["a"](n,s,0,t)}}function Z(e,t,i,r,a,n,s,o,c,l,h,d,u,p){const f=i.length/3;let m=0,b=2*r.count;$(e,t,r.index,r.count,i,0,f,a,n,s,o,c,l,h,b,d,u,p),c+=2*r.count,b=0,Y(a,n,o,s,m,r.pathLengths[0],r.count,c,l,b,d),c+=4*r.pathLengths[0],b+=2*r.pathLengths[0],m+=r.pathLengths[0];for(let g=1;g<r.pathLengths.length;++g)Y(a,n,o,s,m,r.pathLengths[g],r.count,c,l,b,d),c+=4*r.pathLengths[g],b+=2*r.pathLengths[g],m+=r.pathLengths[g]}function $(e,t,i,r,a,n,s,o,c,l,h,d,u,f,m,b,g,v){Object(p["l"])(oe,g);const y=b>0?1:-1;let O=3*i,_=d,x=3*_,j=d+r,w=3*j;for(let T=0;T<r;++T)v&&(oe[0]=e[O+0],oe[1]=e[O+1],oe[2]=e[O+2],Object(p["s"])(oe,oe)),o[x+0]=e[O+0],o[x+1]=e[O+1],o[x+2]=e[O+2],c[x+0]=t[O+0],c[x+1]=t[O+1],c[x+2]=t[O+2],l[x+0]=-y*oe[0],l[x+1]=-y*oe[1],l[x+2]=-y*oe[2],h[_]=0,o[w+0]=e[O+0]+b*oe[0],o[w+1]=e[O+1]+b*oe[1],o[w+2]=e[O+2]+b*oe[2],c[w+0]=t[O+0],c[w+1]=t[O+1],c[w+2]=t[O+2],l[w+0]=y*oe[0],l[w+1]=y*oe[1],l[w+2]=y*oe[2],h[j]=b,x+=3,w+=3,O+=3,_+=1,j+=1;O=3*n,x=0,w=3*m;const S=b<0?le:ce,C=b<0?ce:le;for(let p=0;p<s;++p)f[x+0]=a[O+S[0]],f[x+1]=a[O+S[1]],f[x+2]=a[O+S[2]],u[w+0]=a[O+C[0]]+r,u[w+1]=a[O+C[1]]+r,u[w+2]=a[O+C[2]]+r,x+=3,w+=3,O+=3}function Q(e,t,i,r,a,n,s){r[n]=r[s],s*=3,e[0+(n*=3)]=e[s+0],e[n+1]=e[s+1],e[n+2]=e[s+2],t[n+0]=t[s+0],t[n+1]=t[s+1],t[n+2]=t[s+2],i[n+0]=a[0],i[n+1]=a[1],i[n+2]=a[2]}const X=Object(u["e"])();function Y(e,t,i,r,a,n,s,o,c,l,h){let d=a,u=a+1,p=a+s,f=a+s+1,m=o,b=o+1,g=o+2*n,v=o+2*n+1;h<0&&(d=a+s+1,f=a),l*=3;for(let y=0;y<n;++y)y===n-1&&(h>0?(u=a,f=a+s):(u=a,d=a+s)),re(e,d,u,p,X),Q(e,t,r,i,X,m,d),Q(e,t,r,i,X,b,u),Q(e,t,r,i,X,g,p),Q(e,t,r,i,X,v,f),c[l++]=m,c[l++]=g,c[l++]=v,c[l++]=m,c[l++]=v,c[l++]=b,d++,u++,p++,f++,m+=2,b+=2,g+=2,v+=2}const K=Object(u["e"])(),J=Object(u["e"])(),ee=Object(u["e"])(),te=Object(u["e"])(),ie=Object(u["e"])();function re(e,t,i,r,a){t*=3,i*=3,r*=3,Object(p["x"])(K,e[t++],e[t++],e[t++]),Object(p["x"])(J,e[i++],e[i++],e[i++]),Object(p["x"])(ee,e[r++],e[r++],e[r++]),Object(p["k"])(te,J,K),Object(p["k"])(ie,ee,K),Object(p["h"])(a,ie,te),Object(p["s"])(a,a)}const ae=Object(u["e"])();function ne(e,t,i,r){const a=e.stageObject,n=a.geometryRecords,s=n.length,o="absolute-height"!==t.mode;let c=0;const l=a.transformation,h=Object(f["a"])(Object(g["b"])(),l);for(let d=0;d<s;d+=2){const e=n[d].geometry,s=e.getMutableAttribute("position").data,u=e.vertexAttributes.get("size").data,f=e.vertexAttributes.get("mapPos").data,m=new j["a"](f),b=s.length/3;let g=0,v=!1,y=0;const O=i.spatialReference;for(let a=0;a<b;a++){ae[0]=s[g],ae[1]=s[g+1],ae[2]=s[g+2];const e=Object(P["e"])(m,i,t,r,o?de:null);o&&(y+=de.sampledElevation),C["a"].DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES?(Object(p["x"])(se,m.array[m.offset+0],m.array[m.offset+1],e+u[g/3]),r.toRenderCoords(se,O,se),Object(p["n"])(se,se,h)):(Object(p["x"])(se,s[g+0],s[g+1],s[g+2]),Object(p["n"])(se,se,l),r.setAltitude(e+u[g/3],se),Object(p["n"])(se,se,h)),s[g]=se[0],s[g+1]=se[1],s[g+2]=se[2];const a=he/r.unitInMeters;(Math.abs(ae[0]-s[g])>=a||Math.abs(ae[1]-s[g+1])>=a||Math.abs(ae[2]-s[g+2])>=a)&&(v=!0),m.offset+=3,g+=3}v&&(e.invalidateBoundingInfo(),a.geometryVertexAttrsUpdated(d),n[d+1].geometry.invalidateBoundingInfo(),a.geometryVertexAttrsUpdated(d+1)),c+=y/b}return c/s}const se=Object(u["e"])(),oe=Object(u["e"])(),ce=[0,2,1],le=[0,1,2],he=.01,de={verticalDistanceToGround:0,sampledElevation:0};var ue=i("c120"),pe=i("e041"),fe=i("82fa"),me=i("9ef0"),be=i("4cac"),ge=i("a915"),ve=i("3dc2"),ye=(i("1fd7"),i("ac8e")),Oe=i("02f1"),_e=i("0fc4"),xe=i("7577"),je=i("caf7"),we=i("2df1"),Se=i("74df"),Ce=i("5241"),Te=i("89cb"),Pe=i("ed70"),Ae=i("9180");class Re{constructor(e,t,i){this.graphics3DSymbolLayer=e,this.renderGeometries=t,this.boundingBox=i,this.type="draped",this.stage=null,this._visible=!1,this._addedToStage=!1,this._layerView=null,this.isElevationSource=!1}initialize(e,t,i){this.stage=e,this._layerView=i,this._overlayRenderer=this._layerView.view.basemapTerrain.overlayManager.renderer}setVisibility(e){if(null!=this.stage&&this._visible!==e){if(this._visible=e,e&&!this._addedToStage)return this._addedToStage=!0,void this._overlayRenderer.addGeometries(this.renderGeometries,this._layerView,1);if(e||this._addedToStage){for(const e of this.renderGeometries)e.instanceParameters.visible=this._visible;this._overlayRenderer.updateGeometries(this.renderGeometries,this._layerView,1)}}}destroy(){this.stage&&this._addedToStage&&this._overlayRenderer.removeGeometries(this.renderGeometries,this._layerView,4),this._addedToStage=!1,this._visible=!1,this.stage=null}getBSRadius(){return this.renderGeometries.reduce((e,t)=>Math.max(e,t.boundingSphere[3]),0)}getCenterObjectSpace(e=Object(u["e"])()){return Object(p["x"])(e,0,0,0)}getBoundingBoxObjectSpace(e=Object(x["h"])()){return Object(x["k"])(e)}addObjectState(e,t){0===e&&(this.renderGeometries.forEach(e=>{const i=e.addHighlight();t.addRenderGeometry(e,i,this)}),this._addedToStage&&this._overlayRenderer.updateHighlights(this.renderGeometries,this._layerView))}removeObjectState(e){this.renderGeometries.forEach(t=>{e.removeRenderGeometry(t)})}removeRenderGeometryObjectState(e,t){e.removeHighlight(t),this._addedToStage&&this._overlayRenderer.updateHighlights(this.renderGeometries,this._layerView)}computeAttachmentOrigin(e){for(const t of this.renderGeometries)t.computeAttachmentOrigin(De)&&(e.draped.origin[0]+=De[0],e.draped.origin[1]+=De[1],e.draped.num++)}async getProjectedBoundingBox(e,t,i,a,n){Object(x["k"])(n);for(let r=0;r<this.renderGeometries.length;r++){const t=this.renderGeometries[r];this._getRenderGeometryProjectedBoundingRect(t,e,Me,i),Object(x["q"])(n,Me)}if(t){let e;Object(x["e"])(n,De);const i=Object(T["d"])(n,t);try{e=await t.service.queryElevation(De[0],De[1],a,i,"ground")}catch(s){}Object(r["k"])(e)&&(n[2]=Math.min(n[2],e),n[5]=Math.max(n[5],e))}return n}_getRenderGeometryProjectedBoundingRect(e,t,i,r){if(this.boundingBox)Object(x["C"])(Ee,this.boundingBox);else{const t=e.boundingSphere,i=t[3];Ee[0]=t[0]-i,Ee[1]=t[1]-i,Ee[2]=t[2]-i,Ee[3]=t[0]+i,Ee[4]=t[1]+i,Ee[5]=t[2]+i}return t(Ee,0,2),this.calculateRelativeScreenBounds&&r.push({location:Object(x["e"])(Ee),screenSpaceBoundingRect:this.calculateRelativeScreenBounds()}),Object(x["G"])(Ee,i)}}const Me=Object(Ae["l"])(),Ee=Object(x["h"])(),De=Object(u["e"])();var Ie,Le=Re,Ve=i("a6c9"),ke=i("38a4"),Fe=i("9b40");function ze(e){return null!=e}function Ue(e){return"number"==typeof e}function Ge(e){return"string"==typeof e}function Be(e){return null==e||Ge(e)}function He(e,t){e&&e.push(t)}function Ne(e,t,i,r=Object(g["b"])()){const a=e||0,n=t||0,s=i||0;return 0!==a&&Object(f["g"])(r,r,-a/180*Math.PI),0!==n&&Object(f["e"])(r,r,n/180*Math.PI),0!==s&&Object(f["f"])(r,r,s/180*Math.PI),r}function qe(e,t,i,r,a){const n=e.minSize,s=e.maxSize;if(e.expression)return He(a,"Could not convert size info: expression not supported"),!1;if(e.useSymbolValue){const e=r.symbolSize[i];return t.minSize[i]=e,t.maxSize[i]=e,t.offset[i]=t.minSize[i],t.factor[i]=0,t.type[i]=1,!0}if(ze(e.field))return ze(e.stops)?2===e.stops.length&&Ue(e.stops[0].size)&&Ue(e.stops[1].size)?(We(e.stops[0].size,e.stops[1].size,e.stops[0].value,e.stops[1].value,t,i),t.type[i]=1,!0):(He(a,"Could not convert size info: stops only supported with 2 elements"),!1):Ue(n)&&Ue(s)&&ze(e.minDataValue)&&ze(e.maxDataValue)?(We(n,s,e.minDataValue,e.maxDataValue,t,i),t.type[i]=1,!0):null!=Fe["a"][e.valueUnit]?(t.minSize[i]=-1/0,t.maxSize[i]=1/0,t.offset[i]=0,t.factor[i]=1/Fe["a"][e.valueUnit],t.type[i]=1,!0):"unknown"===e.valueUnit?(He(a,"Could not convert size info: proportional size not supported"),!1):(He(a,"Could not convert size info: scale-dependent size not supported"),!1);if(!ze(e.field)){if(e.stops&&e.stops[0]&&Ue(e.stops[0].size))return t.minSize[i]=e.stops[0].size,t.maxSize[i]=e.stops[0].size,t.offset[i]=t.minSize[i],t.factor[i]=0,t.type[i]=1,!0;if(Ue(n))return t.minSize[i]=n,t.maxSize[i]=n,t.offset[i]=n,t.factor[i]=0,t.type[i]=1,!0}return He(a,"Could not convert size info: unsupported variant of sizeInfo"),!1}function We(e,t,i,r,a,n){const s=Math.abs(r-i)>0?(t-e)/(r-i):0;a.minSize[n]=s>0?e:t,a.maxSize[n]=s>0?t:e,a.offset[n]=e-i*s,a.factor[n]=s}function Ze(e,t,i,r){if(e.normalizationField||e.valueRepresentation)return He(r,"Could not convert size info: unsupported property"),null;if(!Be(e.field))return He(r,"Could not convert size info: field is not a string"),null;if(t.size){if(e.field)if(t.size.field){if(e.field!==t.size.field)return He(r,"Could not convert size info: multiple fields in use"),null}else t.size.field=e.field}else t.size={field:e.field,minSize:[0,0,0],maxSize:[0,0,0],offset:[0,0,0],factor:[0,0,0],type:[0,0,0]};let a;switch(e.axis){case"width":return a=qe(e,t.size,0,i,r),a?t:null;case"height":return a=qe(e,t.size,2,i,r),a?t:null;case"depth":return a=qe(e,t.size,1,i,r),a?t:null;case"width-and-depth":return a=qe(e,t.size,0,i,r),a&&qe(e,t.size,1,i,r),a?t:null;case null:case void 0:case"all":return a=qe(e,t.size,0,i,r),a=a&&qe(e,t.size,1,i,r),a=a&&qe(e,t.size,2,i,r),a?t:null;default:return He(r,`Could not convert size info: unknown axis "${e.axis}""`),null}}function $e(e,t,i){for(let a=0;a<3;++a){let i=t.unitInMeters;1===e.type[a]&&(i*=t.modelSize[a],e.type[a]=2),e.minSize[a]=e.minSize[a]/i,e.maxSize[a]=e.maxSize[a]/i,e.offset[a]=e.offset[a]/i,e.factor[a]=e.factor[a]/i}let r;if(0!==e.type[0])r=0;else if(0!==e.type[1])r=1;else{if(0===e.type[2])return He(i,"No size axis contains a valid size or scale"),!1;r=2}for(let a=0;a<3;++a)0===e.type[a]&&(e.minSize[a]=e.minSize[r],e.maxSize[a]=e.maxSize[r],e.offset[a]=e.offset[r],e.factor[a]=e.factor[r],e.type[a]=e.type[r]);return!0}function Qe(e,t,i){e[4*t+0]=i.r/255,e[4*t+1]=i.g/255,e[4*t+2]=i.b/255,e[4*t+3]=i.a}function Xe(e,t,i){if(e.normalizationField)return He(i,"Could not convert color info: unsupported property"),null;if(Ge(e.field)){if(!e.stops)return He(i,"Could not convert color info: missing stops or colors"),null;{if(e.stops.length>8)return He(i,"Could not convert color info: too many color stops"),null;t.color={field:e.field,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};const r=e.stops;for(let e=0;e<8;++e){const i=r[Math.min(e,r.length-1)];t.color.values[e]=i.value,Qe(t.color.colors,e,i.color)}}}else{if(!(e.stops&&e.stops.length>=0))return He(i,"Could not convert color info: no field and no colors/stops"),null;{const i=e.stops&&e.stops.length>=0&&e.stops[0].color;t.color={field:null,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};for(let e=0;e<8;e++)t.color.values[e]=1/0,Qe(t.color.colors,e,i)}}return t}function Ye(e,t,i){if(e.normalizationField)return He(i,"Could not convert opacity info: unsupported property"),null;if(Ge(e.field)){if(!e.stops)return He(i,"Could not convert opacity info: missing stops or opacities"),null;{if(e.stops.length>8)return He(i,"Could not convert opacity info: too many opacity stops"),null;t.opacity={field:e.field,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};const r=e.stops;for(let e=0;e<8;++e){const i=r[Math.min(e,r.length-1)];t.opacity.values[e]=i.value,t.opacity.opacityValues[e]=i.opacity}}}else{if(!(e.stops&&e.stops.length>=0))return He(i,"Could not convert opacity info: no field and no opacities/stops"),null;{const i=e.stops&&e.stops.length>=0&&e.stops[0].opacity;t.opacity={field:null,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};for(let e=0;e<8;e++)t.opacity.values[e]=1/0,t.opacity.opacityValues[e]=i}}return t}function Ke(e,t,i){const r=2===i&&"arithmetic"===e.rotationType;t.offset[i]=r?90:0,t.factor[i]=r?-1:1,t.type[i]=1}function Je(e,t,i){if(!Ge(e.field))return He(i,"Could not convert rotation info: field is not a string"),null;if(t.rotation){if(e.field)if(t.rotation.field){if(e.field!==t.rotation.field)return He(i,"Could not convert rotation info: multiple fields in use"),null}else t.rotation.field=e.field}else t.rotation={field:e.field,offset:[0,0,0],factor:[1,1,1],type:[0,0,0]};switch(e.axis){case"tilt":return Ke(e,t.rotation,0),t;case"roll":return Ke(e,t.rotation,1),t;case null:case void 0:case"heading":return Ke(e,t.rotation,2),t;default:return He(i,`Could not convert rotation info: unknown axis "${e.axis}""`),null}}function et(e,t,i){if(!e)return null;const r=!t.supportedTypes||!!t.supportedTypes.size,a=!t.supportedTypes||!!t.supportedTypes.color,n=!t.supportedTypes||!!t.supportedTypes.rotation,s=!!t.supportedTypes&&!!t.supportedTypes.opacity,o=e.reduce((e,o)=>{if(!e)return e;if(o.valueExpression)return He(i,"Could not convert visual variables: arcade expressions not supported"),null;switch(o.type){case"size":return r?Ze(o,e,t,i):e;case"color":return a?Xe(o,e,i):e;case"opacity":return s?Ye(o,e,i):null;case"rotation":return n?Je(o,e,i):e;default:return null}},{size:null,color:null,opacity:null,rotation:null});return!(e.length>0&&o)||o.size||o.color||o.opacity||o.rotation?o&&o.size&&!$e(o.size,t,i)?null:o:null}function tt(e){return e&&null!=e.size}function it(e,t){if(!e)return{enabled:!1};if(C["a"].DISABLE_FAST_UPDATES)return{enabled:!1};const i=et(e.visualVariables,t);return i?{enabled:!0,visualVariables:i,materialParameters:nt(i,t),requiresShaderTransformation:tt(i)}:{enabled:!1}}function rt(e,t,i){if(!t||!e.enabled)return!1;const r=e.visualVariables,a=et(t.visualVariables,i);return!!a&&!!(at(r.size,a.size,"size")&&at(r.color,a.color,"color")&&at(r.rotation,a.rotation,"rotation")&&at(r.opacity,a.opacity,"opacity"))&&(e.visualVariables=a,e.materialParameters=nt(a,i),e.requiresShaderTransformation=tt(a),!0)}function at(e,t,i){if(!!e!=!!t)return!1;if(e&&e.field!==t.field)return!1;if(e&&"rotation"===i){const i=e,r=t;for(let e=0;e<3;e++)if(i.type[e]!==r.type[e]||i.offset[e]!==r.offset[e]||i.factor[e]!==r.factor[e])return!1}return!0}function nt(e,t){const i={vvSizeEnabled:!1,vvSizeMinSize:null,vvSizeMaxSize:null,vvSizeOffset:null,vvSizeFactor:null,vvSizeValue:null,vvColorEnabled:!1,vvColorValues:null,vvColorColors:null,vvOpacityEnabled:!1,vvOpacityValues:null,vvOpacityOpacities:null,vvSymbolAnchor:null,vvSymbolRotationMatrix:null},r=tt(e);return e&&e.size?(i.vvSizeEnabled=!0,i.vvSizeMinSize=e.size.minSize,i.vvSizeMaxSize=e.size.maxSize,i.vvSizeOffset=e.size.offset,i.vvSizeFactor=e.size.factor):e&&r&&(i.vvSizeValue=t.transformation.scale),e&&r&&(i.vvSymbolAnchor=t.transformation.anchor,i.vvSymbolRotationMatrix=Object(b["a"])(),Object(f["i"])(st),Ne(t.transformation.rotation[2],t.transformation.rotation[0],t.transformation.rotation[1],st),Object(y["f"])(i.vvSymbolRotationMatrix,st)),e&&e.color&&(i.vvColorEnabled=!0,i.vvColorValues=e.color.values,i.vvColorColors=e.color.colors),e&&e.opacity&&(i.vvOpacityEnabled=!0,i.vvOpacityValues=e.opacity.values,i.vvOpacityOpacities=e.opacity.opacityValues),i}!function(e){const t=Object(g["b"])(),i=Object(u["e"])();function r(e,r,a){if(!e.vvSizeEnabled)return a;Object(f["c"])(t,a);const n=e.vvSymbolRotationMatrix;Object(f["d"])(st,n[0],n[1],n[2],0,n[3],n[4],n[5],0,n[6],n[7],n[8],0,0,0,0,1),Object(f["m"])(t,t,st);for(let t=0;t<3;++t){const a=e.vvSizeOffset[t]+r[0]*e.vvSizeFactor[t];i[t]=Object(ke["d"])(a,e.vvSizeMinSize[t],e.vvSizeMaxSize[t])}return Object(f["s"])(t,t,i),Object(f["t"])(t,t,e.vvSymbolAnchor),t}function a(e,t,i){if(!t.vvSizeEnabled)return Object(p["x"])(e,1,1,1);for(let r=0;r<3;++r){const a=t.vvSizeOffset[r]+i[0]*t.vvSizeFactor[r];e[r]=Object(ke["d"])(a,t.vvSizeMinSize[r],t.vvSizeMaxSize[r])}return e}e.evaluateModelTransform=r,e.evaluateModelTransformScale=a}(Ie||(Ie={}));const st=Object(g["b"])(),ot=Ie.evaluateModelTransform,ct=Ie.evaluateModelTransformScale;var lt=i("6061"),ht=i("1e2c");const dt=Object(g["b"])(),ut=Object(u["g"])(0,0,1),pt=16,ft=1.5,mt=128,bt=.5,gt=[bt/2,bt/2,1-bt/2,1-bt/2],vt=[mt*bt,mt*bt];class yt extends M["a"]{constructor(e,t,i,r){super(e,t,i,r),this._cimLayers=null,this._cimSymbolMaterials=new Map,this._cimSymbolTextures=new Map,this._cimMaterialParametersInfo=null,this._cimRequiredFields=null,this._cimScaleFactorOrFunction=null,this._size=null,this._symbolTextureRatio=1,this._outlineSize=0,this._texture=null,this._releaseTexture=null,this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0}}getCachedSize(){return{size:this._getIconSize()}}async doLoad(e){this._validateOrThrow();const t=this._prepareMaterialParameters(),i=this._getPrimitive();if(Object(r["k"])(i))this._prepareResourcesPrimitive(t,i);else{const i=Object(ye["f"])(this.symbol,this.symbolLayer),r=Object(pe["i"])(i);r&&"application/json"===r.mediaType?await this._prepareResourcesCIM(t,JSON.parse(r.data),e):await this._prepareResourcesHref(t,i,e)}}_validateOrThrow(){if(this._drivenProperties.size)return;const e=Object(T["k"])(this._getIconSize());if(e)throw new d["a"]("graphics3diconsymbollayer:invalid-size",e)}_getIconSize(){const e=this.symbolLayer,t=Math.round(null!=e.size?Object(ge["h"])(e.size):pt);return this._drivenProperties.size?Math.max(t,64):t}_generateTextureCIM(e){const t=this._getGraphicHash(e);let i=""===t?null:this._cimSymbolTextures.get(t);if(!i){const r={scaleFactor:this._cimScaleFactorOrFunction},a=this._context.sharedResources.cimSymbolRasterizer.rasterizeCIMSymbol(this._cimLayers,e,"esriGeometryPoint",r,null,null);this._cimMaterialParametersInfo.anchorPos=this._getAnchorPos("relative",a.anchorPosition);const n={width:a.imageData.width,height:a.imageData.height,powerOfTwoResizeMode:2};i=new ht["a"](a.imageData,n),this._cimSymbolTextures.set(t,i),this._context.stage.add(i)}return i}_computeSize(e,t){const i=e.width/e.height;return i>1?[t,Math.round(t/i)]:[Math.round(t*i),t]}_prepareMaterialParameters(){const e={anchorPos:this._getAnchorPos(this.symbolLayer.anchor,this.symbolLayer.anchorPosition)},t=this.symbol;if(Ot(t)){const{screenLength:i,minWorldLength:r,maxWorldLength:a}=t.verticalOffset;e.verticalOffset={screenLength:Object(ge["h"])(i),minWorldLength:r||0,maxWorldLength:null!=a?a:1/0}}return this._context.screenSizePerspectiveEnabled&&(e.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),e.occlusionTest=!0,e.slicePlaneEnabled=this._context.slicePlaneEnabled,e}_prepareResourcesPrimitive(e,t){const i=this._getOutlineSize();if(_t(t)&&0===i)throw new Error("Nothing to render");this._outlineSize=i,e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize;const r=this._context.sharedResources.textures.fromData(t,()=>xt(t));this._texture=r.texture,this._releaseTexture=()=>this._context.sharedResources.textures.release(r.uid),e.textureIsSignedDistanceField=!0,e.distanceFieldBoundingBox=gt,e.textureId=this._texture.id;const a=this._getIconSize();this._size=[a,a],this._symbolTextureRatio=1/bt,this._createMaterialAndAddToStage(e,this._context.stage)}async _prepareResourcesHref(e,t,i){if(!Object(ue["a"])("esri-canvas-svg-support")&&Object(pe["w"])(t))throw new d["a"]("graphics3diconsymbollayer:unsupported-image-format","IconSymbol3DLayer failed to load (SVG symbols are not supported in IE11)");this._outlineSize=this._getOutlineSize(),e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize,e.textureIsSignedDistanceField=!1;const r=this._getIconSize(),s=r*this._context.layerView.view.pixelRatio,o=await Object(n["d"])(this._context.sharedResources.textures.fromUrl(t,s,{signal:i}));if(!1===o.ok)throw Object(a["v"])(o.error),new d["a"]("graphics3diconsymbollayer:request-failed",`Failed to load (Request for icon resource failed: ${t})`);const{uid:c,texture:l}=o.value;this._releaseTexture=()=>this._context.sharedResources.textures.release(c);const h=l.params;this._size=this._computeSize(h,r),e.textureId=l.id,this._createMaterialAndAddToStage(e,this._context.stage)}async _prepareResourcesCIM(e,t,r){const n=new be["a"]({data:t});if(!this._context.sharedResources.cimSymbolRasterizer){const e=(await Promise.all([i.e("chunk-53ff5184"),i.e("chunk-294f1278")]).then(i.bind(null,"6b49"))).CIMSymbolRasterizer;Object(a["w"])(r),this._context.sharedResources.cimSymbolRasterizer||(this._context.sharedResources.cimSymbolRasterizer=new e(this._context.renderCoordsHelper.spatialReference,!0))}const s=this._context.layer.fields?this._context.layer.fields.map(e=>e.toJSON()):null;let o,c;if(this._cimLayers=await this._context.sharedResources.cimSymbolRasterizer.analyzeCIMSymbol(n,s,this._context.renderer&&"dictionary"===this._context.renderer.type?this._context.renderer.fieldMap:null,"esriGeometryPoint",{signal:r}),this._context.renderer&&"dictionary"===this._context.renderer.type&&this._context.renderer.scaleExpression){const e=this._context.renderer;if(isNaN(e.scaleExpression)){const t=e.scaleExpression,i=await Object(fe["d"])(t,this._context.layer.spatialReference,s);c=(e,t,r)=>{const a=Object(Te["a"])(i,e,{$view:r},"esriGeometryPoint",t);return null!==a?a:1}}else o=Number(e.scaleExpression)}this._cimScaleFactorOrFunction=o||c||1;const l=this._context.renderer?await this._context.renderer.getRequiredFields(this._context.layer.fields):[];Object(a["w"])(r);const h=this._context.layer.fieldsIndex;this._cimRequiredFields=l.map(e=>h.get(e).name),this._cimMaterialParametersInfo=e,this._cimMaterialParametersInfo.color=this._getFillColor(),this._cimMaterialParametersInfo.outlineColor=[0,0,0,0],this._cimMaterialParametersInfo.outlineSize=0,this._cimMaterialParametersInfo.textureIsSignedDistanceField=!1}_getPrimitive(){return this.symbolLayer.resource&&this.symbolLayer.resource.href?null:this.symbolLayer.resource&&this.symbolLayer.resource.primitive||ve["b"]}_getOutlineSize(){let e=0;const t=this.symbolLayer;return Object(r["k"])(t.outline)&&null!=t.outline.size?Math.max(Object(ge["h"])(t.outline.size),0):(e=_t(this._getPrimitive())?ft:0,Math.max(e,0))}_getOutlineColor(){const e=this._getLayerOpacity(),t=this.symbolLayer,i=Object(r["i"])(t,"outline","color");if(Object(r["k"])(i)){const t=me["a"].toUnitRGB(i),r=i.a*e;return[t[0],t[1],t[2],r]}return[0,0,0,0]}_getFillColor(){if(_t(this._getPrimitive()))return Pe["b"];const e=Object(r["j"])(this._getPrimitive()),t=Object(r["i"])(this.symbolLayer,"material","color");return this._getCombinedOpacityAndColor(t,{hasIntrinsicColor:e})}_getAnchorPos(e,t){return"relative"===e?Object(Oe["f"])((t.x||0)+.5,.5-(t.y||0)):e in T["h"]?T["h"][e]:T["h"].center}_createMaterialAndAddToStage(e,t){if(this._cimLayers?this._fastUpdates={enabled:!1}:this._fastUpdates=it(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates.enabled&&Object.assign(e,this._fastUpdates.materialParameters),this._cimLayers){let i=this._cimSymbolMaterials.get(e.textureId);return i||(i=new we["a"](e),this._cimSymbolMaterials.set(e.textureId,i),t.add(i)),i}return this._material=new we["a"](e),t.add(this._material),this._material}_setDrapingDependentMaterialParameters(){this.draped&&(this._forEachMaterial(e=>{e.setParameterValues({verticalOffset:null,screenSizePerspective:null,occlusionTest:!1,slicePlaneEnabled:!1,shaderPolygonOffset:0,isDraped:this.draped})}),this.layerOpacityChanged())}destroy(){super.destroy(),this._forEachMaterial(e=>this._context.stage.remove(e)),this._material=null,this._cimSymbolMaterials.clear(),this._cimSymbolTextures.forEach(e=>this._context.stage.remove(e)),this._cimSymbolTextures.clear(),this._releaseTexture&&(this._releaseTexture(),this._releaseTexture=null)}_getScaleFactor(e,t){if(this._drivenProperties.size&&e.size){for(let t=0;t<3;t++){const i=e.size[t];i&&"symbol-value"!==i&&"proportional"!==i&&(e.size[t]=Object(ge["h"])(i))}if("symbol-value"===e.size[0])return 1;if(isFinite(+e.size[0]))return+e.size[0]/t;if(isFinite(+e.size[2]))return+e.size[2]/t}return 1}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry))return null;let i,a;if(this._cimLayers){if(!this._cimLayers.length)return null;const e=this._generateTextureCIM(t),r={textureId:e.id,...this._cimMaterialParametersInfo};a=this._createMaterialAndAddToStage(r,this._context.stage),i=[e.params.width,e.params.height]}else i=this._size,a=Object(r["t"])(this._material);const n=Object(Ce["d"])(t.geometry);if(Object(r["j"])(n))return this.logger.warn("unsupported geometry type for icon symbol: "+t.geometry.type),null;const s=e.renderingInfo,o=this._getVertexOpacityAndColor(s);let c=1;if(!this._fastUpdates.enabled||!this._fastUpdates.visualVariables.size){const e=i[0]>i[1]?i[0]:i[1];c=this._getScaleFactor(s,e)}c*=this._symbolTextureRatio;const l=[i[0]*c,i[1]*c],h=this.setGraphicElevationContext(t,new A["a"]);return this.ensureDrapedStatus("on-the-ground"===h.mode)&&this._setDrapingDependentMaterialParameters(),this.draped?this._createAsOverlay(t,n,a,o,l,e.layer.uid):this._createAs3DShape(t,n,a,o,l,h,t.uid)}layerOpacityChanged(){const e=this._getFillColor(),t=this._getOutlineColor();return this._forEachMaterial(i=>{i.setParameterValues({color:e}),i.setParameterValues({outlineColor:t})}),!0}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,a=Object(P["d"])(yt.elevationModeChangeTypes,i,r);if(a!==P["a"].UPDATE)return a;const n=Object(P["f"])(r)||"absolute-height"===r;return this.updateGraphics3DGraphicElevationInfo(e,t,()=>n)}slicePlaneEnabledChanged(){return this.draped||this._forEachMaterial(e=>{e.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled})}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!!this._getPrimitive()}applyRendererDiff(e,t){for(const i in e.diff)switch(i){case"visualVariables":if(!rt(this._fastUpdates,t,this._fastVisualVariableConvertOptions()))return!1;Object(r["k"])(this._material)&&this._material.setParameterValues(this._fastUpdates.materialParameters);break;default:return!1}return!0}_defaultElevationInfoNoZ(){return jt}_createAs3DShape(e,t,i,r,a,n,o){const c=this.getFastUpdateAttrValues(e),l=c?e=>ot(this._fastUpdates.materialParameters,c,e):null,h=[je["a"].createPointGeometry(ut,null,r,a,wt,null,c)],d=Object(Ce["a"])(this._context,t,h,[i],null,null,n,this._context.layer.uid,o,l);if(null===d)return null;const u=Se["b"],p=new s["a"](this,d.object,h,null,null,u,n);return p.alignedSampledElevation=d.sampledElevation,p.needsElevationUpdates=Object(P["f"])(n.mode)||"absolute-height"===n.mode,p.getScreenSize=this._createScreenSizeGetter(a,l),p.calculateRelativeScreenBounds=e=>i.calculateRelativeScreenBounds(p.getScreenSize(),1,e),Object(Ce["b"])(p,t,this._context.elevationProvider),p}_createAsOverlay(e,t,i,a,n,s){i.renderPriority=this._renderPriority;const o=Object(_e["c"])();Object(m["t"])(t,o,this._context.overlaySR),o[2]=V["a"];const c=this._context.clippingExtent;if(Object(r["k"])(c)&&!Object(x["g"])(c,o))return null;const l=this.getFastUpdateAttrValues(e),h=l?e=>ot(this._fastUpdates.materialParameters,l,e):null,d=je["a"].createPointGeometry(ut,o,a,n,null,null,l),u=new lt["a"](d,i,s,e.uid);o[3]=0,Object(xe["c"])(u.boundingSphere,o),u.calculateShaderTransformation=h;const p=new Le(this,[u],null);return p.getScreenSize=this._createScreenSizeGetter(n,h),p.calculateRelativeScreenBounds=e=>i.calculateRelativeScreenBounds(p.getScreenSize(),1,e),p}_createScreenSizeGetter(e,t){const i=this._outlineSize+2;if(this._fastUpdates.enabled){const r=e[0]/this._symbolTextureRatio,a=e[1]/this._symbolTextureRatio;return(e=Object(Oe["b"])())=>{const n=t(dt);return e[0]=n[0]*r+i,e[1]=n[5]*a+i,e}}{const t=e[0]/this._symbolTextureRatio+i,r=e[1]/this._symbolTextureRatio+i;return(e=Object(Oe["b"])())=>(e[0]=t,e[1]=r,e)}}_fastVisualVariableConvertOptions(){const e=this._size[0]>this._size[1]?this._size[0]:this._size[1],t=Object(u["g"])(e,e,e),i=Object(ge["i"])(1),r=e*i;return{modelSize:t,symbolSize:Object(u["g"])(r,r,r),unitInMeters:i,transformation:{anchor:u["b"],scale:u["a"],rotation:u["b"]}}}_getGraphicHash(e){let t="";for(const i of this._cimRequiredFields)t+=i+e.attributes[i];return t}_forEachMaterial(e){Object(r["k"])(this._material)&&e(this._material),this._cimSymbolMaterials.forEach(e)}}function Ot(e){return e&&"point-3d"===e.type&&e.hasVisibleVerticalOffset()}function _t(e){return!!Object(r["k"])(e)&&("cross"===e||"x"===e)}function xt(e){let t;const i=mt,r=i*bt;switch(e){case"circle":t=Object(Ve["a"])(i,r);break;case"square":t=Object(Ve["d"])(i,r);break;case"kite":t=Object(Ve["c"])(i,r);break;case"cross":t=Object(Ve["b"])(i,r);break;case"x":t=Object(Ve["g"])(i,r);break;case"triangle":t=Object(Ve["e"])(i,r)}return new ht["a"](t,{mipmap:!1,wrap:{s:33071,t:33071},width:mt,height:mt,components:4,noUnpackFlip:!0})}yt.PRIMITIVE_SIZE=vt,yt.elevationModeChangeTypes={definedChanged:P["a"].UPDATE,staysOnTheGround:P["a"].NONE,onTheGroundChanged:P["a"].RECREATE};const jt={mode:"relative-to-ground",offset:0},wt=Object(_e["d"])(0,0,0,1);var St=i("86ba"),Ct=i("3544"),Tt=i("d408");const Pt=["polyline","polygon","extent"];class At extends M["a"]{constructor(e,t,i,r){super(e,t,i,r),this._uniformSize=1}async doLoad(){if(this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[1,1,1],unitInMeters:1,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=it(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1},!this._drivenProperties.size){const e=null!=this.symbolLayer.size?this.symbolLayer.size:Object(ge["i"])(1);if(e<0)throw new d["a"]("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values");this._uniformSize=e}}getMaterialParameters(e){const t=Object(r["i"])(this.symbolLayer,"material","color"),i=this._getCombinedOpacityAndColor(t),a=i[3],n={width:1,color:i,polygonOffset:!0,join:this.symbolLayer.join||"miter",cap:this.symbolLayer.cap||"butt",transparent:a<1||this.needsDrivenTransparentPass,slicePlaneEnabled:this._context.slicePlaneEnabled,isClosed:e,stipplePattern:this.symbolLayer.stipplePattern?Object(Ct["b"])(this.symbolLayer.stipplePattern.map(ge["h"])):null,stippleOffColor:this.symbolLayer.stippleOffColor?me["a"].toUnitRGBA(this.symbolLayer.stippleOffColor):null,stippleIntegerRepeats:!0};if(this._drivenProperties.size)this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size&&(n.width=Object(ge["h"])(1));else{const e=null!=this.symbolLayer.size?this.symbolLayer.size:Object(ge["i"])(1);n.width=Object(ge["h"])(e)}return this._fastUpdates&&this._fastUpdates.visualVariables?{...n,...this._fastUpdates.materialParameters}:n}get lineMaterial(){return Object(r["j"])(this._lineMaterial)&&(this._lineMaterial=new St["a"](this.getMaterialParameters(!1)),this._context.stage.add(this._lineMaterial)),this._lineMaterial}get ringMaterial(){return Object(r["j"])(this._ringMaterial)&&(this._ringMaterial=new St["a"](this.getMaterialParameters(!0)),this._context.stage.add(this._ringMaterial)),this._ringMaterial}destroy(){super.destroy(),this._context.stage.remove(this._lineMaterial),this._lineMaterial=null,this._context.stage.remove(this._ringMaterial),this._ringMaterial=null}getDrivenSize(e){return this._drivenProperties.size&&e.size?Object(ge["h"])(Object(E["b"])(e.size)):1}getSizeFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?Object(M["b"])(this._fastUpdates.visualVariables.size.field,e):null}getDrivenColor(e){const t=Object(_e["d"])(1,1,1,1);return this._drivenProperties.color&&e.color&&(t[0]=e.color[0],t[1]=e.color[1],t[2]=e.color[2],e.color.length>0&&(t[3]=e.color[3])),this._drivenProperties.opacity&&e.opacity&&(t[3]=e.opacity),t}getColorFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color?Object(M["b"])(this._fastUpdates.visualVariables.color.field,e):null}getOpacityFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.opacity?Object(M["b"])(this._fastUpdates.visualVariables.opacity.field,e):null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,Pt,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(t,new A["a"]);return this.ensureDrapedStatus("on-the-ground"===i.mode),this.draped?this._createAsOverlay(e,this._context.layer.uid):this._createAs3DShape(e,i,t.uid)}applyRendererDiff(e,t){for(const i in e.diff)switch(i){case"visualVariables":if(!rt(this._fastUpdates,t,this._vvConvertOptions))return!1;Object(r["k"])(this._lineMaterial)&&this._lineMaterial.setParameterValues(this._fastUpdates.materialParameters),Object(r["k"])(this._ringMaterial)&&this._ringMaterial.setParameterValues(this._fastUpdates.materialParameters);break;default:return!1}return!0}layerOpacityChanged(){return Object(r["k"])(this._lineMaterial)&&this.updateMaterialLayerOpacity(this._lineMaterial),Object(r["k"])(this._ringMaterial)&&this.updateMaterialLayerOpacity(this._ringMaterial),!0}updateMaterialLayerOpacity(e){const t=e.params.color,i=Object(r["i"])(this.symbolLayer,"material","color"),a=this._getCombinedOpacity(i),n=a<1||this.needsDrivenTransparentPass,s=[t[0],t[1],t[2],a];e.setParameterValues({color:s,transparent:n})}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,a=Object(P["d"])(At.elevationModeChangeTypes,i,r);if(a!==P["a"].UPDATE)return a;const n=Object(P["f"])(r);return this.updateGraphics3DGraphicElevationInfo(e,t,()=>n)}slicePlaneEnabledChanged(){return Object(r["k"])(this._lineMaterial)&&this._lineMaterial.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),Object(r["k"])(this._ringMaterial)&&this._ringMaterial.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}_getGeometryAsPolygonOrPolyline(e){switch(e.type){case"extent":if(e instanceof D["a"])return I["a"].fromExtent(e);break;case"polygon":case"polyline":return e}return null}_createAs3DShape(e,t,i){const a=e.graphic,n=this._getGeometryAsPolygonOrPolyline(a.geometry),o="polygon"===n.type?n.rings:n.paths,c=new Array,l=new Array,h=new Array,d=Object(x["h"])(),u=Object(Tt["b"])(n,this._context.elevationProvider,this._context.renderCoordsHelper,t),p="polygon"===n.type?"rings":"paths";this._logGeometryCreationWarnings(u,o,p,"LineSymbol3DLayer");for(let s=0;s<u.lines.length;s++){const{position:t,mapPosition:i}=u.lines[s];if(Object(r["k"])(this._context.clippingExtent)&&(Object(x["k"])(d),Object(x["n"])(d,i),!Object(x["x"])(d,this._context.clippingExtent)))continue;const a=this._createGeometry(e,t,i,n.type);c.push(a),l.push("polygon"===n.type?this.ringMaterial:this.lineMaterial),h.push(g["a"])}if(0===c.length)return null;const f=new S["a"]({geometries:c,materials:l,transformations:h,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:i}}),m=new s["a"](this,f,c,null,null,Se["c"],t);return m.alignedSampledElevation=u.sampledElevation,m.needsElevationUpdates=Object(P["f"])(t.mode),m}_createGeometry(e,t,i,r){const a="polygon"===r?1:0,n=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color,s=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size;return Object(Tt["a"])({removeDuplicateStartEnd:a,uniformSize:this._uniformSize,attributeData:{position:t,mapPosition:i,size:s?null:this.getDrivenSize(e.renderingInfo),color:n?null:this.getDrivenColor(e.renderingInfo),sizeFeature:this.getSizeFeatureAttributeData(e.graphic),colorFeature:this.getColorFeatureAttributeData(e.graphic),opacityFeature:this.getOpacityFeatureAttributeData(e.graphic)}})}_createAsOverlay(e,t){const i=e.graphic,r=this._getGeometryAsPolygonOrPolyline(i.geometry),a="polygon"===r.type?r.rings:r.paths,n="polygon"===r.type?this.ringMaterial:this.lineMaterial;n.renderPriority=this._renderPriority;const s=[],o=Object(x["h"])(),c=Object(x["k"])(),l=Object(Tt["c"])(r,this._context.overlaySR),h="polygon"===r.type?"rings":"paths";if(this._logGeometryCreationWarnings(l,a,h,"LineSymbol3DLayer"),a.length>0){const{lines:a}=l;for(let l=0;l<a.length;++l){const h=a[l];if(Object(x["k"])(o),Object(x["n"])(o,h.position),!Object(x["x"])(o,this._context.clippingExtent))continue;Object(x["m"])(c,o);const d=this._createGeometry(e,h.position,null,r.type),u=new lt["a"](d,n,t,i.uid);Object(xe["l"])(u.boundingSphere,.5*(o[0]+o[3]),.5*(o[1]+o[4]),0,.5*Math.sqrt((o[3]-o[0])*(o[3]-o[0])+(o[4]-o[1])*(o[4]-o[1]))),s.push(u)}return new Le(this,s,c)}return null}}At.elevationModeChangeTypes={definedChanged:P["a"].RECREATE,staysOnTheGround:P["a"].NONE,onTheGroundChanged:P["a"].RECREATE};var Rt,Mt=i("a4ee"),Et=i("cea0"),Dt=i("59b2"),It=i("d386"),Lt=(i("8eed"),i("f402"),i("afcf")),Vt=i("09db"),kt=i("fcf2"),Ft=i("6a0e"),zt=i("4dc1");const Ut=new WeakMap;let Gt=0,Bt=Rt=class extends Ft["a"]{constructor(e){super(e),this.wrap="repeat"}get url(){return this._get("url")||null}set url(e){this._set("url",e),e&&this._set("data",null)}get data(){return this._get("data")||null}set data(e){this._set("data",e),e&&this._set("url",null)}writeData(e,t,i,r){if(e instanceof HTMLImageElement){const a={type:"image-element",src:Object(kt["e"])(e.src,r),crossOrigin:e.crossOrigin};t[i]=a}else if(e instanceof HTMLCanvasElement){const r=e.getContext("2d").getImageData(0,0,e.width,e.height),a={type:"canvas-element",imageData:this.encodeImageData(r)};t[i]=a}else if(e instanceof HTMLVideoElement){const a={type:"video-element",src:Object(kt["e"])(e.src,r),autoplay:e.autoplay,loop:e.loop,muted:e.muted,crossOrigin:e.crossOrigin,preload:e.preload};t[i]=a}else{const r={type:"image-data",imageData:this.encodeImageData(e)};t[i]=r}}readData(e){switch(e.type){case"image-element":{const t=new Image;return t.src=e.src,t.crossOrigin=e.crossOrigin,t}case"canvas-element":{const t=this.decodeImageData(e.imageData),i=document.createElement("canvas");return i.width=t.width,i.height=t.height,i.getContext("2d").putImageData(t,0,0),i}case"image-data":return this.decodeImageData(e.imageData);case"video-element":{const t=document.createElement("video");return t.src=e.src,t.crossOrigin=e.crossOrigin,t.autoplay=e.autoplay,t.loop=e.loop,t.muted=e.muted,t.preload=e.preload,t}default:return}}get transparent(){const e=this.data,t=this.url;if(e instanceof HTMLCanvasElement)return this.imageDataContainsTransparent(e.getContext("2d").getImageData(0,0,e.width,e.height));if(e instanceof ImageData)return this.imageDataContainsTransparent(e);if(t){const e=t.substr(t.length-4,4).toLowerCase(),i=t.substr(0,15).toLocaleLowerCase();if(".png"===e||"data:image/png;"===i)return!0}return!1}set transparent(e){null!=e?this._override("transparent",e):this._clearOverride("transparent")}get contentHash(){const e="string"==typeof this.wrap?this.wrap:"object"==typeof this.wrap?`${this.wrap.horizontal}/${this.wrap.vertical}`:"",t=(t="")=>`d:${t},t:${this.transparent},w:${e}`;return null!=this.url?t(this.url):null!=this.data?this.data instanceof HTMLImageElement||this.data instanceof HTMLVideoElement?t(this.data.src):(Ut.has(this.data)||Ut.set(this.data,++Gt),t(Ut.get(this.data))):t()}clone(){return new Rt({url:this.url,data:this.data,wrap:this.cloneWrap()})}cloneWithDeduplication(e){const t=e.get(this);if(t)return t;const i=new Rt({url:this.url,data:this.data,wrap:this.cloneWrap()});return e.set(this,i),i}cloneWrap(){return"string"==typeof this.wrap?this.wrap:{horizontal:this.wrap.horizontal,vertical:this.wrap.vertical}}encodeImageData(e){let t="";for(let i=0;i<e.data.length;i++)t+=String.fromCharCode(e.data[i]);return{data:btoa(t),width:e.width,height:e.height}}decodeImageData(e){const t=atob(e.data),i=new Uint8ClampedArray(t.length);for(let r=0;r<t.length;r++)i[r]=t.charCodeAt(r);return Object(zt["f"])(i,e.width,e.height)}imageDataContainsTransparent(e){for(let t=3;t<e.data.length;t+=4)if(255!==e.data[t])return!0;return!1}static from(e){return"string"==typeof e?new Rt({url:e}):e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof ImageData||e instanceof HTMLVideoElement?new Rt({data:e}):Object(Et["d"])(Rt,e)}};Object(Mt["a"])([Object(Dt["b"])({type:String,json:{write:kt["f"]}})],Bt.prototype,"url",null),Object(Mt["a"])([Object(Dt["b"])({json:{write:{overridePolicy(){return{enabled:!this.url}}}}}),Object(Dt["b"])()],Bt.prototype,"data",null),Object(Mt["a"])([Object(Vt["a"])("data")],Bt.prototype,"writeData",null),Object(Mt["a"])([Object(Lt["a"])("data")],Bt.prototype,"readData",null),Object(Mt["a"])([Object(Dt["b"])({type:Boolean,json:{write:{overridePolicy(){return{enabled:this._isOverridden("transparent")}}}}})],Bt.prototype,"transparent",null),Object(Mt["a"])([Object(Dt["b"])({json:{write:!0}})],Bt.prototype,"wrap",void 0),Object(Mt["a"])([Object(Dt["b"])({readOnly:!0})],Bt.prototype,"contentHash",null),Bt=Rt=Object(Mt["a"])([Object(It["a"])("esri.geometry.support.MeshTexture")],Bt);var Ht,Nt=Bt,qt=Nt,Wt=i("7ffa");let Zt=Ht=class extends Ft["a"]{constructor(e){super(e),this.color=null,this.colorTexture=null,this.normalTexture=null,this.alphaMode="auto",this.alphaCutoff=.5,this.doubleSided=!0}clone(){return this.cloneWithDeduplication(null,new Map)}cloneWithDeduplication(e,t){const i=Object(r["k"])(e)?e.get(this):null;if(i)return i;const a=new Ht(this.clonePropertiesWithDeduplication(t));return Object(r["k"])(e)&&e.set(this,a),a}clonePropertiesWithDeduplication(e){return{color:Object(Wt["a"])(this.color),colorTexture:this.colorTexture?this.colorTexture.cloneWithDeduplication(e):null,normalTexture:this.normalTexture?this.normalTexture.cloneWithDeduplication(e):null,alphaMode:this.alphaMode,alphaCutoff:this.alphaCutoff,doubleSided:this.doubleSided}}};Object(Mt["a"])([Object(Dt["b"])({type:me["a"],json:{write:!0}})],Zt.prototype,"color",void 0),Object(Mt["a"])([Object(Dt["b"])({type:qt,json:{write:!0}})],Zt.prototype,"colorTexture",void 0),Object(Mt["a"])([Object(Dt["b"])({type:qt,json:{write:!0}})],Zt.prototype,"normalTexture",void 0),Object(Mt["a"])([Object(Dt["b"])({json:{write:!0}})],Zt.prototype,"alphaMode",void 0),Object(Mt["a"])([Object(Dt["b"])({json:{write:!0}})],Zt.prototype,"alphaCutoff",void 0),Object(Mt["a"])([Object(Dt["b"])({json:{write:!0}})],Zt.prototype,"doubleSided",void 0),Zt=Ht=Object(Mt["a"])([Object(It["a"])("esri.geometry.support.MeshMaterial")],Zt);var $t,Qt=Zt,Xt=Qt;let Yt=$t=class extends Xt{constructor(e){super(e),this.emissiveColor=null,this.emissiveTexture=null,this.occlusionTexture=null,this.metallic=1,this.roughness=1,this.metallicRoughnessTexture=null}clone(){return this.cloneWithDeduplication(null,new Map)}cloneWithDeduplication(e,t){const i=Object(r["k"])(e)?e.get(this):null;if(i)return i;const a=new $t(this.clonePropertiesWithDeduplication(t));return Object(r["k"])(e)&&e.set(this,a),a}clonePropertiesWithDeduplication(e){return{...super.clonePropertiesWithDeduplication(e),emissiveColor:this.emissiveColor?this.emissiveColor.clone():null,emissiveTexture:this.emissiveTexture?this.emissiveTexture.cloneWithDeduplication(e):null,occlusionTexture:this.occlusionTexture?this.occlusionTexture.cloneWithDeduplication(e):null,metallic:this.metallic,roughness:this.roughness,metallicRoughnessTexture:this.metallicRoughnessTexture?this.metallicRoughnessTexture.cloneWithDeduplication(e):null}}};Object(Mt["a"])([Object(Dt["b"])({type:me["a"],json:{write:!0}})],Yt.prototype,"emissiveColor",void 0),Object(Mt["a"])([Object(Dt["b"])({type:qt,json:{write:!0}})],Yt.prototype,"emissiveTexture",void 0),Object(Mt["a"])([Object(Dt["b"])({type:qt,json:{write:!0}})],Yt.prototype,"occlusionTexture",void 0),Object(Mt["a"])([Object(Dt["b"])({type:Number,json:{write:!0},range:{min:0,max:1}})],Yt.prototype,"metallic",void 0),Object(Mt["a"])([Object(Dt["b"])({type:Number,json:{write:!0},range:{min:0,max:1}})],Yt.prototype,"roughness",void 0),Object(Mt["a"])([Object(Dt["b"])({type:qt,json:{write:!0}})],Yt.prototype,"metallicRoughnessTexture",void 0),Yt=$t=Object(Mt["a"])([Object(It["a"])("esri.geometry.support.MeshMaterialMetallicRoughness")],Yt);var Kt,Jt=Yt,ei=Jt,ti=i("1a3e"),ii=i("fc29");const ri=h["a"].getLogger("esri.geometry.support.MeshVertexAttributes");let ai=Kt=class extends Ft["a"]{constructor(e){super(e),this.color=null,this.position=new Float64Array(0),this.uv=null,this.normal=null,this.tangent=null}castColor(e){return si(e,Uint8Array,[Uint8ClampedArray],{loggerTag:".color=",stride:4},ri)}castPosition(e){return e&&e instanceof Float32Array&&ri.warn(".position=","Setting position attribute from a Float32Array may cause precision problems. Consider storing data in a Float64Array or a regular number array"),si(e,Float64Array,[Float32Array],{loggerTag:".position=",stride:3},ri)}castUv(e){return si(e,Float32Array,[Float64Array],{loggerTag:".uv=",stride:2},ri)}castNormal(e){return si(e,Float32Array,[Float64Array],{loggerTag:".normal=",stride:3},ri)}castTangent(e){return si(e,Float32Array,[Float64Array],{loggerTag:".tangent=",stride:4},ri)}clone(){const e={position:Object(Wt["a"])(this.position),uv:Object(Wt["a"])(this.uv),normal:Object(Wt["a"])(this.normal),tangent:Object(Wt["a"])(this.tangent),color:Object(Wt["a"])(this.color)};return new Kt(e)}};function ni(e,t,i,r){const{loggerTag:a,stride:n}=t;return e.length%n!=0?(r.error(a,"Invalid array length, expected a multiple of "+n),new i([])):e}function si(e,t,i,r,a){if(!e)return e;if(e instanceof t)return ni(e,r,t,a);for(const n of i)if(e instanceof n)return ni(new t(e),r,t,a);if(Array.isArray(e))return ni(new t(e),r,t,a);{const r=i.map(e=>`'${e.name}'`);return a.error(`Failed to set property, expected one of ${r}, but got ${e.constructor.name}`),new t([])}}function oi(e,t,i){t[i]=ci(e)}function ci(e){const t=new Array(e.length);for(let i=0;i<e.length;i++)t[i]=e[i];return t}Object(Mt["a"])([Object(Dt["b"])({json:{write:oi}})],ai.prototype,"color",void 0),Object(Mt["a"])([Object(ti["a"])("color")],ai.prototype,"castColor",null),Object(Mt["a"])([Object(Dt["b"])({nonNullable:!0,json:{write:oi}})],ai.prototype,"position",void 0),Object(Mt["a"])([Object(ti["a"])("position")],ai.prototype,"castPosition",null),Object(Mt["a"])([Object(Dt["b"])({json:{write:oi}})],ai.prototype,"uv",void 0),Object(Mt["a"])([Object(ti["a"])("uv")],ai.prototype,"castUv",null),Object(Mt["a"])([Object(Dt["b"])({json:{write:oi}})],ai.prototype,"normal",void 0),Object(Mt["a"])([Object(ti["a"])("normal")],ai.prototype,"castNormal",null),Object(Mt["a"])([Object(Dt["b"])({json:{write:oi}})],ai.prototype,"tangent",void 0),Object(Mt["a"])([Object(ti["a"])("tangent")],ai.prototype,"castTangent",null),ai=Kt=Object(Mt["a"])([Object(It["a"])("esri.geometry.support.MeshVertexAttributes")],ai);var li;const hi=h["a"].getLogger("esri.geometry.support.MeshComponent");let di=li=class extends ii["a"]{constructor(e){super(e),this.faces=null,this.material=null,this.shading="source",this.trustSourceNormals=!1}static from(e){return Object(Et["d"])(li,e)}castFaces(e){return si(e,Uint32Array,[Uint16Array],{loggerTag:".faces=",stride:3},hi)}castMaterial(e){return Object(Et["d"])(e&&"object"==typeof e&&("metallic"in e||"roughness"in e||"metallicRoughnessTexture"in e)?ei:Xt,e)}clone(){return new li({faces:Object(Wt["a"])(this.faces),shading:this.shading,material:Object(Wt["a"])(this.material),trustSourceNormals:this.trustSourceNormals})}cloneWithDeduplication(e,t){return new li({faces:Object(Wt["a"])(this.faces),shading:this.shading,material:this.material?this.material.cloneWithDeduplication(e,t):null,trustSourceNormals:this.trustSourceNormals})}};Object(Mt["a"])([Object(Dt["b"])({json:{write:!0}})],di.prototype,"faces",void 0),Object(Mt["a"])([Object(ti["a"])("faces")],di.prototype,"castFaces",null),Object(Mt["a"])([Object(Dt["b"])({type:Xt,json:{write:!0}})],di.prototype,"material",void 0),Object(Mt["a"])([Object(ti["a"])("material")],di.prototype,"castMaterial",null),Object(Mt["a"])([Object(Dt["b"])({type:String,json:{write:!0}})],di.prototype,"shading",void 0),Object(Mt["a"])([Object(Dt["b"])({type:Boolean})],di.prototype,"trustSourceNormals",void 0),di=li=Object(Mt["a"])([Object(It["a"])("esri.geometry.support.MeshComponent")],di);var ui=di,pi=ui,fi=i("7f83"),mi=i("9786"),bi=i("f694");const gi=h["a"].getLogger("esri.geometry.support.meshUtils.normalProjection");function vi(e,t,i,r,a){return r.isWebMercator||r.isWGS84?(Oi(0,O["u"].fromTypedArray(e),O["v"].fromTypedArray(t),O["v"].fromTypedArray(i),r,O["u"].fromTypedArray(a)),a):(gi.error("Cannot convert PCS spatial reference buffer to ECEF"),a)}function yi(e,t,i,r,a){if(!r.isWebMercator&&!r.isWGS84)return gi.error("Cannot convert PCS spatial reference buffer to ECEF"),a;Oi(0,O["u"].fromTypedArray(e,4*Float32Array.BYTES_PER_ELEMENT),O["v"].fromTypedArray(t),O["v"].fromTypedArray(i),r,O["u"].fromTypedArray(a,4*Float32Array.BYTES_PER_ELEMENT));for(let n=3;n<e.length;n+=4)a[n]=e[n];return a}function Oi(e,t,i,r,a,n){if(!t)return;const s=a.isWGS84||Object(fi["e"])(a)||Object(fi["h"])(a)||Object(fi["i"])(a),o=i.count;if(s)for(let c=0;c<o;c++){r.getVec(c,_i),t.getVec(c,xi);const i=Object(bi["g"])(a);Object(m["d"])(i,_i,ji,i),Object(y["f"])(wi,ji),1===e&&Object(y["n"])(wi,wi),Object(p["y"])(xi,xi,wi),n.setVec(c,xi)}else for(let c=0;c<o;c++){r.getVec(c,_i),t.getVec(c,xi),Object(m["d"])(bi["a"],_i,ji,bi["a"]),Object(y["f"])(wi,ji);const a=Object(mi["h"])(i.get(c,1));let s=Math.cos(a);0===e&&(s=1/s),wi[0]*=s,wi[1]*=s,wi[2]*=s,wi[3]*=s,wi[4]*=s,wi[5]*=s,1===e&&Object(y["n"])(wi,wi),Object(p["y"])(xi,xi,wi),Object(p["s"])(xi,xi),n.setVec(c,xi)}return n}const _i=Object(u["e"])(),xi=Object(u["e"])(),ji=Object(g["b"])(),wi=Object(b["a"])();var Si=i("1038"),Ci=i("caf1"),Ti=i("3748");const Pi=["mesh"];class Ai extends M["a"]{constructor(e,t,i,r){super(e,t,i,r),this._materials=new Map,this._textures=new Map,this.ensureDrapedStatus(!1)}async doLoad(){C["a"].DRAW_MESH_GEOMETRY_NORMALS&&(this._debugVertexNormalMaterial=new Ti["a"]({color:[1,0,1,1]}),this._debugFaceNormalMaterial=new Ti["a"]({color:[0,1,1,1]}))}destroy(){super.destroy(),this._context.stage.removeMany(Array.from(this._materials.values(),e=>e.material)),this._context.stage.removeMany(Array.from(this._textures.values())),this._materials.clear(),this._textures.clear()}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,Pi,"fill on mesh-3d"))return null;const i=this.setGraphicElevationContext(t,new A["a"]),r=e.renderingInfo;return this._createAs3DShape(t,r,i,t.uid)}layerOpacityChanged(e,t){const i=this._getLayerOpacity();return this._materials.forEach(e=>{e.material.setParameterValues({layerOpacity:i});const t=e.material.params;this._setMaterialTransparentParameter(t,e),e.material.setParameterValues({transparent:t.transparent})}),e.forEach(e=>{const a=t(e);Object(r["k"])(a)&&a.layerOpacityChanged(i,this._context.isAsync)}),!0}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,P["g"])}slicePlaneEnabledChanged(e,t){return this._materials.forEach(e=>{e.material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled})}),e.forEach(e=>{const i=t(e);Object(r["k"])(i)&&i.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){const e=this._usePBR();return this._materials.forEach(t=>t.material.setParameterValues({usePBR:e})),!0}pixelRatioChanged(){return!0}_requiresSymbolVertexColors(){return this._drivenProperties.color||this._drivenProperties.opacity}_colorOrTextureUid(e){return e?e instanceof me["a"]?e.toHex():e.contentHash:"-"}_materialPropertiesDefault(e,t){const i=this._requiresSymbolVertexColors(),r=!!e.vertexAttributes.color,a=!!e.vertexAttributes.tangent;return{hasSymbolVertexColors:i,hasVertexColors:r,hasVertexTangents:a,uid:`vc:${r},vt:${a},vct${t},svc:${i}`}}_materialProperties(e,t,i){const r=this._materialPropertiesDefault(e,i);if(!t.material)return r;const{color:a,colorTexture:n,normalTexture:s,doubleSided:o,alphaCutoff:c,alphaMode:l}=t.material,h=this._colorOrTextureUid(a),d=this._colorOrTextureUid(n),u=this._colorOrTextureUid(s);if(r.color=a,r.colorTexture=n,r.normalTexture=s,r.uid=`${r.uid},cmuid:${h},ctmuid:${d},ntmuid:${u},ds:${o},ac:${c},am:${l}`,t.material instanceof ei){const{metallic:e,roughness:i,metallicRoughnessTexture:a,emissiveColor:n,emissiveTexture:s,occlusionTexture:o}=t.material,c=this._colorOrTextureUid(a),l=this._colorOrTextureUid(n),h=this._colorOrTextureUid(s),d=this._colorOrTextureUid(o);r.metallic=e,r.roughness=i,r.metallicRoughnessTexture=a,r.emissiveColor=n,r.emissiveTexture=s,r.occlusionTexture=o,r.uid=`${r.uid},mrm:${e},mrr:${i},mrt:${c},emuid:${l},etmuid:${h},otmuid:${d}`}return r}_setInternalColorValueParameters(e,t){t.diffuse=me["a"].toUnitRGB(e),t.opacity=e.a}_getLoadableTextureResource(e){return e.data?e.data:e.url}_getInternalTextureId(e){const t=this._getLoadableTextureResource(e);if(!t)return;const i=e.contentHash;let r=this._textures.get(i);return r||(r=new ht["a"](t,{mipmap:!0,wrap:this._castTextureWrap(e.wrap),noUnpackFlip:!0,preMultiplyAlpha:!0}),this._textures.set(i,r),this._context.stage.add(r)),r.id}_castTextureWrap(e="repeat"){if("string"==typeof e){const t=this._castTextureWrapIndividual(e);return{s:t,t:t}}return{s:this._castTextureWrapIndividual(e.horizontal),t:this._castTextureWrapIndividual(e.vertical)}}_castTextureWrapIndividual(e){switch(e){case"clamp":return 33071;case"mirror":return 33648;case"repeat":default:return 10497}}_setInternalMaterialParameters(e,t){e.color&&this._setInternalColorValueParameters(e.color,t),e.colorTexture&&(t.textureId=this._getInternalTextureId(e.colorTexture)),e.normalTexture&&(t.normalTextureId=this._getInternalTextureId(e.normalTexture)),e.emissiveColor&&(t.emissiveFactor=me["a"].toUnitRGB(e.emissiveColor)),e.emissiveTexture&&(t.emissiveTextureId=this._getInternalTextureId(e.emissiveTexture)),e.occlusionTexture&&(t.occlusionTextureId=this._getInternalTextureId(e.occlusionTexture)),e.metallicRoughnessTexture&&(t.metallicRoughnessTextureId=this._getInternalTextureId(e.metallicRoughnessTexture))}_setExternalMaterialParameters(e){const t=this._drivenProperties.color;let i=Object(r["k"])(this.symbolLayer.material)?this.symbolLayer.material.colorMixMode:null;if(t)e.externalColor=_e["a"];else{const t=Object(r["k"])(this.symbolLayer.material)?this.symbolLayer.material.color:null;Object(r["k"])(t)?e.externalColor=me["a"].toUnitRGBA(t):(i=null,e.externalColor=_e["a"])}i&&(e.colorMixMode=i),e.castShadows=!!this.symbolLayer.castShadows}_hasTransparentVertexColors(e){const t=e.vertexAttributes.color;if(!t)return!1;for(let i=3;i<t.length;i+=4)if(255!==t[i])return!0;return!1}_getOrCreateMaterial(e,t){const i=t.material&&t.material.color,r=t.material&&t.material.colorTexture,a=t.material&&"blend"===t.material.alphaMode,n=!(t.material&&"opaque"===t.material.alphaMode)&&(this._hasTransparentVertexColors(e)||i&&i.a<1||r&&r.transparent||a),s=this._materialProperties(e,t,n),o=this._materials.get(s.uid);if(o)return o.material;const c={material:null,isComponentTransparent:n,alphaMode:t.material?t.material.alphaMode:"opaque"},l=null==s.metallicRoughnessTexture&&null==s.metallic&&null==s.roughness,h={usePBR:this._usePBR(),isSchematic:l,vertexColors:s.hasVertexColors,symbolColors:s.hasSymbolVertexColors,vertexTangents:s.hasVertexTangents,ambient:u["b"],diffuse:u["a"],opacity:1,doubleSided:!0,doubleSidedType:"winding-order",cullFace:0,textureAlphaPremultiplied:!0,layerOpacity:this._getLayerOpacity(),slicePlaneEnabled:this._context.slicePlaneEnabled,initTextureTransparent:!0};l||(h.mrrFactors=[null!=s.metallic?s.metallic:1,null!=s.roughness?s.roughness:1,.5]),t.material&&(h.doubleSided=t.material.doubleSided,h.cullFace=t.material.doubleSided?0:2,h.textureAlphaCutoff=t.material.alphaCutoff),this._setInternalMaterialParameters(s,h),this._setExternalMaterialParameters(h),this._setMaterialTransparentParameter(h,c);const d=new N["b"](h);return c.material=d,this._materials.set(s.uid,c),this._context.stage.add(d),d}_usePBR(){return this._context.physicalBasedRenderingEnabled}_setMaterialTransparentParameter(e,t){e.transparent=this.needsDrivenTransparentPass||t.isComponentTransparent||e.layerOpacity<1||e.opacity<1||e.externalColor&&e.externalColor[3]<1,"auto"===t.alphaMode?e.textureAlphaMode=e.transparent?3:1:e.textureAlphaMode="opaque"===t.alphaMode?1:"mask"===t.alphaMode?2:0}_addDebugNormals(e,t,i,r){const a=t.length,n=e.spatialReference.isGeographic?20015077/180:1,s=.1*Math.max(e.extent.width*n,e.extent.height*n,e.extent.zmax-e.extent.zmin),o=[],c=[],l=[],h=[];for(let f=0;f<a;f++){const e=t[f],i=e.vertexAttributes.get("position"),r=e.vertexAttributes.get("normal"),a=e.indices.get("position"),n=e.indices.get("normal"),d=i.data,u=r.data;for(let t=0;t<a.length;t++){const e=3*a[t],i=3*n[t];for(let t=0;t<3;t++)o.push(d[e+t]);for(let t=0;t<3;t++)o.push(d[e+t]+u[i+t]*s);if(c.push(c.length),c.push(c.length),t%3==0){this._calculateFaceNormal(d,a,t,Ii),this._getFaceVertices(d,a,t,Mi,Ei,Di),Object(p["g"])(Mi,Mi,Ei),Object(p["g"])(Mi,Mi,Di),Object(p["f"])(Mi,Mi,1/3);for(let e=0;e<3;e++)l.push(Mi[e]);for(let e=0;e<3;e++)l.push(Mi[e]+Ii[e]*s);h.push(h.length),h.push(h.length)}}}const d=new w["a"]([["position",{data:o,size:3,exclusive:!0}]],[["position",new Uint32Array(c)]],2);t.push(d),i.push(this._debugVertexNormalMaterial),r.push(Object(g["c"])(r[0]));const u=new w["a"]([["position",{data:l,size:3,exclusive:!0}]],[["position",new Uint32Array(h)]],2);t.push(u),i.push(this._debugFaceNormalMaterial),r.push(Object(g["c"])(r[0]))}_createAs3DShape(e,t,i,a){const n=e.geometry;if("mesh"!==n.type)return null;const o=this._createGeometryInfo(n,t);if(!o)return null;const{geometries:c,materials:l,transformations:h,objectTransformation:d}=o;C["a"].DRAW_MESH_GEOMETRY_NORMALS&&this._addDebugNormals(n,c,l,h);const u=new S["a"]({geometries:c,materials:l,transformations:h,metadata:{layerUid:this._context.layer.uid,graphicUid:a}});u.transformation=d;const p=Se["b"],f=this._createEdgeMaterial(),m=Object(r["k"])(f)?{baseMaterial:l[0],edgeMaterials:[f],properties:{mergeGeometries:!0,slicePlaneEnabled:this._context.slicePlaneEnabled}}:null,b=new s["a"](this,u,c,null,null,p,i,m);b.needsElevationUpdates=Object(P["g"])(i.mode);const g=n.extent.center.clone();return g.z=0,b.elevationContext.centerPointInElevationSR=g,b.alignedSampledElevation=p(b,b.elevationContext,this._context.elevationProvider,this._context.renderCoordsHelper),b}_createComponentNormals(e,t,i,r){switch(i.shading||"flat"){case"source":return this._createComponentNormalsSource(e,t,i,r);case"flat":return this._createComponentNormalsFlat(e,r);case"smooth":return this._createComponentNormalsSmooth(e,r);default:return}}_createComponentNormalsSource(e,t,i,r){if(!t)return this._createComponentNormalsFlat(e,r);let a=!1;if(!i.trustSourceNormals)for(let n=0;n<r.length;n+=3){this._calculateFaceNormal(e,r,n,Ii);for(let e=0;e<3;e++){const i=3*r[n+e];Mi[0]=t[i+0],Mi[1]=t[i+1],Mi[2]=t[i+2],Object(p["i"])(Ii,Mi)<0&&(t[i+0]=-t[i+0],t[i+1]=-t[i+1],t[i+2]=-t[i+2],a=!0)}}return{normals:t,indices:r,didFlipNormals:a}}_createComponentNormalsFlat(e,t){const i=new Float32Array(t.length),r=new Uint32Array(3*t.length);for(let a=0;a<t.length;a+=3){const n=this._calculateFaceNormal(e,t,a,Ii);for(let e=0;e<3;e++)i[a+e]=n[e],r[a+e]=a/3}return{normals:i,indices:r,didFlipNormals:!1}}_createComponentNormalsSmooth(e,t){const i={};for(let n=0;n<t.length;n+=3){const r=this._calculateFaceNormal(e,t,n,Ii);for(let e=0;e<3;e++){const a=t[n+e];let s=i[a];s||(s={normal:Object(u["e"])(),count:0},i[a]=s),Object(p["g"])(s.normal,s.normal,r),s.count++}}const r=new Float32Array(3*t.length),a=new Uint32Array(3*t.length);for(let n=0;n<t.length;n++){const e=i[t[n]];1!==e.count&&(Object(p["s"])(e.normal,e.normal),e.count=1);for(let t=0;t<3;t++)r[3*n+t]=e.normal[t];a[n]=n}return{normals:r,indices:a,didFlipNormals:!1}}_getFaceVertices(e,t,i,r,a,n){const s=3*t[i+0],o=3*t[i+1],c=3*t[i+2];r[0]=e[s+0],r[1]=e[s+1],r[2]=e[s+2],a[0]=e[o+0],a[1]=e[o+1],a[2]=e[o+2],n[0]=e[c+0],n[1]=e[c+1],n[2]=e[c+2]}_calculateFaceNormal(e,t,i,r){return this._getFaceVertices(e,t,i,Mi,Ei,Di),Object(p["k"])(Ei,Ei,Mi),Object(p["k"])(Di,Di,Mi),Object(p["h"])(Mi,Ei,Di),Object(p["s"])(r,Mi),r}_getOrCreateComponents(e){return e.components?e.components:Fi}_createPositionBuffer(e){const t=e.vertexAttributes.position,i=new Float64Array(t.length),r=this._context.renderCoordsHelper.spatialReference;return Object(m["q"])(e.vertexAttributes.position,e.spatialReference,0,i,r,0,t.length/3),i}_createNormalBuffer(e,t){const i=e.vertexAttributes.normal;if(!i)return null;if("local"===this._context.layerView.view.viewingMode)return i;const r=e.vertexAttributes.position,a=new Float32Array(i.length);return vi(i,r,t,e.spatialReference,a)}_createTangentBuffer(e,t){const i=e.vertexAttributes.tangent;if(!i)return null;if("local"===this._context.layerView.view.viewingMode)return i;const r=e.vertexAttributes.position,a=new Float32Array(i.length);return yi(i,r,t,e.spatialReference,a)}_createColorBuffer(e){return e.vertexAttributes.color}_createSymbolColorBuffer(e){if(this._requiresSymbolVertexColors()){const t=this._getVertexOpacityAndColor(e),i=Object(Ci["b"])(Object(r["i"])(this.symbolLayer,"material","colorMixMode")),a=new Uint8Array(4);return Object(Ci["a"])(t,i,a),a}return null}_createBuffers(e,t){const i=e.vertexAttributes&&e.vertexAttributes.position;if(!i)return this.logger.warn("Mesh geometry must contain position vertex attributes"),null;const r=e.vertexAttributes.normal,a=e.vertexAttributes.uv,n=e.vertexAttributes.tangent;if(r&&r.length!==i.length)return this.logger.warn("Mesh normal vertex buffer must contain the same number of elements as the position buffer"),null;if(n&&n.length/4!=i.length/3)return this.logger.warn("Mesh tangent vertex buffer must contain the same number of elements as the position buffer"),null;if(a&&a.length/2!=i.length/3)return this.logger.warn("Mesh uv vertex buffer must contain the same number of elements as the position buffer"),null;const s=this._createPositionBuffer(e),o=this._createColorBuffer(e),c=this._createSymbolColorBuffer(t),l=this._createNormalBuffer(e,s);return{positionBuffer:s,normalBuffer:l,tangentBuffer:this._createTangentBuffer(e,s),uvBuffer:a,colorBuffer:o,symbolColorBuffer:c,objectTransformation:this._transformCenterLocal(e,s,l)}}_transformCenterLocal(e,t,i){const r=e.extent.center,a=this._context.renderCoordsHelper.spatialReference;Ri[0]=r.x,Ri[1]=r.y,Ri[2]=0;const n=Object(g["b"])();Object(m["d"])(e.spatialReference,Ri,n,a),Object(f["a"])(Li,n);for(let s=0;s<t.length;s+=3)Mi[0]=t[s+0],Mi[1]=t[s+1],Mi[2]=t[s+2],Object(p["n"])(Mi,Mi,Li),t[s+0]=Mi[0],t[s+1]=Mi[1],t[s+2]=Mi[2];if(i){Object(y["f"])(Vi,n),Object(y["n"])(Vi,Vi);for(let e=0;e<i.length;e+=3)Mi[0]=i[e+0],Mi[1]=i[e+1],Mi[2]=i[e+2],Object(p["y"])(Mi,Mi,Vi),i[e+0]=Mi[0],i[e+1]=Mi[1],i[e+2]=Mi[2]}return n}_validateFaces(e,t){const i=e.vertexAttributes.position.length/3,r=t.faces;if(r){let e=-1;for(let t=0;t<r.length;t++){const i=r[t];i>e&&(e=i)}if(i<=e)return this.logger.warn(`Vertex index ${e} is out of bounds of the mesh position buffer`),!1}else if(i%3!=0)return this.logger.warn("Mesh position buffer length must be a multiple of 9 if no component faces are defined (3 values per vertex * 3 vertices per triangle)"),!1;return!0}_getOrCreateFaces(e,t){return t.faces?t.faces:Object(Si["d"])(e.vertexAttributes.position.length/3)}_isOutsideClippingArea(e){if(!this._context.clippingExtent)return!1;const t=e.vertexAttributes&&e.vertexAttributes.position;if(!t)return!1;const i=this._context.elevationProvider.spatialReference;let r;const a=t.length/3;return e.spatialReference.equals(i)?r=t:(r=new Float64Array(t.length),Object(m["q"])(e.vertexAttributes.position,e.spatialReference,0,r,i,0,a)),Object(x["k"])(ki),Object(x["n"])(ki,r,0,a),!Object(x["x"])(ki,this._context.clippingExtent)}_createGeometryInfo(e,t){if(!Object(m["b"])(e.spatialReference,this._context.layerView.view.spatialReference))return this.logger.warn("Geometry spatial reference is not compatible with the view"),null;if(this._isOutsideClippingArea(e))return null;const i=this._createBuffers(e,t);if(!i)return null;const{positionBuffer:r,uvBuffer:a,colorBuffer:n,symbolColorBuffer:s,normalBuffer:o,tangentBuffer:c,objectTransformation:l}=i,h=this._getOrCreateComponents(e),d=[],u=[],p=[];let f=!1;for(const m of h){if(!this._validateFaces(e,m))return null;const t=this._getOrCreateFaces(e,m);if(0===t.length)continue;const i=this._createComponentNormals(r,o,m,t);i.didFlipNormals&&(f=!0);const l=[["position",{size:3,data:r,exclusive:!0}],["normal",{size:3,data:i.normals,exclusive:!0}]],h=[["position",t],["normal",i.indices]];n&&(l.push(["color",{size:4,data:n,exclusive:!0}]),h.push(["color",t])),s&&(l.push(["symbolColor",{size:4,data:s,exclusive:!0}]),h.push(["symbolColor",new Uint16Array(t.length)])),e.vertexAttributes.uv&&(l.push(["uv0",{size:2,data:a,exclusive:!0}]),h.push(["uv0",t])),e.vertexAttributes.tangent&&(l.push(["tangent",{size:4,data:c,exclusive:!0}]),h.push(["tangent",t]));const b=new w["a"](l,h);d.push(b),u.push(Object(g["b"])()),p.push(this._getOrCreateMaterial(e,m))}return f&&this.logger.warn("Normals have been automatically flipped to be consistent with the counter clock wise face winding order. It is better to generate mesh geometries that have consistent normals."),{geometries:d,transformations:u,materials:p,objectTransformation:l}}_createEdgeMaterial(){const e={opacity:this._getLayerOpacity()};return Object(R["a"])(this.symbolLayer,e)}}const Ri=Object(u["e"])(),Mi=Object(u["e"])(),Ei=Object(u["e"])(),Di=Object(u["e"])(),Ii=Object(u["e"])(),Li=Object(g["b"])(),Vi=Object(b["a"])(),ki=Object(x["h"])(),Fi=[new pi];var zi=i("8c11"),Ui=i("9ac8"),Gi=i("f33e"),Bi=i("af3d"),Hi=i("bea9"),Ni=i("e9d6");class qi{constructor(e,t,i,r){this.graphics3DSymbolLayer=e,this.instanceIndex=t,this.elevationAligner=i,this.elevationContext=r,this.type="lod-instance",this.alignedSampledElevation=0,this.isElevationSource=!1,this.needsElevationUpdates=!1}initialize(){}setVisibility(e){const t=this.lodRenderer.instanceData;e!==t.getVisible(this.instanceIndex)&&t.setVisible(this.instanceIndex,e)}destroy(){null!=this.instanceIndex&&(this.lodRenderer.instanceData.removeInstance(this.instanceIndex),this.graphics3DSymbolLayer.notifyDestroyGraphicLayer(this))}alignWithElevation(e,t,i){if(this.elevationAligner){Object(Ni["g"])(this.elevationContext.featureExpressionInfoContext,i);const r=this.elevationAligner(this,this.elevationContext,e,t);null!=r&&(this.alignedSampledElevation=r)}}getBSRadius(){const e=this.lodRenderer;return e.baseBoundingSphere.radius*e.instanceData.getCombinedMaxScaleFactor(this.instanceIndex)}getCenterObjectSpace(e=Object(u["e"])()){return this.lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,Xi),Object(p["n"])(e,this.lodRenderer.baseBoundingSphere.center,Xi)}getBoundingBoxObjectSpace(e=Object(x["h"])()){this.lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,Xi);const t=this.lodRenderer.baseBoundingBox;Object(x["k"])(e);for(let i=0;i<8;++i)Object(p["x"])(Zi,0==(1&i)?t[0]:t[3],0==(2&i)?t[1]:t[4],0==(4&i)?t[2]:t[5]),Object(p["n"])(Zi,Zi,Xi),Object(x["r"])(e,Zi);return e}computeAttachmentOrigin(e){this.lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,Xi),e.render.origin[0]+=Xi[12],e.render.origin[1]+=Xi[13],e.render.origin[2]+=Xi[14],e.render.num++}async getProjectedBoundingBox(e,t,i,a,n){const s=this.getBoundingBoxObjectSpace(n),o=Qi,c=Object(x["y"])(s)?1:o.length;this.lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,Xi);for(let r=0;r<c;r++){const e=o[r];Zi[0]=s[e[0]],Zi[1]=s[e[1]],Zi[2]=s[e[2]],Object(p["n"])(Zi,Zi,Xi),Wi[3*r+0]=Zi[0],Wi[3*r+1]=Zi[1],Wi[3*r+2]=Zi[2]}if(!e(Wi,0,c))return null;Object(x["k"])(s);let l=null;this.calculateRelativeScreenBounds&&(l=this.calculateRelativeScreenBounds());for(let r=0;r<3*c;r+=3){for(let e=0;e<3;e++)s[e]=Math.min(s[e],Wi[r+e]),s[e+3]=Math.max(s[e+3],Wi[r+e]);l&&i.push({location:Wi.slice(r,r+3),screenSpaceBoundingRect:l})}if(t&&(Object(x["e"])(s,$i),"absolute-height"!==this.elevationContext.mode)){let e;const i=Object(T["d"])(s,t);try{e=await t.service.queryElevation($i[0],$i[1],a,i,"ground")}catch(h){}Object(r["k"])(e)&&Object(x["A"])(s,0,0,-this.alignedSampledElevation+e)}return s}addObjectState(e,t){if(0===e){const i=new Hi["a"](e);this.addHighlightId(i),t.addExternal(e=>{this.removeHighlightId(e)},i)}}removeObjectState(e){this.highlights&&this.highlights.forEach(t=>e.remove(t))}addHighlightId(e){this.highlights=this.highlights||new Set,this.highlights.add(e),this.lodRenderer.instanceData.setHighlight(this.instanceIndex,!0)}removeHighlightId(e){this.highlights&&(this.highlights.delete(e),this.lodRenderer.instanceData.setHighlight(this.instanceIndex,this.highlights.size>0),0===this.highlights.size&&(this.highlights=null))}get lodRenderer(){return this.graphics3DSymbolLayer.lodRenderer}}const Wi=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],Zi=Object(u["e"])(),$i=Object(u["e"])(),Qi=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],Xi=Object(g["b"])();var Yi=qi;function Ki(e){const t=[];return e.stageResources.geometries.forEach((i,r)=>{const a=e.stageResources.materials[r],n=e.stageResources.textures;t.push({material:a,geometry:i,textures:n})}),{components:t,minScreenSpaceRadius:e.lodThreshold,pivotOffset:e.pivotOffset}}function Ji(e){return{levels:e.map(e=>Ki(e))}}function er(e,t=ir){const i=Object(Gi["a"])(e);return Math.sqrt(i/(t*Math.PI))}function tr(e){e.levels.forEach(e=>{e.minScreenSpaceRadius||(e.minScreenSpaceRadius=er(e))})}const ir=.05;var rr,ar=i("94a6"),nr=i("fa1e"),sr=i("2ebb"),or=i("1153"),cr=i("7ce4"),lr=i("8539"),hr=i("0fa6"),dr=i("b623"),ur=i("a978"),pr=i("171c"),fr=i("7c51"),mr=i("6a07"),br=i("ce6d"),gr=i("680b"),vr=i("fc00");function yr(e){let t=Object(vr["a"])().mat4f64("localTransform").mat4f64("globalTransform").vec4f64("boundingSphere").vec3f64("modelOrigin").mat3f("model").mat3f("modelNormal").vec2f("modelScaleFactors");return e.indexOf("color")>=0&&(t=t.vec4f("color")),e.indexOf("featureAttribute")>=0&&(t=t.vec4f("featureAttribute")),t=t.u8("state").u8("lodLevel").alignTo(8),t}!function(e){e[e.ALLOCATED=1]="ALLOCATED",e[e.DEFAULT_ACTIVE=2]="DEFAULT_ACTIVE",e[e.VISIBLE=4]="VISIBLE",e[e.HIGHLIGHT=8]="HIGHLIGHT",e[e.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",e[e.REMOVE=32]="REMOVE",e[e.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED",e[e.ACTIVE=18]="ACTIVE"}(rr||(rr={}));class Or{constructor(e){this.localTransform=e.getField("localTransform",O["i"]),this.globalTransform=e.getField("globalTransform",O["i"]),this.modelOrigin=e.getField("modelOrigin",O["v"]),this.model=e.getField("model",O["f"]),this.modelNormal=e.getField("modelNormal",O["f"]),this.modelScaleFactors=e.getField("modelScaleFactors",O["m"]),this.boundingSphere=e.getField("boundingSphere",O["D"]),this.color=e.getField("color",O["C"]),this.featureAttribute=e.getField("featureAttribute",O["C"]),this.state=e.getField("state",O["l"]),this.lodLevel=e.getField("lodLevel",O["l"])}}class _r extends br["a"]{constructor(e,t){super(),this._capacity=0,this._size=0,this._next=0,this._layout=yr(e),this._shaderTransformation=t}get capacity(){return this._capacity}get size(){return this._size}get buffer(){return this._buffer.buffer}get view(){return this._view}addInstance(){this._size+1>this._capacity&&this.grow();const e=this.findSlot();return this._view.state.set(e,rr.ALLOCATED),this._size++,this.emit("instance-added",{index:e}),e}removeInstance(e){const t=this._view.state;Object(or["a"])(e>=0&&e<this._capacity&&t.get(e)&rr.ALLOCATED,"invalid instance handle"),this.getStateFlag(e,rr.ACTIVE)?this.setStateFlags(e,rr.REMOVE):this.freeInstance(e),this.emit("instance-removed",{index:e})}freeInstance(e){const t=this._view.state;Object(or["a"])(e>=0&&e<this._capacity&&t.get(e)&rr.ALLOCATED,"invalid instance handle"),t.set(e,0),this._size--}setLocalTransform(e,t,i=!0){this._view.localTransform.setMat(e,t),i&&this.updateModelTransform(e)}getLocalTransform(e,t){this._view.localTransform.getMat(e,t)}setGlobalTransform(e,t,i=!0){this._view.globalTransform.setMat(e,t),i&&this.updateModelTransform(e)}getGlobalTransform(e,t){this._view.globalTransform.getMat(e,t)}updateModelTransform(e){const t=this._view,i=wr,r=Sr;t.localTransform.getMat(e,Cr),t.globalTransform.getMat(e,Tr);const a=Object(f["m"])(Tr,Tr,Cr);Object(p["x"])(i,a[12],a[13],a[14]),t.modelOrigin.setVec(e,i),Object(y["f"])(r,a),t.model.setMat(e,r);const n=Object(gr["k"])(wr,a);n.sort(),t.modelScaleFactors.set(e,0,n[1]),t.modelScaleFactors.set(e,1,n[2]),Object(y["d"])(r,r),Object(y["n"])(r,r),t.modelNormal.setMat(e,r),this.setStateFlags(e,rr.TRANSFORM_CHANGED),this.emit("instance-transform-changed",{index:e})}getModelTransform(e,t){const i=this._view;i.model.getMat(e,Sr),i.modelOrigin.getVec(e,wr),t[0]=Sr[0],t[1]=Sr[1],t[2]=Sr[2],t[3]=0,t[4]=Sr[3],t[5]=Sr[4],t[6]=Sr[5],t[7]=0,t[8]=Sr[6],t[9]=Sr[7],t[10]=Sr[8],t[11]=0,t[12]=wr[0],t[13]=wr[1],t[14]=wr[2],t[15]=1}applyShaderTransformation(e,t){this._shaderTransformation&&this._shaderTransformation.applyTransform(this,e,t)}getCombinedModelTransform(e,t){return this.getModelTransform(e,t),this._shaderTransformation&&this._shaderTransformation.applyTransform(this,e,t),t}getCombinedLocalTransform(e,t){return this._view.localTransform.getMat(e,t),this._shaderTransformation&&this._shaderTransformation.applyTransform(this,e,t),t}getCombinedMaxScaleFactor(e){let t=this._view.modelScaleFactors.get(e,1);if(this._shaderTransformation){const i=this._shaderTransformation.scaleFactor(wr,this,e);t*=Math.max(i[0],i[1],i[2])}return t}getCombinedMedianScaleFactor(e){let t=this._view.modelScaleFactors.get(e,0);if(this._shaderTransformation){const i=this._shaderTransformation.scaleFactor(wr,this,e);i.sort(),t*=i[1]}return t}getModel(e,t){this._view.model.getMat(e,t)}setFeatureAttribute(e,t){this._view.featureAttribute.setVec(e,t)}getFeatureAttribute(e,t){this._view.featureAttribute.getVec(e,t)}setColor(e,t){this._view.color.setVec(e,t)}getColor(e,t){this._view.color.getVec(e,t)}setVisible(e,t){t!==this.getVisible(e)&&(this.setStateFlag(e,rr.VISIBLE,t),this.emit("instance-visibility-changed",{index:e}))}getVisible(e){return this.getStateFlag(e,rr.VISIBLE)}setHighlight(e,t){t!==this.getHighlight(e)&&(this.setStateFlag(e,rr.HIGHLIGHT,t),this.emit("instance-highlight-changed",{index:e}))}getHighlight(e){return this.getStateFlag(e,rr.HIGHLIGHT)}getState(e){return this._view.state.get(e)}getLodLevel(e){return this._view.lodLevel.get(e)}countFlags(e){let t=0;for(let i=0;i<this._capacity;++i)this.getState(i)&e&&++t;return t}setStateFlags(e,t){const i=this._view.state;t=i.get(e)|t,i.set(e,t)}clearStateFlags(e,t){const i=this._view.state;t=i.get(e)&~t,i.set(e,t)}setStateFlag(e,t,i){i?this.setStateFlags(e,t):this.clearStateFlags(e,t)}getStateFlag(e,t){return!!(this._view.state.get(e)&t)}grow(){const e=Math.max(xr,Math.floor(this._capacity*jr)),t=this._layout.createBuffer(e);if(this._buffer){const e=new Uint8Array(this._buffer.buffer);new Uint8Array(t.buffer).set(e)}this._capacity=e,this._buffer=t,this._view=new Or(this._buffer)}findSlot(){const e=this._view.state;let t=this._next;for(;e.get(t)&rr.ALLOCATED;)t=(t+1)%this._capacity;return this._next=(t+1)%this._capacity,t}}const xr=1024,jr=2,wr=Object(u["e"])(),Sr=Object(b["a"])(),Cr=Object(g["b"])(),Tr=Object(g["b"])();var Pr=i("d0ac"),Ar=i("0bde");class Rr extends Ar["a"]{constructor(e,t){super(e=>Pr["h"].wrap(this._instanceData.view.boundingSphere.getVec(e,this._tmpSphere)),{maximumDepth:25}),this._tmpSphere=Pr["h"].create(),this._tmpMat4=Object(g["b"])(),this._instanceData=e,this._boundingSphere=t}addInstance(e){const t=this._instanceData.view.boundingSphere,i=this._instanceData.getCombinedModelTransform(e,this._tmpMat4);Object(p["n"])(this._tmpSphere,this._boundingSphere.center,i),this._tmpSphere[3]=this._boundingSphere.radius*Object(gr["j"])(i),t.setVec(e,this._tmpSphere),this.add([e])}removeInstance(e){this.remove([e])}}class Mr{constructor(e,t){this.thresholdScale=1,this._camera=new pr["a"],this._worldSpaceRadius=e,this._thresholds=t.map(e=>e)}updateCamera(e){this._camera.copyFrom(e)}selectLevel(e,t){const i=this._camera.computeScreenPixelSizeAt(e),r=this._worldSpaceRadius*t/i,a=this._thresholds;let n=-1;for(let s=0;s<a.length;++s)r>=a[s]*this.thresholdScale&&(n=s);return n}}class Er{constructor(e,t,i){this._elementSize=t,this._buffer=cr["a"].createVertex(e,35044),this.resize(i)}destroy(){this._buffer.dispose()}get elementSize(){return this._elementSize}get capacity(){return this._capacity}get array(){return this._array}get buffer(){return this._buffer}get memoryUsage(){return{cpu:this._capacity*this._elementSize,gpu:this._capacity*this._elementSize}}copyRange(e,t,i,r=0){const a=new Uint8Array(this.array,e*this.elementSize,(t-e)*this.elementSize);new Uint8Array(i.array,r*this.elementSize).set(a)}transferAll(){this._buffer.setData(this._array)}transferRange(e,t){const i=e*this._elementSize,r=t*this._elementSize;this._buffer.setSubData(this._array,i,i,r)}resize(e){const t=e*this._elementSize,i=new ArrayBuffer(t);this._array&&(e>=this._capacity?new Uint8Array(i).set(new Uint8Array(this._array)):new Uint8Array(i).set(new Uint8Array(this._array).subarray(0,e*this._elementSize))),this._array=i,this._buffer.setData(t),this._capacity=e}}var Dr=Er;class Ir{constructor(e){this.modelOriginHi=e.getField("modelOriginHi",O["u"]),this.modelOriginLo=e.getField("modelOriginLo",O["u"]),this.model=e.getField("model",O["f"]),this.modelNormal=e.getField("modelNormal",O["f"]),this.color=e.getField("instanceColor",O["C"]),this.featureAttribute=e.getField("instanceFeatureAttribute",O["C"])}}class Lr{constructor(e,t){this._headIndex=0,this._tailIndex=0,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._rctx=e,this._instanceBufferLayout=t,this._elementSize=t.stride,this._capacity=1}destroy(){this._buffer&&this._buffer.destroy()}get buffer(){return this._buffer.buffer}get view(){return this._view}get capacity(){return this._capacity}get size(){const e=this._headIndex,t=this._tailIndex;return e>=t?e-t:e+this._capacity-t}get isEmpty(){return this._headIndex===this._tailIndex}get isFull(){return this._tailIndex===(this._headIndex+1)%this._capacity}get headIndex(){return this._headIndex}get tailIndex(){return this._tailIndex}get firstIndex(){return this._firstIndex}get memoryUsage(){return this._buffer?this._buffer.memoryUsage:{cpu:0,gpu:0}}reset(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null}startUpdateCylce(){this._captureFirstIndex=!0}beginUpdate(){Object(or["a"])(!this._updating,"already updating"),this._updating=!0,this._prevHeadIndex=this._headIndex}endUpdate(){Object(or["a"])(this._updating,"not updating"),this.size<Fr*this.capacity&&this.shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this.transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1}allocateHead(){Object(or["a"])(this._updating,"not updating"),this.isFull&&this.grow();const e=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=e,this._captureFirstIndex=!1),this.incrementHead(),Object(or["a"])(this._headIndex!==this._tailIndex,"invalid pointers"),e}freeTail(){Object(or["a"])(this._updating,"not updating"),Object(or["a"])(this.size>0,"invalid size");const e=this._tailIndex===this._firstIndex;this.incrementTail(),e&&(this._firstIndex=this._tailIndex)}grow(){const e=Math.max(Vr,Math.floor(this._capacity*kr));this.resize(e)}shrink(){const e=Math.max(Vr,Math.floor(this._capacity*zr));this.resize(e)}resize(e){if(Object(or["a"])(this._updating,"not updating"),e===this._capacity)return;const t=new Dr(this._rctx,this._elementSize,e);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);const e=this.size,i=this.compactInstances(t);Object(or["a"])(i===e,"invalid compaction"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=i,this._prevHeadIndex=0}this._resized=!0,this._capacity=e,this._buffer=t,this._view=new Ir(this._instanceBufferLayout.createView(this._buffer.array))}compactInstances(e){const t=this._headIndex,i=this._tailIndex;return i<t?(this._buffer.copyRange(i,t,e),t-i):i>t?(this._buffer.copyRange(i,this._capacity,e),t>0&&this._buffer.copyRange(0,t,e,this._capacity-i),t+(this._capacity-i)):0}incrementHead(e=1){this._headIndex=(this._headIndex+e)%this._capacity}incrementTail(e=1){this._tailIndex=(this._tailIndex+e)%this._capacity}transferRange(e,t){e<t?this._buffer.transferRange(e,t):e>t&&(t>0&&this._buffer.transferRange(0,t),this._buffer.transferRange(e,this._capacity))}}const Vr=1024,kr=2,Fr=.3,zr=.5;let Ur=function(e){const t=e.baseBoundingSphere.radius,i=e.levels.map(e=>e.minScreenSpaceRadius);return new Mr(t,i)};class Gr{constructor(e,t){const i=e.renderContext.rctx,r=t.geometry,a=t.material;this.materialRep=e.materialRep,a.setParameterValues({instancedDoublePrecision:!0});const n=a.createBufferWriter(),s=n.vertexBufferLayout,o=n.elementCount(r),c=n.allocate(o);n.write({},r,c,0),this.geometry=r,this.material=a,this.glMaterials=Object(dr["a"])(a,this.materialRep),this.vertexBufferLayout=s,this.vbo=cr["a"].createVertex(i,35044,c.buffer),this.vao=new hr["a"](i,nr["a"],{geometry:Object(sr["a"])(s)},{geometry:this.vbo}),this.vertexCount=o}destroy(){Object(dr["f"])(this.material,this.materialRep),this.vbo.dispose(),this.vao.dispose()}get boundingInfo(){return this.geometry.boundingInfo}get triangleCount(){return this.vertexCount/3}intersect(e,t,i,r,a,n){const s=this.geometry.id,o=a.toString();this.material.intersect(this.geometry,null,e.transform.transform,e,i,r,(i,r,c,l)=>{if(i>=0){if(null!=t&&!t(e.rayBeginPoint,e.rayEndPoint,i))return;const h={type:"external",metadata:{layerUid:n.layerUid,graphicUid:n.graphicUid(a)}};if((null==e.results.min.drapedLayerOrder||l>=e.results.min.drapedLayerOrder)&&(null==e.results.min.dist||i<e.results.min.dist)&&(e.results.min.set(h,o,i,r,e.transform.transform,l,null,s,c),e.results.min.intersector="LodRenderer"),0!==e.options.store&&(null==e.results.max.drapedLayerOrder||l>=e.results.max.drapedLayerOrder)&&(null==e.results.max.dist||i>e.results.max.dist)&&(e.results.max.set(h,o,i,r,e.transform.transform,l,null,s,c),e.results.min.intersector="LodRenderer"),2===e.options.store){const t=new ur["b"](e.results.min.ray);t.set(h,o,i,r,e.transform.transform,l,null,s,c),t.intersector="LodRenderer",e.results.all.push(t)}}})}}class Br{constructor(e,t){this.components=[],this.minScreenSpaceRadius=t.minScreenSpaceRadius,t.components.forEach(t=>{this.components.push(new Gr(e,t))})}destroy(){this.components.forEach(e=>{e.destroy()})}intersect(e,t,i,r,a,n){this.components.forEach(s=>{s.intersect(e,t,i,r,a,n)})}get boundingBox(){if(!this._boundingBox){const e=Object(x["k"])();this.components.forEach(t=>{Object(r["k"])(t.boundingInfo)&&(Object(x["r"])(e,t.boundingInfo.bbMin),Object(x["r"])(e,t.boundingInfo.bbMax))}),this._boundingBox=e}return this._boundingBox}get boundingSphere(){if(!this._boundingSphere){const e=this.boundingBox,t=Object(u["e"])();Object(x["e"])(e,t),this._boundingSphere={center:t,radius:.5*Object(x["j"])(e)}}return this._boundingSphere}get triangleCount(){return this.components.reduce((e,t)=>e+t.triangleCount,0)}}class Hr{constructor(e,t,i,r){this.type="Lod",this.isGround=!1,this._inverseViewport=Object(Oe["b"])(),this._levels=[],this._defaultRenderInstanceData=[],this._highlightRenderInstanceData=[],this._instanceIndex=0,this._slicePlane=!1,this._enableLevelSelection=!0,this._lastCamera=new pr["a"],this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.canRender=!0,this._symbol=e,this._optionalFields=t,this._metadata=i,this._instanceBufferLayout=N["b"].getInstanceBufferLayout({instancedDoublePrecision:!0,instanced:t}),this._glInstanceBufferLayout=Object(sr["a"])(this._instanceBufferLayout,{divisor:1}),this._instanceData=new _r(this._optionalFields,r),this._instanceData.on("instance-added",()=>{this.requestUpdateCycle()}),this._instanceData.on("instance-removed",()=>{this.requestUpdateCycle()}),this._instanceData.on("instance-transform-changed",e=>{this.requestUpdateCycle(),this._metadata.notifyGraphicGeometryChanged(e.index)}),this._instanceData.on("instance-visibility-changed",e=>{this.requestUpdateCycle(!0),this._metadata.notifyGraphicVisibilityChanged(e.index)}),this._instanceData.on("instance-highlight-changed",()=>{this.requestUpdateCycle(!0)}),this._enableLevelSelection=this._symbol.levels.length>1,Wr.push(this)}destroy(){Wr.splice(Wr.indexOf(this),1)}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlane(){return this._slicePlane}set slicePlane(e){this._slicePlane=e}get intersectionHandlerId(){return this._metadata.layerUid}get instanceData(){return this._instanceData}get memoryUsage(){const e={cpu:0,gpu:0};return this._defaultRenderInstanceData.forEach(t=>{const i=t.memoryUsage;e.cpu+=i.cpu,e.gpu+=i.gpu}),this._highlightRenderInstanceData.forEach(t=>{const i=t.memoryUsage;e.cpu+=i.cpu,e.gpu+=i.gpu}),e}get renderStats(){const e=this._instanceData.size,t=[];return this._levels.forEach((e,i)=>{const r=this._defaultRenderInstanceData[i],a=this._highlightRenderInstanceData[i],n=r.size+a.size,s=e.triangleCount;t.push({renderedInstances:n,renderedTriangles:n*s,trianglesPerInstance:s})}),{totalInstances:e,renderedInstances:t.reduce((e,t)=>e+t.renderedInstances,0),renderedTriangles:t.reduce((e,t)=>e+t.renderedTriangles,0),levels:t}}initializeRenderContext(e){this._context=e;const t=e.renderContext.rctx;this._symbol.levels.forEach(i=>{this._levels.push(new Br(e,i)),this._defaultRenderInstanceData.push(new Lr(t,this._instanceBufferLayout)),this._highlightRenderInstanceData.push(new Lr(t,this._instanceBufferLayout))}),this._levelSelector=Ur(this)}uninitializeRenderContext(){this.invalidateOctree(),this._levels.forEach(e=>{e.destroy()}),this._defaultRenderInstanceData.forEach(e=>{e.destroy()}),this._highlightRenderInstanceData.forEach(e=>{e.destroy()})}get slots(){return[4,6]}get needsHighlight(){return this._highlightRenderInstanceData.reduce((e,t)=>e+t.size,0)>0}prepareRender(e){this.runUpdates(e)}render(e){const t=e.rctx,i=4===e.slot?3:6===e.slot?5:null;if(!i)return;if(!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleInPass(e.pass))return!1;const r=e.camera;this._inverseViewport[0]=1/r.fullViewport[2],this._inverseViewport[1]=1/r.fullViewport[3];const a={slot:i,origin:[0,0,0],camera:r,inverseViewport:this._inverseViewport,shadowMap:e.shadowMap,shadowMappingEnabled:!!e.shadowMap&&e.shadowMap.enabled,ssaoEnabled:!!e.ssaoHelper&&e.ssaoHelper.enabled,screenToWorldRatio:null,screenToWorldRatioGlobalWM:null,slicePlane:e.sliceHelper&&e.sliceHelper.plane,hudVisibilityTexture:e.offscreenRenderingHelper?e.offscreenRenderingHelper.hudVisibilityTexture:null,highlightDepthTexture:e.offscreenRenderingHelper?e.offscreenRenderingHelper.depthTexture:null,hasOccludees:!1,linearDepthTexture:null,linearDepthTextureUnit:0,lastFrameColorTexture:null,lastFrameColorTextureUnit:0,reprojectionMat:null,ssrEnabled:!1,lighting:e.scenelightingData,transparencyPassType:e.transparencyPassType,terrainLinearDepthTexture:e.multipassTerrainParams.terrainLinearDepthTexture,geometryLinearDepthTexture:e.multipassGeometryParams.geometryLinearDepthTexture,multipassTerrainEnabled:e.multipassTerrainParams.multipassTerrainEnabled,cullAboveGround:e.multipassTerrainParams.cullAboveGround,multipassGeometryEnabled:e.multipassGeometryParams.multipassGeometryEnabled};t.bindVAO();const n=5!==e.pass&&7!==e.pass,s=6!==e.pass;return n&&this.renderComponents(e,i,a,this._defaultRenderInstanceData),s&&this.renderComponents(e,i,a,this._highlightRenderInstanceData),!0}intersect(e,t,i,r){if(!this.baseMaterial.isVisible())return;const a=Object(u["e"])();Object(p["k"])(a,r,i);const n=a=>{this._instanceData.getCombinedModelTransform(a,Qr),e.transform.set(Qr),Object(p["n"])(Xr,i,e.transform.inverse),Object(p["n"])(Yr,r,e.transform.inverse);const n=this._instanceData.getState(a),s=this._instanceData.getLodLevel(a);Object(or["a"])(n&rr.ACTIVE,"invalid instance state"),Object(or["a"])(s>=0&&s<this._levels.length,"invaid lod level"),this._levels[s].intersect(e,t,Xr,Yr,a,this._metadata)};this.baseMaterial.params.verticalOffset?this.octree.forEach(n):this.octree.forEachAlongRay(i,a,n)}queryDepthRange(e){return this.queryDepthRangeOctree(e)}notifyShaderTransformationChanged(){this.invalidateOctree()}requestUpdateCycle(e=!1){this._updateCyclesWithStaticCamera=-1,e&&(this._needFullCycle=!0),this.needsUpdates&&this._context.requestRender()}get needsUpdates(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runUpdates(e){if(C["a"].LOD_INSTANCE_RENDERER_DISABLE_UPDATES)return;if(this._enableLevelSelection){const t=e.equals(this._lastCamera);this._lastCamera.copyFrom(e),t||this.requestUpdateCycle()}const t=this._needFullCycle?this._instanceData.size:2e3;this._needFullCycle=!1,this.updateInstances(e,t),this.needsUpdates&&this._context.requestRender()}get octree(){return this._octree||(this._octree=this.buildOctree()),this._octree}invalidateOctree(){this._octree&&(this._octree.destroy(),this._octree=null)}buildOctree(){const e=new Rr(this._instanceData,this.baseBoundingSphere),t=this._instanceData,i=t.view?t.view.state:null;for(let r=0;r<this._instanceData.capacity;++r)i.get(r)&rr.ACTIVE&&e.addInstance(r);return e}queryDepthRangeOctree(e){const t=e.eye,i=e.viewForward,r=this.octree.findClosest(i,"front-to-back",e.frustum),a=this.octree.findClosest(i,"back-to-front",e.frustum);if(null!=r&&null!=a){this._instanceData.view.boundingSphere.getVec(r,$r),Object(p["k"])($r,$r,t);const n=Object(p["i"])($r,i)-$r[3];this._instanceData.view.boundingSphere.getVec(a,$r),Object(p["k"])($r,$r,t);const s=Object(p["i"])($r,i)+$r[3];return{near:Math.max(e.near,n),far:Math.min(e.far,s)}}return{near:1/0,far:-1/0}}startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._defaultRenderInstanceData.forEach(e=>{e.startUpdateCylce()}),this._highlightRenderInstanceData.forEach(e=>{e.startUpdateCylce()}),this.needsUpdates&&this._context.requestRender()}updateInstances(e,t){const i=this._enableLevelSelection,r=this._levelSelector;r.updateCamera(e),this._defaultRenderInstanceData.forEach(e=>{e.beginUpdate()}),this._highlightRenderInstanceData.forEach(e=>{e.beginUpdate()});const a=this._instanceData,n=this._instanceData.view,s=a.size,o=a.capacity;let c=this._instanceIndex;t=Math.min(s,t);for(let l=0;l<t;++l){0===c&&this.startUpdateCycle();const e=n.state.get(c);let s=0;if(!(e&rr.ALLOCATED)){c=(c+1)%o,t++;continue}const l=n.lodLevel.get(c);if(e&rr.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[l].freeTail(),e&rr.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[l].freeTail(),e&rr.REMOVE)a.freeInstance(c);else if(e&rr.VISIBLE){let t=0;i&&(n.modelOrigin.getVec(c,Zr),t=r.selectLevel(Zr,a.getCombinedMedianScaleFactor(c))),s=e&~(rr.ACTIVE|rr.TRANSFORM_CHANGED),t>=0&&(e&rr.HIGHLIGHT?(Nr(this._highlightRenderInstanceData[t],n,c),s|=rr.HIGHLIGHT_ACTIVE):(Nr(this._defaultRenderInstanceData[t],n,c),s|=rr.DEFAULT_ACTIVE)),n.state.set(c,s),n.lodLevel.set(c,t)}else s=e&~(rr.ACTIVE|rr.TRANSFORM_CHANGED),n.state.set(c,s);if(this._octree){const t=!!(e&rr.ACTIVE),i=!!(s&rr.ACTIVE);!t&&i?this._octree.addInstance(c):t&&!i?this._octree.removeInstance(c):t&&i&&e&rr.TRANSFORM_CHANGED&&(this._octree.removeInstance(c),this._octree.addInstance(c))}c=(c+1)%o}this._instanceIndex=c,this._defaultRenderInstanceData.forEach(e=>{e.endUpdate()}),this._highlightRenderInstanceData.forEach(e=>{e.endUpdate()})}renderComponents(e,t,i,r){this.levels.forEach((a,n)=>{a.components.forEach(a=>{this.renderComponent(e,t,i,r[n],a,n)})})}renderComponent(e,t,i,r,a,n){const s=a.glMaterials.get(e.pass);if(!s||!s.beginSlot(t)||0===r.size)return;const o=e.rctx,c=o.capabilities.instancing;s.ensureParameters(i);const l=s.getTechnique(),h=s.getPipelineState(t);o.setPipelineState(h),s.bind(o,i),o.bindVAO(a.vao),l.ensureAttributeLocations(a.vao);const d=l.program;e.isHighlightPass&&mr["a"].bindOutputHighlight(o,d,i),l.bindDraw(i),C["a"].LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&0===e.pass&&(d.setUniform4fv("externalColor",Kr[Math.min(n,Kr.length-1)]),d.setUniform1i("colorMixMode",fr["b"].replace));const u=r.capacity,p=r.headIndex,f=r.tailIndex,m=r.firstIndex,b=this._glInstanceBufferLayout,g=(e,t)=>{Object(lr["a"])(o,nr["a"],r.buffer,b,e),c.drawArraysInstanced(l.primitiveType,0,a.vertexCount,t-e),Object(lr["e"])(o,nr["a"],r.buffer,b)};a.material.params.transparent&&null!=m?p>f?(Object(or["a"])(m>=f&&m<=p,"invalid firstIndex"),g(m,p),g(f,m)):p<f&&(m<=p?(Object(or["a"])(m>=0&&m<=p,"invalid firstIndex"),g(m,p),g(f,u),g(0,m)):(Object(or["a"])(m>=f&&m<=u,"invalid firstIndex"),g(m,u),g(0,p),g(f,m))):p>f?g(f,p):p<f&&(g(0,p),g(f,u)),o.bindVAO(null)}}function Nr(e,t,i){const r=e.allocateHead();qr(t,i,e.view,r)}function qr(e,t,i,r){Object(dr["d"])(e.modelOrigin,t,i.modelOriginHi,i.modelOriginLo,r),i.model.copyFrom(r,e.model,t),i.modelNormal.copyFrom(r,e.modelNormal,t),e.color&&i.color&&i.color.copyFrom(r,e.color,t),e.featureAttribute&&i.featureAttribute&&i.featureAttribute.copyFrom(r,e.featureAttribute,t)}const Wr=[],Zr=Object(u["e"])(),$r=Object(_e["c"])(),Qr=Object(g["b"])(),Xr=Object(u["e"])(),Yr=Object(u["e"])(),Kr=[[1,0,1,1],[0,0,1,1],[0,1,0,1],[1,1,0,1],[1,0,0,1]];class Jr extends M["a"]{constructor(e,t,i,r){super(e,t,i,r),this._resources=null,this._optionalFields=[],this._instanceIndexToGraphicUid=new Map,this.hasLoadedPBRTextures=!1,this.ensureDrapedStatus(!1),this.hasLoadedPBRTextures=i.physicalBasedRenderingEnabled}getCachedSize(){const[e,t,i]=Object(r["k"])(this._resources)?this._resources.symbolSize:[1,1,1];return{width:e,depth:t,height:i}}async doLoad(e){if(!this._drivenProperties.size&&Object(T["k"])(this.symbolLayer))throw new Error;const t=this.symbolLayer;if(this.isPrimitive){const e=t.resource?t.resource.primitive:zi["b"];this._resources=this._createResourcesForPrimitive(e)}else this._resources=await this._createResourcesForUrl(t.resource.href,e);this.complexity=this.computeComplexity()}get extentPadding(){return Object(r["k"])(this._resources)?this._resources.extentPadding:0}get isPrimitive(){return!(this.symbolLayer.resource&&this.symbolLayer.resource.href)}get lodRenderer(){return Object(r["i"])(this._resources,"lodRenderer")}setMaterialTransparencyParams(e,t=Object(r["i"])(this.symbolLayer,"material","color")){const i=this._getCombinedOpacity(t),a=i<1||this.needsDrivenTransparentPass;return e.transparent=a,e.opacity=i,e}_createResourcesForPrimitive(e){if(!Object(Ui["a"])(e))throw new Error("Unknown object symbol primitive: "+e);const t=this.symbolLayer,i=Object(x["h"])(Object(Bi["a"])(e)),a=Object(u["f"])(Object(x["F"])(i)),n=Object(u["f"])(Object(Bi["b"])(a,t)),s=Object(p["q"])(n),o=!1,c=!1,l={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,instanced:["transformation"],ambient:u["a"],diffuse:u["a"],slicePlaneEnabled:this._context.slicePlaneEnabled,sliceHighlightDisabled:!0,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!this.symbolLayer.isPrimitive},h=l.usePBR;this.setMaterialTransparencyParams(l);const d=this.symbol;if("point-3d"===d.type&&d.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:i}=d.verticalOffset;l.verticalOffset={screenLength:Object(ge["h"])(e),minWorldLength:t||0,maxWorldLength:null!=i?i:1/0},l.castShadows=!1}if(this._context.screenSizePerspectiveEnabled&&(l.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),this._drivenProperties.color)l.externalColor=_e["a"];else{const e=Object(r["k"])(t.material)&&t.material.color,i=Object(r["k"])(e)?me["a"].toUnitRGBA(e):_e["a"];l.externalColor=i}this._fastUpdates=it(this._context.renderer,this._fastVisualVariableConvertOptions(i,n,a,r["p"])),this._fastUpdates.enabled?(Object.assign(l,this._fastUpdates.materialParameters),l.instanced.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(l.instanced.push("color"),this._optionalFields.push("color"));const f=new N["b"](l),m=Object(Ui["b"])(e,f);if(!m)throw new Error("Unknown object symbol primitive: "+e);const b=Object(Gi["d"])(m).map(e=>({opacity:1,transparent:e.params.transparent})),g=this._createStageResources(m,h);return{lodResources:m,lodRenderer:this._createLodRenderer(m),stageResources:g,symbolSize:n,extentPadding:s,isEsriSymbolResource:o,isWosr:c,originalMaterialParameters:b,physicalBasedRenderingEnabled:h,resourceBoundingBox:i,resourceSize:a,dispose:r["p"],pivotOffset:r["p"]}}async _createResourcesForUrl(e,t){const i=["transformation"],a={materialParamsMixin:{instanced:i,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache};this._fastUpdates=it(this._context.renderer,this._fastVisualVariableConvertOptions(r["p"],r["p"],r["p"],r["p"])),this._fastUpdates.enabled?(Object.assign(a.materialParamsMixin,this._fastUpdates.materialParameters),i.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(i.push("color"),this._optionalFields.push("color"));const n=this.symbol;if("point-3d"===n.type&&n.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:i}=n.verticalOffset;a.materialParamsMixin.verticalOffset={screenLength:Object(ge["h"])(e),minWorldLength:t||0,maxWorldLength:null!=i?i:1/0},a.materialParamsMixin.castShadows=!1}a.signal=t,a.usePBR=this._context.physicalBasedRenderingEnabled;const s=a.usePBR,o=await Object(ar["fetch"])(e,a),c=o.isEsriSymbolResource,l=o.isWosr,h=o.remove,d=Ji(o.lods);tr(d),d.levels.sort((e,t)=>e.minScreenSpaceRadius-t.minScreenSpaceRadius),d.levels[0].minScreenSpaceRadius=Math.min(2,d.levels[0].minScreenSpaceRadius);const f=this._context,m=this.symbolLayer.material,b=this._getExternalColorParameters(m),g=Object(r["i"])(this.symbolLayer,"material","color"),v=this._getCombinedOpacity(g,{hasIntrinsicColor:!0}),y=this.needsDrivenTransparentPass,O=Object(Gi["d"])(d),_=Object(Gi["d"])(d).map(e=>{const t=e.params;return{opacity:t.opacity||1,transparent:t.transparent}});O.forEach(e=>{const t=e.params;e.setParameterValues(b);const i=t.opacity*v,r=i<1||y||t.transparent;e.setParameterValues({opacity:i,transparent:r}),f.screenSizePerspectiveEnabled&&e.setParameterValues({screenSizePerspective:f.sharedResources.screenSizePerspectiveSettings})});const j=o.referenceBoundingBox,w=Object(u["f"])(Object(x["F"])(j)),S=Object(u["f"])(d.levels[0].pivotOffset),C=Object(u["f"])(Object(Bi["b"])(w,this.symbolLayer)),T=Object(p["q"])(C);rt(this._fastUpdates,this._context.renderer,this._fastVisualVariableConvertOptions(j,C,w,S))&&O.forEach(e=>e.setParameterValues(this._fastUpdates.materialParameters));const P=this._createStageResources(d,s);return{lodResources:d,lodRenderer:this._createLodRenderer(d),stageResources:P,symbolSize:C,extentPadding:T,isEsriSymbolResource:c,isWosr:l,originalMaterialParameters:_,physicalBasedRenderingEnabled:s,resourceBoundingBox:j,resourceSize:w,dispose:h,pivotOffset:S}}_createStageResources(e,t){const i=this._context.stage,r=Object(Gi["d"])(e);t!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged(),i.addMany(r);const a=Object(Gi["e"])(e);i.addMany(a);const n=Object(Gi["c"])(e);return i.addMany(n),{materials:r,textures:a,geometries:n}}_createLodRenderer(e){const t=this._context.stage,i={layerUid:this._context.layer.uid,graphicUid:e=>this._instanceIndexToGraphicUid.get(e),notifyGraphicGeometryChanged:e=>this._context.notifyGraphicGeometryChanged(this._instanceIndexToGraphicUid.get(e)),notifyGraphicVisibilityChanged:e=>this._context.notifyGraphicVisibilityChanged(this._instanceIndexToGraphicUid.get(e))},r=this._fastUpdates.enabled?{applyTransform:(e,t,i)=>{e.getFeatureAttribute(t,ra),Object(f["c"])(i,ot(this._fastUpdates.materialParameters,ra,i))},scaleFactor:(e,t,i)=>(t.getFeatureAttribute(i,ra),ct(e,this._fastUpdates.materialParameters,ra))}:null,a=new Hr(e,this._optionalFields,i,r);return a.slicePlane=this._context.slicePlaneEnabled,t.addRenderPlugin(a.slots,a),a}_getExternalColorParameters(e){const t={};return this._drivenProperties.color?t.externalColor=_e["a"]:Object(r["k"])(e)&&Object(r["k"])(e.color)?t.externalColor=me["a"].toUnitRGBA(e.color):(t.externalColor=_e["a"],t.colorMixMode="ignore"),t}destroy(){super.destroy();const e=this._context.stage;if(Object(r["k"])(this._resources)){e.removeRenderPlugin(this._resources.lodRenderer),this._resources.lodRenderer.destroy();const t=this._resources.stageResources;e.removeMany(t.materials),e.removeMany(t.textures),e.removeMany(t.geometries),Object(r["k"])(this._resources.dispose)&&this._resources.dispose()}this._resources=null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry))return null;const i=Object(Ce["d"])(t.geometry);if(Object(r["j"])(i))return this.logger.warn("unsupported geometry type for icon symbol: "+t.geometry.type),null;const a=this.setGraphicElevationContext(t,new A["a"]),n=e.renderingInfo;return this._createAs3DShape(t,i,n,a,t.uid)}notifyDestroyGraphicLayer(e){this._instanceIndexToGraphicUid.delete(e.instanceIndex)}graphicLayerToGraphicId(){return 0}layerOpacityChanged(){if(Object(r["j"])(this._resources))return!0;const e=this._drivenProperties.opacity,t=!this.isPrimitive,i=this._resources.stageResources.materials,a=this._resources.originalMaterialParameters;for(let n=0;n<i.length;n++){const s=i[n],o=Object(r["i"])(this.symbolLayer,"material","color"),c=a[n],l=this._getCombinedOpacity(o,{hasIntrinsicColor:t})*c.opacity;s.setParameterValues({opacity:l,transparent:l<1||e||c.transparent})}return!0}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,P["g"])}slicePlaneEnabledChanged(){if(Object(r["j"])(this._resources))return!0;this._resources.lodRenderer.slicePlane=this._context.slicePlaneEnabled;for(const e of this._resources.stageResources.materials)e.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0}physicalBasedRenderingChanged(){if(Object(r["j"])(this._resources))return!0;const{stageResources:e,isWosr:t}=this._resources;for(const i of e.materials)this.isPrimitive?i.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):t||i.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return!1!==this.hasLoadedPBRTextures||!0!==this._context.physicalBasedRenderingEnabled||(this.hasLoadedPBRTextures=!0,!1)}pixelRatioChanged(){return!0}applyRendererDiff(e,t){if(Object(r["j"])(this._resources))return!0;const{stageResources:{materials:i},lodRenderer:a,resourceBoundingBox:n,symbolSize:s,resourceSize:o,pivotOffset:c}=this._resources;for(const r in e.diff)switch(r){case"visualVariables":if(!rt(this._fastUpdates,t,this._fastVisualVariableConvertOptions(n,s,o,c)))return!1;for(const e of i)e.setParameterValues(this._fastUpdates.materialParameters);a.notifyShaderTransformationChanged();break;default:return!1}return!0}computeComplexity(){return Object(r["j"])(this._resources)?super.computeComplexity():{primitivesPerFeature:Object(Gi["b"])(this._resources.lodResources.levels[0]).reduce((e,t)=>e+t.indices.get("position").length,0)/3,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:Object(c["d"])(this.symbol,this.symbolLayer)}}hasLodRenderer(){return Object(r["k"])(this._resources)}_createAs3DShape(e,t,i,a,n){if(!this.hasLodRenderer()||Object(r["j"])(this._resources))return null;const s=this.getFastUpdateAttrValues(e),o=!this._fastUpdates.enabled&&this._hasPerInstanceColor()?Object(T["g"])(i.color,i.opacity):null,c=this._context.clippingExtent;if(Object(m["t"])(t,ea,this._context.elevationProvider.spatialReference),Object(r["k"])(c)&&!Object(x["g"])(c,ea))return null;const l=this._requiresTerrainElevation(a),h=this._computeGlobalTransform(t,a,ia,l?aa:null),d=this._computeLocalTransform(this._resources,this.symbolLayer,i,ta),u=this._resources.lodRenderer.instanceData,p=u.addInstance();this._instanceIndexToGraphicUid.set(p,n),u.setLocalTransform(p,d,!1),u.setGlobalTransform(p,h),s&&u.setFeatureAttribute(p,s),o&&u.setColor(p,o);const f=new Yi(this,p,Se["a"],a);return l&&(f.alignedSampledElevation=aa.sampledElevation),f.needsElevationUpdates=Object(P["g"])(a.mode),Object(Ce["b"])(f,t,this._context.elevationProvider),f}_computeGlobalTransform(e,t,i,r){const a=Object(P["e"])(e,this._context.elevationProvider,t,this._context.renderCoordsHelper,r);return ea[0]=e.x,ea[1]=e.y,ea[2]=a,Object(m["d"])(e.spatialReference,ea,i,this._context.renderCoordsHelper.spatialReference),i}_computeLocalTransform(e,t,i,r){return Object(f["i"])(r),this._applyObjectRotation(i,!1,r),this._applyObjectRotation(t,!0,r),this._applyObjectScale(e,i,r),this._applyAnchor(e,t,r),r}_applyObjectScale(e,t,i){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const r=this._drivenProperties.size&&t.size?t.size:e.symbolSize,a=Object(T["c"])(r,e.symbolSize,e.resourceSize,this._context.renderCoordsHelper.unitInMeters);1===a[0]&&1===a[1]&&1===a[2]||Object(f["s"])(i,i,a)}prepareSymbolLayerPatch(e){if("partial"!==e.diff.type)return;const t=e.diff.diff;this._preparePatchTransform(e,t),this._preparePatchColor(e,t)}updateGeometry(e,t){if(Object(r["j"])(this._resources))return!0;const i=t&&Object(Ce["d"])(t);if(Object(r["j"])(i))return!1;const a=this.getGeometryElevationMode(t);if(e.elevationContext.mode!==a)return!1;const n=this._requiresTerrainElevation(e.elevationContext);return this._computeGlobalTransform(i,e.elevationContext,ia,n?aa:null),n&&(e.alignedSampledElevation=aa.sampledElevation),this._resources.lodRenderer.instanceData.setGlobalTransform(e.instanceIndex,ia,!0),Object(Ce["b"])(e,i,this._context.elevationProvider),!0}_preparePatchTransform(e,t){if(!(t.heading||t.tilt||t.roll||t.width||t.height||t.depth||t.anchor||t.anchorPosition))return;if(Object(r["j"])(this._resources))return;const i=(e,t,i)=>Object(r["u"])(null!=e&&"complete"===e.type?e.newValue:t,i),a=i(t.heading,this.symbolLayer.heading,0),n=i(t.tilt,this.symbolLayer.tilt,0),s=i(t.roll,this.symbolLayer.roll,0),o=i(t.width,this.symbolLayer.width,void 0),c=i(t.height,this.symbolLayer.height,void 0),l=i(t.depth,this.symbolLayer.depth,void 0),h=i(t.anchor,this.symbolLayer.anchor,void 0),d=i(t.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete t.heading,delete t.tilt,delete t.roll,delete t.width,delete t.height,delete t.depth,delete t.anchor,delete t.anchorPosition;const p={heading:a,tilt:n,roll:s,anchor:h,anchorPosition:d},f=this._resources;1===this.loadStatus&&e.symbolLayerStatePatches.push(()=>{f.symbolSize=Object(u["f"])(Object(Bi["b"])(f.resourceSize,{width:o,height:c,depth:l,isPrimitive:this.symbolLayer.isPrimitive}))}),e.graphics3DGraphicPatches.push((e,t)=>{const i=this._computeLocalTransform(f,p,t,ta),r=e.instanceIndex;f.lodRenderer.instanceData.setLocalTransform(r,i,!0)})}_preparePatchColor(e,t){if(!t.material||"partial"!==t.material.type)return;const i=t.material.diff;if(!i.color||"complete"!==i.color.type||null==i.color.newValue||null==i.color.oldValue)return;const a=i.color.newValue,n=Object(r["k"])(a)?me["a"].toUnitRGBA(a):_e["a"];delete i.color;const s=this._resources;Object(r["j"])(s)||e.graphics3DGraphicPatches.push(e=>{let t;this._hasPerInstanceColor()?(s.lodRenderer.instanceData.setColor(e.instanceIndex,n),t=this.setMaterialTransparencyParams({},a)):t=this.setMaterialTransparencyParams({externalColor:n},a);for(const i of s.stageResources.materials)i.setParameterValues(t)})}_requiresTerrainElevation(e){return"absolute-height"!==e.mode}_applyObjectRotation(e,t,i){if(!(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation&&t))return Object(T["b"])(e.heading,e.tilt,e.roll,i)}_computeAnchor(e,t,i){const a=Object(u["e"])();switch(i.anchor){case"center":Object(p["l"])(a,Object(x["e"])(e)),Object(p["u"])(a,a);break;case"top":{const t=Object(x["e"])(e);Object(p["x"])(a,-t[0],-t[1],-e[5]);break}case"bottom":{const t=Object(x["e"])(e);Object(p["x"])(a,-t[0],-t[1],-e[2]);break}case"relative":{const t=Object(x["e"])(e),r=Object(x["F"])(e),n=i.anchorPosition,s=n?Object(u["g"])(n.x,n.y,n.z):u["b"];Object(p["b"])(a,r,s),Object(p["g"])(a,a,t),Object(p["u"])(a,a);break}case"origin":default:Object(r["k"])(t)?Object(p["u"])(a,t):Object(p["l"])(a,u["b"])}return a}_applyAnchor(e,t,i){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const r=this._computeAnchor(e.resourceBoundingBox,e.pivotOffset,t);r&&Object(f["t"])(i,i,r)}_hasPerInstanceColor(){return this._drivenProperties.color||this._drivenProperties.opacity}_fastVisualVariableConvertOptions(e,t,i,a){const n=Object(r["k"])(e)?Object(u["f"])(Object(x["F"])(e)):u["a"],s=Object(r["k"])(e)?this._computeAnchor(e,a,this.symbolLayer):u["b"],o=this._context.renderCoordsHelper.unitInMeters,c=Object(T["c"])(Object(r["k"])(t)?t:void 0,t,i,o),l=Object(u["g"])(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return{modelSize:n,symbolSize:Object(r["k"])(t)?t:u["a"],unitInMeters:o,transformation:{anchor:s,scale:c,rotation:l}}}}const ea=Object(u["e"])(),ta=Object(g["b"])(),ia=Object(g["b"])(),ra=Object(_e["c"])(),aa={verticalDistanceToGround:0,sampledElevation:0};var na=i("3349"),sa=i("1a54"),oa=i("47f8"),ca=i("4212");function la(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function ha(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e}function da(e,t,i,r,a){return e[0]=t,e[1]=i,e[2]=r,e[3]=a,e}function ua(e,t){if(e===t){const i=t[1];e[1]=t[2],e[2]=i}else e[0]=t[0],e[1]=t[2],e[2]=t[1],e[3]=t[3];return e}function pa(e,t){const i=t[0],r=t[1],a=t[2],n=t[3];let s=i*n-a*r;return s?(s=1/s,e[0]=n*s,e[1]=-r*s,e[2]=-a*s,e[3]=i*s,e):null}function fa(e,t){const i=t[0];return e[0]=t[3],e[1]=-t[1],e[2]=-t[2],e[3]=i,e}function ma(e){return e[0]*e[3]-e[2]*e[1]}function ba(e,t,i){const r=t[0],a=t[1],n=t[2],s=t[3],o=i[0],c=i[1],l=i[2],h=i[3];return e[0]=r*o+n*c,e[1]=a*o+s*c,e[2]=r*l+n*h,e[3]=a*l+s*h,e}function ga(e,t,i){const r=t[0],a=t[1],n=t[2],s=t[3],o=Math.sin(i),c=Math.cos(i);return e[0]=r*c+n*o,e[1]=a*c+s*o,e[2]=r*-o+n*c,e[3]=a*-o+s*c,e}function va(e,t,i){const r=t[0],a=t[1],n=t[2],s=t[3],o=i[0],c=i[1];return e[0]=r*o,e[1]=a*o,e[2]=n*c,e[3]=s*c,e}function ya(e,t){const i=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=i,e[2]=-i,e[3]=r,e}function Oa(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e}function _a(e){return"mat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"}function xa(e){return Math.sqrt(e[0]**2+e[1]**2+e[2]**2+e[3]**2)}function ja(e,t,i,r){return e[2]=r[2]/r[0],i[0]=r[0],i[1]=r[1],i[3]=r[3]-e[2]*i[1],[e,t,i]}function wa(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e}function Sa(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e}function Ca(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]}function Ta(e,t){const i=e[0],r=e[1],a=e[2],n=e[3],s=t[0],o=t[1],c=t[2],l=t[3];return Math.abs(i-s)<=ca["a"]*Math.max(1,Math.abs(i),Math.abs(s))&&Math.abs(r-o)<=ca["a"]*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(a-c)<=ca["a"]*Math.max(1,Math.abs(a),Math.abs(c))&&Math.abs(n-l)<=ca["a"]*Math.max(1,Math.abs(n),Math.abs(l))}function Pa(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e}function Aa(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e[2]=t[2]+i[2]*r,e[3]=t[3]+i[3]*r,e}const Ra=ba,Ma=Sa;Object.freeze({__proto__:null,copy:la,identity:ha,set:da,transpose:ua,invert:pa,adjoint:fa,determinant:ma,multiply:ba,rotate:ga,scale:va,fromRotation:ya,fromScaling:Oa,str:_a,frob:xa,LDU:ja,add:wa,subtract:Sa,exactEquals:Ca,equals:Ta,multiplyScalar:Pa,multiplyScalarAndAdd:Aa,mul:Ra,sub:Ma});class Ea extends w["a"]{constructor(e,t,i,r,a,n){super(e,t),this.path=i,this.geometrySR=r,this.upVectorAlignment=a,this.stencilWidth=n}}function Da(e){return"upVectorAlignment"in e}function Ia(){return[1,0,0,1]}function La(e){return[e[0],e[1],e[2],e[3]]}function Va(e,t,i,r){return[e,t,i,r]}function ka(e,t){return new Float64Array(e,t,4)}Object.freeze({__proto__:null,create:Ia,clone:La,fromValues:Va,createView:ka});function Fa(){return{up:Object(u["e"])(),right:Object(u["e"])()}}function za(e,t,i){Object(p["n"])(e.up,t.up,i),Object(p["n"])(e.right,t.right,i)}function Ua(e,t,i){Object(na["s"])(e,Object(p["i"])(i,t.right),Object(p["i"])(i,t.up))}class Ga{constructor(){this.pos=Object(u["e"])(),this.posES=Object(u["e"])(),this.posGS=Object(u["e"])(),this.vRight=Object(u["e"])(),this.vLeft=Object(u["e"])(),this.frame=Fa(),this.rotationFrame=Fa(),this.rotationRight=Object(Oe["b"])(),this.rotationAngle=0,this.miterStretch=Ia()}setFrameFromUpVector(e){Object(p["l"])(this.frame.up,e),Object(p["g"])(cn,this.vLeft,this.vRight),Object(p["s"])(cn,cn),Object(p["f"])(on,this.frame.up,Object(p["i"])(cn,this.frame.up)),Object(p["k"])(dn,cn,on),Object(p["s"])(dn,dn),Object(p["h"])(this.frame.right,dn,this.frame.up)}computeRotationAxisAndAngleFromUpVector(){Object(p["l"])(this.rotationFrame.up,this.frame.up),Object(p["l"])(this.rotationFrame.right,this.frame.right),Object(na["s"])(this.rotationRight,1,0),Object(p["f"])(on,this.frame.up,Object(p["i"])(this.frame.up,this.vLeft)),Object(p["k"])(on,this.vLeft,on),Object(p["u"])(on,on),Object(p["s"])(on,on),Object(p["f"])(cn,this.frame.up,Object(p["i"])(this.frame.up,this.vRight)),Object(p["k"])(cn,this.vRight,cn),Object(p["s"])(cn,cn),Object(p["h"])(ln,this.rotationFrame.up,this.vLeft);const e=Object(ke["s"])(Object(p["i"])(ln,this.vRight));if(this.rotationAngle=e*(Math.PI-Object(ke["b"])(Object(p["i"])(on,cn))),Math.abs(this.rotationAngle)>0){const e=Object(ke["r"])(Math.cos(.5*this.rotationAngle));da(this.miterStretch,e-1+1,0,0,1)}const t=Math.PI-this.rotationAngle;this.maxStretchDistance=Math.abs(Math.min(this.vLeftLength,this.vRightLength)/Math.cos(.5*t))}}class Ba{constructor(){this.vertices=[],this.vertexIndices=[],this.vertexNormals=[],this.poles=[],this.poleIndices=[],this.uvs=null,this.uvIndices=null}addVertex(e,t){return this.vertices.push(Object(Oe["c"])(e)),this.vertexNormals.push(Object(Oe["c"])(t)),this.vertices.length-1}addUV(e){return this.uvs||(this.uvs=[],this.uvIndices=[]),this.uvs.push(e),this.uvs.length-1}addPole(e,t=null){return this.poles.push({position:Object(Oe["c"])(e),normal:t?Object(Oe["c"])(t):null}),this.poles.length-1}addSegment(e,t=null,i=null){this.vertexIndices.push(e.v0),this.vertexIndices.push(e.v1),t&&(this.uvIndices.push(t.v0),this.uvIndices.push(t.v1)),i&&(this.poleIndices.push(i.v0),this.poleIndices.push(i.v1))}get numSegments(){return this.vertexIndices.length/2}hasUV(){return null!=this.uvs}translate(e,t){for(const i of this.vertices)i[0]+=e,i[1]+=t;for(const i of this.poles)i.position[0]+=e,i.position[1]+=t}static circle(e=20){const t=.5,i=new Ba,r={v0:0,v1:0};i.addPole(Object(Oe["f"])(0,0));for(let s=0;s<e;++s){const r=2*s*Math.PI/e,a=Math.cos(r),n=Math.sin(r),o=Object(Oe["f"])(a*t,n*t),c=Object(Oe["f"])(a,n);i.addVertex(o,c),i.addUV(s/e)}i.addUV(1);for(let s=0;s<e-1;++s){const e={v0:s,v1:s+1},t=e;i.addSegment(e,t,r)}const a={v0:e-1,v1:0},n={v0:e-1,v1:e};return i.addSegment(a,n,r),i}static rect(){const e=1,t=1,i=new Ba,r=Object(Oe["f"])(.5*-e,.5*-t),a=Object(Oe["f"])(.5*e,.5*-t),n=Object(Oe["f"])(.5*e,.5*t),s=Object(Oe["f"])(.5*-e,.5*t),o=Object(Oe["f"])(0,-1),c=Object(Oe["f"])(1,0),l=Object(Oe["f"])(0,1),h=Object(Oe["f"])(-1,0);i.addUV(0),i.addUV(1),i.addPole(Object(Oe["f"])(0,.5*t),l),i.addPole(Object(Oe["f"])(0,.5*t)),i.addPole(Object(Oe["f"])(0,.5*-t)),i.addPole(Object(Oe["f"])(0,.5*-t),o);const d={v0:0,v1:1};return i.addVertex(r,o),i.addVertex(a,o),i.addSegment({v0:0,v1:1},d,{v0:3,v1:3}),i.addVertex(a,c),i.addVertex(n,c),i.addSegment({v0:2,v1:3},d,{v0:2,v1:1}),i.addVertex(n,l),i.addVertex(s,l),i.addSegment({v0:4,v1:5},d,{v0:0,v1:0}),i.addVertex(s,h),i.addVertex(r,h),i.addSegment({v0:6,v1:7},d,{v0:1,v1:2}),i}}class Ha{constructor(e){this.vertices=[],this.offset=Object(u["e"])(),this.xform=Object(g["b"])(),this.vertices=e;const t=Math.floor((e.length-1)/2);Object(p["l"])(this.offset,this.vertices[t].pos);for(const i of this.vertices)Object(p["k"])(i.pos,i.pos,this.offset);Object(f["t"])(this.xform,this.xform,this.offset),this.updatePathVertexInformation()}updatePathVertexInformation(){const e=this.vertices.length;let t=this.vertices[0];t.index=0,Object(p["x"])(t.vLeft,0,0,0),t.vLeftLength=0,Object(p["k"])(t.vRight,this.vertices[1].pos,t.pos),t.vRightLength=Object(p["q"])(t.vRight),Object(p["s"])(t.vRight,t.vRight);let i=t;for(let r=1;r<e;++r)t=this.vertices[r],t.index=r,Object(p["l"])(t.vLeft,i.vRight),t.vLeftLength=i.vRightLength,r<e-1?(Object(p["k"])(t.vRight,this.vertices[r+1].pos,t.pos),t.vRightLength=Object(p["q"])(t.vRight),Object(p["s"])(t.vRight,t.vRight)):(Object(p["l"])(t.vRight,t.vLeft),t.vRightLength=t.vLeftLength),i=t}}function Na(e,t){let i=null;const r=e.vertices.length,a=.99619469809,n=Object(u["e"])(),s=Object(u["e"])(),o=Object(u["e"])(),c=Object(u["e"])(),l=Object(u["e"])(),h=Object(u["e"])(),d=Pr["f"].create();let f=e.vertices[0];Object(p["l"])(s,t),Object(p["x"])(n,0,1,0),je["a"].makeOrthoBasisDirUpFallback(f.vRight,s,n,n,o,s,a),Object(p["l"])(f.frame.up,s),Object(p["l"])(f.frame.right,o),i=f;for(let u=1;u<r;++u){f=e.vertices[u],Object(p["g"])(l,f.vLeft,f.vRight);let t=Object(p["q"])(l);t>0?(t=1/Math.sqrt(t),l[0]=l[0]*t,l[1]=l[1]*t,l[2]=l[2]*t):(l[0]=f.vRight[0],l[1]=f.vRight[1],l[2]=f.vRight[2]),Object(p["g"])(h,i.pos,i.frame.up),Pr["f"].fromPositionAndNormal(f.pos,l,d),Pr["f"].intersectRay(d,Pr["g"].wrap(h,f.vLeft),c)?(Object(p["k"])(c,c,f.pos),Object(p["s"])(s,c),Object(p["h"])(o,l,s),Object(p["s"])(o,o)):je["a"].makeOrthoBasisDirUpFallback(l,i.frame.up,i.frame.right,n,o,s,a),Object(p["l"])(f.frame.up,s),Object(p["l"])(f.frame.right,o),i=f}}class qa{numProfilesPerJoin(){return 1}extrude(e,t,i){for(let r=0;r<t.vertices.length;++r)i(e.index,e.frame,t.vertices[r],t.vertexNormals[r],!1)}}class Wa{constructor(e=.8*Math.PI,t=1){this.cutoffAngle=e,this.numBendSubdivisions=t}numProfilesPerJoin(){return this.numBendSubdivisions+1}extrude(e,t,i){const r=un;if(Math.abs(e.rotationAngle)>=this.cutoffAngle)for(let a=0;a<this.numBendSubdivisions+1;++a){Object(f["i"])(pn),Object(f["r"])(pn,pn,.5*-e.rotationAngle+a*e.rotationAngle/this.numBendSubdivisions,e.rotationFrame.up),za(r,e.frame,pn);for(let a=0;a<t.vertices.length;++a)Object(na["g"])(t.vertices[a],e.rotationRight)*e.rotationAngle>=0?i(e.index,r,t.vertices[a],t.vertexNormals[a],!1):(Object(na["o"])(an,t.vertices[a],e.miterStretch),i(e.index,e.frame,an,t.vertexNormals[a],!0))}else for(let a=0;a<this.numBendSubdivisions+1;++a)for(let r=0;r<t.vertices.length;++r){const a=Object(na["g"])(t.vertices[r],e.rotationRight)*e.rotationAngle>=0;Object(na["o"])(an,t.vertices[r],e.miterStretch),i(e.index,e.frame,an,t.vertexNormals[r],!a)}}}const Za={generateUV:!1};class $a{rebuildConnectingProfileGeometry(e,t,i){for(let r=0;r<t.vertices.length;++r)i(e.index,e.frame,t.vertices[r],t.vertexNormals[r],0,0)}}class Qa extends $a{constructor(){super()}getNumVertices(){return 0}getNumIndices(){return 0}rebuildCapGeometry(){}buildTopology(){}}class Xa extends $a{constructor(e,t=0,i=!1){super(),this.profile=e,this.profilePlaneOffset=t,this.flip=i}getNumVertices(){return this.profile.vertices.length}getNumIndices(){return 3*this.profile.numSegments}rebuildConnectingProfileGeometry(e,t,i){for(let r=0;r<t.vertices.length;++r)i(e.index,e.frame,t.vertices[r],t.vertexNormals[r],this.profilePlaneOffset,0)}rebuildCapGeometry(e,t){const i=nn;Object(na["s"])(i,0,0);const r=this.flip?1:-1;for(let a=0;a<this.profile.vertices.length;++a)t(e.index,e.frame,this.profile.vertices[a],i,this.profilePlaneOffset,r)}buildTopology(e,t){const i=this.vertexBufferStart+this.profile.vertexIndices[0];for(let r=1;r<this.profile.numSegments;++r){const e=this.profile.vertexIndices[2*r+0],a=this.profile.vertexIndices[2*r+1],n=this.vertexBufferStart+e,s=this.vertexBufferStart+a;this.flip?t(s,n,i):t(i,n,s)}}}class Ya extends $a{constructor(e){super(),this.flip=!1,this.sign=0,this.breakNormals=!1,this.numSegments=3,this.profile=e.profile,this.flip=e.flip,this.sign=this.flip?1:-1,this.breakNormals=e.breakNormals,this.numSegments=e.subdivisions}getNumVertices(){let e=0;return e=this.profile.vertices.length*(this.numSegments-1),this.breakNormals&&(e+=this.profile.vertices.length),e+=this.profile.poles.length,e}getNumIndices(){let e=0;e+=2*this.profile.numSegments*(this.numSegments-1);for(let t=0;t<this.profile.numSegments;++t){const i=this.profile.vertexIndices[2*t+0],r=this.profile.vertexIndices[2*t+1];this.profile.poleIndices[i]===this.profile.poleIndices[r]?e+=1:e+=2}return 3*e}rebuildCapGeometry(e,t){const i=e.frame,r=.5*this.sign,a=an,n=nn;Object(na["s"])(n,0,0);for(let s=0;s<this.profile.poles.length;++s){const a=this.profile.poles[s];a.normal?t(e.index,i,a.position,a.normal,r,0):t(e.index,i,a.position,n,r,this.sign)}if(this.breakNormals)for(let s=0;s<this.profile.vertices.length;++s)t(e.index,i,this.profile.vertices[s],this.profile.vertexNormals[s],0,0);for(let s=0;s<this.numSegments-1;++s){const o=(1-(s+1)/this.numSegments)*Math.PI*.5,c=Math.sin(o),l=Math.cos(o);for(let s=0;s<this.profile.vertices.length;++s){const o=this.profile.poles[this.profile.poleIndices[s]];Object(na["d"])(a,this.profile.vertices[s],o.position),Object(na["a"])(a,a,c),o.normal?(Object(na["h"])(a,a,o.position),t(e.index,i,a,o.normal,r*l,0)):(Object(na["e"])(n,a),Object(na["a"])(n,n,c),Object(na["h"])(a,a,o.position),t(e.index,i,a,n,r*l,this.sign*l))}}}buildTopology(e,t){const i=this.breakNormals?this.vertexBufferStart+this.profile.poles.length:this.firstProfileVertexIndex,r=this.breakNormals?this.vertexBufferStart+this.profile.poles.length+this.profile.vertices.length:this.vertexBufferStart+this.profile.poles.length;for(let a=0;a<this.profile.numSegments;++a){const e=this.profile.vertexIndices[2*a+0],n=this.profile.vertexIndices[2*a+1],s=this.vertexBufferStart+this.profile.poleIndices[e],o=this.vertexBufferStart+this.profile.poleIndices[n];let c=i+e,l=i+n;for(let i=0;i<this.numSegments-1;++i){const a=r+i*this.profile.vertices.length+e,s=r+i*this.profile.vertices.length+n;this.flip?(t(a,l,c),t(l,a,s)):(t(c,l,a),t(s,a,l)),c=a,l=s}this.flip?(t(s,l,c),s!==o&&t(s,o,l)):(t(c,l,s),s!==o&&t(l,o,s))}}}class Ka{constructor(e,t,i,r,a,n=Za){this.options=n,this._extrusionVertexCount=0,this._triangleCount=0,this.numExtrusionProfiles=0,this.numVerticesTotal=0,this.numNormalsTotal=0,this.numUVTotal=0,this.profile=t,this.path=e,this.extruder=i,this.startCap=r,this.endCap=a;const s=this.path.vertices.length-2;this.numExtrusionProfiles=i.numProfilesPerJoin()*s+2,this.numVerticesTotal=t.vertices.length*this.numExtrusionProfiles,this.numNormalsTotal=this.numVerticesTotal,this.startCap.vertexBufferStart=this.numVerticesTotal;const o=this.startCap.getNumVertices();this.numVerticesTotal+=o,this.numNormalsTotal+=o,this.endCap.vertexBufferStart=this.numVerticesTotal;const c=this.endCap.getNumVertices();this.numVerticesTotal+=c,this.numNormalsTotal+=c,this.pathVertexData=new Float32Array(1*this.numVerticesTotal),this.profileRightAxisData=new Float32Array(4*this.numVerticesTotal),this.profileUpAxisData=new Float32Array(4*this.numVerticesTotal),this.profileVertexAndNormalData=new Float32Array(4*this.numVerticesTotal),this.profile.hasUV()&&this.options.generateUV&&(this.numUVTotal=this.profile.uvs.length,this.uvData=new Float32Array(2*this.numUVTotal)),this.originData=new Float32Array(3*this.path.vertices.length),this.rebuildGeometry(),this.buildTopology()}emitVertex(e,t,i,r,a){if(this.profileRightAxisData[4*this._extrusionVertexCount+0]=t.right[0],this.profileRightAxisData[4*this._extrusionVertexCount+1]=t.right[1],this.profileRightAxisData[4*this._extrusionVertexCount+2]=t.right[2],this.profileUpAxisData[4*this._extrusionVertexCount+0]=t.up[0],this.profileUpAxisData[4*this._extrusionVertexCount+1]=t.up[1],this.profileUpAxisData[4*this._extrusionVertexCount+2]=t.up[2],this.profileVertexAndNormalData[4*this._extrusionVertexCount+0]=i[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+1]=i[1],this.profileVertexAndNormalData[4*this._extrusionVertexCount+2]=r[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+3]=r[1],this.pathVertexData[this._extrusionVertexCount]=e,a){const t=this.path.vertices[e];this.profileRightAxisData[4*this._extrusionVertexCount+3]=t.rotationRight[0]*t.maxStretchDistance,this.profileUpAxisData[4*this._extrusionVertexCount+3]=t.rotationRight[1]*t.maxStretchDistance}else this.profileRightAxisData[4*this._extrusionVertexCount+3]=0,this.profileUpAxisData[4*this._extrusionVertexCount+3]=0;++this._extrusionVertexCount}emitCapVertex(e,t,i,r,a,n){this.profileRightAxisData[4*this._extrusionVertexCount+0]=t.right[0],this.profileRightAxisData[4*this._extrusionVertexCount+1]=t.right[1],this.profileRightAxisData[4*this._extrusionVertexCount+2]=t.right[2],this.profileUpAxisData[4*this._extrusionVertexCount+0]=t.up[0],this.profileUpAxisData[4*this._extrusionVertexCount+1]=t.up[1],this.profileUpAxisData[4*this._extrusionVertexCount+2]=t.up[2],this.profileVertexAndNormalData[4*this._extrusionVertexCount+0]=i[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+1]=i[1],this.profileVertexAndNormalData[4*this._extrusionVertexCount+2]=r[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+3]=r[1],this.pathVertexData[this._extrusionVertexCount]=e,this.profileRightAxisData[4*this._extrusionVertexCount+3]=a,this.profileUpAxisData[4*this._extrusionVertexCount+3]=n,++this._extrusionVertexCount}emitTriangle(e,t,i){this.vertexIndices[3*this._triangleCount+0]=e,this.vertexIndices[3*this._triangleCount+1]=t,this.vertexIndices[3*this._triangleCount+2]=i,this.pathVertexIndices[3*this._triangleCount+0]=this.pathVertexData[e],this.pathVertexIndices[3*this._triangleCount+1]=this.pathVertexData[t],this.pathVertexIndices[3*this._triangleCount+2]=this.pathVertexData[i],this.normalIndices[3*this._triangleCount+0]=e,this.normalIndices[3*this._triangleCount+1]=t,this.normalIndices[3*this._triangleCount+2]=i,++this._triangleCount}rebuildGeometry(){const e=(e,t,i,r,a)=>this.emitVertex(e,t,i,r,a),t=(e,t,i,r,a,n)=>this.emitCapVertex(e,t,i,r,a,n);this._extrusionVertexCount=0;for(const i of this.path.vertices)this.originData[3*i.index+0]=i.pos[0],this.originData[3*i.index+1]=i.pos[1],this.originData[3*i.index+2]=i.pos[2];this.startCap.rebuildConnectingProfileGeometry(this.path.vertices[0],this.profile,t);for(let i=1;i<this.path.vertices.length-1;++i)this.extruder.extrude(this.path.vertices[i],this.profile,e);if(this.endCap.rebuildConnectingProfileGeometry(this.path.vertices[this.path.vertices.length-1],this.profile,t),this.startCap.rebuildCapGeometry(this.path.vertices[0],t),this.endCap.rebuildCapGeometry(this.path.vertices[this.path.vertices.length-1],t),this.profile.hasUV()&&this.options.generateUV)for(let i=0;i<this.profile.uvs.length;++i)this.uvData[2*i+0]=this.profile.uvs[i],this.uvData[2*i+1]=0}buildTopology(){const e=(e,t,i)=>this.emitTriangle(e,t,i);this._triangleCount=0;const t=this.profile.vertices.length,i=this.profile.numSegments,r=this.numExtrusionProfiles-1;let a=i*r*2*3;this.startCap.indexBufferStart=a,this.startCap.firstProfileVertexIndex=0,a+=this.startCap.getNumIndices(),this.endCap.indexBufferStart=a,this.endCap.firstProfileVertexIndex=t*(this.numExtrusionProfiles-1),a+=this.endCap.getNumIndices(),this.vertexIndices=new Uint32Array(a),this.normalIndices=new Uint32Array(a),this.pathVertexIndices=new Uint32Array(a),this.profile.hasUV()&&this.options.generateUV&&(this.uvIndices=new Uint32Array(a));for(let n=0;n<i;++n){const i=this.profile.vertexIndices[2*n],a=this.profile.vertexIndices[2*n+1];for(let n=0;n<r;++n){const r=n*t+i,s=(n+1)*t+a,o=n*t+a;e(r,(n+1)*t+i,s),e(r,s,o)}}this.startCap.buildTopology(this.path.vertices[0],e),this.endCap.buildTopology(this.path.vertices[this.path.vertices.length-1],e)}onPathChanged(){this.rebuildGeometry()}}class Ja{constructor(e){this.builder=e}get xform(){return this.builder.path.xform}onPathChanged(){this.builder.onPathChanged()}}class en extends Ja{constructor(e){super(e),this.vertexAttributePosition=null,this.vertexAttributeNormal=null,this.vertexAttributeColor=null,this.vertexAttributePosition=new Float32Array(3*this.builder.numVerticesTotal),this.vertexAttributeNormal=new Float32Array(3*this.builder.numNormalsTotal),this.vertexAttributeColor=new Uint8Array(4),this.vertexAttributeColor[0]=255,this.vertexAttributeColor[1]=255,this.vertexAttributeColor[2]=255,this.vertexAttributeColor[3]=255}bakeVertexColors(e){this.vertexAttributeColor[0]=255*e[0],this.vertexAttributeColor[1]=255*e[1],this.vertexAttributeColor[2]=255*e[2],this.vertexAttributeColor[3]=255*(e.length>3?e[3]:1)}bake(e){this.size=e;for(let t=0;t<this.builder.numVerticesTotal;++t){const i=this.builder.pathVertexData[t],r=0===i||i===this.builder.path.vertices.length-1,a=rn;Object(p["x"])(a,this.builder.originData[3*i+0],this.builder.originData[3*i+1],this.builder.originData[3*i+2]);const n=on,s=an,o=cn,c=ln,l=hn;let h=0,d=0;if(Object(p["x"])(c,this.builder.profileRightAxisData[4*t+0],this.builder.profileRightAxisData[4*t+1],this.builder.profileRightAxisData[4*t+2]),Object(p["x"])(l,this.builder.profileUpAxisData[4*t+0],this.builder.profileUpAxisData[4*t+1],this.builder.profileUpAxisData[4*t+2]),Object(na["s"])(s,this.builder.profileVertexAndNormalData[4*t+0]*e[0],this.builder.profileVertexAndNormalData[4*t+1]*e[1]),r)Object(p["h"])(o,l,c),h=this.builder.profileRightAxisData[4*t+3]*e[0],d=this.builder.profileUpAxisData[4*t+3];else{const e=nn,i=sn;Object(na["s"])(e,this.builder.profileRightAxisData[4*t+3],this.builder.profileUpAxisData[4*t+3]);const r=Object(na["l"])(e);Object(na["e"])(e,e);const a=Object(na["g"])(s,e);if(Math.abs(a)>r){Object(na["s"])(i,-e[1],e[0]);const t=Object(na["g"])(s,i);Object(na["a"])(e,e,r*Object(ke["s"])(a)),Object(na["a"])(i,i,t),Object(na["h"])(s,e,i)}Object(p["x"])(o,0,0,0)}Object(p["x"])(n,c[0]*s[0]+l[0]*s[1],c[1]*s[0]+l[1]*s[1],c[2]*s[0]+l[2]*s[1]),this.vertexAttributePosition[3*t+0]=a[0]+n[0]+o[0]*h,this.vertexAttributePosition[3*t+1]=a[1]+n[1]+o[1]*h,this.vertexAttributePosition[3*t+2]=a[2]+n[2]+o[2]*h;const u=an;Object(na["s"])(u,this.builder.profileVertexAndNormalData[4*t+2],this.builder.profileVertexAndNormalData[4*t+3]),this.vertexAttributeNormal[3*t+0]=c[0]*u[0]+l[0]*u[1]+o[0]*d,this.vertexAttributeNormal[3*t+1]=c[1]*u[0]+l[1]*u[1]+o[1]*d,this.vertexAttributeNormal[3*t+2]=c[2]*u[0]+l[2]*u[1]+o[2]*d}}createGeometryData(){const e=[["position",this.builder.vertexIndices],["normal",this.builder.normalIndices]],t=[["position",{size:3,data:this.vertexAttributePosition,exclusive:!0}],["normal",{size:3,data:this.vertexAttributeNormal,exclusive:!0}]];if(this.vertexAttributeColor){const i=this.builder.vertexIndices.length;e.push(["color",new Uint32Array(i)]),t.push(["color",{size:4,data:this.vertexAttributeColor}])}return{vertexAttributes:t,indices:e}}onPathChanged(){super.onPathChanged(),this.bake(this.size)}intersect(e,t,i){const r=this.builder.vertexIndices,a={size:3,data:this.vertexAttributePosition},n=r.length/3;Object(fr["j"])(e,t,0,n,r,a,void 0,void 0,i)}}class tn extends Ja{constructor(e,t,i,r){super(e),this.sizeAttributeValue=t,this.colorAttributeValue=i,this.opacityAttributeValue=r,this.vvData=null,this.baked=new en(e),this.vvData=new Float32Array(4*this.builder.path.vertices.length);for(let a=0;a<this.builder.path.vertices.length;++a){this.vvData[4*a+0]=t,this.vvData[4*a+1]=i,this.vvData[4*a+2]=r;const e=0===a||a===this.builder.path.vertices.length-1;this.vvData[4*a+3]=e?1:0}}createGeometryData(){return{vertexAttributes:[["position",{size:3,data:this.builder.originData,exclusive:!0}],["profileRight",{size:4,data:this.builder.profileRightAxisData,exclusive:!0}],["profileUp",{size:4,data:this.builder.profileUpAxisData,exclusive:!0}],["profileVertexAndNormal",{size:4,data:this.builder.profileVertexAndNormalData,exclusive:!0}],["featureValue",{size:4,data:this.vvData,exclusive:!0}]],indices:[["position",this.builder.pathVertexIndices],["profileRight",this.builder.vertexIndices],["profileUp",this.builder.vertexIndices],["profileVertexAndNormal",this.builder.vertexIndices],["featureValue",this.builder.pathVertexIndices]]}}}const rn=Object(u["e"])(),an=Object(Oe["b"])(),nn=Object(Oe["b"])(),sn=Object(Oe["b"])(),on=Object(u["e"])(),cn=Object(u["e"])(),ln=Object(u["e"])(),hn=Object(u["e"])(),dn=Object(u["e"])(),un=Fa(),pn=Object(g["b"])();var fn=i("d7f7"),mn=i("35b3"),bn=i("5957"),gn=i("b4c8"),vn=i("c3a4"),yn=i("ca98"),On=i("da35"),_n=i("8e37"),xn=i("189c"),jn=i("8e97"),wn=i("d272"),Sn=i("7438"),Cn=i("c6d7"),Tn=i("87b7"),Pn=i("d017"),An=i("7d11"),Rn=i("b49d"),Mn=i("af20");const En={position:0,profileRight:1,profileUp:2,profileVertexAndNormal:3,featureValue:4};class Dn extends yn["a"]{initializeProgram(e){const t=Dn.shader.get(),i=this.configuration,r=t.build({OITEnabled:0===i.transparencyPassType,output:i.output,viewingMode:e.viewingMode,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,receiveShadows:i.receiveShadows,vvSize:i.vvSize,vvColor:i.vvColor,vvInstancingEnabled:!0,vvOpacity:i.vvOpacity,useOldSceneLightInterface:!1,pbrMode:0,useCustomDTRExponentForWater:!1,receiveAmbientOcclusion:i.receiveSSAO,doubleSidedMode:i.doubleSidedMode,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new _n["a"](e.rctx,r.generateSource("vertex"),r.generateSource("fragment"),En)}bindPass(e,t,i){jn["a"].bindProjectionMatrix(this.program,i.camera.projectionMatrix),this.program.setUniform3fv("size",t.size),i.multipassTerrainEnabled&&(this.program.setUniform2fv("cameraNearFar",i.camera.nearFar),this.program.setUniform2fv("inverseViewport",i.inverseViewport),Object(Cn["a"])(this.program,e,i)),0!==this.configuration.output&&7!==this.configuration.output||this.program.setUniform1f("opacity",t.opacity),0===this.configuration.output?(i.lighting.setUniforms(this.program,!1),this.program.setUniform3fv("ambient",t.ambient),this.program.setUniform3fv("diffuse",t.diffuse),this.program.setUniform3fv("specular",t.specular),this.program.setUniform1f("opacity",t.opacity)):1!==this.configuration.output&&3!==this.configuration.output||jn["a"].bindNearFar(this.program,i.camera.nearFar),Object(Rn["b"])(this.program,t)}bindDraw(e){jn["a"].bindView(this.program,e),wn["a"].bindUniformsWithOrigin(this.program,this.configuration,e),0!==this.configuration.output&&7!==this.configuration.output||jn["a"].bindCamPosition(this.program,e.origin,e.camera.viewInverseTransposeMatrix),0===this.configuration.output&&Pn["a"].bindView(this.program,e),2===this.configuration.output&&An["a"].bindUniforms(this.program,e.camera.viewInverseTransposeMatrix)}setPipelineState(e){const t=this.configuration,i=3===e,r=2===e,a=e=>!e.slicePlaneEnabled&&!(e.transparent||0===e.doubleSidedMode),n=e=>a(e)&&{face:1028,mode:2305};return Object(xn["e"])({blending:0!==t.output&&7!==t.output||!t.transparent?null:i?Sn["f"]:Object(Sn["a"])(e),culling:n(t),depthTest:{func:Object(Sn["b"])(e)},depthWrite:i||r?xn["d"]:null,colorWrite:xn["c"],stencilWrite:t.sceneHasOcludees?Tn["j"]:null,stencilTest:t.sceneHasOcludees?Tn["e"]:null,polygonOffset:i||r?null:Sn["d"]})}initializePipeline(){return this.setPipelineState(this.configuration.transparencyPassType)}}Dn.shader=new vn["a"](Mn["a"],()=>i.e("chunk-2d0c7e33").then(i.bind(null,"5310")));class In extends On["a"]{constructor(){super(...arguments),this.output=0,this.doubleSidedMode=0,this.receiveShadows=!1,this.receiveSSAO=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.slicePlaneEnabled=!1,this.transparent=!1,this.sceneHasOcludees=!1,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!0}}Object(Mt["a"])([Object(On["b"])({count:8})],In.prototype,"output",void 0),Object(Mt["a"])([Object(On["b"])({count:3})],In.prototype,"doubleSidedMode",void 0),Object(Mt["a"])([Object(On["b"])()],In.prototype,"receiveShadows",void 0),Object(Mt["a"])([Object(On["b"])()],In.prototype,"receiveSSAO",void 0),Object(Mt["a"])([Object(On["b"])()],In.prototype,"vvSize",void 0),Object(Mt["a"])([Object(On["b"])()],In.prototype,"vvColor",void 0),Object(Mt["a"])([Object(On["b"])()],In.prototype,"vvOpacity",void 0),Object(Mt["a"])([Object(On["b"])()],In.prototype,"slicePlaneEnabled",void 0),Object(Mt["a"])([Object(On["b"])()],In.prototype,"transparent",void 0),Object(Mt["a"])([Object(On["b"])()],In.prototype,"sceneHasOcludees",void 0),Object(Mt["a"])([Object(On["b"])({count:4})],In.prototype,"transparencyPassType",void 0),Object(Mt["a"])([Object(On["b"])()],In.prototype,"multipassTerrainEnabled",void 0),Object(Mt["a"])([Object(On["b"])()],In.prototype,"cullAboveGround",void 0);const Ln=or["a"];class Vn extends mn["a"]{constructor(e){super(e,Fn),this.supportsEdges=!0,this._vertexAttributeLocations=En,this.techniqueConfig=new In,this.vertexBufferLayout=Vn.getVertexBufferLayout(this.params)}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.vvSize=this.params.vvSizeEnabled,this.techniqueConfig.vvColor=this.params.vvColorEnabled,this.techniqueConfig.vvOpacity=this.params.vvOpacityEnabled,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.transparent=this.params.transparent,this.techniqueConfig.sceneHasOcludees=this.params.sceneHasOcludees,0!==e&&7!==e||(this.techniqueConfig.doubleSidedMode=this.params.doubleSided&&"normal"===this.params.doubleSidedType?1:this.params.doubleSided&&"winding-order"===this.params.doubleSidedType?2:0,this.techniqueConfig.receiveShadows=this.params.receiveShadows,this.techniqueConfig.receiveSSAO=!(!t||!t.ssaoEnabled)&&this.params.receiveSSAO),this.techniqueConfig.transparencyPassType=t?t.transparencyPassType:3,this.techniqueConfig.multipassTerrainEnabled=!!t&&t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=!t||t.cullAboveGround,this.techniqueConfig}getPassParameters(){return this.params}isVisibleInPass(e){return 4!==e&&6!==e&&7!==e||this.params.castShadows}isVisible(){const e=this.params;return!!super.isVisible()&&e.opacity>0}intersect(e,t,i,a,n,s,o){const c=e;if(!Da(c))return;const l=c.path,h=[this.params.size[0],this.params.size[1]];if(this.params.vvSizeEnabled){const e=this.params.vvSizeOffset,t=this.params.vvSizeFactor,i=this.params.vvSizeMinSize,r=this.params.vvSizeMaxSize,a=l.sizeAttributeValue;h[0]*=Object(ke["d"])(e[0]+a*t[0],i[0],r[0]),h[1]*=Object(ke["d"])(e[2]+a*t[2],i[2],r[2])}const d=Math.max(h[0],h[1]),u=e.boundingInfo;if(Object(r["j"])(u))return void this._intersectTriangles(l,h,n,s,o);const p=Object(x["t"])(u.bbMin[0]-d,u.bbMin[1]-d,u.bbMin[2]-d,u.bbMax[0]+d,u.bbMax[1]+d,u.bbMax[2]+d),f=[s[0]-n[0],s[1]-n[1],s[2]-n[2]],m=Math.sqrt(f[0]*f[0]+f[1]*f[1]+f[2]*f[2]),b=[m/f[0],m/f[1],m/f[2]];Object(fr["f"])(p,n,b,a.tolerance)&&this._intersectTriangles(l,h,n,s,o)}_intersectTriangles(e,t,i,r,a){e.baked.size&&e.baked.size[0]===t[0]&&e.baked.size[1]===t[1]||e.baked.bake(t),e.baked.intersect(i,r,a)}computeAttachmentOrigin(e,t){const i=e.vertexAttributes;if(!i)return null;const r=i.get("position");return Object(Si["a"])(r,null,!1,t)}createBufferWriter(){return new zn(this.vertexBufferLayout)}getGLMaterial(e){if(0===e.output||7===e.output||1===e.output||2===e.output||4===e.output||3===e.output&&this.params.castShadows)return new kn(e)}static getVertexBufferLayout(e){let t=Object(vr["a"])().vec3f("position").vec4f("profileRight").vec4f("profileUp").vec4f("profileVertexAndNormal");return(e.vvColorEnabled||e.vvSizeEnabled||e.vvOpacityEnabled)&&(t=t.vec4f("featureValue")),t}}class kn extends fn["a"]{constructor(e){super(e),this.updateParameters()}updateParameters(e){this.technique=this.techniqueRep.acquireAndReleaseExisting(Dn,this.material.getTechniqueConfig(this.output,e),this.technique)}beginSlot(e){return e===(this.technique.configuration.transparent?5:3)}_updateOccludeeState(e){e.hasOccludees!==this.material.params.sceneHasOcludees&&this.material.setParameterValues({sceneHasOcludees:e.hasOccludees})}_updateShadowState(e){e.shadowMappingEnabled!==this.technique.configuration.receiveShadows&&this.material.setParameterValues({receiveShadows:e.shadowMappingEnabled})}ensureParameters(e){0!==this.output&&7!==this.output||(this._updateShadowState(e),this._updateOccludeeState(e)),this.updateParameters(e)}bind(e,t){e.bindProgram(this.technique.program),this.technique.bindPass(e,this.material.getPassParameters(),t)}}const Fn={size:[1,1,1],ambient:[.2,.2,.2],diffuse:[.8,.8,.8],specular:[0,0,0],opacity:1,doubleSided:!1,doubleSidedType:"normal",receiveSSAO:!0,receiveShadows:!1,castShadows:!0,slicePlaneEnabled:!1,transparent:!1,sceneHasOcludees:!1,...gn["a"].Default,...mn["b"]};class zn{constructor(e){this.vertexBufferLayout=e}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get("position").length}write(e,t,i,r){const a=e=>{if(t.vertexAttributes.has(e)){const a=t.vertexAttributes.get(e),n=t.indices.get(e);Ln(4===a.size);const s=i.getField(e,O["C"]);if(!s)throw new Error("unable to acquire view for "+e);Object(bn["a"])(n,a.data,s,r)}};a("profileRight"),a("profileUp"),a("profileVertexAndNormal"),this.vertexBufferLayout.hasField("featureValue")&&a("featureValue"),Object(bn["c"])(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,i,r)}}const Un=["polyline"];class Gn extends M["a"]{constructor(e,t,i,r){super(e,t,i,r),this._intrinsicSize=Object(Oe["f"])(1,1),this.upVectorAlignment="path",this.stencilWidth=.1,this.ensureDrapedStatus(!1)}async doLoad(){const e=Object(r["k"])(this.symbolLayer.width)?this.symbolLayer.width:Object(r["k"])(this.symbolLayer.height)?this.symbolLayer.height:this.symbolLayer.size,t=Object(r["k"])(this.symbolLayer.height)?this.symbolLayer.height:e;this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[e,1,t],unitInMeters:this._context.renderCoordsHelper.unitInMeters,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=it(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1};const i=this.symbolLayer.anchor||"center";this.upVectorAlignment="path","heading"===this.symbolLayer.profileRotation&&(this.upVectorAlignment="world");const a=this.symbolLayer.profile||"circle";switch(a){case"circle":default:this._profile=Ba.circle(Kn);break;case"quad":this._profile=Ba.rect()}let n=[0,0];switch("center"!==i&&(n={left:[.5,0],right:[-.5,0],top:[0,-.5],bottom:[0,.5]}[i],this._profile.translate(n[0],n[1])),this.symbolLayer.join||"simple"){case"round":this._extruder=new Wa(0,Xn);break;case"bevel":this._extruder=new Wa(0,1);break;case"miter":this._extruder=new Wa(.8*Math.PI,1);break;case"simple":default:this._extruder=new qa}const s=this.symbolLayer.cap||"butt";switch(s){case"none":this._startCap=new Qa,this._endCap=new Qa;break;case"butt":default:this._startCap=new Xa(this._profile,0),this._endCap=new Xa(this._profile,0,!0);break;case"square":this._startCap=new Xa(this._profile,-.5),this._endCap=new Xa(this._profile,.5,!0);break;case"round":{const e="quad"===a;this._startCap=new Ya({profile:this._profile,flip:!1,breakNormals:e,subdivisions:Yn}),this._endCap=new Ya({profile:this._profile,flip:!0,breakNormals:e,subdivisions:Yn});break}}const o=Object(r["i"])(this.symbolLayer,"material","color"),c=this._getCombinedOpacityAndColor(o),l=Object(u["f"])(c),h=c[3],p={diffuse:l,ambient:l,opacity:h,transparent:h<1||this.needsDrivenTransparentPass,vertexColors:!1,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,cullFace:"none"===s?0:void 0,offsetTransparentBackfaces:!0};if(!this._drivenProperties.size&&(Object(na["s"])(this._intrinsicSize,e,t),!Object(T["f"])(this._intrinsicSize[0])||!Object(T["f"])(this._intrinsicSize[1])))throw new d["a"]("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||Object(na["a"])(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters),this._fastUpdates.enabled?(Object.assign(p,this._fastUpdates.materialParameters,{size:[this._intrinsicSize[0],this._intrinsicSize[1],0]}),this._material=new Vn(p)):(p.vertexColors=this._drivenProperties.color||this._drivenProperties.opacity,this._material=new N["b"](p)),this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._context.stage.add(this._material)}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,Un,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(t,new A["a"]),r=e.renderingInfo;return this._createAs3DShape(t,r,i,t.uid)}layerOpacityChanged(){const e=Object(r["i"])(this.symbolLayer,"material","color"),t=this._getCombinedOpacity(e),i=t<1||this.needsDrivenTransparentPass;return this._material.setParameterValues({opacity:t,transparent:i}),!0}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,P["g"])}slicePlaneEnabledChanged(){return this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}pixelRatioChanged(){return!0}applyRendererDiff(e,t){for(const i in e.diff)switch(i){case"visualVariables":if(!rt(this._fastUpdates,t,this._vvConvertOptions))return!1;this._material.setParameterValues(this._fastUpdates.materialParameters);break;default:return!1}return!0}getVertexData(e){let t=0;const i=e.paths,r=[],a=e.spatialReference,n=this._context.elevationProvider.spatialReference,s=this._context.renderCoordsHelper.spatialReference;for(const u of i)t+=u.length;const o=new Float64Array(3*t),c=new Float64Array(3*t),l=new Float64Array(3*t);let h=0;for(const u of i){r.push({index:h,numVertices:u.length});for(const t of u)o[h++]=t[0],o[h++]=t[1],o[h++]=e.hasZ?t[2]:0}let d=!0;return a.equals(n)?this._copyVertices(o,0,c,0,t):d=Object(m["q"])(o,a,0,c,n,0,t),n.equals(s)?this._copyVertices(c,0,l,0,t):Object(m["q"])(c,n,0,l,s,0,t),{pathVertexDataInfos:r,vertexDataGS:o,vertexDataES:c,vertexDataRS:l,projectionSuccess:d,terrainElevation:0}}_copyVertices(e,t,i,r,a){t*=3,r*=3;for(let n=0;n<a;++n)i[r++]=e[t++],i[r++]=e[t++],i[r++]=e[t++]}_createAs3DShape(e,t,i,a){const n=e.geometry,o=new Array,c=new Array,l=new Array,h=n.spatialReference,d=Object(x["h"])(),u=this._context.renderCoordsHelper,f=this.getVertexData(n);if(!f.projectionSuccess)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),null;if(f.pathVertexDataInfos.length>0){for(let a=0;a<f.pathVertexDataInfos.length;++a){const n=f.pathVertexDataInfos[a],s=n.index,m=n.numVertices;if(m<2){this.logger.warn("PathSymbol3DLayer geometry failed to be created (paths should contain at least 2 vertices)");continue}if(Object(r["k"])(this._context.clippingExtent)&&(Object(x["k"])(d),Object(x["n"])(d,f.vertexDataES,3*s,m),!Object(x["x"])(d,this._context.clippingExtent)))continue;const b=[];for(let e=s;e<s+3*m;){const t=e++,r=e++,a=e++,n=new Ga;Object(p["x"])(n.posGS,f.vertexDataGS[t],f.vertexDataGS[r],f.vertexDataGS[a]),Object(p["x"])(n.posES,f.vertexDataES[t],f.vertexDataES[r],f.vertexDataES[a]);const s=Object(P["e"])(n.posES,this._context.elevationProvider,i,u,null);Object(p["x"])(Zn,f.vertexDataRS[t],f.vertexDataRS[r],f.vertexDataRS[a]),u.setAltitude(s,Zn),Object(p["x"])(n.pos,Zn[0],Zn[1],Zn[2]),b.push(n)}const g=new Ha(b);Bn(g,this.upVectorAlignment,this._context.renderCoordsHelper);const v=new Ka(g,this._profile,this._extruder,this._startCap,this._endCap);let y=null;if(this._fastUpdates.enabled){const t=this._fastUpdates.visualVariables,i=t.size?Object(M["b"])(t.size.field,e):0,r=t.color?Object(M["b"])(t.color.field,e):0,a=t.opacity?Object(M["b"])(t.opacity.field,e):0;y=new tn(v,i,r,a)}else{const e=[this._intrinsicSize[0],this._intrinsicSize[1]];this._drivenProperties.size&&(e[0]*=Hn(t.size[0],"symbol-value"===t.size[2]?this.symbolLayer.height||0:t.size[2],this.symbolLayer.width||0),e[1]*=Hn(t.size[2],"symbol-value"===t.size[0]?this.symbolLayer.width||0:t.size[0],this.symbolLayer.height||0));let i=null;this._drivenProperties.color&&(i=t.color),this._drivenProperties.opacity&&null!=t.opacity&&(i=i?[i[0],i[1],i[2],t.opacity]:[1,1,1,t.opacity]);const r=new en(v);r.bake(e),i&&r.bakeVertexColors(i),y=r}const{vertexAttributes:O,indices:_}=y.createGeometryData(),j=new Ea(O,_,y,h,this.upVectorAlignment,this.stencilWidth);o.push(j),c.push(this._material),l.push(y.xform)}if(o.length>0){const e={layerUid:this._context.layer.uid,graphicUid:a},t=new S["a"]({geometries:o,materials:c,transformations:l,metadata:e}),r=new s["a"](this,t,o,null,null,qn,i);return r.alignedSampledElevation=f.terrainElevation,r.needsElevationUpdates=Object(P["g"])(i.mode),r}}else this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)");return null}}function Bn(e,t,i){switch(t){case"world":for(const t of e.vertices)Object(p["g"])($n,t.pos,e.offset),i.worldUpAtPosition($n,Zn),t.setFrameFromUpVector(Zn),t.computeRotationAxisAndAngleFromUpVector();break;case"path":Object(p["g"])($n,e.vertices[0].pos,e.offset),i.worldUpAtPosition($n,Zn),Na(e,Zn);for(const t of e.vertices){const e=Object(ke["s"])(Object(p["i"])(t.frame.right,t.vRight));Object(p["h"])(t.rotationFrame.up,t.vRight,t.vLeft),Object(p["f"])(t.rotationFrame.up,t.rotationFrame.up,e),Object(p["s"])(t.rotationFrame.up,t.rotationFrame.up);const i=Object(p["i"])(t.rotationFrame.up,t.frame.up),r=Object(p["i"])(t.rotationFrame.up,t.frame.right);if(Object(p["f"])($n,t.frame.up,-r),Object(p["f"])(Qn,t.frame.right,i),Object(p["g"])($n,$n,Qn),Object(p["s"])(t.rotationFrame.right,$n),Ua(t.rotationRight,t.frame,t.rotationFrame.right),Object(p["u"])($n,t.vLeft),t.rotationAngle=-e*(Math.PI-Object(ke["b"])(Object(p["i"])($n,t.vRight))),Math.abs(t.rotationAngle)>0){const e=Object(ke["r"])(Math.cos(.5*t.rotationAngle));da(t.miterStretch,1+(e-1)*t.rotationRight[0]*t.rotationRight[0],(e-1)*t.rotationRight[0]*t.rotationRight[1],(e-1)*t.rotationRight[0]*t.rotationRight[1],1+(e-1)*t.rotationRight[1]*t.rotationRight[1])}const a=Math.PI-t.rotationAngle;t.maxStretchDistance=Math.abs(Math.min(t.vLeftLength,t.vRightLength)*Object(ke["r"])(Math.cos(.5*a)))}}}function Hn(e,t,i){switch(e){case"symbol-value":return i;case"proportional":return t;default:return e}}function Nn(e,t,i,r){let a=0;for(const n of e.vertices){const s=Object(P["e"])(n.posES,i,t,r,Jn);a+=Jn.sampledElevation,Object(p["g"])(Zn,n.pos,e.offset),r.setAltitude(s,Zn),Object(p["k"])(n.pos,Zn,e.offset)}return e.updatePathVertexInformation(),a/e.vertices.length}function qn(e,t,i,r){const a=e.stageObject,n=a.geometryRecords,s=n.length;let o=0;Wn.spatialReference=r.spatialReference;for(let c=0;c<s;c++){const e=n[c].geometry;if(!Da(e))continue;const s=e.path,l=s.builder.path;e.geometrySR,o+=Nn(l,t,i,r),"world"!==e.upVectorAlignment&&Bn(l,e.upVectorAlignment,r),s.onPathChanged(),e.invalidateBoundingInfo(),a.geometryVertexAttrsUpdated(c)}return o/s}const Wn=Object(sa["k"])(0,0,0,null),Zn=Object(u["e"])(),$n=Object(oa["c"])(),Qn=Object(oa["c"])(),Xn=3,Yn=3,Kn=10,Jn={verticalDistanceToGround:0,sampledElevation:0};var es=i("70ab");function ts(e,t,i,r=1){if(i.isGeographic){const e=new Float64Array(t.typedBuffer.length),r=3*t.count;for(let a=0;a<r;a+=3)Object(m["m"])(t.typedBuffer,a,e,a,Object(bi["e"])(i));t=O["v"].fromTypedArray(e)}Object(na["s"])(ls,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY);for(let s=0;s<t.count;s++)t.getVec(s,as),ls[0]=Math.min(ls[0],as[0]),ls[1]=Math.min(ls[1],as[1]);const a=ls[0]%r,n=ls[1]%r;ds[0]=ls[0]-a,ds[1]=ls[1]-n;for(let s=0;s<t.count;s++)t.getVec(s,as),e.setValues(s,(as[0]-ds[0])/r,(as[1]-ds[1])/r,ds[0]/r,ds[1]/r)}function is(e,t,i,r,a=1){Object(p["x"])(ss,1,0,0),Object(p["x"])(os,0,1,0),Object(p["x"])(cs,0,0,1),_s(rs,t),ms(t,ns)&&bs(ns,ss,os,cs,i,rs),Object(na["s"])(ls,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),Object(na["s"])(hs,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let c=0;c<t.count;c++){t.getVec(c,as);const e=Object(p["i"])(ss,as),i=Object(p["i"])(os,as);ls[0]=Math.min(ls[0],e),ls[1]=Math.min(ls[1],i),hs[0]=Math.max(hs[0],e),hs[1]=Math.max(hs[1],i)}const n=Object(p["i"])(cs,rs);js(us,ls[0],ls[1],n,ss,os,cs),js(ps,hs[0],ls[1],n,ss,os,cs),js(fs,ls[0],hs[1],n,ss,os,cs),Object(p["k"])(ps,ps,us),Object(p["f"])(ps,ps,.5),Object(p["k"])(fs,fs,us),Object(p["f"])(fs,fs,.5),Object(p["g"])(us,us,ps),Object(p["g"])(us,us,fs);const s=ls[0]%a,o=ls[1]%a;ds[0]=ls[0]-s,ds[1]=ls[1]-o;for(let c=0;c<t.count;c++){t.getVec(c,as),e.setValues(c,(Object(p["i"])(ss,as)-ds[0])/a,(Object(p["i"])(os,as)-ds[1])/a,ds[0]/a,ds[1]/a);for(let e=0;e<3;e++)r.set(c,e,us[e]),r.set(c,e+3,ps[e]),r.set(c,e+6,fs[e])}}const rs=Object(u["e"])(),as=Object(u["e"])(),ns=Object(es["c"])(),ss=Object(u["e"])(),os=Object(u["e"])(),cs=Object(u["e"])(),ls=Object(Oe["b"])(),hs=Object(Oe["b"])(),ds=Object(Oe["b"])(),us=Object(u["e"])(),ps=Object(u["e"])(),fs=Object(u["e"])();function ms(e,t){const i=e.count-1;return Object(es["t"])(e,t,0,Math.floor(i/3),Math.floor(i*(2/3)))}function bs(e,t,i,a,n,s){Object(r["k"])(n)?(n.basisMatrixAtPosition(s,gs),Object(p["x"])(vs,gs[0],gs[1],gs[2]),Object(p["x"])(ys,gs[4],gs[5],gs[6]),Object(p["x"])(Os,gs[8],gs[9],gs[10])):(Object(p["x"])(vs,1,0,0),Object(p["x"])(ys,0,1,0),Object(p["x"])(Os,0,0,1));const o=Object(es["n"])(e);Object(p["i"])(o,Os)<0&&Object(p["f"])(o,o,-1),Object(p["l"])(a,o);const c=Object(p["i"])(o,ys),l=Object(p["i"])(o,vs);Math.abs(c)<Math.abs(l)?(Object(p["d"])(t,vs,o,-l),Object(p["s"])(t,t),Object(p["h"])(i,t,o),Object(p["s"])(i,i),Object(p["f"])(i,i,-1)):(Object(p["d"])(i,ys,o,-c),Object(p["s"])(i,i),Object(p["h"])(t,i,o),Object(p["s"])(t,t))}const gs=Object(g["b"])(),vs=Object(u["e"])(),ys=Object(u["e"])(),Os=Object(u["e"])();function _s(e,t){Object(p["x"])(xs,0,0,0);for(let i=0;i<t.count-1;i++)t.getVec(i,as),Object(p["g"])(xs,xs,as);Object(p["f"])(e,xs,1/(t.count-1))}const xs=Object(u["e"])();function js(e,t,i,r,a,n,s){Object(p["x"])(e,t*a[0]+i*n[0]+r*s[0],t*a[1]+i*n[1]+r*s[1],t*a[2]+i*n[2]+r*s[2])}var ws=i("8675"),Ss=i("aeb3");class Cs extends yn["a"]{initializeProgram(e){const t=Cs.shader.get(),i=this.configuration,r=t.build({output:i.output,attributeColor:i.vertexColors,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,style:i.style,patternSpacing:i.patternSpacing,lineWidth:i.lineWidth,draped:i.draped,OITEnabled:0===i.transparencyPassType,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new _n["a"](e.rctx,r.generateSource("vertex"),r.generateSource("fragment"),As)}bindPass(e,t,i){jn["a"].bindProjectionMatrix(this.program,i.camera.projectionMatrix),this.program.setUniform4fv("matColor",t.color),this.configuration.draped?(this.program.setUniform1f("worldToScreenRatio",1/i.screenToWorldRatioGlobalWM),this.program.setUniform1f("texelSize",1/i.camera.pixelRatio)):this.program.setUniform1f("worldToScreenPerDistanceRatio",1/i.camera.perScreenPixelRatio),4===this.configuration.output&&mr["a"].bindOutputHighlight(e,this.program,i),(1===this.configuration.output||i.multipassTerrainEnabled)&&this.program.setUniform2fv("cameraNearFar",i.camera.nearFar),i.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",i.inverseViewport),Object(Cn["a"])(this.program,e,i))}bindDraw(e){jn["a"].bindView(this.program,e),jn["a"].bindCamPosition(this.program,e.origin,e.camera.viewInverseTransposeMatrix),wn["a"].bindUniformsWithOrigin(this.program,this.configuration,e)}setPipelineState(e,t){const i=this.configuration,r=3===e,a=2===e,n=e=>0!==e&&{face:1===e?1028:1029,mode:2305};return Object(xn["e"])({blending:0===i.output||7===i.output?i.transparent&&r?Sn["f"]:Object(Sn["a"])(e):null,culling:n(i.cullFace),depthTest:{func:Object(Sn["b"])(e)},depthWrite:r?i.writeDepth&&xn["d"]:Object(Sn["c"])(e),colorWrite:xn["c"],stencilWrite:i.sceneHasOcludees?Tn["j"]:null,stencilTest:i.sceneHasOcludees?t?Tn["f"]:Tn["e"]:null,polygonOffset:r||a?i.polygonOffset&&Ts:Object(Sn["g"])(i.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this.setPipelineState(this.configuration.transparencyPassType,!0),this.setPipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(e){return e?this._occludeePipelineState:this.pipeline}}Cs.shader=new vn["a"](Ss["a"],()=>i.e("chunk-2d208701").then(i.bind(null,"a590")));const Ts={factor:1,units:1};class Ps extends On["a"]{constructor(){super(...arguments),this.output=0,this.cullFace=0,this.slicePlaneEnabled=!1,this.vertexColors=!1,this.transparent=!0,this.polygonOffset=!1,this.writeDepth=!0,this.sceneHasOcludees=!1,this.enableOffset=!0,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!0}}Object(Mt["a"])([Object(On["b"])({count:8})],Ps.prototype,"output",void 0),Object(Mt["a"])([Object(On["b"])({count:3})],Ps.prototype,"cullFace",void 0),Object(Mt["a"])([Object(On["b"])()],Ps.prototype,"slicePlaneEnabled",void 0),Object(Mt["a"])([Object(On["b"])()],Ps.prototype,"vertexColors",void 0),Object(Mt["a"])([Object(On["b"])()],Ps.prototype,"transparent",void 0),Object(Mt["a"])([Object(On["b"])()],Ps.prototype,"polygonOffset",void 0),Object(Mt["a"])([Object(On["b"])()],Ps.prototype,"writeDepth",void 0),Object(Mt["a"])([Object(On["b"])()],Ps.prototype,"sceneHasOcludees",void 0),Object(Mt["a"])([Object(On["b"])({count:6})],Ps.prototype,"style",void 0),Object(Mt["a"])([Object(On["b"])()],Ps.prototype,"patternSpacing",void 0),Object(Mt["a"])([Object(On["b"])()],Ps.prototype,"lineWidth",void 0),Object(Mt["a"])([Object(On["b"])()],Ps.prototype,"enableOffset",void 0),Object(Mt["a"])([Object(On["b"])()],Ps.prototype,"draped",void 0),Object(Mt["a"])([Object(On["b"])({count:4})],Ps.prototype,"transparencyPassType",void 0),Object(Mt["a"])([Object(On["b"])()],Ps.prototype,"multipassTerrainEnabled",void 0),Object(Mt["a"])([Object(On["b"])()],Ps.prototype,"cullAboveGround",void 0);const As={position:0,color:3,uvMapSpace:4,boundingRect:5};class Rs extends mn["a"]{constructor(e){super(e,Ds),this.supportsEdges=!0,this._vertexAttributeLocations=As,this.techniqueConfig=new Ps}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.cullFace=this.params.cullFace,this.techniqueConfig.vertexColors=this.params.vertexColors,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.polygonOffset=this.params.polygonOffset,this.techniqueConfig.writeDepth=this.params.writeDepth,this.techniqueConfig.style=this.params.style,this.techniqueConfig.patternSpacing=this.params.patternSpacing,this.techniqueConfig.lineWidth=this.params.lineWidth,this.techniqueConfig.draped=this.params.draped,this.techniqueConfig.transparencyPassType=t?t.transparencyPassType:3,this.techniqueConfig.enableOffset=!t||t.camera.relativeElevation<Sn["e"],this.techniqueConfig.multipassTerrainEnabled=!!t&&t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=!t||t.cullAboveGround,this.techniqueConfig}getPassParameters(){return this.params}intersect(e,t,i,r,a,n,s){Object(fr["i"])(e,t,r,a,n,void 0,s)}getGLMaterial(e){return 0===e.output||7===e.output||4===e.output||1===e.output&&this.params.writeLinearDepth?new Ms(e):void 0}createBufferWriter(){const e=Object(vr["a"])().vec3f("position").vec4u8("color").vec4f("uvMapSpace");return this.params.draped||e.mat3f("boundingRect"),new Es(e)}}class Ms extends fn["a"]{constructor(e){super(e),this.updateParameters()}updateParameters(e){this.technique=this.techniqueRep.acquireAndReleaseExisting(Cs,this.material.getTechniqueConfig(this.output,e),this.technique)}beginSlot(e){return 4===this.output?3===e:e===(this.technique.configuration.transparent?this.technique.configuration.writeDepth?5:8:3)}_updateOccludeeState(e){e.hasOccludees!==this.material.params.sceneHasOcludees&&this.material.setParameterValues({sceneHasOcludees:e.hasOccludees})}ensureParameters(e){0!==this.output&&7!==this.output||this._updateOccludeeState(e),this.updateParameters(e)}bind(e,t){e.bindProgram(this.technique.program),this.technique.bindPass(e,this.material.getPassParameters(),t)}getPipelineState(e,t){return this.technique.getPipelineState(t)}}class Es extends ws["a"]{write(e,t,i,r){for(const a of this.vertexBufferLayout.fieldNames){const n=t.vertexAttributes.get(a),s=t.indices.get(a);if(n&&s)switch(a){case"position":{Object(or["a"])(3===n.size);const t=i.getField(a,O["u"]);t&&Object(bn["e"])(s,n.data,e.transformation,t,r);break}case"color":{Object(or["a"])(3===n.size||4===n.size);const e=i.getField(a,O["J"]);e&&Object(bn["b"])(s,n.data,n.size,e,r);break}case"uvMapSpace":{Object(or["a"])(4===n.size);const e=i.getField(a,O["C"]);e&&Object(bn["a"])(s,n.data,e,r);break}case"boundingRect":{Object(or["a"])(9===n.size);const t=i.getField(a,O["f"]);t&&this.writeBoundingRect(s,n.data,e.transformation,t,r);break}}}}writeBoundingRect(e,t,i,r,a){const n=i,s=r.typedBuffer,o=r.typedBufferStride,c=e.length;a*=o;for(let l=0;l<c;++l){const i=9*e[l],r=t[i],c=t[i+1],h=t[i+2];s[a]=n[0]*r+n[4]*c+n[8]*h+n[12],s[a+1]=n[1]*r+n[5]*c+n[9]*h+n[13],s[a+2]=n[2]*r+n[6]*c+n[10]*h+n[14];for(let e=3;e<9;++e)s[a+e]=t[i+e];a+=o}}}const Ds={color:[1,1,1,1],writeDepth:!0,writeLinearDepth:!1,vertexColors:!1,polygonOffset:!1,slicePlaneEnabled:!1,cullFace:0,sceneHasOcludees:!1,style:2,patternSpacing:10,lineWidth:1,draped:!0,...mn["b"]};var Is=i("d36e");function Ls(e,t,i){return ks(Vs(e),t,i)}function Vs(e){return e&&e.pattern||null}function ks(e,t,i){return Object(r["k"])(e)?"none"===e.style||"solid"===e.style?("none"===e.style&&(t.color=Object(_e["d"])(0,0,0,0),t.transparent=!0),new Is["a"](t)):(t.style=Fs(e.style),t.draped=i.isDraped,new Rs(t)):new Is["a"](t)}function Fs(e){switch(e){case"horizontal":return 0;case"vertical":return 1;case"cross":return 2;case"forward-diagonal":return 3;case"backward-diagonal":return 4;case"diagonal-cross":return 5;default:return}}function zs(e){return e.material instanceof Rs&&!e.material.params.draped}function Us(e,t){if(zs(e)){const i=e.geometry.vertexAttributes,r=i.get("position").data,a=i.get("uvMapSpace").data,n=i.get("boundingRect").data;is(O["C"].fromTypedArray(a),O["v"].fromTypedArray(r),t,O["g"].fromTypedArray(n))}}function Gs(e,t,i,r){const a=Object(Se["c"])(e,t,i,r),n=e.stageObject.geometryRecords;for(let s=0;s<n.length;s++)Us(n[s],r);return a}const Bs=["polyline","polygon","extent"];class Hs extends M["a"]{constructor(e,t,i,r){super(e,t,i,r),this._needsUV=!1,this._hasOutline=!1}async doLoad(){}ensureMaterials(){this.ensureFillMaterial(),this.ensureOutlineMaterial()}ensureFillMaterial(){if(Object(r["k"])(this._material))return;const e=Object(r["i"])(this.symbolLayer,"material","color"),t=this._getCombinedOpacityAndColor(e);this._material=Ls(this.symbolLayer,{color:t,transparent:t[3]<1||this.needsDrivenTransparentPass,polygonOffset:!1,vertexColors:!0,writeLinearDepth:!0,slicePlaneEnabled:this._context.slicePlaneEnabled},{isDraped:this.draped}),this._needsUV=this._material instanceof Rs,this._context.stage.add(this._material)}ensureOutlineMaterial(){const e=this.symbolLayer.outline;if(Object(r["k"])(this._outlineMaterial)||!this._isValidOutline(e))return;this._hasOutline=!0;const t=t=>{const i=e.stipplePattern?Object(Ct["b"])(e.stipplePattern.map(ge["h"])):null,r=e.stippleOffColor?me["a"].toUnitRGBA(e.stippleOffColor):null;return t>1.5?new St["a"]({width:t,color:this._getOutlineColor(),polygonOffset:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,isClosed:!0,stipplePattern:i,stippleIntegerRepeats:!0,stippleOffColor:r}):new Ti["a"]({color:this._getOutlineColor(),slicePlaneEnabled:this._context.slicePlaneEnabled,width:t,stipplePattern:i,stippleIntegerRepeats:!0,stippleOffColor:r})};this._outlineMaterial=t(Object(ge["h"])(e.size)),this._context.stage.add(this._outlineMaterial)}_isValidOutline(e){return Object(r["k"])(e)&&e.size&&e.size>0&&Object(r["k"])(e.color)}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null,this._context.stage.remove(this._outlineMaterial),this._outlineMaterial=null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,Bs,this.symbolLayer.type))return null;const i=this._getVertexOpacityAndColor(e.renderingInfo,255),r=this.setGraphicElevationContext(t,new A["a"]);return this.ensureDrapedStatus("on-the-ground"===r.mode),this.ensureMaterials(),this.draped?this._createAsOverlay(t,i):this._createAs3DShape(t,i,r)}layerOpacityChanged(){if(Object(r["k"])(this._material)){const e=this._material.params.color,t=Object(r["i"])(this.symbolLayer,"material","color"),i=this._getCombinedOpacity(t);this._material.setParameterValues({color:[e[0],e[1],e[2],i],transparent:i<1||this.needsDrivenTransparentPass})}if(Object(r["k"])(this._outlineMaterial)){const e=this._outlineMaterial.params.color;this._outlineMaterial.setParameterValues({color:[e[0],e[1],e[2],this._getOutlineOpacity()]})}return!0}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,a=Object(P["d"])(Hs.elevationModeChangeTypes,i,r);if(a!==P["a"].UPDATE)return a;const n=Object(P["f"])(r);return this.updateGraphics3DGraphicElevationInfo(e,t,()=>n)}slicePlaneEnabledChanged(){if(Object(r["k"])(this._material)&&this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),Object(r["k"])(this._outlineMaterial)){const e={slicePlaneEnabled:this._context.slicePlaneEnabled};this._outlineMaterial.setParameterValues(e)}return!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}_createAs3DShape(e,t,i){const a=z(e.geometry);if(Object(r["j"])(a))return null;qs.renderData=U(a,this._context.elevationProvider,this._context.renderCoordsHelper,i),qs.color=t;const n=qs.renderData.position.length/3;if(this._needsUV&&(qs.uvMapSpace=new Float32Array(4*n),qs.boundingRect=new Float64Array(9*n)),qs.outNum=0,qs.outGeometries=[],qs.outTransforms=[],qs.outMaterials=[],this._createAs3DShapeFill(qs),this._hasOutline&&this._createAs3DShapeOutline(qs),this._logGeometryCreationWarnings(qs.renderData,a.rings,"rings","FillSymbol3DLayer"),0===qs.outNum)return null;this._needsUV&&is(O["C"].fromTypedArray(qs.uvMapSpace),O["v"].fromTypedArray(qs.renderData.position),this._context.renderCoordsHelper,O["g"].fromTypedArray(qs.boundingRect));const o=new S["a"]({geometries:qs.outGeometries,materials:qs.outMaterials,transformations:qs.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:e.uid}}),c=Gs,l=new s["a"](this,o,qs.outGeometries,null,null,c,i);return l.alignedSampledElevation=qs.renderData.sampledElevation,l.needsElevationUpdates=Object(P["f"])(i.mode),l}_createAs3DShapeFill(e){const t=e.renderData.polygons;for(const{position:i,mapPosition:a,holeIndices:n,index:s,count:o}of t){if(Object(r["k"])(this._context.clippingExtent)&&(Object(x["k"])(Ns),Object(x["n"])(Ns,a),!Object(x["x"])(Ns,this._context.clippingExtent)))continue;const t=Object(v["b"])(a,n,3);if(0===t.length)continue;const c=new Uint32Array(t),l=k({indices:c,attributeData:{position:i,color:e.color,mapPosition:a,uvMapSpace:this._needsUV?new Float32Array(e.uvMapSpace.buffer,4*s*e.uvMapSpace.BYTES_PER_ELEMENT,4*o):null,boundingRect:this._needsUV?new Float64Array(e.boundingRect.buffer,9*s*e.boundingRect.BYTES_PER_ELEMENT,9*o):null}});e.outGeometries.push(l),e.outMaterials.push(Object(r["t"])(this._material)),e.outTransforms.push(g["a"]),e.outNum++}}_createAs3DShapeOutline(e){if(!this._hasOutline)return;const t=e.renderData.outlines,i=this._outlineMaterial instanceof Ti["a"];for(let a=0;a<t.length;++a){const{mapPosition:n,position:s}=t[a];if(Object(r["k"])(this._context.clippingExtent)&&(Object(x["k"])(Ns),Object(x["n"])(Ns,n),!Object(x["x"])(Ns,this._context.clippingExtent)))continue;const o=Object(Tt["a"])({removeDuplicateStartEnd:i?0:1,attributeData:{position:s,mapPosition:n}}),c=o.vertexAttributes.get("position");c.data===s&&(c.data=new Float64Array(s)),e.outGeometries.push(o),e.outMaterials.push(Object(r["t"])(this._outlineMaterial)),e.outTransforms.push(g["a"]),e.outNum++}}_createAsOverlay(e,t){const i=z(e.geometry);if(Object(r["j"])(i))return null;Object(r["t"])(this._material).renderPriority=this._renderPriority+this._renderPriorityStep/2,Object(r["k"])(this._outlineMaterial)&&(this._outlineMaterial.renderPriority=this._renderPriority),Ws.renderData=G(i,this._context.overlaySR),Ws.color=t;const a=Ws.renderData.position.length/3;return this._needsUV&&(Ws.uvMapSpace=new Float32Array(4*a)),Ws.outNum=0,Ws.outGeometries=[],Ws.outBoundingBox=Object(x["k"])(),Ws.layerUid=this._context.layer.uid,Ws.graphicsUid=e.uid,this._createAsOverlayFill(Ws),this._hasOutline&&this._createAsOverlayOutline(Ws),this._logGeometryCreationWarnings(Ws.renderData,i.rings,"rings","FillSymbol3DLayer"),0===Ws.outNum?null:(this._needsUV&&ts(O["C"].fromTypedArray(Ws.uvMapSpace),O["v"].fromTypedArray(Ws.renderData.position),this._context.overlaySR),Ws.outNum>0?new Le(this,Ws.outGeometries,Ws.outBoundingBox):null)}_createAsOverlayFill(e){const t=e.renderData.polygons;for(const{position:i,holeIndices:a,index:n,count:s}of t){if(Object(x["k"])(Ns),Object(x["n"])(Ns,i),!Object(x["x"])(Ns,this._context.clippingExtent))continue;const t=Object(v["b"])(i,a,3);if(0===t.length)continue;Object(x["m"])(e.outBoundingBox,Ns);const o=new Uint32Array(t),c=k({indices:o,attributeData:{position:i,color:e.color,uvMapSpace:this._needsUV?new Float32Array(e.uvMapSpace.buffer,4*n*e.uvMapSpace.BYTES_PER_ELEMENT,4*s):null}}),l=new lt["a"](c,Object(r["t"])(this._material),e.layerUid,e.graphicsUid),h=Ns;Object(xe["l"])(l.boundingSphere,.5*(h[0]+h[3]),.5*(h[1]+h[4]),0,.5*Math.sqrt((h[3]-h[0])*(h[3]-h[0])+(h[4]-h[1])*(h[4]-h[1]))),e.outGeometries.push(l),e.outNum++}}_createAsOverlayOutline(e){if(!this._hasOutline)return;const t=e.renderData.outlines;for(let i=0;i<t.length;++i){const{position:a}=t[i];if(Object(x["k"])(Ns),Object(x["n"])(Ns,a),!Object(x["x"])(Ns,this._context.clippingExtent))continue;Object(x["m"])(e.outBoundingBox,Ns);const n=this._outlineMaterial instanceof Ti["a"],s=Object(Tt["a"])({removeDuplicateStartEnd:n?0:1,attributeData:{position:a}}),o=new lt["a"](s,Object(r["t"])(this._outlineMaterial),e.layerUid,e.graphicsUid),c=Ns;Object(xe["l"])(o.boundingSphere,.5*(c[0]+c[3]),.5*(c[1]+c[4]),0,.5*Math.sqrt((c[3]-c[0])*(c[3]-c[0])+(c[4]-c[1])*(c[4]-c[1]))),e.outGeometries.push(o),e.outNum++}}_getOutlineOpacity(){const e=Object(r["i"])(this.symbolLayer,"outline","color");return(this.draped?1:this._getLayerOpacity())*(Object(r["k"])(e)?e.a:0)}_getOutlineColor(){const e=Object(r["i"])(this.symbolLayer,"outline","color"),t=this._getOutlineOpacity();return Object(T["g"])(Object(r["k"])(e)?me["a"].toUnitRGB(e):null,t)}get test(){return{createAsOverlay:(e,t)=>this._createAsOverlay(e,t),createAs3DShape:(e,t,i)=>this._createAs3DShape(e,t,i)}}}Hs.elevationModeChangeTypes={definedChanged:P["a"].RECREATE,staysOnTheGround:P["a"].NONE,onTheGroundChanged:P["a"].RECREATE};const Ns=Object(x["h"])(),qs={renderData:null,color:null,uvMapSpace:null,boundingRect:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},Ws={renderData:null,color:null,uvMapSpace:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};var Zs=i("38bf"),$s=i("a37d"),Qs=i("003f"),Xs=i("c514"),Ys=i("a1ff"),Ks=i("0494");class Js extends Qs["a"]{constructor(e,t,i){super(),this.type=4,this._glTexture=null,this.events=new br["a"],this._requiresPowerOfTwo=!Object(Xs["a"])(e.gl),this._renderer=new Ks["a"](t,i)}get width(){return this._renderer.renderedWidth}get height(){return this._renderer.renderedHeight}get textureWidth(){const e=this.width;return this._requiresPowerOfTwo?Object(ke["o"])(e):e}get textureHeight(){const e=this.height;return this._requiresPowerOfTwo?Object(ke["o"])(e):e}get displayWidth(){return this._renderer.displayWidth}get displayHeight(){return this._renderer.displayHeight}get texcoordScale(){return[this._renderer.renderedWidth/this.textureWidth,this._renderer.renderedHeight/this.textureHeight]}get requiresFrameUpdates(){return!1}createDescriptor(e){return{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,flipped:!0,samplingMode:9987,hasMipmap:!0,preMultiplyAlpha:!0,maxAnisotropy:e.parameters.maxMaxAnisotropy}}load(e){if(Object(r["k"])(this._glTexture))return this._glTexture;const t=Object(Ks["b"])(eo,this.textureWidth,this.textureHeight),i=t.getContext("2d");return i.save(),this._renderer.render(i,0,this.textureHeight-this._renderer.renderedHeight),this._glTexture=new Ys["a"](e,this.createDescriptor(e),t),i.restore(),this._glTexture}unload(){Object(r["k"])(this._glTexture)&&(this._glTexture.dispose(),this._glTexture=null),this.events.emit("unloaded")}}const eo={canvas:null};var to=Js;const io=[0,0,1];class ro extends M["a"]{constructor(e,t,i,r){super(e,t,i,r),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const e=Object(T["k"])(this.symbolLayer.size);if(e)throw new d["a"]("graphics3dtextsymbollayer:invalid-size",e)}this._createTextRenderParameters()}_createTextRenderParameters(){const e=this._context.layerView.view.pixelRatio;this._textRenderParameters=$s["a"].fromSymbol(this.symbolLayer,e)}destroy(){super.destroy()}createGraphics3DGraphic(e){const t=e.graphic,i=Object(Ce["d"])(t.geometry);if(Object(r["j"])(i))return this.logger.warn("unsupported geometry type for text symbol: "+t.geometry.type),null;const a=this.symbolLayer.text;if(!a)return null;const n=Object(Zs["d"])(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?this.symbol:null;return this._createAs3DShape(t,i,a,n)}createLabel(e,t,i,a){const n=e.graphic,s=Object(Ce["d"])(n.geometry);if(Object(r["j"])(s))return this.logger.warn("unsupported geometry type for label: "+n.geometry.type),null;const o=t.text;return!o||/^\s+$/.test(o)?null:this._createAs3DShape(n,s,o,t,t,i,a)}setGraphicElevationContext(e,t,i=0){const r=super.setGraphicElevationContext(e,t);return r.addOffsetRenderUnits(i),r}layerOpacityChanged(){return this.logger.warn("layer opacity change not yet implemented in Graphics3DTextSymbolLayer"),!1}layerElevationInfoChanged(e,t){return ao(e,t,(e,t)=>{this.updateGraphicElevationContext(t,e)}),P["a"].UPDATE}slicePlaneEnabledChanged(e,t){return ao(e,t,e=>{for(const t of e.stageObject.geometryRecords)t.material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled})}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!1}updateGraphicElevationContext(e,t){this.setGraphicElevationContext(e,t.elevationContext,t.metadata.elevationOffset),t.needsElevationUpdates=Object(P["f"])(t.elevationContext.mode)||"absolute-height"===t.elevationContext.mode}_defaultElevationInfoNoZ(){return no}_createAs3DShape(e,t,i,a,n=so,o,c){const l=this.setGraphicElevationContext(e,new A["a"],n.elevationOffset),h="polyline"===Object(r["i"])(e.geometry,"type"),d=e.uid,u=this._context.stage.renderView.renderingContext,p=n.anchor in T["h"]?n.anchor:"center",f=T["h"][p],m=Object(r["j"])(c)?new to(u,i,this._textRenderParameters):null,b={occlusionTest:!0,screenOffset:n.screenOffset,anchorPos:f,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:n.centerOffsetUnits,debugDrawBorder:n.debugDrawBorder,drawInSecondSlot:!0};if(Object(r["k"])(m)&&(b.textureId=m.id,b.texCoordScale=m.texcoordScale),Object(r["k"])(c)&&(b.textureId=c.id),Object(r["k"])(a)&&Object(r["k"])(a.verticalOffset)){const{screenLength:e,minWorldLength:t,maxWorldLength:i}=a.verticalOffset;b.verticalOffset={screenLength:Object(ge["h"])(e),minWorldLength:t||0,maxWorldLength:null!=i?i:1/0}}if(this._context.screenSizePerspectiveEnabled){const{screenSizePerspectiveSettings:e,screenSizePerspectiveSettingsLabels:t}=this._context.sharedResources;b.screenSizePerspective=t.overridePadding(this._textRenderParameters.haloSize),b.screenSizePerspectiveAlignment=e}let g;if(h&&(b.shaderPolygonOffset=1e-4),b.slicePlaneEnabled=this._context.slicePlaneEnabled,Object(r["k"])(o)){const e=JSON.stringify(b);g=o.get(e),Object(r["j"])(g)&&(g=new we["a"](b),o.add(e,g))}else g=new we["a"](b);const v=[g],y=n.translation,O=Object(r["k"])(m)?[m.displayWidth,m.displayHeight]:[0,0],_=n.centerOffset,x=io,j=[0,0],w=[je["a"].createPointGeometry(x,y,null,O,_,j,null)],S=this._context.layer.uid,C=Object(Ce["a"])(this._context,t,w,v,null,null,l,S,d);if(null===C)return null;const R=Se["b"],M=new s["a"](this,C.object,w,Object(r["j"])(o)?v:null,Object(r["k"])(m)?[m]:null,R,l);M.alignedSampledElevation=C.sampledElevation,M.needsElevationUpdates=Object(P["f"])(l.mode)||"absolute-height"===l.mode;const{displayWidth:E,displayHeight:D}=Object(r["k"])(m)?m:n;M.getScreenSize=(e=Object(Oe["b"])())=>(e[0]=E,e[1]=D,e);const I={labelText:i,elevationOffset:n.elevationOffset};return M.metadata=I,Object(Ce["b"])(M,t,this._context.elevationProvider),M}}function ao(e,t,i){e&&e.forEach(e=>{const a=t(e);Object(r["k"])(a)&&i(a,e.graphic)})}const no={mode:"relative-to-ground",offset:0},so={text:null,translation:[0,0,0],elevationOffset:0,centerOffset:[0,0,0,1],screenOffset:[0,0],anchor:"center",verticalOffset:null,centerOffsetUnits:null,debugDrawBorder:!1,displayWidth:0,displayHeight:0};var oo=i("8048");const co={waveStrength:.06,waveTextureRepeat:32,waveDirection:Object(Oe["f"])(1,0),waveVelocity:.05,flowStrength:.015,flowOffset:-.5,animationSpeed:.35,color:[0,0,0,0],transparent:!0,writeDepth:!0,slicePlaneEnabled:!1,isDraped:!1,receiveShadows:!0,ssrEnabled:!1,...mn["b"]},lo={"calm-small":{waveStrength:.005,perturbationStrength:.02,textureRepeat:12,waveVelocity:.01},"rippled-small":{waveStrength:.02,perturbationStrength:.09,textureRepeat:32,waveVelocity:.07},"slight-small":{waveStrength:.05,perturbationStrength:.07,textureRepeat:28,waveVelocity:.1},"moderate-small":{waveStrength:.075,perturbationStrength:.07,textureRepeat:24,waveVelocity:.1},"calm-medium":{waveStrength:.003125,perturbationStrength:.01,textureRepeat:8,waveVelocity:.02},"rippled-medium":{waveStrength:.035,perturbationStrength:.015,textureRepeat:12,waveVelocity:.07},"slight-medium":{waveStrength:.06,perturbationStrength:.015,textureRepeat:8,waveVelocity:.12},"moderate-medium":{waveStrength:.09,perturbationStrength:.03,textureRepeat:4,waveVelocity:.12},"calm-large":{waveStrength:.01,perturbationStrength:0,textureRepeat:4,waveVelocity:.05},"rippled-large":{waveStrength:.025,perturbationStrength:.01,textureRepeat:8,waveVelocity:.11},"slight-large":{waveStrength:.06,perturbationStrength:.02,textureRepeat:3,waveVelocity:.13},"moderate-large":{waveStrength:.14,perturbationStrength:.03,textureRepeat:2,waveVelocity:.15}};var ho=i("f498"),uo=i("a445"),po=i("d4ca");class fo{constructor(e=!0){this.enabled=e,this._time=0}get time(){return Object(r["k"])(this._forcedTime)?this._forcedTime:Object(po["a"])(this._time)}advance(e){this.enabled&&(this._time+=e)}stopAtTime(e){this._forcedTime=e}}class mo extends mn["a"]{constructor(e){super(e,co),this.animation=new fo,this.techniqueConfig=new ho["b"]}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.writeDepth=this.params.writeDepth,this.techniqueConfig.receiveShadows=this.params.receiveShadows,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.transparent=this.params.transparent,this.techniqueConfig.useSSR=this.params.ssrEnabled,this.techniqueConfig.isDraped=this.params.isDraped,this.techniqueConfig.transparencyPassType=t?t.transparencyPassType:3,this.techniqueConfig.enableOffset=!t||t.camera.relativeElevation<Sn["e"],this.techniqueConfig.multipassTerrainEnabled=!!t&&t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=!t||t.cullAboveGround,this.techniqueConfig}update(e){const t=Math.min(e.camera.relativeElevation,e.camera.distance);return this.animation.enabled=Math.sqrt(this.params.waveTextureRepeat/this.params.waveStrength)*t<bo,this.animation.advance(e.dt),this.animation.enabled}intersect(e,t,i,r,a,n,s){Object(fr["i"])(e,t,r,a,n,void 0,s)}getGLMaterial(e){if(0===e.output&&this.params.isDraped){const t=e;return t.output=5,new uo["a"](t)}switch(e.output){case 0:case 2:case 4:case 7:return new uo["a"](e)}}createBufferWriter(){return new ws["a"](ws["d"])}}const bo=35e3,go=["polyline","polygon","extent"];class vo extends M["a"]{constructor(e,t,i,r){super(e,t,i,r)}async doLoad(){}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,go,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(t,new A["a"]);return this.ensureDrapedStatus("on-the-ground"===i.mode),this.ensureMaterial(),this.draped?this._createAsOverlay(t):this._createAs3DShape(t,i,t.uid)}ensureMaterial(){if(Object(r["k"])(this._material))return;const e={...co},t=this.symbolLayer.color;Object(r["k"])(t)&&(e.color=me["a"].toUnitRGBA(t));const i=this._getCombinedOpacity(t,{hasIntrinsicColor:!0});e.color=[e.color[0],e.color[1],e.color[2],i],e.transparent=i<1||this.needsDrivenTransparentPass,e.waveDirection=Object(r["k"])(this.symbolLayer.waveDirection)?vo.headingVectorFromAngle(this.symbolLayer.waveDirection):Object(Oe["f"])(0,0);const a=this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize,n=lo[a];e.waveStrength=n.waveStrength,e.waveTextureRepeat=n.textureRepeat,e.waveVelocity=n.waveVelocity,e.flowStrength=n.perturbationStrength,e.slicePlaneEnabled=this._context.slicePlaneEnabled,e.isDraped=this.draped,this._material=new mo(e),this._context.stage.add(this._material)}layerOpacityChanged(){if(Object(r["j"])(this._material))return!0;const e=this._material.params.color,t=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0}),i=t<1||this.needsDrivenTransparentPass;return this._material.setParameterValues({color:[e[0],e[1],e[2],t],transparent:i}),!0}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,a=Object(P["d"])(vo.elevationModeChangeTypes,i,r);if(a!==P["a"].UPDATE)return a;const n=Object(P["f"])(r);return this.updateGraphics3DGraphicElevationInfo(e,t,()=>n)}slicePlaneEnabledChanged(){return Object(r["k"])(this._material)&&this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}_createAs3DShape(e,t,i){const a=z(e.geometry);if(Object(r["j"])(a))return null;jo.renderData=U(a,this._context.elevationProvider,this._context.renderCoordsHelper,t);const n=jo.renderData.position.length/3;if(jo.uvCoords=new Float64Array(2*n),jo.outNum=0,jo.outGeometries=[],jo.outTransforms=[],jo.outMaterials=[],this._create3DShapeGeometries(jo),this._logGeometryCreationWarnings(jo.renderData,a.rings,"rings","WaterSymbol3DLayer"),0===jo.outNum)return null;this._createUVCoordsFromVertices(jo.uvCoords,jo.renderData.mapPosition,n,this._context.elevationProvider.spatialReference);const o=new S["a"]({geometries:jo.outGeometries,materials:jo.outMaterials,transformations:jo.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:i}}),c=Se["c"],l=new s["a"](this,o,jo.outGeometries,null,null,c,t);return l.alignedSampledElevation=jo.renderData.sampledElevation,l.needsElevationUpdates=Object(P["f"])(t.mode),l}_createUVCoordsFromVertices(e,t,i,r){const a=Object(oo["e"])(r);Object(Ae["n"])(Oo);for(let o=0;o<i;o++)Object(na["s"])(_o,t[3*o+0],t[3*o+1]),Object(Ae["q"])(Oo,_o);Object(xe["b"])(Oo,Oo,a);const n=Oo[0]%vo.unitSizeOfTexture,s=Oo[1]%vo.unitSizeOfTexture;yo[0]=Oo[0]-n,yo[1]=Oo[1]-s;for(let o=0;o<i;o++)e[2*o+0]=(t[3*o+0]*a-yo[0])/vo.unitSizeOfTexture,e[2*o+1]=(t[3*o+1]*a-yo[1])/vo.unitSizeOfTexture}_create3DShapeGeometries(e){const t=e.renderData.polygons,i=e.uvCoords;for(const{count:a,index:n,position:s,mapPosition:o,holeIndices:c}of t){if(Object(r["k"])(this._context.clippingExtent)&&(Object(x["k"])(xo),Object(x["n"])(xo,o),!Object(x["x"])(xo,this._context.clippingExtent)))continue;const t=Object(v["b"])(o,c,3);if(0===t.length)continue;const l=new Uint32Array(t),h=new Float64Array(i.buffer,2*n*i.BYTES_PER_ELEMENT,2*a),d=F({indices:l,attributeData:{position:s,uv0:h,mapPosition:o}});e.outGeometries.push(d),e.outMaterials.push(Object(r["t"])(this._material)),e.outTransforms.push(g["a"]),e.outNum++}}_createAsOverlay(e){const t=z(e.geometry);if(Object(r["j"])(t))return null;Object(r["t"])(this._material).renderPriority=this._renderPriority,wo.renderData=G(t,this._context.overlaySR);const i=wo.renderData.position.length/3;return wo.uvCoords=new Float64Array(2*i),wo.outNum=0,wo.outGeometries=[],wo.outBoundingBox=Object(x["k"])(),wo.layerUid=this._context.layer.uid,wo.graphicsUid=e.uid,this._createAsOverlayWater(wo),this._logGeometryCreationWarnings(wo.renderData,t.rings,"rings","WaterSymbol3DLayer"),0===wo.outNum?null:(this._createUVCoordsFromVertices(wo.uvCoords,wo.renderData.position,i,this._context.overlaySR),wo.outNum>0?new Le(this,wo.outGeometries,wo.outBoundingBox):null)}_createAsOverlayWater(e){const t=e.uvCoords,i=e.renderData.polygons;for(const{position:a,holeIndices:n,index:s,count:o}of i){if(Object(x["k"])(xo),Object(x["n"])(xo,a),!Object(x["x"])(xo,this._context.clippingExtent))continue;Object(x["m"])(e.outBoundingBox,xo);const i=Object(v["b"])(a,n,3);if(0===i.length)continue;const c=new Uint32Array(i),l=new Float64Array(t.buffer,2*s*t.BYTES_PER_ELEMENT,2*o),h=F({indices:c,attributeData:{position:a,uv0:l}}),d=new lt["a"](h,Object(r["t"])(this._material),e.layerUid,e.graphicsUid),u=xo;Object(xe["l"])(d.boundingSphere,.5*(u[0]+u[3]),.5*(u[1]+u[4]),0,.5*Math.sqrt((u[3]-u[0])*(u[3]-u[0])+(u[4]-u[1])*(u[4]-u[1]))),e.outGeometries.push(d),e.outNum++}}static headingVectorFromAngle(e){const t=Object(Oe["b"])(),i=Object(ca["d"])(e);return t[0]=Math.sin(i),t[1]=Math.cos(i),t}get test(){return{create3DShape:e=>this._createAs3DShape(e.graphic,e.elevationContext,e.graphicUid),ensureMaterial:()=>this.ensureMaterial()}}}vo.unitSizeOfTexture=100,vo.elevationModeChangeTypes={definedChanged:P["a"].RECREATE,staysOnTheGround:P["a"].NONE,onTheGroundChanged:P["a"].RECREATE};const yo=Object(Oe["b"])(),Oo=Object(Ae["l"])(),_o=Object(Oe["b"])(),xo=Object(x["h"])(),jo={renderData:null,uvCoords:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},wo={renderData:null,uvCoords:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};const So=h["a"].getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayerFactory");function Co(e,t,i,r){const a=Po[e.type]&&Po[e.type][t.type]||To[t.type];return a?new a(e,t,i,r):(So.error("GraphicsLayerFactory#make","unknown symbol type "+t.type),null)}const To={icon:yt,object:Jr,line:At,path:Gn,fill:Hs,extrude:W,text:ro,water:vo};const Po={"mesh-3d":{fill:Ai}};class Ao extends o["a"]{constructor(e,t,i){super(),this._symbol=e,this._context=t,this._backgroundLayers=i,this._destroyed=!1,this.symbolLayers=[],this.referenced=0,this._extentPadding=0}set symbol(e){if(this._symbol=e,this.symbolLayers)for(let t=0;t<e.symbolLayers.length;t++){const i=this.symbolLayers[t];Object(r["j"])(i)||(i.symbol=e,i.symbolLayer=e.symbolLayers.items[t])}}get symbol(){return this._symbol}async doLoad(e){let t=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(t=this._backgroundLayers.concat(t));const i=t.length;for(;this.symbolLayers.length<t.length;)this.symbolLayers.push(null);this.symbolLayers.length=t.length;const s=[];for(let r=0;r<i;r++){const n=t.getItemAt(r);if(!1===n.enabled)continue;Ro.renderPriority=1-(1+r)/i,Ro.renderPriorityStep=1/i,Ro.ignoreDrivers=n._ignoreDrivers;const o=Co(this.symbol,n,this._context,Ro);s.push(Object(a["s"])(e,()=>{this.symbolLayers[r]=null,o.destroy()})),this.symbolLayers[r]=o}await Object(n["b"])(this.symbolLayers,async(e,t)=>{if(Object(r["k"])(e))try{await e.load(),this._extentPadding+=Math.max(this._extentPadding,e.extentPadding)}catch{this.symbolLayers[t]=null}});for(const r of s)null==r||r.remove();if(s.length=0,Object(a["w"])(e),this.symbolLayers.length&&!this.symbolLayers.some(e=>!!e))throw new Error}getSymbolLayerSize(e){const t=this.symbolLayers[e];return Object(r["k"])(t)?t.getCachedSize():null}get extentPadding(){return this._extentPadding}createGraphics3DGraphic(e,t){const i=e.graphic,a=new Array(this.symbolLayers.length);for(let s=0;s<this.symbolLayers.length;s++){const t=this.symbolLayers[s];a[s]=Object(r["k"])(t)?t.createGraphics3DGraphic(e):null}const n=this._context.arcade||this._context.featureExpressionInfoContext&&this._context.featureExpressionInfoContext.arcade&&this._context.featureExpressionInfoContext.arcade.modules||null;return new l["a"](i,t||this,a,e.layer,n)}get complexity(){return Object(c["f"])(this.symbolLayers.map(e=>Object(r["i"])(e,"complexity")))}globalPropertyChanged(e,t){const i=this.symbolLayers.length;for(let a=0;a<i;a++){const i=this.symbolLayers[a],n=e=>{const t=e._graphics[a];return t instanceof s["a"]?t:null};if(Object(r["k"])(i)&&!i.globalPropertyChanged(e,t,n))return!1}return!0}applyRendererDiff(e,t){return 1===this.loadStatus&&this.symbolLayers.reduce((i,a)=>i&&(Object(r["j"])(a)||a.applyRendererDiff(e,t)),!0)}prepareSymbolPatch(e){if(2===this.loadStatus)return;if("partial"!==e.diff.type)return;const t=e.diff.diff;if(!t.symbolLayers||"partial"!==t.symbolLayers.type)return;const i=t.symbolLayers.diff;this.symbolLayers.forEach((t,a)=>{if(Object(r["j"])(t))return;const n=i[a];if(n){const i={diff:n,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};t.prepareSymbolLayerPatch(i),e.symbolStatePatches.push(...i.symbolLayerStatePatches),i.graphics3DGraphicPatches.length&&e.graphics3DGraphicPatches.push((e,t)=>{const n=e._graphics[a];Object(r["k"])(n)&&i.graphics3DGraphicPatches.forEach(e=>e(n,t))})}})}updateGeometry(e,t){for(let i=0;i<this.symbolLayers.length;i++){const a=this.symbolLayers[i];if(Object(r["j"])(a))continue;const n=e._graphics[i];if(Object(r["j"])(n)||!a.updateGeometry(n,t))return!1}return!0}onRemoveGraphic(e){for(let t=0;t<this.symbolLayers.length;t++){const i=this.symbolLayers[t];if(Object(r["j"])(i))continue;const a=e._graphics[t];Object(r["k"])(a)&&i.onRemoveGraphic(a)}}getFastUpdateStatus(){let e=0,t=0,i=0;return this.symbolLayers.forEach(a=>{Object(r["j"])(a)||(0===a.loadStatus?e++:a.isFastUpdatesEnabled()?i++:t++)}),{loading:e,slow:t,fast:i}}destroy(){if(this.destroyed)console.error("Graphics3DSymbol.destroy called when already destroyed!");else{this.abortLoad();for(const e of this.symbolLayers)Object(r["k"])(e)&&e.destroy();this.symbolLayers.length=0,this._destroyed=!0}}get destroyed(){return this._destroyed}}const Ro={renderPriority:0,renderPriorityStep:1,ignoreDrivers:!1};t["a"]=Ao},6469:function(e,t,i){"use strict";i.d(t,"a",(function(){return j}));var r=i("a4ee"),a=(i("c120"),i("7ffa")),n=i("b2b2"),s=(i("e92d"),i("cea0"),i("59b2"),i("d386")),o=(i("e041"),i("8eed"),i("f402"),i("f4cc")),c=i("4ae5"),l=(i("e06a"),i("ce6d")),h=i("a915"),d=i("af40"),u=i("9305"),p=i("3563"),f=i("8b1a"),m=i("6ae9"),b=i("27df"),g=i("1f1c"),v=i("c20d"),y=i("3510"),O=i("feba");class _{constructor({grabbableForEvent:e}){this.events=new l["a"],this.interactive=!0,this.selectable=!1,this.cursor=null,this.grabbable=!0,this.grabbableForEvent=e}intersectionDistance(e,t){return 0}attach(){}detach(){}}var x=i("4aea");let j=class extends l["a"]{constructor(e){var t,i;super(),this._manipulator=null,this._stagedVertex=null,this.geometryType=null,this.elevationInfo=null,this.snapToSceneEnabled=null,this._handles=new d["a"],this._defaultZ=0,this._elevationDrawSurface=null,this._snappingDrawSurface=null,this._snappingManager=null,this._snappingPipeline=new y["a"],this._createOperationCompleted=!1,this._pointerDownStates=new Set,this._snappingTask=null,this.view=e.view,this.drawingMode=Object(n["u"])(e.drawingMode,x["a"]),this.geometryType=e.geometryType,this.elevationInfo=e.elevationInfo,this.coordinateHelper=Object(f["a"])(e.hasZ,e.hasM,this.view.spatialReference,this.view.viewingMode),this._defaultZ=e.defaultZ,this.snapToSceneEnabled=e.snapToSceneEnabled,this._snappingDrawSurface=Object(n["t"])(e.snappingDrawSurface),this._snappingManager=e.snappingManager;const r=null==(t=e.view)||null==(i=t.resourceController)?void 0:i.scheduler;this._frameTask=r?r.registerTask(u["b"].SNAPPING,e=>this._frameTask.processQueue(e),()=>!1):u["a"],this._elevationDrawSurface=e.elevationDrawSurface,this._editGeometry=new b["a"](new m["c"](this.coordinateHelper),"segment"===this.geometryType?"polyline":this.geometryType),this._activeComponent=new m["a"](this._editGeometry.editGeometry),this._editGeometry.editGeometry.components.push(this._activeComponent),this._editGeometry.on(["vertex-add","vertex-update","vertex-remove"],e=>{const t=e.vertices.map(e=>({componentIndex:0,vertexIndex:e.index,coordinates:this.coordinateHelper.toArray(e.pos)})),i=t.map(e=>e.coordinates);switch(e.type){case"vertex-add":this.emit(e.type,{...e,added:i,vertices:t});break;case"vertex-update":this.emit(e.type,{...e,updated:i,vertices:t});break;case"vertex-remove":this.emit(e.type,{...e,removed:i,vertices:t})}}),this._manipulator=new _({grabbableForEvent:e=>"click"!==this.drawingMode||"touch"===e.pointerType&&this._snappingEnabled&&1===this._pointerDownStates.size}),e.manipulators.add(this._manipulator),this._manipulator.grabbable="point"!==this.geometryType;const a=this.createManipulatorDragPipeline(this._manipulator),s=this._manipulator.events.on("immediate-double-click",e=>{this._manipulator.dragging||"point"===this.geometryType||(this.complete(),e.stopPropagation())}),o=this._manipulator.events.on("immediate-click",e=>{if(this._manipulator.dragging)return;const t=this._activeComponent,i=this._closeOnClickVertexIndex(e.screenPoint);if(Object(n["k"])(i))this.discardStagedVertex(),this.complete();else{const i=this._screenToMap(e.screenPoint);if(Object(n["k"])(i))switch(this.drawingMode){case"freehand":break;case"click":case"hybrid":this._snappingTask=Object(n["a"])(this._snappingTask),this.hasStagedVertex?this.commitStagedVertex():this._editGeometry.appendVertex(this.coordinateHelper.fromPoint(i)),("point"===this.geometryType||"segment"===this.geometryType&&2===t.vertices.length||"segment"===this.geometryType&&"hybrid"===this.drawingMode&&1===t.vertices.length)&&this.complete()}}e.stopPropagation()});this._handles.add([a,o,s])}get isCompleted(){return this._createOperationCompleted}get _snappingEnabled(){return Object(n["k"])(this._snappingManager)&&this._snappingManager.options.effectiveEnabled}createManipulatorDragPipeline(e){switch(this.drawingMode){case"click":return this.createManipulatorDragPipelineClick(e);case"freehand":return this.createManipulatorDragPipelineFreehand(e);case"hybrid":return this.createManipulatorDragPipelineHybrid(e)}}createManipulatorDragPipelineClick(e){return Object(v["e"])(e,(e,t,i,r)=>{const a="touch"===r&&this._snappingEnabled;!this.isCompleted&&a&&(t.next(this._screenToMapDragEventStep()).next(e=>("start"===e.action&&(this.stagedVertex=e.mapStart,("segment"===this.geometryType||a&&0===this.vertices.length)&&this.commitStagedVertex()),e)).next(this._snappingPipeline.createSnapDragEventPipelineStep({predicate:()=>a,cancel:i,snappingManager:this._snappingManager,snappingContext:new g["a"]({geometry:this._editGeometry,elevationInfo:this.elevationInfo,pointer:r,visualizer:new O["a"]})}),this._snappingPipeline.next).next(e=>(a&&(this.stagedVertex=e.mapEnd,"end"===e.action&&this.commitStagedVertex()),e)).next(e=>("end"===e.action&&("segment"!==this.geometryType&&"point"!==this.geometryType||this.complete()),e)),i.next(()=>{a&&Object(n["k"])(this._snappingManager)&&this._snappingManager.doneSnapping()}))})}createManipulatorDragPipelineFreehand(e){return Object(v["e"])(e,(e,t)=>{this.isCompleted||t.next(this._screenToMapDragEventStep()).next(e=>("start"===e.action&&(this.stagedVertex=e.mapStart,"segment"===this.geometryType&&this.commitStagedVertex()),e)).next(e=>{switch(e.action){case"start":case"update":this.stagedVertex=e.mapEnd,"polygon"!==this.geometryType&&"polyline"!==this.geometryType||this.commitStagedVertex();break;case"end":this.complete()}return e})})}createManipulatorDragPipelineHybrid(e){return Object(v["e"])(e,(e,t)=>{this.isCompleted||t.next(this._screenToMapDragEventStep()).next(e=>("start"===e.action&&(this.stagedVertex=e.mapStart,this.commitStagedVertex()),e)).next(e=>{switch(e.action){case"start":case"update":this.stagedVertex=e.mapEnd,"polygon"!==this.geometryType&&"polyline"!==this.geometryType||this.commitStagedVertex();break;case"end":"segment"!==this.geometryType&&"point"!==this.geometryType||this.complete()}return e})})}destroy(){this._handles.destroy(),this._handles=null,this._editGeometry.destroy(),this._frameTask.remove()}onInputEvent(e){switch(e.type){case"pointer-down":this._pointerDownStates.add(e.pointerId);break;case"pointer-up":this._pointerDownStates.delete(e.pointerId)}switch(e.type){case"pointer-move":return this._onPointerMove(e);case"hold":return this._onHold(e)}}get canRedo(){return this._editGeometry.canRedo}redo(){this._editGeometry.redo()}get canUndo(){return this._editGeometry.canUndo}undo(){Object(n["k"])(this._snappingManager)&&this._snappingManager.doneSnapping(),this._editGeometry.undo()}complete(e=!1){Object(n["a"])(this._snappingTask),this.commitStagedVertex(),this._createOperationCompleted=!0,Object(n["k"])(this._snappingManager)&&this._snappingManager.doneSnapping(),this.emit("complete",{vertices:this.vertices.map((e,t)=>({componentIndex:0,vertexIndex:t,coordinates:e})),aborted:e,type:"complete"})}cancel(){this.complete(!0)}get interactive(){return this._manipulator.interactive}set interactive(e){this._manipulator.interactive=e}get numVertices(){return Object(n["k"])(this._stagedVertex)?this._activeComponent.vertices.length+1:this._activeComponent.vertices.length}get numCommittedVertices(){return this._activeComponent.vertices.length}get vertices(){const e=this._activeComponent.vertices.map(e=>this.coordinateHelper.toArray(e.pos));return Object(n["k"])(this._stagedVertex)&&e.push(this.coordinateHelper.pointToArray(this._stagedVertex)),e}get spatialReference(){return this.view.spatialReference}get hasStagedVertex(){return Object(n["k"])(this._stagedVertex)}get stagedVertex(){return this._stagedVertex}set stagedVertex(e){if(Object(n["j"])(e))return void this.discardStagedVertex();if(Object(n["k"])(this._stagedVertex)&&Object(p["b"])(this._stagedVertex,e))return;Object(n["j"])(this._stagedVertex)?this._stagedVertex=Object(a["a"])(e):(this._stagedVertex.x=e.x,this._stagedVertex.y=e.y,this._stagedVertex.z=e.z,this._stagedVertex.m=e.m,this._stagedVertex.hasZ=e.hasZ,this._stagedVertex.hasM=e.hasM,this._stagedVertex.spatialReference=e.spatialReference);const t={componentIndex:0,vertexIndex:this._activeComponent.vertices.length,coordinates:this.coordinateHelper.pointToArray(e)};this.emit("cursor-update",{updated:null,vertices:[t],operation:"apply",type:"vertex-update"})}commitStagedVertex(){if(this._snappingTask=Object(n["a"])(this._snappingTask),Object(n["k"])(this._stagedVertex)){const e=this._stagedVertex;this._stagedVertex=null,this._editGeometry.appendVertex(this.coordinateHelper.fromPoint(e))}}discardStagedVertex(){this._stagedVertex=null}_onPointerMove(e){if(Object(n["a"])(this._snappingTask),this._manipulator.dragging||this._pointerDownStates.has(e.pointerId)||this._manipulator.grabbing||!this._manipulator.interactive)return;const t=Object(h["f"])(e.x,e.y),i=this._closeOnClickVertexIndex(t);if(Object(n["k"])(i)){this.discardStagedVertex();const e={componentIndex:0,vertexIndex:i,coordinates:this.coordinateHelper.toArray(this._activeComponent.vertices[i].pos)};this.emit("cursor-update",{updated:null,vertices:[e],operation:"apply",type:"vertex-update"})}else{const i=this._screenToMap(t);if(this._manipulator.cursor=Object(n["k"])(i)?"crosshair":null,Object(n["k"])(i))if(Object(n["k"])(this._snappingManager)){const t=this._snappingManager,r=new g["a"]({geometry:this._editGeometry,elevationInfo:this.elevationInfo,pointer:e.pointerType,visualizer:new O["a"]});this.stagedVertex=t.update(i,r),this._snappingTask=Object(o["i"])(async e=>{const a=await this._frameTask.schedule(()=>t.snap(i,r,e),e);a.valid&&await this._frameTask.schedule(()=>{this.stagedVertex=a.apply()},e)})}else this.stagedVertex=i}e.stopPropagation()}_onHold(e){Object(n["a"])(this._snappingTask),"click"===this.drawingMode&&"touch"===e.pointerType&&this._snappingEnabled&&(this.stagedVertex=e.mapPoint),e.stopPropagation()}_screenToMapDragEventStep(){let e=null;return t=>{if("start"===t.action&&(e=this._screenToMap(t.screenStart)),Object(n["j"])(e))return null;const i=this._screenToMap(t.screenEnd);return Object(n["k"])(i)?{...t,mapStart:e,mapEnd:i}:null}}_screenToMap(e){return this._getDrawSurface().screenToMap(e)}_mapToScreen(e){return this._getDrawSurface().mapToScreen(e)}_getDrawSurface(){let e=null;if(this.coordinateHelper.hasZ){let t=this._defaultZ,i=!1;Object(n["k"])(this.elevationInfo)&&"absolute-height"===this.elevationInfo.mode&&(i=!0),Object(n["k"])(this.snapToSceneEnabled)&&(i=this.snapToSceneEnabled),Object(n["k"])(this.elevationInfo)&&"on-the-ground"===this.elevationInfo.mode&&(i=!1);const r=this._activeComponent.vertices.length;("segment"===this.geometryType||"polygon"===this.geometryType)&&r>0&&(t=this.coordinateHelper.getZ(this._activeComponent.vertices[0].pos),i=!1),i?e=this._snappingDrawSurface:(this._elevationDrawSurface.defaultZ=t,e=this._elevationDrawSurface)}else this._elevationDrawSurface.defaultZ=null,e=this._elevationDrawSurface;return e}_vertexWithinPointerDistance(e,t){const i=25,r=this._mapToScreen(e);return!!Object(n["k"])(r)&&w(r,t,i)}_closeOnClickVertexIndex(e){const t=this._activeComponent;if("polygon"===this.geometryType&&t.vertices.length>2){if(this._vertexWithinPointerDistance(this.coordinateHelper.toPoint(t.vertices[0].pos,S),e))return 0;if(this._vertexWithinPointerDistance(this.coordinateHelper.toPoint(t.vertices[t.vertices.length-1].pos,S),e))return t.vertices.length-1}return null}};function w(e,t,i){const r=e.x-t.x,a=e.y-t.y;return r*r+a*a<=i}j=Object(r["a"])([Object(s["a"])("esri.views.3d.interactive.editingTools.draw3D.DrawOperation")],j);const S=new c["a"]({x:0,y:0,z:0})},"647b":function(e,t,i){"use strict";i.d(t,"a",(function(){return Z}));var r=i("b2b2"),a=i("0b2d"),n=i("e431"),s=i("d0ac"),o=i("f53a"),c=i("a997"),l=i("38a4"),h=i("02f1"),d=i("0fc4"),u=i("7577"),p=i("1153"),f=i("d5f7"),m=i("7c51"),b=i("a4ee"),g=i("d791"),v=i("afe1"),y=i("c3a4"),O=i("ca98"),_=i("da35"),x=i("8e37"),j=i("189c"),w=i("56d6");class S extends O["a"]{initializeProgram(e){const t=S.shader.get(),i=this.configuration,r=t.build(i);return new x["a"](e.rctx,r.generateSource("vertex"),r.generateSource("fragment"),S.attributeLocations)}bind(e,t,i){this.program.setUniform3fv("innerColor",e.innerColor),this.program.setUniform1f("innerWidth",e.innerWidth*i.pixelRatio),this.program.setUniform3fv("glowColor",e.glowColor),this.program.setUniform1f("glowWidth",e.glowWidth*i.pixelRatio),this.program.setUniform1f("glowFalloff",e.glowFalloff),this.program.setUniform1f("globalAlpha",e.globalAlpha),this.program.setUniform1f("perScreenPixelRatio",i.perScreenPixelRatio),this.program.setUniform2f("pixelToNDC",2/i.fullWidth,2/i.fullHeight),this.program.setUniformMatrix4fv("uProjectionMatrix",i.projectionMatrix),Object(g["t"])(T,i.viewMatrix,t),this.program.setUniformMatrix4fv("uModelViewMatrix",T),this.configuration.contrastControlEnabled&&this.program.setUniform1f("globalAlphaContrastBoost",null!=e.globalAlphaContrastBoost?e.globalAlphaContrastBoost:1)}initializePipeline(){return Object(j["e"])({blending:Object(j["g"])(1,771),colorWrite:j["c"]})}bindPipelineState(e){e.setPipelineState(this.pipeline)}}S.shader=new y["a"](w["a"],()=>i.e("chunk-2d22cca6").then(i.bind(null,"f578"))),S.attributeLocations={start:0,end:1,up:2,extrude:3};class C extends _["a"]{constructor(){super(...arguments),this.contrastControlEnabled=!1}}Object(b["a"])([Object(_["b"])()],C.prototype,"contrastControlEnabled",void 0);const T=Object(v["b"])();i("c120"),i("9f8b");var P=i("2ebb"),A=i("fc00"),R=i("7ce4"),M=i("0fa6");i("d267");class E{constructor(e){this._renderCoordsHelper=e,this._buffers=null,this._origin=Object(a["e"])(),this._dirty=!1,this._count=0,this._vao=null}set vertices(e){const t=new Float64Array(3*e.length);let i=0;for(const r of e)t[i++]=r[0],t[i++]=r[1],t[i++]=r[2];this.buffers=[t]}set buffers(e){if(this._buffers=e,this._buffers.length>0){const e=this._buffers[0],t=3*Math.floor(e.length/3/2);Object(n["x"])(this._origin,e[t+0],e[t+1],e[t+2])}else Object(n["x"])(this._origin,0,0,0);this._dirty=!0}get origin(){return this._origin}draw(e){const t=this.ensureVAO(e);Object(r["k"])(t)&&(e.bindVAO(t),e.drawArrays(4,0,this._count))}dispose(){Object(r["k"])(this._vao)&&this._vao.dispose()}ensureVAO(e){return Object(r["j"])(this._buffers)?null:(Object(r["j"])(this._vao)&&(this._vao=this.createVAO(e,this._buffers)),this.ensureVertexData(this._vao,this._buffers),this._vao)}createVAO(e,t){const i=this.createDataBuffer(t);return this._dirty=!1,new M["a"](e,S.attributeLocations,{data:Object(P["a"])(L)},{data:R["a"].createVertex(e,35044,i)})}ensureVertexData(e,t){if(!this._dirty)return;const i=this.createDataBuffer(t);e.vertexBuffers.data.setData(i),this._dirty=!1}numberOfRenderVertices(e){return 2*(e.length/3-1)*3}createDataBuffer(e){const t=e.reduce((e,t)=>e+this.numberOfRenderVertices(t),0);this._count=t;const i=L.createBuffer(t),r=this._origin;let a=0,s=0;for(const o of e){for(let e=0;e<o.length;e+=3){const t=Object(n["x"])(I,o[e+0],o[e+1],o[e+2]);0===e?s=this._renderCoordsHelper.getAltitude(t):this._renderCoordsHelper.setAltitude(s,t);const c=this._renderCoordsHelper.worldUpAtPosition(t,D),l=a+2*e,h=Object(n["k"])(I,t,r);if(e<o.length-3){i.up.setVec(l,c),i.up.setVec(l+3,c),i.up.setVec(l+5,c);for(let e=0;e<6;e++)i.start.setVec(l+e,h);i.extrude.setValues(l+0,0,-1),i.extrude.setValues(l+1,1,-1),i.extrude.setValues(l+2,1,1),i.extrude.setValues(l+3,0,-1),i.extrude.setValues(l+4,1,1),i.extrude.setValues(l+5,0,1)}if(e>0){i.up.setVec(l-2,c),i.up.setVec(l-4,c),i.up.setVec(l-5,c);for(let e=-6;e<0;e++)i.end.setVec(l+e,h)}}a+=this.numberOfRenderVertices(o)}return i.buffer}}const D=Object(a["e"])(),I=Object(a["e"])(),L=Object(A["a"])().vec3f("start").vec3f("end").vec3f("up").vec2f("extrude");var V=i("fa1e");class k extends O["a"]{initializeProgram(e){const t=k.shader.get(),i=this.configuration,r=t.build(i);return new x["a"](e.rctx,r.generateSource("vertex"),r.generateSource("fragment"),V["a"])}bind(e,t){this.program.setUniform3fv("innerColor",e.innerColor),this.program.setUniform1f("innerWidth",e.innerWidth*t.pixelRatio),this.program.setUniform3fv("glowColor",e.glowColor),this.program.setUniform1f("glowWidth",e.glowWidth*t.pixelRatio),this.program.setUniform1f("glowFalloff",e.glowFalloff),this.program.setUniform1f("globalAlpha",e.globalAlpha),this.configuration.contrastControlEnabled&&this.program.setUniform1f("globalAlphaContrastBoost",null!=e.globalAlphaContrastBoost?e.globalAlphaContrastBoost:1);const i=null!=e.angleCutoff?e.angleCutoff:c["c"];this.program.setUniform2f("angleCutoff",Math.cos(i),Math.cos(Math.max(0,i-Object(l["f"])(2)))),this.configuration.intersectsLineEnabled&&this.program.setUniform1f("perScreenPixelRatio",t.perScreenPixelRatio)}initializePipeline(){return Object(j["e"])({blending:Object(j["g"])(1,771),colorWrite:j["c"]})}}k.shader=new y["a"](c["a"],()=>i.e("chunk-2d2248f1").then(i.bind(null,"e13b")));class F extends _["a"]{constructor(){super(...arguments),this.heightManifoldEnabled=!1,this.pointDistanceEnabled=!1,this.lineVerticalPlaneEnabled=!1,this.intersectsLineEnabled=!1,this.contrastControlEnabled=!1}}Object(b["a"])([Object(_["b"])()],F.prototype,"heightManifoldEnabled",void 0),Object(b["a"])([Object(_["b"])()],F.prototype,"pointDistanceEnabled",void 0),Object(b["a"])([Object(_["b"])()],F.prototype,"lineVerticalPlaneEnabled",void 0),Object(b["a"])([Object(_["b"])()],F.prototype,"intersectsLineEnabled",void 0),Object(b["a"])([Object(_["b"])()],F.prototype,"contrastControlEnabled",void 0);const z=Object(a["e"])(),U=Object(d["c"])(),G={glowColor:[1,.5,0],glowWidth:8,glowFalloff:8,innerColor:[1,1,1],innerWidth:1,globalAlpha:.75,angleCutoff:Object(l["f"])(6),globalAlphaContrastBoost:2};function B(e,t,i,r){const a=z,o=U;Object(n["n"])(a,t,r),Object(n["l"])(o,i),o[3]=0,Object(u["m"])(o,o,r),s["f"].fromPositionAndNormal(a,o,e)}class H{constructor(e,t={},i={contrastControlEnabled:!1}){this._renderCoordsHelper=e,this._config=i,this._technique=null,this._projInfo=Object(d["c"])(),this._zScale=Object(h["b"])(),this._heightManifoldEnabled=!1,this._heightManifoldTarget=Object(a["e"])(),this._pointDistanceEnabled=!1,this._pointDistanceOrigin=Object(a["e"])(),this._pointDistanceTarget=Object(a["e"])(),this._lineVerticalPlaneEnabled=!1,this._lineVerticalPlaneSegment=s["e"].create(),this._intersectsLineEnabled=!1,this._intersectsLineSegment=s["e"].create(),this._intersectsLineRadius=3,this._intersectsLineInfinite=!1,this._pathVerticalPlaneEnabled=!1,this._pathVerticalPlaneData=null,this._pathTechnique=null,this.canRender=!0,this._tempNormal=Object(a["e"])(),this._tempDir=Object(a["e"])(),this._tempUp=Object(a["e"])(),this._tempVec3A=Object(a["e"])(),this._tempVec3B=Object(a["e"])(),this._tempVec4=Object(d["c"])(),this._tempPlane=s["f"].create(),this._tempSphere=s["h"].create(),this._params=Object(m["e"])(t,G)}get renderSlots(){return[this._config.contrastControlEnabled?17:16]}get needsLinearDepth(){return!0}get heightManifoldEnabled(){return this._heightManifoldEnabled}set heightManifoldEnabled(e){this._heightManifoldEnabled!==e&&(this._heightManifoldEnabled=e,this._requestRender())}get heightManifoldTarget(){return this._heightManifoldTarget}set heightManifoldTarget(e){Object(n["l"])(this._heightManifoldTarget,e),this._requestRender()}get pointDistanceEnabled(){return this._pointDistanceEnabled}set pointDistanceEnabled(e){e!==this._pointDistanceEnabled&&(this._pointDistanceEnabled=e,this._requestRender())}get pointDistanceTarget(){return this._pointDistanceTarget}set pointDistanceTarget(e){Object(n["l"])(this._pointDistanceTarget,e),this._requestRender()}get pointDistanceOrigin(){return this._pointDistanceOrigin}set pointDistanceOrigin(e){Object(n["l"])(this._pointDistanceOrigin,e),this._requestRender()}get lineVerticalPlaneEnabled(){return this._lineVerticalPlaneEnabled}set lineVerticalPlaneEnabled(e){e!==this._lineVerticalPlaneEnabled&&(this._lineVerticalPlaneEnabled=e,this._requestRender())}get lineVerticalPlaneSegment(){return this._lineVerticalPlaneSegment}set lineVerticalPlaneSegment(e){s["e"].copy(e,this._lineVerticalPlaneSegment),this._requestRender()}get intersectsLineEnabled(){return this._intersectsLineEnabled}set intersectsLineEnabled(e){e!==this._intersectsLineEnabled&&(this._intersectsLineEnabled=e,this._requestRender())}get intersectsLineSegment(){return this._intersectsLineSegment}set intersectsLineSegment(e){s["e"].copy(e,this._intersectsLineSegment),this._requestRender()}get intersectsLineRadius(){return this._intersectsLineRadius}set intersectsLineRadius(e){e!==this._intersectsLineRadius&&(this._intersectsLineRadius=e,this._requestRender())}get intersectsLineInfinite(){return this._intersectsLineInfinite}set intersectsLineInfinite(e){e!==this._intersectsLineInfinite&&(this._intersectsLineInfinite=e,this._requestRender())}get pathVerticalPlaneEnabled(){return this._pathVerticalPlaneEnabled}set pathVerticalPlaneEnabled(e){e!==this._pathVerticalPlaneEnabled&&(this._pathVerticalPlaneEnabled=e,Object(r["k"])(this._pathVerticalPlaneData)&&this._requestRender())}set pathVerticalPlaneVertices(e){Object(r["j"])(this._pathVerticalPlaneData)&&(this._pathVerticalPlaneData=new E(this._renderCoordsHelper)),this._pathVerticalPlaneData.vertices=e,this.pathVerticalPlaneEnabled&&this._requestRender()}set pathVerticalPlaneBuffers(e){Object(r["j"])(this._pathVerticalPlaneData)&&(this._pathVerticalPlaneData=new E(this._renderCoordsHelper)),this._pathVerticalPlaneData.buffers=e,this.pathVerticalPlaneEnabled&&this._requestRender()}setParameterValues(e){Object(m["k"])(this._params,e)&&this._requestRender()}initializeRenderContext(e){this._context=e;const t=e.renderContext.rctx;this._quadVAO=Object(f["d"])(t),this._techniqueRepository=e.shaderTechniqueRep,this._techniqueConfig=new F,this._pathTechniqueConfig=new C}uninitializeRenderContext(){this._quadVAO=Object(r["f"])(this._quadVAO),this._techniqueRepository.release(this._technique),this._technique=null,this._pathVerticalPlaneData=Object(r["f"])(this._pathVerticalPlaneData),this._techniqueRepository.release(this._pathTechnique),this._pathTechnique=null}render(e){const t=this.heightManifoldEnabled||this.pointDistanceEnabled||this.lineVerticalPlaneSegment||this.intersectsLineEnabled,i=this.pathVerticalPlaneEnabled;if(!t&&!i)return!0;const r=e.camera;return Object(p["f"])(r.projectionMatrix,r.fullWidth,r.fullHeight,this._projInfo,this._zScale),t&&this.renderUnified(e),i&&this.renderPath(e),!0}renderUnified(e){const t=e.rctx,i=this._selectTechnique(),r=i.program;t.bindProgram(r),i.bindPipelineState(t),this.bindGlobalUniforms(e,r),this.bindHeightManifoldUniforms(e,r),this.bindPointDistanceUniforms(e,r),this.bindLineVerticalPlaneUniforms(e,r),this.bindIntersectsLineUniforms(e,r),i.bind(this._params,e.camera),t.bindVAO(this._quadVAO),t.drawArrays(5,0,4)}renderPath(e){if(Object(r["j"])(this._pathVerticalPlaneData))return;this._pathTechniqueConfig.contrastControlEnabled=this._config.contrastControlEnabled,this._pathTechnique=this._techniqueRepository.acquireAndReleaseExisting(S,this._pathTechniqueConfig,this._pathTechnique);const t=e.rctx,i=this._pathTechnique,a=i.program;t.bindProgram(a),i.bindPipelineState(t),this.bindGlobalUniforms(e,a),i.bind(this._params,this._pathVerticalPlaneData.origin,e.camera),this._pathVerticalPlaneData.draw(e.rctx)}bindHeightManifoldUniforms(e,t){if(!this.heightManifoldEnabled)return;const i=this._tempVec3A,r=this._tempPlane;this._renderCoordsHelper.worldUpAtPosition(this._heightManifoldTarget,i),B(r,this._heightManifoldTarget,i,e.camera.viewMatrix),t.setUniform4fv("heightPlane",r)}bindPointDistanceUniforms(e,t){if(!this._pointDistanceEnabled)return;const i=e.camera,r=this._tempSphere;Object(n["l"])(r,this._pointDistanceOrigin),Object(n["n"])(r,r,i.viewMatrix),r[3]=Object(n["p"])(this._pointDistanceOrigin,this._pointDistanceTarget),t.setUniform4f("pointDistanceSphere",r[0],r[1],r[2],r[3])}bindLineVerticalPlaneUniforms(e,t){if(!this._lineVerticalPlaneEnabled)return;const i=this._renderCoordsHelper,r=e.camera,a=this._tempPlane,o=this._tempVec3A,c=this._tempUp,l=this._tempDir,h=this._tempNormal;s["e"].pointAt(this._lineVerticalPlaneSegment,.5,o),i.worldUpAtPosition(o,c),Object(n["s"])(l,this._lineVerticalPlaneSegment.vector),Object(n["h"])(h,c,l),Object(n["s"])(h,h),B(a,this._lineVerticalPlaneSegment.origin,h,r.viewMatrix),t.setUniform4fv("lineVerticalPlane",a);const d=this._tempVec3A;Object(n["l"])(d,this._lineVerticalPlaneSegment.origin),i.setAltitude(0,d),Object(n["n"])(d,d,r.viewMatrix),t.setUniform3fv("lineVerticalStart",d);const u=this._tempVec3B;Object(n["g"])(u,this._lineVerticalPlaneSegment.origin,this._lineVerticalPlaneSegment.vector),i.setAltitude(0,u),Object(n["n"])(u,u,r.viewMatrix),t.setUniform3fv("lineVerticalEnd",u)}bindIntersectsLineUniforms(e,t){if(!this._intersectsLineEnabled)return;const i=q,r=W;if(this._intersectsLineInfinite){const t=e.camera;if(s["c"].fromRay(s["g"].wrap(this._intersectsLineSegment.origin,this._intersectsLineSegment.vector),N),N.c0=-Number.MAX_VALUE,!s["d"].intersectClipRay(t.frustum,N))return;s["c"].getStart(N,i),s["c"].getEnd(N,r)}else Object(n["l"])(i,this._intersectsLineSegment.origin),Object(n["g"])(r,this._intersectsLineSegment.origin,this._intersectsLineSegment.vector);const a=this._tempVec3A;Object(n["n"])(a,i,e.camera.viewMatrix),t.setUniform3fv("intersectsLineStart",a);const o=this._tempVec4;Object(n["l"])(o,this._intersectsLineSegment.vector),this._tempVec4[3]=0,Object(u["m"])(this._tempVec4,this._tempVec4,e.camera.viewMatrix),Object(n["n"])(r,r,e.camera.viewMatrix),t.setUniform3fv("intersectsLineEnd",r),Object(n["s"])(o,o),t.setUniform3f("intersectsLineDirection",o[0],o[1],o[2]),t.setUniform1f("intersectsLineRadius",this._intersectsLineRadius)}bindGlobalUniforms(e,t){const i=e.camera;t.setUniform4fv("projInfo",this._projInfo),t.setUniform2fv("zScale",this._zScale),t.setUniform2f("nearFar",i.near,i.far),this._heightManifoldEnabled?t.setUniform1f("maxPixelDistance",2*i.computeScreenPixelSizeAt(this._heightManifoldTarget)):this._pointDistanceEnabled?t.setUniform1f("maxPixelDistance",2*i.computeScreenPixelSizeAt(this._pointDistanceTarget)):this._lineVerticalPlaneEnabled&&t.setUniform1f("maxPixelDistance",2*i.computeScreenPixelSizeAt(this._lineVerticalPlaneSegment.origin)),t.setUniform1i("depthMap",0),e.rctx.bindTexture(e.offscreenRenderingHelper.linearDepthTexture,0),t.setUniform1i("frameColor",1),e.rctx.bindTexture(e.offscreenRenderingHelper.mainColorTexture,1)}_requestRender(){this._context&&this._context.requestRender()}_selectTechnique(){return this._techniqueConfig.heightManifoldEnabled=this.heightManifoldEnabled,this._techniqueConfig.lineVerticalPlaneEnabled=this.lineVerticalPlaneEnabled,this._techniqueConfig.pointDistanceEnabled=this.pointDistanceEnabled,this._techniqueConfig.intersectsLineEnabled=this.intersectsLineEnabled,this._techniqueConfig.contrastControlEnabled=this._config.contrastControlEnabled,this._technique=this._techniqueRepository.acquireAndReleaseExisting(k,this._techniqueConfig,this._technique),this._technique}}const N=s["c"].create(),q=Object(a["e"])(),W=Object(a["e"])();class Z extends o["a"]{constructor(e){super(e.view),this._angleCutoff=c["c"],this._style={},this._heightManifoldTarget=Object(a["e"])(),this._heightManifoldEnabled=!1,this._intersectsLine=s["e"].create(),this._intersectsLineEnabled=!1,this._intersectsLineInfinite=!1,this._lineVerticalPlaneSegment=null,this._pathVerticalPlaneBuffers=null,this._pointDistanceLine=null,this.applyProps(e)}get testData(){return this.renderer}createResources(){this.ensureRenderer()}destroyResources(){this.disposeRenderer()}updateVisibility(){this.syncHeightManifold(),this.syncIntersectsLine(),this.syncPathVerticalPlane(),this.syncLineVerticalPlane(),this.syncPointDistance()}get angleCutoff(){return this._angleCutoff}set angleCutoff(e){this._angleCutoff!==e&&(this._angleCutoff=e,this.syncAngleCutoff())}get style(){return this._style}set style(e){this._style=e,this.syncStyle()}get heightManifoldTarget(){return this._heightManifoldEnabled?this._heightManifoldTarget:null}set heightManifoldTarget(e){Object(r["k"])(e)?(Object(n["l"])(this._heightManifoldTarget,e),this._heightManifoldEnabled=!0):this._heightManifoldEnabled=!1,this.syncRenderer(),this.syncHeightManifold()}set intersectsWorldUpAtLocation(e){if(Object(r["j"])(e))return void(this.intersectsLine=null);const t=this.view.renderCoordsHelper.worldUpAtPosition(e,$);this.intersectsLine=s["e"].fromValues(e,t),this.intersectsLineInfinite=!0}get intersectsLine(){return this._intersectsLineEnabled?this._intersectsLine:null}set intersectsLine(e){Object(r["k"])(e)?(s["e"].copy(e,this._intersectsLine),this._intersectsLineEnabled=!0):this._intersectsLineEnabled=!1,this.syncIntersectsLine(),this.syncRenderer()}get intersectsLineInfinite(){return this._intersectsLineInfinite}set intersectsLineInfinite(e){this._intersectsLineInfinite=e,this.syncIntersectsLineInfinite()}get lineVerticalPlaneSegment(){return this._lineVerticalPlaneSegment}set lineVerticalPlaneSegment(e){this._lineVerticalPlaneSegment=Object(r["k"])(e)?s["e"].copy(e):null,this.syncLineVerticalPlane(),this.syncRenderer()}get pathVerticalPlane(){return this._pathVerticalPlaneBuffers}set pathVerticalPlane(e){this._pathVerticalPlaneBuffers=e,this.syncPathVerticalPlane(),this.syncLineVerticalPlane(),this.syncPointDistance(),this.syncRenderer()}get pointDistanceLine(){return this._pointDistanceLine}set pointDistanceLine(e){this._pointDistanceLine=Object(r["k"])(e)?{origin:Object(a["d"])(e.origin),target:Object(a["d"])(e.target)}:null,this.syncPointDistance(),this.syncRenderer()}syncRenderer(){this.attached&&(this._intersectsLineEnabled||this._heightManifoldEnabled||Object(r["k"])(this._pointDistanceLine)||Object(r["k"])(this._pathVerticalPlaneBuffers))?this.ensureRenderer():this.disposeRenderer()}ensureRenderer(){Object(r["k"])(this.renderer)||(this.renderer=new H(this.view.renderCoordsHelper,void 0,{contrastControlEnabled:!0}),this.syncStyle(),this.syncHeightManifold(),this.syncIntersectsLine(),this.syncIntersectsLineInfinite(),this.syncPathVerticalPlane(),this.syncLineVerticalPlane(),this.syncPointDistance(),this.syncAngleCutoff(),this.view._stage&&this.view._stage.addRenderPlugin(this.renderer.renderSlots,this.renderer))}syncStyle(){Object(r["j"])(this.renderer)||(this.renderer.setParameterValues(this._style),null!=this._style.intersectsLineRadius&&(this.renderer.intersectsLineRadius=this._style.intersectsLineRadius))}syncAngleCutoff(){Object(r["j"])(this.renderer)||this.renderer.setParameterValues({angleCutoff:this._angleCutoff})}syncHeightManifold(){Object(r["j"])(this.renderer)||(this.renderer.heightManifoldEnabled=this._heightManifoldEnabled&&this.visible,this._heightManifoldEnabled&&(this.renderer.heightManifoldTarget=this._heightManifoldTarget))}syncIntersectsLine(){Object(r["j"])(this.renderer)||(this.renderer.intersectsLineEnabled=this._intersectsLineEnabled&&this.visible,this._intersectsLineEnabled&&(this.renderer.intersectsLineSegment=this._intersectsLine))}syncIntersectsLineInfinite(){Object(r["j"])(this.renderer)||(this.renderer.intersectsLineInfinite=this._intersectsLineInfinite)}syncPathVerticalPlane(){Object(r["j"])(this.renderer)||(this.renderer.pathVerticalPlaneEnabled=Object(r["k"])(this._pathVerticalPlaneBuffers)&&this.visible,Object(r["k"])(this._pathVerticalPlaneBuffers)&&(this.renderer.pathVerticalPlaneBuffers=this._pathVerticalPlaneBuffers))}syncLineVerticalPlane(){Object(r["j"])(this.renderer)||(this.renderer.lineVerticalPlaneEnabled=Object(r["k"])(this._lineVerticalPlaneSegment)&&this.visible,Object(r["k"])(this._lineVerticalPlaneSegment)&&(this.renderer.lineVerticalPlaneSegment=this._lineVerticalPlaneSegment))}syncPointDistance(){Object(r["j"])(this.renderer)||(this.renderer.pointDistanceEnabled=Object(r["k"])(this._pointDistanceLine)&&this.visible,Object(r["k"])(this._pointDistanceLine)&&(this.renderer.pointDistanceOrigin=this._pointDistanceLine.origin,this.renderer.pointDistanceTarget=this._pointDistanceLine.target))}disposeRenderer(){Object(r["k"])(this.renderer)&&this.view._stage&&(this.view._stage.removeRenderPlugin(this.renderer),this.renderer=null)}}const $=Object(a["e"])()},"65a7":function(e,t,i){"use strict";i.d(t,"a",(function(){return l}));var r=i("c649"),a=i("e753"),n=i("e6b5"),s=i("d232"),o=i("b63c"),c=i("5715");class l{draw(e,t){const i=this.getUniqueHints(e),l=[];for(const r of i)r instanceof a["a"]&&l.push(this.visualizeIntersectionPoint(r,t)),r instanceof n["a"]&&l.push(this.visualizeLine(r,t)),r instanceof s["a"]&&l.push(this.visualizeParallelSign(r,t)),r instanceof c["a"]&&l.push(this.visualizeRightAngleQuad(r,t)),r instanceof o["a"]&&l.push(this.visualizePoint(r,t));return Object(r["b"])(l)}getUniqueHints(e){const t=[];for(const i of e){let e=!0;for(const r of t)if(i.equals(r)){e=!1;break}e&&t.push(i)}return t}}},"65c9":function(e,t,i){"use strict";i.d(t,"a",(function(){return u})),i.d(t,"b",(function(){return d}));var r=i("3886"),a=i("690a"),n=i("501b"),s=i("d047"),o=i("6a07"),c=i("d017"),l=i("2aad"),h=i("58c2");function d(e){const t=new a["a"];return t.include(c["a"]),t.fragment.include(n["a"]),t.fragment.include(s["a"]),t.include(h["a"]),t.include(l["a"]),t.fragment.uniforms.add("defaultDepthTex","sampler2D").add("highlightDepthTex","sampler2D").add("depthMap","sampler2D").add("highlightMap","sampler2D").add("color","vec4").add("nearFar","vec2").add("opacity","float").add("occludedOpacity","float").add("terminationFactor","float").add("inverseView","mat4").add("lightingMainDirectionView","vec3").add("texelSize","vec2"),t.fragment.constants.add("unoccludedHighlightFlag","vec4",o["b"]).add("highlightedThreshold","float",e.highlightedThreshold).add("selfShadowThreshold","float",e.selfShadowThreshold),t.fragment.code.add(r["a"]`
    vec3 normalFromDepth(vec3 pixelPos, vec2 fragCoord, vec2 uv, vec2 texelSize, sampler2D depthMap, vec2 nearFar) {
      float leftPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(-1.0, 0.0) * texelSize, nearFar);
      float rightPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(1.0, 0.0) * texelSize, nearFar);
      float bottomPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(0.0, -1.0) * texelSize, nearFar);
      float topPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(0.0, 1.0) * texelSize, nearFar);

      bool pickLeft = abs(pixelPos.z - leftPixelDepth) < abs(pixelPos.z - rightPixelDepth);
      bool pickBottom = abs(pixelPos.z - bottomPixelDepth) < abs(pixelPos.z - topPixelDepth);

      vec3 fragCoordHorizontal = pickLeft
                                  ? vec3(fragCoord + vec2(-1.0, 0.0), leftPixelDepth)
                                  : vec3(fragCoord + vec2(1.0, 0.0), rightPixelDepth);
      vec3 fragCoordVertical = pickBottom
                                  ? vec3(fragCoord + vec2(0.0, -1.0), bottomPixelDepth)
                                  : vec3(fragCoord + vec2(0.0, 1.0), topPixelDepth);

      vec3 verticalPixelPos = reconstructPosition(fragCoordHorizontal.xy, fragCoordHorizontal.z);
      vec3 horizontalPixelPos = reconstructPosition(fragCoordVertical.xy, fragCoordVertical.z);

      vec3 normal = normalize(cross(verticalPixelPos - pixelPos, horizontalPixelPos - pixelPos));
      // Flip normal depending on triangle winding order for consistency
      return pickLeft == pickBottom ? normal : -normal;
    }
  `),t.fragment.code.add(r["a"]`
    void main(void) {
      vec4 highlightInfo = texture2D(highlightMap, uv);
      float visiblyHighlighted = (1.0 - clamp(distance(unoccludedHighlightFlag, highlightInfo), 0.0, 1.0)) * highlightInfo.a;

      if (visiblyHighlighted > highlightedThreshold) {
        discard;
      }

      float depth = rgba2float(texture2D(depthMap, uv));
      // 0.0 is the clear value of depthMap, which means nothing has been drawn there and we should discard
      if (depth == 0.0) {
        discard;
      }

      float currentPixelDepth = linearDepthFromFloat(depth, nearFar);

      if (-currentPixelDepth>nearFar.y || -currentPixelDepth<nearFar.x) {
        discard;
      }

      vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
      vec4 worldSpacePos = inverseView * currentPixelPos;

      mat4 shadowMatrix;
      float linearDepth = -currentPixelDepth;
      int i = chooseCascade(linearDepth, shadowMatrix);

      if (i >= uShadowMapNum) {
        discard;
      }

      vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);

      // vertex completely outside? -> no shadow
      if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
        discard;
      }

      vec2 uvShadow = cascadeCoordinates(i, lvpos);

      float depthHighlight = readShadowMapDepth(uvShadow, highlightDepthTex);
      bool shadowHighlight = depthHighlight < lvpos.z;

      if (!shadowHighlight) {
        discard;
      }

      float depthDefault = readShadowMapDepth(uvShadow, defaultDepthTex);
      bool shadowDefault = depthDefault < lvpos.z;

      vec3 normal = normalFromDepth(currentPixelPos.xyz, gl_FragCoord.xy, uv, texelSize, depthMap, nearFar);
      bool shaded = dot(normal, lightingMainDirectionView) < selfShadowThreshold;

      float differenceOpacity = opacity;
      float bothOpacity = occludedOpacity;

      float fragOpacity = (shadowDefault || shaded) ? bothOpacity : differenceOpacity;
      gl_FragColor = vec4(color.rgb, color.a * fragOpacity * terminationFactor);
    }
  `),t}var u=Object.freeze({__proto__:null,build:d})},6611:function(e,t,i){"use strict";var r=i("a4ee"),a=(i("c120"),i("e92d"),i("cea0"),i("59b2")),n=i("d386"),s=(i("e041"),i("8eed"),i("f402"),i("fc29"));let o=class extends s["a"]{constructor(){super(...arguments),this.SCENEVIEW_HITTEST_RETURN_INTERSECTOR=!1,this.SCENEVIEW_LOCKING_LOG=!1,this.HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED=!0,this.HIGHLIGHTS_PROFILE_TO_CONSOLE=!1,this.DECONFLICTOR_SHOW_VISIBLE=!1,this.DECONFLICTOR_SHOW_INVISIBLE=!1,this.DECONFLICTOR_SHOW_GRID=!1,this.LABELS_SHOW_BORDER=!1,this.OVERLAY_DRAW_DEBUG_TEXTURE=!1,this.OVERLAY_SHOW_CENTER=!1,this.SHOW_POI=!1,this.TESTS_DISABLE_UPDATE_THRESHOLDS=!1,this.DISABLE_DECONFLICTOR_VISIBILITY_OFFSET=!1,this.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES=!1,this.DRAW_MESH_GEOMETRY_NORMALS=!1,this.FEATURE_TILE_FETCH_SHOW_TILES=!1,this.FEATURE_TILE_TREE_SHOW_TILES=!1,this.TERRAIN_TILE_TREE_SHOW_TILES=!1,this.I3S_TREE_SHOW_TILES=!1,this.I3S_SHOW_MODIFICATIONS=!1,this.ENABLE_PROFILE_DEPTH_RANGE=!1,this.DISABLE_FAST_UPDATES=!1,this.LOD_INSTANCE_RENDERER_DISABLE_UPDATES=!1,this.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL=!1,this.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES=!1}};Object(r["a"])([Object(a["b"])()],o.prototype,"SCENEVIEW_HITTEST_RETURN_INTERSECTOR",void 0),Object(r["a"])([Object(a["b"])()],o.prototype,"SCENEVIEW_LOCKING_LOG",void 0),Object(r["a"])([Object(a["b"])()],o.prototype,"HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED",void 0),Object(r["a"])([Object(a["b"])()],o.prototype,"HIGHLIGHTS_PROFILE_TO_CONSOLE",void 0),Object(r["a"])([Object(a["b"])()],o.prototype,"DECONFLICTOR_SHOW_VISIBLE",void 0),Object(r["a"])([Object(a["b"])()],o.prototype,"DECONFLICTOR_SHOW_INVISIBLE",void 0),Object(r["a"])([Object(a["b"])()],o.prototype,"DECONFLICTOR_SHOW_GRID",void 0),Object(r["a"])([Object(a["b"])()],o.prototype,"LABELS_SHOW_BORDER",void 0),Object(r["a"])([Object(a["b"])()],o.prototype,"OVERLAY_DRAW_DEBUG_TEXTURE",void 0),Object(r["a"])([Object(a["b"])()],o.prototype,"OVERLAY_SHOW_CENTER",void 0),Object(r["a"])([Object(a["b"])()],o.prototype,"SHOW_POI",void 0),Object(r["a"])([Object(a["b"])()],o.prototype,"TESTS_DISABLE_UPDATE_THRESHOLDS",void 0),Object(r["a"])([Object(a["b"])()],o.prototype,"DISABLE_DECONFLICTOR_VISIBILITY_OFFSET",void 0),Object(r["a"])([Object(a["b"])()],o.prototype,"DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES",void 0),Object(r["a"])([Object(a["b"])()],o.prototype,"DRAW_MESH_GEOMETRY_NORMALS",void 0),Object(r["a"])([Object(a["b"])()],o.prototype,"FEATURE_TILE_FETCH_SHOW_TILES",void 0),Object(r["a"])([Object(a["b"])()],o.prototype,"FEATURE_TILE_TREE_SHOW_TILES",void 0),Object(r["a"])([Object(a["b"])()],o.prototype,"TERRAIN_TILE_TREE_SHOW_TILES",void 0),Object(r["a"])([Object(a["b"])()],o.prototype,"I3S_TREE_SHOW_TILES",void 0),Object(r["a"])([Object(a["b"])()],o.prototype,"I3S_SHOW_MODIFICATIONS",void 0),Object(r["a"])([Object(a["b"])()],o.prototype,"ENABLE_PROFILE_DEPTH_RANGE",void 0),Object(r["a"])([Object(a["b"])()],o.prototype,"DISABLE_FAST_UPDATES",void 0),Object(r["a"])([Object(a["b"])()],o.prototype,"LOD_INSTANCE_RENDERER_DISABLE_UPDATES",void 0),Object(r["a"])([Object(a["b"])()],o.prototype,"LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL",void 0),Object(r["a"])([Object(a["b"])()],o.prototype,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",void 0),o=Object(r["a"])([Object(n["a"])("esri.views.3d.support.DebugFlags")],o);const c=new o;t["a"]=c},"668b":function(e,t,i){"use strict";i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return s})),i.d(t,"c",(function(){return a}));var r=i("da6c");function a(e,t,i){if(e.count!==t.count)return void r["a"].error("source and destination buffers need to have the same number of elements");const a=e.count,n=i[0],s=i[1],o=i[2],c=i[4],l=i[5],h=i[6],d=i[8],u=i[9],p=i[10],f=i[12],m=i[13],b=i[14],g=e.typedBuffer,v=e.typedBufferStride,y=t.typedBuffer,O=t.typedBufferStride;for(let r=0;r<a;r++){const e=r*v,t=r*O,i=y[t],a=y[t+1],_=y[t+2];g[e]=n*i+c*a+d*_+f,g[e+1]=s*i+l*a+u*_+m,g[e+2]=o*i+h*a+p*_+b}}function n(e,t,i){if(e.count!==t.count)return void r["a"].error("source and destination buffers need to have the same number of elements");const a=e.count,n=i[0],s=i[1],o=i[2],c=i[3],l=i[4],h=i[5],d=i[6],u=i[7],p=i[8],f=e.typedBuffer,m=e.typedBufferStride,b=t.typedBuffer,g=t.typedBufferStride;for(let r=0;r<a;r++){const e=r*m,t=r*g,i=b[t],a=b[t+1],v=b[t+2];f[e]=n*i+c*a+d*v,f[e+1]=s*i+l*a+u*v,f[e+2]=o*i+h*a+p*v}}function s(e,t,i){const r=Math.min(e.count,t.count),a=e.typedBuffer,n=e.typedBufferStride,s=t.typedBuffer,o=t.typedBufferStride;for(let c=0;c<r;c++){const e=c*n,t=c*o;a[e]=i*s[t],a[e+1]=i*s[t+1],a[e+2]=i*s[t+2]}}function o(e,t,i){const r=Math.min(e.count,t.count),a=e.typedBuffer,n=e.typedBufferStride,s=t.typedBuffer,o=t.typedBufferStride;for(let c=0;c<r;c++){const e=c*n,t=c*o;a[e]=s[t]>>i,a[e+1]=s[t+1]>>i,a[e+2]=s[t+2]>>i}}Object.freeze({__proto__:null,transformMat4:a,transformMat3:n,scale:s,shiftRight:o})},"66af":function(e,t,i){"use strict";i.d(t,"a",(function(){return c}));var r=i("a4ee"),a=(i("c120"),i("e92d"),i("cea0"),i("59b2")),n=i("d386"),s=(i("e041"),i("8eed"),i("f402"),i("3795")),o=i("d2f2");const c=e=>{let t=class extends e{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.supportsHeightUnitConversion=!1}postscript(e){super.postscript(e),Object(o["b"])(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())}async _validateHeightModelInfo(){const e=Object(s["h"])(this.view.defaultsFromMap,"isHeightModelInfoSearching");this.handles.add(e),await e;const t=Object(o["c"])(this.layer,this.view.heightModelInfo,this.supportsHeightUnitConversion);if(t)throw t}};return Object(r["a"])([Object(a["b"])()],t.prototype,"view",void 0),Object(r["a"])([Object(a["b"])()],t.prototype,"slicePlaneEnabled",void 0),t=Object(r["a"])([Object(n["a"])("esri.views.3d.layers.LayerView3D")],t),t}},"66b9":function(e,t,i){"use strict";i.d(t,"a",(function(){return b})),i.d(t,"b",(function(){return v}));var r=i("b2b2"),a=i("1c92"),n=i("8c71"),s=i("db21"),o=(i("c120"),i("38a4"),i("9f8b"),i("7ce4")),c=i("0fa6"),l=(i("d267"),i("bc05"));class h{constructor(e,t){this.layerUIDs=[],this.isDestroyed=!1,this.data=e,this.memoryUsed=e.byteLength;let i=1;const r=new Uint32Array(e);this.layerUIDs=[];const a=r[i++];for(let n=0;n<a;n++)this.layerUIDs[n]=r[i++];this.bufferDataOffset=i,t&&(this.layer=t.getStyleLayerByUID(this.layerUIDs[0]))}get isPreparedForRendering(){return Object(r["j"])(this.data)}get offset(){return this.bufferDataOffset}destroy(){this.isDestroyed||(this.doDestroy(),this.isDestroyed=!0)}prepareForRendering(e){Object(r["j"])(this.data)||(this.doPrepareForRendering(e,this.data,this.bufferDataOffset),this.data=null)}}class d extends h{constructor(e,t){super(e,t),this.type=2,this.lineIndexStart=0,this.lineIndexCount=0;const i=new Uint32Array(e);let r=this.bufferDataOffset;this.lineIndexStart=i[r++],this.lineIndexCount=i[r++],this.bufferDataOffset=r}hasData(){return this.lineIndexCount>0}triangleCount(){return this.lineIndexCount/3}doDestroy(){Object(r["k"])(this.lineVertexArrayObject)&&this.lineVertexArrayObject.dispose(),Object(r["k"])(this.lineVertexBuffer)&&this.lineVertexBuffer.dispose(),Object(r["k"])(this.lineIndexBuffer)&&this.lineIndexBuffer.dispose(),this.lineVertexArrayObject=null,this.lineVertexBuffer=null,this.lineIndexBuffer=null,this.memoryUsed=0}doPrepareForRendering(e,t,i){const r=new Uint32Array(t),a=new Int32Array(r.buffer),n=r[i++];this.lineVertexBuffer=o["a"].createVertex(e,35044,new Int32Array(a.buffer,4*i,n)),i+=n;const s=r[i++];this.lineIndexBuffer=o["a"].createIndex(e,35044,new Uint32Array(r.buffer,4*i,s)),i+=s;const l=this.layer.lineMaterial;this.lineVertexArrayObject=new c["a"](e,l.getAttributeLocations(),l.getLayoutInfo(),{geometry:this.lineVertexBuffer},this.lineIndexBuffer)}}class u extends h{constructor(e,t){super(e,t),this.type=1,this.fillIndexStart=0,this.fillIndexCount=0,this.outlineIndexStart=0,this.outlineIndexCount=0;const i=new Uint32Array(e);let r=this.bufferDataOffset;this.fillIndexStart=i[r++],this.fillIndexCount=i[r++],this.outlineIndexStart=i[r++],this.outlineIndexCount=i[r++],this.bufferDataOffset=r}hasData(){return this.fillIndexCount>0||this.outlineIndexCount>0}triangleCount(){return(this.fillIndexCount+this.outlineIndexCount)/3}doDestroy(){Object(r["k"])(this.fillVertexArrayObject)&&this.fillVertexArrayObject.dispose(),Object(r["k"])(this.fillVertexBuffer)&&this.fillVertexBuffer.dispose(),Object(r["k"])(this.fillIndexBuffer)&&this.fillIndexBuffer.dispose(),this.fillVertexArrayObject=null,this.fillVertexBuffer=null,this.fillIndexBuffer=null,Object(r["k"])(this.outlineVertexArrayObject)&&this.outlineVertexArrayObject.dispose(),Object(r["k"])(this.outlineVertexBuffer)&&this.outlineVertexBuffer.dispose(),Object(r["k"])(this.outlineIndexBuffer)&&this.outlineIndexBuffer.dispose(),this.outlineVertexArrayObject=null,this.outlineVertexBuffer=null,this.outlineIndexBuffer=null,this.memoryUsed=0}doPrepareForRendering(e,t,i){const r=new Uint32Array(t),a=new Int32Array(r.buffer),n=r[i++];this.fillVertexBuffer=o["a"].createVertex(e,35044,new Int32Array(a.buffer,4*i,n)),i+=n;const s=r[i++];this.fillIndexBuffer=o["a"].createIndex(e,35044,new Uint32Array(r.buffer,4*i,s)),i+=s;const l=r[i++];this.outlineVertexBuffer=o["a"].createVertex(e,35044,new Int32Array(a.buffer,4*i,l)),i+=l;const h=r[i++];this.outlineIndexBuffer=o["a"].createIndex(e,35044,new Uint32Array(r.buffer,4*i,h)),i+=h;const d=this.layer,u=d.fillMaterial,p=d.outlineMaterial;this.fillVertexArrayObject=new c["a"](e,u.getAttributeLocations(),u.getLayoutInfo(),{geometry:this.fillVertexBuffer},this.fillIndexBuffer),this.outlineVertexArrayObject=new c["a"](e,p.getAttributeLocations(),p.getLayoutInfo(),{geometry:this.outlineVertexBuffer},this.outlineIndexBuffer)}}class p extends h{constructor(e,t,i){super(e,t),this.type=3,this.iconPerPageElementsMap=new Map,this.glyphPerPageElementsMap=new Map,this.symbolInstances=[],this.isIconSDF=!1,this.opacityChanged=!1,this.lastOpacityUpdate=0,this.symbols=[];const r=new Uint32Array(e),a=new Int32Array(e),n=new Float32Array(e);let s=this.bufferDataOffset;this.isIconSDF=!!r[s++];const o=r[s++];for(let l=0;l<o;l++){const e=r[s++],t=r[s++],i=r[s++];this.iconPerPageElementsMap.set(e,[t,i])}const c=r[s++];for(let l=0;l<c;l++){const e=r[s++],t=r[s++],i=r[s++];this.glyphPerPageElementsMap.set(e,[t,i])}const h=r[s++],d=r[s++];this.iconOpacity=new Int32Array(h),this.textOpacity=new Int32Array(d),s=Object(l["b"])(r,a,n,s,this.symbols,i),this.bufferDataOffset=s}hasData(){return this.iconPerPageElementsMap.size>0||this.glyphPerPageElementsMap.size>0}triangleCount(){let e=0;for(const[t,i]of this.iconPerPageElementsMap)e+=i[1];for(const[t,i]of this.glyphPerPageElementsMap)e+=i[1];return e/3}doDestroy(){Object(r["k"])(this.iconVertexArrayObject)&&this.iconVertexArrayObject.dispose(),Object(r["k"])(this.iconVertexBuffer)&&this.iconVertexBuffer.dispose(),Object(r["k"])(this.iconOpacityBuffer)&&this.iconOpacityBuffer.dispose(),Object(r["k"])(this.iconIndexBuffer)&&this.iconIndexBuffer.dispose(),this.iconVertexArrayObject=null,this.iconVertexBuffer=null,this.iconOpacityBuffer=null,this.iconIndexBuffer=null,Object(r["k"])(this.textVertexArrayObject)&&this.textVertexArrayObject.dispose(),Object(r["k"])(this.textVertexBuffer)&&this.textVertexBuffer.dispose(),Object(r["k"])(this.textOpacityBuffer)&&this.textOpacityBuffer.dispose(),Object(r["k"])(this.textIndexBuffer)&&this.textIndexBuffer.dispose(),this.textVertexArrayObject=null,this.textVertexBuffer=null,this.textOpacityBuffer=null,this.textIndexBuffer=null,this.memoryUsed=0}updateOpacityInfo(){if(!this.opacityChanged)return;this.opacityChanged=!1;const e=Object(r["t"])(this.iconOpacity),t=Object(r["t"])(this.iconOpacityBuffer);e.length>0&&e.byteLength===t.size&&t.setSubData(e);const i=Object(r["t"])(this.textOpacity),a=Object(r["t"])(this.textOpacityBuffer);i.length>0&&i.byteLength===a.size&&a.setSubData(i)}doPrepareForRendering(e,t,i){const a=new Uint32Array(t),n=new Int32Array(a.buffer),s=a[i++];this.iconVertexBuffer=o["a"].createVertex(e,35044,new Int32Array(n.buffer,4*i,s)),i+=s;const l=a[i++];this.iconIndexBuffer=o["a"].createIndex(e,35044,new Uint32Array(a.buffer,4*i,l)),i+=l;const h=a[i++];this.textVertexBuffer=o["a"].createVertex(e,35044,new Int32Array(n.buffer,4*i,h)),i+=h;const d=a[i++];this.textIndexBuffer=o["a"].createIndex(e,35044,new Uint32Array(a.buffer,4*i,d)),i+=d,this.iconOpacityBuffer=o["a"].createVertex(e,35044,Object(r["t"])(this.iconOpacity).buffer),this.textOpacityBuffer=o["a"].createVertex(e,35044,Object(r["t"])(this.textOpacity).buffer);const u=this.layer,p=u.iconMaterial,f=u.textMaterial;this.iconVertexArrayObject=new c["a"](e,p.getAttributeLocations(),p.getLayoutInfo(),{geometry:this.iconVertexBuffer,opacity:this.iconOpacityBuffer},this.iconIndexBuffer),this.textVertexArrayObject=new c["a"](e,f.getAttributeLocations(),f.getLayoutInfo(),{geometry:this.textVertexBuffer,opacity:this.textOpacityBuffer},this.textIndexBuffer)}}class f extends h{constructor(e,t){super(e,t),this.type=4,this.circleIndexStart=0,this.circleIndexCount=0;const i=new Uint32Array(e);let r=this.bufferDataOffset;this.circleIndexStart=i[r++],this.circleIndexCount=i[r++],this.bufferDataOffset=r}hasData(){return this.circleIndexCount>0}triangleCount(){return this.circleIndexCount/3}doDestroy(){Object(r["k"])(this.circleVertexArrayObject)&&this.circleVertexArrayObject.dispose(),Object(r["k"])(this.circleVertexBuffer)&&this.circleVertexBuffer.dispose(),Object(r["k"])(this.circleIndexBuffer)&&this.circleIndexBuffer.dispose(),this.circleVertexArrayObject=null,this.circleVertexBuffer=null,this.circleIndexBuffer=null,this.memoryUsed=0}doPrepareForRendering(e,t,i){const r=new Uint32Array(t),a=new Int32Array(r.buffer),n=r[i++];this.circleVertexBuffer=o["a"].createVertex(e,35044,new Int32Array(a.buffer,4*i,n)),i+=n;const s=r[i++];this.circleIndexBuffer=o["a"].createIndex(e,35044,new Uint32Array(r.buffer,4*i,s)),i+=s;const l=this.layer.circleMaterial;this.circleVertexArrayObject=new c["a"](e,l.getAttributeLocations(),l.getLayoutInfo(),{geometry:this.circleVertexBuffer},this.circleIndexBuffer)}}var m=i("e4b1");class b extends m["a"]{constructor(e,t,i,r,a=null){super(e,i,r,[4096,4096]),this._memCache=a,this._referenced=0,this._hasSymbolBuckets=!1,this._memoryUsedByLayerData=0,this.layerData=new Map,this.layerCount=0,this.status="loading",this.allSymbolsFadingOut=!1,this.lastOpacityUpdate=0,this.symbols=new Map,this.isCoverage=!1,this.neededForCoverage=!1,this.decluttered=!1,this.invalidating=!1,this.parentTile=null,this.childrenTiles=new Set,this._processed=!1,this._referenced=1,this.styleRepository=t,this.id=e.id,this.transforms.tileUnitsToPixels=Object(n["b"])()}get hasSymbolBuckets(){return this._hasSymbolBuckets}get isFading(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<s["d"]}get isHoldingForFade(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<s["d"])}get wasRequested(){return"errored"===this.status||"loaded"===this.status||"reloading"===this.status}setData(e){this.changeDataImpl(e),this.requestRender(),this.ready(),this.invalidating=!1,this._processed=!0}deleteLayerData(e){let t=!1;for(const i of e)if(this.layerData.has(i)){const e=this.layerData.get(i);this._memoryUsedByLayerData-=e.memoryUsed,3===e.type&&this.symbols.has(i)&&(this.symbols.delete(i),t=!0),e.destroy(),this.layerData.delete(i),this.layerCount--}Object(r["k"])(this._memCache)&&this._memCache.updateSize(this.key.id,this,this._memoryUsedByLayerData),t&&this.emit("symbols-changed"),this.requestRender()}processed(){return this._processed}hasData(){return this.layerCount>0}dispose(){"unloaded"!==this.status&&(g.delete(this),b._destroyRenderBuckets(this.layerData),this.layerData=null,this.layerCount=0,this._memoryUsedByLayerData=0,this.destroy(),this.status="unloaded")}release(){return 0==--this._referenced&&(this.dispose(),this.stage=null,!0)}retain(){++this._referenced}get referenced(){return this._referenced}getMemoryUsage(){return(this._memoryUsedByLayerData+256)/(this._referenced||1)}changeDataImpl(e){let t=!1;if(e){const i=this._createRenderBuckets(e);for(const[e,r]of i){if(this.layerData.has(e)){const t=this.layerData.get(e);this._memoryUsedByLayerData-=r.memoryUsed,t.destroy(),this.layerData.delete(e),this.layerCount--}3===r.type&&(this.symbols.set(e,r.symbols),t=!0),this._memoryUsedByLayerData+=r.memoryUsed,this.layerData.set(e,r),this.layerCount++}Object(r["k"])(this._memCache)&&this._memCache.updateSize(this.key.id,this,this._memoryUsedByLayerData)}this._hasSymbolBuckets=!1;for(const[i,r]of this.layerData)3===r.type&&(this._hasSymbolBuckets=!0);t&&this.emit("symbols-changed")}attachWithContext(e){this.stage={context:e,trashDisplayObject(e){e.processDetach()},untrashDisplayObject:()=>!1}}setTransform(e,t){super.setTransform(e,t);const i=t/(e.resolution*e.pixelRatio),r=this.size[0]/this.coordRange[0]*i,n=this.size[1]/this.coordRange[1]*i,s=[0,0];e.toScreen(s,this.coords);const o=this.transforms.tileUnitsToPixels;Object(a["h"])(o),Object(a["a"])(o,o,s),Object(a["l"])(o,o,Math.PI*e.rotation/180),Object(a["c"])(o,o,[r,n,1])}static _destroyRenderBuckets(e){if(!e)return;const t=new Set;e.forEach(e=>{t.has(e)||(e.destroy(),t.add(e))}),e.clear()}_createRenderBuckets(e){const t=new Map,i=new Map;for(const r of e){const e=this._deserializeBucket(r,i);for(const i of e.layerUIDs)t.set(i,e)}return t}_deserializeBucket(e,t){let i=t.get(e);if(i)return i;switch(new Uint32Array(e)[0]){case 1:i=new u(e,this.styleRepository);break;case 2:i=new d(e,this.styleRepository);break;case 3:i=new p(e,this.styleRepository,this);break;case 4:i=new f(e,this.styleRepository)}return t.set(e,i),i}}const g=new Map;function v(){g.forEach((e,t)=>{console.log(`\n${t.key}:`),e[0].forEach(e=>console.log(e)),console.log("========"),e[1].forEach(e=>console.log(e))})}},6706:function(e,t,i){"use strict";i.d(t,"a",(function(){return d})),i.d(t,"b",(function(){return h})),i.d(t,"c",(function(){return u})),i.d(t,"d",(function(){return l})),i.d(t,"e",(function(){return p})),i.d(t,"f",(function(){return c}));var r=i("4ae5"),a=i("a915"),n=i("0b2d"),s=i("3349"),o=i("f408");function c(e,t){const i=e.x-t.x,r=e.y-t.y;return i*i+r*r}function l(e,t){const i=e.length===t.length&&e[0]===t[0]&&e[1]===t[1];switch(e.length){case 2:return i;case 3:return i&&e[2]===t[2];case 4:return i&&e[3]===t[3]}return!1}function h(e,t,i,r){return"2d"===r.type?r.toScreen(t.toPoint(e,b)):(d(e,t,i,r,f),r.state.camera.projectToScreen(f,m),Object(a["f"])(m[0],m[1]))}function d(e,t,i,r,a=Object(n["e"])()){const s=t.toXYZ(e);return s[2]=Object(o["b"])(r,s,t.spatialReference,i)||0,r.renderCoordsHelper.toRenderCoords(s,t.spatialReference,a),a}function u(e,t,i,r,a,n,s){const c=i.toXYZ(e),l=i.toXYZ(t),h=Object(o["b"])(a,c,i.spatialReference,r),d=Object(o["b"])(a,l,i.spatialReference,r),u=(null==h?d:null==d?h:Math.min(h,d))||0;c[2]=u,l[2]=u,a.renderCoordsHelper.toRenderCoords(c,i.spatialReference,n),a.renderCoordsHelper.toRenderCoords(l,i.spatialReference,s)}function p(e,t){t.sort((t,i)=>Object(s["j"])(t.targetPoint,e)-Object(s["j"])(i.targetPoint,e))}const f=Object(n["e"])(),m=Object(a["g"])(),b=new r["a"]},6750:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i("3886");function a(e,t){e.constants.add("stippleAlphaColorDiscard","float",.001),e.constants.add("stippleAlphaHighlightDiscard","float",.5),t.stippleEnabled?n(e,t):s(e)}function n(e,t){e.vertex.uniforms.add("stipplePatternPixelSizeInv","float"),t.stippleUVMaxEnabled&&e.varyings.add("stipplePatternUvMax","float"),e.varyings.add("stipplePatternUv","float"),e.fragment.uniforms.add("stipplePatternTexture","sampler2D"),t.stippleOffColorEnabled&&e.fragment.uniforms.add("stippleOffColor","vec4"),e.fragment.code.add(r["a"]`
  float getStippleAlpha() {
    float stipplePatternUvClamped = stipplePatternUv * gl_FragCoord.w;
    ${t.stippleUVMaxEnabled?"stipplePatternUvClamped = clamp(stipplePatternUvClamped, 0.0, stipplePatternUvMax);":""}

    return texture2D(stipplePatternTexture, vec2(mod(stipplePatternUvClamped, 1.0), 0.5)).a;
  }`),t.stippleOffColorEnabled?e.fragment.code.add(r["a"]`
    #define discardByStippleAlpha(stippleAlpha, threshold) {}
    #define blendStipple(color, stippleAlpha) mix(color, stippleOffColor, stippleAlpha)
    `):e.fragment.code.add(r["a"]`
    #define discardByStippleAlpha(stippleAlpha, threshold) if (stippleAlpha < threshold) { discard; }
    #define blendStipple(color, stippleAlpha) vec4(color.rgb, color.a * stippleAlpha)
    `)}function s(e){e.fragment.code.add(r["a"]`
  float getStippleAlpha() { return 1.0; }

  #define discardByStippleAlpha(_stippleAlpha_, _threshold_) {}
  #define blendStipple(color, _stippleAlpha_) color
  `)}},"6a21":function(e,t,i){"use strict";i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return o}));var r=i("c120"),a=i("3886"),n=i("998f");function s({code:e},t){t.doublePrecisionRequiresObfuscation?e.add(a["a"]`
      vec3 dpPlusFrc(vec3 a, vec3 b) {
        return mix(a, a + b, vec3(notEqual(b, vec3(0))));
      }

      vec3 dpMinusFrc(vec3 a, vec3 b) {
        return mix(vec3(0), a - b, vec3(notEqual(a, b)));
      }

      // based on https://www.thasler.com/blog/blog/glsl-part2-emu
      vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
        vec3 t1 = dpPlusFrc(hiA, hiB);
        vec3 e = dpMinusFrc(t1, hiA);
        vec3 t2 = dpMinusFrc(hiB, e) + dpMinusFrc(hiA, dpMinusFrc(t1, e)) + loA + loB;
        return t1 + t2;
      }
    `):e.add(a["a"]`
      vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
        vec3 t1 = hiA + hiB;
        vec3 e = t1 - hiA;
        vec3 t2 = ((hiB - e) + (hiA - (t1 - e))) + loA + loB;
        return t1 + t2;
      }
    `)}function o(e){return!!Object(r["a"])("force-double-precision-obfuscation")||Object(n["b"])(e).doublePrecisionRequiresObfuscation}},"6ae9":function(e,t,i){"use strict";i.d(t,"a",(function(){return h})),i.d(t,"b",(function(){return l})),i.d(t,"c",(function(){return d})),i.d(t,"d",(function(){return c}));var r=i("b2b2"),a=i("1219"),n=i("521c"),s=(i("e06a"),i("ce6d")),o=i("8b1a");class c{constructor(e){this.left=null,this.right=null,this.type="vertex",this.index=null,this.component=e}get pos(){return this._pos}set pos(e){this._pos=e,this.component.unnormalizeVertexPositions()}}class l{constructor(e,t,i){this.type="edge",this.component=e,this.left=t,this.right=i,t.right=this,i.left=this}}class h{constructor(e){this.vertices=[],this.edges=[],this.data=e}unnormalizeVertexPositions(){this.vertices.length<=1||this.data.coordinateHelper.unnormalize(this.vertices)}updateVertexIndex(e,t){if(0===this.vertices.length)return;const i=this.vertices[0];let r=null,a=e,n=t;do{r=a,r.index=n++,a=r.right?r.right.right:null}while(null!=a&&a!==i);r.left&&r!==this.vertices[this.vertices.length-1]&&this.swapVertices(this.vertices.indexOf(r),this.vertices.length-1)}getFirstVertex(){return 0===this.vertices.length?null:this.vertices[0]}getLastVertex(){return 0===this.vertices.length?null:this.vertices[this.vertices.length-1]}swapVertices(e,t){const i=this.vertices[e];this.vertices[e]=this.vertices[t],this.vertices[t]=i}iterateVertices(e){if(0===this.vertices.length)return;const t=this.vertices[0];let i=t;do{e(i,i.index),i=Object(r["k"])(i.right)?i.right.right:null}while(i!==t&&null!=i)}}class d extends s["a"]{constructor(e){super(),this.coordinateHelper=e,this.undoStack=[],this.redoStack=[],this.components=[]}apply(e,t=1){0!==t&&!Object(r["j"])(this.lastOperation)&&this.lastOperation.accumulate(e)||(e.apply(),this.undoStack.push(e),this.redoStack=[])}undo(){if(this.undoStack.length>0){const e=this.undoStack.pop();return e.undo(),this.redoStack.push(e),e}return null}get canUndo(){return this.undoStack.length>0}get lastOperation(){return this.undoStack.length>0?this.undoStack[this.undoStack.length-1]:null}redo(){if(this.redoStack.length>0){const e=this.redoStack.pop();return e.apply(),this.undoStack.push(e),e}return null}get canRedo(){return this.redoStack.length>0}toPoint(){return 0===this.components.length||0===this.components[0].vertices.length?null:this.coordinateHelper.createPoint(this.components[0].vertices[0].pos)}toPolyline(){const e=[],t=this.coordinateHelper.toArray;return this.components.forEach((i,r)=>{const a=[];let n=i.vertices.find(e=>null==e.left);const s=n;do{a.push(t(n.pos)),n=n.right?n.right.right:null}while(n&&n!==s);e.push(a)}),new n["a"]({paths:e,spatialReference:this.coordinateHelper.spatialReference})}toPolygon(){const e=[],t=this.coordinateHelper.toArray;return this.components.forEach((i,a)=>{const n=[],s=i.vertices[0];let o=s;const c=o;do{n.push(t(o.pos)),o=Object(r["k"])(o.right)?o.right.right:null}while(o&&o!==c);n.push(t(s.pos)),e.push(n)}),new a["a"]({rings:e,spatialReference:this.coordinateHelper.spatialReference})}static fromGeometry(e,t){const i=Object(o["a"])(e.hasZ,e.hasM,e.spatialReference,t),r=new d(i);switch(e.type){case"polygon":{const t=e.rings;for(let e=0;e<t.length;++e){const a=t[e],n=new h(r),s=a.length-1;for(let e=0;e<s;++e){const t=i.fromArray(a[e]),r=new c(n);n.vertices.push(r),r.pos=t,r.index=e}const o=n.vertices.length-1;for(let e=0;e<o;++e){const t=n.vertices[e],i=n.vertices[e+1],r=new l(n,t,i);n.edges.push(r)}const d=new l(n,n.vertices[n.vertices.length-1],n.vertices[0]);n.edges.push(d),r.components.push(n)}}break;case"polyline":for(const t of e.paths){const e=new h(r),a=t.length;for(let r=0;r<a;++r){const a=i.fromArray(t[r]),n=new c(e);e.vertices.push(n),n.pos=a,n.index=r}const n=e.vertices.length-1;for(let t=0;t<n;++t){const i=e.vertices[t],r=e.vertices[t+1],a=new l(e,i,r);e.edges.push(a)}r.components.push(e)}break;case"point":{const t=new h(r),i=new c(t);i.index=0,i.pos=r.coordinateHelper.fromPoint(e),t.vertices.push(i),r.components.push(t)}}return r}}},"6b38":function(e,t,i){"use strict";i.d(t,"a",(function(){return v}));var r=i("6c97"),a=i("38a4"),n=i("0b2d"),s=i("e431"),o=i("680b"),c=i("f694"),l=i("d791"),h=i("9180"),d=i("8188"),u=i("afe1"),p=i("4261"),f=i("d0ac"),m=i("de58");const b=.5*Math.PI,g=b/Math.PI*180;class v{constructor(e){this.renderCoordsHelper=e.renderCoordsHelper,this.extent=new Array(4),this.planes=new Array(6),this.maxSpan=0,this.center={origin:Object(n["e"])(),direction:Object(n["e"])()};for(let t=0;t<4;t++)this.extent[t]={origin:Object(n["e"])(),direction:Object(n["e"])(),cap:{next:null,direction:Object(n["e"])()}},this.planes[t]=f["f"].create();this.planes[4]=f["f"].create(),this.planes[5]=f["f"].create(),this.planesWithoutFar=this.planes.slice(0,5)}update(e,t,i,r=!0){const a=this.extent;this.toRenderBoundingExtent(e,t,i),Object(s["g"])(this.center.origin,a[0].origin,a[2].origin),Object(s["f"])(this.center.origin,this.center.origin,.5),this.renderCoordsHelper.worldUpAtPosition(this.center.origin,this.center.direction),r||Object(s["f"])(this.center.direction,this.center.direction,-1);for(let n=0;n<4;n++){const e=a[n];this.renderCoordsHelper.worldUpAtPosition(e.origin,e.direction);const t=a[3===n?0:n+1];e.cap.next=t.origin,Object(o["h"])(e.cap.direction,e.origin,t.origin),f["f"].fromVectorsAndPoint(e.direction,e.cap.direction,e.origin,this.planes[n]),r||Object(s["f"])(e.direction,e.direction,-1)}f["f"].fromVectorsAndPoint(a[0].cap.direction,a[1].cap.direction,a[0].origin,this.planes[4]),r?f["f"].negate(this.planes[4],this.planes[5]):(f["f"].copy(this.planes[4],this.planes[5]),f["f"].negate(this.planes[4],this.planes[4])),this.maxSpan=Math.max(Math.abs(e[0]-e[2]),Math.abs(e[1]-e[3])),this.maxSpanSpatialReference=t,this.minGlobalAltitude=.9*Object(c["e"])(this.maxSpanSpatialReference).radius}isVisibleInFrustum(e,t,i=!1){if(null==e)return!1;if(1===this.renderCoordsHelper.viewingMode){const i=this.maxSpanSpatialReference.isGeographic?g:b*t;if(this.maxSpan>i)return!0;if(e.altitude>=this.minGlobalAltitude)return this.isVisibleInFrustumGlobal(e)}if(0===this.maxSpan){const t=this.extent[0];return!(i||!e.intersectsRay(f["g"].wrap(t.origin,t.direction)))}for(let a=0;a<this.extent.length;a++){const t=this.extent[a];if(!i&&e.intersectsRay(f["g"].wrap(t.origin,t.direction)))return!0;if(e.intersectsLineSegment(f["e"].fromPoints(t.origin,t.cap.next,w),t.cap.direction))return!0}const r=i?this.planes:this.planesWithoutFar;for(let a=0;a<e.lines.length;a++){const t=e.lines[a];if(Object(m["b"])(r,t.origin,t.endpoint,t.direction))return!0}return!1}toRenderBoundingExtentGlobal(e,t,i){const r=5;Object(h["e"])(e,O),O[2]=i,Object(d["d"])(t,O,_,this.renderCoordsHelper.spatialReference),Object(l["a"])(x,_),Object(p["k"])(j);for(const{x0:n,x1:o,y0:c,y1:l}of y)for(let h=0;h<r;h++){const u=h/(r-1);O[0]=Object(a["l"])(e[n],e[o],u),O[1]=Object(a["l"])(e[c],e[l],u),O[2]=i,Object(d["y"])(O,t,O,this.renderCoordsHelper.spatialReference),Object(s["n"])(O,O,x),Object(p["r"])(j,O)}Object(s["x"])(this.extent[0].origin,j[0],j[1],j[2]),Object(s["x"])(this.extent[1].origin,j[3],j[1],j[2]),Object(s["x"])(this.extent[2].origin,j[3],j[4],j[2]),Object(s["x"])(this.extent[3].origin,j[0],j[4],j[2]);for(let a=0;a<4;++a)Object(s["n"])(this.extent[a].origin,this.extent[a].origin,_)}toRenderBoundingExtentLocal(e,t){Object(s["x"])(this.extent[0].origin,e[0],e[1],t),Object(s["x"])(this.extent[1].origin,e[2],e[1],t),Object(s["x"])(this.extent[2].origin,e[2],e[3],t),Object(s["x"])(this.extent[3].origin,e[0],e[3],t)}toRenderBoundingExtent(e,t,i){switch(this.renderCoordsHelper.viewingMode){case 1:this.toRenderBoundingExtentGlobal(e,t,i);break;case 2:this.toRenderBoundingExtentLocal(e,i);break;default:Object(r["a"])(this.renderCoordsHelper.viewingMode)}}isVisibleInFrustumGlobal(e){if(Object(s["i"])(this.center.direction,e.direction)<0)return!0;for(let t=0;t<4;t++){const i=this.extent[t];if(Object(s["i"])(i.direction,e.direction)<0)return!0}return!1}}const y=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],O=Object(n["e"])(),_=Object(u["b"])(),x=Object(u["b"])(),j=Object(p["h"])(),w=f["e"].create()},"6cb2":function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i("3886"),a=i("5876");function n(e,t){t.symbolColor?(e.include(a["a"]),e.attributes.add("symbolColor","vec4"),e.varyings.add("colorMixMode","mediump float")):e.fragment.uniforms.add("colorMixMode","int"),t.symbolColor?e.vertex.code.add(r["a"]`
    int symbolColorMixMode;

    vec4 getSymbolColor() {
      return decodeSymbolColor(symbolColor, symbolColorMixMode) * 0.003921568627451;
    }

    void forwardColorMixMode() {
      colorMixMode = float(symbolColorMixMode) + 0.5;
    }
  `):e.vertex.code.add(r["a"]`
    vec4 getSymbolColor() { return vec4(1.0); }
    void forwardColorMixMode() {}
    `)}},"6df2":function(e,t,i){"use strict";i("c120");var r=i("b2b2"),a=i("189c"),n=i("c514");const s=33984;class o{constructor(){for(this._current=new Array,this._max=new Array,this._allocations=new Map;this._current.length<6;)this._current.push(0),this._max.push(0)}resetMax(){for(this._max.length=0;this._max.length<this._current.length;)this._max.push(0)}increment(e,t){const i=++this._current[e];this._max[e]=Math.max(i,this._max[e])}decrement(e,t){--this._current[e]}get max(){return this._max}get current(){return this._current}printResourceCount(){if(console.log("Live objects:"),console.log("Textures: "+this._current[0]),console.log("Buffers: "+this._current[1]),console.log("VAOs: "+this._current[2]),console.log("Programs: "+this._current[3]),console.log("Framebuffers: "+this._current[4]),console.log("Renderbuffers: "+this._current[5]),this._allocations.size>0){console.log(this._allocations.size+" live object allocations:");const e=new Map;this._allocations.forEach(t=>{var i;e.set(t,(null!=(i=e.get(t))?i:0)+1)}),e.forEach((e,t)=>console.log(e," : ",t))}}}var c=i("1a9a");function l(e,t){if(t.disjointTimerQuery)return null;if(Object(n["a"])(e))return{drawBuffers:e.drawBuffers.bind(e),MAX_DRAW_BUFFERS:e.MAX_DRAW_BUFFERS,MAX_COLOR_ATTACHMENTS:e.MAX_COLOR_ATTACHMENTS};if(t.drawBuffers)return null;const i=e.getExtension("WEBGL_draw_buffers");return i?{drawBuffers:i.drawBuffersWEBGL.bind(i),MAX_DRAW_BUFFERS:i.MAX_DRAW_BUFFERS_WEBGL,MAX_COLOR_ATTACHMENTS:i.MAX_COLOR_ATTACHMENTS_WEBGL}:null}function h(e){if(Object(n["a"])(e))return{drawArraysInstanced:e.drawArraysInstanced.bind(e),drawElementsInstanced:e.drawElementsInstanced.bind(e),vertexAttribDivisor:e.vertexAttribDivisor.bind(e)};const t=e.getExtension("ANGLE_instanced_arrays");return t?{drawArraysInstanced:t.drawArraysInstancedANGLE.bind(t),drawElementsInstanced:t.drawElementsInstancedANGLE.bind(t),vertexAttribDivisor:t.vertexAttribDivisorANGLE.bind(t)}:null}function d(e,t){const i=t.loseContext&&e.getExtension("WEBGL_lose_context");return i?{loseRenderingContext:()=>i.loseContext()}:null}function u(e,t){if(Object(n["a"])(e))return{createVertexArray:e.createVertexArray.bind(e),deleteVertexArray:e.deleteVertexArray.bind(e),bindVertexArray:e.bindVertexArray.bind(e)};if(t.vao)return null;const i=e.getExtension("OES_vertex_array_object")||e.getExtension("MOZ_OES_vertex_array_object")||e.getExtension("WEBKIT_OES_vertex_array_object");return i?{createVertexArray:i.createVertexArrayOES.bind(i),deleteVertexArray:i.deleteVertexArrayOES.bind(i),bindVertexArray:i.bindVertexArrayOES.bind(i)}:null}function p(e,t){const i=t&&t.disabledExtensions||{},r=t&&t.debugWebGLExtensions||{};let a,n,s,o,p,_,x,j,w,S,C,T=null,P=null,A=null,R=null;return{get drawBuffers(){return C||(C=l(e,i)),C},get instancing(){return a||(a=h(e)),a},get vao(){return n||(n=u(e,i)),n},get compressedTextureETC(){return s||(s=f(e,i)),s},get compressedTextureS3TC(){return o||(o=m(e,i)),o},get textureFilterAnisotropic(){return p||(p=g(e,i)),p},get disjointTimerQuery(){return _||(_=Object(c["a"])(e,i)),_},get textureFloat(){return x||(x=v(e,i)),x},get colorBufferFloat(){return j||(j=y(e,i)),j},get blendMinMax(){return w||(w=b(e,i)),w},get depthTexture(){return null===T&&(T=O(e,i,"depthTexture",!0,["WEBGL_depth_texture","MOZ_WEBGL_depth_texture","WEBKIT_WEBGL_depth_texture"])),T},get standardDerivatives(){return null===P&&(P=O(e,i,"standardDerivatives",!0,["OES_standard_derivatives"])),P},get shaderTextureLOD(){return null===A&&(A=O(e,i,"shaderTextureLOD",!0,["EXT_shader_texture_lod"])),A},get fragDepth(){return null===R&&(R=O(e,i,"fragDepth",!0,["EXT_frag_depth"])),R},get loseContext(){return S||(S=d(e,r)),S},enable(e){return this[e]}}}function f(e,t){if(t.compressedTextureETC)return null;const i=e.getExtension("WEBGL_compressed_texture_etc");return i?{COMPRESSED_R11_EAC:i.COMPRESSED_R11_EAC,COMPRESSED_SIGNED_R11_EAC:i.COMPRESSED_SIGNED_R11_EAC,COMPRESSED_RG11_EAC:i.COMPRESSED_RG11_EAC,COMPRESSED_SIGNED_RG11_EAC:i.COMPRESSED_SIGNED_RG11_EAC,COMPRESSED_RGB8_ETC2:i.COMPRESSED_RGB8_ETC2,COMPRESSED_SRGB8_ETC2:i.COMPRESSED_SRGB8_ETC2,COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:i.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:i.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_RGBA8_ETC2_EAC:i.COMPRESSED_RGBA8_ETC2_EAC,COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:i.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC}:null}function m(e,t){if(t.compressedTextureS3TC)return null;const i=e.getExtension("WEBGL_compressed_texture_s3tc");return i?{COMPRESSED_RGB_S3TC_DXT1:i.COMPRESSED_RGB_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT1:i.COMPRESSED_RGBA_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT3:i.COMPRESSED_RGBA_S3TC_DXT3_EXT,COMPRESSED_RGBA_S3TC_DXT5:i.COMPRESSED_RGBA_S3TC_DXT5_EXT}:null}function b(e,t){if(Object(n["a"])(e))return{MIN:e.MIN,MAX:e.MAX};if(t.blendMinMax)return null;{const t=e.getExtension("EXT_blend_minmax");return t?{MIN:t.MIN_EXT,MAX:t.MAX_EXT}:null}}function g(e,t){if(t.textureFilterAnisotropic)return null;const i=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");return i?{MAX_TEXTURE_MAX_ANISOTROPY:i.MAX_TEXTURE_MAX_ANISOTROPY_EXT,TEXTURE_MAX_ANISOTROPY:i.TEXTURE_MAX_ANISOTROPY_EXT}:null}function v(e,t){if(Object(n["a"])(e))return{textureFloat:!0,textureFloatLinear:!t.textureFloatLinear&&!!e.getExtension("OES_texture_float_linear"),textureHalfFloat:!0,textureHalfFloatLinear:!t.textureHalfFloatLinear&&!!e.getExtension("OES_texture_half_float_linear"),HALF_FLOAT:e.HALF_FLOAT};if(e instanceof WebGLRenderingContext){const i=!t.textureHalfFloat&&e.getExtension("OES_texture_half_float");return{textureFloat:!t.textureFloat&&!!e.getExtension("OES_texture_float"),textureFloatLinear:!t.textureFloatLinear&&!!e.getExtension("OES_texture_float_linear"),textureHalfFloat:!!i,textureHalfFloatLinear:!t.textureHalfFloatLinear&&!!e.getExtension("OES_texture_half_float_linear"),HALF_FLOAT:i?i.HALF_FLOAT_OES:void 0}}return null}function y(e,t){if(Object(n["a"])(e)){const i=!t.colorBufferFloat&&e.getExtension("EXT_color_buffer_half_float"),r=!t.colorBufferFloat&&e.getExtension("EXT_color_buffer_float"),a=!t.colorBufferFloat&&e.getExtension("EXT_float_blend");return i||r||a?{textureFloat:!!r,textureHalfFloat:!!i,R16F:e.R16F,RG16F:e.RG16F,RGBA16F:e.RGBA16F,R32F:e.R32F,RG32F:e.RG32F,RGBA32F:e.RGBA32F,R11F_G11F_B10F:e.R11F_G11F_B10F,RGB16F:e.RGB16F}:null}if(e instanceof WebGLRenderingContext){const i=!t.colorBufferFloat&&e.getExtension("EXT_color_buffer_half_float"),r=!t.colorBufferFloat&&e.getExtension("WEBGL_color_buffer_float"),a=!t.colorBufferFloat&&e.getExtension("EXT_float_blend");return i||r||a?{textureFloat:!!r,textureHalfFloat:!!i,RGBA16F:i?i.RGBA16F_EXT:void 0,RGB16F:i?i.RGB16F_EXT:void 0,RGBA32F:r?r.RGBA32F_EXT:void 0}:null}return null}function O(e,t,i,r,a){if(r&&Object(n["a"])(e))return!0;if(t[i])return!1;for(const n of a)if(e.getExtension(n))return!0;return!1}class _{constructor(e,t){this.gl=null,this.instanceCounter=new o,this._blendEnabled=!1,this._blendColorState={r:0,g:0,b:0,a:0},this._blendFunctionState={srcRGB:1,dstRGB:0,srcAlpha:1,dstAlpha:0},this._blendEquationState={mode:32774,modeAlpha:32774},this._colorMaskState={r:!0,g:!0,b:!0,a:!0},this._polygonCullingEnabled=!1,this._cullFace=1029,this._frontFace=2305,this._scissorTestEnabled=!1,this._scissorRect={x:0,y:0,width:0,height:0},this._depthTestEnabled=!1,this._depthFunction=513,this._clearDepth=1,this._depthWriteEnabled=!0,this._depthRange={zNear:0,zFar:1},this._viewport=null,this._stencilTestEnabled=!1,this._polygonOffsetFillEnabled=!1,this._polygonOffset=[0,0],this._stencilFunction={face:1032,func:519,ref:0,mask:1},this._clearStencil=0,this._stencilWriteMask=1,this._stencilOperation={face:1032,fail:7680,zFail:7680,zPass:7680},this._clearColor={r:0,g:0,b:0,a:0},this._activeShaderProgram=null,this._activeVertexBuffer=null,this._activeIndexBuffer=null,this._activeFramebuffer=null,this._activeRenderbuffer=null,this._activeTextureUnit=0,this._textureUnitMap=[],this._numOfDrawCalls=0,this._numOfTriangles=0,this.contextVersion=Object(n["a"])(e)?"webgl2":"webgl",this.gl=e,e instanceof WebGLRenderingContext&&this.gl.getExtension("OES_element_index_uint"),this._capabilities=p(e,t);const i=this.gl.getParameter(this.gl.VIEWPORT);this._viewport={x:i[0],y:i[1],width:i[2],height:i[3]},this._stateTracker=new a["a"]({setBlending:e=>{if(e){this.setBlendingEnabled(!0),this.setBlendEquationSeparate(e.opRgb,e.opAlpha),this.setBlendFunctionSeparate(e.srcRgb,e.dstRgb,e.srcAlpha,e.dstAlpha);const t=e.color;this.setBlendColor(t.r,t.g,t.b,t.a)}else this.setBlendingEnabled(!1)},setCulling:e=>{e?(this.setFaceCullingEnabled(!0),this.setCullFace(e.face),this.setFrontFace(e.mode)):this.setFaceCullingEnabled(!1)},setPolygonOffset:e=>{e?(this.setPolygonOffsetFillEnabled(!0),this.setPolygonOffset(e.factor,e.units)):this.setPolygonOffsetFillEnabled(!1)},setDepthTest:e=>{e?(this.setDepthTestEnabled(!0),this.setDepthFunction(e.func)):this.setDepthTestEnabled(!1)},setStencilTest:e=>{if(e){this.setStencilTestEnabled(!0);const t=e.function;this.setStencilFunction(t.func,t.ref,t.mask);const i=e.operation;this.setStencilOp(i.fail,i.zFail,i.zPass)}else this.setStencilTestEnabled(!1)},setDepthWrite:e=>{e?(this.setDepthWriteEnabled(!0),this.setDepthRange(e.zNear,e.zFar)):this.setDepthWriteEnabled(!1)},setColorWrite:e=>{e?this.setColorMask(e.r,e.g,e.b,e.a):this.setColorMask(!1,!1,!1,!1)},setStencilWrite:e=>{e?this.setStencilWriteMask(e.mask):this.setStencilWriteMask(0)}}),this.enforceState()}isWebGL2Context(){return"webgl2"===this.contextVersion}get contextAttributes(){return this.gl.getContextAttributes()}get parameters(){if(!this._parameters){const e=this.capabilities.textureFilterAnisotropic;this._parameters={versionString:this.gl.getParameter(this.gl.VERSION),maxVertexTextureImageUnits:this.gl.getParameter(this.gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxVertexAttributes:this.gl.getParameter(this.gl.MAX_VERTEX_ATTRIBS),maxMaxAnisotropy:e?this.gl.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY):void 0,maxTextureImageUnits:this.gl.getParameter(this.gl.MAX_TEXTURE_IMAGE_UNITS),maxTextureSize:this.gl.getParameter(this.gl.MAX_TEXTURE_SIZE)}}return this._parameters}dispose(){this.bindVAO(null),this.unbindBuffer(34962),this.unbindBuffer(34963),this._textureUnitMap=[],this.gl=null,this._capabilities=null}setPipelineState(e){this._stateTracker.setPipeline(e)}setBlendingEnabled(e){this._blendEnabled!==e&&(!0===e?this.gl.enable(this.gl.BLEND):this.gl.disable(this.gl.BLEND),this._blendEnabled=e,this._stateTracker.invalidateBlending())}setBlendColor(e,t,i,r){e===this._blendColorState.r&&t===this._blendColorState.g&&i===this._blendColorState.b&&r===this._blendColorState.a||(this.gl.blendColor(e,t,i,r),this._blendColorState.r=e,this._blendColorState.g=t,this._blendColorState.b=i,this._blendColorState.a=r,this._stateTracker.invalidateBlending())}setBlendFunction(e,t){e===this._blendFunctionState.srcRGB&&t===this._blendFunctionState.dstRGB||(this.gl.blendFunc(e,t),this._blendFunctionState.srcRGB=e,this._blendFunctionState.srcAlpha=e,this._blendFunctionState.dstRGB=t,this._blendFunctionState.dstAlpha=t,this._stateTracker.invalidateBlending())}setBlendFunctionSeparate(e,t,i,r){this._blendFunctionState.srcRGB===e&&this._blendFunctionState.srcAlpha===i&&this._blendFunctionState.dstRGB===t&&this._blendFunctionState.dstAlpha===r||(this.gl.blendFuncSeparate(e,t,i,r),this._blendFunctionState.srcRGB=e,this._blendFunctionState.srcAlpha=i,this._blendFunctionState.dstRGB=t,this._blendFunctionState.dstAlpha=r,this._stateTracker.invalidateBlending())}setBlendEquation(e){this._blendEquationState.mode!==e&&(this.gl.blendEquation(e),this._blendEquationState.mode=e,this._blendEquationState.modeAlpha=e,this._stateTracker.invalidateBlending())}setBlendEquationSeparate(e,t){this._blendEquationState.mode===e&&this._blendEquationState.modeAlpha===t||(this.gl.blendEquationSeparate(e,t),this._blendEquationState.mode=e,this._blendEquationState.modeAlpha=t,this._stateTracker.invalidateBlending())}setColorMask(e,t,i,r){this._colorMaskState.r===e&&this._colorMaskState.g===t&&this._colorMaskState.b===i&&this._colorMaskState.a===r||(this.gl.colorMask(e,t,i,r),this._colorMaskState.r=e,this._colorMaskState.g=t,this._colorMaskState.b=i,this._colorMaskState.a=r,this._stateTracker.invalidateColorWrite())}setClearColor(e,t,i,r){this._clearColor.r===e&&this._clearColor.g===t&&this._clearColor.b===i&&this._clearColor.a===r||(this.gl.clearColor(e,t,i,r),this._clearColor.r=e,this._clearColor.g=t,this._clearColor.b=i,this._clearColor.a=r)}setFaceCullingEnabled(e){this._polygonCullingEnabled!==e&&(!0===e?this.gl.enable(this.gl.CULL_FACE):this.gl.disable(this.gl.CULL_FACE),this._polygonCullingEnabled=e,this._stateTracker.invalidateCulling())}setPolygonOffsetFillEnabled(e){this._polygonOffsetFillEnabled!==e&&(!0===e?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL),this._polygonOffsetFillEnabled=e,this._stateTracker.invalidatePolygonOffset())}setPolygonOffset(e,t){this._polygonOffset[0]===e&&this._polygonOffset[1]===t||(this._polygonOffset[0]=e,this._polygonOffset[1]=t,this.gl.polygonOffset(e,t),this._stateTracker.invalidatePolygonOffset())}setCullFace(e){this._cullFace!==e&&(this.gl.cullFace(e),this._cullFace=e,this._stateTracker.invalidateCulling())}setFrontFace(e){this._frontFace!==e&&(this.gl.frontFace(e),this._frontFace=e,this._stateTracker.invalidateCulling())}setScissorTestEnabled(e){this._scissorTestEnabled!==e&&(!0===e?this.gl.enable(this.gl.SCISSOR_TEST):this.gl.disable(this.gl.SCISSOR_TEST),this._scissorTestEnabled=e)}setScissorRect(e,t,i,r){this._scissorRect.x===e&&this._scissorRect.y===t&&this._scissorRect.width===i&&this._scissorRect.height===r||(this.gl.scissor(e,t,i,r),this._scissorRect.x=e,this._scissorRect.y=t,this._scissorRect.width=i,this._scissorRect.height=r)}setDepthTestEnabled(e){this._depthTestEnabled!==e&&(!0===e?this.gl.enable(this.gl.DEPTH_TEST):this.gl.disable(this.gl.DEPTH_TEST),this._depthTestEnabled=e,this._stateTracker.invalidateDepthTest())}setClearDepth(e){this._clearDepth!==e&&(this.gl.clearDepth(e),this._clearDepth=e)}setDepthFunction(e){this._depthFunction!==e&&(this.gl.depthFunc(e),this._depthFunction=e,this._stateTracker.invalidateDepthTest())}setDepthWriteEnabled(e){this._depthWriteEnabled!==e&&(this.gl.depthMask(e),this._depthWriteEnabled=e,this._stateTracker.invalidateDepthWrite())}setDepthRange(e,t){this._depthRange.zNear===e&&this._depthRange.zFar===t||(this.gl.depthRange(e,t),this._depthRange.zNear=e,this._depthRange.zFar=t,this._stateTracker.invalidateDepthWrite())}setStencilTestEnabled(e){this._stencilTestEnabled!==e&&(!0===e?this.gl.enable(this.gl.STENCIL_TEST):this.gl.disable(this.gl.STENCIL_TEST),this._stencilTestEnabled=e,this._stateTracker.invalidateStencilTest())}setClearStencil(e){e!==this._clearStencil&&(this.gl.clearStencil(e),this._clearStencil=e)}setStencilFunction(e,t,i){this._stencilFunction.func===e&&this._stencilFunction.ref===t&&this._stencilFunction.mask===i||(this.gl.stencilFunc(e,t,i),this._stencilFunction.face=1032,this._stencilFunction.func=e,this._stencilFunction.ref=t,this._stencilFunction.mask=i,this._stateTracker.invalidateStencilTest())}setStencilFunctionSeparate(e,t,i,r){this._stencilFunction.face===e&&this._stencilFunction.func===t&&this._stencilFunction.ref===i&&this._stencilFunction.mask===r||(this.gl.stencilFuncSeparate(e,t,i,r),this._stencilFunction.face=e,this._stencilFunction.func=t,this._stencilFunction.ref=i,this._stencilFunction.mask=r,this._stateTracker.invalidateStencilTest())}setStencilWriteMask(e){this._stencilWriteMask!==e&&(this.gl.stencilMask(e),this._stencilWriteMask=e,this._stateTracker.invalidateStencilWrite())}setStencilOp(e,t,i){this._stencilOperation.fail===e&&this._stencilOperation.zFail===t&&this._stencilOperation.zPass===i||(this.gl.stencilOp(e,t,i),this._stencilOperation.face=1032,this._stencilOperation.fail=e,this._stencilOperation.zFail=t,this._stencilOperation.zPass=i,this._stateTracker.invalidateStencilTest())}setStencilOpSeparate(e,t,i,r){this._stencilOperation.face===e&&this._stencilOperation.fail===t&&this._stencilOperation.zFail===i&&this._stencilOperation.zPass===r||(this.gl.stencilOpSeparate(e,t,i,r),this._stencilOperation.face=e,this._stencilOperation.face=e,this._stencilOperation.fail=t,this._stencilOperation.zFail=i,this._stencilOperation.zPass=r,this._stateTracker.invalidateStencilTest())}setActiveTexture(e){const t=this._activeTextureUnit;return e>=0&&e!==this._activeTextureUnit&&(this.gl.activeTexture(s+e),this._activeTextureUnit=e),t}clear(e){e&&this.gl.clear(e)}clearSafe(e,t=255){e&&(16384&e&&this.setColorMask(!0,!0,!0,!0),256&e&&this.setDepthWriteEnabled(!0),1024&e&&this.setStencilWriteMask(t),this.gl.clear(e))}drawArrays(e,t,i){this.gl.drawArrays(e,t,i)}drawElements(e,t,i,r){5123!==i?5125===i&&this.gl.drawElements(e,t,i,r):this.gl.drawElements(e,t,i,r)}logIno(){}get capabilities(){return this._capabilities}setViewport(e,t,i,r){const a=this._viewport;a.x===e&&a.y===t&&a.width===i&&a.height===r||(a.x=e,a.y=t,a.width=i,a.height=r,this.gl.viewport(e,t,i,r))}getViewport(){return{x:this._viewport.x,y:this._viewport.y,width:this._viewport.width,height:this._viewport.height}}bindProgram(e){if(!e)return this.gl.useProgram(null),void(this._activeShaderProgram=null);this._activeShaderProgram!==e&&(e.initialize(),this.gl.useProgram(e.glName),this._activeShaderProgram=e)}bindTexture(e,t){(t>=this.parameters.maxTextureImageUnits||t<0)&&console.error("Input texture unit is out of range of available units!");const i=this._textureUnitMap[t];if(this.setActiveTexture(t),null==e||null==e.glName)return null!=i&&this.gl.bindTexture(i.descriptor.target,null),void(this._textureUnitMap[t]=null);i!==e?(this.gl.bindTexture(e.descriptor.target,e.glName),e.applyChanges(),this._textureUnitMap[t]=e):e.applyChanges()}unbindTextureAllUnits(e){for(let t=0;t<this.parameters.maxTextureImageUnits;t++)this._textureUnitMap[t]===e&&this.bindTexture(null,t)}bindFramebuffer(e){if(Object(r["j"])(e))return this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),void(this._activeFramebuffer=null);this._activeFramebuffer!==e&&(e.initializeAndBind(),this._activeFramebuffer=e)}bindBuffer(e){e&&(34962===e.bufferType?this._activeVertexBuffer=x(this.gl,e,e.bufferType,this._activeVertexBuffer):this._activeIndexBuffer=x(this.gl,e,e.bufferType,this._activeIndexBuffer))}bindRenderbuffer(e){const t=this.gl;e||(t.bindRenderbuffer(t.RENDERBUFFER,null),this._activeRenderbuffer=null),this._activeRenderbuffer!==e&&(t.bindRenderbuffer(t.RENDERBUFFER,e.glName),this._activeRenderbuffer=e)}unbindBuffer(e){34962===e?this._activeVertexBuffer=x(this.gl,null,e,this._activeVertexBuffer):this._activeIndexBuffer=x(this.gl,null,e,this._activeIndexBuffer)}bindVAO(e){e?this._activeVertexArrayObject&&this._activeVertexArrayObject===e||(e.bind(),this._activeVertexArrayObject=e):this._activeVertexArrayObject&&(this._activeVertexArrayObject.unbind(),this._activeVertexArrayObject=null)}getBoundTexture(e){return this._textureUnitMap[e]}getBoundFramebufferObject(){return this._activeFramebuffer}getBoundVAO(){return this._activeVertexArrayObject}resetState(){this.bindProgram(null),this.bindVAO(null),this.bindFramebuffer(null),this.unbindBuffer(34962),this.unbindBuffer(34963);for(let e=0;e<this.parameters.maxTextureImageUnits;e++)this.bindTexture(null,e);this.setBlendingEnabled(!1),this.setBlendFunction(1,0),this.setBlendEquation(32774),this.setBlendColor(0,0,0,0),this.setFaceCullingEnabled(!1),this.setCullFace(1029),this.setFrontFace(2305),this.setPolygonOffsetFillEnabled(!1),this.setPolygonOffset(0,0),this.setScissorTestEnabled(!1),this.setScissorRect(0,0,this.gl.canvas.width,this.gl.canvas.height),this.setDepthTestEnabled(!1),this.setDepthFunction(513),this.setDepthRange(0,1),this.setStencilTestEnabled(!1),this.setStencilFunction(519,0,0),this.setStencilOp(7680,7680,7680),this.setClearColor(0,0,0,0),this.setClearDepth(1),this.setClearStencil(0),this.setColorMask(!0,!0,!0,!0),this.setStencilWriteMask(4294967295),this.setDepthWriteEnabled(!0),this.setViewport(0,0,this.gl.canvas.width,this.gl.canvas.height)}enforceState(){const e=this.gl,t=this.capabilities.vao;t&&t.bindVertexArray(null);for(let i=0;i<this.parameters.maxVertexAttributes;i++)e.disableVertexAttribArray(i);if(this._activeVertexBuffer?e.bindBuffer(this._activeVertexBuffer.bufferType,this._activeVertexBuffer.glName):e.bindBuffer(34962,null),this._activeIndexBuffer?e.bindBuffer(this._activeIndexBuffer.bufferType,this._activeIndexBuffer.glName):e.bindBuffer(34963,null),t&&this._activeVertexArrayObject){const e=this._activeVertexArrayObject;this._activeVertexArrayObject&&(this._activeVertexArrayObject.unbind(),this._activeVertexArrayObject=null),this.bindVAO(e)}e.bindFramebuffer(e.FRAMEBUFFER,this._activeFramebuffer?this._activeFramebuffer.glName:null),e.useProgram(this._activeShaderProgram?this._activeShaderProgram.glName:null),e.blendColor(this._blendColorState.r,this._blendColorState.g,this._blendColorState.b,this._blendColorState.a),e.bindRenderbuffer(e.RENDERBUFFER,this._activeRenderbuffer?this._activeRenderbuffer.glName:null),!0===this._blendEnabled?e.enable(this.gl.BLEND):e.disable(this.gl.BLEND),e.blendEquationSeparate(this._blendEquationState.mode,this._blendEquationState.modeAlpha),e.blendFuncSeparate(this._blendFunctionState.srcRGB,this._blendFunctionState.dstRGB,this._blendFunctionState.srcAlpha,this._blendFunctionState.dstAlpha),e.clearColor(this._clearColor.r,this._clearColor.g,this._clearColor.b,this._clearColor.a),e.clearDepth(this._clearDepth),e.clearStencil(this._clearStencil),e.colorMask(this._colorMaskState.r,this._colorMaskState.g,this._colorMaskState.b,this._colorMaskState.a),e.cullFace(this._cullFace),e.depthFunc(this._depthFunction),e.depthRange(this._depthRange.zNear,this._depthRange.zFar),!0===this._depthTestEnabled?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),e.depthMask(this._depthWriteEnabled),e.frontFace(this._frontFace),e.lineWidth(1),!0===this._polygonCullingEnabled?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),e.polygonOffset(this._polygonOffset[0],this._polygonOffset[1]),!0===this._polygonOffsetFillEnabled?e.enable(e.POLYGON_OFFSET_FILL):e.disable(e.POLYGON_OFFSET_FILL),e.scissor(this._scissorRect.x,this._scissorRect.y,this._scissorRect.width,this._scissorRect.height),!0===this._scissorTestEnabled?e.enable(e.SCISSOR_TEST):e.disable(e.SCISSOR_TEST),e.stencilFunc(this._stencilFunction.func,this._stencilFunction.ref,this._stencilFunction.mask),e.stencilOpSeparate(this._stencilOperation.face,this._stencilOperation.fail,this._stencilOperation.zFail,this._stencilOperation.zPass),!0===this._stencilTestEnabled?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),e.stencilMask(this._stencilWriteMask);for(let i=0;i<this.parameters.maxTextureImageUnits;i++){e.activeTexture(s+i),e.bindTexture(3553,null);const t=this._textureUnitMap[i];t&&e.bindTexture(t.descriptor.target,t.glName)}e.activeTexture(s+this._activeTextureUnit),e.viewport(this._viewport.x,this._viewport.y,this._viewport.width,this._viewport.height)}}function x(e,t,i,r){return t?r!==t&&e.bindBuffer(i,t.glName):e.bindBuffer(i,null),t}t["a"]=_},"6fcc":function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));var r=i("3886"),a=i("bc40");function n(e){const t=r["a"]`
    bool isNaN( float val )
    {
      return ( val < 0.0 || 0.0 < val || val == 0.0 ) ? false : true;
      // important: some nVidias failed to cope with version below.
      // Probably wrong optimization.
      /*return ( val <= 0.0 || 0.0 <= val ) ? false : true;*/
    }
  `;e.code.add(t)}function s(e,t){e.vertex.include(n),e.include(a["a"],t);const i=e.vertex;i.uniforms.add("uDepthBias","vec2"),i.uniforms.add("uViewportDimInv","vec2"),t.legacy?(i.uniforms.add("uView","mat4"),i.uniforms.add("uProj","mat4")):i.uniforms.add("uTransformNormal_ViewFromGlobal","mat3"),t.legacy?i.code.add(r["a"]`
      vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {
        float offsetXY = uDepthBias.x;
        float offsetZ  = uDepthBias.y;

        // screen space pixel offset
        // we multiply by two to account for the fact that NDC go from -1 to 1
        // we multiply by projPos.w to compensate for the perspective division that happens later
        // normalizing over xyz means that the xy influence is reduced the more the normal is pointing
        // towards the camera
        vec4 projNormal = uProj * uView * vec4(globalNormal, 0.0);

        return offsetXY * projPos.w * 2.0 * uViewportDimInv * normalize(projNormal.xyz).xy;
      }
    `):i.code.add(r["a"]`
      vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {
        float offsetXY = uDepthBias.x;
        float offsetZ  = uDepthBias.y;

        // screen space pixel offset
        // we multiply by two to account for the fact that NDC go from -1 to 1
        // we multiply by projPos.w to compensate for the perspective division that happens later
        // normalizing over xyz means that the xy influence is reduced the more the normal is pointing
        // towards the camera
        vec4 projNormal = uTransform_ProjFromView * vec4(uTransformNormal_ViewFromGlobal * globalNormal, 0.0);

        return offsetXY * projPos.w * 2.0 * uViewportDimInv * normalize(projNormal.xyz).xy;
      }
    `),i.code.add(r["a"]`
    // A z-offset, using a depth based heuristic.
    float _calculateProjectedBiasZ(vec4 projPos) {
      float offsetZ = uDepthBias.y;
      return sqrt(projPos.z) * offsetZ;
    }

    vec4 adjustProjectedPosition(vec4 projPos, vec3 worldNormal, float lineWidth) {
      vec2 offsetXY = calculateProjectedBiasXY(projPos, worldNormal);

      // we currently have to do this check because some geometries come with 0 length edge normals.
      // see https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/12890
      if (!isNaN(offsetXY.x) && !isNaN(offsetXY.y)) {
        projPos.xy += offsetXY;
      }

      projPos.z += _calculateProjectedBiasZ(projPos);

      return projPos;
    }
  `)}},7079:function(e,t,i){"use strict";i.d(t,"a",(function(){return r})),i.d(t,"b",(function(){return s}));var r,a=i("3886"),n=i("9617");function s(e,t){t.multipassGeometryEnabled&&e.vertex.include(n["b"]),e.vertex.code.add(a["a"]`
  void main(void) {
    vec4 posProjCenter;
    if (dot(position, position) > 0.0) {
      // Render single point to center of the pixel to avoid subpixel
      // filtering to affect the marker color
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);
      posProjCenter = alignToPixelCenter(posProj, viewport.zw);

      ${t.multipassGeometryEnabled?a["a"]`
        // Don't draw vertices behind geometry
        if(geometryDepthTest(.5 + .5 * posProjCenter.xy / posProjCenter.w, projectAux.posView.z)){
          posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
        }`:""}

      vec3 vpos = projectAux.posModel;
      if (rejectBySlice(vpos)) {
        // Project out of clip space
        posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
      }

    }
    else {
      // Project out of clip space
      posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
    }

    gl_Position = posProjCenter;
    gl_PointSize = 1.0;
  }
  `),e.fragment.uniforms.add("color","vec4"),e.fragment.code.add(a["a"]`
  void main() {
    gl_FragColor = color;
  }
  `)}!function(e){function t(e){e.setUniform4f("color",1,1,1,1)}e.bindUniforms=t}(r||(r={}))},7088:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i("3886");function a(e,t){const i=e.fragment;t.receiveAmbientOcclusion?(i.uniforms.add("ssaoTex","sampler2D"),i.uniforms.add("viewportPixelSz","vec4"),i.code.add(r["a"]`
      float evaluateAmbientOcclusion() {
        return 1.0 - texture2D(ssaoTex, (gl_FragCoord.xy - viewportPixelSz.xy) * viewportPixelSz.zw).a;
      }

      float evaluateAmbientOcclusionInverse() {
        float ssao = texture2D(ssaoTex, (gl_FragCoord.xy - viewportPixelSz.xy) * viewportPixelSz.zw).a;
        return viewportPixelSz.z < 0.0 ? 1.0 : ssao;
      }
    `)):i.code.add(r["a"]`
      float evaluateAmbientOcclusion() { return 0.0; } // no occlusion
      float evaluateAmbientOcclusionInverse() { return 1.0; }
    `)}},"70ce":function(e,t,i){"use strict";i.d(t,"a",(function(){return d}));var r=i("a4ee"),a=(i("c120"),i("e92d"),i("cea0"),i("59b2")),n=i("d386"),s=(i("e041"),i("8eed"),i("f402"),i("fc29")),o=i("22f4"),c=i("9096"),l=i("2258");const h={visible:"visibleSublayers",definitionExpression:"layerDefs",labelingInfo:"hasDynamicLayers",labelsVisible:"hasDynamicLayers",opacity:"hasDynamicLayers",minScale:"visibleSublayers",maxScale:"visibleSublayers",renderer:"hasDynamicLayers",source:"hasDynamicLayers"};let d=class extends(Object(c["b"])(s["a"])){constructor(e){super(e),this.scale=0}destroy(){this.layer=null}get dynamicLayers(){if(!this.hasDynamicLayers)return null;const e=this.visibleSublayers.map(e=>e.toExportImageJSON());return e.length?JSON.stringify(e):null}get hasDynamicLayers(){return this.layer&&Object(l["a"])(this.visibleSublayers,this.layer.serviceSublayers,this.layer)}set layer(e){this._get("layer")!==e&&(this._set("layer",e),this.handles.remove("layer"),e&&this.handles.add([e.allSublayers.on("change",()=>this.notifyChange("visibleSublayers")),e.on("sublayer-update",e=>this.notifyChange(h[e.propertyName]))],"layer"))}get layers(){const e=this.visibleSublayers;return e?e.length?"show:"+e.map(e=>e.id).join(","):"show:-1":null}get layerDefs(){const e=this.visibleSublayers.filter(e=>null!=e.definitionExpression);return e.length?JSON.stringify(e.reduce((e,t)=>(e[t.id]=t.definitionExpression,e),{})):null}get version(){this.commitProperty("layers"),this.commitProperty("layerDefs"),this.commitProperty("dynamicLayers"),this.commitProperty("timeExtent");const e=this.layer;return e&&(e.commitProperty("dpi"),e.commitProperty("imageFormat"),e.commitProperty("imageTransparency"),e.commitProperty("gdbVersion")),(this._get("version")||0)+1}get visibleSublayers(){const e=[];if(!this.layer)return e;const t=this.layer.sublayers,i=t=>{const r=this.scale,a=0===r,n=0===t.minScale||r<=t.minScale,s=0===t.maxScale||r>=t.maxScale;t.visible&&(a||n&&s)&&(t.sublayers?t.sublayers.forEach(i):e.unshift(t))};t&&t.forEach(i);const r=this._get("visibleSublayers");return!r||r.length!==e.length||r.some((t,i)=>e[i]!==t)?e:r}toJSON(){const e=this.layer;let t={dpi:e.dpi,format:e.imageFormat,transparent:e.imageTransparency,gdbVersion:e.gdbVersion||null};return this.hasDynamicLayers&&this.dynamicLayers?t.dynamicLayers=this.dynamicLayers:t={...t,layers:this.layers,layerDefs:this.layerDefs},t}};Object(r["a"])([Object(a["b"])({readOnly:!0})],d.prototype,"dynamicLayers",null),Object(r["a"])([Object(a["b"])({readOnly:!0})],d.prototype,"hasDynamicLayers",null),Object(r["a"])([Object(a["b"])()],d.prototype,"layer",null),Object(r["a"])([Object(a["b"])({readOnly:!0})],d.prototype,"layers",null),Object(r["a"])([Object(a["b"])({readOnly:!0})],d.prototype,"layerDefs",null),Object(r["a"])([Object(a["b"])({type:Number})],d.prototype,"scale",void 0),Object(r["a"])([Object(a["b"])(o["a"])],d.prototype,"timeExtent",void 0),Object(r["a"])([Object(a["b"])({readOnly:!0})],d.prototype,"version",null),Object(r["a"])([Object(a["b"])({readOnly:!0})],d.prototype,"visibleSublayers",null),d=Object(r["a"])([Object(n["a"])("esri.layers.mixins.ExportImageParameters")],d)},"713b":function(e,t,i){"use strict";i.d(t,"a",(function(){return u})),i.d(t,"b",(function(){return d}));var r=i("3886"),a=i("4db9"),n=i("690a"),s=i("d272"),o=i("6a07"),c=i("ebd5"),l=i("6750"),h=i("6d5b");function d(e){const t=new n["a"];return t.include(a["a"],{linearDepth:!1}),t.include(h["a"],e),t.include(l["a"],e),t.vertex.uniforms.add("proj","mat4").add("view","mat4"),t.attributes.add("position","vec3"),t.varyings.add("vpos","vec3"),t.vertex.code.add(r["a"]`
    void main(void) {
      vpos = position;
      forwardNormalizedVertexColor();
      gl_Position = transformPosition(proj, view, vpos);
  `),e.stippleEnabled&&(t.attributes.add("auxpos1","vec3"),t.vertex.uniforms.add("ndcToPixel","vec2"),t.vertex.code.add(r["a"]`
    vec4 vpos2 = transformPosition(proj, view, auxpos1);
    float lineSegmentPixelSize = length((vpos2.xy / vpos2.w - gl_Position.xy / gl_Position.w) * ndcToPixel);

    stipplePatternUv = lineSegmentPixelSize * stipplePatternPixelSizeInv;
    ${e.stippleIntegerRepeatsEnabled?"stipplePatternUv = floor(stipplePatternUv + 0.5);":""}

    // Cancel out perspective correct interpolation because we want this length the really represent
    // the screen distance
    stipplePatternUv *= gl_Position.w;
    `)),t.vertex.code.add(r["a"]`
  }
  `),4===e.output&&t.include(o["a"]),t.include(s["a"],e),t.fragment.uniforms.add("constantColor","vec4").add("alphaCoverage","float"),t.fragment.code.add(r["a"]`
  void main() {
    discardBySlice(vpos);

    vec4 color = ${e.attributeColor?"vColor":"constantColor"};

    float stippleAlpha = getStippleAlpha();
    discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);

    vec4 finalColor = blendStipple(vec4(color.rgb, color.a * alphaCoverage), stippleAlpha);

    if (finalColor.a < ${r["a"].float(c["c"])}) {
      discard;
    }

    ${0===e.output?r["a"]`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${4===e.output?r["a"]`outputHighlight();`:""}
  }
  `),t}var u=Object.freeze({__proto__:null,build:d})},7304:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i("3886"),a=i("5876");function n(e,t){1===t.componentData&&(e.vertex.uniforms.add("uComponentColorTex","sampler2D"),e.vertex.uniforms.add("uComponentColorTexInvDim","vec2"),e.attributes.add("componentIndex","float"),e.varyings.add("vExternalColorMixMode","mediump float"),e.varyings.add("vExternalColor","vec4"),e.include(a["a"]),e.vertex.code.add(r["a"]`
      vec4 _readComponentColor() {
        float normalizedIndex = (componentIndex + 0.5) * uComponentColorTexInvDim.x;
        vec2 indexCoord = vec2(
          mod(normalizedIndex, 1.0),
          (floor(normalizedIndex) + 0.5) * uComponentColorTexInvDim.y
        );
        return texture2D(uComponentColorTex, indexCoord);
       }

      vec4 forwardExternalColor(out bool castShadows) {
        vec4 componentColor = _readComponentColor() * 255.0;

        float shadowFlag = mod(componentColor.b * 255.0, 2.0);
        componentColor.b -= shadowFlag;
        castShadows = shadowFlag >= 1.0;

        int decodedColorMixMode;
        vExternalColor = decodeSymbolColor(componentColor, decodedColorMixMode) * 0.003921568627451; // = 1/255;
        vExternalColorMixMode = float(decodedColorMixMode) + 0.5; // add 0.5 to avoid interpolation artifacts

        return vExternalColor;
      }
    `),e.fragment.code.add(r["a"]`
      void readExternalColor(out vec4 externalColor, out int externalColorMixMode) {
        externalColor = vExternalColor;
        externalColorMixMode = int(vExternalColorMixMode);
      }
    `)),0===t.componentData&&(e.vertex.uniforms.add("uExternalColor","vec4"),e.fragment.uniforms.add("uExternalColorMixMode","int"),e.varyings.add("vExternalColor","vec4"),e.vertex.code.add(r["a"]`
      vec4 forwardExternalColor(out bool castShadows) {
        vExternalColor = uExternalColor;
        castShadows = true;
        return uExternalColor;
      }
    `),e.fragment.code.add(r["a"]`
      void readExternalColor(out vec4 externalColor, out int externalColorMixMode) {
        externalColor = vExternalColor;
        externalColorMixMode = uExternalColorMixMode;
      }
    `))}},"73d4":function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));var r=i("3886"),a=i("5211"),n=i("7cb4");function s(e,t){const i=e.fragment;t.baseColorTexture?(e.include(n["a"],t),i.uniforms.add("uBaseColorTexture","sampler2D"),i.uniforms.add("uBaseColorTextureSize","vec2"),2===t.attributeTextureCoordinates?(e.include(a["a"]),i.code.add(r["a"]`
        vec4 readBaseColorTexture() {
          return textureAtlasLookup(
            uBaseColorTexture,
            uBaseColorTextureSize,
            vuv0,
            vuvRegion
          );
        }
      `)):i.code.add(r["a"]`
        vec4 readBaseColorTexture() {
          return texture2D(uBaseColorTexture, vuv0);
        }
      `)):i.code.add(r["a"]`
      vec4 readBaseColorTexture() { return vec4(1.0); }
    `)}},"748f":function(e,t,i){"use strict";i.d(t,"a",(function(){return d})),i.d(t,"b",(function(){return u}));var r=i("b2b2"),a=i("8a44"),n=i("ce6d"),s=i("0b2d"),o=i("af40"),c=i("003f");const l=["layerObjectAdded","layerObjectRemoved","layerObjectsAdded","layerObjectsRemoved","shaderTransformationChanged","objectTransformation","visibilityChanged","occlusionChanged","highlightChanged","objectGeometryAdded","objectGeometryRemoved","vertexAttrsUpdated"];var h=i("0bde");class d extends c["a"]{constructor(e,t=""){super(),this.apiLayerUid=t,this.type=0,this.events=new n["a"],this.isSliceable=!1,this._objects=new a["a"],this._stageHandles=new o["a"],this.apiLayerUid=t,e=e||{},this.group=e.group||"",this.isVisible=null==e.isVisible||e.isVisible,this.isPickable=null==e.isPickable||e.isPickable,this.translation=e.translation?Object(s["d"])(e.translation):Object(s["e"])()}destroy(){this.detachStage(),this._stage=null}attachStage(e){this.detachStage(),this._stage=e;for(const t of l)this._stageHandles.add(this.events.on(t,i=>e.handleEvent(t,i)))}detachStage(){this._stageHandles.removeAll(),this.invalidateSpatialQueryAccelerator()}getObjectIds(){return this._objects.map(e=>e.id)}getObjects(){return this._objects}add(e){this._objects.push(e),e.parentLayer=this,this.events.emit("layerObjectAdded",{layer:this,object:e}),Object(r["k"])(this._octree)&&this._octree.add([e])}remove(e){this._objects.removeUnordered(e)&&(e.parentLayer=null,this.events.emit("layerObjectRemoved",{layer:this,object:e}),Object(r["k"])(this._octree)&&this._octree.remove([e]))}addMany(e){this._objects.pushArray(e);for(const t of e)t.parentLayer=this;this.events.emit("layerObjectsAdded",{layer:this,objects:e}),Object(r["k"])(this._octree)&&this._octree.add(e)}removeMany(e){const t=new Array;if(this._objects.removeUnorderedMany(e,e.length,t),0!==t.length){for(const e of t)e.parentLayer=null;this.events.emit("layerObjectsRemoved",{layer:this,objects:t}),Object(r["k"])(this._octree)&&this._octree.remove(t)}}commit(){Object(r["k"])(this._stage)&&this._stage.processDirtyLayer(this.id)}notifyObjectBBChanged(e,t){Object(r["k"])(this._octree)&&this._octree.update(e,t)}getSpatialQueryAccelerator(){return Object(r["j"])(this._octree)&&this._objects.length>50&&this._createOctree(),this._octree}shaderTransformationChanged(){this.invalidateSpatialQueryAccelerator(),this.events.emit("shaderTransformationChanged",this)}invalidateSpatialQueryAccelerator(){this._octree=Object(r["e"])(this._octree)}_createOctree(){this._octree=new h["a"](e=>e.getBounds()),this._octree.add(this._objects.data,this._objects.length)}}function u(e){return Object(r["k"])(e)&&0===e.type}},"74df":function(e,t,i){"use strict";i.d(t,"a",(function(){return b})),i.d(t,"b",(function(){return f})),i.d(t,"c",(function(){return p}));var r=i("b2b2"),a=i("0b2d"),n=i("e431"),s=i("d791"),o=i("8188"),c=i("afe1"),l=i("0cb9"),h=i("6611"),d=i("ba58"),u=i("2e0f");function p(e,t,i,r){const a=e.stageObject,n=i.spatialReference,s=a.geometryRecords,c=s.length,d="absolute-height"!==t.mode;let p=0;for(let f=0;f<c;f++){const e=s[f].geometry,c=s[f].getShaderTransformation();y[0]=c[12],y[1]=c[13],y[2]=c[14],e.invalidateBoundingInfo();const m=e.getMutableAttribute("position"),b=m.data,_=e.vertexAttributes.get("mapPos").data,x=m.size,w=b.length/x,S=new l["a"](_,n);let C=0,T=!1,P=0;for(let a=0;a<w;a++){O[0]=b[C],O[1]=b[C+1],O[2]=b[C+2];const e=Object(u["e"])(S,i,t,r,d?j:null);if(d&&(P+=j.sampledElevation),h["a"].DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES?(b[C]=S.array[S.offset],b[C+1]=S.array[S.offset+1],b[C+2]=e,Object(o["q"])(b,n,C,b,r.spatialReference,C,1),b[C]-=y[0],b[C+1]-=y[1],b[C+2]-=y[2]):(v[0]=b[C]+y[0],v[1]=b[C+1]+y[1],v[2]=b[C+2]+y[2],r.setAltitude(e,v),b[C]=v[0]-y[0],b[C+1]=v[1]-y[1],b[C+2]=v[2]-y[2]),h["a"].TESTS_DISABLE_UPDATE_THRESHOLDS)T=!0;else{const e=g/r.unitInMeters;(Math.abs(O[0]-b[C])>=e||Math.abs(O[1]-b[C+1])>=e||Math.abs(O[2]-b[C+2])>=e)&&(T=!0)}C+=x,S.offset+=3}p+=P/w,T&&a.geometryVertexAttrsUpdated(f)}return p/c}function f(e,t,i,r){const a=e.stageObject,c=t.centerPointInElevationSR;let l=0,p=0;if(a.metadata.usesVerticalDistanceToGround)l=Object(u["e"])(c,i,t,r,j),Object(d["j"])(a,j.verticalDistanceToGround),p=j.sampledElevation;else{const e="absolute-height"!==t.mode;l=Object(u["e"])(c,i,t,r,e?j:null),e&&(p=j.sampledElevation)}const f=Object(s["c"])(m,a.transformation),b=Object(n["x"])(x,f[12],f[13],f[14]);h["a"].DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES?(v[0]=c.x,v[1]=c.y,v[2]=l,Object(o["d"])(c.spatialReference,v,f,r.spatialReference)&&(a.transformation=f)):r.setAltitudeOfTransformation(l,f);const y=g/r.unitInMeters;return(Math.abs(f[12]-b[0])>=y||Math.abs(f[13]-b[1])>=y||Math.abs(f[14]-b[2])>=y)&&(a.transformation=f),p}const m=Object(c["b"])();function b(e,t,i,a){const s=e.graphics3DSymbolLayer.lodRenderer;if(Object(r["j"])(s))return 0;const c=t.centerPointInElevationSR;let l=0,d=0;const p="absolute-height"!==t.mode;l=Object(u["e"])(c,i,t,a,p?j:null),p&&(d=j.sampledElevation);const f=s.instanceData,m=e.instanceIndex,b=_;f.getGlobalTransform(m,b);const y=Object(n["x"])(x,b[12],b[13],b[14]);h["a"].DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES?(v[0]=c.x,v[1]=c.y,v[2]=l,Object(o["d"])(c.spatialReference,v,b,a.spatialReference)&&f.setGlobalTransform(m,b)):a.setAltitudeOfTransformation(l,b);const O=g/a.unitInMeters;return(h["a"].TESTS_DISABLE_UPDATE_THRESHOLDS||Math.abs(b[12]-y[0])>=O||Math.abs(b[13]-y[1])>=O||Math.abs(b[14]-y[2])>=O)&&f.setGlobalTransform(m,b),d}const g=.01,v=Object(a["e"])(),y=Object(a["e"])(),O=Object(a["e"])(),_=Object(c["b"])(),x=Object(a["e"])(),j={verticalDistanceToGround:0,sampledElevation:0}},7585:function(e,t,i){"use strict";i.d(t,"a",(function(){return K})),i.d(t,"b",(function(){return W})),i.d(t,"c",(function(){return J}));var r=i("a4ee"),a=(i("c120"),i("b2b2")),n=i("e92d"),s=(i("cea0"),i("59b2")),o=i("d386"),c=(i("e041"),i("8eed"),i("f402"),i("8a44")),l=i("fc29"),h=i("f2e0"),d=i("0b2d"),u=i("af40"),p=i("3795"),f=i("d791"),m=i("9305"),b=i("28eb"),g=i("02f1"),v=i("a1ff"),y=i("8539"),O=i("d5f7"),_=i("2bc9"),x=i("a978"),j=i("171c"),w=i("6611"),S=i("70a2"),C=(i("38a4"),i("9f8b"),i("1956"),i("d267"));class T{constructor(e,t){this.id=Object(h["b"])(),this._renderTarget=null,this._renderTarget=new C["a"](e,{colorTarget:0,depthStencilTarget:0},{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9987,hasMipmap:t,maxAnisotropy:8,width:0,height:0})}dispose(){this._renderTarget=Object(a["f"])(this._renderTarget)}getTexture(){return this._renderTarget?this._renderTarget.colorTexture:null}isValid(){return null!==this._renderTarget}resize(e,t){this._renderTarget.resize(e,t)}bind(e){e.bindFramebuffer(this._renderTarget)}generateMipMap(){this._renderTarget.colorTexture.descriptor.hasMipmap&&this._renderTarget.colorTexture.generateMipmap()}disposeRenderTargetMemory(){this._renderTarget&&this._renderTarget.resize(0,0)}getGpuMemoryUsage(){let e=0;return this._renderTarget&&(e+=Object(y["c"])(this._renderTarget)),e}}var P=i("9180"),A=i("7abc");class R{constructor(e){this.extent=Object(P["l"])(),this.resolution=0,this.renderLocalOrigin=Object(A["a"])(0,0,0,"O"),this.pixelRatio=1,this.renderTargets={color:{fbo:new T(e,!0),valid:!1,lastUsed:1/0},colorWithoutRasterImage:{fbo:new T(e,!0),valid:!1,lastUsed:1/0},highlight:{fbo:new T(e,!1),valid:!1,lastUsed:1/0},water:{fbo:new T(e,!0),valid:!1,lastUsed:1/0},occluded:{fbo:new T(e,!0),valid:!1,lastUsed:1/0}}}dispose(){this.renderTargets.color.fbo.dispose(),this.renderTargets.colorWithoutRasterImage.fbo.dispose(),this.renderTargets.highlight.fbo.dispose(),this.renderTargets.water.fbo.dispose(),this.renderTargets.occluded.fbo.dispose()}drawRenderTargets(e,t,i){const r=this.renderTargets;r.color.valid=e.drawPass(0,r.color.fbo,t),r.highlight.valid=e.drawPass(5,r.highlight.fbo,t),r.water.valid=e.drawPass(3,r.water.fbo,t),r.occluded.valid=e.drawPass(0,r.occluded.fbo,t,1),r.colorWithoutRasterImage.valid=i&&e.drawPass(0,r.colorWithoutRasterImage.fbo,t,2)}computeRenderTargetValidityBitfield(){const e=this.renderTargets;return+e.color.valid|+e.colorWithoutRasterImage.valid<<1|+e.highlight.valid<<2|+e.water.valid<<3|+e.occluded.valid<<4}validateUsage(e,t){if(e.valid)e.lastUsed=t;else if(t-e.lastUsed>M)e.fbo.disposeRenderTargetMemory(),e.lastUsed=1/0;else if(e.lastUsed<1/0)return!0;return!1}collectUnusedMemory(e){let t=!1;return t=this.validateUsage(this.renderTargets.color,e)||t,t=this.validateUsage(this.renderTargets.colorWithoutRasterImage,e)||t,t=this.validateUsage(this.renderTargets.highlight,e)||t,t=this.validateUsage(this.renderTargets.occluded,e)||t,t=this.validateUsage(this.renderTargets.water,e)||t,t}getGpuMemoryUsage(){return this.renderTargets.color.fbo.getGpuMemoryUsage()+this.renderTargets.colorWithoutRasterImage.fbo.getGpuMemoryUsage()+this.renderTargets.highlight.fbo.getGpuMemoryUsage()+this.renderTargets.water.fbo.getGpuMemoryUsage()+this.renderTargets.occluded.fbo.getGpuMemoryUsage()}}const M=1e3;var E=i("eaa4"),D=i("0e88"),I=i("caca"),L=i("adf1"),V=i("d6e5"),k=i("35b3"),F=i("fdc9"),z=i("9def"),U=i("191a");let G=class extends l["a"]{constructor(){super(...arguments),this._pendingAddsRemoves=new Map,this._changes=new F["a"],this._materialRenderers=new Map,this._sortedMaterialRenderers=new c["a"],this._hasHighlights=!1,this._hasWater=!1}dispose(){this._changes.prune(),this._materialRenderers&&(this._materialRenderers.forEach(e=>e.dispose()),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear())}get updating(){return this._pendingAddsRemoves.size>0||this._changes.updates.length>0}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return Object(b["b"])(this._materialRenderers,e=>e.rendersOccluded)}stopAnimationsAtTime(e){this._sortedMaterialRenderers.forAll(t=>Object(a["c"])(t.material.animation,t=>t.stopAtTime(e)))}get isEmpty(){return!this.updating&&0===this._materialRenderers.size}commitChanges(){let e=!1;if(!this.updating)return!1;this.updateAddsRemoves();const t=Object(z["a"])(this._changes);let i=!1,r=!1;return t.forEach((t,a)=>{let n=this._materialRenderers.get(a);if(!n&&t.adds.length>0&&(n=new U["a"](this.rctx,this.materialRepository,a),this._materialRenderers.set(a,n),e=!0,i=!0,r=!0),!n)return;const s=i||n.hasHighlights,o=r||n.hasWater;n.modify(t),i=i||s!==n.hasHighlights,r=r||o!==n.hasWater,n.isEmpty&&(this._materialRenderers.delete(a),n.dispose(),e=!0)}),this._changes.clear(),this._pendingAddsRemoves.clear(),e&&this.updateSortedMaterialRenderers(),i&&(this._hasHighlights=Object(b["b"])(this._materialRenderers,e=>e.hasHighlights)),r&&(this._hasWater=Object(b["b"])(this._materialRenderers,e=>e.hasWater)),this.notifyChange("updating"),!0}add(e){if(0===e.length)return;const t=0===this._pendingAddsRemoves.size;for(const i of e)this._pendingAddsRemoves.set(i,0);t&&this.notifyChange("updating")}remove(e){const t=0===this._pendingAddsRemoves.size;for(const i of e){const e=this._pendingAddsRemoves.get(i);0===e?this._pendingAddsRemoves.set(i,2):2!==e&&this._pendingAddsRemoves.set(i,1)}t&&this._pendingAddsRemoves.size>0&&this.notifyChange("updating")}modify(e,t){const i=0===this._changes.updates.length;for(const r of e){const e=this._changes.updates.pushNew();e.renderGeometry=r,e.updateType=t}i&&this._changes.updates.length>0&&this.notifyChange("updating")}updateLogic(e){let t=!1;return this._sortedMaterialRenderers.forAll(({materialRenderer:i})=>{i.updateLogic&&i.updateLogic(e)&&(t=!0)}),t}draw(e,t){for(let i=0;i<this._sortedMaterialRenderers.length;i++){const r=this._sortedMaterialRenderers.data[i];Object(k["c"])(r.material,e)&&r.materialRenderer.render(null,e,t,null)}}updateSortedMaterialRenderers(){this._sortedMaterialRenderers.clear();let e=0;this._materialRenderers.forEach((t,i)=>{i.insertOrder=e++,this._sortedMaterialRenderers.push({material:i,materialRenderer:t})}),this._sortedMaterialRenderers.sort((e,t)=>{const i=t.material.renderPriority-e.material.renderPriority;return 0!==i?i:e.material.insertOrder-t.material.insertOrder})}updateAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._pendingAddsRemoves.forEach((e,t)=>{switch(e){case 0:this._changes.adds.push(t);break;case 1:this._changes.removes.push(t)}});let e=0;for(;e<this._changes.updates.length;){const t=this._changes.updates.data[e].renderGeometry;this._pendingAddsRemoves.has(t)?this._changes.updates.removeUnorderedIndex(e):e++}}get test(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}};Object(r["a"])([Object(s["b"])()],G.prototype,"rctx",void 0),Object(r["a"])([Object(s["b"])()],G.prototype,"materialRepository",void 0),Object(r["a"])([Object(s["b"])()],G.prototype,"updating",null),G=Object(r["a"])([Object(o["a"])("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],G);var B=i("7aed"),H=i("2245"),N=i("3544");const q=n["a"].getLogger("esri.views.3d.webgl-engine.lib.OverlayRenderer");let W=class extends(Object(S["b"])(l["a"])){constructor(e){super(e),this._overlays=null,this._hasHighlights=!1,this._rendersOccluded=!1,this._hasWater=!1,this._lighting=new H["a"],this._localOrigins=new L["a"],this._handles=new u["a"],this._layerRenderers=new Map,this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers=new c["a"],this._geometries=new Map,this.globalUnitScale=1,this.longitudeCyclical=null}initialize(){this._rctx=this.renderView.renderingContext,this._renderContext=new V["a"](this._rctx,null,null,null,null,null),this._stippleTextureRepository=new N["a"],this.waterTextureRepository=this.renderView.waterTextureRepository,this._shaderTechniqueRepository=new D["a"]({rctx:this._rctx,viewingMode:2,commonUniformStore:new E["a"],stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:this.waterTextureRepository}),Object(p["a"])(this.waterTextureRepository,"loadingState",()=>this.emitContentChanged()),this._materialRepository=new I["a"](this.renderView.textureRepository,this._shaderTechniqueRepository),this._materialRepository.onMaterialChanged=e=>{(e.renderOccluded&J)>0!==this._rendersOccluded&&this.updateRendersOccluded(),this.emitContentChanged(),this.notifyChange("updating")},this._compositingHelper=this.renderView.compositingHelper,this._lighting.set({lights:[new _["a"](Object(d["g"])(1,1,1))],groundLightingFactor:1,globalFactor:0}),this._bindParameters={slot:null,highlightDepthTexture:Object(O["b"])(this._rctx),camera:Q,inverseViewport:Object(g["b"])(),origin:null,screenToWorldRatio:null,screenToWorldRatioGlobalWM:null,shadowMappingEnabled:!1,slicePlane:null,ssaoEnabled:!1,hasOccludees:!1,linearDepthTexture:null,linearDepthTextureUnit:0,lastFrameColorTexture:null,lastFrameColorTextureUnit:0,reprojectionMat:null,ssrEnabled:!1,lighting:this._lighting,transparencyPassType:3,terrainLinearDepthTexture:null,geometryLinearDepthTexture:null,multipassTerrainEnabled:!1,cullAboveGround:!0,multipassGeometryEnabled:!1},this._handles.add(this.scheduler.registerTask(m["b"].STAGE,()=>this.commitChanges(),()=>this.updating))}dispose(){this._handles.destroy(),this._layerRenderers.forEach(e=>e.dispose()),this._layerRenderers.clear(),this._bindParameters.highlightDepthTexture=Object(a["f"])(this._bindParameters.highlightDepthTexture),this._shaderTechniqueRepository=Object(a["f"])(this._shaderTechniqueRepository),this._temporaryRenderTarget=Object(a["f"])(this._temporaryRenderTarget),this._debugPatternTexture=Object(a["f"])(this._debugPatternTexture),this._quadVAO=Object(a["f"])(this._quadVAO)}get updating(){return this._sortedLayerRenderersDirty||Object(b["b"])(this._layerRenderers,e=>e.updating)||this.waterTextureRepository.updating}get hasOverlays(){return Object(a["k"])(this._overlays)}get gpuMemoryUsage(){return Object(a["k"])(this._overlays)?this._overlays[0].getGpuMemoryUsage()+this._overlays[1].getGpuMemoryUsage():0}get overlays(){return this._overlays}forEachOverlay(e){Object(a["k"])(this._overlays)&&(e(this._overlays[0],0),e(this._overlays[1],1))}ensureOverlays(){if(Object(a["j"])(this._overlays)){const e=this.renderView.renderingContext;this._overlays=[new R(e),new R(e)]}}disposeOverlays(){Object(a["k"])(this._overlays)&&(this._overlays.forEach(e=>e.dispose()),this._overlays=null)}commitChanges(){let e=!1;this._layerRenderers.forEach((t,i)=>{t.commitChanges()&&(e=!0),t.isEmpty&&(this._layerRenderers.delete(i),this._sortedLayerRenderersDirty=!0,this._handles.remove(i))}),this._sortedLayerRenderersDirty&&(this.updateSortedLayerRenderers(),e=!0),e&&(this.notifyChange("updating"),this.emitContentChanged(),this.updateHasHighlights(),this.updateRendersOccluded(),this.updateHasWater())}addGeometries(e,t,i){for(const r of e)null==r.origin&&(r.origin=this._localOrigins.getOrigin(r.boundingSphere)),Object(a["j"])(r.id)&&(r.id=Object(h["b"])()),this._geometries.set(r.id,r);this.ensureLayerRenderer(t).add(e),2===i&&this.notifyGraphicGeometryChanged(e,t)}removeGeometries(e,t,i){for(const n of e)this._geometries.delete(Object(a["t"])(n.id));const r=this._layerRenderers.get(t);r&&(r.remove(e),2===i&&this.notifyGraphicGeometryChanged(e,t))}updateGeometries(e,t,i){const r=this._layerRenderers.get(t);if(r)switch(r.modify(e,i),i){case 4:case 2:return this.notifyGraphicGeometryChanged(e,t);case 1:return this.notifyGraphicVisibilityChanged(e,t)}else q.warn("Attempted to update geometry for nonexistent layer")}notifyGraphicGeometryChanged(e,t){if(Object(a["j"])(t.notifyGraphicGeometryChanged))return;let i;for(const r of e){const e=r.graphicUid;e!==i&&(t.notifyGraphicGeometryChanged(e),i=e)}}notifyGraphicVisibilityChanged(e,t){if(Object(a["j"])(t.notifyGraphicVisibilityChanged))return;let i;for(const r of e){const e=r.graphicUid;e!==i&&(t.notifyGraphicVisibilityChanged(e),i=e)}}updateHighlights(e,t){const i=this._layerRenderers.get(t);i?i.modify(e,8):q.warn("Attempted to update highlights for nonexistent layer")}isEmpty(){return 0===this._geometries.size&&!w["a"].OVERLAY_DRAW_DEBUG_TEXTURE}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return this._rendersOccluded}updateLogic(e){let t=!1;return this._layerRenderers.forEach(i=>{i.updateLogic(e)&&(t=!0)}),t}updateLayerOrder(){this._sortedLayerRenderersDirty=!0}drawPass(e,t,i,r=0){if(0===i.numViews)return!1;if(this._screenToWorldRatio=i.pixelRatio*Math.abs(i.views[0].extent[2]-i.views[0].extent[0])/Math.abs(i.views[0].viewport[2]-i.views[0].viewport[0]),this.isEmpty()||5===e&&!this.hasHighlights||3===e&&!this.hasWater)return!1;if(!this.hasNonZeroSizedView(i))return!1;const n=i.width,s=i.height;if(!t.isValid())return!1;t.resize(n,s);const o=this._rctx;if(Q.pixelRatio=i.pixelRatio||1,this._renderContext.pass=e,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToWorldRatioGlobalWM=this._screenToWorldRatio*this.globalUnitScale,t.bind(o),o.setClearColor(0,0,0,0),o.clearSafe(16384),1===r&&(this._renderContext.renderOccludedMask=J),w["a"].OVERLAY_DRAW_DEBUG_TEXTURE&&1!==r)for(let a=0;a<i.numViews;a++)this.setViewParameters(i.views[a],Q),this.drawDebugTexture(n,s,$[i.index%$.length]);return this._layerRenderers.size>0&&this._sortedLayerRenderers.forAll(({layerView:c,renderer:l})=>{if(2===r&&Object(a["k"])(c)&&0===c.drapeSourceType)return;const h=Object(a["k"])(c)&&Object(a["k"])(c.fullOpacity)&&c.fullOpacity<1&&0===e;h&&(this.bindTemporaryFramebuffer(this._rctx,n,s),o.clearSafe(16384));for(let e=0;e<i.numViews;e++)this.setViewParameters(i.views[e],Q),l.draw(this._renderContext,this._bindParameters);h&&Object(a["k"])(this._temporaryRenderTarget)&&(t.bind(o),this._compositingHelper.composite(this._temporaryRenderTarget.getTexture(),2,Object(a["t"])(Object(a["t"])(c).fullOpacity)))}),o.bindFramebuffer(null),t.generateMipMap(),this._renderContext.resetRenderOccludedMask(),!0}bindTemporaryFramebuffer(e,t,i){Object(a["j"])(this._temporaryRenderTarget)&&(this._temporaryRenderTarget=new T(e,!1)),this._temporaryRenderTarget.resize(t,i),this._temporaryRenderTarget.bind(e)}async reloadShaders(){await this._shaderTechniqueRepository.hotReload()}intersect(e,t,i){let r=0;this._geometries.forEach(a=>{if(i&&!i(a))return;this.intersectRenderGeometry(a,t,0,e,r);const n=this.longitudeCyclical;n&&(a.boundingSphere[0]-a.boundingSphere[3]<n.min&&this.intersectRenderGeometry(a,t,n.range,e,r),a.boundingSphere[0]+a.boundingSphere[3]>n.max&&this.intersectRenderGeometry(a,t,-n.range,e,r)),r++})}intersectRenderGeometry(e,t,i,r,n){if(!e.instanceParameters.visible)return;let s=0;Object(a["k"])(e.transformation)&&(i+=e.transformation[12],s=e.transformation[13]),X[0]=t[0]-i,X[1]=t[1]-s,X[2]=1,Y[0]=t[0]-i,Y[1]=t[1]-s,Y[2]=0,e.screenToWorldRatio=this._screenToWorldRatio,e.material.intersect(e,null,e.getShaderTransformation(),r,X,Y,(t,i,a)=>{this.addIntersectionResult(a,e.material.renderPriority,n,r,e.layerUid,e.graphicUid)},e.calculateShaderTransformation,!0)}addIntersectionResult(e,t,i,r,a,n){const s={type:"external",metadata:{layerUid:a,graphicUid:n}},o=a=>{a.set(s,null,r.results.ground.dist,r.results.ground.normal,r.results.ground.transformation,t,null,null,e,i),a.intersector="OverlayRenderer"};if((null==r.results.min.drapedLayerOrder||t>=r.results.min.drapedLayerOrder)&&(null==r.results.min.dist||r.results.ground.dist<=r.results.min.dist)&&o(r.results.min),0!==r.options.store&&(null==r.results.max.drapedLayerOrder||t<r.results.max.drapedLayerOrder)&&(null==r.results.max.dist||r.results.ground.dist>r.results.max.dist)&&o(r.results.max),2===r.options.store){const e=new x["b"](r.ray);o(e),r.results.all.push(e)}}stopAnimationsAtTime(e){this._sortedLayerRenderers.forAll(t=>t.renderer.stopAnimationsAtTime(e))}ensureLayerRenderer(e){let t=this._layerRenderers.get(e);return t||(t=new G({rctx:this._rctx,materialRepository:this._materialRepository}),this._layerRenderers.set(e,t),this._sortedLayerRenderersDirty=!0,"fullOpacity"in e&&this._handles.add(e.watch("fullOpacity",()=>this.emitContentChanged()),e),this._handles.add(Object(p["a"])(t,"updating",()=>this.notifyChange("updating")),e)),t}updateSortedLayerRenderers(){if(!this._sortedLayerRenderersDirty)return;if(this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers.clear(),0===this._layerRenderers.size)return;const[{view:{allLayerViews:e}}]=this._layerRenderers.keys(),t=new Set(this._layerRenderers.values());e.forEach(e=>{const i=e,r=this._layerRenderers.get(i);r&&(this._sortedLayerRenderers.push(new Z(i,r)),t.delete(r))}),t.forEach(e=>{this._sortedLayerRenderers.push(new Z(null,e))})}setViewParameters(e,t){t.viewport=e.viewport;const i=e.extent;Object(f["o"])(t.projectionMatrix,0,i[2]-i[0],0,i[3]-i[1],t.near,t.far),Object(f["i"])(t.viewMatrix),Object(f["t"])(t.viewMatrix,t.viewMatrix,[-e.extent[0],-e.extent[1],0]),t.setGLViewport(this._rctx),this._renderContext.camera=t,this._bindParameters.camera=t,this._bindParameters.inverseViewport[0]=1/t.fullViewport[2],this._bindParameters.inverseViewport[1]=1/t.fullViewport[3]}hasNonZeroSizedView(e){for(let t=0;t<e.numViews;t++){const i=e.views[t];if(i.extent[0]!==i.extent[2]&&i.extent[1]!==i.extent[3])return!0}return!1}emitContentChanged(){this.onContentChanged&&this.onContentChanged()}updateHasWater(){const e=Object(b["b"])(this._layerRenderers,e=>e.hasWater);e!==this._hasWater&&(this._hasWater=e)}updateHasHighlights(){const e=Object(b["b"])(this._layerRenderers,e=>e.hasHighlights);e!==this._hasHighlights&&(this._hasHighlights=e,this.onHasHighlightsChanged&&this.onHasHighlightsChanged(this._hasHighlights))}updateRendersOccluded(){const e=Object(b["b"])(this._layerRenderers,e=>e.rendersOccluded);e!==this._rendersOccluded&&(this._rendersOccluded=e,this.onRendersOccludedChanged&&this.onRendersOccludedChanged(this.rendersOccluded))}drawDebugTexture(e,t,i){const r=this._rctx;this.ensureDebugPatternResources(e,t);const a=this._debugTextureTechnique.program;r.bindProgram(a),r.setPipelineState(this._debugTextureTechnique.pipeline),a.setUniform4f("color",i[0],i[1],i[2],1),a.setUniform1i("tex",0),r.bindTexture(this._debugPatternTexture,0),r.bindVAO(this._quadVAO),r.drawArrays(5,0,Object(y["f"])(this._quadVAO,"geometry"))}ensureDebugPatternResources(e,t){if(this._debugPatternTexture)return;const i=new Uint8Array(e*t*4);let r=0;for(let n=0;n<t;n++)for(let a=0;a<e;a++){const s=Math.floor(a/10),o=Math.floor(n/10);s<2||o<2||10*s>e-20||10*o>t-20?(i[r++]=255,i[r++]=255,i[r++]=255,i[r++]=255):(i[r++]=255,i[r++]=255,i[r++]=255,i[r++]=1&s&&1&o?1&a^1&n?0:255:1&s^1&o?0:128)}this._debugPatternTexture=new v["a"](this._rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:e,height:t},i);const a=new B["b"];a.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniqueRepository.acquireAndReleaseExisting(B["a"],a,this._debugTextureTechnique),this._quadVAO=Object(O["d"])(this._rctx)}get test(){return{layerRenderers:this._layerRenderers}}};Object(r["a"])([Object(S["c"])()],W.prototype,"_shaderTechniqueRepository",void 0),Object(r["a"])([Object(S["c"])()],W.prototype,"_stippleTextureRepository",void 0),Object(r["a"])([Object(s["b"])(),Object(S["c"])()],W.prototype,"waterTextureRepository",void 0),Object(r["a"])([Object(s["b"])({constructOnly:!0})],W.prototype,"renderView",void 0),Object(r["a"])([Object(s["b"])({constructOnly:!0})],W.prototype,"scheduler",void 0),Object(r["a"])([Object(s["b"])()],W.prototype,"globalUnitScale",void 0),Object(r["a"])([Object(s["b"])({type:Boolean,readOnly:!0})],W.prototype,"updating",null),W=Object(r["a"])([Object(o["a"])("esri.views.3d.terrain.OverlayRenderer")],W);class Z{constructor(e,t){this.layerView=e,this.renderer=t}}const $=[[1,.5,.5],[.5,.5,1],[.5,1,.5]],Q=new j["a"];Q.near=1,Q.far=1e4,Q.relativeElevation=null;const X=Object(d["e"])(),Y=Object(d["e"])(),K=-2,J=4},7697:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i("3886");function a(e){e.fragment.uniforms.add("u_transformGrid","sampler2D"),e.fragment.uniforms.add("u_transformSpacing","vec2"),e.fragment.uniforms.add("u_transformGridSize","vec2"),e.fragment.uniforms.add("u_targetImageSize","vec2"),e.fragment.code.add(r["a"]`
    vec2 projectPixelLocation(vec2 coords) {
      // pixel index in row/column, corresponds to upperleft corner, e.g. [100, 20]
      vec2 index_image = floor(coords * u_targetImageSize);

      // pixel's corresponding cell index in transform grid
      // each transform cell corresponds to 4 pixels: 6 coefficients from lowerleft triangle followed by 6 coefficients from upperright triangle
      vec2 oneTransformPixel = vec2(0.25 / u_transformGridSize.s, 1.0 / u_transformGridSize.t);
      vec2 index_transform = floor(index_image / u_transformSpacing) / u_transformGridSize;

      // correspoding position in transform grid cell, cell center coordinates
      vec2 pos = fract((index_image + vec2(0.5, 0.5)) / u_transformSpacing);
      vec2 srcLocation;
      // pixel's corresponding transform cell location, center cell coordinates
      vec2 transform_location = index_transform + oneTransformPixel * 0.5;

      // use lower triangle or upper triangle
      if (pos.s <= pos.t) {
        vec4 ll_abc = texture2D(u_transformGrid, vec2(transform_location.s, transform_location.t));
        vec4 ll_def = texture2D(u_transformGrid, vec2(transform_location.s + oneTransformPixel.s, transform_location.t));
        srcLocation.s = dot(ll_abc.rgb, vec3(pos, 1.0));
        srcLocation.t = dot(ll_def.rgb, vec3(pos, 1.0));
      } else {
        vec4 ur_abc = texture2D(u_transformGrid, vec2(transform_location.s + 2.0 * oneTransformPixel.s, transform_location.t));
        vec4 ur_def = texture2D(u_transformGrid, vec2(transform_location.s + 3.0 * oneTransformPixel.s, transform_location.t));
        srcLocation.s = dot(ur_abc.rgb, vec3(pos, 1.0));
        srcLocation.t = dot(ur_def.rgb, vec3(pos, 1.0));
      }
      return srcLocation;;
    }
  `)}function n(e){e.include(a),e.fragment.uniforms.add("u_image","sampler2D"),e.fragment.uniforms.add("u_isFloatTexture","bool"),e.fragment.uniforms.add("u_flipY","bool"),e.fragment.uniforms.add("u_applyTransform","bool"),e.fragment.uniforms.add("u_opacity","float"),e.fragment.code.add(r["a"]`
    vec2 getPixelLocation(vec2 coords) {
      vec2 targetLocation = u_flipY ? vec2(coords.s, 1.0 - coords.t) : coords;
      if (!u_applyTransform) {
        return targetLocation;
      }
      return projectPixelLocation(targetLocation);
    }

    bool isOutside(vec2 coords){
      if (coords.t>1.00001 ||coords.t<-0.00001 || coords.s>1.00001 ||coords.s<-0.00001) {
        return true;
      } else {
        return false;
      }
    }

    vec4 getPixel(vec2 pixelLocation) {
      return texture2D(u_image, pixelLocation);
    }
  `)}},"76ac":function(e,t,i){"use strict";i.d(t,"a",(function(){return o})),i.d(t,"b",(function(){return s}));var r=i("3886"),a=i("4db9"),n=i("690a");function s(e){const t=new n["a"];return 2===e.geometry?(t.attributes.add("position","vec2"),t.varyings.add("color","vec4"),t.vertex.uniforms.add("lightingMainDirection","vec3").add("cameraPosition","vec3").add("undergroundFadeAlpha","float"),t.vertex.code.add(r["a"]`
      void main(void) {
          float ndotl = dot(normalize(cameraPosition), -lightingMainDirection);
          float lighting = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));

          color = vec4(vec3(lighting), undergroundFadeAlpha);

          gl_Position = vec4(position.xy, 1.0, 1.0); // on the far plane
      }
  `),t.fragment.code.add(r["a"]`
      void main() {
          gl_FragColor = color;
      }
  `)):(t.include(a["a"],{linearDepth:!1}),t.attributes.add("position","vec3"),t.varyings.add("vtc","vec2"),t.varyings.add("falloff","float"),1!==e.geometry&&t.varyings.add("innerFactor","float"),t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("lightingMainDirection","vec3"),1!==e.geometry&&t.vertex.uniforms.add("silCircleCenter","vec3").add("silCircleV1","vec3").add("silCircleV2","vec3").add("texV","vec2").add("innerScale","float"),1!==e.geometry&&t.vertex.code.add(r["a"]`
			const float TWICEPI = 2.0*3.14159265;
			const float ATMOSPHERE_RIM_SEGMENTS = 128.0;
		`),t.vertex.code.add(r["a"]`
		void main(void) {
			vec3 lightDirection = -lightingMainDirection;
	`),1===e.geometry?t.vertex.code.add(r["a"]`
			vec3 pos = position;
			float ndotl = lightDirection.z;
			vtc = vec2(0.0, position.z+0.05);
			`):t.vertex.code.add(r["a"]`
			innerFactor = clamp(-position.z, 0.0, 1.0);
			float scale = position.y * (1.0 + innerFactor * innerScale);
			float phi = position.x * (TWICEPI / ATMOSPHERE_RIM_SEGMENTS) + 1.0;
			vec3 pos =  (silCircleCenter + sin(phi) * silCircleV1 + cos(phi) * silCircleV2) * scale;
			float ndotl = dot(normalize(position.y > 0.0 ? pos: silCircleCenter), lightDirection);

			vtc.x = position.x / ATMOSPHERE_RIM_SEGMENTS;
			vtc.y = texV.x * (1.0 - position.z) + texV.y * position.z;
		`),t.vertex.code.add(r["a"]`
		falloff = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));

		gl_Position = transformPosition(proj, view, pos);
		gl_Position.z = gl_Position.w; // project atmosphere onto the far plane
			}
	`),t.fragment.uniforms.add("tex","sampler2D"),1!==e.geometry&&t.fragment.uniforms.add("altitudeFade","float"),t.fragment.code.add(r["a"]`
		void main() {
			vec4 texColor = texture2D(tex, vtc);
	`),1===e.geometry?t.fragment.code.add(r["a"]`
			gl_FragColor = texColor * falloff;
			}
		`):t.fragment.code.add(r["a"]`
			vec4 atmosphereColor = texColor * falloff;
			vec4 innerColor = vec4(texColor.rgb * falloff, 1.0 - altitudeFade);
			gl_FragColor = mix(atmosphereColor, innerColor, smoothstep(0.0, 1.0, innerFactor));
		}
		`)),t}var o=Object.freeze({__proto__:null,build:s})},7752:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i("fc00");function a(e){const t=Object(r["a"])().vec3f("position");return e.normals&&t.vec2i16("normalCompressed",{glNormalized:!0}),1===e.textureCoordinates?t.vec2f("uv0"):2===e.textureCoordinates&&(t.vec2f("uv0"),t.vec4u16("uvRegion",{glNormalized:!0})),e.colors&&t.vec4u8("color",{glNormalized:!0}),t.alignTo(4)}},7779:function(e,t,i){"use strict";i.d(t,"a",(function(){return a})),i.d(t,"b",(function(){return u}));var r=i("9ef0");const a={main:new r["a"]([255,127,0]),selected:new r["a"]([255,255,255]),outline:new r["a"]([0,0,0,.5]),selectedOutline:new r["a"]([255,255,255]),hoverOutline:new r["a"]([255,255,255]),secondary:new r["a"]([255,255,255]),secondaryOutline:new r["a"]([100,100,100]),transparent:new r["a"]([0,0,0,0])};function n(e,t){if(t)for(const i in t)e[i]=t[i]}class s{constructor(e){this.size=8,this.hoverSize=10,this.color=a.main,this.hoverColor=a.main,this.outlineColor=a.outline,this.hoverOutlineColor=a.hoverOutline,n(this,e)}}class o{constructor(e){this.color=a.secondary,this.hoverColor=a.main,n(this,e)}}class c{constructor(e){this.color=a.transparent,this.hoverColor=a.transparent,this.outlineColor=a.main,this.hoverOutlineColor=a.main,this.stagedColor=a.transparent,this.stagedOutlineColor=a.secondary,n(this,e)}}class l{constructor(e){this.vertex=new s,this.midpoint=new s({color:a.secondary,outlineColor:a.secondaryOutline,size:6}),this.selected=new s({color:a.selected,hoverColor:a.selected,hoverOutlineColor:a.hoverOutline}),n(this,e)}}class h{constructor(e){this.center=new s({color:a.secondaryOutline}),this.fill=new c,this.line=new o,this.vertex=new s({color:a.selected,outlineColor:a.main,hoverColor:a.selected,hoverOutlineColor:a.secondaryOutline}),n(this,e)}}class d{constructor(e){this.reshapeGraphics=new l,this.transformGraphics=new h,n(this,e)}}const u=new d},"78ba":function(e,t,i){"use strict";i.d(t,"a",(function(){return h}));var r=i("b2b2"),a=i("e92d"),n=i("c649"),s=i("b50f"),o=i("f4cc"),c=i("dfa0");const l=a["a"].getLogger("esri.core.workers.WorkerHandle");class h{constructor(e,t,i,r={}){this._mainMethod=t,this._listeners=[],this._promise=Object(c["b"])(e,{...r,scheduler:i}).then(e=>{if(void 0===this._thread){this._thread=e,this._promise=null,r.hasInitialize&&this.broadcast({},"initialize");for(const e of this._listeners)this._connectListener(e)}else e.close()}),this._promise.catch(t=>l.error(`Failed to initialize ${e} worker: ${t}`))}on(e,t){const i={removed:!1,eventName:e,callback:t,threadHandle:null};return this._listeners.push(i),this._connectListener(i),Object(n["c"])(()=>{i.removed=!0,Object(s["k"])(this._listeners,i),this._thread&&Object(r["k"])(i.threadHandle)&&i.threadHandle.remove()})}destroy(){this._thread&&(this._thread.close(),this._thread=null),this._promise=null}invoke(e,t){return this.invokeMethod(this._mainMethod,e,t)}invokeMethod(e,t,i){if(this._thread){const r=this.getTransferList(t,e);return this._thread.invoke(e,t,{transferList:r,signal:i})}return this._promise?this._promise.then(()=>(Object(o["w"])(i),this.invokeMethod(e,t,i))):Promise.reject(null)}broadcast(e,t){return this._thread?Promise.all(this._thread.broadcast(t,e)).then(()=>{}):this._promise?this._promise.then(()=>this.broadcast(e,t)):Promise.reject()}get promise(){return this._promise}_connectListener(e){this._thread&&this._thread.on(e.eventName,e.callback).then(t=>{e.removed||(e.threadHandle=t)})}}},"7a18":function(e,t,i){"use strict";function r(e){return e&&"base-tile"===e.type||"tile"===e.type||"elevation"===e.type||"imagery-tile"===e.type||"base-elevation"===e.type||"open-street-map"===e.type||"wcs"===e.type||"web-tile"===e.type||"wmts"===e.type||"vector-tile"===e.type}function a(e){return e.parent&&"esri.Basemap"===e.parent.declaredClass&&e.parent.baseLayers.indexOf(e)>-1}function n(e){return!0===e.labelsVisible&&null!=e.labelingInfo&&e.labelingInfo.length>0}i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return a})),i.d(t,"c",(function(){return r}))},"7abc":function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i("0b2d");class a{constructor(e,t){this.vec3=e,this.id=t}}function n(e,t,i,n){return new a(Object(r["g"])(e,t,i),n)}},"7aed":function(e,t,i){"use strict";i.d(t,"a",(function(){return d})),i.d(t,"b",(function(){return u}));var r=i("a4ee"),a=i("c3a4"),n=i("ca98"),s=i("da35"),o=i("fa1e"),c=i("8e37"),l=i("189c"),h=i("3e44");class d extends n["a"]{initializeProgram(e){const t=d.shader.get().build();return new c["a"](e.rctx,t.generateSource("vertex"),t.generateSource("fragment"),o["a"])}initializePipeline(){return this.configuration.hasAlpha?Object(l["e"])({blending:Object(l["f"])(770,1,771,771),colorWrite:l["c"]}):Object(l["e"])({colorWrite:l["c"]})}}d.shader=new a["a"](h["a"],()=>i.e("chunk-2d0b3143").then(i.bind(null,"279a")));class u extends s["a"]{constructor(){super(...arguments),this.hasAlpha=!1}}Object(r["a"])([Object(s["b"])()],u.prototype,"hasAlpha",void 0)},"7b96":function(e,t,i){"use strict";var r=i("b2b2"),a=i("0b2d"),n=i("e431"),s=i("4261"),o=i("f895"),c=i("ba58"),l=i("e9d6");class h{constructor(e,t,i,r,a,n,s,o=null){this.graphics3DSymbolLayer=e,this.stageObject=t,this._uniqueGeometries=i,this._uniqueMaterials=r,this._uniqueTextures=a,this.elevationAligner=n,this.elevationContext=s,this._edgeState=o,this.type="object3d",this.stageLayer=null,this.stage=null,this._visible=!1,this._addedToStage=!1,this.alignedSampledElevation=0,this.needsElevationUpdates=!1,this.graphics3DSymbolLayer=e,this.stageObject=t}get isElevationSource(){return!(!this.stageObject.metadata||!this.stageObject.metadata.isElevationSource)}getBSRadius(){throw new Error("Method not implemented.")}initialize(e,t){this.stageLayer=t,this.stage=e,e.addMany(this._uniqueMaterials),e.addMany(this._uniqueGeometries),e.addMany(this._uniqueTextures),e.add(this.stageObject)}destroy(){const e=this.stage;this.stageLayer&&(e.removeMany(this._uniqueMaterials),e.removeMany(this._uniqueGeometries),e.removeMany(this._uniqueTextures)),e.remove(this.stageObject),this._addedToStage&&(this.stageLayer.remove(this.stageObject),this._addedToStage=!1);const t=this.stage.renderView.ensureEdgeView();t.hasObject(this.stageObject)&&t.removeObject(this.stageObject),this.stageObject.dispose(),this._visible=!1,this.stageLayer=null,this.stage=null}layerOpacityChanged(e,t){if(Object(r["j"])(this._edgeState))return;const i=d(this._edgeState.baseMaterial);let a=!1;for(const r of this._edgeState.edgeMaterials)r.objectTransparency!==i&&(r.objectTransparency=i,a=!0);a&&this.resetEdgeObject(t),this.stage.renderView.ensureEdgeView().updateAllComponentOpacities(this.stageObject,[e])}slicePlaneEnabledChanged(e,t){Object(r["j"])(this._edgeState)||(this.stage.renderView.ensureEdgeView().updateAllComponentMaterials(this.stageObject,this._edgeState.edgeMaterials,{slicePlaneEnabled:e},!t),this._edgeState.properties.slicePlaneEnabled=e)}setVisibility(e){if(null!=this.stage&&this._visible!==e&&(this._visible=e,this._visible?this._addedToStage?this.stageObject.setVisible(!0):(this.stageLayer.add(this.stageObject),this._addedToStage=!0):this.stageObject.setVisible(!1),Object(r["k"])(this._edgeState))){const t=this.stage.renderView.ensureEdgeView();t.hasObject(this.stageObject)?t.updateObjectVisibility(this.stageObject,e):e&&this.addOrUpdateEdgeObject(t,!1)}}get visible(){return this._visible}alignWithElevation(e,t,i,a){if(null==this.elevationAligner)return;Object(r["k"])(i)&&Object(l["g"])(this.elevationContext.featureExpressionInfoContext,i);const n=this.elevationAligner(this,this.elevationContext,e,t);null!=n&&(this.alignedSampledElevation=n),this.resetEdgeObject(a)}getCenterObjectSpace(e=Object(a["e"])()){return Object(n["l"])(e,Object(o["c"])(this.stageObject.getBounds(!0)))}getBoundingBoxObjectSpace(e=Object(s["h"])()){return u(this.stageObject,!0,e)}computeAttachmentOrigin(e){for(const t of this.stageObject.geometryRecords)t.computeAttachmentOrigin(m)&&(Object(n["n"])(m,m,this.stageObject.transformation),Object(n["g"])(e.render.origin,e.render.origin,m),e.render.num++)}async getProjectedBoundingBox(e,t,i,a,o){const l=this.getBoundingBoxObjectSpace(o),h=b,d=Object(s["y"])(l)?1:h.length;for(let r=0;r<d;r++){const e=h[r];f[0]=l[e[0]],f[1]=l[e[1]],f[2]=l[e[2]],Object(n["n"])(f,f,this.stageObject.transformation),p[3*r+0]=f[0],p[3*r+1]=f[1],p[3*r+2]=f[2]}if(!e(p,0,d))return null;Object(s["k"])(l);let u=null;this.calculateRelativeScreenBounds&&(u=this.calculateRelativeScreenBounds());for(let r=0;r<3*d;r+=3){for(let e=0;e<3;e++)l[e]=Math.min(l[e],p[r+e]),l[e+3]=Math.max(l[e+3],p[r+e]);u&&i.push({location:p.slice(r,r+3),screenSpaceBoundingRect:u})}if(t&&t.service&&"absolute-height"!==this.elevationContext.mode){Object(s["e"])(l,m);const e="relative-to-scene"===this.elevationContext.mode?"scene":"ground";let i=0;if(t.useViewElevation)i=Object(r["u"])(t.service.getElevation(m[0],m[1],e),0);else try{const n=Object(c["d"])(l,t);i=Object(r["u"])(await t.service.queryElevation(m[0],m[1],a,n,e),0)}catch(g){}Object(s["A"])(l,0,0,-this.alignedSampledElevation+i)}return l}addObjectState(e,t){0===e&&t.addObject(this.stageObject,this.stageObject.highlight()),1===e&&t.addObject(this.stageObject,this.stageObject.maskOccludee())}removeObjectState(e){e.removeObject(this.stageObject)}resetEdgeObject(e){if(Object(r["j"])(this._edgeState))return;const t=this.stage.renderView.ensureEdgeView();this._visible?this.addOrUpdateEdgeObject(t,e):t.removeObject(this.stageObject)}addOrUpdateEdgeObject(e,t){const i=this._edgeState;if(Object(r["j"])(i))return;const a=d(i.baseMaterial);for(const r of i.edgeMaterials)r.objectTransparency=a;e.addOrUpdateObject3D(this.stageObject,i.edgeMaterials,i.properties,!t).then(()=>{var e;return null==(e=this.stageLayer)?void 0:e.commit()})}}function d(e){return e.isVisible?e.params.transparent?1:2:0}function u(e,t,i){return i||(i=Object(s["h"])()),Object(s["E"])(i,e.getBBMin(t)),Object(s["D"])(i,e.getBBMax(t)),i}!function(e){let t;!function(e){e[e.REMOVE_OBJECT=0]="REMOVE_OBJECT",e[e.HIDE_FACERANGE=1]="HIDE_FACERANGE"}(t=e.VisibilityModes||(e.VisibilityModes={}))}(h||(h={}));const p=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],f=Object(a["e"])(),m=Object(a["e"])(),b=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];var g=h;t["a"]=g},"7c1d":function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i("3886");function a(e){const t=r["a"]`
    vec4 alignToPixelCenter(vec4 clipCoord, vec2 widthHeight) {
      vec2 xy = vec2(0.500123) + 0.5 * clipCoord.xy / clipCoord.w;
      vec2 pixelSz = vec2(1.0) / widthHeight;
      vec2 ij = (floor(xy * widthHeight) + vec2(0.5)) * pixelSz;
      vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
      return vec4(result, clipCoord.zw);
    }
  `,i=r["a"]`

    vec4 alignToPixelOrigin(vec4 clipCoord, vec2 widthHeight) {
      vec2 xy = vec2(0.5) + 0.5 * clipCoord.xy / clipCoord.w;
      vec2 pixelSz = vec2(1.0) / widthHeight;
      vec2 ij = floor((xy + 0.5 * pixelSz) * widthHeight) * pixelSz;
      vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
      return vec4(result, clipCoord.zw);
    }
  `;e.vertex.code.add(t),e.vertex.code.add(i),e.fragment.code.add(t),e.fragment.code.add(i)}},"7c4b":function(e,t,i){"use strict";i.d(t,"a",(function(){return o}));var r=i("c120"),a=i("f4cc"),n=i("ce6d");const s=1/Object(r["a"])("mapview-transitions-duration");class o extends n["a"]{constructor(){super(...arguments),this._fadeOutResolver=null,this._fadeInResolver=null,this._clips=null,this.computedVisible=!0,this.computedOpacity=1,this.fadeTransitionEnabled=!1,this.inFadeTransition=!1,this._isReady=!1,this._opacity=1,this._stage=null,this._visible=!0}get clips(){return this._clips}set clips(e){this._clips=e,this.requestRender()}get isReady(){return this._isReady}get opacity(){return this._opacity}set opacity(e){this._opacity!==e&&(this._opacity=Math.min(1,Math.max(e,0)),this.requestRender())}get stage(){return this._stage}set stage(e){if(this._stage===e)return;const t=this._stage;this._stage=e,e?this._stage.untrashDisplayObject(this)||(this.onAttach(),this.emit("attach")):t.trashDisplayObject(this)}get visible(){return this._visible}set visible(e){this._visible!==e&&(this._visible=e,this.requestRender())}fadeIn(){return this._fadeInResolver||(this._fadeOutResolver&&(this._fadeOutResolver(),this._fadeOutResolver=null),this.computedOpacity=0,this.fadeTransitionEnabled=!0,this._fadeInResolver=Object(a["h"])(),this.requestRender()),this._fadeInResolver.promise}fadeOut(){return this._fadeOutResolver||(this._fadeInResolver&&(this._fadeInResolver(),this._fadeInResolver=null),this.fadeTransitionEnabled=!0,this._fadeOutResolver=Object(a["h"])(),this.requestRender()),this._fadeOutResolver.promise}beforeRender(e){this.updateTransitionProperties(e.deltaTime,e.state.scale)}afterRender(e){this._fadeInResolver&&this.computedOpacity===this.opacity?(this._fadeInResolver(),this._fadeInResolver=null):this._fadeOutResolver&&0===this.computedOpacity&&(this._fadeOutResolver(),this._fadeOutResolver=null)}remove(){var e;null==(e=this.parent)||e.removeChild(this)}setTransform(e){}processRender(e){this.stage&&this.computedVisible&&this.doRender(e)}requestRender(){this.stage&&this.stage.requestRender()}processDetach(){this.onDetach(),this.emit("detach")}updateTransitionProperties(e,t){if(this.fadeTransitionEnabled){const t=this._fadeOutResolver||!this.visible?0:this.opacity,i=this.computedOpacity;if(i===t)this.computedVisible=this.visible;else{const r=e*s;this.computedOpacity=i>t?Math.max(t,i-r):Math.min(t,i+r),this.computedVisible=this.computedOpacity>0;const a=t===this.computedOpacity;this.inFadeTransition=!a,a||this.requestRender()}}else this.computedOpacity=this.opacity,this.computedVisible=this.visible}onAttach(){}onDetach(){}doRender(e){}ready(){this._isReady||(this._isReady=!0,this.emit("isReady"),this.requestRender())}}},"7c5a":function(e,t,i){"use strict";i.r(t);var r=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{staticClass:"wrap"},[i("div",{ref:"dom",staticClass:"container"})])},a=[],n=i("1da1"),s=(i("96cf"),i("d81d"),i("d3b7"),i("159b"),i("b0c0"),i("99af"),i("bc3a")),o=i.n(s),c=i("5996"),l=(i("2650"),i("53f8"),i("5bd5")),h=(i("c246"),i("6d1b")),d=i("a4ee"),u=i("c120"),p=i("b2b2"),f=i("e92d"),m=i("cea0"),b=i("c649"),g=i("59b2"),v=i("1a3e"),y=i("d386"),O=i("ce50"),_=i("e041"),x=(i("8eed"),i("f402"),i("9d83")),j=i("f4cc"),w=i("5815"),S=i("9786"),C=i("4ae5"),T=i("3af1"),P=(i("e06a"),i("2c4f")),A=i("a915"),R=i("8d60"),M=i("0b2d"),E=i("2603"),D=i("8d667"),I=i("cb72"),L=i("3795"),V=i("f694"),k=i("e64d"),F=i("9180"),z=i("8188");function U(e,t){return null!=e&&("2d"===t||("local"===t?!e.isGeographic:e.isWebMercator||e.isWGS84||4490===e.wkid||104971===e.wkid||104905===e.wkid||104903===e.wkid))}var G,B=i("7ffa"),H=i("6a0e"),N=i("afcf"),q=i("09db");let W=G=class extends H["a"]{constructor(e){super(e),this.date=null,this.directShadowsEnabled=!1,this.displayUTCOffset=null}readDate(e,t){return null!=t.datetime&&new Date(t.datetime)||null}writeDate(e,t,i){t[i]=e.getTime()}readDirectShadowsEnabled(e,t){return!!t.directShadows}writedirectShadowsEnabled(e,t,i){e&&(t[i]=e)}writeDisplayUTCOffset(e,t){null!=e&&(t.displayUTCOffset=e)}clone(){return new G(this.cloneConstructProperties())}cloneConstructProperties(){const e={directShadowsEnabled:this.directShadowsEnabled,displayUTCOffset:null!=this.displayUTCOffset?this.displayUTCOffset:null};return null!=this.date&&(e.date=new Date(this.date.getTime())),e}};Object(d["a"])([Object(g["b"])({type:Date,json:{type:Number,write:{target:"datetime"}}})],W.prototype,"date",void 0),Object(d["a"])([Object(N["a"])("date",["datetime"])],W.prototype,"readDate",null),Object(d["a"])([Object(q["a"])("date")],W.prototype,"writeDate",null),Object(d["a"])([Object(g["b"])({type:Boolean,json:{default:!1,write:{target:"directShadows"}}})],W.prototype,"directShadowsEnabled",void 0),Object(d["a"])([Object(N["a"])("directShadowsEnabled",["directShadows"])],W.prototype,"readDirectShadowsEnabled",null),Object(d["a"])([Object(q["a"])("directShadowsEnabled")],W.prototype,"writedirectShadowsEnabled",null),Object(d["a"])([Object(g["b"])({type:Number,json:{write:!0}})],W.prototype,"displayUTCOffset",void 0),Object(d["a"])([Object(q["a"])("displayUTCOffset")],W.prototype,"writeDisplayUTCOffset",null),W=G=Object(d["a"])([Object(y["a"])("esri.webscene.Lighting")],W);var Z=W,$=Z;let Q=class extends H["a"]{constructor(e){super(e)}clone(){}};Object(d["a"])([Object(g["b"])({readOnly:!0,json:{read:!1}})],Q.prototype,"type",void 0),Q=Object(d["a"])([Object(y["a"])("esri.webscene.background.Background")],Q);var X,Y=Q,K=Y,J=i("448d"),ee=i("9ef0"),te=i("5c00");const ie={...te["a"],nonNullable:!0};let re=X=class extends K{constructor(e){super(e),this.type="color",this.color=new ee["a"]([0,0,0,1])}clone(){return new X(this.cloneProperties())}cloneProperties(){return{color:this.color.clone()}}};Object(d["a"])([Object(J["a"])({color:"color"},{readOnly:!0})],re.prototype,"type",void 0),Object(d["a"])([Object(g["b"])(ie)],re.prototype,"color",void 0),re=X=Object(d["a"])([Object(y["a"])("esri.webscene.background.ColorBackground")],re);var ae=re,ne=ae;const se={base:K,key:"type",typeMap:{color:ne}};function oe(e){return(t,i,r)=>{if(!t)return t;for(const a in e.typeMap)if(t.type===a){const i=new e.typeMap[a];return i.read(t,r),i}}}const ce={types:se,json:{read:oe(se),write:{overridePolicy:(e,t,i)=>({enabled:!i||!i.isPresentation})}}};var le;const he=(e,t,i)=>({enabled:!i||!i.isPresentation});let de=le=class extends H["a"]{constructor(e){super(e),this.lighting=new $,this.background=null,this.atmosphereEnabled=!0,this.starsEnabled=!0}clone(){return new le(this.cloneConstructProperties())}cloneConstructProperties(){return{lighting:$.prototype.clone.call(this.lighting),background:Object(B["a"])(this.background),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled}}};Object(d["a"])([Object(g["b"])({type:$,json:{write:!0}})],de.prototype,"lighting",void 0),Object(d["a"])([Object(g["b"])(ce)],de.prototype,"background",void 0),Object(d["a"])([Object(g["b"])({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:he}}})],de.prototype,"atmosphereEnabled",void 0),Object(d["a"])([Object(g["b"])({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:he}}})],de.prototype,"starsEnabled",void 0),de=le=Object(d["a"])([Object(y["a"])("esri.webscene.Environment")],de);var ue=de,pe=ue,fe=i("dfa0"),me=i("cf9c"),be=i("4dc1"),ge=i("49a0"),ve=i("7a18"),ye=i("05a9"),Oe=i("5e70"),_e=i("7aa6"),xe=i("0cb9"),je=i("fc29"),we=i("af40"),Se=i("2172"),Ce=i("ce6d"),Te=i("851f"),Pe=i("2ec5");const Ae=f["a"].getLogger("esri.views.support.GroundViewElevationSampler");let Re=class extends Ce["a"].EventedAccessor{constructor(e){super(e),this.demResolution={min:-1,max:-1},this.noDataValue=Pe["c"]}initialize(){this.view.basemapTerrain.on("elevation-change",()=>this.emit("changed",{}))}get extent(){const e=this.view.basemapTerrain;return e.extent&&e.spatialReference?Object(F["A"])(e.extent,e.spatialReference):null}elevationAt(e){const t=e.spatialReference,i=this.spatialReference;if(!Object(S["a"])(t,i)){const e=t?t.wkid:"unknown";return Ae.error(`Cannot sample elevation at a location with spatial reference (${e}) different from the view (${i.wkid})`),null}if(!Object(Se["e"])(this.extent,e)){const t=this.extent,i=`${t.xmin}, ${t.ymin}, ${t.xmax}, ${t.ymax}`;Ae.warn("#elevationAt()",`Point used to sample elevation (${e.x}, ${e.y}) is outside of the sampler extent (${i})`)}return Object(xe["b"])(this.view.elevationProvider,e)}queryElevation(e){return Object(Te["b"])(e.clone(),this)}};Object(d["a"])([Object(g["b"])({readOnly:!0})],Re.prototype,"demResolution",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],Re.prototype,"extent",null),Object(d["a"])([Object(g["b"])({readOnly:!0})],Re.prototype,"noDataValue",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0,aliasOf:"view.basemapTerrain.spatialReference"})],Re.prototype,"spatialReference",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],Re.prototype,"view",void 0),Re=Object(d["a"])([Object(y["a"])("esri.views.support.GroundViewElevationSampler")],Re);var Me=Re,Ee=Me;let De=class extends je["a"]{constructor(e){super(e),this.handles=new we["a"],this.view=null,this.layerViews=new P["a"]}initialize(){this.handles.add(Object(L["f"])(this,"view.map.ground",e=>e.load())),this.handles.add(this.layerViews.on("after-changes",()=>this.layerViewsAfterChangesHandler()))}destroy(){this._set("view",null),this.handles&&(this.handles.destroy(),this.handles=null)}get elevationSampler(){return this.view?"2d"===this.view.type?null:this.view.ready&&this.view.basemapTerrain&&this.view.basemapTerrain.ready?new Ee({view:this.view}):null:null}get updating(){return!this.suspended&&this.layerViews.some(e=>e.updating)}get suspended(){return!this.view||this.view.suspended}layerViewsAfterChangesHandler(){this.handles.remove("updating"),this.handles.add(this.layerViews.map(e=>e.watch("updating",()=>this.updateUpdating(),!0)).toArray(),"updating"),this.updateUpdating()}updateUpdating(){this.notifyChange("updating")}};Object(d["a"])([Object(g["b"])({readOnly:!0})],De.prototype,"elevationSampler",null),Object(d["a"])([Object(g["b"])({type:Boolean,readOnly:!0})],De.prototype,"updating",null),Object(d["a"])([Object(g["b"])({constructOnly:!0})],De.prototype,"view",void 0),Object(d["a"])([Object(g["b"])({type:P["a"],readOnly:!0})],De.prototype,"layerViews",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],De.prototype,"suspended",null),De=Object(d["a"])([Object(y["a"])("esri.views.GroundView")],De);var Ie=De,Le=Ie,Ve=i("de65"),ke=i("412f"),Fe=i("535f"),ze=i("f61d"),Ue=i("c4da");function Ge(e){return"global"===e?1:2}const Be=()=>i.e("chunk-5aaaddb0").then(i.bind(null,"cbe4")),He=()=>Promise.resolve().then(i.bind(null,"1dc3")),Ne={"base-dynamic":()=>i.e("chunk-0ad75820").then(i.bind(null,"7af4")),"base-elevation":He,"base-tile":Be,"bing-maps":Be,"building-scene":()=>Promise.all([i.e("chunk-2d0d03a7"),i.e("chunk-31ca1d6f"),i.e("chunk-66a552f7"),i.e("chunk-3667027a"),i.e("chunk-6acd4e4a")]).then(i.bind(null,"246f")),csv:()=>Promise.all([i.e("chunk-2d0d03a7"),i.e("chunk-31ca1d6f"),i.e("chunk-66a552f7"),i.e("chunk-e9a1e1b6"),i.e("chunk-227c17c0")]).then(i.bind(null,"88bb")),elevation:He,feature:()=>Promise.all([i.e("chunk-2d0d03a7"),i.e("chunk-31ca1d6f"),i.e("chunk-66a552f7"),i.e("chunk-e9a1e1b6"),i.e("chunk-8a24c11a")]).then(i.bind(null,"6e37")),geojson:()=>Promise.all([i.e("chunk-2d0d03a7"),i.e("chunk-31ca1d6f"),i.e("chunk-66a552f7"),i.e("chunk-e9a1e1b6"),i.e("chunk-72f1c4b6")]).then(i.bind(null,"66a7")),graphics:()=>Promise.all([i.e("chunk-66a552f7"),i.e("chunk-72218984")]).then(i.bind(null,"bb49")),group:()=>i.e("chunk-2d0cc20b").then(i.bind(null,"4d38")),imagery:()=>i.e("chunk-33c596ba").then(i.bind(null,"3a8b")),"integrated-mesh":()=>Promise.all([i.e("chunk-66a552f7"),i.e("chunk-3667027a"),i.e("chunk-553f6a54")]).then(i.bind(null,"f05f")),"map-image":()=>i.e("chunk-b782072a").then(i.bind(null,"997a")),"ogc-feature":()=>Promise.all([i.e("chunk-2d0d03a7"),i.e("chunk-31ca1d6f"),i.e("chunk-66a552f7"),i.e("chunk-e9a1e1b6"),i.e("chunk-95a9c458")]).then(i.bind(null,"52c0")),"open-street-map":Be,"point-cloud":()=>Promise.all([i.e("chunk-33bd1f4e"),i.e("chunk-6c7a01e0")]).then(i.bind(null,"9056")),scene:e=>null==e.profile||"mesh-pyramids"===e.profile?Promise.all([i.e("chunk-2d0d03a7"),i.e("chunk-31ca1d6f"),i.e("chunk-66a552f7"),i.e("chunk-3667027a"),i.e("chunk-1eca538c")]).then(i.bind(null,"1e7c")):Promise.all([i.e("chunk-2d0d03a7"),i.e("chunk-31ca1d6f"),i.e("chunk-66a552f7"),i.e("chunk-e9a1e1b6"),i.e("chunk-2ce23232")]).then(i.bind(null,"c572")),stream:()=>Promise.all([i.e("chunk-2d0d03a7"),i.e("chunk-31ca1d6f"),i.e("chunk-66a552f7"),i.e("chunk-e9a1e1b6"),i.e("chunk-0bd2c71f")]).then(i.bind(null,"a7bf")),tile:Be,"imagery-tile":()=>i.e("chunk-e76b2668").then(i.bind(null,"1793")),"vector-tile":()=>Promise.all([i.e("chunk-2893bf7e"),i.e("chunk-43384cda")]).then(i.bind(null,"ce88")),wcs:()=>i.e("chunk-e76b2668").then(i.bind(null,"1793")),"web-tile":Be,wms:()=>i.e("chunk-293b2d0f").then(i.bind(null,"3dce")),wmts:()=>i.e("chunk-2d0a3fdd").then(i.bind(null,"0513")),"geo-rss":null,kml:null,"map-notes":null,route:null,unknown:null,unsupported:null};function qe(e){const t=e.declaredClass?e.declaredClass.slice(e.declaredClass.lastIndexOf(".")+1):"Unknown",i=t.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new O["a"](i+":view-not-supported",t+" is not supported in 3D")}const We={hasLayerViewModule:e=>Object(p["k"])(Ne[e.type]),importLayerView:e=>{const t=Ne[e.type];if(!Object(p["k"])(t))throw qe(e);return t(e)}};var Ze=i("e20b"),$e=i("2255"),Qe=i("38a4"),Xe=i("680b");const Ye=f["a"].getLogger("esri.views.3d.state.Constraints");let Ke=class extends je["a"]{constructor(e){super(e),this.collision=new rt,this.distance=1/0,this.minimumPoiDistance=4}get altitude(){return 2===this.mode?null:this._get("altitude")||null}set altitude(e){2!==this.mode?this._set("altitude",e):Ye.warn("Altitude constraint is ignored in local scenes")}clampAltitude(e){return this.altitude?Object(Qe["d"])(e,this.altitude.min,this.altitude.max):e}clampTilt(e,t){if(!this.tilt)return t;const i=this.tilt(e);return Object(Qe["d"])(t,i.min,i.max)}clampDistance(e){return Math.min(e,this.distance)}createDefaultTilt(){return 2===this.mode?this.createDefaultTiltLocal():this.createDefaultTiltGlobal()}createConstantMaxTilt(e){return(t,i=it)=>(i.min=tt.min,i.max=e,i)}createDefaultTiltLocal(){const e=this.collision.enabled?Object(Xe["i"])([[4e3,tt.max],[1e4,Object(Qe["f"])(88)],[6e6,Object(Qe["f"])(88)]]):()=>tt.max;return(t,i=it)=>(i.min=tt.min,i.max=e(t),i)}createDefaultTiltGlobal(){const e=this.collision.enabled?Object(Xe["i"])([[4e3,tt.max],[5e4,Object(Qe["f"])(88)],[6e6,Object(Qe["f"])(88)],[2e7,tt.min]]):Object(Xe["i"])([[3e5,tt.max],[3e6,Object(Qe["f"])(88)],[6e6,Object(Qe["f"])(88)],[2e7,tt.min]]);return(t,i=it)=>(i.min=tt.min,i.max=e(t),i)}};function Je(e){return{min:-2e5,max:4*e.radius}}Object(d["a"])([Object(g["b"])()],Ke.prototype,"altitude",null),Object(d["a"])([Object(g["b"])({readOnly:!0})],Ke.prototype,"collision",void 0),Object(d["a"])([Object(g["b"])()],Ke.prototype,"distance",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],Ke.prototype,"minimumPoiDistance",void 0),Object(d["a"])([Object(g["b"])()],Ke.prototype,"tilt",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],Ke.prototype,"mode",void 0),Ke=Object(d["a"])([Object(y["a"])("esri.views.3d.state.Constraints")],Ke);const et=Je($e["a"]),tt={min:Object(Qe["f"])(.5),max:Object(Qe["f"])(179.5)},it={min:0,max:0};let rt=class extends je["a"]{constructor(){super(...arguments),this.enabled=!0,this.elevationMargin=5}};Object(d["a"])([Object(g["b"])({type:Boolean})],rt.prototype,"enabled",void 0),Object(d["a"])([Object(g["b"])({type:Number})],rt.prototype,"elevationMargin",void 0),rt=Object(d["a"])([Object(y["a"])("esri.views.3d.state.Constraints.CollisionConstraint")],rt);var at=Ke,nt=at;let st=class extends je["a"]{constructor(){super(...arguments),this.min=et.min,this.max=et.max}set mode(e){Object(Ze["a"])(f["a"].getLogger(this.declaredClass),"esri.views.SceneView.constraints.altitude.mode is deprecated. The altitude constraint no longer applies to local scenes and does not have an automatic mode anymore.",{version:"4.6"})}get mode(){return Object(Ze["a"])(f["a"].getLogger(this.declaredClass),"esri.views.SceneView.constraints.altitude.mode is deprecated. The altitude constraint no longer applies to local scenes and does not have an automatic mode anymore.",{version:"4.6"}),"manual"}};Object(d["a"])([Object(g["b"])({type:Number})],st.prototype,"min",void 0),Object(d["a"])([Object(g["b"])({type:Number})],st.prototype,"max",void 0),st=Object(d["a"])([Object(y["a"])("esri.views.3d.constraints.AltitudeConstraint")],st);var ot=st,ct=ot;let lt=class extends je["a"]{constructor(){super(...arguments),this.mode="auto"}get near(){return this._get("near")}set near(e){this._set("near",e),e>=this._get("far")&&(this.far=e+1e-9),this.mode="manual"}castNear(e){return Math.max(1e-8,e)}get far(){return this._get("far")}set far(e){this._set("far",e),e<=this._get("near")&&(this.near=e-1e-9),this.mode="manual"}castFar(e){return Math.max(1e-8,e)}autoUpdate(e,t){"auto"===this.mode&&(this._get("near")!==e&&this._set("near",e),this._get("far")!==t&&this._set("far",t))}};Object(d["a"])([Object(g["b"])({type:Number,value:1e-8})],lt.prototype,"near",null),Object(d["a"])([Object(v["a"])("near")],lt.prototype,"castNear",null),Object(d["a"])([Object(g["b"])({type:Number,value:1e-8})],lt.prototype,"far",null),Object(d["a"])([Object(v["a"])("far")],lt.prototype,"castFar",null),Object(d["a"])([Object(g["b"])({type:["auto","manual"]})],lt.prototype,"mode",void 0),lt=Object(d["a"])([Object(y["a"])("esri.views.3d.constraints.ClipDistanceConstraint")],lt);var ht=lt,dt=ht;const ut={min:Object(Qe["q"])(tt.min),max:Object(Qe["q"])(tt.max)};let pt=class extends je["a"]{constructor(){super(...arguments),this.mode="auto"}get max(){return this._get("max")}set max(e){this._set("max",e),this.mode="manual"}castMax(e){return Object(Qe["d"])(e,ut.min,ut.max)}autoUpdate(e){"auto"===this.mode&&this._get("max")!==e&&this._set("max",e)}};Object(d["a"])([Object(g["b"])({type:["auto","manual"]})],pt.prototype,"mode",void 0),Object(d["a"])([Object(g["b"])({type:Number,value:ut.max})],pt.prototype,"max",null),Object(d["a"])([Object(v["a"])("max")],pt.prototype,"castMax",null),pt=Object(d["a"])([Object(y["a"])("esri.views.3d.constraints.TiltConstraint")],pt);var ft=pt,mt=ft;let bt=class extends je["a"]{constructor(){super(...arguments),this.tilt=new mt,this.altitude=new ct,this.clipDistance=new dt}};Object(d["a"])([Object(g["b"])({type:mt})],bt.prototype,"tilt",void 0),Object(d["a"])([Object(g["b"])({type:ct})],bt.prototype,"altitude",void 0),Object(d["a"])([Object(g["b"])({type:dt})],bt.prototype,"clipDistance",void 0),bt=Object(d["a"])([Object(y["a"])("esri.views.3d.constraints.Constraints")],bt);var gt,vt=bt,yt=vt;let Ot=gt=class extends je["a"]{set quality(e){-1!==["low","high"].indexOf(e)&&this._set("quality",e)}clone(){return new gt({quality:this.quality})}};Object(d["a"])([Object(g["b"])({type:["low","high"],value:"low"})],Ot.prototype,"quality",null),Ot=gt=Object(d["a"])([Object(y["a"])("esri.views.3d.environment.SceneViewAtmosphere")],Ot);var _t,xt=Ot,jt=xt;let wt=_t=class extends(Ce["a"].EventedMixin($)){constructor(e){super(e),this.positionTimezoneInfo={hours:0,minutes:0,seconds:0,autoUpdated:!0},this.cameraTrackingEnabled=!0,this.ambientOcclusionEnabled=!1,this.waterReflectionEnabled=!1;const t=(new Date).getFullYear(),i=new Date("March 15, "+t+" 12:00:00 UTC");this._set("defaultDate",i),this._set("date",i)}static fromWebsceneLighting(e){return new _t({...e.cloneConstructProperties()})}get defaultDate(){return new Date(this._get("defaultDate").getTime())}set defaultDate(e){const t=this._get("date")===this._get("defaultDate");e=new Date(e.getTime()),this._set("defaultDate",e),t&&this._set("date",e)}set date(e){null!=e&&(this.positionTimezoneInfo.autoUpdated=!1,this._set("date",new Date(e.getTime())))}autoUpdate(e,t){const i=St(this.positionTimezoneInfo);this.positionTimezoneInfo.hours=t.hours,this.positionTimezoneInfo.minutes=t.minutes,this.positionTimezoneInfo.seconds=t.seconds;let r=null;null!=e&&(this.positionTimezoneInfo.autoUpdated=!0,r=this.date&&this.date.getTime(),this._set("date",new Date(e.getTime())));const a=St(this.positionTimezoneInfo);if(i!==a&&(Ct.target=this,Ct.timezoneOffset=a,this.emit("timezone-will-change",Ct)),null!=e)return r!==e.getTime()}clone(){const e=this._get("date")===this._get("defaultDate"),t=new _t({...this.cloneConstructProperties(),defaultDate:this.defaultDate,cameraTrackingEnabled:this.cameraTrackingEnabled,ambientOcclusionEnabled:this.ambientOcclusionEnabled,waterReflectionEnabled:this.waterReflectionEnabled});return e&&t._set("date",t._get("defaultDate")),t.positionTimezoneInfo.autoUpdated=this.positionTimezoneInfo.autoUpdated,t.positionTimezoneInfo.hours=this.positionTimezoneInfo.hours,t.positionTimezoneInfo.minutes=this.positionTimezoneInfo.minutes,t.positionTimezoneInfo.seconds=this.positionTimezoneInfo.seconds,t}cloneWithWebsceneLighting(e){const t=this.clone();return null!=e.date&&(t.date=e.date),t.directShadowsEnabled=e.directShadowsEnabled,t.displayUTCOffset=e.displayUTCOffset,t}};function St({hours:e,minutes:t,seconds:i}){return Math.round(e+t/60+i/3600)}Object(d["a"])([Object(g["b"])({type:Boolean})],wt.prototype,"cameraTrackingEnabled",void 0),Object(d["a"])([Object(g["b"])({type:Boolean})],wt.prototype,"ambientOcclusionEnabled",void 0),Object(d["a"])([Object(g["b"])({type:Boolean})],wt.prototype,"waterReflectionEnabled",void 0),Object(d["a"])([Object(g["b"])({type:Date})],wt.prototype,"defaultDate",null),Object(d["a"])([Object(g["b"])({type:Date})],wt.prototype,"date",null),wt=_t=Object(d["a"])([Object(y["a"])("esri.views.3d.environment.SceneViewLighting")],wt);const Ct={target:null,timezoneOffset:0};var Tt;let Pt=Tt=class extends pe{constructor(e){super(e),this.atmosphere=new jt}static fromWebsceneEnvironment(e){const t=e.cloneConstructProperties();return new Tt({...t,lighting:wt.fromWebsceneLighting(t.lighting)})}castLighting(e){return this.convertLighting(e)}applyLighting(e){this.lighting=this.convertLighting(e)}convertLighting(e){return e?e instanceof wt?e:e instanceof $?this.lighting?this.lighting.cloneWithWebsceneLighting(e):wt.fromWebsceneLighting(e):Object(m["m"])(wt,e):new wt}clone(){return new Tt({lighting:this.lighting.clone(),atmosphere:this.atmosphere.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:Object(B["a"])(this.background)})}cloneWithWebsceneEnvironment(e){return new Tt({atmosphere:this.atmosphere.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:Object(B["a"])(this.background),...e.cloneConstructProperties(),lighting:null!=this.lighting?this.lighting.cloneWithWebsceneLighting(e.lighting):wt.fromWebsceneLighting(e.lighting)})}};Object(d["a"])([Object(g["b"])({type:jt,json:{read:!1}})],Pt.prototype,"atmosphere",void 0),Object(d["a"])([Object(g["b"])()],Pt.prototype,"lighting",void 0),Object(d["a"])([Object(v["a"])("lighting")],Pt.prototype,"castLighting",null),Pt=Tt=Object(d["a"])([Object(y["a"])("esri.views.3d.environment.SceneViewEnvironment")],Pt);var At=Pt,Rt=At,Mt=i("0d9f"),Et=i("d0ac"),Dt=i("7f83"),It=i("e431"),Lt=i("0fc4"),Vt=i("d791"),kt=i("afe1"),Ft=i("2db0"),zt=i("fa1e"),Ut=i("76ac"),Gt=i("c3a4"),Bt=i("ca98"),Ht=i("da35"),Nt=i("8e37"),qt=i("189c");class Wt extends Bt["a"]{initializeProgram(e){const t=Wt.shader.get(),i=this.configuration,r=t.build({geometry:i.geometry});return new Nt["a"](e.rctx,r.generateSource("vertex"),r.generateSource("fragment"),zt["a"])}initializePipeline(){return 1===this.configuration.geometry?Object(qt["e"])({blending:Object(qt["f"])(770,1,771,771),culling:qt["b"],depthTest:{func:515},colorWrite:qt["c"]}):Object(qt["e"])({blending:Object(qt["f"])(770,1,771,771),depthTest:{func:515},colorWrite:qt["c"]})}}Wt.shader=new Gt["a"](Ut["a"],()=>i.e("chunk-2d0d7e66").then(i.bind(null,"797e")));class Zt extends Ht["a"]{constructor(){super(...arguments),this.geometry=0}}Object(d["a"])([Object(Ht["b"])({count:3})],Zt.prototype,"geometry",void 0);var $t="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAIACAYAAABD1gYFAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAA7AAAAOwAFq1okJAAAAB3RJTUUH4QkLDx4bnqU2+QAAAd1JREFUSMd9lkmWxDAIQ/Xluv+V0wuDjaeuhV+IGQUoJUnNwGfAVvx+lsBCWJIsCaMpQn8nuhgqyyEzbAX1Ih0oHaQZN5X5jul581diaDVbSgAdZv1YLoCLyn/RruCsOdcqR7RS/jXkLMa9UddcDn9O7G8gwprzs6xbQl/Fns3BE90r9veQ/wzNrTM5p1yDF1yokLCosDX5kik1lxeSWxfWsihN/lZcHuPIOuhccZ4Ovt74qQK3USkFzsQx7Ki5NgqoMI1J5ILztr9UrGoGHN2qnSEwOHiD97ByDghs/KIVYp9DfdIIoJPcBkWWnM2O2s5ru3su+8GdPLhM5048r/09UDsZmJ3HRwe5MT/aA9Ul4cG74+lIvICYlZcFY42B6vAzuz/HEVn5VbP3DDgQ7xuAGZtnI76cEkbPczDDgSMDR8iFkfBMTQV728mnsx84GopNWZxQsWJxbI9pD0hmNAzWB8bun41hRk+3mNlRFvbY86mcMEVCWWAX+xJbERJHWVPP3Wkq91uyDtuKDLrYNKLl7bww6rZulo3jnafyePJ64ZZi67aEl0MkbJtTbE1h+2vIzVOU3JwWISrNyNtfi+9xqECIXZk87ODcEMeBhjj41GN1Xf+DzP9c9UmPd39C1BID2rDpAwAAAABJRU5ErkJggg==",Qt=$t,Xt=i("2ebb"),Yt=i("fc00"),Kt=i("8e97"),Jt=i("caf7"),ei=i("7ce4"),ti=i("a1ff"),ii=i("8539"),ri=i("0fa6");const ai=f["a"].getLogger("esri.views.3d.environment.PanoramicAtmosphere");class ni{constructor(e){this.slot=14,this._readyResolver=Object(j["h"])(),this._readyController=Object(j["e"])(),this.view=e,this._atmosphereTechniqueConfig=new Zt}get canRender(){return null!=this._texture}destroy(){this._readyResolver.reject(),this._texture=Object(p["f"])(this._texture),this._vao=Object(p["f"])(this._vao),this._readyController=Object(p["a"])(this._readyController)}when(){return this._readyResolver.promise}initializeRenderContext(e){const t=e.renderContext.rctx;this._atmosphereTechniqueConfig.geometry=1,this._atmosphereTechnique=e.shaderTechniqueRep.acquireAndReleaseExisting(Wt,this._atmosphereTechniqueConfig,this._atmosphereTechnique),this._vao=this._createVertexArrayObject(t),this._vaoCount=Object(ii["f"])(this._vao,"geometry"),Object(Ft["a"])(Qt,{signal:this._readyController.signal}).then(i=>{this._texture=new ti["a"](t,{pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},i),e.requestRender(),this._readyController=null,this._readyResolver.resolve()}).catch(e=>{Object(j["n"])(e)||ai.error("Unable to initialize atmosphere: image request failed",e),this._readyResolver.reject()})}uninitializeRenderContext(){this.destroy()}render(e){if(e.slot!==this.slot||0!==e.pass)return!1;const t=e.rctx,i=this._atmosphereTechnique.program;return t.bindProgram(i),this._atmosphereTechnique.bindPipelineState(t),t.bindTexture(this._texture,0),i.setUniform1i("tex",0),Kt["a"].bindProjectionMatrix(i,e.camera.projectionMatrix),si(oi,e.camera.viewMatrix),i.setUniformMatrix4fv("view",oi),i.setUniform4f("color",1,1,1,1),e.scenelightingData.setLightDirectionUniform(i),t.bindVAO(this._vao),i.assertCompatibleVertexAttributeLocations(this._vao),t.drawArrays(4,0,this._vaoCount),!0}_createVertexArrayObject(e){const t=Jt["a"].createPolySphereGeometry(1,2,!1),i=t.indices.get("position");for(let s=0;s<i.length;s+=3){const e=i[s];i[s]=i[s+2],i[s+2]=e}const r=t.vertexAttributes.get("position").data,a=ci.createBuffer(i.length),n=a.position;for(let s=0;s<i.length;++s){const e=3*i[s];n.set(s,0,r[e]),n.set(s,1,r[e+1]),n.set(s,2,r[e+2])}return new ri["a"](e,zt["a"],{geometry:Object(Xt["a"])(ci)},{geometry:ei["a"].createVertex(e,35044,a.buffer)})}}function si(e,t){return Object(Vt["c"])(e,t),e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}const oi=Object(kt["b"])(),ci=Object(Yt["a"])().vec3f("position");var li=ni,hi=i("02f1"),di=i("3349"),ui=i("7577");function pi(e){const t=1e5,i=1e6;return Math.min(1,Math.max(0,(e-t)/(i-t)))}const fi=1e4;var mi=i("c49d");class bi extends Bt["a"]{initializeProgram(e){const t=bi.shader.get(),i=this.configuration,r=t.build({haze:i.haze});return new Nt["a"](e.rctx,r.generateSource("vertex"),r.generateSource("fragment"),zt["a"])}initializePipeline(){return this.configuration.haze?Object(qt["e"])({blending:Object(qt["f"])(1,0,769,1),colorWrite:qt["c"]}):Object(qt["e"])({blending:Object(qt["f"])(770,1,771,771),depthTest:{func:515},colorWrite:qt["c"]})}}bi.shader=new Gt["a"](mi["a"],()=>i.e("chunk-2d0e64e7").then(i.bind(null,"97d7")));class gi extends Ht["a"]{constructor(){super(...arguments),this.haze=!1}}Object(d["a"])([Object(Ht["b"])()],gi.prototype,"haze",void 0);class vi{constructor(e){this._view=e,this.canRender=!0,this._skyslot=14,this._hazeSlot=15,this._renderData={texDepth:Object(hi["b"])(),cameraPosition:Object(M["e"])(),projectionInverse:Object(kt["b"])(),viewInverse:Object(kt["b"])(),heightParameters:Object(Lt["c"])(),atmosphereParameters1:Object(Lt["c"])(),atmosphereParameters2:Object(Lt["c"])(),atmosphereParameters3:Object(M["e"])(),invWavelength:xi,invWavelengthScaled:ji,radii:Object(hi["b"])(),scale:0,scaleDepth:wi,lowerAlphaBlendBound:0,scaleOverScaleDepth:0,oneOverScaleDepth:0,scaleDepthBlue:Si,oneOverScaleDepthBlue:Ti,scaleOverScaleDepthBlue:0,g:Pi,g2:Pi*Pi,miePhaseCoefficients:Ai,nearFar:Object(hi["b"])(),cameraHeight:0,cameraHeightSq:0,C:0,CSur:0,innerFadeDistance:0,altitudeFade:0},this._lowerElevationBoundRadius=0,this._lowerBoundEarthRadius=$e["a"].radius,this._updateRadius($e["a"].radius),this._atmosphereTechniqueConfig=new gi}destroy(){this._handles&&(this._handles.destroy(),this._handles=null),this._vao&&(this._vao.dispose(),this._vao=null)}when(){return Promise.resolve()}initializeRenderContext(e){const t=e.renderContext.rctx;this._handles=new we["a"],this._updateElevation({spatialReference:this._view.basemapTerrain.spatialReference,tile:this._view.basemapTerrain.rootTiles[0],extent:this._view.basemapTerrain.rootTiles[0].extent,context:"ground"}),this._handles.add(Object(L["b"])(this._view,"basemapTerrain","elevation-change",e=>this._updateElevation(e),()=>this._updateElevation())),this._handles.add(Object(L["b"])(this._view,"basemapTerrain","elevation-bounds-change",()=>this._updateVisibleElevationBounds(),()=>this._updateVisibleElevationBounds())),this._atmosphereTechniqueConfig.haze=!1,this._atmosphereTechnique=e.shaderTechniqueRep.acquireAndReleaseExisting(bi,this._atmosphereTechniqueConfig,this._atmosphereTechnique),this._atmosphereTechniqueConfig.haze=!0,this._atmosphereHazeTechnique=e.shaderTechniqueRep.acquireAndReleaseExisting(bi,this._atmosphereTechniqueConfig,this._atmosphereHazeTechnique),this._vao=this._createVertexArrayObject(t)}uninitializeRenderContext(){this.destroy()}render(e){return(e.slot===this._hazeSlot||e.slot===this._skyslot)&&0===e.pass&&(this._update(e.camera),e.slot===this._skyslot&&this._renderSky(e),e.slot===this._hazeSlot&&this._renderHaze(e),!0)}_renderSky(e){const t=e.rctx,i=this._atmosphereTechnique.program;t.bindProgram(i),this._atmosphereTechnique.bindPipelineState(t),i.setUniform3fv("atmosphereParameters3",this._renderData.atmosphereParameters3),this._renderCommon(i,e)}_renderHaze(e){const t=e.rctx,i=e.offscreenRenderingHelper,r=this._atmosphereHazeTechnique.program;t.bindProgram(r),this._atmosphereHazeTechnique.bindPipelineState(t),i.renderDepthDetached(()=>{const a=i.depthTexture;t.bindTexture(a,0),r.setUniform1i("depthTex",0),this._renderCommon(r,e)})}_renderCommon(e,t){const i=t.rctx;e.setUniform3fv("invWavelength",this._renderData.invWavelength),e.setUniform3fv("invWavelengthScaled",this._renderData.invWavelengthScaled),t.scenelightingData.setLightDirectionUniform(e),e.setUniform4fv("heightParameters",this._renderData.heightParameters),e.setUniform3fv("cameraPosition",this._renderData.cameraPosition),e.setUniformMatrix4fv("projectionInverse",this._renderData.projectionInverse),e.setUniformMatrix4fv("viewInverse",this._renderData.viewInverse),e.setUniform2fv("nearFar",this._renderData.nearFar),e.setUniform2fv("radii",this._renderData.radii),e.setUniform4fv("atmosphereParameters1",this._renderData.atmosphereParameters1),e.setUniform4fv("atmosphereParameters2",this._renderData.atmosphereParameters2),e.setUniform1f("innerFadeDistance",this._renderData.innerFadeDistance),e.setUniform1f("altitudeFade",this._renderData.altitudeFade),i.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),i.drawArrays(5,0,4)}_createVertexArrayObject(e){const t=Ri.createBuffer(4);return t.position.setVec(0,[-1,-1]),t.position.setVec(1,[1,-1]),t.position.setVec(2,[-1,1]),t.position.setVec(3,[1,1]),t.uv0.setVec(0,[0,0]),t.uv0.setVec(1,[1,0]),t.uv0.setVec(2,[0,1]),t.uv0.setVec(3,[1,1]),new ri["a"](e,zt["a"],{geometry:Object(Xt["a"])(Ri)},{geometry:ei["a"].createVertex(e,35044,t.buffer)})}_adjustRadiusForTesselation(e){const t=16,i=4,r=Math.PI/2**i/t;return e*Math.cos(r)}_updateElevation(e){const t=e?e.tile:this._view.basemapTerrain.rootTiles[0];if(0!==t.lij[0])return;const i=this._adjustRadiusForTesselation($e["a"].radius+t.elevationBounds[0]);i!==this._lowerElevationBoundRadius&&(this._lowerElevationBoundRadius=i,this._lowerBoundEarthRadius=-1,this._updateVisibleElevationBounds())}_updateVisibleElevationBounds(){const e=this._adjustRadiusForTesselation($e["a"].radius+this._view.basemapTerrain.elevationBounds.min);(this._lowerBoundEarthRadius<0||e<this._lowerBoundEarthRadius)&&this._updateRadius(e)}_updateRadius(e){this._lowerBoundEarthRadius=e;const t=e,i=t/10*10.25,r=1/(i-t),a=r/wi,n=r/Si,s=.3*(i-t)+t,o=this._renderData;Object(ui["l"])(o.atmosphereParameters1,r,wi,a,Ci),Object(ui["l"])(o.atmosphereParameters2,Pi,Si,n,Ti),Object(It["x"])(o.atmosphereParameters3,Pi*Pi,Ai,s),Object(di["s"])(o.radii,t,i),o.scale=r,o.lowerAlphaBlendBound=s,o.scaleOverScaleDepth=a,o.scaleOverScaleDepthBlue=n;const c=fi;o.innerFadeDistance=2*Math.sqrt((2*t-c)*c)}_update(e){e&&(this._renderData.cameraHeight=Object(It["q"])(e.eye),this._renderData.cameraHeightSq=this._renderData.cameraHeight*this._renderData.cameraHeight,this._renderData.C=this._renderData.cameraHeightSq-this._renderData.radii[1]*this._renderData.radii[1],this._renderData.CSur=this._renderData.cameraHeightSq-this._renderData.radii[0]*this._renderData.radii[0],this._renderData.heightParameters=Object(Lt["d"])(this._renderData.cameraHeight,this._renderData.cameraHeightSq,this._renderData.C,this._renderData.CSur),Object(It["l"])(this._renderData.cameraPosition,e.eye),Object(Vt["a"])(this._renderData.projectionInverse,e.projectionMatrix),Object(Vt["a"])(this._renderData.viewInverse,e.viewMatrix),Object(di["s"])(this._renderData.nearFar,e.near,e.far),this._renderData.altitudeFade=pi(this._renderData.cameraHeight-this._lowerBoundEarthRadius))}static isSupported(e){return e.renderContext.rctx.capabilities.depthTexture}}const yi=.001,Oi=.02*Math.PI,_i=4*yi*Math.PI,xi=Object(M["g"])(1/.65**4,1/.57**4,1/.475**4),ji=Object(M["d"])(xi);Object(It["f"])(ji,ji,Oi),Object(It["g"])(ji,ji,Object(M["g"])(_i,_i,_i));const wi=.25,Si=.05,Ci=1/wi,Ti=1/Si,Pi=-.99999,Ai=(1-Pi*Pi)/(2+Pi*Pi)*1.5,Ri=Object(Yt["a"])().vec2f("position").vec2f("uv0");var Mi=i("1153"),Ei="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAIACAYAAAE00TaTAAAACXBIWXMAAA7AAAAOwAFq1okJAAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAAp1JREFUSMd9lcmSEzEQRCtflnqxYZgIThBDAP//kXDQ0pJtuDhqycxWZ5fKERFCERARIAVEyCjCtSFFEjWVa9q7OdJE0oiidIhKhRBROlhloiGVhaYERQHJWFEwMpYKrjUlibI2cqSJIJEpKNmM2c3GkRTOJDnThTMpnMWu0VFszs3Jfbe5bza3w+a229yOIs6zmP3czfn1K2w/for8+EVU15pNmmyqkeJyclinXNJRu1xrUaJmjmdzJiejVNt7zZVBRAIq1RwrsrrWnez+SR7WmQQP/1itKz2q/pmzuJtYnNy2bth9x9z2NLfDcB7FHOcGx6ebOb9/iPzxG/ztg4iorglFiKjzF9HSNphCoRb1OY3RZQJrYgRdT68bmgXGDdBzrTG8qNS7QP/m19ef7tGlcoH7vESYkK70uoPuOLEetz0IqeGoWQW6MlB/j36EnipYGKPWwDRg/RkNhXCNJIzAhMk6PrDePJNII6JHqM5VWqYApCtNFPe0GFFGtOWopWCrEVBSoiQi06KkRRaD08IlxXa/ifz8Jvz2LvjyLnh7F/r8Rei8a8xfjNkIrpmMOQ1C02COrkTEHxGhh+6DQJfXc/eZprXxcIyVIf1LJVgWvKaHvwI/1aQxtv851SQ/nqGXL6MHFVY3nmhLyqKsWO/+qzWif+yS1TpNKq8NezjGPCV69ciZoQj1PwfN6QRpWyCGVMe1D/AAHt3/gefu1Ign3AVpjOiNXkN90JlpL6TUnzFEUU+Jvks0tkp/dY3Fy1TzI24BWwsYJPyg11Q0FqDwK72xIz2kLojbeuxS1FpgtfNWyMX1gFw0j3W7RNeSHTVEe3VaV7SdCzVywFaEt02w7QH7Eeg4AvZDNdJ+Cu1HENsutO+Byi6ilEBZ9BeCNBJceJIjHgAAAABJRU5ErkJggg==",Di=Ei,Ii=i("d5f7");const Li=f["a"].getLogger("esri.views.3d.environment.SimpleAtmosphere"),Vi=128,ki=-fi,Fi=0,zi=50,Ui=()=>1-511/512,Gi=Object(Xe["i"])([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]);class Bi{constructor(e){this.slot=14,this._renderData={texV:Object(hi["b"])(),silCircleCenter:Object(M["e"])(),silCircleV1:Object(M["e"])(),silCircleV2:Object(M["e"])(),altitudeFade:0,innerScale:0,undergroundFadeAlpha:0},this._fadeVaoCount=0,this._readyResolver=Object(j["h"])(),this._readyController=Object(j["e"])(),this.texV1=1,this.isOnMars=Object(Dt["h"])(e.spatialReference);const t=Object(V["e"])(e.spatialReference);this.planetRadius=t.radius,this.outerRimWidth=t.outerAtmosphereRimWidth,this.innerRimFactor=(this.planetRadius+ki)/this.planetRadius,this.middleRimFactor=(this.planetRadius+Fi)/this.planetRadius,this.outerRimFactor=(this.planetRadius+this.outerRimWidth)/this.planetRadius,this.texV0=Fi/this.outerRimWidth,this.texVScale=this.texV1-this.texV0,this._atmosphereTechniqueConfig=new Zt,this.view=e}get canRender(){return null!=this._texture}when(){return this._readyResolver.promise}initializeRenderContext(e){const t=e.renderContext.rctx;this._cameraChangeHandle=Object(L["a"])(this.view,"state.camera",()=>e.requestRender(),!0),this._atmosphereTechniqueConfig.geometry=0,this._atmosphereConeTechnique=e.shaderTechniqueRep.acquireAndReleaseExisting(Wt,this._atmosphereTechniqueConfig,this._atmosphereConeTechnique),this._atmosphereTechniqueConfig.geometry=2,this._atmosphereUndergroundTechnique=e.shaderTechniqueRep.acquireAndReleaseExisting(Wt,this._atmosphereTechniqueConfig,this._atmosphereUndergroundTechnique),this._vao=this._createRibbon(t),this._vaoCount=Object(ii["f"])(this._vao,"geometry"),this._fadeVao=Object(Ii["d"])(t),this._fadeVaoCount=Object(ii["f"])(this._fadeVao,"geometry"),Object(Ft["a"])(this.isOnMars?Di:Qt,{signal:this._readyController.signal}).then(i=>{this._texture=new ti["a"](t,{pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},i),e.requestRender(),this._readyController=null,this._readyResolver.resolve()}).catch(e=>{Object(j["n"])(e)||Li.error("Unable to initialize simple atmosphere: image request failed",e),this._readyResolver.reject()})}uninitializeRenderContext(){this.destroy()}destroy(){this._readyResolver.reject(),this._cameraChangeHandle&&(this._cameraChangeHandle.remove(),this._cameraChangeHandle=null),this._texture&&(this._texture.dispose(),this._texture=null),this._fadeVao&&(this._fadeVao.dispose(),this._fadeVao=null),this._vao&&(this._vao.dispose(),this._vao=null),this._readyController&&(this._readyController.abort(),this._readyController=null)}render(e){if(e.slot!==this.slot||0!==e.pass)return!1;this._update(e.camera);const t=e.rctx;if(this._atmosphereConeTechnique.bindPipelineState(t),this._renderData.undergroundFadeAlpha<1){const i=this._atmosphereConeTechnique.program;t.bindProgram(i),i.setUniformMatrix4fv("proj",e.camera.projectionMatrix),i.setUniformMatrix4fv("view",e.camera.viewMatrix),i.setUniform3fv("silCircleCenter",this._renderData.silCircleCenter),i.setUniform3fv("silCircleV1",this._renderData.silCircleV1),i.setUniform3fv("silCircleV2",this._renderData.silCircleV2),i.setUniform2fv("texV",this._renderData.texV),t.bindTexture(this._texture,0),i.setUniform1i("tex",0),e.scenelightingData.setLightDirectionUniform(i),i.setUniform1f("altitudeFade",this._renderData.altitudeFade),i.setUniform1f("innerScale",this._renderData.innerScale),t.bindVAO(this._vao),t.drawArrays(4,0,this._vaoCount)}if(this._renderData.undergroundFadeAlpha>0){const i=this._atmosphereUndergroundTechnique.program;t.bindProgram(i),i.setUniform1f("undergroundFadeAlpha",this._renderData.undergroundFadeAlpha),e.scenelightingData.setLightDirectionUniform(i),i.setUniform3fv("cameraPosition",e.camera.eye),t.bindVAO(this._fadeVao),t.drawArrays(5,0,this._fadeVaoCount)}return!0}_update(e){const t=Object(M["e"])(),i=this.planetRadius,r=Object(It["q"])(e.eye),a=r-i;if(a<0){const e=Math.min(-a/5e3,1);this._renderData.undergroundFadeAlpha=e}else this._renderData.undergroundFadeAlpha=0;const n=Math.max(zi,a),s=i+ki;this._renderData.innerScale=Zi(i+n,i,s)-1,this._renderData.altitudeFade=pi(a),Object(It["f"])(t,e.eye,(i+zi)/r),Hi(t,e.center,e.up,i,this._renderData);const o=this._computeScreenRimWidth(e,t,e.up,this._renderData),c=Ui(),l=Gi(a);let h=this.texV0+c*this.texVScale,d=this.texV0+o*l*this.texVScale;if(a>zi){Hi(e.eye,e.center,e.up,i,this._renderData);const t=this._computeScreenRimWidth(e,e.eye,e.up,this._renderData),r=Object(Qe["d"])((t-1.5)/(o-1.5),0,1);h=this.texV0+r*c*this.texVScale,d=this.texV0+Object(Qe["l"])(this.texV1,o*l,r)*this.texVScale}Object(di["s"])(this._renderData.texV,h,d)}_createRibbon(e){const t=new Float32Array(3+3*Vi*3),i=new Uint32Array(3*Vi*5);t[0]=0,t[1]=0,t[2]=-1;for(let n=0;n<Vi;n++){const e=9*n+3;t[e+0]=n,t[e+1]=this.innerRimFactor,t[e+2]=-1,t[e+3]=n,t[e+4]=this.middleRimFactor,t[e+5]=0,t[e+6]=n,t[e+7]=this.outerRimFactor,t[e+8]=1;const r=3*n+1,a=n===Vi-1?1:r+3,s=15*n;i[s+0]=r,i[s+1]=r+1,i[s+2]=a+1,i[s+3]=a+1,i[s+4]=a,i[s+5]=r,i[s+6]=r+1,i[s+7]=r+2,i[s+8]=a+2,i[s+9]=a+2,i[s+10]=a+1,i[s+11]=r+1,i[s+12]=r,i[s+13]=a,i[s+14]=0}const r=$i.createBuffer(i.length),a=r.position;for(let n=0;n<i.length;++n){const e=3*i[n];a.set(n,0,t[e]),a.set(n,1,t[e+1]),a.set(n,2,t[e+2])}return new ri["a"](e,zt["a"],{geometry:Object(Xt["a"])($i)},{geometry:ei["a"].createVertex(e,35044,r.buffer)})}_computeScreenRimWidth(e,t,i,r){return Object(It["g"])(qi,r.silCircleCenter,r.silCircleV2),Object(It["f"])(Wi,qi,this.outerRimFactor),Object(Vt["l"])(Ni,t,qi,i),Object(Mi["j"])(qi,Ni,e.projectionMatrix,e.viewport),Object(Mi["j"])(Wi,Ni,e.projectionMatrix,e.viewport),Object(It["p"])(qi,Wi)/e.height}}function Hi(e,t,i,r,a){const n=Object(It["q"])(e),s=r*Math.sqrt(n*n-r*r)/n,o=Math.sqrt(r*r-s*s),c=a.silCircleV1,l=a.silCircleV2;return Object(It["f"])(a.silCircleCenter,e,o/n),Object(It["h"])(c,e,t),Object(It["t"])(c)<1&&Object(It["h"])(c,e,i),Object(It["f"])(c,c,s/Object(It["q"])(c)),Object(It["h"])(l,c,e),Object(It["f"])(l,l,s/Object(It["q"])(l)),s}const Ni=Object(kt["b"])(),qi=Object(M["e"])(),Wi=Object(M["e"])();function Zi(e,t,i){return e*e/(Math.sqrt(e*e-t*t)*Math.sqrt(e*e-i*i)+t*i)}const $i=Object(Yt["a"])().vec3f("position");var Qi=Bi,Xi=i("b2cd"),Yi=i("d347"),Ki=i("3111");class Ji extends Bt["a"]{initializeProgram(e){const t=Ji.shader.get().build();return new Nt["a"](e.rctx,t.generateSource("vertex"),t.generateSource("fragment"),zt["a"])}initializePipeline(){return Object(qt["e"])({blending:Object(qt["f"])(770,1,771,771),depthTest:{func:515},colorWrite:qt["c"]})}bindPass(e,{camera:t,modelMatrix:i}){const r=this.makeInfiniteProjectionMatrix(t.projectionMatrix,t.near,er);Object(Vt["m"])(r,r,t.viewMatrix),Object(Vt["m"])(r,r,i),this.program.setUniformMatrix4fv("transform",r),this.program.setUniform4fv("viewport",t.fullViewport),this.program.setUniform1f("pixelRatio",t.pixelRatio)}makeInfiniteProjectionMatrix(e,t,i){const r=24e-8;return Object(Vt["c"])(i,e),i[10]=r-1,i[11]=-1,i[14]=(r-2)*t,i}}Ji.shader=new Gt["a"](Ki["a"],()=>i.e("chunk-2d229d83").then(i.bind(null,"ded0")));const er=Object(kt["b"])(),tr=f["a"].getLogger("esri.views.3d.environment.Stars");let ir=class extends je["a"]{constructor(e){super(e),this.slot=14,this._loadDataTask=null,this._resources=null,this._modelMatrix=Object(kt["b"])(),this._updatingTracking=new Yi["a"],this._requestRender=()=>{}}get updating(){return this._updatingTracking.updating||this.loading}get loading(){return Object(p["k"])(this._loadDataTask)&&!this._loadDataTask.finished}get canRender(){return!this.loading}initialize(){this._loadDataTask=this._createLoadDataTask()}destroy(){Object(p["k"])(this._loadDataTask)&&(this._loadDataTask.abort(),this._loadDataTask=null),this._updatingTracking.destroy(),Object(p["k"])(this._resources)&&(this._resources.vao.dispose(),this._resources.technique.dispose(),this._resources=null),this._requestRender=null}initializeRenderContext(e){this._requestRender=e.requestRender}uninitializeRenderContext(){this.destroy()}render(e){if(e.slot!==this.slot||0!==e.pass)return!1;if(this._ensureResources(e),Object(p["j"])(this._resources))return!0;const{technique:t,vao:i,num:r}=this._resources,a=e.rctx,n=t.program;return a.bindProgram(n),t.bindPass(a,{camera:e.camera,modelMatrix:this._modelMatrix}),t.bindPipelineState(a),a.bindVAO(i),n.assertCompatibleVertexAttributeLocations(i),a.drawArrays(0,0,r),!0}_ensureResources(e){if(Object(p["k"])(this._resources)||Object(p["j"])(cr))return;const t=e.rctx,i=new Ji({rctx:t,viewingMode:this.view.state.mode},null),r=cr.byteLength/sr,a=new Float32Array(cr,0,2*r),n=new Uint8Array(cr,2*r*4,r),s=this._createVertexArrayObject(e.rctx,a,n,r);this._resources={vao:s,technique:i,num:r},this._updatingTracking.add(this.view,"environment.lighting.date",e=>this._update(e),2)}_computeDayDuration(e){const t=e,i=new Date(e.getFullYear(),0,1,11,58,56);return(+t-+i)/(+new Date(e.getFullYear()+1,0,1,11,58,55)-+i)}_update(e){if(!e)return;const t=(e.getHours()/12+e.getMinutes()/60*(2/24)+e.getSeconds()/60*(2/1440)-.9972222)%2,i=2*this._computeDayDuration(e),r=this._modelMatrix;Object(Vt["c"])(r,nr),Object(Vt["g"])(r,r,-i*Math.PI),Object(Vt["m"])(r,ar,r),Object(Vt["g"])(r,r,-t*Math.PI),this._requestRender()}_hexToRGB(e){return[parseInt(e.substring(0,2),16),parseInt(e.substring(2,4),16),parseInt(e.substring(4,6),16)]}_unpackUint8Attributes(e){return e>=192?[2.9,e-192]:e>=160?[2.5,e-160]:e>=128?[2,e-128]:e>=96?[1.5,e-96]:e>=64?[1,e-64]:e>=32?[.7,e-32]:[.4,e]}_createVertexArrayObject(e,t,i,r){const a=or.createBuffer(r),n=a.position,s=a.color,o=a.size;for(let c=0;c<r;c++){const e=t[2*c+0],r=t[2*c+1];n.set(c,0,-Math.cos(e)*Math.sin(r)),n.set(c,1,-Math.sin(e)*Math.sin(r)),n.set(c,2,-Math.cos(r));const a=this._unpackUint8Attributes(i[c]),l=this._hexToRGB(rr[a[1]]);s.set(c,0,255*l[0]),s.set(c,1,255*l[1]),s.set(c,2,255*l[2]),s.set(c,3,255),o.set(c,a[0])}return new ri["a"](e,zt["a"],{geometry:Object(Xt["a"])(or)},{geometry:ei["a"].createVertex(e,35044,a.buffer)})}_createLoadDataTask(){if(Object(p["k"])(cr))return null;const e=Object(j["i"])(async e=>{const{data:t}=await Object(Xi["a"])("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:e});this._verifyStarData(t),cr=t});return e.promise.catch(e=>{Object(j["n"])(e)||tr.error(e)}).then(()=>{this.destroyed||(this._requestRender(),this.notifyChange("updating"))}),e}_verifyStarData(e){if(!e)throw new O["a"]("stars:no-data-received","Failed to create stars because star catalogue is missing");const t=e.byteLength/sr;if(t%1!=0||t>5e4||t<5e3)throw new O["a"]("stars:invalid-data","Failed to create stars because star catalogue data is invalid")}};Object(d["a"])([Object(g["b"])({constructOnly:!0})],ir.prototype,"view",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],ir.prototype,"updating",null),Object(d["a"])([Object(g["b"])()],ir.prototype,"_loadDataTask",void 0),Object(d["a"])([Object(g["b"])()],ir.prototype,"_updatingTracking",void 0),ir=Object(d["a"])([Object(y["a"])("esri.views.3d.environment.Stars")],ir);const rr=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],ar=Object(kt["e"])(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),nr=Object(kt["e"])(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),sr=9,or=Object(Yt["a"])().vec3f("position").vec4u8("color").f32("size");let cr=null;const lr=[14,15];let hr=class extends je["a"]{constructor(){super(...arguments),this._handles=new we["a"],this._context=null,this._pendingAtmosphere=null,this._atmosphere=null,this._stars=null}get canRender(){return!(!this.view.basemapTerrain||!this.view.basemapTerrain.renderer.canRender)||"global"!==this.view.viewingMode}get updating(){return Object(p["k"])(this._pendingAtmosphere)||Object(p["k"])(this._stars)&&this._stars.updating}initialize(){this.view._stage.addRenderPlugin(lr,this)}destroy(){this._pendingAtmosphere=Object(p["e"])(this._pendingAtmosphere),this._atmosphere=Object(p["e"])(this._atmosphere),this._stars=Object(p["e"])(this._stars),this._handles=Object(p["e"])(this._handles),this.view&&(this.view._stage.removeRenderPlugin(this),this._set("view",null))}initializeRenderContext(e){this._context=e,this.setup()}setup(){this._handles.add(Object(L["f"])(this.view,"basemapTerrain",()=>this._updateBasemapTerrain(),!0)),this._handles.add([Object(L["a"])(this.view,["viewingMode","environment.atmosphereEnabled","environment.atmosphere.quality"],()=>this._updateAtmosphere(),!0),Object(L["a"])(this.view,"environment.starsEnabled",()=>this._updateStars(),!0)])}uninitializeRenderContext(){Object(p["k"])(this._stars)&&(this._stars.uninitializeRenderContext(),this._stars.destroy(),this._stars=null),Object(p["k"])(this._atmosphere)&&(this._atmosphere.uninitializeRenderContext(),this._atmosphere.destroy(),this._atmosphere=null)}render(e){let t=!0;return Object(p["k"])(this._stars)&&this._stars.canRender&&(t=this._stars.render(e)&&t),Object(p["k"])(this._atmosphere)&&this._atmosphere.canRender&&(t=this._atmosphere.render(e)&&t),t}_setNeedsRender(){this._context&&this._context.requestRender()}_updateStars(){var e,t,i;const r=null!=(e=null==(t=this.view)||null==(i=t.environment)?void 0:i.starsEnabled)&&e;r&&Object(p["j"])(this._stars)?(this._stars=new ir({view:this.view}),this._stars.initializeRenderContext(this._context),this._setNeedsRender()):!r&&Object(p["k"])(this._stars)&&(this._stars.destroy(),this._stars=null,this._setNeedsRender())}_updateAtmosphere(){const e=this._getAtmosphereType();if(this.atmosphereType===e)return;this.atmosphereType=e,Object(p["k"])(this._pendingAtmosphere)&&(this._pendingAtmosphere!==this._atmosphere&&this._pendingAtmosphere.destroy(),this._pendingAtmosphere=null);const t=this._getAtmosphereClass();if(!t)return Object(p["k"])(this._atmosphere)&&(this._atmosphere.destroy(),this._atmosphere=null,this._setNeedsRender()),void this._updateBasemapTerrain();const i=new t(this.view);i.initializeRenderContext(this._context),Object(p["j"])(this._atmosphere)&&(this._atmosphere=i,this._setNeedsRender()),this._pendingAtmosphere=i,i.when().then(()=>{Object(p["k"])(this._atmosphere)&&this._pendingAtmosphere!==this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=this._pendingAtmosphere),this._pendingAtmosphere=null,this._setNeedsRender(),this._updateBasemapTerrain()}).catch(()=>{this._pendingAtmosphere===i&&(this._pendingAtmosphere=null)})}_getAtmosphereClass(){const e=this._getAtmosphereType();if(this.atmosphereClassFromType)return this.atmosphereClassFromType(e);switch(e){case"none":return null;case"realistic":return vi;case"panoramic":return li;case"simple":return Qi;default:return}}_getAtmosphereType(){const e=this.view.get("environment.atmosphereEnabled"),t=this.view.get("environment.atmosphere.quality"),i=this.view.viewingMode;return!e||null==t||Object(Dt["i"])(this.view.spatialReference)?"none":"local"===i?"panoramic":"high"===t&&vi.isSupported(this._context)&&!Object(Dt["h"])(this.view.spatialReference)?"realistic":"simple"}_updateBasemapTerrain(){const e=this.view.basemapTerrain;e&&(e.velvetOverground=null!=this._atmosphere&&"simple"===this.atmosphereType)}get test(){return{atmosphere:this._atmosphere}}};Object(d["a"])([Object(g["b"])({constructOnly:!0})],hr.prototype,"view",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],hr.prototype,"atmosphereClassFromType",void 0),Object(d["a"])([Object(g["b"])()],hr.prototype,"updating",null),Object(d["a"])([Object(g["b"])()],hr.prototype,"_pendingAtmosphere",void 0),Object(d["a"])([Object(g["b"])()],hr.prototype,"_stars",void 0),hr=Object(d["a"])([Object(y["a"])("esri.views.3d.environment.EnvironmentRenderer")],hr);var dr=hr,ur=dr;function pr(e,t,i){return fr(e,t.longitude,t.latitude,i.longitude,i.latitude)}function fr(e,t,i,r,a){const n=Object(Qe["f"])(i),s=Object(Qe["f"])(a),o=n-s,c=Object(Qe["f"])(t)-Object(Qe["f"])(r),l=Math.sin(o/2),h=Math.sin(c/2),d=2*Object(Qe["c"])(Math.sqrt(l*l+Math.cos(n)*Math.cos(s)*h*h))*e;return Math.round(1e4*d)/1e4}function mr(e,t,i){const r=t.spatialReference,a=Object(V["e"])(r),n=new C["a"](t.x,e.y,r),s=new C["a"](i.x,e.y,r),o=new C["a"](e.x,t.y,r),c=new C["a"](e.x,i.y,r);return{lon:pr(a.radius,n,s),lat:pr(a.radius,o,c)}}function br(e,t,i){const r=t/i,a=Object(Qe["f"])(e),n=Math.sin(r/2),s=Math.cos(a),o=2*Object(Qe["c"])(Math.sqrt(n*n/(s*s)));return Object(Qe["q"])(o)}function gr(e,t){let i=e/15;return t||(i=Math.round(i)),i}function vr(e,t){t||(t={hours:0,minutes:0,seconds:0}),t.hours=gr(e[0],!0);const i=t.hours%1;t.hours-=i,t.minutes=60*i;const r=t.minutes%1;return t.minutes-=r,t.seconds=Math.round(60*r),t}var yr=i("5f6c"),Or=Object(yr["b"])((function(e){var t;void 0!==(t=function(){var e=Math.PI,t=Math.sin,i=Math.cos,r=Math.tan,a=Math.asin,n=Math.atan2,s=Math.acos,o=e/180,c=864e5,l=2440588,h=2451545,d={dec:0,ra:0};function u(e){return e.valueOf()/c-.5+l}function p(e){return new Date((e+.5-l)*c)}function f(e){return u(e)-h}var m=23.4397*o;function b(e,a){return n(t(e)*i(m)-r(a)*t(m),i(e))}function g(e,r){return a(t(r)*i(m)+i(r)*t(m)*t(e))}function v(e,a,s){return n(t(e),i(e)*t(a)-r(s)*i(a))}function y(e,r,n){return a(t(r)*t(n)+i(r)*i(n)*i(e))}function O(e,t){return o*(280.16+360.9856235*e)-t}function _(e){return o*(357.5291+.98560028*e)}function x(e){return o*(1.9148*t(e)+.02*t(2*e)+3e-4*t(3*e))}function j(t,i){return t+i+102.9372*o+e}function w(e,t){var i=_(e),r=j(i,x(i));return t||(t={dec:0,ra:0}),t.dec=g(r,0),t.ra=b(r,0),t}var S={POLAR_EXCEPTION:{NORMAL:0,MIDNIGHT_SUN:1,POLAR_NIGHT:2},getPosition:function(e,t,i,r){var a=o*-i,n=o*t,s=f(e),c=w(s,d),l=O(s,a)-c.ra;return r||(r={azimuth:0,altitude:0}),r.azimuth=v(l,n,c.dec),r.altitude=y(l,n,c.dec),r}},C=[[-.83,"sunrise","sunset"]];S.addTime=function(e,t,i){C.push([e,t,i])};var T=9e-4;function P(t,i){return Math.round(t-T-i/(2*e))}function A(t,i,r){return T+(t+i)/(2*e)+r}function R(e,i,r){return h+e+.0053*t(i)-.0069*t(2*r)}function M(e,r,a){return s((t(e)-t(r)*t(a))/(i(r)*i(a)))}function E(e){var r=o*(134.963+13.064993*e),a=o*(93.272+13.22935*e),n=o*(218.316+13.176396*e)+6.289*o*t(r),s=5.128*o*t(a),c=385001-20905*i(r);return{ra:b(n,s),dec:g(n,s),dist:c}}return S.getTimes=function(e,r,a){var n=o*-a,s=o*r,c=P(f(e),n),l=A(0,n,c),h=_(l),d=x(h),u=j(h,d),m=g(u,0),b=R(l,h,u);function v(e){return R(A(M(e,s,m),n,c),h,u)}function y(e){var r=(t(e)-t(s)*t(m))/(i(s)*i(m));return r<-1?S.POLAR_EXCEPTION.MIDNIGHT_SUN:r>1?S.POLAR_EXCEPTION.POLAR_NIGHT:S.POLAR_EXCEPTION.NORMAL}var O,w,T,E,D,I={solarNoon:p(b),nadir:p(b-.5),polarException:S.POLAR_EXCEPTION.NORMAL};for(O=0,w=C.length;O<w;O+=1)D=b-((E=v((T=C[O])[0]*o))-b),I[T[1]]=p(D),I[T[2]]=p(E);return I.polarException=y(C[0][0]*o),I},S.getMoonPosition=function(e,t,i){var a=o*-i,n=o*t,s=f(e),c=E(s),l=O(s,a)-c.ra,h=y(l,n,c.dec);return h+=.017*o/r(h+10.26*o/(h+5.1*o)),{azimuth:v(l,n,c.dec),altitude:h,distance:c.dist}},S.getMoonFraction=function(e){var r=f(e),a=w(r),o=E(r),c=149598e3,l=s(t(a.dec)*t(o.dec)+i(a.dec)*i(o.dec)*i(a.ra-o.ra)),h=n(c*t(l),o.dist-c*i(l));return(1+i(h))/2},S}())&&(e.exports=t)}));const _r={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,diffuseAtNoon:.65,diffuseAtTwilight:.7},global:{altitude:8e5,ambient:.015,diffuse:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}};function xr(e,t){const i=t[2],r=Tr;Object(It["x"])(r.ambient.color,1,1,1),r.ambient.intensity=_r.global.ambient,Object(It["x"])(r.diffuse.color,1,1,1),r.diffuse.intensity=_r.global.diffuse;let a=(Math.abs(i)-_r.local.altitude)/(_r.global.altitude-_r.local.altitude);a=Object(Qe["d"])(a,0,1),r.globalFactor=a;const n=Or.getTimes(e,t[1],t[0]);if(a<1){const t=Ar(e,n);Object(It["j"])(r.ambient.color,t.ambient.color,r.ambient.color,a),r.ambient.intensity=Object(Qe["l"])(t.ambient.intensity,r.ambient.intensity,a),Object(It["j"])(r.diffuse.color,t.diffuse.color,r.diffuse.color,a),r.diffuse.intensity=Object(Qe["l"])(t.diffuse.intensity,r.diffuse.intensity,a)}return r.noonFactor=Pr(e,n),r}function jr(e,t,i,r){r||(r=Object(M["e"])());const a=Cr,n=Object(Vt["i"])(Sr);if("global"===i)Or.getPosition(e,0,0,a),Object(It["x"])(r,0,0,-1),Object(Vt["e"])(n,n,-a.azimuth),Object(Vt["f"])(n,n,-a.altitude),Object(It["n"])(r,r,n);else{const i=_r.planarDirection,s=i.globalAngles,o=t[2];let c=(Math.abs(o)-i.localAltitude)/(i.globalAltitude-i.localAltitude);c=Object(Qe["d"])(c,0,1),c<1?(Or.getPosition(e,t[1],t[0],a),a.azimuth=(1-c)*a.azimuth+c*s.azimuth,a.altitude=(1-c)*a.altitude+c*s.altitude):(a.azimuth=s.azimuth,a.altitude=s.altitude),Object(It["x"])(r,0,-1,0),Object(Vt["g"])(n,n,-a.azimuth),Object(Vt["e"])(n,n,-a.altitude),Object(It["n"])(r,r,n)}return r}function wr(e,t){if("global"===t)return!0;{const t=_r.planarDirection,i=e[2];return Math.abs(i)<t.localAltitude}}const Sr=Object(kt["b"])(),Cr={azimuth:0,altitude:0},Tr={ambient:{color:Object(M["e"])(),intensity:0},diffuse:{color:Object(M["e"])(),intensity:0,direction:Object(M["e"])()},globalFactor:0,noonFactor:0};function Pr(e,t){const i=e.valueOf();let r,a;t.polarException===Or.POLAR_EXCEPTION.MIDNIGHT_SUN?(r=i-60*(e.getHours()+48)*60*1e3-60*e.getMinutes()*1e3,a=r+432e6):t.polarException===Or.POLAR_EXCEPTION.POLAR_NIGHT?(r=i-2,a=i-1):(r=t.sunrise.valueOf(),a=t.sunset.valueOf());const n=r+(a-r)/2;return 1-Object(Qe["d"])(Math.abs(i-n)/432e5,0,1)}function Ar(e,t){const i=e.valueOf();let r,a;t.polarException===Or.POLAR_EXCEPTION.MIDNIGHT_SUN?(r=i-60*(e.getHours()+48)*60*1e3-60*e.getMinutes()*1e3,a=r+432e6):t.polarException===Or.POLAR_EXCEPTION.POLAR_NIGHT?(r=i-2,a=i-1):(r=t.sunrise.valueOf(),a=t.sunset.valueOf());const n=a-r,s=r+n/2,o=n/4,c=s-o,l=s+o,h=.06*n,d=r-h/2,u=r+h/2,p=a-h/2,f=a+h/2,m=_r.local,b=[.01,m.ambientAtNight],g=[.8,.8,1],v=[.01,.01,.01],y=[m.diffuseAtTwilight,m.ambientAtTwilight],O=[1,.75,.75],_=[.8,.8,1],x=[.9*m.diffuseAtNoon,m.ambientAtNoon],j=[1,.98,.98],w=[.98,.98,1],S=[m.diffuseAtNoon,m.ambientAtNoon],C=[1,1,1],T=[1,1,1],P=x,A=j,R=w,E=y,D=O,I=_;let L,V,k=[0,0],F=[0,0,0],z=[0,0,0];return i<d||i>f?(k=b,F=v,z=g,V="night"):i<u?(L=u-d,k=Rr(i-d,L,b,y),F=Rr(i-d,L,v,O),z=Rr(i-d,L,g,_),V="sun rising"):i<c?(L=c-u,k=Rr(i-u,L,y,x),F=Rr(i-u,L,O,j),z=Rr(i-u,L,_,w),V="early morning"):i<s?(L=s-c,k=Rr(i-c,L,x,S),F=Rr(i-c,L,j,C),z=Rr(i-c,L,w,T),V="late morning"):i<l?(L=l-s,k=Rr(i-s,L,S,P),F=Rr(i-s,L,C,A),z=Rr(i-s,L,T,R),V="early afternoon"):i<p?(L=p-l,k=Rr(i-l,L,P,E),F=Rr(i-l,L,A,D),z=Rr(i-l,L,R,I),V="late afternoon"):i<f&&(L=f-p,k=Rr(i-p,L,E,b),F=Rr(i-p,L,D,v),z=Rr(i-p,L,I,g),V="sun setting"),{diffuse:{intensity:k[0],color:Object(M["g"])(F[0],F[1],F[2])},ambient:{intensity:k[1],color:Object(M["g"])(z[0],z[1],z[2])},timeOfDay:V}}function Rr(e,t,i,r){const a=[];for(let n=0;n<i.length;n++)a[n]=(r[n]-i[n])*e/t+i[n];return a}var Mr=i("2bc9");const Er=Object(M["g"])(.5773502691896258,-.5773502691896258,.5773502691896258);let Dr=class extends Ce["a"].EventedAccessor{constructor(...e){super(...e),this._referencePointUpdateDelay=200,this._referencePointUpdateInterval=3e3,this._referencePointUpdateDistThreshold=1e6,this._referencePosUpdateQuery=null,this._referencePosMapCoordsRequested=null,this._viewHandles=new we["a"],this._preserveAbsoluteDateTime=!1,this._trackingEnabled=!1,this._referencePosResetPreserveAbsoluteTime=!1,this.referencePosUpdateTimer=null,this._referencePosWGS84Comparable=null,this._referencePosMapCoords=null,this._mainLight=new Mr["c"],this._ambientLight=new Mr["a"],this._moonLight=new Mr["b"],this._renderer=null,this._resetReferencePosition()}destroy(){this.disconnectView(),this._viewHandles.destroy()}get updating(){return!!(!this.disableQueries&&(this._referencePosUpdateQuery||this._referencePosMapCoordsRequested)||this._renderer&&this._renderer.updating)}connectView(e){this._renderer||(this._view=e,this._renderer=new ur({view:e}),this._viewHandles.add([e.watch("environment.lighting.date",e=>this._lightingDateHandler(e),!0),e.watch("stationary",()=>this._interactingStationaryHandler()),e.watch(["environment.lighting.directShadowsEnabled","environment.lighting.ambientOcclusionEnabled","environment.lighting.waterReflectionEnabled","environment.background.color"],()=>this._updateRenderParamsHandler(),!0),e.watch("spatialReference",()=>this._resetReferencePosition(!0),!0),Object(L["a"])(e,"viewingMode",()=>this._resetReferencePosition(!0),!0),Object(L["a"])(e,"environment.lighting.cameraTrackingEnabled",e=>this._updateCameraTracking(e),!0),Object(L["a"])(e,"state.camera",()=>this._cameraHandler(null),!0),this.watch("disableQueries",()=>this._cameraHandler(null))]),this._updateRenderParamsHandler(),this._updateLightParams(),this._cameraHandler(),this.notifyChange("updating"))}disconnectView(){this._renderer&&(this._viewHandles.removeAll(),this._resetReferencePosition(),this._renderer.destroy(),this._renderer=null,this._view=null)}_updateCameraTracking(e){if(this._trackingEnabled=e,e)this._cameraHandler();else{const e=this._view.environment.lighting;e&&(e.positionTimezoneInfo.autoUpdated=!1)}}_lightingDateHandler(e){if(!e)return;const t=this._view.environment.lighting;if(!t.positionTimezoneInfo.autoUpdated){this._preserveAbsoluteDateTime=!0;const i=this._view.spatialReference;if(!Object(z["a"])(i)){const e=this._view.camera.position;if(!this._referencePosMapCoords||!this._referencePosMapCoords.equals(e))return void this._requestReferencePositionUpdate(e)}if(this._preupdateTracking(e),this._referencePosWGS84Comparable){const e=vr(this._referencePosWGS84Comparable,Lr);Object(p["k"])(e)&&(t.autoUpdate(null,e),this._trackingEnabled&&(t.positionTimezoneInfo.autoUpdated=!0))}}this._updateLightParams(e)}_preupdateTracking(e){!this._trackingEnabled&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e)}_cameraHandler(e=null){if(!this._view.ready)return;const t=this._view.camera;t&&(this._cameraHandlerClientSide(t,e)||this._cameraHandlerServerSide(t))}_cameraHandlerClientSide(e,t){const i=Object(Dt["f"])(this._view.spatialReference);if(i&&!Object(z["a"])(this._view.spatialReference))return!1;const r=e.position;return this._referencePosWGS84Comparable||(this._referencePosWGS84Comparable=Object(M["e"])()),i?Object(z["u"])(r,this._referencePosWGS84Comparable):Object(It["x"])(this._referencePosWGS84Comparable,r.longitude,r.latitude,r.z),this._autoUpdateTimezone(this._referencePosWGS84Comparable,t)||this._updateLightParams(t),!0}_cameraHandlerServerSide(e){const t=e.position;(!this._referencePosMapCoords||this._referencePosMapCoordsRequested||this._exceedsReferencePosDistThreshold(t))&&this._requestReferencePositionUpdate(t,!0),this._view.mapCoordsHelper&&this._referencePosWGS84Comparable&&(this._referencePosWGS84Comparable[2]=t.z*this._view.mapCoordsHelper.unitInMeters,this._referencePosChanged())}_interactingStationaryHandler(){this._view.stationary&&this._executePendingReferencePositionUpdate()}_updateLightParams(e){const t=this._view.environment.lighting;e=e||t.date;const i=this._view._stage;let r;this._referencePosWGS84Comparable?(r=xr(e,this._referencePosWGS84Comparable),jr(e,this._referencePosWGS84Comparable,this._view.viewingMode,r.diffuse.direction)):r={diffuse:{color:[1,1,1],intensity:.55,direction:Er},ambient:{color:[1,1,1],intensity:.55},noonFactor:.5,globalFactor:0},Object(It["f"])(this._mainLight.intensity,r.diffuse.color,r.diffuse.intensity*Math.PI),Object(It["u"])(this._mainLight.direction,r.diffuse.direction),Object(It["f"])(this._ambientLight.intensity,r.ambient.color,r.ambient.intensity),Object(It["j"])(this._moonLight.intensity,Vr,kr,r.globalFactor);const a=(1-.5*r.globalFactor)*(1-.4*r.noonFactor*(1-r.globalFactor));Object(It["f"])(this._moonLight.intensity,this._moonLight.intensity,a),Object(It["l"])(this._moonLight.direction,r.diffuse.direction),i.setLighting({lights:[this._mainLight,this._ambientLight,this._moonLight],globalFactor:r.globalFactor,groundLightingFactor:1-r.noonFactor}),this._updateRenderParamsHandler()}_autoUpdateTimezone(e,t=null){if(!this._view.environment.lighting.cameraTrackingEnabled)return!1;const i=Ir;i.setTime((t||this._view.environment.lighting.date).getTime());const r=vr(e,Lr);if(Object(p["j"])(r))return!1;let a=this._view.environment.lighting.positionTimezoneInfo;if(a.autoUpdated){if(a.hours===r.hours&&a.minutes===r.minutes&&a.seconds===r.seconds)return!1}else a=r;const n=i.getUTCHours()-(r.hours-a.hours),s=i.getUTCMinutes()-(r.minutes-a.minutes),o=i.getUTCSeconds()-(r.seconds-a.seconds);return i.setUTCHours(n),i.setUTCMinutes(s),i.setUTCSeconds(o),!t&&this._view.environment.lighting.autoUpdate(i,r)}_updateRenderParamsHandler(){const e=this._view._stage;if(!e)return;const t=!this._referencePosWGS84Comparable||wr(this._referencePosWGS84Comparable,this._view.viewingMode),i=this._view.environment.background,r=i instanceof ne?{type:"color",color:Object(Lt["g"])(ee["a"].toUnitRGBA(i.color))}:{type:"color",color:Object(Lt["d"])(0,0,0,1)};e.renderView.setRenderParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&t,ssao:this._view.environment.lighting.ambientOcclusionEnabled,waterReflectionEnabled:this._view.environment.lighting.waterReflectionEnabled,background:r})}_resetReferencePosition(e=!1){this._cancelReferencePosUpdates(),this._referencePosMapCoords=null,this._referencePosMapCoordsRequested=null,this._referencePosResetPreserveAbsoluteTime=null,this._referencePosWGS84Comparable=null,this.notifyChange("updating"),e&&this._cameraHandler(null)}_requestReferencePositionUpdate(e,t=!1){if(!this.disableQueries&&(this._referencePosMapCoordsRequested?this._referencePosMapCoordsRequested.copy(e):this._referencePosMapCoordsRequested=e.clone(),this._referencePosResetPreserveAbsoluteTime=!!t,!this._referencePosUpdateQuery&&!this.referencePosUpdateTimer&&this._view.stationary)){const e=this._referencePosUpdateQuery=Object(j["a"])(this._referencePointUpdateDelay).then(()=>{if(this._referencePosUpdateQuery===e){const t=()=>this._referencePosUpdateQuery!==e;return this._doReferencePositionUpdateQuery(t)}}).catch(e=>{"mapcoordshelper:missing-geometry-service"===e.name&&(this.disableQueries=!0)}).then(()=>{this._referencePosUpdateQuery===e&&(this._referencePosUpdateQuery=null,this.referencePosUpdateTimer||this._executePendingReferencePositionUpdate(),this.notifyChange("updating"))}),t=this.referencePosUpdateTimer=Object(j["a"])(this._referencePointUpdateInterval).then(()=>{this.referencePosUpdateTimer===t&&(this.referencePosUpdateTimer=null,this._referencePosUpdateQuery||this._executePendingReferencePositionUpdate())});this.notifyChange("updating")}}async _doReferencePositionUpdateQuery(e){this._referencePosResetPreserveAbsoluteTime&&(this._preserveAbsoluteDateTime=!1),this._referencePosMapCoords?this._referencePosMapCoords.copy(this._referencePosMapCoordsRequested):this._referencePosMapCoords=this._referencePosMapCoordsRequested.clone(),this._referencePosResetPreserveAbsoluteTime=null,this._referencePosMapCoordsRequested=null;const t=await this._view.mapCoordsHelper.toGeographic(this._referencePosMapCoords);if(!e()&&!isNaN(t[0])&&!isNaN(t[1])){const e=this._referencePosMapCoords.z*this._view.mapCoordsHelper.unitInMeters;this._referencePosWGS84Comparable?(this._referencePosWGS84Comparable[0]=t[0],this._referencePosWGS84Comparable[1]=t[1],this._referencePosWGS84Comparable[2]=e):this._referencePosWGS84Comparable=[t[0],t[1],e],this._referencePosChanged()}}_executePendingReferencePositionUpdate(){const e=this._referencePosMapCoordsRequested;e&&this._requestReferencePositionUpdate(e,this._referencePosResetPreserveAbsoluteTime)}_referencePosChanged(){this._preserveAbsoluteDateTime?this._updateLightParams():this._autoUpdateTimezone(this._referencePosWGS84Comparable)||this._updateLightParams()}_exceedsReferencePosDistThreshold(e){if(this._referencePosMapCoords){let t=this._referencePosMapCoords.distance(e);return this._view.mapCoordsHelper&&(t*=this._view.mapCoordsHelper.unitInMeters),t>this._referencePointUpdateDistThreshold}return!0}_cancelReferencePosUpdates(){const e=!!this._referencePosUpdateQuery;return this._referencePosUpdateQuery=null,this.referencePosUpdateTimer=null,e}get test(){const e=this;return{renderer:this._renderer,set referencePointUpdateInterval(t){e._referencePointUpdateInterval=t},set referencePointUpdateDistThreshold(t){e._referencePointUpdateDistThreshold=t},set referencePosUpdateTimer(t){e.referencePosUpdateTimer=t},set referencePointUpdateDelay(t){e._referencePointUpdateDelay=t}}}};Dr.FIXED_LIGHT_DIRECTION=Er,Object(d["a"])([Object(g["b"])({type:Boolean,readOnly:!0})],Dr.prototype,"updating",null),Object(d["a"])([Object(g["b"])()],Dr.prototype,"disableQueries",void 0),Object(d["a"])([Object(g["b"])()],Dr.prototype,"_renderer",void 0),Dr=Object(d["a"])([Object(y["a"])("esri.views.3d.environment.SceneViewEnvironmentManager")],Dr);const Ir=new Date,Lr={hours:0,minutes:0,seconds:0},Vr=Object(M["g"])(.22,.22,.33),kr=Object(M["g"])(.22,.22,.22);var Fr=Dr,zr=Fr,Ur=i("a978"),Gr=i("9250"),Br=i("2589"),Hr=i("6345"),Nr=i("16d5"),qr=i("bec4"),Wr=i("0f18"),Zr=i("82a5"),$r=i("e35b"),Qr=i("7164"),Xr=i("1bf0");function Yr(e,t,i,r){return Object(p["k"])(e.renderCoordsHelper.fromRenderCoords(t.eye,aa,r))&&Object(F["h"])(i,aa)}function Kr(e,t){return e.elevationProvider?Object(p["u"])(e.elevationProvider.getElevation(t[0],t[1],t[2],e.renderCoordsHelper.spatialReference,"ground"),0):0}function Jr(e,t,i,r){const a=e.state.camera.clone();t&&(a.eye=t),i&&(a.center=i),r&&(a.up=r),ta(e,a.ray,na)||Object(It["l"])(na,a.center);const n=e.state.constraints,s=n.minimumPoiDistance;if(Object(It["m"])(a.eye,na)<s){const t=n.collision.enabled;Object(It["l"])(sa,a.viewForward),Object(It["f"])(sa,sa,s),t?Object(It["k"])(a.eye,na,sa):Object(It["g"])(na,a.eye,sa);const i=e.renderCoordsHelper,r=i.getAltitude(a.eye),o=n.collision.elevationMargin;t&&r<o&&(Object(It["k"])(sa,na,a.eye),i.setAltitude(o,a.eye),Object(It["g"])(na,a.eye,sa))}return a.center=na,a}function ea(e,t,i){if(!e.state.isGlobal)return!1;const r=Kr(e,t),a=e.stateManager.constraintsManager.nearFarHeuristic,{far:n}=a.compute(t,i,e.dataExtent,r,oa),s=n*n;return Object(It["m"])(t,i)>s}function ta(e,t,i=Object(M["e"])()){let r=ra[e.viewingMode];r||(r=new Gr["a"](e.state.mode),r.options.backfacesTerrain=!e.state.isGlobal,r.options.invisibleTerrain=!0,ra[e.viewingMode]=r);const{isGlobal:a}=e.state;return!(!e.sceneIntersectionHelper.intersectRay(t,r,i)||ea(e,t.origin,i))||!(!e.renderCoordsHelper.intersectManifold(t,0,i)||ea(e,t.origin,i))||!!a&&ia(t,i,Object(V["e"])(e.spatialReference).radius)}function ia(e,t,i){const r=Object(It["i"])(e.origin,e.origin)-i*i,a=r>0?Math.sqrt(r)/3:1;return Object(It["f"])(t,e.direction,a/Object(It["q"])(e.direction)),Object(It["g"])(t,t,e.origin),!0}const ra={},aa=Object(M["e"])(),na=Object(M["e"])(),sa=Object(M["e"])(),oa={near:0,far:0};function ca(e,t,i=0){const r=e.state.constraints;if(!r.collision.enabled)return!1;const a=Kr(e,t.eye),n=e.renderCoordsHelper.getAltitude(t.eye),s=a+r.collision.elevationMargin;if(n>=s)return!1;const o=Object(It["q"])(t.eye);if(Object(It["k"])(la,t.center,t.eye),e.renderCoordsHelper.setAltitude(s,t.eye),1===i)Object(It["g"])(t.center,t.eye,la);else if(2===i){const e=(o-n+s)/o;Object(It["f"])(t.center,t.center,e)}return t.markViewDirty(),!0}const la=Object(M["e"])();function ha(e){return e}const da=e=>e*e,ua=e=>1-da(1-e),pa=e=>e<.5?da(2*e)/2:(ua(2*(e-.5))+1)/2,fa=e=>e*e*e,ma=e=>1-fa(1-e),ba=e=>e<.5?fa(2*e)/2:(ma(2*(e-.5))+1)/2,ga=e=>e*e*e*e,va=e=>1-ga(1-e),ya=e=>e<.5?ga(2*e)/2:(va(2*(e-.5))+1)/2,Oa=e=>e*e*e*e*e,_a=e=>1-Oa(1-e),xa=e=>e<.5?Oa(2*e)/2:(_a(2*(e-.5))+1)/2,ja=e=>1-Math.cos(e*Math.PI/2),wa=e=>1-ja(1-e),Sa=e=>e<.5?ja(2*e)/2:(wa(2*(e-.5))+1)/2,Ca=e=>2**(10*(e-1)),Ta=e=>1-Ca(1-e),Pa=e=>e<.5?Ca(2*e)/2:(Ta(2*(e-.5))+1)/2,Aa=e=>-(Math.sqrt(1-e*e)-1),Ra=e=>1-Aa(1-e),Ma=e=>e<.5?Aa(2*e)/2:(Ra(2*(e-.5))+1)/2;function Ea(e){const t=2*(e-Math.sqrt((e-1)*e)),i=t/2/e;return r=>r<i?e*r*r:t*r-t+1}function Da(e,t){return i=>i<t?t*e(i/t):1-e((1-i)/(1-t))*(1-t)}const Ia=Da(Ea(1),1),La=Da(Ea(1),0),Va=Da(Ea(1),.5),ka=Da(Ea(2),1),Fa=Da(Ea(2),0),za=Da(Ea(2),.5),Ua=Da(Ea(3),1),Ga=Da(Ea(3),0),Ba=Da(Ea(3),.5),Ha=Da(Ea(4),1),Na=Da(Ea(4),0),qa=Da(Ea(4),.5),Wa={linear:ha,"in-quad":da,"out-quad":ua,"in-out-quad":pa,"in-coast-quad":Ia,"out-coast-quad":La,"in-out-coast-quad":Va,"in-cubic":fa,"out-cubic":ma,"in-out-cubic":ba,"in-coast-cubic":ka,"out-coast-cubic":Fa,"in-out-coast-cubic":za,"in-quart":ga,"out-quart":va,"in-out-quart":ya,"in-coast-quart":Ua,"out-coast-quart":Ga,"in-out-coast-quart":Ba,"in-quint":Oa,"out-quint":_a,"in-out-quint":xa,"in-coast-quint":Ha,"out-coast-quint":Na,"in-out-coast-quint":qa,"in-sine":ja,"out-sine":wa,"in-out-sine":Sa,"in-expo":Ca,"out-expo":Ta,"in-out-expo":Pa,"in-circ":Aa,"out-circ":Ra,"in-out-circ":Ma};function Za(e,t){return 0!=(e&t)}function $a(e,t,i,r,a,n){0!==e&&(i?(n.min=Math.min(n.min,t),n.max=Math.max(n.max,t)):null!=r?(n.min-=Math.max(0,(t-n.min)*(1-r)),n.max+=Math.max(0,(t-n.max)*(1-r))):a&&(n.min-=Math.max(0,t-n.min-a),n.max+=Math.max(0,t-n.max-a)))}const Qa={selection:0,interactionType:0,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:0};function Xa(e,t,i,r){return t=t||e.viewForward,Object(It["l"])(r,t),Object(It["f"])(r,r,Object(Qe["s"])(Object(It["i"])(t,i))),r}var Ya=i("de58");function Ka(e,t,i=Qa){const r=Ja(e,t,i);if(0===r)return!1;const a=e.renderCoordsHelper,n=a.getAltitude(t.eye)+r,s=Xa(t,i.interactionDirection,rn(e,t,Object(Qe["s"])(r),on),sn),o=Object(It["l"])(cn,t.viewForward);return a.intersectInfiniteManifold(Et["g"].wrap(t.eye,s),n,t.eye)||a.setAltitude(n,t.eye),Object(Ya["a"])(t.eye,o,t.center,t.center),t.markViewDirty(),!0}function Ja(e,t,i=Qa){if(!en(e,i))return 0;const r=an(e.state.constraints.altitude,nn);tn(e,i,r);const a=e.renderCoordsHelper.getAltitude(t.eye),n=Object(Qe["d"])(a,r.min,r.max)-a;return Math.abs(n)<=1e-6?0:n}function en(e,t){const i=e.state.constraints.altitude;return!(!e.state.isGlobal||!i)&&(2!==t.interactionType||!Za(t.selection,1))}function tn(e,t,i){const r=t.interactionType;if(0===r)return;const{min:a,max:n}=i,{interactionStartCamera:s,interactionFactor:o}=t,c=2===r||1===r,l=Ja(e,s),h=0===l?0:e.renderCoordsHelper.getAltitude(s.eye);i.min=a,i.max=n,$a(l,h,c,o,.05*h,i)}function rn(e,t,i,r){return e.renderCoordsHelper.worldUpAtPosition(t.eye,r),Object(It["f"])(r,r,i),r}function an(e,t){return t.min=e.min,t.max=e.max,t}const nn={min:0,max:0},sn=Object(M["e"])(),on=Object(M["e"])(),cn=Object(M["e"])();function ln(e,t,i=Qa){if(!e.state.isLocal)return 0;const r=e.state.constraints.distance;if(!e.pointsOfInterest.surfaceOrigin.renderLocation||r===1/0)return 0;fn.min=0,fn.max=r,dn(e,i,fn);const a=un(e,t),n=fn.max-a;return n>=-1e-6?0:n}function hn(e,t,i=Qa){const r=ln(e,t,i);if(0===r)return!1;const a=e.pointsOfInterest.surfaceOrigin,n=un(e,t)+r,s=Object(It["l"])(mn,t.eye),o=Xa(t,i.interactionDirection,pn(e,t,vn),gn);if(Et["h"].intersectRay(Et["h"].fromCenterAndRadius(a.renderLocation,n),Et["g"].wrap(t.eye,o),t.eye)){const i=Object(It["k"])(bn,t.eye,s);Object(It["g"])(t.center,t.center,i),t.markViewDirty();const r=e.renderCoordsHelper.getAltitude(t.center);return e.renderCoordsHelper.intersectInfiniteManifold(t.ray,r,t.center),t.markViewDirty(),!0}return!1}function dn(e,t,i){const r=t.interactionType;if(0===r)return;const{min:a,max:n}=i,{interactionStartCamera:s,interactionFactor:o}=t,c=1===r||4===r,l=ln(e,s),h=0===l?0:un(e,s);i.min=a,i.max=n,$a(l,h,c,o,.05*h,i)}function un(e,t){const i=e.pointsOfInterest.surfaceOrigin;return Object(It["p"])(t.eye,i.renderLocation)}function pn(e,t,i){const r=e.pointsOfInterest.surfaceOrigin;return Object(Xe["h"])(i,t.eye,r.renderLocation)}const fn={min:0,max:0},mn=Object(M["e"])(),bn=Object(M["e"])(),gn=Object(M["e"])(),vn=Object(M["e"])();var yn=i("6c97");function On(e,t,i){e.worldUpAtPosition(t,_n),Object(It["k"])(xn,i,t);const r=Object(It["q"])(xn);return 0===r?0:Object(Qe["b"])(Object(It["i"])(xn,_n)/r)}const _n=Object(M["e"])(),xn=Object(M["e"])();function jn(e,t,i=Qa,r=!0){Hn.eyeCenterDistance=0,Hn.requiresTwoSteps=!1;const a=wn(e,t,i,void 0,Hn);if(0===a)return!1;switch(Object(Vt["i"])(Fn),Object(Vt["r"])(Fn,Fn,-a,t.viewRight),i.tiltMode){case 1:Object(It["n"])(kn,t.viewForward,Fn),Object(It["f"])(kn,kn,Hn.eyeCenterDistance),Object(It["g"])(t.center,t.eye,kn);break;case 0:Object(It["k"])(kn,t.center,t.eye),Object(It["n"])(kn,kn,Fn),Object(It["k"])(t.eye,t.center,kn);break;default:Object(yn["a"])(i.tiltMode)}return Object(It["n"])(t.up,t.up,Fn),t.markViewDirty(),!Hn.requiresTwoSteps||!r||jn(e,t,i,!1)}function wn(e,t,i=Qa,r=Qa,a){if(!e.state.constraints.tilt)return 0;const n=t.distance,s=e.state.constraints.tilt(n,Gn);return Ln(e,i,s),2===r.interactionType&&Za(r.selection,2)&&Vn(e,r.interactionStartCamera,s),1===i.tiltMode||1===r.tiltMode?Cn(e,t,s,a):Sn(e,t,s)}function Sn(e,t,i){const r=On(e.renderCoordsHelper,t.center,t.eye),a=r-Object(Qe["d"])(r,i.min,i.max);return Rn(a)?a:0}function Cn(e,t,i,r){switch(r&&(r.requiresTwoSteps=!1),e.viewingMode){case"global":return Pn(e,t,i,r);case"local":return Tn(e,t,i,r);default:return void Object(yn["a"])(e.viewingMode)}}function Tn(e,t,i,r){const a=On(e.renderCoordsHelper,t.center,t.eye),n=Object(Qe["d"])(a,i.min,i.max),s=a-n;if(!Rn(s))return 0;if(r){const i=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,a=e.renderCoordsHelper.getAltitude(t.eye)-i,s=Math.cos(n);Math.abs(s)>1e-4?r.eyeCenterDistance=a/s:r.eyeCenterDistance=t.distance}return s}function Pn(e,t,i,r){const a=An(e,t,Bn),n=Object(Qe["d"])(a.tiltAtCenter,i.min,i.max);if(!Rn(a.tiltAtCenter-n))return 0;let s,o;return a.centerIsOnSurface?(s=Mn(a),o=Dn(a,s)):(s=a.constraints.clampTilt(a.eyeCenterDistance,a.tiltAtCenter),r&&s<Math.PI/2&&(r.requiresTwoSteps=!0,s=Math.PI/2-1e-5),o=In(a,s)),r&&(r.eyeCenterDistance=En(a,s)),o}function An(e,t,i){const r=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,a=r+Object(V["e"])(e.spatialReference).radius,n=e.renderCoordsHelper.intersectManifold(t.ray,r,zn);return i.eyeCenterDistance=t.distance,n?(i.eyeCenterDistance=Object(It["p"])(t.eye,zn),i.tiltAtCenter=On(e.renderCoordsHelper,zn,t.eye)):e.state.isLocal?i.tiltAtCenter=On(e.renderCoordsHelper,t.center,t.eye):(Et["h"].closestPointOnSilhouette(Et["h"].fromRadius(a),t.ray,zn),i.eyeCenterDistance=Object(It["p"])(t.eye,zn),i.tiltAtCenter=Object(Qe["b"])(-Object(It["i"])(t.viewForward,Object(It["s"])(zn,zn)))),i.radius=a,i.eyeRadius=Object(It["q"])(t.eye),i.constraints=e.state.constraints,i.centerIsOnSurface=n,i}function Rn(e){return Math.abs(e)>1e-9}function Mn(e){const{constraints:t,eyeCenterDistance:i,tiltAtCenter:r}=e;let a=r,n=t.clampTilt(i,r);const s=En(e,n);if(t.clampTilt(s,r)===n)return n;let o=0;for(;o<10&&Rn(n-a);){const i=(a+n)/2,r=En(e,i);Rn(t.clampTilt(r,i)-i)?a=i:n=i,o++}return n}function En(e,t){if(!e.centerIsOnSurface)return e.eyeCenterDistance;const i=Math.PI-Object(Qe["d"])(t,0,Math.PI),r=Object(Qe["c"])(e.radius/e.eyeRadius*Math.sin(i)),a=Math.PI-i-r,n=Math.sin(a)/Math.sin(i);if(e.eyeRadius<e.radius&&n>1){const t=Math.PI-r,a=Math.PI-i-t;return Math.sin(a)/Math.sin(i)*e.eyeRadius}return n*e.eyeRadius}function Dn(e,t){const i=Object(Qe["c"])(e.radius/e.eyeRadius*Math.sin(e.tiltAtCenter)),r=Object(Qe["c"])(e.radius/e.eyeRadius*Math.sin(t));return e.eyeRadius>e.radius?i-r:r-i}function In(e,t){return e.tiltAtCenter-Math.PI/2-(t-Math.PI/2)}function Ln(e,t,i){if(0===t.interactionType)return;const{interactionStartCamera:r,interactionFactor:a}=t,{min:n,max:s}=i,o=wn(e,r,Qa,t),c=0===o?0:On(e.renderCoordsHelper,r.center,r.eye);i.min=n,i.max=s,2===t.interactionType?(Za(t.selection,2)&&Vn(e,r,i),$a(o,c,!0,a,Un,i)):$a(o,c,!1,a,Un,i)}function Vn(e,t,i){if(e.state.isLocal)return;const r=e.state.constraints;if(!r.altitude)return;const a=Object(It["t"])(t.center),n=Math.sqrt(a),s=t.distance,o=Object(V["e"])(e.spatialReference).radius,c=r.altitude.min+o,l=r.altitude.max+o,h=(c*c-s*s-a)/(-2*n*s),d=(l*l-s*s-a)/(-2*n*s);i.min=Math.max(i.min,Math.min(Math.PI-Object(Qe["b"])(d),i.max)),i.max=Math.min(i.max,Math.PI-Object(Qe["b"])(h))}const kn=Object(M["e"])(),Fn=Object(kt["b"])(),zn=Object(M["e"])(),Un=Object(Qe["f"])(5),Gn={min:0,max:0},Bn={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,eyeCenterDistance:0,tiltAtCenter:0},Hn={eyeCenterDistance:0,requiresTwoSteps:!1};function Nn(e,t,i=Qn,r=t){let a=!1;r!==t&&r.copyFrom(t),r.markViewDirty(),r.computeUp(e.state.mode);for(let o=0;o<Xn;o++){let t=0;for(const n of $n)if(Za(i.selection,n.type)){const s=Math.abs(n.error(e,r,i));n.apply(e,r,i)&&(a=!0,t+=s)}if(0===t)break}const n=Za(i.selection,8),s=qn(i.interactionType,e);return n&&ca(e,r,s)&&(a=!0),a&&r.computeUp(e.state.mode),a}function qn(e,t){switch(e){case 4:return 1;case 5:return t.state.isGlobal?2:1;default:return 0}}function Wn(e,t){const i="number"==typeof e?e:Object(di["i"])(e,t),r=Math.min(1,i/150);return ba(r)}function Zn(e,t,i){return wn(e,t,i)*t.distance}const $n=[{type:1,error:Zn,apply:jn},{type:2,error:Ja,apply:Ka},{type:4,error:ln,apply:hn}],Qn={selection:15,interactionType:0,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:0},Xn=5;var Yn=i("171c"),Kn=i("dae5"),Jn=i("1c92");const es=Object(M["e"])(),ts=Object(M["e"])(),is=Object(M["e"])(),rs=Object(M["e"])(),as=Object(M["e"])(),ns=Object(M["e"])(),ss={upward:Object(M["g"])(0,0,1),forward:Object(M["g"])(0,1,0),sideway:Object(M["g"])(1,0,0)},os=Object(Kn["a"])();class cs{constructor(e=1){this.viewingMode=e,this.center=Object(M["e"])(),this.pitch=0,this.yaw=0,this.distance=0,this.lookAtDirection=Object(M["d"])(ss.forward)}pixelsPerPanAtZoom(e){return this.size/2/(this._zoomToPanScale*e)}zoomAtPixelsPerPan(e){return this.size/2/(this._zoomToPanScale*e)}pixelsPerRotateAtZoom(){const e=Math.max(Math.cos(Math.abs(this.pitch)),.5);return this.size/2/e}compareTo(e,t){if(t||(t={pan:0,rotate:0,sourceZoom:0,targetZoom:0}),1===this.viewingMode){const i=(Object(It["q"])(this.center)+Object(It["q"])(e.center))/2;t.pan=Object(Xe["b"])(this.center,e.center)*i}else t.pan=Object(It["p"])(this.center,e.center);let i=Math.abs(e.yaw-this.yaw);i>=Math.PI&&(i=2*Math.PI-i);const r=Math.abs(e.pitch-this.pitch);return t.rotate=Math.max(i,r),t.sourceZoom=this.distance,t.targetZoom=e.distance,t}interpolate(e,t,i){1===this.viewingMode?Object(Xe["l"])(e.center,t.center,i.pan,this.center):Object(It["j"])(this.center,e.center,t.center,i.pan),this.distance=Object(Qe["l"])(e.distance,t.distance,i.zoom),this.pitch=Object(Qe["l"])(e.pitch,t.pitch,i.rotate);let r=e.yaw;const a=t.yaw;Math.abs(a-r)>=Math.PI&&(r+=2*(r<a?1:-1)*Math.PI),this.yaw=Object(Qe["l"])(r,a,i.rotate)}copyFrom(e){Object(It["l"])(this.center,e.center),this.pitch=e.pitch,this.yaw=e.yaw,this.distance=e.distance,Object(It["l"])(this.lookAtDirection,e.lookAtDirection),this.size=e.size,this.copyFromCommon(e),this.viewingMode=e.viewingMode}copyFromRenderCamera(e){const t=this._lookAtOrientation(e.center,os);Object(It["l"])(this.center,e.center),Object(It["k"])(rs,e.center,e.eye),Object(It["y"])(rs,rs,t),Object(It["y"])(as,e.up,t),this.distance=Object(It["q"])(rs),rs[0]/=this.distance,rs[1]/=this.distance,rs[2]/=this.distance,this.pitch=this._eyeUpToPitch(rs),this.yaw=this._eyeUpToYaw(rs,as),this.size=Math.sqrt(e.width*e.width+e.height*e.height),this.copyFromCommon(e)}copyFromCommon(e){this.fov=e.fov,this._zoomToPanScale=Math.atan(.5*this.fov)}copyToRenderCamera(e){const t=this._lookAtOrientation(this.center,os);Object(Jn["n"])(t,t),this._axisAngleVec3(ss.sideway,this.pitch-Math.PI/2,ss.forward,rs),this._axisAngleVec3(ss.upward,this.yaw,rs),this._axisAngleVec3(ss.sideway,this.pitch-Math.PI/2,ss.upward,as),this._axisAngleVec3(ss.upward,this.yaw,as),Object(It["f"])(rs,rs,this.distance),Object(It["y"])(rs,rs,t),Object(It["y"])(as,as,t),e.center=this.center,e.eye=Object(It["k"])(rs,this.center,rs),e.up=as}_axisAngleVec3(e,t,i,r=i){const a=Math.cos(t),n=Math.sin(t);return Object(It["f"])(es,i,a),Object(It["h"])(ts,e,i),Object(It["f"])(ts,ts,n),Object(It["f"])(is,e,(1-a)*Object(It["i"])(e,i)),Object(It["g"])(r,Object(It["g"])(r,es,ts),is)}_lookAtOrientation(e,t){return this._upAtLookAt(e,is),Object(It["h"])(es,this.lookAtDirection,is),Object(It["s"])(es,es),0===es[0]&&0===es[1]&&0===es[2]&&Object(It["l"])(es,ss.sideway),Object(It["h"])(ts,is,es),Object(It["s"])(ts,ts),t||(t=Object(Kn["a"])()),t[0]=es[0],t[1]=ts[0],t[2]=is[0],t[3]=es[1],t[4]=ts[1],t[5]=is[1],t[6]=es[2],t[7]=ts[2],t[8]=is[2],t}_upAtLookAt(e,t){return 2===this.viewingMode?Object(It["l"])(t,ss.upward):Object(It["s"])(t,e)}_eyeUpToPitch(e){return Math.PI-Object(Xe["b"])(ss.upward,e)}_eyeUpToYaw(e,t){const i=ns;return Math.abs(t[2])<.5?(Object(It["l"])(i,t),e[2]>0&&Object(It["f"])(i,i,-1)):Object(It["l"])(i,e),Object(It["h"])(ts,i,ss.upward),Object(It["s"])(ts,ts),Object(Xe["b"])(ss.sideway,ts,ss.upward)}}var ls=cs;const hs={desiredScreenFlow:2,minDuration:.5,maxDuration:8};class ds{constructor(e){this.createCamera=e,this.compared={sourceZoom:0,targetZoom:0,pan:0,rotate:0},this.settings={desiredScreenFlow:hs.desiredScreenFlow},this.source=e(),this.target=e()}clone(){const e=new ds(this.createCamera);return e.copyFrom(this),e}copyFrom(e){this.update(e.source,e.target,e.settings)}update(e,t,i){this.source!==e&&this.source.copyFrom(e),this.target!==t&&this.target.copyFrom(t),this.compared=this.source.compareTo(this.target,this.compared),this.settings.desiredScreenFlow=null!=i.desiredScreenFlow?i.desiredScreenFlow:hs.desiredScreenFlow,this.desiredPixelFlow=this.settings.desiredScreenFlow*this.target.size,this.halfWindowSize=this.target.size/2}halfWindowPanAtZoom(e){const t=this.target.pixelsPerPanAtZoom(e);return this.halfWindowSize/t}get hasZoom(){return Math.abs(this.compared.sourceZoom-this.compared.targetZoom)>1e-5}get hasPan(){return this.compared.pan>1e-9}get hasRotate(){return this.compared.rotate>1e-9}}class us{constructor(){this.segments=[]}get time(){return this.segments.reduce((e,t)=>e+t.time,0)}interpolateComponentsAt(e,t){e=Math.min(Math.max(e,0),1),e*=this.time;let i=0,r=0;const a=this.definition;for(let n=0;n<this.segments.length;n++){const s=this.segments[n],o=s.definition;if(e<=s.time||n===this.segments.length-1){t=this.segmentInterpolateComponentsAt(s,e/s.time,t),a.hasPan?t.pan=(i+o.compared.pan*t.pan)/a.compared.pan:t.pan=1,a.hasRotate?t.rotate=(r+o.compared.rotate*t.rotate)/a.compared.rotate:t.rotate=1;const n=t.zoom*(o.compared.targetZoom-o.compared.sourceZoom)+o.compared.sourceZoom,c=this.segments[0].definition.compared.sourceZoom,l=this.segments[this.segments.length-1].definition.compared.targetZoom;return a.hasZoom?t.zoom=(n-c)/(l-c):t.zoom=1,t}e-=s.time,i+=o.compared.pan,r+=o.compared.rotate}}segmentInterpolateComponentsAt(e,t,i){return e.interpolateComponentsAt(t,i)}}class ps{constructor(e){e&&this.update(e)}update(e){e&&(this.definition?this.definition.copyFrom(e):this.definition=e.clone()),this._updatePrecomputedVariables(),this._updatePixelFlow()}_updatePrecomputedVariables(){const e=this.definition,t=e.compared,i=t.sourceZoom,r=t.targetZoom;this._zoomSign=i>r?1:-1,this._panPixelsAtSource=t.pan*e.source.pixelsPerPanAtZoom(i);const a=(e.source.pixelsPerRotateAtZoom(i)+e.target.pixelsPerRotateAtZoom(r))/2;this._rotatePixels=t.rotate*a}_updatePixelFlow(){const e=this.definition.compared.sourceZoom,t=this.definition.compared.targetZoom,{hasZoom:i,hasPan:r,hasRotate:a}=this.definition;let n=0,s=0;i&&(r&&(n=(t/e-1)/(-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2*this._panPixelsAtSource)),a&&(s=this._zoomSign*(Math.log(e/t)/Math.LN2)*this.definition.halfWindowSize/this._rotatePixels)),this._zoomPixelFlow=0,this._panPixelFlow=0,this._rotatePixelFlow=0;const o=this.definition.desiredPixelFlow;if(i&&r&&a){const e=n+s+n*s;this._zoomPixelFlow=n*s/e*o,this._panPixelFlow=s/e*o,this._rotatePixelFlow=n/e*o}else if(i&&r){const e=1+n;this._zoomPixelFlow=n/e*o,this._panPixelFlow=1/e*o}else if(i&&a){const e=1+s;this._zoomPixelFlow=s/e*o,this._rotatePixelFlow=1/e*o}else if(r&&a){const e=this._panPixelsAtSource/this._rotatePixels,t=1+e;this._panPixelFlow=e/t*o,this._rotatePixelFlow=1/t*o}else r?this._panPixelFlow=o:i?this._zoomPixelFlow=o:a&&(this._rotatePixelFlow=o);this.time=a?this.rotateTime:i?this.zoomTime:r?this.panTime:0}get zoomTime(){return this.definition.hasZoom?this._zoomSign*(Math.log(this.definition.compared.sourceZoom/this.definition.compared.targetZoom)/Math.LN2)*this.definition.halfWindowSize/this._zoomPixelFlow:0}get panTime(){if(this.definition.hasPan){if(this.definition.hasZoom){const e=-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2,t=e*this._panPixelsAtSource;return Math.log(t*(this._zoomPixelFlow/this._panPixelFlow)+1)/(e*this._zoomPixelFlow)}return this._panPixelsAtSource/this._panPixelFlow}return 0}get rotateTime(){return this.definition.hasRotate?this._rotatePixels/this._rotatePixelFlow:0}_interpolateComponentsZoom(e){if(0===e||1===e)return e;if(this.definition.hasZoom){const t=this.definition.compared.sourceZoom,i=this.definition.compared.targetZoom;return(t*(t/i)**-e-t)/(i-t)}return e}_interpolateComponentsPan(e){if(0===e||1===e)return e;if(this.definition.hasPan&&this.definition.hasZoom){const t=-1/(this._zoomSign*this.definition.halfWindowSize)*this._zoomPixelFlow;return 1/this._panPixelsAtSource*(this._panPixelFlow*(2**(t*e*this.time)-1))/(t*Math.LN2)}return e}_interpolateComponentsRotate(e){return e}interpolateComponentsAt(e,t){e=Math.min(Math.max(e,0),1);const i=this._interpolateComponentsZoom(e),r=this._interpolateComponentsPan(e),a=this._interpolateComponentsRotate(e);return t?(t.zoom=i,t.pan=r,t.rotate=a):t={zoom:i,pan:r,rotate:a},t}}function fs(e,t,i){const r=t-e.compared.sourceZoom,a=e.halfWindowPanAtZoom(r);return-e.halfWindowSize*(i.ascensionFactor*Math.LN2*e.compared.pan+a)*Math.log(e.compared.sourceZoom/t)/(e.desiredPixelFlow*Math.LN2*a)}function ms(e,t,i){const r=1/t,a=Math.log(e.compared.sourceZoom*r),n=1/e.desiredPixelFlow,s=1/Math.LN2,o=t-e.compared.sourceZoom,c=1/o,l=(i.ascensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(o))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*r*n*s*c*l-e.halfWindowSize*a*n*s*c+e.halfWindowSize*a*n*s*l/(o*o)}function bs(e,t,i){const r=t-e.compared.sourceZoom,a=1/r,n=1/t,s=Math.log(e.compared.sourceZoom*n),o=(i.ascensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(r))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*a*(-2*a*n*o+2*a*s+2*n-2*s*o/(r*r)-o/(t*t))/(e.desiredPixelFlow*Math.LN2)}function gs(e,t){return-e.halfWindowSize*Math.log(e.compared.sourceZoom/t)/(e.desiredPixelFlow*Math.LN2)}function vs(e,t){return e.halfWindowSize/(t*e.desiredPixelFlow*Math.LN2)}function ys(e,t){return-e.halfWindowSize/(t*t*e.desiredPixelFlow*Math.LN2)}function Os(e,t,i){return-e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t))}function _s(e,t,i){return e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t*t))}function xs(e,t,i){return-2*e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t*t*t))}function js(e,t,i){return e.halfWindowSize*(-e.halfWindowPanAtZoom(t)-i.descensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(e.compared.targetZoom))*Math.log(t/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2*e.halfWindowPanAtZoom(-t+e.compared.targetZoom))}function ws(e,t,i){const r=Math.log(t/e.compared.targetZoom),a=1/e.desiredPixelFlow,n=1/Math.LN2,s=-t+e.compared.targetZoom,o=1/s,c=(-e.halfWindowPanAtZoom(t)-i.descensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(e.compared.targetZoom))/e.halfWindowPanAtZoom(1);return-e.halfWindowSize*r*a*n*o+e.halfWindowSize*r*a*n*c/(s*s)+e.halfWindowSize*a*n*o*c/t}function Ss(e,t,i){const r=t-e.compared.targetZoom,a=1/r,n=1/t,s=Math.log(t/e.compared.targetZoom),o=(e.halfWindowPanAtZoom(t)+i.descensionFactor*Math.LN2*e.compared.pan-e.halfWindowPanAtZoom(e.compared.targetZoom))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*a*(-2*a*n*o-2*a*s+2*n+2*s*o/(r*r)-o/(t*t))/(e.desiredPixelFlow*Math.LN2)}function Cs(e,t){return e.halfWindowSize*Math.log(t/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2)}function Ts(e,t){return e.halfWindowSize/(t*e.desiredPixelFlow*Math.LN2)}function Ps(e,t){return-e.halfWindowSize/(t*t*e.desiredPixelFlow*Math.LN2)}function As(e){const t=Math.LN2*e.compared.pan,i=e.compared.sourceZoom-e.compared.targetZoom,r=e.halfWindowPanAtZoom(i),a=e.halfWindowSize*Math.log(e.compared.sourceZoom/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2*r);return e.compared.sourceZoom<=e.compared.targetZoom?a*(t-r):a*(t+r)}function Rs(e,t){let i=Ms(e,t);const r={ascensionFactor:null!=t.ascensionFactor?t.ascensionFactor:.5,descensionFactor:null!=t.descensionFactor?t.descensionFactor:.5},a=0===r.ascensionFactor,n=0===r.descensionFactor,s=a?gs:fs,o=a?vs:ms,c=a?ys:bs,l=n?Cs:js,h=n?Ts:ws,d=n?Ps:Ss,u=t=>s(e,t,r)+Os(e,t,r)+l(e,t,r),p=t=>o(e,t,r)+_s(e,t,r)+h(e,t,r),f=t=>c(e,t,r)+xs(e,t,r)+d(e,t,r);let m=u(i);const b=As(e);let g;const v=t.maximumIterations||20,y=null!=t.maximumDistance?t.maximumDistance:1/0;for(g=0;g<v;g++){const t=1e-6,r=(p(i)+t)/f(i);if(isNaN(r)||i>=y&&r<0){if(!isFinite(y))return null;i=y,m=u(i);break}if(i-=r,i<e.compared.sourceZoom||i<e.compared.targetZoom)return null;const a=u(i);if(Math.abs(a-m)/m<=.005)break;m=a}return m>.7*b||i<e.compared.sourceZoom||i<e.compared.targetZoom?null:i}function Ms(e,t){const i=Math.max(e.compared.sourceZoom,e.compared.targetZoom),r=e.source.zoomAtPixelsPerPan(e.desiredPixelFlow/e.compared.pan)/2;return r<i?null!=t.maximumDistance?i+(t.maximumDistance-i)/2:1.5*i:t.maximumDistance?Math.min(t.maximumDistance,r):r}class Es extends us{constructor(e,t){super(),this._preallocSegments=[new ps,new ps,new ps],this.update(e,t)}update(e,t){if(!e)return;this.definition?this.definition.copyFrom(e):this.definition=e.clone();let i=null;t&&t.apex&&(i=Rs(e,t.apex)),this.segments.length=0,this._ascensionSegment=null,this._descensionSegment=null,null==i?this._updateWithoutApex():this._updateWithApex(i,t.apex)}segmentInterpolateComponentsAt(e,t,i){return i=e.interpolateComponentsAt(t,i),e===this._ascensionSegment?i.zoom=ua(i.zoom):e===this._descensionSegment&&(i.zoom=da(i.zoom)),i}_updateWithApex(e,t){const[i,r,a]=this._preallocSegments,n=null!=t.ascensionFactor?t.ascensionFactor:.5,s=Math.min(1-n,null!=t.ascensionFactor?t.descensionFactor:.5),o=1-n-s;i.definition?i.definition.copyFrom(this.definition):i.definition=this.definition.clone(),i.definition.compared.targetZoom=e,i.definition.compared.pan=this.definition.compared.pan*n,i.definition.compared.rotate=this.definition.compared.rotate*n,i.update(),this._ascensionSegment=i,this.segments.push(i),o>0&&(r.definition?r.definition.copyFrom(this.definition):r.definition=this.definition.clone(),r.definition.copyFrom(this.definition),r.definition.compared.sourceZoom=e,r.definition.compared.targetZoom=e,r.definition.compared.pan=this.definition.compared.pan*o,r.definition.compared.rotate=this.definition.compared.rotate*o,r.update(),this.segments.push(r)),a.definition?a.definition.copyFrom(this.definition):a.definition=this.definition.clone(),a.definition.compared.sourceZoom=e,a.definition.compared.pan=this.definition.compared.pan*s,a.definition.compared.rotate=this.definition.compared.rotate*s,a.update(),this._descensionSegment=a,this.segments.push(a)}_updateWithoutApex(){const[e]=this._preallocSegments;e.update(this.definition),this.segments.push(e)}}const Ds={zoom:0,pan:0,rotate:0};class Is{constructor(e){this.createCamera=e,this.time=0,this.definition=new ds(e),this.path=new Es}update(e,t,i){this.definition.update(e,t,i),this.path.update(this.definition,i),this.time=this._applyTimeSettings(this.path.time,i),this.settings=i}cameraAt(e,t){t=t||this.createCamera(),e=Math.min(Math.max(0,e),1),e=this.settings.easing?this.normalizedEasing(this.settings.easing,e):this.time>=1?this.normalizedEasing(Va,e):this.normalizedEasing(Ta,e);const i=this.path.interpolateComponentsAt(e,Ds);return t.interpolate(this.definition.source,this.definition.target,i),t}normalizedEasing(e,t){const i=e(0),r=e(1);return(e(t)-i)/(r-i)}_applyTimeSettings(e,t){const i=null!=t.speedFactor?t.speedFactor:1;null!=t.duration?e=t.duration:null!=t.speedFactor&&(e/=i);const r=null!=t.minDuration?t.minDuration:hs.minDuration/i,a=null!=t.maxDuration?t.maxDuration:hs.maxDuration/i;return Math.min(Math.max(r,e),a)}}const Ls=Object(M["e"])();class Vs{constructor(e){this.currentTime=0,this.animation=new Is(()=>new ls(e)),this._current=new ls(e)}get finished(){return this.currentTime>=this.animation.time}get time(){return this.animation.time}update(e,t,i){const r=this.animation.definition.source,a=this.animation.definition.target,n=Object(It["k"])(Ls,t.center,e.center),s=Object(It["q"])(n);s>=1e-5?(n[0]/=s,n[1]/=s,n[2]/=s):(n[0]=0,n[1]=1,n[0]=0),Object(It["l"])(r.lookAtDirection,n),Object(It["l"])(a.lookAtDirection,n),r.copyFromRenderCamera(e),a.copyFromRenderCamera(t),this._current.copyFrom(r),this.animation.update(r,a,i),this.currentTime=0,e.almostEquals(t)&&(this.currentTime=this.animation.time)}cameraAt(e,t){return this.animation.cameraAt(e,this._current),t=t||new Yn["a"],this._current.copyToRenderCamera(t),t}step(e,t){return this.finished||(this.currentTime+=e,this.currentTime>=this.time&&(this.currentTime=this.time)),this.cameraAt(this.currentTime/this.time,t)}}var ks;!function(e){e.Ready="ready",e.Rejected="rejected",e.Running="running",e.Stopped="stopped",e.Finished="finished"}(ks||(ks={}));let Fs=class extends je["a"]{constructor(){super(...arguments),this.state=ks.Ready}get active(){return this.state===ks.Running}get isInteractive(){return!1}get canStop(){return!1}stopController(){return!!this.canStop&&(this.state=ks.Stopped,!0)}finishController(){this.state=ks.Finished}get steppingFinished(){return!1}};Object(d["a"])([Object(g["b"])({readOnly:!0})],Fs.prototype,"active",null),Object(d["a"])([Object(g["b"])()],Fs.prototype,"state",void 0),Fs=Object(d["a"])([Object(y["a"])("esri.views.3d.state.controllers.CameraController")],Fs);let zs=class extends Fs{get canStop(){return!0}set asyncResult(e){this._asyncResult&&(this._asyncResult.reject(Object(j["f"])()),this._asyncResult=null),this.state===ks.Finished||this.state===ks.Stopped?this.state===ks.Finished?e.resolve():e.reject(Object(j["f"])()):this._asyncResult=e}get asyncResult(){return this._asyncResult}onControllerStart(){this.state=ks.Running,Object(p["k"])(this.viewAnimation)&&this.viewAnimation.when(()=>this.updateStateFromViewAnimation(),()=>this.updateStateFromViewAnimation())}updateStateFromViewAnimation(){!Object(p["k"])(this.viewAnimation)||this.state!==ks.Ready&&this.state!==ks.Running||(this.viewAnimation.state===ze["a"].State.FINISHED?this.finish():this.viewAnimation.state===ze["a"].State.STOPPED&&(this.state=ks.Stopped))}onControllerEnd(){Object(p["k"])(this.viewAnimation)&&!this.viewAnimation.done&&(this.state===ks.Finished?this.viewAnimation.finish():this.state===ks.Stopped&&this.viewAnimation.stop()),this._asyncResult&&(this.state===ks.Finished?this._asyncResult.resolve():this._asyncResult.reject(Object(j["f"])()))}finish(){this.finishController()}};zs=Object(d["a"])([Object(y["a"])("esri.views.3d.state.controllers.AnimationController")],zs);let Us=class extends zs{constructor(e){super(e),this.view=null,this.mode="interaction",this.hasTarget=!1}get intersectionHelper(){return this.view.sceneIntersectionHelper}initialize(){this.animation=new Vs(this.view.state.mode),this.viewAnimation="interaction"===this.mode?null:new ze["a"]}get isInteractive(){return"interaction"===this.mode}begin(e,t){this.hasTarget=!0;const i=this.animationSettings(t);Gs.copyFrom(this.view.state.camera);const r=new Gr["a"](this.view.state.mode);this.intersectionHelper.intersectRay(Gs.ray,r,Bs)&&(Gs.center=Bs),this.animation.update(Gs,e,i),this.animation.finished&&this.finish()}finish(){this.animation.currentTime=this.animation.time,super.finish()}get steppingFinished(){return this.hasTarget&&this.animation.finished}stepController(e,t){this.hasTarget&&this.animation.step(e,t)}onControllerEnd(e){this.hasTarget&&(this.animation.cameraAt(this.animation.currentTime/this.animation.time,e),this.animation.currentTime=this.animation.time),super.onControllerEnd(e)}animationSettings(e={}){return{apex:{maximumDistance:this.view.state.constraints.clampAltitude(1/0)/6,ascensionFactor:void 0,descensionFactor:void 0},speedFactor:e.speedFactor,duration:e.duration,maxDuration:e.maxDuration,easing:e.easing}}};Object(d["a"])([Object(g["b"])({constructOnly:!0})],Us.prototype,"view",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],Us.prototype,"mode",void 0),Us=Object(d["a"])([Object(y["a"])("esri.views.3d.state.controllers.PointToPointAnimationController")],Us);const Gs=new Yn["a"],Bs=Object(M["e"])();var Hs=i("f091"),Ns=i("2047");function qs(e){const{value:t,operations:i}=e;return{operations:i,value:i.create(t)}}function Ws(e,t,i){return e.operations.setExtent(e.value,t,i.value),i}function Zs(e){return{operations:e,value:e.create()}}function $s(e,t,i=Zs(e)){return i.operations=e,e.copy(t,i.value),i}function Qs(e){return $s(Et["h"],Et["h"].fromValues(0,0,0,Object(V["e"])(e).radius))}const Xs=2**50;function Ys(){return $s(Et["b"],Et["b"].fromValues([0,0,0],[Xs,0,0],[0,Xs,0]))}function Ks(e,t,i){return e.operations.axisAt(e.value,t,2,i)}function Js(e,t,i,r){return e.operations.axisAt(e.value,t,i,r)}function eo(e,t,i){return e.operations.intersectRay(e.value,t,i)}function to(e,t,i){return e.operations.intersectRayClosestSilhouette(e.value,t,i)}function io(e,t){return e.operations.altitudeAt(e.value,t)}function ro(e,t,i,r){return e.operations.setAltitudeAt(e.value,t,i,r)}function ao(e,t,i,r){return t!==r&&Object(Vt["c"])(r,t),Object(It["x"])(so,r[12],r[13],r[14]),ro(e,so,i,so),r[12]=so[0],r[13]=so[1],r[14]=so[2],r}function no(e,t,i){return e.operations.elevate(e.value,t,i.value)}const so=Object(M["e"])();function oo(e,t,i,r,a){return a[0]=Object(It["i"])(e,t),a[1]=Object(It["i"])(e,i),a[2]=Object(It["i"])(e,r),a}function co(e,t,i,r,a){Object(It["l"])(i,e),Object(It["l"])(lo,t),Object(It["s"])(lo,lo),Object(It["h"])(r,lo,i),Object(It["h"])(a,r,i)}const lo=Object(M["e"])();function ho(e,t,i){return i[0]=t[0]/(e.fullWidth/e.pixelRatio),i[1]=t[1]/(e.fullHeight/e.pixelRatio),i}function uo(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}function po(e,t,i){const r=Hs["a"].get();Object(Vt["i"])(r),Object(Vt["r"])(r,r,i[3],Et["a"].axis(i)),Object(It["k"])(e.eye,e.eye,t),Object(It["n"])(e.eye,e.eye,r),Object(It["g"])(e.eye,e.eye,t),Object(It["k"])(e.center,e.center,t),Object(It["n"])(e.center,e.center,r),Object(It["g"])(e.center,e.center,t),Object(It["n"])(e.up,e.up,r),e.markViewDirty()}function fo(e,t,i,r){return Et["f"].intersectRay(e,Et["g"].fromScreen(t,i,uc),r)}function mo(e,t,i,r){const a=Hs["d"].get();let n=1-i;Object(It["k"])(a,t,e.eye);const s=Object(It["q"])(a);let o=s*(1-n);n>=0&&o<r&&(o=r,n=-(o-s)/s),Math.abs(s-o)<1e-6||(Object(It["f"])(a,a,n),Object(It["g"])(e.eye,e.eye,a),Object(It["j"])(e.center,e.center,t,n))}function bo(e,t,i){t.getScreenCenter(go),Et["h"].intersectScreen(e,t,go,t.center),t.markViewDirty();const r=t.distance,a=r*i;if(Math.abs(r-a)<1e-6)return;const n=Object(It["f"])(Hs["d"].get(),t.viewForward,a);Object(It["k"])(t.eye,t.center,n),t.markViewDirty()}const go=Object(A["g"])();function vo(e,t){Object(It["x"])(t,0,0,0);for(const i of e)Object(It["g"])(t,t,i);Object(It["f"])(t,t,1/e.length)}function yo(e,t,i,r){return Math.sin(e/Object(It["q"])(t))*(i+r.radius)}function Oo(e,t,i,r){return yo(Math.PI/2,t,i,r)+(e-Math.PI/2)}var _o;!function(e){e[e.Vertical=0]="Vertical",e[e.Horizontal=1]="Horizontal"}(_o||(_o={}));const xo={Elevation:3e4,Angle:Object(Qe["f"])(6)},jo={Pole:.95,Angle:Object(Qe["f"])(18),Tilt:45},wo=Object(Qe["f"])(80);function So(e,t,i,r,a){const n=Object(M["e"])(),s=Et["h"].create();let o=!0,c=!0;return e.intersectScreen(i,n)?s[3]=Object(It["q"])(n):(c=!1,t.aboveGround?s[3]=Math.max(Object(It["q"])(t.center),.9*a.radius):s[3]=Object(It["q"])(t.eye)-t.relativeElevation,r?Ao(s,t,i,n):o=Et["h"].intersectScreen(s,t,i,n)),{sphere:s,scenePickPoint:o?n:null,hasGeometryIntersection:c}}function Co(e,t,i,r){return Object(It["q"])(e.eye)-r.radius>xo.Elevation?_o.Horizontal:i?(Et["g"].fromScreenAtEye(e,t,pc),-Object(Qe["s"])(e.relativeElevation)*(.5*Math.PI+Object(Ns["a"])(e.eye,pc.direction))<xo.Angle?_o.Vertical:_o.Horizontal):_o.Vertical}function To(e,t,i){Object(It["k"])(Po,i,t),Object(It["k"])(e.eye,e.eye,Po),Object(It["k"])(e.center,e.center,Po),e.markViewDirty()}const Po=Object(M["e"])();function Ao(e,t,i,r){const a=Et["g"].fromScreenAtEye(t,i,uc);return!Object(p["j"])(a)&&(Et["h"].closestPointOnSilhouette(e,a,Ro),Et["h"].intersectRay(e,a,r)?!(Object(It["m"])(Ro,a.origin)<Object(It["m"])(r,a.origin))||(Object(It["l"])(r,Ro),!1):(Object(It["k"])(Mo,t.eye,t.center),Object(It["s"])(Mo,Mo),Et["f"].fromNormalAndOffset(Mo,-Object(It["i"])(Object(It["s"])(Mo,Mo),Ro),Eo),Et["f"].intersectRay(Eo,a,r),!1))}const Ro=Object(M["e"])(),Mo=Object(M["e"])(),Eo=Et["f"].create();function Do(e,t,i,r,a,n){let s;if(Object(It["h"])(hc,e,t),Object(It["k"])(cc,e,t),Object(It["q"])(e)<=a||!r.aboveGround){Object(It["h"])(i,cc,r.eye);const o=Object(It["i"])(e,t)/(Object(It["q"])(e)*Object(It["q"])(t)),c=Math.cos(Object(Qe["d"])(Xe["g"].normalize(Object(Qe["f"])(n)),0,wo));s=-Object(Qe["b"])(o)-Math.max(0,Object(It["q"])(t)-a)/(c*a)}else Object(It["k"])(Io,r.eye,r.center),Object(It["h"])(i,cc,Io),s=-Object(It["q"])(cc)/a;return Object(It["s"])(i,i),Object(It["f"])(i,i,Object(It["q"])(hc)),s}const Io=Object(M["e"])();function Lo(e,t,i,r){let a,n;const s=Math.cos(Object(Qe["d"])(Xe["g"].normalize(Object(Qe["f"])(r)),0,wo));return a=t>i?-(t-i)/(s*i):t<-i?Math.PI-(t+i)/(s*i):Object(Qe["b"])(t/i),n=e>i?-(e-i)/(s*i):e<-i?Math.PI-(e+i)/(s*i):Object(Qe["b"])(e/i),(n-a)*i}function Vo(e,t,i,r,a,n,s,o,c,l){const h=Lo(e[2],t[2],s[3],c),d=l?Lo(e[0],t[0],s[3],180):t[0]-e[0],u=Math.sin(o)*d-Math.cos(o)*h,p=Math.cos(o)*d+Math.sin(o)*h;Object(It["s"])(oc,a);const f=l?u/Math.sqrt(Math.abs(s[3]**2-Object(It["i"])(i,oc)**2)):u/s[3],m=p/Math.sqrt(Math.abs(s[3]**2-Object(It["i"])(i,r)**2));Object(di["s"])(n,f,m)}function ko(e,t,i,r,a,n,s,o,c,l){Object(It["h"])(hc,e,t),co(n.up,n.eye,Xo,Yo,Ko),co([0,0,1],n.eye,Zo,$o,Qo),Object(It["l"])(i,$o),Object(It["l"])(r,Zo),Object(It["s"])(i,i),Object(It["f"])(i,i,Object(It["q"])(hc)),oo(e,Object(It["s"])(Yo,Yo),Object(It["s"])(Ko,Ko),Object(It["s"])(Xo,Xo),Jo),oo(t,Yo,Ko,Xo,ec),Vo(Jo,ec,e,Zo,$o,a,s,o,c,l)}function Fo(e,t,i,r,a,n,s){Object(Vt["i"])(rc),Object(Vt["i"])(ac),Object(Vt["i"])(nc),Object(Vt["r"])(rc,rc,a,r),Object(Vt["r"])(ac,ac,s,n),Object(Vt["m"])(nc,rc,ac),Object(It["k"])(t,e,i),Object(It["n"])(t,t,nc),Object(It["g"])(t,t,i)}function zo(e,t,i,r,a,n){Object(Vt["i"])(rc),Object(Vt["i"])(ac),Object(Vt["i"])(nc),Object(Vt["r"])(rc,rc,r,i),Object(Vt["r"])(ac,ac,n,a),Object(Vt["m"])(nc,rc,ac),Object(It["k"])(e.eye,e.eye,t),Object(It["n"])(e.eye,e.eye,nc),Object(It["g"])(e.eye,e.eye,t),Object(It["k"])(e.center,e.center,t),Object(It["n"])(e.center,e.center,nc),Object(It["g"])(e.center,e.center,t),Object(It["k"])(e.up,e.up,t),Object(It["n"])(e.up,e.up,nc),Object(It["g"])(e.up,e.up,t),e.markViewDirty()}function Uo(e,t,i,r,a,n,s=jo.Pole,o=jo.Angle){const c=Math.abs(r)>Math.PI-o||Math.abs(r)<o,l=Math.abs(e[2])<i*s||Math.abs(t)>i;return!!(c&&l&&n.aboveGround&&a<jo.Tilt)}function Go(e,t,i,r,a,n){if(n)Et["a"].fromPoints(i,r,ic),po(t,e,ic);else{const n=Do(i,r,dc,t,e[3],a);po(t,e,Et["a"].wrapAxisAngle(dc,n))}}function Bo(e,t,i,r,a,n,s){const o=s?20:1,c=1e-12;let l,h;Object(It["l"])(sc,r),lc.copyFrom(t);for(let d=0;d<o&&Object(It["m"])(i,sc)>c&&(l=Object(It["m"])(i,sc),ko(i,sc,$o,Zo,tc,lc,e,a,n,s),zo(lc,e,Zo,tc[1],$o,tc[0]),Fo(sc,sc,e,Zo,tc[1],$o,tc[0]),h=Object(It["m"])(i,sc),h<l||0===d);d++)t.copyFrom(lc)}function Ho(e,t,i,r,a,n,s){Uo(i,Object(It["i"])(t.up,i),e[3],-Xe["g"].normalize(Object(Qe["f"])(a)),n,t,jo.Pole,jo.Angle)?Bo(e,t,i,r,-Xe["g"].normalize(Object(Qe["f"])(a)),n,s):Go(e,t,i,r,n,s)}function No(e,t,i,r,a,n){const{eye:s}=e;co([0,0,1],s,Zo,$o,Qo);const o=t.translation[0]*i.pan,c="zoom"===a.mode?0:t.translation[1]*i.pan,l=Math.max(Math.sqrt(Math.abs(1-Object(It["i"])(e.center,Zo)**2/Object(It["q"])(e.center)**2)),.5),h=(Math.sin(n)*c+Math.cos(n)*o)/l,d=-Math.cos(n)*c+Math.sin(n)*o;switch(Object(Vt["r"])(r.pan.matrix,r.pan.matrix,h,Zo),r.pan.enabled=!0,a.mode){case"pan":Object(Vt["r"])(r.pan.matrix,r.pan.matrix,d,$o),r.pan.enabled=!0;break;case"zoom":r.zoom=-t.translation[1]*i.zoom}}function qo(e,t,i,r,a){const{eye:n,viewRight:s}=e,o=Object(It["h"])(Hs["d"].get(),s,n),c=t.translation[0]*i.pan;switch(0!==c&&(Object(Vt["r"])(r.pan.matrix,r.pan.matrix,-c,o),r.pan.enabled=!0),a.mode){case"pan":{const e=t.translation[1]*i.pan;0!==e&&(Object(Vt["r"])(r.pan.matrix,r.pan.matrix,e,s),r.pan.enabled=!0);break}case"zoom":r.zoom=-t.translation[1]*i.zoom}}function Wo(e,t,i,r,a,n,s,o,c){Uo(e.center,Object(It["i"])(e.up,e.center),Object(It["q"])(e.center),-Xe["g"].normalize(Object(Qe["f"])(n)),s,t)?No(t,i,r,o,c,-Xe["g"].normalize(Object(Qe["f"])(a))):qo(t,i,r,o,c)}const Zo=Object(M["e"])(),$o=Object(M["e"])(),Qo=Object(M["e"])(),Xo=Object(M["e"])(),Yo=Object(M["e"])(),Ko=Object(M["e"])(),Jo=Object(M["e"])(),ec=Object(M["e"])(),tc=Object(hi["b"])(),ic=Et["a"].create(),rc=Object(kt["b"])(),ac=Object(kt["b"])(),nc=Object(kt["b"])(),sc=Object(M["e"])(),oc=Object(M["e"])(),cc=Object(M["e"])(),lc=new Yn["a"],hc=Object(M["e"])(),dc=Object(M["e"])(),uc={origin:Object(M["e"])(),direction:Object(M["e"])()},pc={origin:Object(M["e"])(),direction:Object(M["e"])()},fc=.6,mc=4,bc=12,gc=60,vc=20;let yc=class extends Us{constructor(){super(...arguments),this.zoomLocation=Object(M["e"])(),this.tmpCamera=new Yn["a"],this.tmpViewDir=Object(M["e"])(),this.tmpRayDir={origin:Object(M["e"])(),direction:Object(M["e"])()},this.targetOnSphere=Object(M["e"])(),this.tmpCenter=Object(M["e"])(),this.constraintOptions={selection:7,interactionType:1,interactionFactor:null,interactionStartCamera:new Yn["a"],interactionDirection:null,tiltMode:0},this.sphere=Et["h"].create()}initialize(){this.intersector=new Gr["a"](this.view.state.mode)}zoomStep(e,t){if(!this.active)return;const i=this.view.state,{interactionStartCamera:r}=this.constraintOptions;this.animation.finished?r.copyFrom(i.camera):this.animation.cameraAt(1,r);let a=!1,n=!1;this.intersectionHelper.intersectScreen(t,this.zoomLocation)&&(a=e>0,n=!0),this.tmpCamera.copyFrom(i.camera),a?this.intersectionHelper.intersectRay(this.tmpCamera.ray,this.intersector,this.tmpCenter)&&(this.tmpCamera.center=this.tmpCenter):this.intersectionHelper.intersectRay(this.tmpCamera.ray,this.intersector,this.zoomLocation)?this.tmpCamera.center=this.zoomLocation:Object(It["l"])(this.zoomLocation,this.tmpCamera.center),this.updateCamera(this.tmpCamera,e,this.zoomLocation,t,n),this.begin(this.tmpCamera)}animationSettings(){return{apex:null,duration:.6,easing:Ta}}updateCamera(e,t,i,r,a){const n=Object(V["e"])(this.view.spatialReference);if(Co(e,r,a,n)===_o.Horizontal||Object(u["a"])("disable-feature:context-navigation")){let a=fc**t;this.sphere[3]=Object(It["q"])(i),Object(It["k"])(this.tmpViewDir,e.center,e.eye);const n=Object(It["q"])(this.tmpViewDir);let s=n*a;if(a<=1&&s<mc&&(s=mc,a=s/n),Math.abs(n-s)<1e-6)return;const o=Object(It["q"])(e.center);if(this.sphere[3]!==o){const t=this.sphere[3]+a*(o-this.sphere[3]);Object(It["f"])(e.center,e.center,t/o)}Object(It["f"])(this.tmpViewDir,this.tmpViewDir,-a),Object(It["g"])(e.eye,e.center,this.tmpViewDir),Nn(this.view,e,this.constraintOptions),Object(It["m"])(i,e.center)>1e-12&&Et["h"].intersectScreen(this.sphere,e,r,this.targetOnSphere)&&Ho(this.sphere,e,i,this.targetOnSphere,this.view.camera.heading,this.view.camera.tilt,!0)}else{let a=fc**Math.abs(t);const n=t>0?1:-1;let s;Et["g"].fromScreenAtEye(e,r,this.tmpRayDir),Object(It["s"])(this.tmpRayDir.direction,this.tmpRayDir.direction),this.view.camera.position.hasZ&&(s=Math.abs(this.view.camera.position.z));let o=Math.max(bc*s,vc);const c=this.view._stage.renderView.getMinimalDepthForArea(r[0],r[1],this.view._stage.camera,gc);o=o>c?c:o,Object(It["f"])(this.tmpRayDir.direction,this.tmpRayDir.direction,o),Object(It["g"])(i,this.tmpRayDir.origin,this.tmpRayDir.direction);let l=o*a;if(t>0&&l<mc&&(l=mc,a=l/o),Math.abs(o-l)<1e-6)return;Object(It["f"])(this.tmpRayDir.direction,this.tmpRayDir.direction,n*(1-a)),Object(It["g"])(e.eye,e.eye,this.tmpRayDir.direction),Object(It["g"])(e.center,e.center,this.tmpRayDir.direction)}ca(this.view,e)}};yc=Object(d["a"])([Object(y["a"])("esri.views.3d.state.controllers.global.ZoomStepController")],yc);var Oc=i("1091");const _c=.6,xc=4,jc=60,wc=14,Sc=20;let Cc=class extends Us{constructor(){super(...arguments),this.zoomLocation=Object(M["e"])(),this.tmpCamera=new Yn["a"],this.tmpRayDir=Object(M["e"])(),this.tmpCenter=Object(M["e"])(),this.constraintOptions={selection:15,interactionType:1,interactionFactor:null,interactionStartCamera:new Yn["a"],interactionDirection:null,tiltMode:0}}zoomStep(e,t){if(!this.active)return;const i=this.view.state,{interactionStartCamera:r}=this.constraintOptions;this.animation.finished?r.copyFrom(i.camera):this.animation.cameraAt(1,r),this.tmpCamera.copyFrom(i.camera);const a=new Gr["a"](this.view.state.mode);e>0?(this.intersectionHelper.intersectScreenFreePointFallback(t,this.zoomLocation),this.intersectionHelper.intersectRay(this.tmpCamera.ray,a,this.tmpCenter)&&(this.tmpCamera.center=this.tmpCenter)):this.intersectionHelper.intersectRay(this.tmpCamera.ray,a,this.zoomLocation)?this.tmpCamera.center=this.zoomLocation:Object(It["l"])(this.zoomLocation,this.tmpCamera.center);const n=_c**e;if(!Object(Oc["a"])()){let e=this.view._stage.renderView.getMinimalDepthForArea(t[0],t[1],this.view._stage.camera,jc);const i=Math.max(wc*Math.abs(this.view.camera.position.z),Sc);if(e=e?Math.min(e,i):i,e){const t=Object(M["e"])();Object(It["k"])(t,this.zoomLocation,this.tmpCamera.eye),e<Object(It["q"])(t)&&(Object(It["s"])(t,t),Object(It["g"])(this.zoomLocation,this.tmpCamera.eye,Object(It["f"])(t,t,e)))}}this.updateCamera(this.tmpCamera,n,this.zoomLocation),this.begin(this.tmpCamera)}animationSettings(){return{apex:null,duration:.6,easing:Ta}}updateCamera(e,t,i){Object(It["k"])(this.tmpRayDir,i,e.eye);const r=Object(It["q"])(this.tmpRayDir);let a=r*t;t<=1&&a<xc&&(a=xc,t=a/r),Math.abs(r-a)<1e-6||(Object(It["f"])(this.tmpRayDir,this.tmpRayDir,t),Object(It["k"])(e.eye,i,this.tmpRayDir),Object(It["j"])(e.center,e.center,i,1-t),Nn(this.view,e,this.constraintOptions))}};Cc=Object(d["a"])([Object(y["a"])("esri.views.3d.state.controllers.local.ZoomStepController")],Cc);class Tc extends Qr["a"]{constructor(e,t){super(!0),this.view=e,this.registerIncoming("double-click",t,e=>this.handleDoubleClick(e))}handleDoubleClick(e){const t=e.data;if(Object(Xr["b"])(t,"primary")){const i=this.view.state.isGlobal?new yc({view:this.view,mode:"animation"}):new Cc({view:this.view,mode:"animation"});this.view.state.switchCameraController(i),i.zoomStep(Math.log(.5)/Math.log(.6),Object(A["g"])(t.x,t.y)),e.stopPropagation()}}}let Pc=class extends Fs{constructor(){super(...arguments),this.beginCamera=new Yn["a"],this.currentCamera=new Yn["a"]}get isInteractive(){return!0}stepController(e,t){t.copyViewFrom(this.currentCamera),this.currentCamera.copyFrom(t)}onControllerStart(e){this.state=ks.Running,this.beginCamera.copyFrom(e),this.currentCamera.copyFrom(e)}onControllerEnd(e){e.copyViewFrom(this.currentCamera)}};Pc=Object(d["a"])([Object(y["a"])("esri.views.3d.state.controllers.InteractiveController")],Pc);const Ac=7,Rc=90;let Mc=class extends Pc{constructor(e){super(e),this.view=null,this.pivot="center",this.lastPoint=Object(hi["b"])(),this.tmpWorldUp=Object(M["e"])(),this.tmpViewDir=Object(M["e"])(),this.tmpRotCurPoint=Object(hi["b"])(),this.tmpTransf=Object(kt["b"])(),this.tmpAxis=Object(M["e"])(),this.tmpPivotPoint=Object(M["e"])(),this.pivotPos=Object(M["e"])(),this.constraintOptions={selection:15,interactionType:2,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:0}}get intersectionHelper(){return this.view.sceneIntersectionHelper}initialize(){this.rotScale="center"===this.pivot?3:1.5}begin(e){if(this.active){switch(this.pivot){case"eye":Object(It["l"])(this.pivotPos,this.beginCamera.eye),this.constraintOptions.interactionType=3,this.constraintOptions.tiltMode=1,this.constraintOptions.selection=0;break;case"center":this.intersectionHelper.intersectRayFreePointFallback(this.beginCamera.ray,this.pivotPos)||Object(It["l"])(this.pivotPos,this.beginCamera.center),Object(u["a"])("disable-feature:context-navigation")||this.constrainPivotPoint(e),this.beginCamera.center=this.pivotPos,this.constraintOptions.interactionType=2,this.constraintOptions.tiltMode=0,this.constraintOptions.selection=11}this.constraintOptions.interactionStartCamera=this.beginCamera,ho(this.beginCamera,e,this.lastPoint)}}constrainPivotPoint(e){const t=this.beginCamera,i=Object(M["e"])();let r;Object(It["k"])(i,this.pivotPos,t.eye),this.view.camera.position.hasZ&&(r=Math.abs(this.view.camera.position.z));let a=Object(It["q"])(i);this.view.camera.position.hasZ&&a>Ac*r&&(a=Ac*r);const n=Object(V["e"])(this.view.spatialReference),s=Object(A["g"])(t.width/t.pixelRatio*.5,t.height/t.pixelRatio*.5),o=Co(this.beginCamera,s,!0,n);let c=this.view._stage.renderView.getMinimalDepthForArea(t.fullWidth/t.pixelRatio*.5,t.fullHeight/t.pixelRatio*.5,t,Rc,2.5),l=this.view._stage.renderView.getMinimalDepthForArea(e[0],e[1],t,Rc);void 0===c&&void 0===l||(c=void 0===c?l:c,l=void 0===l||o===_o.Horizontal?c:l,a=c>l?l:c),Object(It["s"])(i,i),Object(It["l"])(this.pivotPos,Object(It["g"])(this.tmpPivotPoint,t.eye,Object(It["f"])(this.tmpPivotPoint,i,a)))}update(e){if(!this.active)return;let t;switch(this.pivot){case"eye":t=this.currentCamera.center;break;case"center":this.currentCamera.center=this.pivotPos,t=this.currentCamera.eye}this.applyRotation(this.currentCamera,e,t,this.pivotPos),Nn(this.view,this.currentCamera,this.constraintOptions)}end(){this.active&&this.finishController()}applyRotation(e,t,i,r){this.view.renderCoordsHelper.worldUpAtPosition(r,this.tmpWorldUp),ho(e,t,this.tmpRotCurPoint);let a=(this.lastPoint[1]-this.tmpRotCurPoint[1])*this.rotScale,n=(this.tmpRotCurPoint[0]-this.lastPoint[0])*this.rotScale;Object(It["k"])(this.tmpViewDir,i,r);const s=Object(It["q"])(this.tmpViewDir),o=Object(Qe["b"])(Object(It["i"])(this.tmpViewDir,this.tmpWorldUp)/s);if("eye"===this.pivot){a*=-.5;const e=.5*Math.PI-o,t=.5*Math.PI*.99;a=e-Math.max(-t,Math.min(t,e+a))}a=Object(Qe["d"])(a+o,tt.min,tt.max)-o,Object(Vt["i"])(this.tmpTransf),Object(It["h"])(this.tmpAxis,e.up,this.tmpViewDir),"center"===this.pivot&&(n=-n),Object(Vt["r"])(this.tmpTransf,this.tmpTransf,n,this.tmpWorldUp),Object(Vt["r"])(this.tmpTransf,this.tmpTransf,a,this.tmpAxis),Object(It["n"])(this.tmpViewDir,this.tmpViewDir,this.tmpTransf),Object(It["g"])(i,r,this.tmpViewDir),Object(It["n"])(e.up,e.up,this.tmpTransf),Object(di["c"])(this.lastPoint,this.tmpRotCurPoint),e.markViewDirty()}};Object(d["a"])([Object(g["b"])({constructOnly:!0})],Mc.prototype,"view",void 0),Object(d["a"])([Object(g["b"])()],Mc.prototype,"pivot",void 0),Mc=Object(d["a"])([Object(y["a"])("esri.views.3d.state.controllers.RotateController")],Mc);class Ec extends Qr["a"]{constructor(e,t,i,r){super(!0),this.view=e,this.pointerAction=t,this.pivotPoint=i,this.registerIncoming("drag",r,e=>this.handleDrag(e))}handleDrag(e){const t=e.data;if(t.pointers.size>1)return;if(!Object(Xr["a"])(e.data,this.pointerAction))return;const i=Object(A["g"])(t.center.x,t.center.y);switch(t.action){case"start":this.cameraController&&(this.cameraController.end(),this.cameraController=null),this.cameraController=new Mc({view:this.view,pivot:this.pivotPoint}),this.view.state.switchCameraController(this.cameraController),this.cameraController.begin(i);break;case"update":this.cameraController&&this.cameraController.update(i);break;case"end":this.cameraController&&(this.cameraController.end(),this.cameraController=null)}e.stopPropagation()}}const Dc=30,Ic=70;let Lc=class extends Pc{constructor(e){super(e),this.view=null,this.pickPoint=Object(M["e"])(),this.tmpP0=Object(hi["b"])(),this.panAxisAngle=Et["a"].create(),this.tmpRayDir=Object(M["e"])(),this.targetOnSphere=Object(M["e"])(),this.tmpRay={origin:Object(M["e"])(),direction:Object(M["e"])()},this.dragBeginPoint=Object(A["g"])(),this.normalizedAnchorPoint=Object(hi["b"])(),this.constraintOptions={selection:7,interactionType:1,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:0},this.sphere=Et["h"].create(),this.hasPickPoint=!1}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;Object(di["c"])(this.dragBeginPoint,e),ho(this.beginCamera,e,this.normalizedAnchorPoint);const t=Object(V["e"])(this.view.spatialReference),i=So(this.intersectionHelper,this.beginCamera,e,!1,t);if(this.navMode=Co(this.beginCamera,e,i.hasGeometryIntersection,t),this.navMode===_o.Horizontal||Object(u["a"])("disable-feature:context-navigation"))this.hasPickPoint=!!i.scenePickPoint,this.pickPoint=i.scenePickPoint,this.sphere=i.sphere;else{let t;Et["g"].fromScreenAtEye(this.beginCamera,e,this.tmpRay),Object(It["s"])(this.tmpRay.direction,this.tmpRay.direction),this.view.camera.position.hasZ&&(t=Math.abs(this.view.camera.position.z));let i=Dc*t;const r=this.view._stage.renderView.getMinimalDepthForArea(e[0],e[1],this.view._stage.camera,Ic);i=i>r?r:i,this.hasPickPoint=!0,Object(It["f"])(this.tmpRay.direction,this.tmpRay.direction,i),Object(It["g"])(this.pickPoint,this.tmpRay.origin,this.tmpRay.direction)}this.constraintOptions.interactionStartCamera=this.beginCamera}update(e){if(this.active){if(this.currentCamera.eye=this.beginCamera.eye,this.currentCamera.center=this.beginCamera.center,this.currentCamera.up=this.beginCamera.up,this.navMode===_o.Horizontal||Object(u["a"])("disable-feature:context-navigation")){Object(It["k"])(this.tmpRayDir,this.currentCamera.center,this.currentCamera.eye);const t=Object(It["q"])(this.tmpRayDir);ho(this.currentCamera,e,this.tmpP0);const i=12*(this.normalizedAnchorPoint[1]-this.tmpP0[1]);let r=t*2**i;const a=this.view.state.constraints.minimumPoiDistance;if(i<0&&r<a&&(r=a),Math.abs(t-r)<1e-6)return;if(this.hasPickPoint&&r<t){const e=1-(1-r/t)*(1-this.sphere[3]/Object(It["q"])(this.currentCamera.center));Object(It["f"])(this.currentCamera.center,this.currentCamera.center,e)}Object(It["f"])(this.tmpRayDir,this.tmpRayDir,-r/t),Object(It["g"])(this.currentCamera.eye,this.currentCamera.center,this.tmpRayDir),this.constraintOptions.interactionFactor=Wn(this.dragBeginPoint,e),Nn(this.view,this.currentCamera,this.constraintOptions),this.hasPickPoint&&(Ao(this.sphere,this.currentCamera,this.dragBeginPoint,this.targetOnSphere),Et["a"].fromPoints(this.pickPoint,this.targetOnSphere,this.panAxisAngle),po(this.currentCamera,this.sphere,this.panAxisAngle))}else{const t=Object(It["q"])(this.tmpRay.direction);ho(this.currentCamera,e,this.tmpP0);const i=12*(this.normalizedAnchorPoint[1]-this.tmpP0[1]);let r=t*2**i;const a=this.view.state.constraints.minimumPoiDistance;if(i<0&&r<a&&(r=a),Math.abs(t-r)<1e-6)return;Object(It["f"])(this.tmpRayDir,this.tmpRay.direction,1-r/t),Object(It["g"])(this.currentCamera.eye,this.currentCamera.eye,this.tmpRayDir),Object(It["g"])(this.currentCamera.center,this.currentCamera.center,this.tmpRayDir)}ca(this.view,this.currentCamera)}}end(){this.active&&this.finishController()}};Object(d["a"])([Object(g["b"])({constructOnly:!0})],Lc.prototype,"view",void 0),Lc=Object(d["a"])([Object(y["a"])("esri.views.3d.state.controllers.global.ZoomController")],Lc);const Vc=30,kc=70;let Fc=class extends Pc{constructor(e){super(e),this.view=null,this.tmpP=Object(M["e"])(),this.tmpDir=Object(M["e"])(),this.tmpN=Object(M["e"])(),this.tmpP0=Object(hi["b"])(),this.tmpPoi=Object(M["e"])(),this.tmpRayDir=Object(M["e"])(),this.dragBeginPoint=Object(A["g"])(),this.normalizedAnchorPoint=Object(hi["b"])(),this.constraintOptions={selection:15,interactionType:1,interactionFactor:0,interactionStartCamera:null,interactionDirection:Object(M["e"])(),tiltMode:0},this.plane=Et["f"].create()}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;let t;Object(di["c"])(this.dragBeginPoint,e),ho(this.beginCamera,e,this.normalizedAnchorPoint),this.intersectionHelper.intersectScreenFreePointFallback(e,this.tmpP),Object(It["k"])(this.tmpDir,this.tmpP,this.beginCamera.eye),Object(It["s"])(this.tmpDir,this.tmpDir),this.view.camera.position.hasZ&&(t=Math.abs(this.view.camera.position.z));let i=Vc*t;const r=this.view._stage.renderView.getMinimalDepthForArea(e[0],e[1],this.view._stage.camera,kc);i=i>r?r:i,Object(It["f"])(this.tmpDir,this.tmpDir,i),Object(It["g"])(this.tmpP,this.beginCamera.eye,this.tmpDir),Object(It["k"])(this.tmpN,this.beginCamera.eye,this.beginCamera.center),Object(It["s"])(this.tmpN,this.tmpN),this.tmpN[1]<0&&Object(It["u"])(this.tmpN,this.tmpN),Et["f"].fromPositionAndNormal(this.tmpP,this.tmpN,this.plane),this.constraintOptions.interactionStartCamera=this.beginCamera}update(e){if(!this.active)return;fo(this.plane,this.currentCamera,this.dragBeginPoint,this.tmpPoi)||Object(It["l"])(this.tmpPoi,this.currentCamera.center),ho(this.currentCamera,e,this.tmpP0);let t=4*(this.tmpP0[1]-this.normalizedAnchorPoint[1]);Object(di["c"])(this.normalizedAnchorPoint,this.tmpP0),Object(It["k"])(this.tmpRayDir,this.tmpPoi,this.currentCamera.eye);const i=Object(It["q"])(this.tmpRayDir);let r=i*(1-t);Object(It["l"])(this.constraintOptions.interactionDirection,this.tmpRayDir),Object(It["f"])(this.constraintOptions.interactionDirection,this.constraintOptions.interactionDirection,Object(Qe["s"])(t)/i);const a=this.view.state.constraints.minimumPoiDistance;t>=0&&r<a&&(r=a,t=-(r-i)/i),Math.abs(i-r)<1e-6||(Object(It["f"])(this.tmpRayDir,this.tmpRayDir,t),Object(It["g"])(this.currentCamera.eye,this.currentCamera.eye,this.tmpRayDir),Object(It["j"])(this.currentCamera.center,this.currentCamera.center,this.tmpPoi,t),this.tmpPoi[2]>this.beginCamera.center[2]?this.currentCamera.center[2]=Math.max(this.beginCamera.center[2],this.currentCamera.center[2]):this.currentCamera.center[2]=Math.min(this.beginCamera.center[2],this.currentCamera.center[2]),this.currentCamera.markViewDirty(),this.constraintOptions.interactionFactor=Wn(this.dragBeginPoint,e),Nn(this.view,this.currentCamera,this.constraintOptions))}end(){this.active&&this.finishController()}};Object(d["a"])([Object(g["b"])({constructOnly:!0})],Fc.prototype,"view",void 0),Fc=Object(d["a"])([Object(y["a"])("esri.views.3d.state.controllers.local.ZoomController")],Fc);class zc extends Qr["a"]{constructor(e,t,i){super(!0),this.view=e,this.pointerAction=t,this.registerIncoming("drag",i,e=>this.handleDrag(e))}handleDrag(e){const t=e.data;if(t.pointers.size>1)return;if(!Object(Xr["a"])(e.data,this.pointerAction))return;const i=Object(A["g"])(t.center.x,t.center.y);switch(t.action){case"start":this.cameraController&&(this.cameraController.end(),this.cameraController=null),this.view.state.isGlobal?this.cameraController=new Lc({view:this.view}):this.cameraController=new Fc({view:this.view}),this.view.state.switchCameraController(this.cameraController),this.cameraController.begin(i);break;case"update":this.cameraController&&this.cameraController.update(i);break;case"end":this.cameraController&&(this.cameraController.end(),this.cameraController=null)}e.stopPropagation()}}var Uc=i("85d4");const Gc=Object(M["e"])(),Bc=Object(M["e"])();function Hc(){return{direction:Object(M["e"])(),up:Object(M["e"])()}}function Nc(e,t,i,r,a){let n=Object(It["s"])(Gc,e),s=Object(It["i"])(n,r);const o=s>0;s=Math.abs(s),s>.99&&(s=Math.abs(Object(It["i"])(t,r)),s<.99?(Object(It["l"])(n,t),o&&Object(It["f"])(n,n,-1)):n=null);let c=0;if(n){Object(It["f"])(Bc,r,Object(It["i"])(r,n)),Object(It["k"])(n,n,Bc);const e=Object(It["i"])(n,a)/(Object(It["q"])(n)*Object(It["q"])(a));Object(It["h"])(Bc,n,a),c=(Object(It["i"])(Bc,r)>0?1:-1)*Object(Qe["q"])(Object(Qe["b"])(e))}const l=Object(Qe["q"])(Object(Qe["b"])(-Object(It["i"])(r,e)/Object(It["q"])(e)));return i?(i.heading=c,i.tilt=l,i):{heading:c,tilt:l}}const qc=Object(M["g"])(0,1,0),Wc=Object(M["g"])(0,0,1),Zc=Object(kt["b"])(),$c=Object(M["e"])(),Qc=Object(M["e"])();function Xc(e,t,i,r=Hc()){Object(Vt["i"])(Zc);const{direction:a,up:n}=r;return Object(Vt["g"])(Zc,Zc,-Object(Qe["f"])(t)),Object(Vt["e"])(Zc,Zc,Object(Qe["f"])(i)),Object(It["n"])(a,Wc,Zc),Object(It["f"])(a,a,-1),Object(It["n"])(n,qc,Zc),r}function Yc(e,t,i,r){return Nc(t,i,r,Wc,qc)}function Kc(e,t,i,r){const a=Xc(e,i,r),n=Object(M["e"])();return Object(It["f"])(n,a.direction,-t),Object(It["g"])(n,n,e),{up:a.up,eye:n,heading:i,tilt:r}}function Jc(e){return Object(Qe["q"])(e)}function el(e){return Object(Qe["f"])(e)}function tl(e,t,i,r,a){const n=e.renderSpatialReference,s=e.map&&e.spatialReference||t.spatialReference;return Object(z["t"])(t,$c,n),Object(z["t"])(t,Qc,n),$c[0]-=i/2,Qc[0]+=i/2,$c[1]-=r/2,Qc[1]+=r/2,Object(z["y"])($c,n,$c,s),Object(z["y"])(Qc,n,Qc,s),a?(a.xmin=$c[0],a.ymin=$c[1],a.xmax=Qc[0],a.ymax=Qc[1],a.spatialReference=s):a=new T["a"]($c[0],$c[1],Qc[0],Qc[1],s),a}var il=Object.freeze({__proto__:null,headingTiltToDirectionUp:Xc,directionToHeadingTilt:Yc,eyeForCenterWithHeadingTilt:Kc,lookAtTiltToEyeTilt:Jc,eyeTiltToLookAtTilt:el,toExtent:tl});const rl=Object(M["g"])(0,0,1),al=Object(It["s"])(Object(M["e"])(),Object(M["g"])(1,1,1)),nl=new Xe["a"](-180,180),sl=Object(kt["b"])(),ol=Object(M["e"])(),cl=Object(M["e"])();function ll(e,t,i,r=Hc()){Object(It["h"])(ol,e,rl),0===Object(It["i"])(ol,ol)&&Object(It["h"])(ol,e,al),Object(Vt["i"])(sl),Object(Vt["r"])(sl,sl,-Object(Qe["f"])(t),e),Object(Vt["r"])(sl,sl,-Object(Qe["f"])(i),ol);const{up:a,direction:n}=r;return Object(It["h"])(a,ol,e),Object(It["s"])(a,a),Object(It["n"])(a,a,sl),Object(It["s"])(n,e),Object(It["u"])(n,n),Object(It["n"])(n,n,sl),r}function hl(e,t,i,r){const a=ol,n=cl;return Object(It["s"])(a,e),Object(It["h"])(cl,a,rl),0===Object(It["i"])(cl,cl)&&Object(It["h"])(cl,a,al),Object(It["h"])(n,cl,a),Nc(t,i,r,a,n)}function dl(e,t,i,r){const a={eye:Object(M["e"])(),up:null,tilt:r,heading:i},n=ol;n[0]=e[0],n[1]=e[2],n[2]=-e[1];const s=t,o=Object(Qe["f"])(i),c=Object(Qe["f"])(r),l=Math.sin(o),h=Math.cos(o),d=Math.sin(c),u=Math.cos(c),p=Object(It["q"])(n);let f;if(Math.abs(c)<1e-8)f=s+p;else{const e=p/d,t=Object(Qe["c"])(s/e),i=Math.PI-c-t;f=e*Math.sin(i)}const m=u*s,b=s*s*(d*d),g=h*h*b,v=f-m,y=v*v,O=g*(g+y-n[1]*n[1]);if(O<0)return Object(It["f"])(a.eye,n,f/p),a.tilt=0,a;const _=Math.sqrt(O),x=n[1]*v,j=g+y;let w;if(w=h>0?-_+x:_+x,Math.abs(j)<1e-8)return p<1e-8?(a.eye[0]=0,a.eye[1]=0,a.eye[2]=s):Object(It["f"])(a.eye,n,f/p),a.tilt=0,ul(a.eye),pl(a,e);a.eye[1]=w/j;const S=l*l*b,C=d*s,T=h*C*a.eye[1],P=a.eye[1]*a.eye[1],A=1-P,R=Math.sqrt(A),E=g*P+S-2*T*R*v+A*y;return Math.abs(E)<1e-8?(Object(It["f"])(a.eye,n,f/p),a.tilt=0,ul(a.eye),pl(a,e)):(a.eye[0]=(A*(f*n[0]-m*n[0])-C*R*(n[0]*a.eye[1]*h+n[2]*l))/E,a.eye[2]=(A*(f*n[2]-m*n[2])-C*R*(n[2]*a.eye[1]*h-n[0]*l))/E,Object(It["f"])(a.eye,a.eye,f),ul(a.eye),pl(a,e))}function ul(e){const t=e[1];e[1]=-e[2],e[2]=t}function pl(e,t){const i=ll(t,e.heading,e.tilt);return e.up=i.up,e}function fl(e,t,i){const r=Object(It["q"])(t),a=Math.sqrt(i*i+r*r-2*i*r*Math.cos(Math.PI-e)),n=Object(Qe["c"])(i/(a/Math.sin(e)));return Object(Qe["q"])(e-n)}function ml(e,t,i){const r=Object(Qe["f"])(e),a=Object(It["q"])(t);return Object(Qe["c"])(i/(a/Math.sin(r)))+r}function bl(e,t,i,r,a){let n,s,o,l;const h=t.latitude,d=t.longitude,u=br(h,i,Object(V["e"])(e.spatialReference).radius)/2;n=d-u,s=d+u;const p=Object(Qe["f"])(h),f=Object(V["e"])(e.spatialReference).radius,m=(1+Math.sin(p))/(1-Math.sin(p)),b=(m+1)*Math.tan(r/f/2),g=b*b;function v(e){const t=Math.PI/2;return(e=Xe["e"].normalize(e,-t))>t&&(e=Math.PI-e),e}if(o=1.5*Math.PI-2*Math.atan(.5*(b+Math.sqrt(4*m+g))),l=o+r/f,o=v(o),l=v(l),l<o){const e=l;l=o,o=e}if(o=Math.max(Object(Qe["q"])(o),-90),l=Math.min(Object(Qe["q"])(l),90),s=nl.monotonic(n,s),s-n>180){const e=(s-n-180)/2;n+=e,s-=e}const y=e.spatialReference&&e.spatialReference.isGeographic?e.spatialReference:c["a"].WGS84;return a?(a.xmin=n,a.ymin=o,a.xmax=s,a.ymax=l,a.spatialReference=y):a=new T["a"](n,o,s,l,y),e.spatialReference&&e.spatialReference.isWebMercator&&Object(S["b"])(a,!1,a),a}var gl=Object.freeze({__proto__:null,headingTiltToDirectionUp:ll,directionToHeadingTilt:hl,eyeForCenterWithHeadingTilt:dl,lookAtTiltToEyeTilt:fl,eyeTiltToLookAtTilt:ml,toExtent:bl});const vl=f["a"].getLogger("esri.views.3d.support.cameraUtils"),yl=39.37,Ol=96,_l=1,xl=8,jl=5,wl=1,Sl=Object(M["e"])(),Cl=Object(M["e"])(),Tl={heading:0,tilt:0},Pl=new C["a"],Al=new Xe["a"](-20037508.342788905,20037508.342788905),Rl=new Xe["a"](-180,180);function Ml(e){return e.spatialReference||c["a"].WGS84}function El(e){return"global"===e.viewingMode?gl:il}function Dl(e,t,i,r,a){return El(e).headingTiltToDirectionUp(t,i,r,a)}function Il(e,t){if(Object(p["j"])(t))return null;const i=e.renderSpatialReference,r=El(e).headingTiltToDirectionUp,a=Object(M["e"])();if(!Object(z["t"])(t.position,a,i))return null;const n=r(a,t.heading,t.tilt);Object(It["f"])(n.direction,n.direction,e.state.camera.distance),Object(It["g"])(n.direction,n.direction,a);const s=Jr(e,a,n.direction,n.up);return s.fov=Object(Qe["f"])(t.fov),s}const Ll=Object(M["e"])();function Vl(e,t,i){const r=e.renderSpatialReference,a=Gl(e,t.eye,t.viewForward,t.up,Tl);let n=Ml(e);return Object(z["y"])(t.eye,r,Ll,n)||(n=c["a"].WGS84,Object(z["y"])(t.eye,r,Ll,n)),Object(p["j"])(i)?new E["a"](new C["a"](Ll,n),a.heading,a.tilt,Object(Qe["q"])(t.fov)):(i.position.x=Ll[0],i.position.y=Ll[1],i.position.z=Ll[2],i.position.spatialReference=n,i.heading=a.heading,i.tilt=a.tilt,i.fov=Object(Qe["q"])(t.fov),i)}function kl(e,t,i){const r=e.state.camera,a=r.width/2/r.pixelRatio;return 1===e.renderCoordsHelper.viewingMode&&null!=i&&(t*=Math.cos(Object(Qe["f"])(i))),t/=e.renderCoordsHelper.unitInMeters,a/(Ol*yl/t)/Math.tan(r.fovX/2)}function Fl(e,t,i){const r=e.state.camera,a=t*Math.tan(r.fovX/2),n=r.width/2/r.pixelRatio;let s=Ol*yl/(n/a);return 1===e.renderCoordsHelper.viewingMode&&(s/=Math.cos(Object(Qe["f"])(i))),s*=e.renderCoordsHelper.unitInMeters,s}function zl(e,t,i,r,a,n){return Ul(e,t,kl(e,i,t.latitude),r,a,n)}function Ul(e,t,i,r,a,n){if(lh(n)){const s=new ch(n.signal);return Wl(e,r.heading,r.tilt,t,i,a,s),void s.resolver.promise.then(t=>{const i=rh(e,t,r.fov);if(!Object(p["j"])(i))return n.resolver.resolve(i);n.resolver.reject()},e=>n.resolver.reject(e))}const s=Wl(e,r.heading,r.tilt,t,i,a);return rh(e,s,r.fov,n)}function Gl(e,t,i,r,a){return El(e).directionToHeadingTilt(t,i,r,a)}function Bl(e,t){return!!(e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(t,Pl,e.spatialReference)&&Object(p["u"])(Object(xe["b"])(e.elevationProvider,Pl),0)>Pl.z-wl)}async function Hl(e,t,i){if(!e.renderCoordsHelper.fromRenderCoords(t,Pl,e.spatialReference))return!1;const r=await e.elevationProvider.queryElevation(Pl.x,Pl.y,Pl.z,Pl.spatialReference,"ground",i);return Object(p["u"])(r,0)>Pl.z-wl}async function Nl(e,t,i){const r=Object(M["e"])();if(t)if(t instanceof C["a"]){if(Object(z["t"])(t,r,e.renderSpatialReference),null==t.z&&null!=e.basemapTerrain){const a=await e.elevationProvider.queryElevation(t.x,t.y,t.z,t.spatialReference,"ground",i);return Object(p["k"])(a)&&e.renderCoordsHelper.setAltitude(a,r),r}}else Object(It["l"])(r,t);else Object(It["l"])(r,e.state.camera.center);return r}function ql(e,t){const i=Object(M["e"])();if(t&&t instanceof C["a"]){if(Object(z["t"])(t,i,e.renderSpatialReference),null==t.z&&null!=e.basemapTerrain){const r=Object(xe["b"])(e.elevationProvider,t);Object(p["k"])(r)&&e.renderCoordsHelper.setAltitude(r,i)}}else Object(It["l"])(i,t||e.state.camera.center);return i}function Wl(e,t,i,r,a,n,s){const o=r&&r instanceof C["a"]?r:null;if(lh(s))return Nl(e,r,s.signal).then(r=>{Zl(e,t,i,o,r,a,n,s)},e=>s.resolver.reject(e)),null;const c=ql(e,r);return Zl(e,t,i,o,c,a,n,s)}function Zl(e,t,i,r,a,n,s,o){if(Object(p["j"])(r)){const t=e.renderSpatialReference;if(r=Object(z["x"])(a,t,Ml(e)),Object(p["j"])(r))return null}n=Math.max(n,e.state.constraints.minimumPoiDistance);const c=Yl(e,t,i,a,n,s),l=(0,El(e).eyeForCenterWithHeadingTilt)(a,n,c.heading,c.tilt);if(1===s&&"global"===e.viewingMode&&i>0){const c=()=>{const c=th(e,a,n,eh(e,n,i,a));return Zl(e,t,c,r,a,n,s=i-c<1?0:1,o)},h=e.map.ground.navigationConstraint;if(!h||"stay-above"===h.type){if(Bl(e,l.eye))return c();if(lh(o))return Hl(e,l.eye,o.signal).then(e=>e?c():(o.resolver.resolve({eye:l.eye,up:l.up,center:Object(M["d"])(a),heading:l.heading,tilt:l.tilt}),null)),null}}const h=!o||lh(o)?{center:Object(M["e"])(),eye:Object(M["e"])(),up:Object(M["e"])(),tilt:0,heading:0}:o;return h.eye=l.eye,h.up=l.up,h.center=Object(M["d"])(a),h.heading=l.heading,h.tilt=l.tilt,lh(o)&&o.resolver.resolve(h),h}function $l(e,t,i,r,a,n=null){let s,o,c,l,h=0;if(null!=t.zmax&&null!=t.zmin&&(s=(t.zmax+t.zmin)/2,h=t.zmax-t.zmin),"global"===e.viewingMode){if(!U(t.spatialReference,"global"))return lh(n)&&n.resolver.reject(),null;const e=new C["a"](t.xmin,t.ymin,t.spatialReference),i=new C["a"](t.xmax,t.ymax,t.spatialReference),r=t.spatialReference.isGeographic?Rl:Al;o=new C["a"](r.center(e.x,i.x),(i.y+e.y)/2,t.spatialReference),null!=s&&(o.z=s);const a=Object(V["e"])(t.spatialReference),h=mr(o,e,i);c=h.lon,l=h.lat,r.diff(e.x,i.x)>r.range/2&&(c+=a.halfCircumference),c=Math.min(c,a.halfCircumference),l=Math.min(l,a.halfCircumference)}else{const i=Ml(e);c=t.xmax-t.xmin,l=t.ymax-t.ymin,o=new C["a"]({x:t.xmin+.5*c,y:t.ymin+.5*l,z:s,spatialReference:i})}const d=e.state.camera,u=1/Math.tan(d.fovX/2),f=1/Math.tan(d.fovY/2),m=1/Math.tan(d.fov/2),b=Math.max(.5*c*u,.5*l*f,.5*h*m)/_l;if(lh(n)){const t=new ch(n.signal);return Wl(e,i,r,o,b,a,t),void t.resolver.promise.then(t=>{const i=rh(e,t,e.camera.fov);if(!Object(p["j"])(i))return n.resolver.resolve(i);n.resolver.reject()},e=>n.resolver.reject(e))}const g=Wl(e,i,r,o,b,a);return rh(e,g,e.camera.fov,n)}function Ql(e,t,i){const r=e.renderSpatialReference,a=Object(z["x"])(i,r,Ml(e));if(Object(p["j"])(a))return null;const n=Math.tan(t.fovX/2),s=Math.tan(t.fovY/2),o=Object(It["B"])(t.eye,i),c=2*o*n*_l,l=2*o*s*_l;return"global"===e.viewingMode?bl(e,a,c,l):tl(e,a,c,l)}function Xl(e,t,i){const r=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(i/r)/Math.LN2>xl)return!0;const a=e.renderSpatialReference,n=Ml(e),s=Object(z["x"])(t,a,n),o=Object(z["x"])(e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,a,n);if(Object(p["j"])(s)||Object(p["j"])(o))return!1;const c=Math.tan(.5*e.state.camera.fov)*r;return o.distance(s)/c>jl}function Yl(e,t,i,r,a,n){let s=0;return 1===n&&Xl(e,r,a)?(t=0,s=Jl(e,a,i,r)):s=ih(e,r,a,i),s=e.state.constraints.clampTilt(a,s),{heading:t,tilt:i=th(e,r,a,s)}}const Kl=.7;function Jl(e,t,i,r){const a=e.state.constraints.tilt(t);a.max=Math.min(a.max,.5*Math.PI);const n=a.min*(1-Kl)+a.max*Kl,s=ih(e,r,t,i);return Math.min(s,n)}function eh(e,t,i,r){const a=e.state.constraints.tilt(t);let n=ih(e,r,t,i);return n=Math.min(n,.5*Math.PI),a.min*(1-Kl)+n*Kl}function th(e,t,i,r){return El(e).lookAtTiltToEyeTilt(r,t,i)}function ih(e,t,i,r){return El(e).eyeTiltToLookAtTilt(r,t,i)}function rh(e,t,i,r){if(Object(p["j"])(t))return null;const a=e.renderSpatialReference,n=Object(z["x"])(t.eye,a,Ml(e));return Object(p["j"])(n)?null:Object(p["k"])(r)?(r.position=n,r.heading=t.heading,r.tilt=t.tilt,r.fov=i,r):new E["a"](n,t.heading,t.tilt,i)}function ah(e,t){var i;const r=null==(i=e.basemapTerrain)?void 0:i.tilingScheme;if(r)return r.levelAtScale(t);vl.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")}function nh(e,t){var i;const r=null==(i=e.basemapTerrain)?void 0:i.tilingScheme;if(r)return r.scaleAtLevel(t);vl.error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")}function sh(e,t){return e.spatialReference?Object(ge["a"])(t,e.spatialReference):void 0}function oh(e,t,i){const r=e.renderSpatialReference;let a,n;t||(t=e.state.camera);const s=c["a"].WGS84;return t instanceof E["a"]?(a=t.position.latitude,Object(z["t"])(t.position,Sl,r),Object(z["t"])(i,Cl,r),n=Object(It["p"])(Sl,Cl)):(Object(z["y"])(t.center,r,Cl,s),a=Cl[1],n=t.distance),Fl(e,n,a)}class ch{constructor(e){this.signal=e,this.resolver=Object(j["h"])()}}function lh(e){return e&&"resolver"in e}let hh=class extends Pc{constructor(e){super(e),this.transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},this.keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],this.tmpCamera=new Yn["a"],this.constraintOptions={selection:15,interactionType:0,interactionStartCamera:new Yn["a"],interactionFactor:0,interactionDirection:null,tiltMode:1}}handleEventGamepad(e){const t=Object(Uc["a"])(e,this.view.navigation.gamepad,this.transformation);("end"===e.action||Object(Uc["c"])(t))&&this.finishController()}activateDirection(e){this.keysButtonState[e]=1,Object(Uc["b"])(this.keysButtonState,this.transformation)}deactivateDirection(e){this.keysButtonState[e]=0;const t=Object(Uc["b"])(this.keysButtonState,this.transformation);Object(Uc["c"])(t)&&this.finishController()}onControllerStart(e){this.filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this.headingStart=this.view.camera.heading,super.onControllerStart(e)}updateFilteredSurfaceElevation(e){const t=this.view.pointsOfInterest.cameraOnSurface.location.z,i=1;this.filteredSurfaceElevation+=i*(t-this.filteredSurfaceElevation)*e}stepController(e,t){this.updateStartHeading(),this.updateFilteredSurfaceElevation(e),this.currentCamera.copyViewFrom(t),this.updateCameraCenter(),this.constraintOptions.interactionStartCamera.copyFrom(this.currentCamera),this.calculateControlTransformation(e,this.currentCamera,vh),this.applyDisabledMovementTypes(vh),this.applyPan(vh.pan),this.applyRotate(vh.rotate),this.applyZoom(vh.zoom),this.applyAscend(vh.ascend),this.constraintOptions.interactionType=0,this.constraintOptions.selection=8,Nn(this.view,this.currentCamera,this.constraintOptions),super.stepController(e,t)}updateStartHeading(){0!==this.transformation.heading&&(this.headingStart=this.view.camera.heading)}applyRotate(e){if(!e.enabled)return;const t=this.currentCamera,{center:i,up:r,eye:a}=t;Object(It["k"])(i,i,a),Object(It["n"])(i,i,e.matrix),Object(It["g"])(i,i,a),Object(It["n"])(r,r,e.matrix),t.markViewDirty(),this.constraintOptions.interactionType=3,this.constraintOptions.selection=7,Nn(this.view,t,this.constraintOptions)}applyPan(e,t=this.currentCamera){if(!e.enabled)return;const{center:i,eye:r,up:a}=t;Object(It["n"])(r,r,e.matrix),Object(It["n"])(i,i,e.matrix),this.view.state.isGlobal&&Object(It["n"])(a,a,e.matrix),t.markViewDirty(),this.constraintOptions.interactionType=4,this.constraintOptions.selection=15,Nn(this.view,t,this.constraintOptions)}applyZoom(e){if(!e)return;const{eye:t,viewForward:i}=this.currentCamera;Object(It["g"])(t,t,Object(It["f"])(Hs["d"].get(),i,e)),this.currentCamera.markViewDirty(),Object(It["l"])(yh,i),Object(It["u"])(yh,yh),this.constraintOptions.interactionDirection=yh,this.constraintOptions.interactionType=1,this.constraintOptions.selection=7,Nn(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null}applyAscend(e){if(!e)return;const{center:t,eye:i}=this.currentCamera,r=this.view.renderCoordsHelper.worldUpAtPosition(i,Hs["d"].get());if(this.constraintOptions.interactionDirection=Object(It["l"])(yh,r),this.view.state.isGlobal){const r=Object(It["q"])(i),a=(r+e)/r;Object(It["f"])(i,i,a),Object(It["f"])(t,t,a)}else{const a=Object(It["f"])(Hs["d"].get(),r,e);Object(It["g"])(i,i,a),Object(It["g"])(t,t,a)}this.currentCamera.markViewDirty(),this.updateCameraCenter(),this.constraintOptions.interactionType=5,this.constraintOptions.selection=8,Nn(this.view,this.currentCamera,this.constraintOptions)&&this.updateCameraCenter(),this.constraintOptions.selection=7,Nn(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null}calculateControlTransformation(e,t,i){_h(i);const r=this.computeVelocities(e);this.view.state.isLocal?this.calculateControlTransformationLocal(r,t,i):this.calculateControlTransformationGlobal(r,t,i)}updateCameraCenter(){const{ray:e,center:t}=this.currentCamera,i=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude;this.view.renderCoordsHelper.intersectManifoldClosestSilhouette(e,i,t),this.currentCamera.markViewDirty()}calculateControlTransformationLocal(e,t,i){const{viewRight:r,viewForward:a}=t,n=this.transformation,s=this.view.navigation.gamepad,o=Object(It["x"])(Hs["d"].get(),a[0],a[1],0);Object(It["s"])(o,o);const c=n.translation[0]*e.pan;if(0!==c){const e=Object(It["f"])(Hs["d"].get(),r,c);Object(Vt["t"])(i.pan.matrix,i.pan.matrix,e),i.pan.enabled=!0}switch(s.mode){case"pan":{const t=-n.translation[1]*e.pan;if(0!==t){const e=Object(It["f"])(Hs["d"].get(),o,t);Object(Vt["t"])(i.pan.matrix,i.pan.matrix,e),i.pan.enabled=!0}i.zoom=n.zoom*e.zoom;break}case"zoom":i.zoom=(-n.translation[1]+n.zoom)*e.zoom;break;default:Object(yn["a"])(s.mode)}const l=n.translation[2]*e.ascend;i.ascend=l;const h=-n.heading*e.rotate;0!==h&&(Object(Vt["r"])(i.rotate.matrix,i.rotate.matrix,h,this.view.renderCoordsHelper.worldUpAtPosition(t.eye,Hs["d"].get())),i.rotate.enabled=!0);const d=n.tilt*e.rotate,u=On(this.view.renderCoordsHelper,t.center,t.eye),p=Object(Qe["d"])(u+d,tt.min,tt.max)-u;p&&(Object(Vt["r"])(i.rotate.matrix,i.rotate.matrix,p,r),i.rotate.enabled=!0)}calculateControlTransformationGlobal(e,t,i){const{eye:r,viewRight:a}=t,n=this.transformation,s=this.view.navigation.gamepad,o=Object(It["h"])(Hs["d"].get(),a,r);Object(It["s"])(o,o),Object(It["u"])(o,o),Wo(this.beginCamera,t,n,e,this.view.camera.heading,this.headingStart,this.view.camera.tilt,i,s),this.tmpCamera.copyFrom(this.currentCamera),this.applyPan(vh.pan,this.tmpCamera);const c=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,l=n.translation[2]*e.ascend;i.ascend=l;const h=-n.heading*e.rotate;0!==h&&(Object(Vt["r"])(i.rotate.matrix,i.rotate.matrix,h,this.tmpCamera.eye),i.rotate.enabled=!0);const d=n.tilt*e.rotate,u=this.clampTiltDeltaGlobalToValidRange(d,t.ray,c);0!==u&&(Object(Vt["r"])(i.rotate.matrix,i.rotate.matrix,u,this.tmpCamera.viewRight),i.rotate.enabled=!0),i.zoom+=n.zoom*e.zoom}clampTiltDeltaGlobalToValidRange(e,t,i){const r=Object(V["e"])(this.view.spatialReference),a=yo(tt.min,t.origin,i,r);let n=0,s=0;const o=Hs["d"].get();if(this.view.renderCoordsHelper.intersectManifold(t,i,o)){const e=On(this.view.renderCoordsHelper,o,t.origin);n=yo(e,t.origin,i,r),s=yo(tt.max,t.origin,i,r)}else{Et["h"].closestPointOnSilhouette(Et["h"].fromRadius(i+r.radius),t,o);const e=Object(Qe["b"])(-Object(It["i"])(t.direction,Object(It["s"])(o,o)));n=Oo(e,t.origin,i,r),s=Oo(tt.max,t.origin,i,r)}return Object(Qe["d"])(n+e,a,s)-n}getPointAbsoluteSurfaceElevation(e,t,i){const{renderCoordsHelper:r}=this.view,a=r.getAltitude(e),n=t+Math.abs(a-t);return Object(It["l"])(i,e),r.setAltitude(n,i),n}clampedDistanceToSurface(e,t){const{renderCoordsHelper:i}=this.view,{camera:r}=this.view.state,{direction:a}=Dl(this.view,t,0,uh,Oh),n=i.intersectManifoldClosestSilhouette(Et["g"].wrap(t,a),e,Hs["d"].get()),s=Object(It["p"])(t,n),o=i.intersectManifoldClosestSilhouette(Et["g"].wrap(t,Object(Xe["h"])(Hs["d"].get(),t,r.center)),e,Hs["d"].get()),c=Object(It["p"])(t,o);return Math.min(s,c)}computeHeadingRotateRadius(e){const{renderCoordsHelper:t,state:i}=this.view,{camera:r,isGlobal:a}=i,n=t.intersectManifoldClosestSilhouette(r.ray,this.filteredSurfaceElevation,Hs["d"].get());if(a){const t=Object(It["k"])(Hs["d"].get(),e,n),i=Object(It["q"])(t);Object(It["f"])(t,t,1/i);const r=Object(It["s"])(Hs["d"].get(),e),a=Object(Qe["b"])(Object(It["i"])(r,t));return i*Math.sin(Math.min(ph,a))}{const i=Object(It["l"])(Hs["d"].get(),e);return t.setAltitude(this.filteredSurfaceElevation,i),Object(It["p"])(n,i)}}minimumAscendVelocity(){return this.view.state.constraints.collision.enabled?0:mh}computeVelocities(e){const t=this.filteredSurfaceElevation,i=t+Object(V["e"])(this.view.spatialReference).radius,{camera:r,isGlobal:a}=this.view.state,n=Hs["d"].get(),s=this.getPointAbsoluteSurfaceElevation(r.eye,t,n),o=this.clampedDistanceToSurface(t,n),c=r.width/2,l=fh*r.width,h=fh*r.width,d=o*Math.tan(.5*r.fovX)/c,u=d/i,p=d/this.computeHeadingRotateRadius(n),f=s-t;return{pan:(a?u:d)*l*e,ascend:Math.max(this.minimumAscendVelocity()*e,2**(l*e/c)*f-f),zoom:2**(l*e/c)*o-o,rotate:Object(Qe["d"])(p*h,bh,gh)*e}}applyDisabledMovementTypes(e){!Object(p["k"])(this.disableMovements)||void 0!==this.disableMovements.mode&&this.view.state.mode!==this.disableMovements.mode||(e.zoom=this.disableMovements.zoom?0:e.zoom,e.ascend=this.disableMovements.ascend?0:e.ascend,e.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&Object(Vt["i"])(e.pan.matrix),e.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&Object(Vt["i"])(e.rotate.matrix))}static activatesFor(e,t){const i=Object(Uc["a"])(t,e.navigation.gamepad,dh);return!("end"===t.action||Object(Uc["c"])(i))}};Object(d["a"])([Object(g["b"])({constructOnly:!0})],hh.prototype,"view",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],hh.prototype,"gamepadDevice",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],hh.prototype,"disableMovements",void 0),hh=Object(d["a"])([Object(y["a"])("esri.views.3d.state.controllers.GamepadKeyboardController")],hh);const dh={translation:[0,0,0],heading:0,tilt:0,zoom:0},uh=80,ph=Object(Qe["f"])(uh),fh=.75,mh=5,bh=Object(Qe["f"])(30),gh=Object(Qe["f"])(80),vh={zoom:0,ascend:0,pan:{enabled:!1,matrix:Object(kt["b"])()},rotate:{enabled:!1,matrix:Object(kt["b"])()}},yh=Object(M["e"])(),Oh=Hc();function _h(e){e.zoom=0,e.ascend=0,e.pan.enabled=!1,Object(Vt["i"])(e.pan.matrix),e.rotate.enabled=!1,Object(Vt["i"])(e.rotate.matrix)}class xh extends Qr["a"]{constructor(e){super(!0),this.view=e,this.watchHandles=new we["a"],this.handle=this.registerIncoming("gamepad",e=>this.handleEventGamepad(e)),this.handle.pause()}onInstall(e){super.onInstall(e),this.watchHandles.add([Object(L["a"])(this.view.navigation.gamepad,"enabled",e=>{e?this.handle.resume():(this.handle.pause(),this.cameraControllerGamepad&&(this.cameraControllerGamepad.finishController(),this.cameraControllerGamepad=null))}),this.view.navigation.gamepad.watch("device",e=>{this.cameraControllerGamepad&&e&&this.cameraControllerGamepad.gamepadDevice!==e&&(this.cameraControllerGamepad.finishController(),this.cameraControllerGamepad=null)})])}onUninstall(){this.watchHandles.removeAll(),super.onUninstall()}handleEventGamepad(e){const t=this.view.navigation.gamepad.device;if(t&&e.data.device!==t)return;const i=this.cameraControllerGamepad&&this.cameraControllerGamepad.active;if(i||hh.activatesFor(this.view,e.data)){if(!i){const t=new hh({view:this.view,gamepadDevice:e.data.device});this.view.state.switchCameraController(t)&&(this.cameraControllerGamepad=t)}this.cameraControllerGamepad&&this.cameraControllerGamepad.active&&this.cameraControllerGamepad.gamepadDevice===e.data.device&&this.cameraControllerGamepad.handleEventGamepad(e.data)}}}class jh extends Qr["a"]{constructor(e,t){super(!0),this.view=e,this.disableMovements={pan:!0,zoom:!1,ascend:!0,rotate:!1,mode:2},this.keyToNumber={[t.left]:0,[t.right]:1,[t.forward]:2,[t.backward]:3,[t.up]:4,[t.down]:5,[t.headingLeft]:6,[t.headingRight]:7,[t.tiltUp]:8,[t.tiltDown]:9,[t.zoomIn]:10,[t.zoomOut]:11},this.registerIncoming("key-down",null,e=>this.handleKeyDown(e)),this.registerIncoming("key-up",null,e=>this.handleKeyUp(e)),this.registerIncoming("blur",null,()=>this.handleBlur())}handleKeyDown(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const t=this.keyToNumber[e.data.key];null!=t&&(this.cameraControllerKeyboard&&this.cameraControllerKeyboard.active||(this.cameraControllerKeyboard=new hh({view:this.view,disableMovements:this.disableMovements}),this.view.state.switchCameraController(this.cameraControllerKeyboard)),this.cameraControllerKeyboard.active&&(this.cameraControllerKeyboard.activateDirection(t),e.stopPropagation()))}handleBlur(){this.cameraControllerKeyboard&&this.cameraControllerKeyboard.active&&(this.cameraControllerKeyboard.finishController(),this.cameraControllerKeyboard=null)}handleKeyUp(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const t=this.keyToNumber[e.data.key];null!=t&&this.cameraControllerKeyboard&&this.cameraControllerKeyboard.active&&(this.cameraControllerKeyboard.deactivateDirection(t),e.stopPropagation())}}class wh extends Qr["a"]{constructor(e,t){super(!0),this.view=e,this.registerIncoming("mouse-wheel",t,e=>this.handleMouseWheel(e))}handleMouseWheel(e){if(!this.view.navigation.mouseWheelZoomEnabled)return;const t=e.data;this.cameraController&&this.cameraController.active||(this.cameraController=this.view.state.isGlobal?new yc({view:this.view,mode:"interaction"}):new Cc({view:this.view,mode:"interaction"}),this.view.state.switchCameraController(this.cameraController)),this.cameraController.zoomStep(-1/60*t.deltaY,Object(A["g"])(t.x,t.y)),e.preventDefault(),e.stopPropagation()}}class Sh{constructor(e){this._gain=e}reset(e){this._value=e}set gain(e){this._gain=e}get value(){return void 0===this._value?0:this._value}update(e){void 0===this._value?this._value=e:this._value=this._gain*e+(1-this._gain)*this._value}}let Ch=class extends zs{constructor(e){super(e),this.view=null,this.beginCamera=new Yn["a"],this.elapsedTimeSec=0,this.constraintOptions={selection:15,interactionType:4,interactionFactor:0,interactionStartCamera:new Yn["a"],interactionDirection:null,tiltMode:0}}initialize(){this.constraintOptions.interactionType=this.interactionType,this.viewAnimation=new ze["a"]}get steppingFinished(){return this.momentum.isFinished(this.elapsedTimeSec)}onControllerStart(e){this.beginCamera.copyFrom(e),this.constraintOptions.interactionStartCamera=this.beginCamera,super.onControllerStart(e)}stepController(e,t){t.copyViewFrom(this.beginCamera),this.elapsedTimeSec+=e,this.momentumStep(this.elapsedTimeSec,t),Nn(this.view,t,this.constraintOptions)}};Object(d["a"])([Object(g["b"])({constructOnly:!0})],Ch.prototype,"view",void 0),Ch=Object(d["a"])([Object(y["a"])("esri.views.3d.state.controllers.momentum.MomentumController")],Ch);let Th=class extends Ch{constructor(e){super(e),this.interactionType=4,this.tmpPan=Object(M["e"])()}momentumStep(e,t){const i=this.momentum.value(e);Object(It["f"])(this.tmpPan,this.momentum.direction,i),Object(It["k"])(t.eye,t.eye,this.tmpPan),Object(It["k"])(t.center,t.center,this.tmpPan),t.markViewDirty(),this.constraintOptions.interactionDirection=this.tmpPan}};Object(d["a"])([Object(g["b"])({constructOnly:!0})],Th.prototype,"momentum",void 0),Th=Object(d["a"])([Object(y["a"])("esri.views.3d.state.controllers.momentum.PanPlanarMomentumController")],Th);const Ph=Object(M["e"])(),Ah=Object(M["e"])();let Rh=class extends Ch{constructor(e){super(e),this.interactionType=4}momentumStep(e,t){const i=this.momentum.value1(e),r=this.momentum.value2(e);Object(It["l"])(Ah,t.eye),Object(It["s"])(Ah,Ah),Object(It["h"])(this.momentum.axis2,Ah,this.momentum.axis1),zo(t,Ph,this.momentum.axis1,i,this.momentum.axis2,r)}};Object(d["a"])([Object(g["b"])({constructOnly:!0})],Rh.prototype,"momentum",void 0),Rh=Object(d["a"])([Object(y["a"])("esri.views.3d.state.controllers.momentum.PanSphericalMomentumController")],Rh);let Mh=class extends Ch{constructor(e){super(e),this.interactionType=2}set center(e){this._set("center",Object(M["d"])(e))}set axis(e){this._set("axis",Object(M["d"])(e))}momentumStep(e,t){const i=this.momentum.value(e);po(t,this.center,Et["a"].wrapAxisAngle(this.axis,i))}};Object(d["a"])([Object(g["b"])({constructOnly:!0})],Mh.prototype,"momentum",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],Mh.prototype,"center",null),Object(d["a"])([Object(g["b"])({constructOnly:!0})],Mh.prototype,"axis",null),Mh=Object(d["a"])([Object(y["a"])("esri.views.3d.state.controllers.momentum.MomentumController")],Mh);let Eh=class extends Ch{constructor(e){super(e),this.interactionType=1,this.constraintOptions.interactionDirection=Object(M["e"])()}set zoomCenter(e){this._set("zoomCenter",Object(M["d"])(e))}momentumStep(e,t){Object(It["l"])(this.constraintOptions.interactionDirection,t.eye);const i=this.momentum.valueDelta(0,e);mo(t,this.zoomCenter,i,this.view.state.constraints.minimumPoiDistance),this.constraintOptions.interactionDirection=Object(Xe["h"])(this.constraintOptions.interactionDirection,t.eye,this.constraintOptions.interactionDirection)}};Object(d["a"])([Object(g["b"])({constructOnly:!0})],Eh.prototype,"momentum",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],Eh.prototype,"zoomCenter",null),Eh=Object(d["a"])([Object(y["a"])("esri.views.3d.state.controllers.momentum.ZoomPlanarMomentumController")],Eh);let Dh=class extends Ch{constructor(e){super(e),this.interactionType=1,this.radius=0,this.tmpSceneCenter=Object(M["e"])(),this.tmpZoomAxisAngle=Et["a"].create(),this.sphere=Et["h"].create()}set screenCenter(e){this._set("screenCenter",Object(A["g"])(e[0],e[1]))}set sceneCenter(e){this._set("sceneCenter",Object(M["d"])(e))}initialize(){this.sphere[3]=this.radius}momentumStep(e,t){const i=this.momentum.valueDelta(0,e);bo(this.sphere,t,i),this.constraintOptions.interactionType=1,Nn(this.view,t,this.constraintOptions),Ao(this.sphere,t,this.screenCenter,this.tmpSceneCenter),Et["a"].fromPoints(this.sceneCenter,this.tmpSceneCenter,this.tmpZoomAxisAngle),po(t,this.sphere,this.tmpZoomAxisAngle),this.constraintOptions.interactionType=4}};Object(d["a"])([Object(g["b"])({constructOnly:!0})],Dh.prototype,"momentum",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],Dh.prototype,"screenCenter",null),Object(d["a"])([Object(g["b"])({constructOnly:!0})],Dh.prototype,"sceneCenter",null),Object(d["a"])([Object(g["b"])({constructOnly:!0})],Dh.prototype,"radius",void 0),Dh=Object(d["a"])([Object(y["a"])("esri.views.3d.state.controllers.momentum.ZoomSphericalMomentumController")],Dh);var Ih=i("4e47"),Lh=i("0ca15"),Vh=i("b33e");class kh{constructor(e){this.gain=e}update(e){this.hasFilteredValue?this.filteredValue=(1-this.gain)*this.filteredValue+this.gain*e:this.filteredValue=e}reset(){this.filteredValue=void 0}get hasFilteredValue(){return void 0!==this.filteredValue}}const Fh=1e-5;class zh extends Vh["a"]{constructor(e,t,i,r,a,n=0,s){super(e,t,i),this.angularVelocity1=r,this.axis1=a,this.angularVelocity2=n,this.axis2=s}value1(e){return super.valueFromInitialVelocity(this.angularVelocity1,e)}value2(e){return super.valueFromInitialVelocity(this.angularVelocity2,e)}}class Uh{constructor(e=300,t=12,i=.84){this.minimumInitialVelocity=e,this.stopVelocity=t,this.friction=i,this.enabled=!0,this.tmpAxis1=Object(M["e"])(),this.tmpAxis2=Object(M["e"])(),this.tmpAngles=Object(hi["b"])(),this.time=new Lh["a"](.3),this.screen=[new Lh["a"](.4),new Lh["a"](.4)],this.angle1=new kh(.6),this.angle2=new kh(.6),this.axis1=Object(M["e"])(),this.axis2=Object(M["e"])(),this.lastScene=Object(M["e"])()}addMomentumDirectRotation(e,t,i,r,a,n){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(i)<.01)return;let e=Do(this.lastScene,t,this.tmpAxis2,r,a,n);this.angle2.update(0),Object(It["t"])(this.tmpAxis2)<Fh?e=0:Object(It["s"])(this.axis1,this.tmpAxis2),this.angle1.update(e),Object(It["l"])(this.lastScene,t)}this.screen[0].update(e[0]),this.screen[1].update(e[1]),this.time.update(i)}}addMomentumPreserveHeading(e,t,i,r,a,n,s){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(i)<.01)return;ko(this.lastScene,t,this.tmpAxis2,this.tmpAxis1,this.tmpAngles,r,a,n,s,!1),Object(It["t"])(this.tmpAxis2)<Fh?(this.angle1.update(0),this.angle2.update(0)):(this.angle1.update(this.tmpAngles[1]),this.angle2.update(this.tmpAngles[0]),Object(It["s"])(this.axis1,this.tmpAxis1),Object(It["s"])(this.axis2,this.tmpAxis2)),Object(It["l"])(this.lastScene,t)}this.screen[0].update(e[0]),this.screen[1].update(e[1]),this.time.update(i)}}reset(){this.screen[0].reset(),this.screen[1].reset(),this.angle1.reset(),this.angle2.reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.screen[0].hasFilteredDelta)return null;const e=this.screen[0].filteredDelta,t=this.screen[1].filteredDelta,i=Math.sqrt(e*e+t*t)/this.time.filteredDelta;return Math.abs(i)<this.minimumInitialVelocity?null:this.createMomentum(i,this.stopVelocity,this.friction)}createMomentum(e,t,i){const r=this.angle1.filteredValue/this.time.filteredDelta,a=this.angle2.filteredValue/this.time.filteredDelta;return new zh(e,t,i,r,this.axis1,a,this.axis2)}}var Gh=i("11d8"),Bh=i("8e6f");let Hh=class extends Pc{constructor(e){super(e),this.view=null,this.smoothRotation=new Sh(.05),this.rotationAxis=Object(M["e"])(),this.panningPlane=Et["f"].create(),this.smoothScaling=new Sh(.05),this.zoomCenterScreen=Object(A["g"])(),this.zoomMomentumEstimator=new Bh["a"],this.rotationMomentumEstimator=new Gh["a"],this.panSphericalMomentumEstimator=new Uh,this.panPlanarMomentumEstimator=new Ih["a"],this.adjustedSphere=Et["h"].create(),this.tmp3d=Object(M["e"])(),this.tmpScreenPointArray=Object(A["g"])(),this.beginScreenPoint=Object(A["g"])(),this.beginScenePoint=Object(M["e"])(),this.screenPickPoint=Object(A["g"])(),this.navMode=_o.Horizontal,this.tmpInteractionDirection=Object(M["e"])(),this.constraintOptions={selection:15,interactionType:0,interactionFactor:0,interactionStartCamera:new Yn["a"],interactionDirection:null,tiltMode:0}}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;const t=this.view.navigation.momentumEnabled;this.zoomMomentumEstimator.enabled=t,this.rotationMomentumEstimator.enabled=t,this.panPlanarMomentumEstimator.enabled=t,this.panSphericalMomentumEstimator.enabled=t,this.beginHeading=-Xe["g"].normalize(Object(Qe["f"])(this.view.camera.heading)),this.beginRadius=e.radius,this.pointerCount=e.pointers.size,this.beginAngle=e.angle,this.smoothRotation.reset(),Object(A["j"])(e.center,this.screenPickPoint),Object(di["c"])(this.beginScreenPoint,this.screenPickPoint);const i=Object(V["e"])(this.view.spatialReference),r=So(this.intersectionHelper,this.beginCamera,this.screenPickPoint,!0,i);this.scenePickPoint=r.scenePickPoint,this.sphere=r.sphere,Object(It["l"])(this.beginScenePoint,this.scenePickPoint),this.navMode=Co(this.beginCamera,this.screenPickPoint,r.hasGeometryIntersection,i),this.navMode===_o.Vertical&&this.preparePlanarPanMode(e),this.constraintOptions.interactionStartCamera.copyFrom(this.beginCamera)}preparePlanarPanMode(e){const t=Object(It["u"])(this.tmp3d,this.beginCamera.viewForward);Et["f"].fromPositionAndNormal(this.scenePickPoint,t,this.panningPlane);const i=Object(A["g"])(this.screenPickPoint[0],0),r=Object(M["e"])(),a=Object(It["q"])(this.beginCamera.eye);this.adjustedSphere[3]=a<this.sphere[3]?a-100:this.sphere[3],Ao(this.adjustedSphere,this.beginCamera,i,r);const n=Object(A["e"])();this.beginCamera.projectToRenderScreen(r,n);const s=.9*n[1];if(this.screenPickPoint[1]=Math.min(this.screenPickPoint[1],s),this.intersectionHelper.intersectScreen(this.screenPickPoint,this.scenePickPoint)&&Et["f"].fromPositionAndNormal(this.scenePickPoint,Et["f"].normal(this.panningPlane),this.panningPlane),!Object(Oc["a"])()){const e=Object(M["e"])(),t=Object(M["e"])(),i=Object(M["e"])(),r=80,a=5,n=50;Object(It["k"])(e,this.scenePickPoint,this.currentCamera.eye),Object(It["s"])(e,e);const s=a*Math.max(Math.abs(this.view.camera.position.z),n),o=this.view._stage.renderView.getMinimalDepthForArea(this.screenPickPoint[0],this.screenPickPoint[1],this.view._stage.camera,r),c=o?Math.min(o,s):s;Object(It["l"])(i,Object(It["g"])(t,this.currentCamera.eye,Object(It["f"])(t,e,c))),this.panningPlane[3]=-Object(It["i"])(this.panningPlane,i)}const o=Object(A["j"])(e.center,this.tmpScreenPointArray);fo(this.panningPlane,this.beginCamera,o,this.beginScenePoint)}update(e){if(!this.active)return;this.currentCamera.copyFrom(this.beginCamera);const t=e.pointers.size>1;this.navMode===_o.Horizontal?(t&&this.zoomSpherical(e),this.panningSpherical(e),t&&this.rotateSpherical(e)):(t&&this.zoomPlanar(e),this.panningPlanar(e),t&&this.rotatePlanar(e)),this.currentCamera.markViewDirty()}end(e){e.pointers.size===this.pointerCount&&this.update(e),this.finishController();const t=this.zoomMomentumEstimator.evaluateMomentum();if(t)return this.navMode===_o.Horizontal?new Dh({view:this.view,momentum:t,screenCenter:this.zoomCenterScreen,sceneCenter:this.beginScenePoint,radius:this.sphere[3]}):new Eh({view:this.view,momentum:t,zoomCenter:this.beginScenePoint});const i=this.rotationMomentumEstimator.evaluateMomentum();if(i)return new Mh({view:this.view,momentum:i,center:this.sphere,axis:this.rotationAxis});if(this.navMode===_o.Horizontal){const e=this.panSphericalMomentumEstimator.evaluateMomentum();if(e)return new Rh({view:this.view,momentum:e})}else{const e=this.panPlanarMomentumEstimator.evaluateMomentum();if(e)return new Th({view:this.view,momentum:e})}return null}zoomSpherical(e){const t=this.beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this.smoothScaling.gain=i,this.smoothScaling.update(t),bo(this.sphere,this.currentCamera,this.smoothScaling.value),Object(A["j"])(e.center,this.zoomCenterScreen),this.zoomMomentumEstimator.add(this.smoothScaling.value,.001*e.timestamp),this.constraintOptions.interactionType=1,this.constraintOptions.interactionFactor=Wn(e.radius-this.beginRadius),Nn(this.view,this.currentCamera,this.constraintOptions)}panningSpherical(e){const t=Object(A["j"])(e.center,this.tmpScreenPointArray);Ao(this.sphere,this.currentCamera,t,this.tmp3d),Uo(this.beginScenePoint,Object(It["i"])(this.currentCamera.up,this.beginScenePoint),this.sphere[3],this.beginHeading,this.view.camera.tilt,this.beginCamera)?(Bo(this.sphere,this.currentCamera,this.beginScenePoint,this.tmp3d,this.beginHeading,this.view.camera.tilt,!1),this.panSphericalMomentumEstimator.addMomentumPreserveHeading(t,this.tmp3d,.001*e.timestamp,this.beginCamera,this.sphere,this.beginHeading,this.view.camera.tilt)):(Go(this.sphere,this.currentCamera,this.beginScenePoint,this.tmp3d,this.view.camera.tilt,!1),this.panSphericalMomentumEstimator.addMomentumDirectRotation(t,this.tmp3d,.001*e.timestamp,this.beginCamera,this.sphere[3],this.view.camera.tilt)),this.constraintOptions.interactionType=4,this.constraintOptions.interactionFactor=Wn(this.screenPickPoint,t),Nn(this.view,this.currentCamera,this.constraintOptions)}rotateSpherical(e){Object(It["s"])(this.rotationAxis,this.scenePickPoint),this.currentCamera.aboveGround||Object(It["u"])(this.rotationAxis,this.rotationAxis);const t=this.smoothRotation.value,i=t+uo(e.angle-t),r=.00125*Math.min(Math.max(e.radius,40),120);this.smoothRotation.gain=r,this.smoothRotation.update(i);const a=this.smoothRotation.value-this.beginAngle;this.rotationMomentumEstimator.add(a,.001*e.timestamp),po(this.currentCamera,this.sphere,Et["a"].wrapAxisAngle(this.rotationAxis,a)),this.constraintOptions.interactionType=2,this.constraintOptions.interactionFactor=Wn(e.radius*i),Nn(this.view,this.currentCamera,this.constraintOptions)}panningPlanar(e){const t=Object(A["j"])(e.center,this.tmpScreenPointArray);fo(this.panningPlane,this.currentCamera,t,this.tmp3d)&&(To(this.currentCamera,this.beginScenePoint,this.tmp3d),this.panPlanarMomentumEstimator.add(t,this.tmp3d,.001*e.timestamp),this.constraintOptions.interactionType=4,this.constraintOptions.interactionFactor=Wn(this.beginScreenPoint,t),this.constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this.tmpInteractionDirection),Nn(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null)}zoomPlanar(e){const t=this.beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this.smoothScaling.gain=i,this.smoothScaling.update(t),this.zoomMomentumEstimator.add(this.smoothScaling.value,.001*e.timestamp),mo(this.currentCamera,this.beginScenePoint,this.smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this.constraintOptions.interactionType=1,this.constraintOptions.interactionFactor=Wn(e.radius-this.beginRadius),Nn(this.view,this.currentCamera,this.constraintOptions)}rotatePlanar(e){Object(It["l"])(this.rotationAxis,this.beginScenePoint),this.currentCamera.aboveGround||Object(It["u"])(this.rotationAxis,this.rotationAxis);const t=this.smoothRotation.value;let i=e.angle-t;i=uo(i);const r=t+i,a=.00125*Math.min(Math.max(e.radius,40),120);this.smoothRotation.gain=a,this.smoothRotation.update(r);const n=this.smoothRotation.value-this.beginAngle;this.rotationMomentumEstimator.add(n,.001*e.timestamp),po(this.currentCamera,this.sphere,Et["a"].wrapAxisAngle(this.rotationAxis,n)),this.constraintOptions.interactionType=2,this.constraintOptions.interactionFactor=Wn(e.radius*n),Nn(this.view,this.currentCamera,this.constraintOptions)}};Object(d["a"])([Object(g["b"])({constructOnly:!0})],Hh.prototype,"view",void 0),Hh=Object(d["a"])([Object(y["a"])("esri.views.3d.state.controllers.global.PinchAndPanController")],Hh);const Nh=Object(M["g"])(0,0,1),qh={ELEVATION_THRESHOLD:3e4,ANGLE_THRESHOLD:16/180*Math.PI};let Wh=class extends Pc{constructor(e){super(e),this.view=null,this.rotationValueSmooth=new Sh(.05),this.scalingValueSmooth=new Sh(.05),this.planeHorizontal=Et["f"].create(),this.planeVertical=Et["f"].create(),this.rotationMomentumEstimator=new Gh["a"],this.panMomentumEstimator=new Ih["a"](300,12,.9),this.zoomMomentumEstimator=new Bh["a"],this.beginCenter=Object(M["e"])(),this.tmpPoints=[],this.beginCenterScreen=Object(A["g"])(),this.tmpCentroid3d=Object(M["e"])(),this.tmpCentroid2d=Object(A["g"])(),this.tmp2d=Object(A["g"])(),this.constraintOptions={selection:15,interactionType:0,interactionFactor:0,interactionStartCamera:new Yn["a"],interactionDirection:null,tiltMode:0}}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;const t=this.view.navigation.momentumEnabled;this.zoomMomentumEstimator.enabled=t,this.rotationMomentumEstimator.enabled=t,this.panMomentumEstimator.enabled=t,this.beginRadius=e.radius,this.pointerCount=e.pointers.size,this.beginAngle=e.angle,this.rotationValueSmooth.reset(),this.scalingValueSmooth.reset(),Object(A["j"])(e.center,this.beginCenterScreen),Et["f"].fromNormalAndOffset(Nh,0,this.planeHorizontal);const i=Object(M["e"])();this.intersectionHelper.intersectScreenFreePointFallback(this.beginCenterScreen,i);const r=Object(M["e"])();Object(It["u"])(r,this.beginCamera.viewForward);const a=Object(M["e"])();Object(It["l"])(a,Nh);const n=Object(It["i"])(r,a),s=Object(Qe["c"])(n<0?-n:n);if(this.panMode=s>=qh.ANGLE_THRESHOLD?_o.Horizontal:_o.Vertical,Et["f"].setOffsetFromPoint(this.planeHorizontal,i,this.planeHorizontal),this.beginCamera.aboveGround||Et["f"].negate(this.planeHorizontal,this.planeHorizontal),this.panMode===_o.Vertical){if(Object(It["f"])(a,a,n),Object(It["k"])(this.planeVertical,r,a),Object(It["s"])(this.planeVertical,this.planeVertical),Et["f"].setOffsetFromPoint(this.planeVertical,i,this.planeVertical),!Object(Oc["a"])()){const e=Object(M["e"])(),t=Object(M["e"])(),r=Object(M["e"])();Object(It["k"])(e,i,this.currentCamera.eye),Object(It["s"])(e,e);const a=5*Math.max(Math.abs(this.view.camera.position.z),50),n=this.view._stage.renderView.getMinimalDepthForArea(this.beginCenterScreen[0],this.beginCenterScreen[1],this.view._stage.camera,80),s=n?Math.min(n,a):a;Object(It["l"])(r,Object(It["g"])(t,this.currentCamera.eye,Object(It["f"])(t,e,s))),this.planeVertical[3]=-Object(It["i"])(this.planeVertical,r)}this.computePlanePoints(e.pointers,this.planeVertical,this.beginCamera,this.tmpPoints),vo(this.tmpPoints,this.beginCenter)}else this.computePlanePoints(e.pointers,this.planeHorizontal,this.beginCamera,this.tmpPoints),vo(this.tmpPoints,this.beginCenter);this.constraintOptions.interactionStartCamera.copyFrom(this.beginCamera)}update(e){if(!this.active)return;this.currentCamera.copyFrom(this.beginCamera);const t=e.pointers.size>1,i=this.panMode===_o.Horizontal?this.planeHorizontal:this.planeVertical,r=this.beginCenter;if(t){const t=this.beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this.scalingValueSmooth.gain=i,this.scalingValueSmooth.update(t),mo(this.currentCamera,r,this.scalingValueSmooth.value,this.view.state.constraints.minimumPoiDistance),this.zoomMomentumEstimator.add(this.scalingValueSmooth.value,.001*e.timestamp),this.constraintOptions.interactionType=1,this.constraintOptions.interactionFactor=Wn(Math.abs(e.radius-this.beginRadius)),Nn(this.view,this.currentCamera,this.constraintOptions)}if(this.computePlanePoints(e.pointers,i,this.currentCamera,this.tmpPoints),vo(this.tmpPoints,this.tmpCentroid3d),Object(A["j"])(e.center,this.tmpCentroid2d),To(this.currentCamera,r,this.tmpCentroid3d),this.panMomentumEstimator.add(this.tmpCentroid2d,this.tmpCentroid3d,.001*e.timestamp),this.constraintOptions.interactionType=4,this.constraintOptions.interactionFactor=Wn(this.beginCenterScreen,this.tmpCentroid2d),Nn(this.view,this.currentCamera,this.constraintOptions),t){const t=this.planeHorizontal,i=r,a=this.rotationValueSmooth.value,n=a+uo(e.angle-a),s=.00125*Math.min(Math.max(e.radius,40),120);this.rotationValueSmooth.gain=s,this.rotationValueSmooth.update(n);const o=this.rotationValueSmooth.value-this.beginAngle;this.rotationMomentumEstimator.add(o,.001*e.timestamp),po(this.currentCamera,i,Et["a"].wrapAxisAngle(t,o)),this.constraintOptions.interactionType=2,this.constraintOptions.interactionFactor=Wn(Math.abs(e.radius*o)),Nn(this.view,this.currentCamera,this.constraintOptions)}this.currentCamera.markViewDirty()}end(e){e.pointers.size===this.pointerCount&&this.update(e),this.finishController();const t=this.zoomMomentumEstimator.evaluateMomentum();if(t)return new Eh({view:this.view,momentum:t,zoomCenter:this.beginCenter});const i=this.rotationMomentumEstimator.evaluateMomentum();if(i)return new Mh({view:this.view,momentum:i,center:this.beginCenter,axis:Et["f"].normal(this.planeHorizontal)});const r=this.panMomentumEstimator.evaluateMomentum();return r?new Th({view:this.view,momentum:r}):null}computePlanePoints(e,t,i,r){r.length=e.size;const a=this.tmp2d;let n=0;return e.forEach(e=>{a[0]=e.x,a[1]=e.y,void 0===r[n]&&(r[n]=Object(M["e"])()),fo(t,i,a,r[n]),n+=1}),r}};Object(d["a"])([Object(g["b"])({constructOnly:!0})],Wh.prototype,"view",void 0),Wh=Object(d["a"])([Object(y["a"])("esri.views.3d.state.controllers.local.PinchAndPanController")],Wh);class Zh extends Qr["a"]{constructor(e,t,i){super(!0),this.view=e,this.pointerAction=t,this.lastEndTimestamp=0,this.lastTimestamp=0,this.registerIncoming("drag",i,e=>this.handleDrag(e))}handleDrag(e){if("mouse"===e.data.pointerType&&!Object(Xr["a"])(e.data,this.pointerAction))return;const t=e.timestamp-this.lastEndTimestamp,i=40,r=this.momentum&&this.momentum.active&&t<i;switch(e.data.action){case"start":case"update":if(r)break;this.controller&&this.controller.active?e.data.timestamp-this.lastTimestamp>2&&(this.controller.update(e.data),this.lastTimestamp=e.timestamp):this.startController(e);break;case"end":case"removed":this.endController(e,!0);break;case"added":this.endController(e,!1),this.startController(e)}e.stopPropagation()}endController(e,t){if(this.controller&&this.controller.active){this.lastEndTimestamp=e.timestamp;const i=this.controller.end(e.data);t&&i&&(this.momentum=i,this.view.state.switchCameraController(this.momentum))}this.controller=null}startController(e){this.controller=this.createController(),this.view.state.switchCameraController(this.controller),this.controller.begin(e.data),this.lastTimestamp=e.timestamp}createController(){return this.view.state.isGlobal?new Hh({view:this.view}):new Wh({view:this.view})}}class $h extends Qr["a"]{constructor(e,t){super(!0),this.view=e,this.registerIncoming("pointer-down",t,()=>this.view.state.stopActiveCameraController())}}class Qh extends Qr["a"]{constructor(e,t){super(!0),this.key=e,this.registerIncoming("key-down",t,e=>this._handleKeyDown(e))}_handleKeyDown(e){e.data.key===this.key&&(this.activate(),e.stopPropagation())}}class Xh extends Qh{constructor(e,t,i){super(t,i),this.view=e,this.key=t}activate(){this.view.goTo({heading:0}).catch(()=>{})}}class Yh extends Qh{constructor(e,t,i){super(t,i),this.view=e,this.key=t}activate(){this.view.goTo({tilt:0}).catch(()=>{})}}class Kh extends Qr["a"]{constructor(e,t=!1){super(!0),this.view=e,this.invert=t,this.registerIncoming("vertical-two-finger-drag",e=>this.handleTwoFinger(e))}handleTwoFinger(e){const t=this.invert?-1:1,i=Object(A["g"])(0,e.data.delta*t);switch(e.data.action){case"begin":this.cameraController&&(this.cameraController.end(),this.cameraController=null),this.cameraController=new Mc({view:this.view,pivot:"center"}),this.view.state.switchCameraController(this.cameraController),this.cameraController.begin(i);break;case"update":this.cameraController&&this.cameraController.update(i);break;case"end":this.cameraController&&(this.cameraController.end(),this.cameraController=null)}}}var Jh=i("2b7b");class ed extends Qr["a"]{constructor(e=20,t=40){super(!1),this._threshold=e,this._maxDelta=t,this.state="ready",this.emittedArtificalEnd2=!1,this._vertical=this.registerOutgoing("vertical-two-finger-drag"),this._artificalDrag=this.registerOutgoing("drag"),this.dragEventSeparator=new Jh["a"]({start:(e,t)=>this.observeStart(e,t),update:(e,t,i)=>this.observeUpdate(e,t,i),end:(e,t)=>this.observeEnd(t)}),this.registerIncoming("drag",e=>this.dragEventSeparator.handle(e))}get failed(){return"failed"===this.state}observeStart(e,t){1===e&&this.emittedArtificalEnd2&&(this.emittedArtificalEnd2=!1,this._artificalDrag.emit({action:"start",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center,artifical:!0}),t.stopPropagation()),this.state=2===e?"ready":"failed"}observeUpdate(e,t,i){if("failed"!==this.state&&2===e)return"active"===this.state?(this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"update"}),void t.stopPropagation()):void(this.checkMovementWithinLimits(t.data,i.data)?this.checkVerticalThresholdReached(t.data,i.data)&&(this.state="active",this.emittedArtificalEnd2=!0,this._thresholdReachedCenter=t.data.center,this._artificalDrag.emit({action:"end",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center,artifical:!0}),this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"begin"}),t.stopPropagation()):this.state="failed")}observeEnd(e){"active"===this.state&&(this._vertical.emit({delta:e.data.center.y-this._thresholdReachedCenter.y,action:"end"}),this.state="ready",e.stopPropagation())}checkMovementWithinLimits(e,t){let i=-1/0,r=1/0,a=-1/0,n=1/0;t.pointers.forEach(e=>{i=Math.max(i,e.x),r=Math.min(r,e.x),a=Math.max(a,e.y),n=Math.min(n,e.y)});let s=-1/0,o=1/0,c=-1/0,l=1/0;e.pointers.forEach(e=>{s=Math.max(s,e.x),o=Math.min(o,e.x),c=Math.max(c,e.y),l=Math.min(l,e.y)});const h=i-r,d=a-n,u=s-o,p=c-l;return Math.abs(e.center.x-t.center.x)<this._threshold&&Math.abs(u-h)<=this._maxDelta&&Math.abs(p-d)<=this._maxDelta}checkVerticalThresholdReached(e,t){let i=Math.abs(e.center.y-t.center.y);return e.pointers.forEach((e,r)=>{const a=t.pointers.get(r);i=Math.min(i,Math.abs(e.y-a.y))}),i>=this._threshold}}let td=class extends je["a"]{constructor(){super(...arguments),this._handles=new we["a"]}destroy(){this._handles&&(this._handles.removeAll(),this._handles=null),this.disconnect()}get primaryDragAction(){return this._get("primaryDragAction")}set primaryDragAction(e){"pan"!==e&&"rotate"!==e||e===this._get("primaryDragAction")||(this._set("primaryDragAction",e),this._updateMode())}get mode(){return this._get("mode")}set mode(e){"default"!==e&&"pro"!==e||e===this._get("mode")||(this._set("mode",e),this._updateMode())}disconnect(){this.view.viewEvents.disconnect(),this._inputManager&&(this._inputManager.destroy(),this._inputManager=null),this._source&&(this._source.destroy(),this._source=null)}connect(){const e=this.view;this._source=new Hr["a"](this.view.surface,e.input);const t=[new Zr["a"],new $r["a"],new qr["b"],new Wr["a"](this.view.navigation),new ed],i=new Br["a"]({eventSource:this._source,recognizers:t});this._inputManager=i,i.installHandlers("prevent-context-menu",[new Nr["a"]],Br["b"].INTERNAL),this._modeDragPan=new Zh(e,"primary"),this._modeDragRotate=new Ec(e,"secondary","center"),this._modeDragZoom=new zc(e,"tertiary");const r={lookAround:"b",pan:{left:"ArrowLeft",right:"ArrowRight",forward:"ArrowUp",backward:"ArrowDown",up:"u",down:"j",headingLeft:"a",headingRight:"d",tiltUp:"w",tiltDown:"s",zoomIn:"+",zoomOut:"-"},resetHeading:"n",resetTilt:"p"};i.installHandlers("navigation",[new $h(e),new Tc(e),new xh(e),new jh(e,r.pan),new wh(e),new Yh(e,r.resetTilt),new Xh(e,r.resetHeading),new Ec(e,"primary","eye",[r.lookAround]),new Ec(e,"secondary","center",[r.lookAround]),new Zh(e,"tertiary",[r.lookAround]),this._modeDragRotate,this._modeDragZoom,this._modeDragPan,new Kh(e)],Br["b"].INTERNAL),this.view.viewEvents.connect(i),this._updateMode(),Object(L["a"])(this.view.navigation,"browserTouchPanEnabled",e=>{this._source.browserTouchPanningEnabled=!e})}_updateMode(){const e=this.mode,t=this.primaryDragAction,i=id.get(e).get(t);this._modeDragPan&&(this._modeDragPan.pointerAction=i.pan),this._modeDragRotate&&(this._modeDragRotate.pointerAction=i.rotate),this._modeDragZoom&&(this._modeDragZoom.pointerAction=i.zoom)}get test(){return{inputManager:this._inputManager,modeDragPan:this._modeDragPan,modeDragRotate:this._modeDragRotate,modeDragZoom:this._modeDragZoom}}};Object(d["a"])([Object(g["b"])()],td.prototype,"view",void 0),Object(d["a"])([Object(g["b"])({value:"pan"})],td.prototype,"primaryDragAction",null),Object(d["a"])([Object(g["b"])({value:"default"})],td.prototype,"mode",null),Object(d["a"])([Object(g["b"])({readOnly:!0,aliasOf:"_inputManager.hasPendingInputs"})],td.prototype,"hasPendingInputs",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0,aliasOf:"_inputManager.latestPointerType"})],td.prototype,"latestPointerType",void 0),Object(d["a"])([Object(g["b"])()],td.prototype,"_inputManager",void 0),td=Object(d["a"])([Object(y["a"])("esri.views.3d.input.SceneInputManager")],td);const id=new Map,rd=new Map,ad=new Map;rd.set("pan",{pan:"primary",rotate:"secondary",zoom:"tertiary"}),rd.set("rotate",{pan:"secondary",rotate:"primary",zoom:"tertiary"}),ad.set("pan",{pan:"primary",rotate:"tertiary",zoom:"secondary"}),ad.set("rotate",{pan:"tertiary",rotate:"primary",zoom:"secondary"}),id.set("default",rd),id.set("pro",ad);var nd=td,sd=nd;async function od(e,t){return"3d"===e.type?new((await ld(t.type)).viewConstructor)({view:e,dataObject:t}):null}async function cd(e,t){return"3d"===e.type?new((await ld(t.type)).controllerConstructor)({view:e,dataObject:t}):null}async function ld(e){if(!(e in hd))switch(e){case"DirectLineMeasurement3D":hd[e]=Promise.all([i.e("chunk-0477a460").then(i.bind(null,"ecae")),Promise.all([i.e("chunk-2d22cf8c"),i.e("chunk-35155168")]).then(i.bind(null,"92fb"))]).then(e=>({viewConstructor:e[0].DirectLineMeasurement3DView,controllerConstructor:e[1].DirectLineMeasurement3DController}))}return hd[e]}const hd={};var dd=i("6611"),ud=i("9305"),pd=i("28eb"),fd=i("8a44"),md=i("f895");let bd,gd,vd=!1,yd=!1,Od=!1,_d=!1,xd=null;function jd(e,t){if(!yd||!gd)return;Sd();const i=gd;let r=0;for(let a=0;a<e.accBinsNumX;a++)for(let t=0;t<e.accBinsNumY;t++){const n=e.accBins[a][e.accBinsNumY-1-t];r+=n.length;const s=a*e.accBinsSizeX,o=(a+1)*e.accBinsSizeX,c=t*e.accBinsSizeY,l=(t+1)*e.accBinsSizeY;i.fillText(n.length.toFixed(),s+5,c+15),Td(s,o,c,l,"blue")}i.fillText("total totalShownLabels: "+r,70,40),i.fillText("total visible labels: "+t.size,70,50),i.fillText("total numTests: "+e.accNumTests,70,30)}function wd(e){Od=dd["a"].DECONFLICTOR_SHOW_VISIBLE,_d=dd["a"].DECONFLICTOR_SHOW_INVISIBLE,vd=Od||_d,yd=dd["a"].DECONFLICTOR_SHOW_GRID,xd=null,vd||yd?xd=()=>Cd(e):bd&&(bd.parentElement.removeChild(bd),bd=null)}function Sd(){xd&&(xd(),xd=null)}function Cd(e){null==bd&&(bd=document.createElement("canvas"),bd.setAttribute("id","canvas2d"),e.surface.parentElement.style.position="relative",e.surface.parentElement.appendChild(bd));const t=e.width*e.pixelRatio,i=e.height*e.pixelRatio;bd.setAttribute("width",t+"px"),bd.setAttribute("height",i+"px"),bd.setAttribute("style",`position:absolute;left:0px;top:0px;display:block;pointer-events:none;width:${e.width}px;height:${e.height}px`),gd=bd.getContext("2d"),gd.clearRect(0,0,e.width,e.height),gd.font="12px Arial"}function Td(e,t,i,r,a){Sd();const n=bd.height,s=gd;s.beginPath(),s.lineWidth=1,s.strokeStyle=a,s.moveTo(e,n-i),s.lineTo(t,n-i),s.stroke(),s.lineTo(t,n-r),s.stroke(),s.lineTo(t,n-i),s.stroke(),s.lineTo(e,n-i),s.stroke(),s.lineTo(e,n-i),s.stroke(),s.closePath()}function Pd(e,t){vd&&(t&&Od||!t&&_d)&&Td(e.aabr[0],e.aabr[2],e.aabr[1],e.aabr[3],t?"green":"red")}var Ad=i("da1c"),Rd=i("2df1");const Md=Object(M["e"])(),Ed=Object(Lt["c"])(),Dd=Object(Lt["c"])(),Id=Object(M["e"])(),Ld=Object(kt["b"])(),Vd=Et["h"].create(),kd=Et["g"].create(),Fd=Object(M["e"])(),zd=Object(F["l"])();class Ud{constructor(){this.aabr=Object(F["l"])(),this.distance=0,this.culled=!1,this.visible=!1}}class Gd{constructor(e,t,i={}){this.graphics3DGraphic=e,this.slicePlaneEnabled=t,this.info=i}}class Bd{constructor(){this.active=new Map,this.visible=new Map}clear(){this.active.clear(),this.visible.clear()}}class Hd{}class Nd{constructor(){this.sortArray=new fd["a"]({allocator:e=>e||new Hd})}}class qd{constructor(){this.camera=new Yn["a"],this.slicePlane=Et["b"].create(),this.slicePlaneEnabled=!1}copyFrom(e){this.camera.copyFrom(e.camera),Et["b"].copy(e.slicePlane,this.slicePlane),this.slicePlaneEnabled=e.slicePlaneEnabled}}let Wd=class extends je["a"]{constructor(){super(...arguments),this._dirty=!1,this._runningViewState=new qd,this._state=0,this.graphics=new Bd,this.iterators=new Nd,this.accBinsNumX=15,this.accBinsNumY=20,this.accBinsSizeX=0,this.accBinsSizeY=0,this.accBins=null,this.accNumTests=0}get dirty(){return this._dirty}get state(){return this._state}destroy(){this.graphics.clear(),this.iterators=null}setDirty(){!this._dirty&&this.graphics.active.size>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return 0!==this._state||this._dirty}get updatingProgress(){if(!this.updating)return 1;const e=this._state/4;return this._dirty?.5*e:e}needsUpdate(){return this.view.ready&&null!=this.view.state&&this.updating}update(e){switch(this._state){case 0:this.startUpdate(),e.madeProgress();case 1:if(this._state=1,!this.processActiveGraphics(e))return;case 2:if(this._state=2,!this.sortVisibleGraphics(e))return;case 3:if(this._state=3,!this.deconflictVisibleGraphics(e))return;default:jd(this,this.graphics.visible),this._state=0,this.notifyChange("updating")}}modifyGraphics(e,t){t?e.forEach(e=>this.addToActiveGraphics(e)):e.forEach(e=>this.removeFromActiveGraphics(e)),this.setDirty()}layerSupportsDeconfliction(e){if(Object(p["j"])(e)||"object3d"!==e.type)return!1;const t=e.stageObject;return 1===(t?t.getNumGeometryRecords():0)&&t.getGeometryRecord(0).material instanceof Rd["a"]}startUpdate(){wd(this.view),this._dirty=!1,this._runningViewState.copyFrom(this.viewState);const{fullWidth:e,fullHeight:t}=this._runningViewState.camera;this.initBins(e,t),this.resetIterators()}addToActiveGraphics(e){e.info[this.visibilityGroup]=new Ud,this.graphics.active.set(e.graphics3DGraphic.graphic.uid,e),this.setDirty()}removeFromActiveGraphics(e){this.removeFromVisibleGraphics(e),Zd(e,this.visibilityGroup),delete e.info[this.visibilityGroup],this.graphics.active.delete(e.graphics3DGraphic.graphic.uid),this.setDirty()}addToVisibleGraphics(e){this.graphics.visible.set(e.graphics3DGraphic.graphic.uid,e)}removeFromVisibleGraphics(e){this.graphics.visible.delete(e.graphics3DGraphic.graphic.uid)}processActiveGraphics(e){const t=this.ensureActiveGraphicsIterator(),i=Object(Vt["a"])(Ld,this._runningViewState.camera.projectionMatrix),r="global"===this.view.viewingMode&&1===this.view.map.ground.opacity&&this._runningViewState.camera.relativeElevation>0?Vd:null;let a=0;for(Object(p["k"])(r)&&(Object(It["n"])(r,M["b"],this._runningViewState.camera.viewMatrix),r[3]=Object(V["e"])(this.view.spatialReference).radius,a=Et["h"].distanceToSilhouette(r,M["b"]));!e.done;){e.madeProgress();const n=t.next();if(n.done)return this.resetActiveGraphicsIterator(),!0;const s=n.value,o=s&&s.info[this.visibilityGroup];o&&(this.collectGraphics3DGraphics(s,i,r,a),o.culled?this.removeFromVisibleGraphics(s):this.addToVisibleGraphics(s))}return!1}sortVisibleGraphics(e){const t=this.ensureSortGraphicsIterator();for(;!e.done;){const i=t.next();if(e.madeProgress(),i.done)return this.resetSortGraphicsIterator(),!0}return!1}deconflictVisibleGraphics(e){const t=this.ensureVisibleGraphicsIterator(),i=1===this.visibilityGroup;for(;!e.done;){e.madeProgress();const r=t.next();if(r.done)return this.resetVisibleGraphicsIterator(),!0;const a=r.value,n=a.info[this.visibilityGroup];if(!n||n.culled)continue;const s=a.graphics3DGraphic,o=(!i||s.isVisible())&&!this.isConflicted(a);o&&this.addToBins(a),n.visible=o,this.setGraphicVisibility(a,o),Pd(n,o)}return!1}resetIterators(){this.iterators.active=null,this.iterators.visible=null,this.iterators.sort=null}ensureActiveGraphicsIterator(){return this.iterators.active||(this.iterators.active=$d(this.graphics.active)),this.iterators.active}resetActiveGraphicsIterator(){this.iterators.active=null}ensureVisibleGraphicsIterator(){return this.iterators.visible||(this.iterators.visible=$d(this.graphics.visible)),this.iterators.visible}resetVisibleGraphicsIterator(){this.iterators.visible=null}ensureSortGraphicsIterator(){return this.iterators.sort||(this.iterators.sort=Qd(this.graphics.visible,this.iterators.sortArray,this.visibilityGroup)),this.iterators.sort}resetSortGraphicsIterator(){this.iterators.sort=null}collectGraphics3DGraphics(e,t,i,r){const a=e.graphics3DGraphic;if(a.destroyed)return;const n=e.info[this.visibilityGroup];if(!a.isVisible(0,3))return void(n.culled=!0);const s=this.getGraphicsLayers(a);Object(F["n"])(n.aabr);let o=null;for(const c of s){if(!this.layerSupportsDeconfliction(c))continue;const a=c.stageObject.getGeometryRecord(0).material;if(Object(p["j"])(o)){if(o=this.getProjectionInfo(c,t,Kd),o.isOutsideScreen||this.isCulledBySlice(e,Md)||Object(p["k"])(i)&&this.isCulledByHorizon(o,i,r))return void(n.culled=!0);!dd["a"].DISABLE_DECONFLICTOR_VISIBILITY_OFFSET&&n.visible&&(o.distance*=.7)}this.expandBoundingRect(n,c,a,o)}Object(p["j"])(o)?n.culled=!0:(n.distance=o.distance,n.culled=!1)}getProjectionInfo(e,t,i){const r=this._runningViewState.camera,a=e.stageObject,n=a.getGeometryRecord(0),s=n.material,o=Et["h"].getCenter(a.getBounds());Object(It["n"])(Md,o,r.viewMatrix);const c=n.geometry.vertexAttributes,l=c.get("normal").data,h=c.get("auxpos1").data;return s.applyShaderOffsetsView(Md,l,a.transformation,h,r,i.scaleInfo,Md),Object(ui["l"])(Ed,Md[0],Md[1],Md[2],1),Object(ui["m"])(Dd,Ed,r.projectionMatrix),Object(It["f"])(i.positionNDC,Dd,1/Dd[3]),s.applyShaderOffsetsNDC(i.positionNDC,h,r,i.positionNDC,Id),i.distanceWithoutPolygonOffset=r.depthNDCToWorld(Id[2]),i.distance=Id[2]===i.positionNDC[2]?i.distanceWithoutPolygonOffset:r.depthNDCToWorld(i.positionNDC[2]),Object(ui["l"])(Dd,i.positionNDC[0],i.positionNDC[1],i.positionNDC[2],1),Object(ui["m"])(Ed,Dd,t),Object(ui["b"])(Ed,Ed,1/Ed[3]),Object(It["x"])(i.positionView,Md[0],Md[1],Md[2]),i}isCulledByHorizon(e,t,i){return Object(It["l"])(kd.direction,e.positionView),Object(It["x"])(kd.origin,0,0,0),!!Object(md["d"])(t,kd,Fd)&&e.distanceWithoutPolygonOffset>i}isCulledBySlice(e,t){return e.slicePlaneEnabled&&this._runningViewState.slicePlaneEnabled&&Et["b"].extrusionContainsPoint(this._runningViewState.slicePlane,t)}expandBoundingRect(e,t,i,{positionNDC:r,scaleInfo:a}){const n=this._runningViewState.camera,s=t.getScreenSize(Xd);Object(Ad["a"])(s,a.factor,s),s[0]*=n.pixelRatio,s[1]*=n.pixelRatio;const o=Object(F["y"])(i.calculateRelativeScreenBounds(s,a.factorAlignment.scale,zd),Object(Qe["l"])(0,n.fullWidth,.5+.5*r[0]),Object(Qe["l"])(0,n.fullHeight,.5+.5*r[1])),c=this.iconMarginFactor;if(0!==c){const e=c*Math.min(Object(F["B"])(o),Object(F["u"])(o));o[0]-=e,o[1]-=e,o[2]+=e,o[3]+=e}Object(F["p"])(e.aabr,o)}isConflicted(e){const t=e.graphics3DGraphic.graphic.uid,i=e.info[this.visibilityGroup];for(let r=Math.floor(i.aabr[0]/this.accBinsSizeX);r<=Math.floor(i.aabr[2]/this.accBinsSizeX);r++)if(!(r<0||r>=this.accBinsNumX))for(let e=Math.floor(i.aabr[1]/this.accBinsSizeY);e<=Math.floor(i.aabr[3]/this.accBinsSizeY);e++){if(e<0||e>=this.accBinsNumY)continue;const a=this.accBins[r][e];for(let e=0;e<a.length;e++){const r=a.data[e],n=r.info[this.visibilityGroup];if(n&&n.visible&&r.graphics3DGraphic.graphic.uid!==t&&(this.accNumTests++,Object(F["w"])(n.aabr,i.aabr)))return!0}}return!1}initBins(e,t){if(null==this.accBins){this.accBins=[];for(let e=0;e<this.accBinsNumX;e++){this.accBins.push([]);const e=this.accBins[this.accBins.length-1];for(let t=0;t<this.accBinsNumY;t++)e.push(new fd["a"])}}else for(let i=0;i<this.accBinsNumX;i++)for(let e=0;e<this.accBinsNumY;e++)this.accBins[i][e].clear();this.accBinsSizeX=e/this.accBinsNumX,this.accBinsSizeY=t/this.accBinsNumY,this.accNumTests=0}addToBins(e){const t=e.info[this.visibilityGroup],i=Math.floor(t.aabr[0]/this.accBinsSizeX),r=Math.floor(t.aabr[2]/this.accBinsSizeX),a=Math.floor(t.aabr[1]/this.accBinsSizeY),n=Math.floor(t.aabr[3]/this.accBinsSizeY);for(let s=i;s<=r;s++)if(!(s<0||s>=this.accBinsNumX))for(let t=a;t<=n;t++)t<0||t>=this.accBinsNumY||this.accBins[s][t].push(e)}setGraphicVisibility(e,t){const i=e.graphics3DGraphic;i.destroyed||(i.setVisibilityFlag(3,t,this.visibilityGroup),1===this.visibilityGroup&&this.view.labeler.setLabelGraphicVisibility(i,t))}};function Zd(e,t){const i=e.graphics3DGraphic;i.destroyed||i.clearVisibilityFlag(3,t)}function*$d(e){if(Map.prototype.entries){const t=e.entries();for(let e=t.next();!e.done;e=t.next())yield e.value[1]}else yield*e.values()}function*Qd(e,t,i){t.clear(),e.forEach((e,r)=>{const a=t.pushNew();a.id=r,a.prio=e.info?-e.info[i].distance:Number.MAX_VALUE}),yield;const r=t.iterableSort((e,t)=>t.prio-e.prio);for(let a=r.next();!a.done;a=r.next())yield;t.forAll(t=>{const i=e.get(t.id);i&&(e.delete(t.id),e.set(t.id,i))}),t.clear()}Object(d["a"])([Object(g["b"])({constructOnly:!0})],Wd.prototype,"view",void 0),Object(d["a"])([Object(g["b"])({type:Boolean,readOnly:!0})],Wd.prototype,"updating",null),Wd=Object(d["a"])([Object(y["a"])("esri.views.3d.layers.graphics.Deconflictor")],Wd);const Xd=Object(hi["b"])();class Yd{constructor(){this.positionView=Object(M["e"])(),this.positionNDC=Object(M["e"])(),this.distance=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}}}get isOutsideScreen(){const e=this.positionNDC;return e[0]<-1||e[1]<-1||e[2]<-1||e[0]>=1||e[1]>=1}}const Kd=new Yd,Jd=2e3;let eu=class extends Wd{constructor(){super(...arguments),this.visibilityGroup=1,this.iconMarginFactor=0,this._lastDeconfliction=0}get viewState(){return this.parent.viewState}update(e){if(this.parent.needsUpdate())return;const t=performance.now();(2===e.state||t-this._lastDeconfliction>Jd)&&(super.update(e),0===this.state&&(this._lastDeconfliction=t))}enabledChanged(e,t){this.modifyGraphics(t,e.labelsEnabled)}getGraphicsLayers(e){return e.labelGraphics}};Object(d["a"])([Object(g["b"])({constructOnly:!0})],eu.prototype,"parent",void 0),eu=Object(d["a"])([Object(y["a"])("esri.views.3d.layers.graphics.LabelDeconflictor")],eu);let tu=class extends Wd{constructor(){super(...arguments),this._handles=new we["a"],this._contexts=new Map,this._viewState=new qd,this.visibilityGroup=0,this._iconMarginFactor=-.1}get labels(){return this._labels}get viewState(){return this._viewState}initialize(){this._handles.add([this.view.watch("state.camera",()=>{this.updateViewState(),this.setDirty()}),this.view.watch("map.ground.opacity",(e,t)=>{1!==e&&1!==t||this.setDirty()}),Object(L["a"])(this.view,"slicePlane",()=>{this.updateSlicePlane(),this.slicePlaneChanged()})]),this._frameTask=this.view.resourceController.scheduler.registerTask(ud["b"].GRAPHICS_DECONFLICTOR,e=>this.update(e),()=>this.needsUpdate()),this._labels=new eu({view:this.view,parent:this})}destroy(){this._labels.destroy(),this._labels=null,this._handles.destroy(),this._handles=null,this._frameTask&&(this._frameTask.remove(),this._frameTask=null)}get iconMarginFactor(){return this._iconMarginFactor}set iconMarginFactor(e){this._iconMarginFactor=e,this.setDirty()}setDirty(){this._contexts.size>0&&(super.setDirty(),this._labels.setDirty())}update(e){super.update(e),this.needsUpdate()||this._labels.setDirty()}setInitialIconVisibilityFlag(e,t){const i=!(this._graphicSupportsDeconfliction(t)&&iu(e));t.setVisibilityFlag(3,i,0)}updateViewState(){this.view&&this.view.state&&(this._viewState.camera.copyFrom(this.view.state.camera),this.updateSlicePlane())}updateSlicePlane(){const e=this.view?this.view.slicePlane:null;Object(p["k"])(e)&&Et["b"].transform(e,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=Object(p["k"])(e)}slicePlaneChanged(){Object(pd["b"])(this._contexts,(e,t)=>t.symbolCreationContext.slicePlaneEnabled)&&this.setDirty()}addGraphicsOwner(e){let t=this._contexts.get(e);return null==t&&(t=new Map,this._contexts.set(e,t),this.setDirty()),{addGraphic:i=>this.addGraphic(e,t,i),removeGraphic:e=>this.removeGraphic(t,e),labelingInfoChange:()=>this._labels.enabledChanged(e,t),featureReductionChange:()=>this.enabledChanged(e,t),slicePlaneEnabledChange:()=>this._slicePlaneEnabledChanged(e,t),clear:()=>t.forEach(e=>this.removeGraphic(t,e.graphics3DGraphic))}}removeGraphicsOwner(e){const t=this._contexts.get(e);t&&(t.forEach(e=>this.removeGraphic(t,e.graphics3DGraphic)),this._contexts.delete(e),this.setDirty())}addGraphic(e,t,i){const r=i.graphic.uid,a=new Gd(i,e.symbolCreationContext.slicePlaneEnabled);t.set(r,a),iu(e)&&this.addToActiveGraphics(a),e.labelsEnabled&&this._labels.addToActiveGraphics(a)}removeGraphic(e,t){const i=t.graphic.uid,r=e.get(i);r&&(this.removeFromActiveGraphics(r),this._labels.removeFromActiveGraphics(r),e.delete(i),this.setDirty())}enabledChanged(e,t){const i=iu(e);i||ru(e),this.modifyGraphics(t,i)}_slicePlaneEnabledChanged(e,t){const i=e.symbolCreationContext.slicePlaneEnabled;t.forEach(e=>e.slicePlaneEnabled=i),this.setDirty()}getGraphicsLayers(e){return e._graphics}_graphicSupportsDeconfliction(e){if(e.isDraped)return!1;const t=e._graphics;if(!t||!t.length)return!1;for(const i of t)if(this.layerSupportsDeconfliction(i))return!0;return!1}};function iu(e){const t=e.layer;return!(!t||!t.featureReduction||"selection"!==t.featureReduction.type)}function ru(e){const t=e.graphics3DGraphics;t&&t.forEach(e=>e.clearVisibilityFlag(3))}tu=Object(d["a"])([Object(y["a"])("esri.views.3d.layers.graphics.GraphicsDeconflictor")],tu);var au=i("38bf"),nu=i("792b"),su=i("d3cf"),ou=i("ccac"),cu=i("1a64"),lu=i("e6bc"),hu=i("748f"),du=i("a37d"),uu=i("0494"),pu=i("6339"),fu=i("e384");function mu(e){return e instanceof fu["a"]?e.graphics3DSymbol:e instanceof pu["a"]?e:null}var bu=i("4261");const gu=f["a"].getLogger("esri.views.3d.layers.graphics.labelPlacement");function vu(e){const t=Mu(e);if(Object(p["j"])(t))return null;const i=yu(e,t);if(Object(p["j"])(i))return null;const r=i.anchor,a=!!t.hasLabelVerticalOffset;return wu({anchor:r,verticalOffset:t.verticalOffset,screenOffset:Object(hi["b"])(),centerOffset:Object(Lt["d"])(0,0,0,-1),centerOffsetUnits:"world",translation:Object(M["e"])(),elevationOffset:0,hasLabelVerticalOffset:a},i,e)}function yu(e,t){if(t.anchor)return t;const i=e.labelClass.labelPlacement,r=Du[i],a=r||ju(e);return i&&!r&&gu.warnOncePerTick(`the requested label placement '${i}' is not currently supported in SceneView`),_u(a,e)}function Ou(e){const t=e.graphics3DGraphic.graphics3DSymbol,i=mu(t);return Object(p["k"])(i)?i.symbol.symbolLayers.getItemAt(0):null}function _u(e,t){const i=t.graphics3DGraphic.graphic.geometry;if(Object(p["j"])(i))return null;if(Object(p["k"])(t.disablePlacement))return t.labelClass.labelPlacement?(gu.warnOncePerTick(xu(e.placement,t.disablePlacement.logEntityDescription)),ju(t)):e;const r=i.type;switch(r){case"polyline":case"polygon":case"extent":case"multipoint":if(t.labelClass.labelPlacement)return gu.warnOncePerTick(xu(e.placement,`'${r}' geometries`)),ju(t);break;case"point":case"mesh":return e}return e}function xu(e,t){return`the requested label placement '${e}' is currently unsupported for ${t} in SceneView`}function ju(e){const t=e.graphics3DGraphic.graphic.geometry;if(Object(p["j"])(t))return null;switch(t.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:null,anchor:"center"};case"polygon":{const t=Ou(e);return Object(p["k"])(t)&&"extrude"===t.type?Du["above-center"]:{placement:"center-center",normalizedOffset:null,anchor:"center"}}case"point":case"mesh":return Du["above-center"];default:return}}function wu(e,t,i){const r=i.graphics3DGraphic.graphic.geometry;if(Object(p["j"])(r))return null;switch(r.type){case"point":Cu(e,t,i);break;case"polygon":Su(e,t,i);break;case"mesh":Au(e,t,i)}return e}function Su(e,t,i){const r=Ou(i);if(!Object(p["j"])(r))switch(r.type){case"extrude":{const r=i.graphics3DGraphic._graphics[0];Object(p["k"])(r)&&r.getBoundingBoxObjectSpace(ku),Object(bu["e"])(ku,e.translation),e.translation[2]=Object(bu["v"])(ku)/2,Au(e,t,i);break}}}function Cu(e,t,i){const r=Ou(i);if(!Object(p["j"])(r))switch(i.graphics3DGraphic.getCenterObjectSpace(e.translation),r.type){case"icon":case"text":Tu(e,t,i);break;case"object":Au(e,t,i)}}function Tu(e,t,i){const{graphics3DGraphic:r}=i,a=r._graphics[0],n=Object(p["k"])(a)?a.getScreenSize():null;if(!r.isDraped&&Object(p["k"])(n)){const r=Pu(i);Lu[0]=n[0]/2*(t.normalizedOffset[0]-r[0]),Lu[1]=n[1]/2*(t.normalizedOffset[1]-r[1]),e.screenOffset[0]=Lu[0],e.hasLabelVerticalOffset?(e.centerOffset[1]=Lu[1],e.centerOffsetUnits="screen"):e.screenOffset[1]=Lu[1]}else e.hasLabelVerticalOffset||"center"===e.anchor||(Du[i.labelClass.labelPlacement]&&gu.warnOncePerTick(`the requested placement '${t.placement}' is currently unsupported for draped graphics`),e.anchor="center")}function Pu(e,t=Vu){const{graphics3DGraphic:i}=e,r=i._graphics[0],a=Object(p["k"])(r)?r.stageObject.geometryRecords[0].material:null;if(a&&a instanceof Rd["a"]){const e=a.params.anchorPos;t[0]=2*(e[0]-.5),t[1]=2*(e[1]-.5)}else t[0]=0,t[1]=0;return t}function Au(e,t,i){const r=i.graphics3DGraphic._graphics[0],a=Object(p["k"])(r)?r.getBoundingBoxObjectSpace(ku):ku,n=Object(M["g"])(a[3]-a[0],a[4]-a[1],a[5]-a[2]),s=Math.sqrt(n[0]*n[0]+n[1]*n[1]);e.centerOffset[0]=s/2*t.normalizedOffset[0];const o=e.translation[2],c=n[2]/2*t.normalizedOffset[1];e.translation[2]=0,e.elevationOffset=o+c;const l=Object(It["q"])(n);e.centerOffset[2]=l/2*t.normalizedOffset[2]}function Ru(e){switch(e){case"above-center":return!0;default:return!1}}function Mu(e){const t=e.labelClass.labelPlacement,{labelSymbol:i,graphics3DGraphic:r}=e,a=mu(r.graphics3DSymbol),n=Object(p["k"])(a)?a.symbol:null,s=Du[t]||ju(e);return"point-3d"===n.type&&n.supportsCallout()&&n.hasVisibleVerticalOffset()&&!r.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:Eu(n.verticalOffset),anchor:null,normalizedOffset:null}:!i||!i.hasVisibleVerticalOffset()||"point-3d"===n.type&&n.supportsCallout()&&n.verticalOffset&&!r.isDraped?{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}:Ru(s.placement)?{placement:"above-center",verticalOffset:Eu(i.verticalOffset),anchor:"bottom",normalizedOffset:[0,s.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(gu.errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+t+" placement)"),null)}function Eu(e){const{screenLength:t,minWorldLength:i,maxWorldLength:r}=e;return{screenLength:t,minWorldLength:i,maxWorldLength:r}}const Du={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},Iu={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const FC in Iu){const e=Iu[FC],t=Du[FC];e.forEach(e=>{Du[e]=t})}Object.freeze&&(Object.freeze(Du),Object.keys(Du).forEach((function(e){Object.freeze(Du[e]),Object.freeze(Du[e].normalizedOffset)})));const Lu=[0,0],Vu=[0,0],ku=Object(bu["h"])();class Fu{constructor(e){this._stage=e,this._materials=new Map}get(e){return this._materials.get(e)}add(e,t){this._materials.set(e,t),this._stage.add(t)}dispose(){this._stage.removeMany(Array.from(this._materials.values())),this._materials.clear()}}var zu,Uu=i("f2e0");const Gu=512,Bu=4096,Hu=.85,Nu=.95;let qu=zu=class extends je["a"]{constructor(e){super(e),this.type=4,this.id=Object(Uu["b"])(),this.events=new Ce["a"],this.glTexture=null,this.needsClear=!1,this.elementsToAddOrUpdate=new Map,this.elementsToRemove=new Map,this.elementsToRender=new Map,this.elements=new Map,this.stageObjects=new Map,this.updating=!1}initialize(){this.stage=this.view._stage,this.canvas=this.create2DCanvas(),this.ctx=this.canvas.getContext("2d"),this.stage.add(this);const e=this.computeAtlasResolution(this.view.width,this.view.height);this.createAtlasRegion(e),this.update2DCanvasSize(),this.resetAtlasCursor()}unload(){Object(p["k"])(this.glTexture)&&(this.glTexture.dispose(),this.glTexture=null),this.events.emit("unloaded")}get width(){return this.atlas.size.width}get height(){return this.atlas.size.height}get requiresFrameUpdates(){return!1}createDescriptor(e){return{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,flipped:!0,samplingMode:9987,hasMipmap:!0,preMultiplyAlpha:!0,maxAnisotropy:e.parameters.maxMaxAnisotropy}}load(e){if(Object(p["k"])(this.glTexture))return this.glTexture;this.glTexture=new ti["a"](e,this.createDescriptor(e),this.canvas);const t=this.view.resourceController.scheduler;return this.frameWorker=t.registerTask(ud["b"].TEXT_TEXTURE_ATLAS,e=>this.run(e,!0),()=>this.updating),this.setDirty(),this.glTexture}dispose(){this.elements=null,this.elementsToAddOrUpdate=null,this.elementsToRemove=null,this.elementsToRender=null,this.frameWorker=Object(p["s"])(this.frameWorker),this.glTexture&&(this.stage.remove(this),this.glTexture=null),this.canvas.width=0,this.canvas.height=0,this.canvas=null,this.ctx=null}create2DCanvas(){const e=document.createElement("canvas");return e.setAttribute("id","canvas2d"),e.setAttribute("style","display:none"),e.setAttribute("width",Gu.toString()),e.setAttribute("height",Gu.toString()),e}update2DCanvasSize(){this.canvas.setAttribute("width",this.atlas.size.width.toString()),this.canvas.setAttribute("height",this.atlas.size.height.toString())}createAtlasRegion(e=Gu){this.atlas={size:{width:e,height:e},cursor:{x:0,y:0},lineHeight:0}}computeAtlasResolution(e,t){let i=Math.max(e,t);return i+=256,i=Object(Qe["o"])(i),i=Math.min(i,Bu),i}resizeAtlas(e,t){t=t||e;const i=this.atlas;i.size.width=e,i.size.height=t,Object(p["k"])(this.glTexture)&&this.glTexture.resize(e,t),this.update2DCanvasSize()}resetAtlasCursor(){const e=this.atlas;e.cursor.x=Wu,e.cursor.y=Wu+Zu,e.lineHeight=0,this.needsClear=!0}getAtlasUsage(){const e=this.atlas;return(e.cursor.x+e.cursor.y*e.size.width)/(e.size.width*e.size.height)}getExpectedAtlasUsage(){const e=this.elementsToRemove.size,t=this.elementsToAddOrUpdate.size,i=this.elements.size;return this.getAtlasUsage()/i*(i+t-e)}addAtlasElement(e,t,i,r){const a=this.atlas,{renderedWidth:n,renderedHeight:s,displayWidth:o,displayHeight:c}=e.textRenderer;e.placement.offset.x=a.cursor.x,e.placement.offset.y=a.cursor.y,e.placement.size.width=n,e.placement.size.height=s,e.placement.size.displayWidth=o,e.placement.size.displayHeight=c,e.placement.uvMinMax=[e.placement.offset.x/a.size.width,1-(e.placement.offset.y+s)/a.size.height,(e.placement.offset.x+n)/a.size.width,1-e.placement.offset.y/a.size.height],a.cursor.x+=i,a.lineHeight=Math.max(a.lineHeight,r),this.elements.set(t,e)}removeAtlasElement(e){if(e&&this.elements.has(e.textId)){const t=e.placement.offset,i=e.placement.size;this.ctx.clearRect(t.x,t.y,i.width,i.height),this.elements.delete(e.textId)}}ensureStageObjects(e){const t=this.stageObjects.get(e);if(t)return t;const i=new Set;return this.stageObjects.set(e,i),i}addStageObject(e,t){this.ensureStageObjects(e).add(t)}removeStageObject(e,t){const i=this.stageObjects.get(e);i&&i.delete(t)&&(t.geometries[0].vertexAttributes.get("size").data=[0,0],t.geometryVertexAttrsUpdated(0))}_processAddition(e,t){const i=this.atlas,r=e.textId,a=e.textRenderer.renderedWidth,n=e.textRenderer.renderedHeight,s=a+Wu,o=n+Wu+Zu;if(i.cursor.x+s<i.size.width&&i.cursor.y+o<i.size.height)this.addAtlasElement(e,r,s,o),this.elementsToRender.set(r,e),this.elementsToAddOrUpdate.delete(r);else{if(!(i.cursor.y+o+i.lineHeight<i.size.height)){const e=this.getExpectedAtlasUsage(),r=e>Hu&&i.size.width<Bu;return r&&this.resizeAtlas(2*i.size.width,2*i.size.height),!t||!r&&e>Nu&&i.size.width===Bu?(this.processRemovals(),0):(this.repack(),1)}i.cursor.x=Wu,i.cursor.y+=i.lineHeight,i.lineHeight=0,this.addAtlasElement(e,r,s,o),this.elementsToRender.set(r,e),this.elementsToAddOrUpdate.delete(r)}return 0}processRemovals(){this.elementsToRemove.forEach((e,t)=>{const i=this.stageObjects.get(t);i&&0!==i.size||this.removeAtlasElement(e),i&&0===i.size&&this.stageObjects.delete(t)}),this.elementsToRemove.clear()}repack(){this.processRemovals(),this.elements.forEach((e,t)=>{e.rendered=!1,this.elementsToAddOrUpdate.set(t,e)}),this.elements.clear(),this.resetAtlasCursor(),this.elementsToRender.clear()}processRenderingRequest(e){this.ctx.clearRect(e.placement.offset.x,e.placement.offset.y,e.placement.size.width,e.placement.size.height),e.textRenderer.render(this.ctx,e.placement.offset.x,e.placement.offset.y);const t=this.stageObjects.get(e.textId);t&&t.forEach(t=>{t.geometries[0].vertexAttributes.get("uv0").data=new Float32Array(e.placement.uvMinMax),t.geometries[0].vertexAttributes.get("size").data=[e.placement.size.displayWidth,e.placement.size.displayHeight],t.geometryVertexAttrsUpdated(0)}),e.rendered=!0}run(e,t){if(!this.glTexture)return;let i=!1;if(Object(pd["b"])(this.elementsToAddOrUpdate,(e,r)=>{const a=this.elements.get(r);if(a&&a.rendered){const e=this.stageObjects.get(r);return e&&e.forEach(e=>{const t=e.geometries[0].vertexAttributes,i=this.elements.get(r);t.get("uv0").data=new Float32Array(i.placement.uvMinMax),t.get("size").data=new Float32Array([i.placement.size.displayWidth,i.placement.size.displayHeight]),e.geometryVertexAttrsUpdated(0)}),this.elementsToAddOrUpdate.delete(r),!1}return 1===this._processAddition(this.elementsToAddOrUpdate.get(r),t)&&(i=!0,!0)}),i)return void this.run(ud["d"],!1);let r=!1;this.elementsToRender.size>0&&this.needsClear&&(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.needsClear=!1),Object(pd["b"])(this.elementsToRender,(t,i)=>(this.processRenderingRequest(t),this.elementsToRender.delete(i),r=!0,e.madeProgress(),e.done)),r&&Object(p["k"])(this.glTexture)&&this.glTexture.setData(this.canvas),this.updating=this.elementsToRender.size>0,!this.updating&&zu.test.orderedRepackingEnabled&&this.repackOrdered()}addTextTexture(e,t){const i=e.key;this.elementsToAddOrUpdate.has(i)||this.elementsToAddOrUpdate.set(i,{textId:i,placement:{offset:{x:0,y:0},size:{width:0,height:0,displayWidth:0,displayHeight:0},uvMinMax:[]},textRenderer:e,rendered:!1}),this.addStageObject(i,t),this.elementsToRemove.delete(i),this.setDirty()}removeTextTexture(e,t){const i=e.key;this.elementsToRemove.set(i,this.elements.get(i)),this.removeStageObject(i,t)}setDirty(){this.updating=!0}repackOrdered(){if(0===this.elements.size)return;const e=[];this.elements.forEach((t,i)=>e.push({element:t,key:i}));let t=!0;for(let i=0;i<e.length-1;i++)if(e[i].key.localeCompare(e[i+1].key)>0){t=!1;break}if(!t||this.elementsToRemove.size){e.sort((e,t)=>e.key.localeCompare(t.key)),this.elements.clear();for(const{element:t,key:i}of e)this.elements.set(i,t);this.repack(),this.setDirty()}}get test(){const{elements:e,stageObjects:t,elementsToRemove:i,atlas:r}=this,a=this;return{elements:e,stageObjects:t,elementsToRemove:i,atlas:r,resizeAtlas:(e,t)=>a.resizeAtlas(e,t),run:(e,t)=>a.run(e,t)}}};qu.test={orderedRepackingEnabled:!1},Object(d["a"])([Object(g["b"])({constructOnly:!0})],qu.prototype,"view",void 0),Object(d["a"])([Object(g["b"])({type:Boolean})],qu.prototype,"updating",void 0),qu=zu=Object(d["a"])([Object(y["a"])("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],qu);const Wu=2,Zu=2;var $u=qu,Qu=$u;const Xu=f["a"].getLogger("esri.views.3d.layers.graphics.Labeler");let Yu=class extends je["a"]{constructor(){super(...arguments),this._dirty=!1,this.labels=new Map,this.labelsToAdd=new Map,this.labelsToRemove=new Map,this.labelingContexts=[]}setup(){if(Object(p["j"])(this.handles)){const e=this.view.resourceController.scheduler;this.handles=new we["a"],this.handles.add([this.view.watch("state.camera",()=>this.setDirty()),this.view.watch("pixelRatio",()=>this.resetAllLabels()),e.registerTask(ud["b"].LABELER,e=>this.update(e),()=>this.needsUpdate())])}Object(p["j"])(this.textTextureAtlas)&&(this.textTextureAtlas=new Qu({view:this.view}),this.hudMaterialCollection=new Fu(this.view._stage),this.calloutMaterialCollection=new Fu(this.view._stage))}dispose(){this.handles=Object(p["e"])(this.handles),this.textTextureAtlas=Object(p["f"])(this.textTextureAtlas),this.hudMaterialCollection=Object(p["f"])(this.hudMaterialCollection),this.calloutMaterialCollection=Object(p["f"])(this.calloutMaterialCollection),this.labelingContexts=[],this.labels.clear(),this.labelsToAdd.clear(),this.labelsToRemove.clear()}isActiveLabelingContext(e){return e.active&&Object(ve["a"])(e.layer)}activateLabelingContext(e){e.labels.forEach((e,t)=>{this.labels.set(t,e),e.graphics3DGraphic.setVisibilityFlag(0,!0,1)}),e.active=!0}deactivateLabelingContext(e){e.labels.forEach((e,t)=>{e.graphics3DGraphic.setVisibilityFlag(0,!1,1),this.setLabelGraphicVisibility(e.graphics3DGraphic,!1),this.labels.delete(t)}),e.active=!1}addLabelTextureToAtlas(e){for(const t of e.graphics3DGraphic.labelGraphics){if(!t._labelClass)continue;const i=e.textRenderers[t._labelIndex];i&&this.textTextureAtlas.addTextTexture(i,t.stageObject)}e.rendered=!0}removeLabelTextureFromAtlas(e){for(const t of e.graphics3DGraphic.labelGraphics){if(!t._labelClass)continue;const i=e.textRenderers[t._labelIndex];i&&this.textTextureAtlas.removeTextTexture(i,t.stageObject)}e.rendered=!1}needsUpdate(){return this.view.ready&&this.isDirty}update(e){this._updateLabels(e),!this._dirty&&this.deconflictor.needsUpdate()&&this.deconflictor.update(e)}_updateLabels(e){if(this._dirty){this._dirty=!1;for(const t of this.labelingContexts)if(this.isActiveLabelingContext(t)){if(!this.hasValidLabelClassContext(t)){if(this.hasInvalidLabelClassContext(t)){this.deactivateLabelingContext(t);continue}if(this.createLabelClassContext(t),this.hasPendingLabelClassContext(t)){this._dirty=!0;continue}if(!this.hasValidLabelClassContext(t))continue}Object(pd["b"])(t.labelsToInitialize,(i,r)=>(this.ensureGraphics3DResources(i)&&(this.labels.set(r,i),this.deconflictor.setDirty(),e.madeProgress()),(i.visible&&i.hasTextTextureResources||!i.visible&&i.hasGraphics3DResources)&&(t.labelsToInitialize.delete(r),e.madeProgress()),e.done))&&(this._dirty=!0)}this.labelsToRemove.forEach(e=>this.removeLabelTextureFromAtlas(e)),this.labelsToRemove.clear(),this.labelsToAdd.forEach(e=>this.addLabelTextureToAtlas(e)),this.labelsToAdd.clear(),this._dirty||this.notifyChange("updating")}}hasPendingLabelClassContext(e){return e.labelClassPromise&&!!e.labelClassAbortController}hasValidLabelClassContext(e){return e.labelClassContexts&&e.labelClassContexts.length}hasInvalidLabelClassContext(e){return null===e.labelClassContexts}async createLabelClassContextAsync(e){const t=e.labelClassAbortController.signal;await e.layer.when(),Object(j["w"])(t),e.scaleVisibility&&e.scaleVisibility.updateScaleRangeActive();const i=e.graphics3DCore,r=i.layer,a=r.labelingInfo&&r.labelingInfo.filter(e=>!!e.symbol);if(!a||0===a.length)return;const n=new Array(a.length);let s=!1;await Object(nu["b"])(a,async(r,a)=>{const o=r.symbol,c=mu(i.getOrCreateGraphics3DSymbol(o));if(Object(p["j"])(c))return void Xu.error("Failed to create Graphics3DSymbol for label");await c.load(),Object(j["w"])(t);let l=null;Object(au["d"])(o)&&o.hasVisibleCallout()&&(l=Object(cu["a"])(o,i.symbolCreationContext),await l.load(),Object(j["w"])(t));const h=await Object(nu["d"])(Object(ou["createLabelFunction"])(r,e.layer.fields.map(e=>e.toJSON()),this.view.spatialReference));Object(j["w"])(t),!0===h.ok?n[a]={labelClass:r,labelFunction:h.value,graphics3DSymbol:c,graphics3DCalloutSymbolLayer:l,calloutSymbolLayerIndex:0,textRenderParameters:this.createTextRenderParameters(c.symbol)}:(Xu.error("Label expression failed to evaluate: "+h.error),s=!0)}),Object(j["w"])(t),s||(e.labelClassContexts=n)}async createLabelClassContext(e){return e.labelClassPromise||(e.labelClassPromise=this.createLabelClassContextAsync(e).catch(t=>{if(Object(j["n"])(t))throw t;e.labelClassContexts=null}).then(()=>{e.labelClassAbortController=null,this.notifyChange("updating")}).catch(()=>{}),this.notifyChange("updating")),e.labelClassPromise}createTextRenderParameters(e){const t=e.symbolLayers.getItemAt(0);return t&&"text"===t.type?du["a"].fromSymbol(t,this.view.pixelRatio):null}destroyLabelClassContext(e){for(const i of e.labelClassContexts)--i.graphics3DSymbol.referenced,i.graphics3DSymbol=null;const t=e.labelClassAbortController;e.labelClassAbortController=Object(j["e"])(),t&&t.abort(),e.labelClassContexts=[],e.labelClassPromise=null,this.notifyChange("updating")}createTextSymbolGraphic(e,t,i,r,a){const n={text:e.text,centerOffset:i.centerOffset,translation:i.translation,elevationOffset:i.elevationOffset,screenOffset:i.screenOffset,anchor:i.anchor,centerOffsetUnits:i.centerOffsetUnits,verticalOffset:i.verticalOffset,debugDrawBorder:dd["a"].LABELS_SHOW_BORDER,displayWidth:e.displayWidth,displayHeight:e.displayHeight};return Ku.graphic=t,Ku.renderingInfo=null,Ku.layer=r,a.createLabel(Ku,n,this.hudMaterialCollection,this.textTextureAtlas)}createLineCalloutGraphic(e,t,i,r,a){const n={symbol:t,translation:r.translation,elevationOffset:r.elevationOffset,screenOffset:r.screenOffset,centerOffset:r.centerOffset,centerOffsetUnits:r.centerOffsetUnits,materialCollection:this.calloutMaterialCollection};return Ku.graphic=e,Ku.renderingInfo=n,Ku.layer=a,i.createGraphics3DGraphic(Ku)}ensureGraphics3DResources(e){if(e.hasGraphics3DResources)return!1;const t=e.graphics3DGraphic;if(t.destroyed)return!1;this.ensureTextTextureResources(e);const i=e.labelingContext,r=i.labelClassContexts;if(!r||0===r.length||!i.emptySymbolLabelSupported&&0===t._graphics.length)return!1;let a=!1;const n=t.graphic,s=i.layer,o=Object(ve["a"])(i.layer),c=this.view._stage;for(let l=0;l<r.length;l++){const h=e.textRenderers[l];if(!h)continue;const d=r[l],u=d.graphics3DSymbol;let f=null;u.symbol&&"label-3d"===u.symbol.type&&(f=u.symbol);const m=u.symbolLayers[0];if(!m)continue;const b=d.labelClass,g=i.disablePlacement,v=vu({graphics3DGraphic:t,labelSymbol:f,labelClass:b,disablePlacement:g});if(Object(p["j"])(v))continue;m.setElevationInfoOverride(i.elevationInfoOverride);const y=this.createTextSymbolGraphic(h,n,v,s,m);if(!y)return!1;y._labelClass=b,y._labelIndex=l,t.addLabelGraphic(y,c,i.stageLayer),t.setVisibilityFlag(0,o,1),t.clearVisibilityFlag(1,1),t.setVisibilityFlag(3,!1,1),a=!0;const O=d.graphics3DCalloutSymbolLayer;if(O&&v.hasLabelVerticalOffset){O.setElevationInfoOverride(i.elevationInfoOverride);const e=this.createLineCalloutGraphic(n,f,O,v,s);e&&(d.calloutSymbolLayerIndex=t.labelGraphics.length,t.addLabelGraphic(e,c,i.stageLayer))}break}return i.scaleVisibility&&a&&i.scaleVisibility.updateGraphicLabelScaleVisibility(t),e.hasGraphics3DResources=!0,!0}destroyGraphics3DResources(e){const t=e.labelingContext.labelClassContexts;for(const i of e.graphics3DGraphic.labelGraphics){if(null==i._labelClass)continue;const e=t[i._labelIndex].graphics3DSymbol.symbolLayers[0];null!=e&&e.onRemoveGraphic(i)}e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1}ensureTextTextureResources(e){if(e.hasTextTextureResources)return;const t=e.labelingContext,i=t.labelClassContexts;if(!i||0===i.length)return;const r=e.graphics3DGraphic.graphic;for(let n=0;n<i.length;n++){const s=i[n];if(e.textRenderers[n]=null,!s.textRenderParameters)continue;const o=s.labelFunction;let c;if("arcade"===o.type)try{const e=o.needsHydrationToEvaluate()?Object(su["c"])(r,t.layer):r;c=o.evaluate(e)}catch(a){c=null}else c=o.evaluate(r);Object(p["j"])(c)||""===c||/^\s+$/.test(c)||(e.textRenderers[n]=new uu["a"](c,s.textRenderParameters))}e.hasTextTextureResources=!0}destroyTextTextureResources(e){e.textRenderers=[],e.hasTextTextureResources=!1}addGraphic(e,t){const i={hasGraphics3DResources:!1,hasTextTextureResources:!1,visible:!1,rendered:!1,labelingContext:e,graphics3DGraphic:t,textRenderers:[]},r=t.graphic.uid;e.labels.set(r,i),e.labelsToInitialize.set(r,i),this.setDirty(),this.deconflictor.setDirty()}removeGraphic(e,t){const i=t.graphic.uid,r=e.labels.get(i);r&&(this.destroyGraphic(r,i),e.labels.delete(i),e.labelsToInitialize.delete(i),this.setDirty(),this.deconflictor.setDirty())}destroyGraphic(e,t){this.labels.has(t)&&(this.labels.delete(t),this.labelsToAdd.delete(t),this.labelsToRemove.delete(t)),e.hasTextTextureResources&&(this.removeLabelTextureFromAtlas(e),this.destroyTextTextureResources(e)),e.hasGraphics3DResources&&this.destroyGraphics3DResources(e)}async labelingInfoChange(e,t){if(!t)return this.visibilityInfoChange(e),this.resetLabels(e),this.createLabelClassContext(e);for(const i of t){const t=e.labels.get(i);t&&(this.removeGraphic(e,t.graphics3DGraphic),this.addGraphic(e,t.graphics3DGraphic))}}globalPropertyChanged(e,t){for(const i of t.labelClassContexts){const r=new Map;t.labels.forEach(e=>{const t=e.graphics3DGraphic;r.set(t.graphic.uid,t)});const a=e=>e.labelGraphics[0];if(Object(p["t"])(i.graphics3DSymbol.symbolLayers[0]).globalPropertyChanged(e,r,a),i.graphics3DCalloutSymbolLayer){const t=e=>e.labelGraphics[i.calloutSymbolLayerIndex];i.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,r,t)}}}visibilityInfoChange(e){const t=e.layer.labelsVisible;t&&!e.active&&this.activateLabelingContext(e),!t&&e.active&&this.deactivateLabelingContext(e),this.setDirty()}resetAllLabels(){for(const e of this.labelingContexts)this.resetLabels(e)}resetLabels(e){e.labels.forEach((t,i)=>{this.destroyGraphic(t,i),t.visible=!1,t.rendered=!1,e.labelsToInitialize.set(i,t)}),this.destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()}findLabelingContext(e){for(const t of this.labelingContexts)if(t.graphics3DCore===e)return t;return null}addGraphicsOwner(e,t,i){const r=i&&i.emptySymbolLabelSupported||!1,a=i&&i.elevationInfoOverride||null,n=i&&i.disablePlacement||null;if(this.findLabelingContext(e))return;const s=e.layer,o={graphics3DCore:e,layer:s,scaleVisibility:t,emptySymbolLabelSupported:r,elevationInfoOverride:a,disablePlacement:n,active:s.labelsVisible,labelClassPromise:null,labelClassAbortController:Object(j["e"])(),labelClassContexts:[],labels:new Map,labelsToInitialize:new Map,stageLayer:new hu["a"]({isPickable:!0},s.uid)};return this.view._stage.add(o.stageLayer),this.labelingContexts.push(o),this.setDirty(),{addGraphic:e=>this.addGraphic(o,e),removeGraphic:e=>this.removeGraphic(o,e),featureReductionChange:()=>{},layerLabelsEnabled:()=>Object(ve["a"])(o.layer),labelingInfoChange:e=>this.labelingInfoChange(o,e),elevationInfoChange:()=>this.globalPropertyChanged("elevationInfo",o),slicePlaneEnabledChange:()=>this.globalPropertyChanged("slicePlaneEnabled",o),visibilityInfoChange:()=>this.visibilityInfoChange(o),reset:()=>this.resetLabels(o),clear:()=>{},processStageDirty:()=>o.stageLayer.commit()}}removeGraphicsOwner(e){const t=this.findLabelingContext(e);if(!t)return;const i=this.labelingContexts.indexOf(t);this.labelingContexts.splice(i,1),t.labels.forEach(e=>this.removeGraphic(t,e.graphics3DGraphic)),this.view._stage.remove(t.stageLayer),t.stageLayer=null,this.setDirty()}setLabelGraphicVisibility(e,t){const i=e.graphic.uid,r=this.labels.get(i);r&&r.visible!==t&&(t&&!r.rendered?(this.labelsToAdd.set(i,r),this.labelsToRemove.delete(i),r.hasTextTextureResources||r.labelingContext.labelsToInitialize.set(i,r)):!t&&r.rendered&&(this.labelsToRemove.set(i,r),this.labelsToAdd.delete(i)),r.visible=t,this.setDirty())}get isDirty(){return this._dirty||this.textTextureAtlas&&this.textTextureAtlas.updating||this.deconflictor.needsUpdate()}setDirty(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))}get updating(){return this._dirty||this.textTextureAtlas&&this.textTextureAtlas.updating||this.deconflictor.updating||this.labelingContexts.some(e=>this.hasPendingLabelClassContext(e))}get updatingProgress(){if(!this.updating||!this.textTextureAtlas)return 1;const e=this.labelingContexts.length>0?this.labelingContexts.reduce((e,t)=>e+(this.hasPendingLabelClassContext(t)?0:1),0)/this.labelingContexts.length:1;return(this._dirty?0:.3)+(this.textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}get test(){return{textTextureAtlas:this.textTextureAtlas,resetAllLabels:()=>this.resetAllLabels()}}};Object(d["a"])([Object(g["b"])({constructOnly:!0})],Yu.prototype,"view",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],Yu.prototype,"deconflictor",void 0),Object(d["a"])([Object(g["b"])()],Yu.prototype,"textTextureAtlas",void 0),Object(d["a"])([Object(g["b"])({type:Boolean,readOnly:!0})],Yu.prototype,"updating",null),Yu=Object(d["a"])([Object(y["a"])("esri.views.3d.layers.graphics.Labeler")],Yu);const Ku=new lu["a"](null,null,null);var Ju=i("2b60"),ep=i("3c3b"),tp=i("22f5");class ip{constructor(){this.gltfCache=new Map,this.wosrCache=new Map,this.evictHandles=new we["a"]}loadGLTF(e,t,i){const r=i?"gltfPBR:"+e:"gltf:"+e;return this.fromCache(this.gltfCache,r,t=>Object(ep["a"])(new Ju["a"](t.streamDataRequester),e,t,i),t)}loadWOSR(e,t){const i=`wosr:${e}:${t.disableTextures}`;return this.fromCache(this.wosrCache,i,t=>Object(tp["a"])(e,t),t)}destroy(){this.evictHandles.destroy(),this.gltfCache.clear(),this.wosrCache.clear()}get size(){return this.wosrCache.size+this.gltfCache.size}fromCache(e,t,i,r){return new Promise((a,n)=>{if(Object(j["o"])(r))return void n(Object(j["f"])());const s=Object(j["r"])(r,()=>{this.remove(e,t),n(Object(j["f"])())}),o=e.get(t);if(o)return this.evictHandles.remove(t),o.refCount++,void o.item.then(a,n);const c=Object(j["e"])(),l={...r,signal:c.signal},h={refCount:1,abortController:c,item:i(l).then(i=>(h.abortController=null,i.remove=()=>this.remove(e,t),i))};e.set(t,h),h.item.then(e=>{Object(p["k"])(s)&&s.remove(),a(e)},e=>{Object(p["k"])(s)&&s.remove(),n(e)})})}remove(e,t){const i=e.get(t);i&&(i.refCount--,0===i.refCount&&this.evictHandles.add(Object(b["e"])(()=>{e.delete(t),Object(p["k"])(i.abortController)&&i.abortController.abort()},ap),t))}}const rp=1e4;let ap=rp;class np{constructor(e,t,i,r=null){this.lij=[0,0,0],this.extent=Object(F["l"])(),this.resolution=0,this.loadPriority=0,this.measures={visibility:2,screenRect:Object(F["l"])(),distance:0,shouldSplit:!1},this.used=!1,r&&this.acquire(e,t,i,r)}acquire(e,t,i,r){this.tilingScheme=r,this.id=np.id(e,t,i),this.lij[0]=e,this.lij[1]=t,this.lij[2]=i,r.getExtent(e,t,i,this.extent),this.resolution=r.resolutionAtLevel(e)}release(){this.tilingScheme=null}getChildren(e){const t=this.lij[0]+1,i=2*this.lij[1],r=2*this.lij[2];return e?(e[0].acquire(t,i,r,this.tilingScheme),e[1].acquire(t,i+1,r,this.tilingScheme),e[2].acquire(t,i,r+1,this.tilingScheme),e[3].acquire(t,i+1,r+1,this.tilingScheme),e):[new np(t,i,r,this.tilingScheme),new np(t,i+1,r,this.tilingScheme),new np(t,i,r+1,this.tilingScheme),new np(t,i+1,r+1,this.tilingScheme)]}copyMeasurementsFrom(e){this.measures.visibility=e.measures.visibility,this.measures.shouldSplit=e.measures.shouldSplit,this.measures.distance=e.measures.distance,Object(F["z"])(e.measures.screenRect,this.measures.screenRect)}static id(e,t,i){return`${e}/${t}/${i}`}}var sp=i("ecd7"),op=i("3482");class cp{constructor(e){this.renderCoordsHelper=e,this.frustum=Object(op["c"])(),this._points=Object(op["a"])(),this.lines=new Array(12),this.origin=Object(M["e"])(),this.direction=Object(M["e"])(),this._altitude=null;for(let t=0;t<12;t++)this.lines[t]={origin:null,direction:Object(M["e"])(),endpoint:null}}get planes(){return this.frustum}get points(){return this._points}get mutablePoints(){return this._points}update(e){Object(op["b"])(e.viewMatrix,e.projectionMatrix,this.frustum,this._points),Object(It["l"])(this.origin,e.eye),Object(It["l"])(this.direction,e.viewForward),this._altitude=this.renderCoordsHelper.getAltitude(this.origin),this.updateLines()}updatePoints(e){for(let t=0;t<this._points.length;t++)Object(It["l"])(this._points[t],e[t]);Object(op["d"])(this.frustum,this._points),this.updateLines()}get altitude(){return this._altitude}intersectsSphere(e){return Object(op["i"])(this.frustum,e)}intersectsRay(e){return Object(op["e"])(this.frustum,e)}intersectsLineSegment(e,t){return Object(op["g"])(this.frustum,e,t)}intersectsPoint(e){return Object(op["h"])(this.frustum,e)}updateLines(){const e=this._points;for(let t=0;t<4;t++){const i=t,r=t+4;lp(this.lines[t],e[i],e[r]),lp(this.lines[t+4],e[i],3===t?e[0]:e[i+1]),lp(this.lines[t+8],e[r],3===t?e[4]:e[r+1])}}}function lp(e,t,i){e.origin=t,e.endpoint=i,Object(Xe["h"])(e.direction,t,i)}cp.planePointIndices=op["k"],cp.nearFarLineIndices=[[0,4],[1,5],[2,6],[3,7]];var hp=i("6b38");class dp{constructor(e){this.renderCoordsHelper=e,this.surfaceElevation=0,this.cache=new Map,this.frustum=new cp(e),this.extendedFrustum=new cp(e),this.intersector=new hp["a"]({renderCoordsHelper:e}),this.renderCoordsHelper=e}begin(e,t){this.surfaceElevation=t,this.aboveGround=this.renderCoordsHelper.getAltitude(e.eye)>t,this.frustum.update(e),this.shortenFrustumFarPlane(this.frustum),this.updateExtendedFrustum(e)}end(){this.cache.clear()}calculate(e){if(this.allTilesInvisible)return 0;const t=1===this.renderCoordsHelper.viewingMode&&e.lij[0]>=up&&e.lij[0]<pp,i=this.getOrCalculateSingleTileVisibility(e,!t);return 0!==i&&t?this.calculateAggregatedChildrenVisibility(e):i}shortenFrustumFarPlane(e){const t=cp.nearFarLineIndices,i=e.mutablePoints;for(const r of t){const[e,t]=r,a=i[e],n=i[t];Object(It["k"])(gp,n,a),Object(It["f"])(gp,gp,mp),Object(It["g"])(i[t],a,gp)}e.updatePoints(i)}calculateAggregatedChildrenVisibility(e){let t=0;const i=this.cache.get(e.id);if(null!=i)return i;const r=Op.acquire();e.getChildren(r);for(const a of r){const e=this.calculate(a);if(0!==e&&(t=e,2===e))break}return Op.release(r),this.cache.set(e.id,t),t}getOrCalculateSingleTileVisibility(e,t){const i=this.cache.get(e.id);if(null!=i)return i;const r=this.calculateSingleTileVisibility(e);return t&&this.cache.set(e.id,r),r}calculateSingleTileVisibility(e){return!this.aboveGround&&1===this.renderCoordsHelper.viewingMode&&e.lij[0]<fp?0===this.calculateSingleTileVisibilitySided(e,!1)?this.calculateSingleTileVisibilitySided(e,!0):void 0:this.calculateSingleTileVisibilitySided(e,this.aboveGround)}calculateSingleTileVisibilitySided(e,t){this.intersector.update(e.extent,e.tilingScheme.spatialReference,this.surfaceElevation,t);const i=Object(V["e"])(e.tilingScheme.spatialReference).radius;return this.intersector.isVisibleInFrustum(this.extendedFrustum,i)?this.intersector.isVisibleInFrustum(this.frustum,i,!0)?2:1:0}updateExtendedFrustum(e){this.extendedFrustum.update(e),this.shortenFrustumFarPlane(this.extendedFrustum);const t=this.renderCoordsHelper.worldUpAtPosition(e.eye,gp);this.aboveGround||Object(It["u"])(t,t);const i=Object(Qe["b"])(-Object(It["i"])(t,e.viewForward));if(this.allTilesInvisible=i>(Math.PI+e.fovY)/2,this.allTilesInvisible)return;if(this.hasExtendedFrustum=i>e.fovY/2,!this.hasExtendedFrustum)return;const r=this.extendedFrustumParameters(),a=this.extendedFrustum.mutablePoints;for(let n=0;n<4;n++){const e=r.pointIndices[n],t=a[e],i=this.renderCoordsHelper.getAltitude(t);if(r.needsAltitudeAdjustment(i)){switch(this.renderCoordsHelper.worldUpAtPosition(t,gp),e){case 4:case 7:case 0:case 3:Et["f"].projectVector(this.extendedFrustum.planes[0],gp,gp);break;case 5:case 6:case 1:case 2:Et["f"].projectVector(this.extendedFrustum.planes[1],gp,gp)}Object(It["f"])(gp,gp,r.direction),this.renderCoordsHelper.intersectInfiniteManifold(Et["g"].wrap(t,gp),r.zWithMargin,t)}}if(this.extendedFrustum.updatePoints(a),Et["f"].fromPoints(a[0],a[1],a[2],vp),Et["f"].fromPoints(a[1],a[2],a[3],yp),Object(It["i"])(Et["f"].normal(vp),Et["f"].normal(yp))<0){const e=this.extendedFrustum.mutablePoints;this.aboveGround?[e[0],e[1]]=[e[1],e[0]]:[e[3],e[2]]=[e[2],e[3]],this.extendedFrustum.updatePoints(e)}}extendedFrustumParameters(){return this.aboveGround?this.extendedFrustumParametersAboveSurface():this.extendedFrustumParametersBelowSurface()}extendedFrustumParametersAboveSurface(){const e=this.surfaceElevation-bp;return{zWithMargin:e,pointIndices:cp.planePointIndices.bottom,direction:-1,needsAltitudeAdjustment:t=>t>e}}extendedFrustumParametersBelowSurface(){const e=this.surfaceElevation+bp;return{zWithMargin:e,pointIndices:cp.planePointIndices.top,direction:1,needsAltitudeAdjustment:t=>t<e}}}const up=2,pp=6,fp=12,mp=.95,bp=1,gp=Object(M["e"])(),vp=Et["f"].create(),yp=Et["f"].create(),Op=new sp["a"](Array,e=>{4!==e.length&&(e[0]=new np,e[1]=new np,e[2]=new np,e[3]=new np)},e=>{e[0].release(),e[1].release(),e[2].release(),e[3].release()});var _p=dp;class xp{constructor(e){this.camera=new Yn["a"],this.focusOnMap=[0,0],this.screenRect=Object(F["l"])(),this.tileSize=e.tileSize,this.maxVerticalScreenSize=e.maxVerticalScreenSize,this.renderCoordsHelper=e.renderCoordsHelper,this.tilingScheme=e.tilingScheme,this.visibility=new _p(e.renderCoordsHelper)}begin(e,t,i){this.camera.copyFrom(e),this.surfaceElevation=i,this.focusOnMap[0]=t.x,this.focusOnMap[1]=t.y,Object(F["t"])(0,0,e.fullWidth,e.fullHeight,this.screenRect),this.visibility.begin(this.camera,i)}end(){this.visibility.end()}updateTile(e){e.measures.visibility=this.visibility.calculate(e),e.measures.distance=Object(F["m"])(e.extent,this.focusOnMap),0!==e.measures.visibility&&this.updateScreenMeasure(e)}updateScreenMeasure(e){const t=Sp,i=1<<t,r=e.measures.screenRect;Object(F["n"])(r);let a=0;const n=e.lij[0]+t,s=e.lij[1]<<t,o=e.lij[2]<<t,c=this.tileSizeWithBias(e),l=c*c;let h=!1;for(let d=0;d<i;d++){for(let t=0;t<i;t++)if(a+=this.computeScreenArea(e,n,s+d,o+t,r).area,h=a>l&&Object(F["u"])(r)>this.maxVerticalScreenSize,h)break;if(h)break}e.measures.shouldSplit=a>l}tileSizeWithBias(e){return 1===e.measures.visibility?this.tileSize*Cp:this.tileSize}computeScreenArea(e,t,i,r,a){const n=1===e.measures.visibility,s=Tp.points;this.projectToScreen(t,i,r,n,s),Object(F["n"])(jp);for(let o=0;o<4;o++)Object(F["q"])(jp,s[o]);return Object(F["p"])(a,jp),Object(F["v"])(jp,this.screenRect,wp),Tp.screenOverlap=Object(F["d"])(wp)/Object(F["d"])(jp),Tp.area=Et["i"].areaPoints2d(s[0],s[1],s[2])+Et["i"].areaPoints2d(s[0],s[2],s[3]),Tp}projectToScreen(e,t,i,r,a){this.tilingScheme.ensureMaxLod(e),this.tilingScheme.getExtent(e,t,i,Pp),this.toRenderCoords(Pp,0,3,Rp[0]),this.toRenderCoords(Pp,2,3,Rp[1]),this.toRenderCoords(Pp,2,1,Rp[2]),this.toRenderCoords(Pp,0,1,Rp[3]),r&&(this.projectToPlane(Rp,this.camera.frustum[4]),this.projectToPlane(Rp,this.camera.frustum[3]),this.projectToPlane(Rp,this.camera.frustum[2]));for(let n=0;n<4;n++)this.camera.projectToRenderScreen(Rp[n],Ep),this.camera.renderToScreen(Ep,a[n])}projectToPlane(e,t){for(let r=0;r<4;r++)Mp[r]=Et["f"].signedDistance(t,e[r]);const i=Math.max(Mp[0],Mp[1],Mp[2],Mp[3]);if(i>0){const r=Object(It["f"])(Ap,Et["f"].normal(t),-i);for(let t=0;t<4;t++)Object(It["g"])(e[t],e[t],r)}}toRenderCoords(e,t,i,r){return Ap[0]=e[t],Ap[1]=e[i],Ap[2]=this.surfaceElevation,this.renderCoordsHelper.toRenderCoords(Ap,this.tilingScheme.spatialReference,r),r}}const jp=Object(F["l"])(),wp=Object(F["l"])(),Sp=2,Cp=5,Tp={points:[Object(A["g"])(),Object(A["g"])(),Object(A["g"])(),Object(A["g"])()],area:0,screenOverlap:0},Pp=Object(F["l"])(),Ap=Object(M["e"])(),Rp=[Object(M["e"])(),Object(M["e"])(),Object(M["e"])(),Object(M["e"])()],Mp=[0,0,0,0],Ep=Object(A["e"])();var Dp=i("4b49");const Ip=f["a"].getLogger("esri.views.3d.layers.support.FeatureTileTree3D");let Lp=class extends je["a"]{constructor(e){super(e),this.tiles=new P["a"],this.tileSize=512,this._idToTile=new Map,this._handles=new we["a"],this._clients=new Set,this._dirty=!1,this._newTiles=new fd["a"]}get tilingScheme(){const e=this.tilingSchemeOwner.tilingScheme;return e?e.clone():null}set filterExtent(e){if(e&&!e.spatialReference.equals(this.viewState.spatialReference))return void Ip.error("#extent","extent spatial reference needs to be in the same spatial reference as the view");const t=this._get("filterExtent");if(t===e||t&&e&&t.equals(e))return;const i=e?e.clone():null;this._set("filterExtent",i),this._setDirty()}get filterExtentRect(){if(!this.filterExtent||!this.tilingScheme)return null;const e=Object(F["l"])();return Object(Dp["b"])(this.filterExtent,e,this.tilingScheme.spatialReference),e}get rootTileIds(){return this.filterExtentRect?this.tilingScheme.rootTilesInExtent(this.filterExtentRect):[[0,0,0]]}set suspended(e){e!==this._get("suspended")&&(this._set("suspended",e),this._setDirty())}get updating(){return this._dirty||!!this._pendingTiles}initialize(){this._handles.add(this.watch(["tilingScheme","tileSize"],()=>this._reset(),!0)),this._handles.add(Object(L["a"])(this,["tileSize","cameraOnSurface.location","tilingScheme","viewState.contentCamera","focus.location"],()=>this._setDirty(),!0)),this.scheduler&&(this._frameWorker=this.scheduler.registerTask(ud["b"].FEATURE_TILE_TREE,e=>this._update(e),()=>this.updating))}destroy(){this._frameWorker=Object(p["s"])(this._frameWorker),this._handles=Object(p["e"])(this._handles)}addClient(){const e=kp();return this._clients.add(e),1===this._clients.size&&this._setDirty(),{remove:()=>this._removeClient(e)}}_removeClient(e){this._clients.delete(e),this._hasClients||this._clear()}get _hasClients(){return this._clients.size>0}_setDirty(){!this._hasClients||this.suspended||this._dirty||(this._frameWorker?(this._dirty=!0,this.notifyChange("updating")):this._update(ud["d"]))}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(),this._dirty=!1,this.notifyChange("updating")}_update(e){this._dirty=!1,this._pendingTiles||(this._startUpdate(),Object(p["k"])(this._frameWorker)&&(this._frameWorker.task=ud["b"].FEATURE_TILE_TREE_ACTIVE)),this._subdivideTilesForView(e),!this._pendingTiles&&Object(p["k"])(this._frameWorker)&&(this._frameWorker.task=ud["b"].FEATURE_TILE_TREE),this.notifyChange("updating")}_startUpdate(){if(this.suspended)return;if(!this.tilingScheme)return void this._clear();this._tileMeasurements||(this._tileMeasurements=new xp({renderCoordsHelper:this.renderCoordsHelper,tilingScheme:this.tilingScheme,tileSize:this.tileSize,maxVerticalScreenSize:zp}));const e=this.viewState.contentCamera;this._tileMeasurements.begin(e,this.focus.location,this.cameraOnSurface.location.z),this._pendingTiles=this._getRootTiles()}_reset(){this._newTiles.clear(),this._tileMeasurements=null,this._pendingTiles=null,this._setDirty()}_getRootTiles(){return this.rootTileIds.map(e=>new np(e[0],e[1],e[2],this.tilingScheme))}_purgeHorizonTiles(e){e.sort((e,t)=>{const i=e.measures.screenRect,r=t.measures.screenRect;return i[1]+i[3]-(r[1]+r[3])}),Object(F["n"])(Fp);for(let t=0;t<e.length;t++)if(Object(F["p"])(Fp,e.data[t].measures.screenRect),Object(F["u"])(Fp)>zp)return e.data.slice(t,e.length);return[]}_subdivideTilesForView(e){if(this._pendingTiles){for(;this._pendingTiles.length>0&&!e.done;){const t=this._pendingTiles.pop();e.madeProgress(),this.filterExtentRect&&!Object(F["w"])(this.filterExtentRect,t.extent)||(this._tileMeasurements.updateTile(t),0!==t.measures.visibility&&(t.measures.shouldSplit?(this.tilingScheme.ensureMaxLod(t.lij[0]+1),this._pendingTiles.push(...t.getChildren())):this._newTiles.push(t)))}0===this._pendingTiles.length&&(this._updateTiles(this._purgeHorizonTiles(this._newTiles)),this._newTiles.clear(),this._tileMeasurements.end(),this._pendingTiles=null)}}_updateTiles(e){for(const r of this.tiles.items)r.used=!1;const t=e.filter(e=>{const t=this._idToTile.get(e.id);return t?(t.copyMeasurementsFrom(e),t.used=!0):this._idToTile.set(e.id,e),!t}),i=this.tiles.items.filter(e=>!e.used&&(this._idToTile.delete(e.id),!0));this.tiles.removeMany(i),this.tiles.addMany(t),this.sortTiles()}sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort((e,t)=>e.measures.visibility!==t.measures.visibility?2===e.measures.visibility?-1:1:e.measures.distance-t.measures.distance),this.tiles.forEach((e,t)=>e.loadPriority=t)}};Object(d["a"])([Object(g["b"])({constructOnly:!0})],Lp.prototype,"scheduler",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],Lp.prototype,"renderCoordsHelper",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],Lp.prototype,"tilingSchemeOwner",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],Lp.prototype,"cameraOnSurface",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],Lp.prototype,"focus",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],Lp.prototype,"viewState",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],Lp.prototype,"terrain",void 0),Object(d["a"])([Object(g["b"])()],Lp.prototype,"tiles",void 0),Object(d["a"])([Object(g["b"])()],Lp.prototype,"tileSize",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],Lp.prototype,"tilingScheme",null),Object(d["a"])([Object(g["b"])()],Lp.prototype,"filterExtent",null),Object(d["a"])([Object(g["b"])({readOnly:!0})],Lp.prototype,"filterExtentRect",null),Object(d["a"])([Object(g["b"])({readOnly:!0})],Lp.prototype,"rootTileIds",null),Object(d["a"])([Object(g["b"])({value:!1})],Lp.prototype,"suspended",null),Object(d["a"])([Object(g["b"])({readOnly:!0})],Lp.prototype,"updating",null),Lp=Object(d["a"])([Object(y["a"])("esri.views.3d.layers.support.FeatureTileTree3D")],Lp);let Vp=0;function kp(){return Vp++}const Fp=Object(F["l"])(),zp=10;var Up=Lp,Gp=Up,Bp=i("9714"),Hp=i("0646");let Np=class extends je["a"]{constructor(){super(),this._propertiesPool=new Bp["a"]({camera:Yn["a"]},this),this._lastSeenCameraProjectionValues=new Yn["a"],this.events=new Ce["a"],this.mode=1,this._cameraChanged=!1,this.updateQueue=new Array,this.processingUpdates=!1}exit(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new Bp["a"]({camera:Yn["a"]},this)}init(e,t){this._set("mode",e),this._set("spatialReference",t),this.camera=Zp(this.mode,t),this._set("constraints",new nt({mode:this.mode}))}get animation(){return this.cameraController instanceof zs&&Object(p["k"])(this.cameraController.viewAnimation)?this.cameraController.viewAnimation:null}get camera(){return this._get("camera")}set camera(e){e!==Wp&&Wp.copyFrom(e),Wp.markViewDirty(),Wp.computeUp(this.mode),$p.camera=Wp,this.events.emit("before-camera-change",$p);const t=this._get("camera");if(this.cameraProjectionChanged(this._lastSeenCameraProjectionValues,Wp)&&(this._lastSeenCameraProjectionValues.copyFrom(Wp),Qp.camera=this._lastSeenCameraProjectionValues,this.events.emit("camera-projection-changed",Qp)),(!t||!t.equals(Wp))&&(this._set("camera",this._propertiesPool.get("camera").copyFrom(Wp)),this._cameraChanged=!t||!t.almostEquals(Wp),this._cameraChanged)){const e=Object(Hp["a"])(()=>{this._cameraChanged=!1,e.remove()})}}get contentCamera(){return Object(p["k"])(this._contentCamera)?this._contentCamera:this.camera}set contentCamera(e){this._contentCamera=Object(p["k"])(e)?e.clone():null}get fixedContentCamera(){return!!Object(p["k"])(this._contentCamera)}get isGlobal(){return!this.isLocal}get isLocal(){return 2===this.mode}get navigating(){return!(!this.cameraController||!this.cameraController.isInteractive)}get stationary(){return!this._cameraChanged&&!this.navigating}get cameraController(){return this._get("cameraController")}set cameraController(e){this.stopActiveCameraController()?(e&&(e.watch("state",t=>{t!==ks.Finished&&t!==ks.Stopped||(this._set("cameraController",null),this.updateCamera(t=>e.onControllerEnd(t)))},!0),e.onControllerStart(this.camera)),this._set("cameraController",e)):e&&(e.state=ks.Rejected)}switchCameraController(e){return this.cameraController=e,e.state!==ks.Rejected}stopActiveCameraController(){return!(this.cameraController&&!this.cameraController.stopController())}updateCamera(e){this.updateQueue.push(e),this.processUpdateQueue()}processUpdateQueue(){if(0===this.updateQueue.length||this.processingUpdates)return;this.processingUpdates=!0;const e=this.updateQueue.shift();Wp.copyFrom(this._get("camera")),e(Wp),this.camera=Wp,this.processingUpdates=!1,this.processUpdateQueue()}cameraProjectionChanged(e,t){return e.fov!==t.fov||e.fullViewport[0]!==t.fullViewport[0]||e.fullViewport[1]!==t.fullViewport[1]||e.fullViewport[2]!==t.fullViewport[2]||e.fullViewport[3]!==t.fullViewport[3]||e.padding[0]!==t.padding[0]||e.padding[1]!==t.padding[1]||e.padding[2]!==t.padding[2]||e.padding[3]!==t.padding[3]}};Object(d["a"])([Object(g["b"])({readOnly:!0,type:ze["a"]})],Np.prototype,"animation",null),Object(d["a"])([Object(g["b"])({type:Yn["a"]})],Np.prototype,"camera",null),Object(d["a"])([Object(g["b"])({})],Np.prototype,"_contentCamera",void 0),Object(d["a"])([Object(g["b"])({type:Yn["a"]})],Np.prototype,"contentCamera",null),Object(d["a"])([Object(g["b"])({readOnly:!0})],Np.prototype,"fixedContentCamera",null),Object(d["a"])([Object(g["b"])({readOnly:!0})],Np.prototype,"constraints",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],Np.prototype,"events",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],Np.prototype,"isGlobal",null),Object(d["a"])([Object(g["b"])({readOnly:!0})],Np.prototype,"isLocal",null),Object(d["a"])([Object(g["b"])({readOnly:!0})],Np.prototype,"mode",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],Np.prototype,"spatialReference",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],Np.prototype,"navigating",null),Object(d["a"])([Object(g["b"])({readOnly:!0})],Np.prototype,"stationary",null),Object(d["a"])([Object(g["b"])()],Np.prototype,"_cameraChanged",void 0),Object(d["a"])([Object(g["b"])()],Np.prototype,"cameraController",null),Np=Object(d["a"])([Object(y["a"])("esri.views.3d.state.ViewState")],Np);var qp=Np;const Wp=new Yn["a"];function Zp(e,t){if(1===e){const e=Object(V["e"])(t).radius;return new Yn["a"](Object(M["g"])(4*e,0,0),Object(M["g"])(e,0,0),Object(M["g"])(0,0,1))}return new Yn["a"](Object(M["g"])(0,0,100),Object(M["g"])(0,0,0),Object(M["g"])(0,1,0))}const $p={camera:null},Qp={camera:null};var Xp=qp,Yp=i("8048");function Kp(e,t,i){return 1===e?new ef(i):new Jp(t,i)}class Jp{constructor(e,t){this.elevationProvider=e,this._referenceEllipsoid=Object(V["e"])(t),this.unitInMeters=Object(Yp["e"])(t,this._referenceEllipsoid.metersPerDegree)}compute(e,t,i,r,a){a||(a={near:0,far:0});let n=e[2]*this.unitInMeters;const s=n,o=n-r,c=this.elevationProvider?this.elevationProvider.elevationBounds:null;c&&(n=o>=0?s-this.unitInMeters*c.min:this.unitInMeters*c.max-s);const l={x:i.xmax-i.xmin,y:i.ymax-i.ymin,z:4*Math.max(i.xmax-i.xmin,i.ymax-i.ymin)},h=Math.max(l.x,l.y,l.z);Object(It["k"])(cf,t,e),of[0]=cf[0]>0?i.xmax:i.xmin,of[1]=cf[1]>0?i.ymax:i.ymin,of[2]=cf[2]>0?h/2:-h/2,Object(It["k"])(of,of,e),Object(It["s"])(cf,cf);const d=1.1*Object(It["i"])(of,cf)*this.unitInMeters,u=Math.sqrt(n*(n+2*this._referenceEllipsoid.radius)),p=Math.max(i.xmax-i.xmin,i.ymax-i.ymin),f=p*nf*this.unitInMeters,m=p*sf*this.unitInMeters;let b=Object(Qe["d"])((n-m)/(f-m),0,1);b*=b*b;let g=Object(Qe["l"])(u,d,b);return g*=Math.max(Math.log(Math.abs(o)),1),g=Math.min(g,Math.max(34064e4,h)),g/=this.unitInMeters,tf(g,rf,this.unitInMeters,a)}}class ef{constructor(e){this._referenceEllipsoid=Object(V["e"])(e)}compute(e,t,i,r,a){a||(a={near:0,far:0});const n=Object(It["q"])(e)-this._referenceEllipsoid.radius,s=this._referenceEllipsoid.radius+Math.min(0,r),o=Math.abs(n-r),c=Math.max(o,Math.abs(n));return tf(1.2*Math.sqrt(c*(c+2*s)),Object(Qe["d"])(2e4-(Math.log(c)-7.983)/9.011*19e3,1e3,2e4),1,a)}}function tf(e,t,i,r){const a=af/i;return e/t>a?(r.far=e,r.near=r.far/t):(r.near=a,r.far=r.near*t),r}const rf=2e4,af=2,nf=.001,sf=1e-4,of=Object(M["e"])(),cf=Object(M["e"])();i("8d95");var lf=i("4054");i("19b9"),i("a125");let hf=class extends je["a"]{constructor(e){super(e),this.handles=new we["a"]}initialize(){this.handles.add(this.view.basemapTerrain.on("elevation-change",e=>this.handleElevationChangeEvent(e)))}destroy(){this.handles&&(this.handles.destroy(),this.handles=null)}handleElevationChangeEvent(e){if(this.view.state.cameraController)return;const t=this.view.state.camera;Yr(this.view,t,e.extent,e.spatialReference)&&this.applyToCurrentCamera()}applyToCurrentCamera(){this.view.state.updateCamera(e=>{ca(this.view,e,1)})}};Object(d["a"])([Object(g["b"])({constructOnly:!0})],hf.prototype,"view",void 0),hf=Object(d["a"])([Object(y["a"])("esri.views.3d.state.ElevationCollisionConstraint")],hf);var df=hf,uf=df;let pf=class extends je["a"]{constructor(e){super(e),this._handles=new we["a"],this.nearFarHeuristic=Kp(e.view.state.mode,e.view.basemapTerrain,e.view.renderCoordsHelper.spatialReference)}initialize(){this._handles.add([this.view.watch(["constraints.clipDistance.near","constraints.clipDistance.far"],()=>this._clipDistanceNearFarChanged()),this.view.watch("constraints.clipDistance.mode",()=>this._updateNearFar()),this.view.state.events.on("before-camera-change",e=>this._updateCameraNearFar(e.camera)),this.view.watch("dataExtent",()=>this._updateNearFar(),!0),this.view.watch(["constraints.altitude.min","constraints.altitude.max"],()=>this._updateAltitude(),!0),this.view.watch("constraints.tilt.max",()=>this._updateTiltMax(),!0),this.view.watch("constraints.tilt.mode",()=>this._updateTilt(),!0),this.view.watch("state.camera",()=>this._updateTiltAutoMax(),!0),this.view.watch(["map.ground.navigationConstraint.type","constraints.collision.enabled"],()=>this._updateCollision(),!0)]),this.view.state.isLocal&&this._handles.add(Object(L["a"])(this.view,"dataExtent",e=>this._updateLocalSurfaceDistance(e))),this._updateNearFar(),2!==this.view.state.mode&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new uf({view:this.view}))}destroy(){this._handles=Object(p["e"])(this._handles),this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null))}_clipDistanceNearFarChanged(){const e=this.view.constraints&&this.view.constraints.clipDistance;e&&"auto"!==e.mode&&this.view.state.updateCamera(t=>(this._updateCameraNearFarManual(t,e),!0))}_updateNearFar(){this.view.state.updateCamera(e=>(this._updateCameraNearFar(e),!0))}_updateCameraNearFar(e){const t=this.view.constraints&&this.view.constraints.clipDistance;"manual"===(t?t.mode:"auto")?this._updateCameraNearFarManual(e,t):this._updateCameraNearFarAuto(e,t)}_updateCameraNearFarAuto(e,t){this.nearFarHeuristic.compute(e.eye,e.center,this.view.dataExtent,Kr(this.view,e.eye),e),t&&t.autoUpdate(e.near,e.far)}_updateCameraNearFarManual(e,t){t&&(e.near=t.near,e.far=t.far)}_updateCollision(){var e,t,i;const r=null==(e=this.view.map)||null==(t=e.ground)||null==(i=t.navigationConstraint)?void 0:i.type,a=!r||"stay-above"===r,n=this.view.state.constraints.collision;if(a!==n.enabled){n.enabled=a,a&&this._reapplyConstraints(8);const e=this.view.constraints&&this.view.constraints.tilt;e&&"auto"!==e.mode||this._updateTiltAuto()}}_updateAltitude(){const e=this.view.constraints&&this.view.constraints.altitude;e&&2!==this.view.state.mode?this.view.state.constraints.altitude={min:e.min,max:e.max}:this.view.state.constraints.altitude=null,this._reapplyConstraints()}_updateTiltMax(){const e=this.view.constraints&&this.view.constraints.tilt;e&&"auto"!==e.mode&&(this._updateTiltManual(e),this._reapplyConstraints())}_updateTilt(){const e=this.view.constraints&&this.view.constraints.tilt;"manual"===(e?e.mode:"auto")?this._updateTiltManual(e):this._updateTiltAuto(),this._reapplyConstraints()}_updateTiltManual(e){const t=this.view.state.constraints;t.tilt=t.createConstantMaxTilt(Object(Qe["f"])(e.max))}_updateTiltAuto(){const e=this.view.state.constraints;e.tilt=e.createDefaultTilt(),this._updateTiltAutoMax()}_updateTiltAutoMax(){const e=this.view.constraints&&this.view.constraints.tilt;if(!e||"auto"!==e.mode)return;const t=this.view.state.constraints;if(t.tilt){const i=t.tilt(this.view.state.camera.distance).max;e.autoUpdate(Object(Qe["q"])(i))}}_updateLocalSurfaceDistance(e){let t=Math.max(e.width,e.height);if(t<=0)return;e.hasZ&&(t=Math.max(t,e.zmax-e.zmin));const i=this.view.state,r=3*t/Math.atan(i.camera.fov/2);r!==i.constraints.distance&&(i.constraints.distance=r)}_reapplyConstraints(e=15){this.view.state.updateCamera(t=>Nn(this.view,t,{selection:e,interactionType:0,interactionFactor:null,interactionStartCamera:null,interactionDirection:null,tiltMode:0}))}};Object(d["a"])([Object(g["b"])({constructOnly:!0})],pf.prototype,"view",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],pf.prototype,"surfaceCollisionConstraint",void 0),pf=Object(d["a"])([Object(y["a"])("esri.views.3d.state.ConstraintsManager")],pf);var ff=pf,mf=ff;let bf=class extends Fs{constructor(e){super(e),this.handles=new we["a"]}set desiredCamera(e){this._set("desiredCamera",e.clone())}get canStop(){return!0}get constraintEnabled(){return this.view.state.constraints.collision.enabled}onControllerStart(){this.state=ks.Running,this.handles.add(this.view.basemapTerrain.on("elevation-change",e=>this.handleElevationChangeEvent(e))),this.applyCorrection()}onControllerEnd(){this.handles.removeAll()}stepController(){}handleElevationChangeEvent(e){Yr(this.view,this.desiredCamera,e.extent,e.spatialReference)&&this.applyCorrection()}applyCorrection(){this.view.state.updateCamera(e=>{e.copyViewFrom(this.desiredCamera),ca(this.view,e,1)||this.constraintEnabled||(this.state=ks.Stopped)})}};Object(d["a"])([Object(g["b"])({constructOnly:!0})],bf.prototype,"view",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],bf.prototype,"desiredCamera",null),bf=Object(d["a"])([Object(y["a"])("esri.views.3d.state.controllers.SurfaceCollisionCorrectionController")],bf);var gf=i("3760");const vf=.66;function yf(e){return 360-Xe["f"].normalize(e)}function Of(e){return Xe["f"].normalize(360-e)}function _f(e){return Object(p["k"])(e)&&e.resolver&&e.resolver.reject(),null}function xf(e,t){return Object(p["k"])(e)&&e.resolver&&e.resolver.resolve(t),t}function jf(e,t,i,r=null){if(!t)return _f(r);const a=e.spatialReference||c["a"].WGS84;if(Object(p["k"])(t.camera)){const e=t.get("camera.position.spatialReference");if(!Object(S["a"])(e,a))return _f(r);const i=t.camera.clone();return e.equals(a)||(i.position=Object(S["d"])(i.position,a)),xf(r,i)}if(Object(p["j"])(t.targetGeometry))return _f(r);const n=t.get("targetGeometry.spatialReference");if(n&&!Object(S["a"])(n,a))return _f(r);const s=Vl(e,e.state.camera);let o=1;if(null!=t.rotation&&(s.heading=yf(t.rotation),o=0),null!=i&&(s.tilt=i),"point"===t.targetGeometry.type){const i=t.targetGeometry;let a;const n=t.targetGeometry.clone();return a=null!=t.scale?kl(e,t.scale,i.latitude):e.state.camera.distance,Ul(e,n,a,s,o,r)}const l=t.targetGeometry.extent;return $l(e,l,s.heading,s.tilt,o,r)}function wf(e,t,i=null){return Object(p["j"])(i)&&(i=new I["a"]),Af(e,null,t.clone(),i)}async function Sf(e,t,i){const r=Bf(e,t);if(!r)throw new O["a"]("viewpointutils-create:no-target","Missing target for creating viewpoint");const a=new E["a"]({fov:e.camera.fov}),n=new I["a"]({camera:a});if(r.target instanceof I["a"])return Hf(await Df(e,r.target,r,i,n));if(r.target instanceof E["a"])return Hf(If(e,r.target,n));const s=null!=r.scale||null!=r.zoom;if(r.target instanceof T["a"]){const t=r.target.xmin===r.target.xmax||r.target.ymin===r.target.ymax;return Hf(s||t?await Vf(e,r,r.target.center,a,i,n):await zf(e,r,r.target,a,i,n))}const o={boundingBox:Object(bu["k"])(),hasZ:!1,screenSpaceObjects:[]},c=s?Tf(e,r):void 0;if(await Ef(e,r.target,c,o),isFinite(o.boundingBox[0])){let t;if(Object(bu["e"])(o.boundingBox,qf),em.x=qf[0],em.y=qf[1],em.z=qf[2],em.spatialReference=e.spatialReference,isFinite(em.z)&&o.hasZ?t=Object(bu["y"])(o.boundingBox):(em.z=void 0,t=Object(F["x"])(Object(bu["G"])(o.boundingBox,Qf))),s||t)return Hf(await Vf(e,r,em,a,i,n));const c=Nf(e,o.screenSpaceObjects);return Hf(await Gf(e,r,em,o.boundingBox,c,a,i,n))}return r.position?Hf(kf(e,r,a,n)):Hf(await Ff(e,r,a,i,n))}function Cf(e,t){return null==t.scale&&null!=t.zoom?nh(e,t.zoom):t.scale}function Tf(e,t){return sh(e,Cf(e,t))}function Pf(e,t){let i=!1;return null!=t.heading?(e.heading=t.heading,i=!0):null!=t.rotation&&(e.heading=yf(t.rotation),i=!0),null!=t.tilt&&(e.tilt=t.tilt,i=!0),null!=t.fov&&(e.fov=t.fov),i}function Af(e,t,i,r){const a=e.spatialReference||c["a"].WGS84;return t=Object(p["k"])(t)?t:Il(e,i),Object(p["j"])(t)||(r.targetGeometry=Object(z["x"])(t.center,e.renderSpatialReference,a),r.scale=oh(e,t),r.rotation=Of(i.heading),r.camera=i),r}function Rf(e,t,i){if(!t)return;if(!Object(S["a"])(t.spatialReference,e.spatialReference))throw new O["a"]("viewpointutils:incompatible-spatialreference",`Spatial reference (${t.spatialReference?t.spatialReference.wkid:"unknown"}) is incompatible with the view (${e.spatialReference.wkid})`,{geometry:t});const r=[];if(!t.hasZ&&e.basemapTerrain){let i;switch(t.type){case"point":i=t;break;case"multipoint":case"polyline":case"mesh":i=t.extent.center;break;case"extent":i=t.center;break;case"polygon":i=t.centroid}i&&Object(S["a"])(i,e.basemapTerrain.spatialReference)?qf[2]=Object(p["u"])(Object(xe["b"])(e.elevationProvider,i),0):qf[2]=0}(0,tm[t.type])(t,e=>{r.push(e[0],e[1],e[2])},qf);const a=r.length/3;if(0===a)return;const n=new Array(r.length);if(Object(z["q"])(r,t.spatialReference,0,n,e.spatialReference,0,a)){t.hasZ&&(i.hasZ=!0);for(let e=0;e<n.length;e+=3)t.hasZ?(qf[0]=n[e+0],qf[1]=n[e+1],qf[2]=n[e+2]):(qf[0]=n[e+0],qf[1]=n[e+1]),Object(bu["r"])(i.boundingBox,qf)}}async function Mf(e,t,i,r){const a=await Object(nu["d"])(e.whenViewForGraphic(t));if(!1===a.ok||Object(p["j"])(a.value)||!("whenGraphicBounds"in a.value))return void Rf(e,t.geometry,r);const n=a.value,s=await Object(nu["d"])(n.whenGraphicBounds(t,{minDemResolution:i}));if(!1===s.ok)return void Rf(e,t.geometry,r);const{screenSpaceObjects:o,boundingBox:c}=s.value;Object(bu["m"])(r.boundingBox,c),o&&o.forEach(e=>{r.screenSpaceObjects.push(e)}),isFinite(c[2])&&(r.hasZ=!0)}async function Ef(e,t,i,r){if(Array.isArray(t)&&2===t.length){const i=t[0],a=t[1];if("number"==typeof i&&"number"==typeof a)return em.x=i,em.y=a,em.z=void 0,em.spatialReference=e.spatialReference.isGeographic?e.spatialReference:c["a"].WGS84,void Rf(e,em,r)}t&&"function"==typeof t.map?await Object(j["k"])(t.map(t=>Ef(e,t,i,r))):t instanceof gf["a"]?Rf(e,t,r):t instanceof R["a"]&&await Mf(e,t,i,r)}async function Df(e,t,i,r,a){if(Object(p["k"])(t.camera))return If(e,t.camera,a);a.scale=t.scale,a.rotation=t.rotation,a.targetGeometry=Object(p["k"])(t.targetGeometry)?t.targetGeometry.clone():null,a.camera=null,null!=i.heading?a.rotation=Of(i.heading):null!=i.rotation&&(a.rotation=i.rotation);const n=Cf(e,i);null!=n&&(a.scale=n);const s=new ch(r);return jf(e,a,i.tilt,s),a.camera=await s.resolver.promise,a}function If(e,t,i){const r=e.spatialReference,a=t.position.spatialReference;return Object(S["a"])(a,r)?((t=t.clone()).fov=e.camera.fov,a.equals(r)||(t.position=Object(S["d"])(t.position,r)),Af(e,null,t,i)):null}function Lf(e,t,i,r,a,n){const s=e.renderSpatialReference;return Object(z["t"])(i.position,Yf,s),Object(z["t"])(t,Kf,s),n.targetGeometry=new C["a"](t),a.position=new C["a"](i.position),Object(It["k"])(Xf,Kf,Yf),Gl(e,Yf,Xf,r.up,a),n.scale=Fl(e,Object(It["p"])(Yf,Kf),n.targetGeometry.latitude),n.rotation=Of(a.heading),n.camera=a,n}async function Vf(e,t,i,r,a,n){if(Object(p["j"])(i))throw new O["a"]("createfromcenter","invalid point");n.targetGeometry=i.clone();const s=Jr(e);if(t.position)return Lf(e,n.targetGeometry,t,s,r,n);if(t.zoomFactor){const r=s.distance/t.zoomFactor,a=Object(It["f"])(qf,s.viewForward,-r);Object(It["g"])(s.eye,s.center,a),s.markViewDirty(),n.scale=Fl(e,r,i.latitude)}Vl(e,s,r);const o=Pf(r,t)?0:1;if(!t.zoomFactor){n.scale=Cf(e,t),null==n.scale&&(Object(z["t"])(i,qf,e.renderSpatialReference),Et["d"].intersectsPoint(s.frustum,qf)?n.scale=Fl(e,Object(It["p"])(s.eye,qf),i.latitude):n.scale=oh(e,s));const c=new ch(a);zl(e,n.targetGeometry,n.scale,r,o,c),n.camera=await c.resolver.promise}return n}function kf(e,t,i,r){const a=Jr(e);return Object(It["l"])(Xf,a.viewForward),Gl(e,a.eye,Xf,a.up,Jf),i.position=new C["a"](t.position),i.heading=null!=t.heading?t.heading:Jf.heading,i.tilt=null!=t.tilt?t.tilt:Jf.tilt,Af(e,null,i,r)}async function Ff(e,t,i,r,a){const n=Jr(e);return Vf(e,t,Object(z["x"])(n.center,e.renderSpatialReference,e.spatialReference),i,r,a)}async function zf(e,t,i,r,a,n){n.targetGeometry=i.clone();const s=Jr(e);Vl(e,s,r);const o=Pf(r,t)?0:1,c=new ch(a);return $l(e,i,r.heading,r.tilt,o,c),n.camera=await c.resolver.promise,n}function Uf(e,t,i,r,a){let n=0;i.hasZ?n=i.z:e.basemapTerrain&&(n=Object(p["t"])(Object(xe["b"])(e.elevationProvider,i))),Object(It["x"])(qf,i.x,i.y,n),Object(z["d"])(e.spatialReference,qf,Wf,e.renderSpatialReference),Object(Jn["f"])(Zf,Wf),Object(Jn["n"])(Zf,Zf),Object(bu["k"])($f);const s=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];for(let p=0;p<s.length;p++){const t=s[p];let i=r[t[2]];isFinite(i)||(i=n),Object(It["x"])(qf,r[t[0]],r[t[1]],i),Object(z["y"])(qf,e.spatialReference,qf,e.renderSpatialReference),Object(bu["r"])($f,Object(It["y"])(qf,qf,Zf))}const o=Object(bu["H"])($f),c=Object(bu["v"])($f),l=Object(bu["i"])($f),h=1/Math.tan(t.fovX/2),d=1/Math.tan(t.fovY/2),u=.5*Math.sqrt(o*o+l*l)*Math.max(d,h)+.5*c,f=.5*c*d+.5*Math.max(o,l);return Math.max(u,f)/a}async function Gf(e,t,i,r,a,n,s,o){o.targetGeometry=i.clone();const c=Jr(e),l=Uf(e,c,i,r,a);Vl(e,c,n);const h=Pf(n,t)?0:1;o.scale=Fl(e,l,o.targetGeometry.latitude);const d=new ch(s);return zl(e,o.targetGeometry,o.scale,n,h,d),o.camera=await d.resolver.promise,o}function Bf(e,t){if(!t||!e.spatialReference)return null;const i={target:null};if("declaredClass"in t||Array.isArray(t))i.target=t;else{for(const e in t)i[e]=t[e];t.center&&!i.target&&(i.target=t.center)}return i}function Hf(e){return e&&Object(p["k"])(e.camera)&&(e.rotation=Of(e.camera.heading)),e}function Nf(e,t){const i=vf;if(!t.length)return i;let r=Number.NEGATIVE_INFINITY;for(let a=0;a<t.length;a++){const e=t[a].screenSpaceBoundingRect;r=Math.max(r,Math.abs(e[0]),Math.abs(e[1]),Math.abs(e[2]),Math.abs(e[3]))}return i-r/Math.min(e.width,e.height)*2}const qf=Object(M["e"])(),Wf=Object(kt["b"])(),Zf=Object(Kn["a"])(),$f=Object(bu["h"])(),Qf=Object(F["l"])(),Xf=Object(M["e"])(),Yf=Object(M["e"])(),Kf=Object(M["e"])(),Jf={heading:0,tilt:0},em=new C["a"],tm={point(e,t,i){i[0]=e.x,i[1]=e.y,e.hasZ&&(i[2]=e.z),t(i)},polygon(e,t,i){const r=e.hasZ;for(let a=0;a<e.rings.length;a++){const n=e.rings[a];for(let e=0;e<n.length;e++)i[0]=n[e][0],i[1]=n[e][1],r&&(i[2]=n[e][2]),t(i)}},polyline(e,t,i){const r=e.hasZ;for(let a=0;a<e.paths.length;a++){const n=e.paths[a];for(let e=0;e<n.length;e++)i[0]=n[e][0],i[1]=n[e][1],r&&(i[2]=n[e][2]),t(i)}},multipoint(e,t,i){const r=e.points,a=e.hasZ;for(let n=0;n<r.length;n++)i[0]=r[n][0],i[1]=r[n][1],a&&(i[2]=r[n][2]),t(i)},extent(e,t,i){e.hasZ?(t(Object(It["x"])(i,e.xmin,e.ymin,e.zmin)),t(Object(It["x"])(i,e.xmax,e.ymin,e.zmin)),t(Object(It["x"])(i,e.xmin,e.ymax,e.zmin)),t(Object(It["x"])(i,e.xmax,e.ymax,e.zmin)),t(Object(It["x"])(i,e.xmin,e.ymin,e.zmax)),t(Object(It["x"])(i,e.xmax,e.ymin,e.zmax)),t(Object(It["x"])(i,e.xmin,e.ymax,e.zmax)),t(Object(It["x"])(i,e.xmax,e.ymax,e.zmax))):(t(Object(It["x"])(i,e.xmin,e.ymin,i[2])),t(Object(It["x"])(i,e.xmax,e.ymin,i[2])),t(Object(It["x"])(i,e.xmin,e.ymax,i[2])),t(Object(It["x"])(i,e.xmax,e.ymax,i[2])))},mesh(e,t,i){const r=e.vertexAttributes&&e.vertexAttributes.position;if(r)for(let a=0;a<r.length;a+=3)t(Object(It["x"])(i,r[a+0],r[a+1],r[a+2]))}};class im{constructor(e,t,i){this.target=e,this.options=t,this.view=i,this.state="pending",this.abortController=null,this.animationController=null,this.promise=new Promise((e,t)=>{this.resolveCallback=e,this.rejectCallback=t;const i=Object(j["e"])();Object(p["k"])(this.options.signal)&&Object(j["r"])(this.options.signal,()=>{this.abort()}),this.abortController=i,this.waitForReady()})}then(e,t){return this.promise.then(e,t)}catch(e){return this.promise.catch(e)}resolve(e){return this.state="finished",this.resolveCallback(e)}reject(e){return this.state="finished",this.rejectCallback(e)}abort(e=!1){switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":this.reject(Object(j["f"])());break;case"wait-for-animation-finish":!e&&Object(p["k"])(this.animationController)&&this.view.stateManager.view.state.cameraController===this.animationController&&this.animationController.active&&this.animationController.stopController(),this.reject(Object(j["f"])())}}waitForReady(){this.state="wait-for-ready",this.view.stateManager.view.ready?this.createViewPoint():Object(L["k"])(this.view.stateManager.view,"ready",this.abortController.signal).then(()=>{this.createViewPoint()},e=>{this.reject(e)})}createViewPoint(){"finished"!==this.state&&(this.state="wait-for-viewpoint",this.animationController=this.options.animate?this.getAnimationController():null,Sf(this.view.stateManager.view,this.target,this.abortController.signal).then(e=>{if("finished"===this.state)return;const t=this.getCameraFromViewpoint(e);if(!Object(p["j"])(t))if(this.options.animate){if(Object(p["j"])(this.animationController))return;this.startAnimation(t,this.animationController)}else this.view.stateManager.setStateCamera(t.camera,{applyConstraints:!t.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),this.resolve()},e=>{this.reject(e)}))}internalAnimateOptions(e){const t={};return e&&(null!=e.speedFactor&&(t.speedFactor=e.speedFactor),null!=e.duration&&(t.duration=e.duration/1e3),null!=e.maxDuration&&(t.maxDuration=e.maxDuration/1e3),null!=e.easing&&("string"==typeof e.easing?t.easing=Wa[e.easing]:t.easing=e.easing)),t}getCameraFromViewpoint(e){const t=!!(this.target instanceof I["a"]&&this.target.camera||this.target instanceof E["a"]),i=e.camera;if(Object(p["j"])(i))return null;if(!this.view.stateManager.isCompatible(i)){const e=i.position,t=e&&e.spatialReference,r=t?t.wkid:"none",a=this.view.stateManager.view.spatialReference.wkid;return this.reject(new O["a"]("GotoAnimation:incompatible-spatialreference",`Resulting camera has an incompatible spatial reference (camera: ${r}, view: ${a})`,{camera:i})),null}const r=Il(this.view.stateManager.view,i);return Object(p["j"])(r)?(this.reject(new O["a"]("GotoAnimation:invalid-camera","Resulting camera is invalid")),null):{viewpoint:e,camera:r,isFullySpecified:t}}startAnimation(e,t){this.state="wait-for-animation-finish";const i=t.viewAnimation;if(Object(p["j"])(i))return void this.reject(new O["a"]("GotoAnimation:missing-animation","Unreachable code in view.stateManager"));if(i.update(e.viewpoint,"running"),!t.active||Object(p["j"])(t.viewAnimation)||t.viewAnimation.target!==e.viewpoint||this.view.stateManager.view.state.cameraController!==t)return this.abort();let r;e.isFullySpecified?(r=new bf({view:this.view.stateManager.view,desiredCamera:e.camera}),ca(this.view.stateManager.view,e.camera,1)):Nn(this.view.stateManager.view,e.camera),t.begin(e.camera,this.internalAnimateOptions(this.options));const a=()=>{const i=this.view.stateManager.view.state.cameraController;r&&(i&&i.active?i instanceof Us&&Object(p["k"])(i.viewAnimation)&&i.viewAnimation.target===e.viewpoint&&(this.view.stateManager.view.state.cameraController=r):Object(p["k"])(t.viewAnimation)&&t.viewAnimation.target===e.viewpoint&&"finished"===t.state&&(this.view.stateManager.view.state.cameraController=r))},n=e=>{if(!Object(p["j"])(this.view.stateManager.view.state))switch(t.state){case ks.Finished:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.resolve()}break;case ks.Ready:case ks.Rejected:case ks.Running:case ks.Stopped:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.reject(e)}}};i.when(a,e=>n(e)),t.asyncResult={resolve:()=>n(),reject:e=>n(e)}}getAnimationController(){let e,t=null;const i=this.view.stateManager.view.state.cameraController;return i instanceof Us&&(i.updateStateFromViewAnimation(),i.active&&(e=i,t=e.viewAnimation)),null!=e||(e=new Us({view:this.view.stateManager.view,mode:"animation"}),t=e.viewAnimation,this.view.stateManager.view.state.switchCameraController(e))?e:(Object(p["k"])(t)&&t.stop(),this.reject(new O["a"]("GotoAnimation:goto-cannot-interrupt","Cannot start an animation while interacting")),null)}}const rm=f["a"].getLogger("esri.views.3d.state.ViewStateManager");let am=class extends je["a"]{constructor(e){super(e),this.propertiesPool=new Bp["a"]({frustum:cp},this),this.handles=new we["a"],this.cameraSetByUser=!1,this.gotoOperation=null,this.ready=!1,this.updateDevicePixelRatio=null}get camera(){const e=this._get("camera");if(!this.ready)return e;const t=Vl(this.view,this.view.state.camera);return t&&e&&t.equals(e)?e:t}set camera(e){this.updatePropertyBeforeReady("camera",e)||this.setStateCamera(Il(this.view,e),{applyConstraints:!1})||rm.error("#camera=","Invalid camera",e)}get contentCamera(){const e=this._get("contentCamera");if(!this.ready)return e;const t=Vl(this.view,this.view.state.contentCamera);return t&&e&&t.equals(e)?e:t}set contentCamera(e){if(this.updatePropertyBeforeReady("contentCamera",e))return;const t=Il(this.view,e);Object(p["j"])(t)?this.view.state.contentCamera=null:(this.updateElevation(t),this.view.state.contentCamera=t)}get center(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")}set center(e){this.updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this.centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.update():rm.error("#center=","Invalid center",e):rm.error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e):rm.error("#center=","Center may not be null or undefined"))}get extent(){if(!this.ready)return this._get("extent");const e=this.view,t=Ql(e,e.state.camera,e.pointsOfInterest.centerOnContent.renderLocation);return Object(p["k"])(t)?t:this._get("extent")}set extent(e){this.updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this.extentToCamera(e),{applyConstraints:!0})||rm.error("#extent=","Invalid extent",e):rm.error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e):rm.error("#extent=","Extent may not be null or undefined"))}get frustum(){const e=this.propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e}get hasInitialView(){return!!this.view.get("map.initialViewProperties.viewpoint")}get scale(){if(this.ready){const e=this.view.pointsOfInterest.centerOnContent;return Fl(this.view,e.distance,e.location.latitude)}return this._get("scale")}set scale(e){this.updatePropertyBeforeReady("scale",e)||this.setStateCamera(this.scaleToCamera(e),{applyConstraints:!0})||rm.error("#scale=","Invalid scale",e)}get padding(){if(!this.ready)return this._get("padding");const e=this.view.state.camera,t=e.padding,i=e.pixelRatio,r=this._get("padding"),a=Math.round(t[0]/i),n=Math.round(t[1]/i),s=Math.round(t[2]/i),o=Math.round(t[3]/i);return null!=r&&r.top===a&&r.right===n&&r.bottom===s&&r.left===o?r:{top:a,right:n,bottom:s,left:o}}set padding(e){this.updatePropertyBeforeReady("padding",e)||(this.paddingToArray(e,this.view.state.camera.pixelRatio,dm),this.view.state.updateCamera(e=>e.padding=dm))}paddingToArray(e,t,i){e?Object(ui["l"])(i,e.top||0,e.right||0,e.bottom||0,e.left||0):Object(ui["l"])(i,0,0,0,0);for(let r=0;r<4;r++)i[r]=Math.round(i[r]*t)}get screenCenter(){const e=this.padding;return Object(A["f"])((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)}get viewpoint(){return this.ready?wf(this.view,this.camera):this._get("viewpoint")}set viewpoint(e){if(!this.updatePropertyBeforeReady("viewpoint",e))if(e)if(this.isCompatible(e))this.setStateCamera(this.viewpointToCamera(e),{applyConstraints:!e.camera})||rm.error("#viewpoint=","Invalid viewpoint",e);else{const t=Object(p["k"])(e.camera)?e.camera.position:e.targetGeometry,i=Object(p["k"])(t)&&t.spatialReference;rm.error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(i?i.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e)}else rm.error("#viewpoint=","Viewpoint may not be null or undefined")}get zoom(){return this.ready?ah(this.view,this.scale):this._get("zoom")}set zoom(e){this.updatePropertyBeforeReady("zoom",e)||this.setStateCamera(this.zoomToCamera(e),{applyConstraints:!0})||rm.error("#zoom=","Invalid zoom",e)}initialize(){this.handles.add([this.view.state.watch("camera",e=>this.cameraChangedSync(e),!0),Object(L["b"])(this.view,"state.events","before-camera-change",e=>this.updateElevation(e.camera))]),Object(L["c"])(this.view.state,"camera",e=>this.updateElevation(e),!0),this.handles.add(Object(w["a"])({prepare:()=>this.prepareFrame()})),this.handles.add(this.view.state.watch("cameraController",()=>{this.cameraSetByUser=!0,this.handles.remove(um)})),this.handles.add(Object(L["b"])(this.view,"state.events","camera-projection-changed",()=>this.notifyChange("scale")))}destroy(){this.deinit(),this.handles&&(this.handles.destroy(),this.handles=null),this.propertiesPool&&(this.propertiesPool.destroy(),this.propertiesPool=null)}init(){this.constraintsManager=new mf({view:this.view}),this.prepareFrame();const e=this.getInitialProperties();this.cameraSetByUser=!1,this._set("ready",!0);for(const t of e)this.set(t.name,t.value);if(!this.cameraSetByUser){const e=this.view.get("map.initialViewProperties.viewpoint")||this.view.initialExtent;e&&this.isCompatible(e)?this.setInitialView(e):2===this.view.state.mode&&this.handles.add(Object(L["k"])(this.view.basemapTerrain,"ready",()=>{this.handles.remove(um),this.setInitialView(this.view.groundExtent)}),um)}}deinit(){this.cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this.cameraSetByUser=!1,this.handles.remove(um),this.constraintsManager&&(this.constraintsManager.destroy(),this.constraintsManager=null))}async goTo(e,t){const i={animate:!0,...t};return Object(p["k"])(this.gotoOperation)&&this.gotoOperation.abort(i.animate),this.gotoOperation=new im(e,i,this.view),this.gotoOperation}debugSetCameraOnContent(){this.setStateCamera(Jr(this.view),{applyConstraints:!1})}step(e){const t=this.view.state,i=t&&this.view.state.cameraController;i&&(t.updateCamera(t=>{i.stepController(e,t)}),i.steppingFinished&&i.finishController())}cancelGoToOperation(){Object(p["k"])(this.gotoOperation)&&(this.gotoOperation.abort(),this.gotoOperation=null)}getInitialProperties(){const e=new Set,t=[];for(const{propertyName:i,overrides:r}of om){const a=e.has(i),n=this._isOverridden(i);!a&&n&&t.push({name:i,value:this._get(i)}),this._clearOverride(i),(a||n)&&r.forEach(t=>e.add(t))}return t}setInitialView(e){if(!e||this.cameraSetByUser)return;if(e instanceof E["a"])return void this.setStateCamera(Il(this.view,e),{applyConstraints:!1});if(e instanceof I["a"]){if(e.targetGeometry instanceof T["a"]){const t=$l(this.view,e.targetGeometry,0,.5,0);return void(Object(p["k"])(t)&&this.setStateCamera(Il(this.view,t),{applyConstraints:!0}))}const t={applyConstraints:!e.camera},i=this.viewpointToCamera(e);return void this.setStateCamera(i,t)}const t=$l(this.view,e,0,.5,0);Object(p["k"])(t)&&this.setStateCamera(Il(this.view,t),{applyConstraints:!0})}updatePropertyBeforeReady(e,t){return!this.ready&&(this._override(e,t),t&&-1!==sm.indexOf(e)&&this._override("hasInitialView",!0),!0)}isCompatible(e){return!Object(p["j"])(e)&&(e instanceof I["a"]?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof E["a"]?this.isCompatible(e.position):e.spatialReference&&Object(S["a"])(e.spatialReference,this.view.spatialReference))}getPreservingHeadingTilt(e=cm){return this.cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e}centerPointAtDistanceToCamera(e,t,i=hm){const{heading:r,tilt:a}=this.getPreservingHeadingTilt(),n=Wl(this.view,r,a,e,t,1);return Object(p["j"])(n)?null:(i.copyFrom(this.view.state.camera),i.eye=n.eye,i.center=n.center,i.up=n.up,i)}centerToCamera(e){const t=this.view.pointsOfInterest.centerOnContent;t.update();const i=t.distance;return this.centerPointAtDistanceToCamera(e,i)}extentToCamera(e){const{heading:t,tilt:i}=this.getPreservingHeadingTilt(),r=$l(this.view,e,t,i,1,lm);return Object(p["k"])(r)?Il(this.view,r):null}scaleToCamera(e){if(null==e)return null;const t=this.view.pointsOfInterest.centerOnContent;t.update();const i=t.renderLocation,r=t.location.latitude,a=kl(this.view,e,r);return this.centerPointAtDistanceToCamera(i,a)}zoomToCamera(e){return this.scaleToCamera(nh(this.view,e))}viewpointToCamera(e){return Il(this.view,jf(this.view,e))}setStateCamera(e,t){return!(Object(p["j"])(e)||!this.view.state.stopActiveCameraController())&&(this.cameraSetByUser=!0,t.doNotCancelGoToOperation||this.cancelGoToOperation(),this.view.state.updateCamera(i=>{t.positionAndOrientationOnly?(i.eye=e.eye,i.center=e.center,i.up=e.up):i.copyFrom(e),t.applyConstraints&&Nn(this.view,i)}),t.applyConstraints||(this.view.state.cameraController=new bf({view:this.view,desiredCamera:e})),!0)}prepareFrame(){const{container:e,canvas:t}=this.view;if(!e||!t)return;Object(p["k"])(this.updateDevicePixelRatio)&&this.updateDevicePixelRatio();const i=this.view.pixelRatio,r=Math.round(e.clientWidth*i),a=Math.round(e.clientHeight*i);if(0!==r&&0!==a&&(t.width===r&&t.height===a||(t.width=r,t.height=a),this.view.state)){const e=this.view.state.camera;e.fullWidth===r&&e.fullHeight===a&&e.pixelRatio===i||(hm.copyFrom(e),hm.pixelRatio!==i&&(this.paddingToArray(this.padding,i,dm),hm.padding=dm),hm.fullWidth=r,hm.fullHeight=a,hm.pixelRatio=i,this.view.state.camera=hm)}}updateElevation(e){const t=this.view.basemapTerrain&&this.view.basemapTerrain.spatialReference,i=this.view.renderCoordsHelper.getAltitude(e.eye),r=t?Kr(this.view,e.eye):0;e.relativeElevation=i-r}cameraChangedSync(e){e&&this.view._stage&&(this.view._stage.camera=e)}};Object(d["a"])([Object(g["b"])({type:E["a"],dependsOn:["view.state.camera","ready"]})],am.prototype,"camera",null),Object(d["a"])([Object(g["b"])({type:E["a"],dependsOn:["view.state.contentCamera","ready"]})],am.prototype,"contentCamera",null),Object(d["a"])([Object(g["b"])({type:C["a"]})],am.prototype,"center",null),Object(d["a"])([Object(g["b"])({type:T["a"]})],am.prototype,"extent",null),Object(d["a"])([Object(g["b"])({readOnly:!0})],am.prototype,"frustum",null),Object(d["a"])([Object(g["b"])({readOnly:!0})],am.prototype,"hasInitialView",null),Object(d["a"])([Object(g["b"])({readOnly:!0,type:Boolean})],am.prototype,"ready",void 0),Object(d["a"])([Object(g["b"])({type:Number})],am.prototype,"scale",null),Object(d["a"])([Object(g["b"])()],am.prototype,"padding",null),Object(d["a"])([Object(g["b"])({readOnly:!0})],am.prototype,"screenCenter",null),Object(d["a"])([Object(g["b"])({constructOnly:!0})],am.prototype,"view",void 0),Object(d["a"])([Object(g["b"])({type:I["a"]})],am.prototype,"viewpoint",null),Object(d["a"])([Object(g["b"])({type:Number})],am.prototype,"zoom",null),Object(d["a"])([Object(g["b"])({constructOnly:!0})],am.prototype,"updateDevicePixelRatio",void 0),am=Object(d["a"])([Object(y["a"])("esri.views.3d.state.ViewStateManager")],am);var nm=am;const sm=["camera","viewpoint","extent","scale","center","zoom"],om=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],cm={heading:0,tilt:0},lm=new E["a"],hm=new Yn["a"],dm=Object(Lt["c"])(),um="pending-initial-view";var pm=nm;class fm{constructor(e,t,i){this.viewingMode=e,this.layerProvider=t,this.view=i,this.externalIntersectionHandlers=new fd["a"],this.tolerance=Gr["a"].DEFAULT_TOLERANCE,this.tmpRay=Object(lf["c"])(),this.validateHUDIntersector=new Gr["a"](this.viewingMode),this.validateHUDIntersector.options.hud=!1}intersectScreen(e,t){return this.intersectRay(this.getPickRay(e,this.tmpRay),gm(this.viewingMode),t)}intersectScreenFreePointFallback(e,t){return this.intersectRayFreePointFallback(this.getPickRay(e,this.tmpRay),t)}intersectRayFreePointFallback(e,t){return this.intersectRay(e,gm(this.viewingMode),t)||this.intersectRayFreePointLocal(e,t)}intersectRay(e,t,i,r){return t.options.selectionMode=!1,t.options.store=0,this.computeIntersection(e,t,r),!!t.results.min&&t.results.min.getIntersectionPoint(i)}getCenterRayWithSubpixelOffset(e,t,i=.5,r=.5){return e.getRenderCenter(Om,i,r),Om[0]+=.0466,Om[1]-=.0123,Object(lf["f"])(e,Om,t)}intersectIntersectorScreen(e,t,i){this.computeIntersection(this.getPickRay(e,this.tmpRay),t,i)}intersectToolIntersectorScreen(e,t,i){const r=this.getPickRay(e,this.tmpRay);this.intersectToolIntersectorRay(r,t,i)}intersectToolIntersectorRay(e,t,i){t.options.selectionMode=!0,this.computeIntersection(e,t,i);const r=t.results.min;this.view.basemapTerrain&&this.view.basemapTerrain.opaque||r.hasIntersectionPoint&&"TerrainRenderer"!==r.intersector||(t.options.selectionMode=!1,this.computeIntersection(e,t,i))}setTolerance(e=Gr["a"].DEFAULT_TOLERANCE){this.tolerance=e}addIntersectionHandler(e){this.externalIntersectionHandlers.push(e),this.externalIntersectionHandlers.sort((e,t)=>"Terrain"===e.type?1:"Terrain"===t.type?-1:0)}removeIntersectionHandler(e){this.externalIntersectionHandlers.removeUnordered(e),this.externalIntersectionHandlers.sort((e,t)=>"Terrain"===e.type?1:"Terrain"===t.type?-1:0)}getPickRay(e,t=Object(lf["c"])()){const i=this.view.state.camera;return Object(lf["a"])(i,e,t)}intersectRayFreePointLocal(e,t){if(2!==this.viewingMode||Object(p["j"])(e))return!1;const i=this.view.dataExtent,r={x:i.xmax-i.xmin,y:i.ymax-i.ymin,z:8*Math.max(i.xmax-i.xmin,i.ymax-i.ymin)},a=Math.max(r.x,r.y,r.z);if(0===a)return Object(It["g"])(t,e.origin,Object(It["s"])(Hs["d"].get(),e.direction)),!0;const n=this.view.state.camera,s=Math.max(0,i.xmin-n.eye[0],n.eye[0]-i.xmax),o=Math.max(0,i.ymin-n.eye[1],n.eye[1]-i.ymax),c=Math.sqrt(s*s+o*o),l=Math.abs(n.relativeElevation)+Number.MIN_VALUE,h=Math.max(0,Math.log(a/l))**2;let d=a/Math.max(1,h);d=Math.max(d,Math.min(c,a));const u=Object(It["f"])(Hs["d"].get(),e.direction,d/Object(It["q"])(e.direction));return Object(It["g"])(t,e.origin,u),!0}intersectElevationFromScreen(e,t,i=0,r=null){return this.intersectElevation(this.getPickRay(e,this.tmpRay),t,i,r)}intersectElevation(e,t,i=0,r=null){if(Object(p["j"])(e))return null;const a=Object(p["k"])(t)?t.mode:"absolute-height",n=Object(p["k"])(t)?Object(p["u"])(t.offset,0):0,s="on-the-ground"!==a?n+i:0,o=s/this.view.renderCoordsHelper.unitInMeters;if("absolute-height"===a){if(this.view.renderCoordsHelper.intersectManifold(e,s,ym)){const e=this.view.computeMapPointFromVec3d(ym);return e.z-=n,e}return null}const c=this.view.state.camera,l=Object(A["b"])(Hs["d"].get());c.projectToRenderScreen(e.origin,l);const h=this.prepareFilters(null,vm),d=this.view.slicePlane,u=Object(p["k"])(d)?Object(Ur["i"])(d):null,f=new Gr["a"](this.viewingMode);f.options.store=0,f.options.verticalOffset=o;const m=e.origin,b=Object(It["g"])(Hs["d"].get(),m,e.direction);f.reset(m,b),f.point=l,f.camera=c,f.filterPredicate=null;const g=Object(p["k"])(r)?"type"in r&&"graphics"===r.type?e=>e.metadata.layerUid!==r.uid:e=>e.metadata.graphicUid!==r.uid:null;switch(a){case"relative-to-scene":{const e=e=>(Object(p["j"])(g)||g(e))&&e.metadata&&e.metadata.isElevationSource;f.intersect(h.layers,l,c,this.tolerance,null,e),this.externalIntersectionHandlers.forAll(e=>{if("I3S"===e.type||"Terrain"===e.type){const t=e.slicePlane?u:null;e.intersect(f,t,f.rayBeginPoint,f.rayEndPoint,l)}})}break;case"on-the-ground":case"relative-to-ground":this.externalIntersectionHandlers.forAll(e=>{if(e.isGround){const t=e.slicePlane?u:null;e.intersect(f,t,f.rayBeginPoint,f.rayEndPoint,l)}})}if(f.results.min.getIntersectionPoint(ym)){const e=this.view.computeMapPointFromVec3d(ym);return e.z=i,e}return null}computeIntersection(e,t,i){if(Object(p["j"])(e))return;const r=this.view.state.camera,a=Object(A["b"])(Hs["d"].get());r.projectToRenderScreen(e.origin,a);const n=this.prepareFilters(i,vm);t.options.selectOpaqueTerrainOnly=!i||!("include"in i||"exclude"in i);const s=e.origin,o=Object(It["g"])(Hs["d"].get(),e.origin,e.direction);t.reset(s,o),t.intersect(n.layers,a,r,this.tolerance);const c=this.view.slicePlane,l=Object(p["k"])(c)?Object(Ur["i"])(c):null;t.intersect(n.sliceableLayers,a,r,this.tolerance,l);const h=i&&(i.requiresGroundFeedback||i.enableDraped);this.externalIntersectionHandlers.forAll(e=>{if(t.options.isFiltered=!n.filterLayerUid(e.intersectionHandlerId),e.isGround&&h||!t.options.isFiltered){const i=e.slicePlane?l:null;e.intersect(t,i,s,o,a)}});const d=Hs["d"].get();if(i&&i.enableDraped&&t.results.ground.getIntersectionPoint(d)){const e=this.view.basemapTerrain.overlayManager.renderer,i=this.view.renderCoordsHelper.spatialReference,r=Hs["d"].get();this.view.renderCoordsHelper.fromRenderCoords(d,r,this.view.spatialReference),r[2]=Object(p["u"])(this.view.elevationProvider.getElevation(d[0],d[1],d[2],i,"ground"),0),e.intersect(t,r,n.filterRenderGeometry)}t.sortResults();const u=t.results.hud;if(u.hasIntersectionPoint){const e=Object(A["b"])(Hs["d"].get()),i=Hs["d"].get(),a=Hs["d"].get();this.unprojectHUDResultRay(u.center,e,i,a);const s=Object(It["p"])(u.center,i)/Object(It["p"])(i,a)*.99;this.validateHUDIntersector.reset(i,a),this.validateHUDIntersector.intersect(n.layers,e,r,this.tolerance),this.validateHUDIntersector.intersect(n.sliceableLayers,e,r,this.tolerance,l),this.externalIntersectionHandlers.forAll(t=>{if(!n.filterLayerUid(t.intersectionHandlerId))return;const r=t.slicePlane?l:null;t.intersect(this.validateHUDIntersector,r,i,a,e)});const o=this.validateHUDIntersector.results.min;(null==o.dist||s<=o.dist)&&(t.results.min.copyFrom(u),t.results.all.splice(0,0,u))}}prepareFilters(e,t){const i=[],r=[];return this.layerProvider.forEachLayer(e=>{e.isPickable&&(e.isSliceable?r:i).push(e)}),t.include=e&&e.include,t.exclude=e&&e.exclude,t.layers.length=0,t.sliceableLayers.length=0,mm(i,t.filterLayer,t.layers),mm(r,t.filterLayer,t.sliceableLayers),t}unprojectHUDResultRay(e,t,i,r){const a=this.view.state.camera;a.projectToRenderScreen(e,t);const n=Object(A["b"])(Hs["d"].get());n[0]=t[0],n[1]=t[1],n[2]=0,a.unprojectFromRenderScreen(n,i),n[2]=1,a.unprojectFromRenderScreen(n,r)}}function mm(e,t,i){for(const r of e)t&&!t(r)||i.push(r);return i}let bm;function gm(e){return bm||(bm=new Gr["a"](e)),bm.viewingMode=e,bm}const vm={include:null,exclude:null,layers:[],sliceableLayers:[],filterLayer:e=>vm.filterLayerUid(e.apiLayerUid),filterLayerUid(e){const{include:t,exclude:i}=vm;return Object(p["j"])(e)?null==t&&null==i:(null==t||t.has(e))&&(null==i||!i.has(e))},filterRenderGeometry:e=>vm.filterLayerUid(e.layerUid)},ym=Object(M["e"])(),Om=Object(A["d"])();var _m=i("1797");let xm=class extends(Ce["a"].EventedMixin(je["a"])){constructor(e){super(e),this.im=new Array,this.ground=new Array,this.scene=new Array,this.handles=new Map}destroy(){this._elevationQuery=Object(p["e"])(this._elevationQuery)}get elevationQuery(){return Object(p["j"])(this._elevationQuery)&&(this._elevationQuery=new _m["a"](this.view.resourceController.scheduler,this.view.spatialReference,()=>this.view.map&&this.view.map.ground,{maximumAutoTileRequests:4})),this._elevationQuery}getElevation(e,t,i,r,a){let n=null;return n=jm(n,this.im,e,t,i,r,a),Object(p["j"])(n)&&(n=jm(n,this.ground,e,t,i,r,a)),"scene"===a&&(n=jm(n,this.scene,e,t,i,r,a)),n}queryElevation(e,t,i,r,a,n=null,s=0){const o=Object(j["h"])();return this.elevationQuery.queryElevation(e,t,n,s).then(n=>{"scene"===a&&(n=jm(n,this.scene,e,t,i,r,a)),o.resolve(n)}).catch(n=>{Object(j["n"])(n)?o.reject(n):o.resolve(this.getElevation(e,t,i,r,a))}),o.promise}register(e,t){this.handles.set(t,t.on("elevation-change",e=>this.emit("elevation-change",e))),this[e].push(t)}unregister(e){this.handles.has(e)&&(this.handles.get(e).remove(),this.handles.delete(e));for(const t of[this.im,this.ground,this.scene]){const i=t.indexOf(e);i>-1&&t.splice(i,1)}}};function jm(e,t,i,r,a,n,s){for(const o of t){const t=o.getElevation(i,r,a,n,s);Object(p["k"])(t)&&(e=Object(p["k"])(e)?Math.max(t,e):t)}return e}Object(d["a"])([Object(g["b"])({constructOnly:!0})],xm.prototype,"view",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0,aliasOf:"view.basemapTerrain.spatialReference"})],xm.prototype,"spatialReference",void 0),xm=Object(d["a"])([Object(y["a"])("esri.views.3d.support.CombinedElevationProvider")],xm);class wm{static isValidProfile(e){return e in wm.profiles}static getDefaultProfile(){return Object(u["a"])("trident")||Object(u["a"])("esri-iPhone")?"low":"medium"}static apply(e,t){const i=wm.profiles[e];t.graphics3D.maxTotalNumberOfFeatures=i.graphics3D.maxTotalNumberOfFeatures,t.graphics3D.maxTotalNumberOfPrimitives=i.graphics3D.maxTotalNumberOfPrimitives,t.graphics3D.polygonLodFactor=i.graphics3D.polygonLodFactor,t.graphics3D.polylineLodFactor=i.graphics3D.polylineLodFactor;{const e=t.sceneService["3dObject"],r=i.sceneService["3dObject"];e.lodFactor=r.lodFactor,e.lodCrossfadeinDuration=r.lodCrossfadeinDuration,e.lodCrossfadeoutDuration=r.lodCrossfadeoutDuration,e.lodCrossfadeUncoveredDuration=r.lodCrossfadeUncoveredDuration}t.sceneService.point.lodFactor=i.sceneService.point.lodFactor,t.sceneService.integratedMesh.lodFactor=i.sceneService.integratedMesh.lodFactor,t.sceneService.pointCloud.lodFactor=i.sceneService.pointCloud.lodFactor,t.sceneService.uncompressedTextureDownsamplingEnabled=i.sceneService.uncompressedTextureDownsamplingEnabled,t.tiledSurface.lodBias=i.tiledSurface.lodBias,t.tiledSurface.angledSplitBias=i.tiledSurface.angledSplitBias,t.tiledSurface.reduceTileLevelDifferences=i.tiledSurface.reduceTileLevelDifferences,t.tiledSurface.textureFadeDuration=i.tiledSurface.textureFadeDuration,t.antialiasingEnabled=i.antialiasingEnabled,t.physicallyBasedRenderingEnabled=i.physicalBasedRenderingEnabled,t.highQualityTransparency=i.highQualityTransparency,t.memoryLimit=i.memoryLimit,t.additionalCacheMemory=i.additionalCacheMemory,t.frameRate=i.frameRate,t.maximumRenderResolution=i.maximumRenderResolution,t.maximumPixelRatio=i.maximumPixelRatio}}function Sm(){const e=!!Object(u["a"])("esri-mobile");return{low:{graphics3D:{maxTotalNumberOfFeatures:25e3,maxTotalNumberOfPrimitives:85e4,polygonLodFactor:.5,polylineLodFactor:1},sceneService:{"3dObject":{lodFactor:.2,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:0},point:{lodFactor:1},integratedMesh:{lodFactor:.6},pointCloud:{lodFactor:.5},uncompressedTextureDownsamplingEnabled:!0},tiledSurface:{lodBias:-1,angledSplitBias:.5,reduceTileLevelDifferences:!1,textureFadeDuration:0},antialiasingEnabled:!1,physicalBasedRenderingEnabled:!1,highQualityTransparency:!1,memoryLimit:200,additionalCacheMemory:0,frameRate:0,maximumRenderResolution:null,maximumPixelRatio:1},medium:{graphics3D:{maxTotalNumberOfFeatures:5e4,maxTotalNumberOfPrimitives:17e5,polygonLodFactor:e?.8:1,polylineLodFactor:e?1.2:1.5},sceneService:{"3dObject":{lodFactor:1,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:400},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:e},tiledSurface:{lodBias:0,angledSplitBias:1,reduceTileLevelDifferences:!Object(u["a"])("disable-feature:reduce-map-tile-levels"),textureFadeDuration:400},antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,memoryLimit:e?600:750,additionalCacheMemory:e?0:150,frameRate:0,maximumRenderResolution:null,maximumPixelRatio:1},high:{graphics3D:{maxTotalNumberOfFeatures:5e4,maxTotalNumberOfPrimitives:17e5,polygonLodFactor:e?1.2:2,polylineLodFactor:e?1.2:2},sceneService:{"3dObject":{lodFactor:1,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:400},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:!1},tiledSurface:{lodBias:0,angledSplitBias:1,reduceTileLevelDifferences:!Object(u["a"])("disable-feature:reduce-map-tile-levels"),textureFadeDuration:400},antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,memoryLimit:e?900:1500,additionalCacheMemory:0,frameRate:0,maximumRenderResolution:e?null:4096,maximumPixelRatio:e?1:null}}}wm.debug={reset(){const e=Sm();for(const t in e)wm.profiles[t]=e[t]}},function(e){e.profiles=Sm()}(wm||(wm={}));var Cm=wm,Tm=Cm,Pm=i("5ef2");let Am=class extends je["a"]{constructor(){super(...arguments),this.color=new ee["a"]([0,255,255]),this.haloColor=null,this.haloOpacity=1,this.fillOpacity=.25,this.shadowOpacity=.4,this.shadowColor=new ee["a"]([0,0,0]),this.shadowDifference=.2}static toEngineOptions(e){const t=ee["a"].toUnitRGBA(e.color),i=Object(p["k"])(e.haloColor)?ee["a"].toUnitRGBA(e.haloColor):t,r=ee["a"].toUnitRGBA(e.shadowColor);return{color:Object(Pm["c"])(t[0],t[1],t[2],t[3]),haloColor:Object(Pm["c"])(i[0],i[1],i[2],i[3]),haloOpacity:e.haloOpacity,haloOpacityOccluded:.25*e.haloOpacity,fillOpacity:e.fillOpacity,fillOpacityOccluded:.25*e.fillOpacity,shadowOpacity:e.shadowOpacity,shadowColor:Object(Pm["c"])(r[0],r[1],r[2],r[3]),occludedShadowOpacity:e.shadowOpacity*(1-e.shadowDifference)}}};Object(d["a"])([Object(g["b"])({type:ee["a"]})],Am.prototype,"color",void 0),Object(d["a"])([Object(g["b"])({type:ee["a"]})],Am.prototype,"haloColor",void 0),Object(d["a"])([Object(g["b"])()],Am.prototype,"haloOpacity",void 0),Object(d["a"])([Object(g["b"])()],Am.prototype,"fillOpacity",void 0),Object(d["a"])([Object(g["b"])()],Am.prototype,"shadowOpacity",void 0),Object(d["a"])([Object(g["b"])({type:ee["a"]})],Am.prototype,"shadowColor",void 0),Object(d["a"])([Object(g["b"])()],Am.prototype,"shadowDifference",void 0),Am=Object(d["a"])([Object(y["a"])("esri.views.3d.support.HighlightOptions")],Am);var Rm=Am,Mm=Rm,Em=i("0024"),Dm=i("e2e8");class Im{constructor(e,t,i=null){this.spatialReference=t,this.unitInMeters=Object(Yp["e"])(this.spatialReference,Object(V["e"])(this.spatialReference).metersPerDegree),this._geometryServicePromise=Object(nu["d"])(this.loadGeometryService(e,i))}async loadGeometryService(e,t){if(t)return t;try{return await Object(Dm["create"])(e&&e.get("portalItem"))}catch{throw new O["a"]("mapcoordshelper:missing-geometry-service","Must specify geometryService in esri/config")}}async awaitGeometryService(){const e=await this._geometryServicePromise;if(!0===e.ok)return e.value;throw e.error}async toGeographic(e){const t=await this.awaitGeometryService();let i,r=!0;Array.isArray(e[0])&&"number"!=typeof e[0]?i=e:(i=[e],r=!1);const a=i.map(e=>e instanceof C["a"]?e:new C["a"](e,this.spatialReference)),n=new Em["a"]({geometries:a,outSpatialReference:c["a"].WGS84}),s=(await t.project(n)).map(e=>"point"===e.type?[e.x,e.y]:void 0);return r?s:s[0]}}let Lm=class extends je["a"]{constructor(){super(...arguments),this.minTotalNumberOfFeatures=2e3,this.maxTotalNumberOfFeatures=5e4,this.maxTotalNumberOfPrimitives=17e5,this.polygonLodFactor=1,this.polylineLodFactor=1}};Object(d["a"])([Object(g["b"])()],Lm.prototype,"minTotalNumberOfFeatures",void 0),Object(d["a"])([Object(g["b"])()],Lm.prototype,"maxTotalNumberOfFeatures",void 0),Object(d["a"])([Object(g["b"])()],Lm.prototype,"maxTotalNumberOfPrimitives",void 0),Object(d["a"])([Object(g["b"])()],Lm.prototype,"polygonLodFactor",void 0),Object(d["a"])([Object(g["b"])()],Lm.prototype,"polylineLodFactor",void 0),Lm=Object(d["a"])([Object(y["a"])("esri.views.3d.support.QualitySettings.Graphics3DSettings")],Lm);let Vm=class extends je["a"]{constructor(){super(...arguments),this.lodFactor=1}};Object(d["a"])([Object(g["b"])()],Vm.prototype,"lodFactor",void 0),Vm=Object(d["a"])([Object(y["a"])("esri.views.3d.support.QualitySettings.LoDFactorSettings")],Vm);let km=class extends Vm{constructor(){super(...arguments),this.lodCrossfadeinDuration=0,this.lodCrossfadeoutDuration=0,this.lodCrossfadeUncoveredDuration=0}};km=Object(d["a"])([Object(y["a"])("esri.views.3d.support.QualitySettings.LoDFactor3DObjectSettings")],km);let Fm=class extends je["a"]{constructor(){super(...arguments),this["3dObject"]=new km,this.point=new Vm,this.integratedMesh=new Vm,this.pointCloud=new Vm,this.uncompressedTextureDownsamplingEnabled=!1}};Object(d["a"])([Object(g["b"])({type:km})],Fm.prototype,"3dObject",void 0),Object(d["a"])([Object(g["b"])({type:Vm})],Fm.prototype,"point",void 0),Object(d["a"])([Object(g["b"])({type:Vm})],Fm.prototype,"integratedMesh",void 0),Object(d["a"])([Object(g["b"])({type:Vm})],Fm.prototype,"pointCloud",void 0),Object(d["a"])([Object(g["b"])()],Fm.prototype,"uncompressedTextureDownsamplingEnabled",void 0),Fm=Object(d["a"])([Object(y["a"])("esri.views.3d.support.QualitySettings.SceneServiceSettings")],Fm);let zm=class extends je["a"]{constructor(){super(...arguments),this.lodBias=0,this.angledSplitBias=1,this.reduceTileLevelDifferences=!0,this.textureFadeDuration=500}};Object(d["a"])([Object(g["b"])()],zm.prototype,"lodBias",void 0),Object(d["a"])([Object(g["b"])()],zm.prototype,"angledSplitBias",void 0),Object(d["a"])([Object(g["b"])()],zm.prototype,"reduceTileLevelDifferences",void 0),Object(d["a"])([Object(g["b"])()],zm.prototype,"textureFadeDuration",void 0),zm=Object(d["a"])([Object(y["a"])("esri.views.3d.support.QualitySettings.TiledSurfaceSettings")],zm);let Um=class extends je["a"]{constructor(){super(...arguments),this.graphics3D=new Lm,this.sceneService=new Fm,this.tiledSurface=new zm,this.antialiasingEnabled=!0,this.physicallyBasedRenderingEnabled=!1,this.highQualityTransparency=!0}};Object(d["a"])([Object(g["b"])({type:Lm})],Um.prototype,"graphics3D",void 0),Object(d["a"])([Object(g["b"])({type:Fm})],Um.prototype,"sceneService",void 0),Object(d["a"])([Object(g["b"])({type:zm})],Um.prototype,"tiledSurface",void 0),Object(d["a"])([Object(g["b"])()],Um.prototype,"antialiasingEnabled",void 0),Object(d["a"])([Object(g["b"])()],Um.prototype,"physicallyBasedRenderingEnabled",void 0),Object(d["a"])([Object(g["b"])()],Um.prototype,"highQualityTransparency",void 0),Object(d["a"])([Object(g["b"])()],Um.prototype,"memoryLimit",void 0),Object(d["a"])([Object(g["b"])()],Um.prototype,"additionalCacheMemory",void 0),Object(d["a"])([Object(g["b"])()],Um.prototype,"frameRate",void 0),Object(d["a"])([Object(g["b"])()],Um.prototype,"maximumRenderResolution",void 0),Object(d["a"])([Object(g["b"])()],Um.prototype,"maximumPixelRatio",void 0),Um=Object(d["a"])([Object(y["a"])("esri.views.3d.support.QualitySettings.QualitySettings")],Um);var Gm=Um,Bm=Gm,Hm=i("1a54");class Nm{constructor(e,t,i,r){this.viewingMode=e,this.spatialReference=t,this.unitInMeters=i,this.coordinateSystem=r,this._coordinateSystem=qs(r)}set extent(e){e&&Ws(this.coordinateSystem,e,this.coordinateSystem)}getAltitude(e){return io(this.coordinateSystem,e)}setAltitude(e,t){ro(this.coordinateSystem,t,e,t)}setAltitudeOfTransformation(e,t){ao(this.coordinateSystem,t,e,t)}worldUpAtPosition(e,t){return Ks(this.coordinateSystem,e,t)}worldBasisAtPosition(e,t,i){return Js(this.coordinateSystem,e,t,i)}basisMatrixAtPosition(e,t){const i=this.worldBasisAtPosition(e,0,Hs["d"].get()),r=this.worldBasisAtPosition(e,1,Hs["d"].get()),a=this.worldBasisAtPosition(e,2,Hs["d"].get());return Object(Vt["d"])(t,i[0],i[1],i[2],0,r[0],r[1],r[2],0,a[0],a[1],a[2],0,0,0,0,1),t}intersectManifoldClosestSilhouette(e,t,i){return no(this.coordinateSystem,t,this._coordinateSystem),to(this._coordinateSystem,e,i),i}intersectManifold(e,t,i){no(this.coordinateSystem,t,this._coordinateSystem);const r=Hs["d"].get();return!!eo(this._coordinateSystem,e,r)&&(Object(It["l"])(i,r),!0)}intersectInfiniteManifold(e,t,i){if(1===this.viewingMode)return this.intersectManifold(e,t,i);no(this.coordinateSystem,t,this._coordinateSystem);const r=this._coordinateSystem.value,a=Hs["d"].get();return!!Et["f"].intersectRay(r.plane,e,a)&&(Object(It["l"])(i,a),!0)}toRenderCoords(e,t,i){return Object(Hm["j"])(e)?Object(z["t"])(e,t,this.spatialReference):Object(z["y"])(e,t,i,this.spatialReference)}fromRenderCoords(e,t,i=null){return Object(Hm["j"])(t)?(Object(p["k"])(i)&&(t.spatialReference=i),Object(z["w"])(e,this.spatialReference,t)):t instanceof c["a"]?Object(z["x"])(e,this.spatialReference,t):Object(z["y"])(e,this.spatialReference,t,i)?t:null}static createGlobal(e){return new Nm(1,e,1,Qs(e))}static createLocal(e){return new Nm(2,e,Object(Yp["e"])(e),Ys())}static createMode(e,t){switch(e){case 2:return Nm.createLocal(t);case 1:return Nm.createGlobal(t)}}}var qm=i("2aa2"),Wm=i("aefa");function Zm(e){return"function"==typeof e.getUsedMemory}const $m=f["a"].getLogger("esri.views.3d.support.MemoryController");function Qm(e){return new tb(e)}const Xm=1,Ym=1,Km=.75,Jm=.6,eb=1.3;class tb{constructor(e){this._view=e,this.events=new Ce["a"],this.minQuality=.1,this._maxMemory=500,this._additionalCacheMemory=100,this._quality=1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._memoryUsed=0,this._memoryPredicted=0,this._cacheStorage=new Wm["c"],this._numQualityChanges=0,this._updating=!1}destroy(){this.events=null,this._cacheStorage.destroy()}getMemCache(e,t){return new Wm["b"](e,this._cacheStorage,t)}set maxMemory(e){null!=e&&e>0&&(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(Xm),this._maxMemory=e)}get maxMemory(){return this._maxMemory}set additionalCacheMemory(e){null!=e&&e>=0&&(this._additionalCacheMemory=e)}disableMemCache(){this._additionalCacheMemory=-4096}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._memoryUsed}resetStableQuality(){this._stableQuality=0}update(){if(this._updateMemory(),this._memoryPredicted<=0&&!this._updating)return;let e=this._layersUpdating();if(this._memoryPredicted<Jm&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(Xm);else if(e)(this._memoryPredicted>1.1*Ym||this._memoryUsed>Ym)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>this.minQuality&&this._downscaleMemoryUsed<this._memoryUsed&&(this._updateQuality(this._quality/eb),this._downscaleMemoryUsed=this._memoryUsed,this._canFastRecover=!1));else if(this._downscaleMemoryUsed=0,this._memoryUsed>Ym)this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/eb),this._downscaleMemoryUsed=this._memoryPredicted;else if(this._stableQuality!==this._quality)if(this._memoryUsed<Km&&this._quality<Xm){this._stableQuality=this._quality;const t=.05;e=this._updateQuality(this._quality+t)}else this._quality<1&&(this._canFastRecover=!0);this.updating!==e&&(this._updating=e,this.events.emit("updating-changed",this.updating))}_updateQuality(e){return(e=Math.min(Math.max(e,this.minQuality),Xm))!==this._quality&&(this._quality=e,this.events.emit("quality-changed",this._quality),++this._numQualityChanges,!0)}_layersUpdating(){return this._view.allLayerViews.some(e=>!!e.updating)}_updateMemory(){let e=0,t=0;this._view.basemapTerrain&&this._view.basemapTerrain.getUsedMemory&&(e+=this._view.basemapTerrain.getUsedMemory());const i=this._view._stage&&this._view._stage.renderView&&this._view._stage.renderView.edgeView;Object(p["k"])(i)&&(e+=i.usedMemory),this._view.allLayerViews&&this._view.allLayerViews.forEach(i=>{if(Zm(i)){const r=i.ignoresMemoryFactor()?this._quality:1;e+=i.getUsedMemory()*r,t+=i.getUnloadedMemory()*r}});const r=null==this._warnMemoryUsage||Math.round(10*e)!==Math.round(10*this._warnMemoryUsage),a=1048576*this._maxMemory;if(e>a&&r){this._warnMemoryUsage=e;const i=e=>(e/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",r=Math.round(100*this._quality);$m.warn(`Memory Limit exceeded! Limit: ${i(a)} Current: ${i(e)} Projected: ${i(e+t)} Quality: ${r}%`)}this._memoryUsed=e/a,this._memoryPredicted=(e+t)/a;const n=a-e;this._cacheStorage.maxSize=Math.max(0,n+1048576*this._additionalCacheMemory),this.events.emit("memory-used",this._memoryUsed)}get test(){const e=this;return{cacheStorage:this._cacheStorage,resetQualityChanges:()=>{const t=e._numQualityChanges;return e._numQualityChanges=0,t}}}}var ib=i("3af9");let rb=class extends je["a"]{constructor(){super(...arguments),this.updating=!1}};function ab(e,t=(()=>performance.now())){return new nb.ResourceController({view:e,now:t})}var nb;Object(d["a"])([Object(g["b"])({readOnly:!0})],rb.prototype,"updating",void 0),rb=Object(d["a"])([Object(y["a"])("esri.views.3d.support.ResourceController")],rb),function(e){let t=class extends rb{constructor(){super(...arguments),this._scheduler=null,this._memoryController=null,this._streamDataLoader=null,this._cameraChangeTime=0,this._handles=new we["a"],this._frameTask=null}initialize(){this._cameraChangeTime=this.now(),this._scheduler=Object(ud["c"])(this.now),this._memoryController=Qm(this.view),this._streamDataLoader=new ib["b"],this._streamDataLoader.setup(qm["b"],qm["a"],this._scheduler),this._handles.add([this.view.watch("state.camera",(e,t)=>this._cameraChangedHandler(e,t),!0),this.view.watch("stationary",()=>this._stationaryChangedHandler()),this._memoryController.events.on("updating-changed",()=>this.notifyChange("updating"))]),this._frameTask=Object(w["a"])({update:e=>this.frame(e)})}destroy(){this._handles=Object(p["e"])(this._handles),this._frameTask=Object(p["s"])(this._frameTask),this._streamDataLoader=Object(p["e"])(this._streamDataLoader),this._memoryController=Object(p["e"])(this._memoryController),this._scheduler=Object(p["e"])(this._scheduler)}get updating(){var e,t;return!!(null!=(e=this._memoryController)&&e.updating||null!=(t=this._streamDataLoader)&&t.updating)}get scheduler(){return this._scheduler}get memoryController(){return this._memoryController}createStreamDataRequester(e){const t=this._streamDataLoader;return{request:(i,r,a)=>t.request(i,r,e,a),get busy(){return!t.hasDownloadSlots(e)}}}frame(e){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step(e.deltaTime/1e3),!this._scheduler)||(this._scheduler.state=this.state,this._scheduler.updateBudget(e)?(this._memoryController.update(),this._scheduler.frame()):this._memoryController.updating&&this._memoryController.update())}_cameraChangedHandler(e,t){e&&t&&e.almostEquals(t)||(this._cameraChangeTime=this._scheduler.now,this._scheduler.state=this.state)}_stationaryChangedHandler(){this.memoryController.resetStableQuality()}get state(){const e=this.view;return e.animation?0:e.interacting||this._scheduler.now-this._cameraChangeTime<=i?1:2}get test(){return{getQueueStats:e=>this._streamDataLoader.test.loadQueue.getStatsForType(e),state:this.state}}};Object(d["a"])([Object(g["b"])({constructOnly:!0})],t.prototype,"view",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],t.prototype,"now",void 0),Object(d["a"])([Object(g["b"])()],t.prototype,"_scheduler",void 0),Object(d["a"])([Object(g["b"])()],t.prototype,"_memoryController",void 0),Object(d["a"])([Object(g["b"])()],t.prototype,"_streamDataLoader",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],t.prototype,"updating",null),t=Object(d["a"])([Object(y["a"])("esri.views.3d.support.ResourceController")],t),e.ResourceController=t;const i=300}(nb||(nb={}));var sb=i("8b9d");function ob(e){return"performanceInfo"in e}class cb{constructor(e,t){if(this.layer=null,this.memory=0,this.displayedNumberOfFeatures=0,this.maximumNumberOfFeatures=null,this.totalNumberOfFeatures=null,this.layer=e.layer,this.memory=Object(sb["j"])(e)?t.basemapTerrain.getUsedMemoryForLayerView(e):e.getUsedMemory(),ob(e)){const t=e.performanceInfo;this.displayedNumberOfFeatures=t.displayedNumberOfFeatures,this.maximumNumberOfFeatures=t.maximumNumberOfFeatures,this.totalNumberOfFeatures=t.totalNumberOfFeatures}}}var lb=cb;class hb{constructor(e){this.totalMemory=0,this.usedMemory=0,this.quality=1,this.load=0,this.terrainMemory=0,this.edgesMemory=0,this.layerPerformanceInfos=new Array;const t=e.resourceController.memoryController;this.totalMemory=1048576*t.maxMemory,this.usedMemory=Math.round(t.usedMemory*this.totalMemory),this.quality=t.memoryFactor,this.load=e.resourceController.scheduler.load,this.terrainMemory=e.basemapTerrain?e.basemapTerrain.getUsedMemory():0;const i=e._stage&&e._stage.renderView&&e._stage.renderView.edgeView;this.edgesMemory=Object(p["k"])(i)?i.usedMemory:0,e.allLayerViews.items.forEach(t=>{(Zm(t)||Object(sb["j"])(t))&&this.layerPerformanceInfos.push(new lb(t,e))}),this.layerPerformanceInfos.sort((e,t)=>t.memory-e.memory)}}var db=hb,ub=i("b50f"),pb=i("998f"),fb=i("1e2c");class mb{constructor(e,t,i,r){this._streamDataRequester=e,this._stage=t,this._textureOptions=i,this._textureRequests=new Map,this._frameTask=Object(p["k"])(r)?r.registerTask(ud["b"].TEXTURE_UNLOAD,e=>this._frameTask.processQueue(e),()=>!1):ud["a"]}destroy(){this._frameTask.remove(),this._textureRequests.forEach(e=>this.releaseTextureRequest(e)),this._textureRequests.clear()}async fromUrl(e,t,i){Object(j["w"])(i);const r=Object(p["k"])(i)&&i.signal,a=this.makeUid(e,t);let n=this._textureRequests.get(a);if(!n){const i=Object(j["e"])(),r=this._streamDataRequester.request(e,"image",{uid:a,signal:i.signal});n={referenceCount:0,texture:null,textureAsync:null,abortController:i},this._textureRequests.set(a,n),n.textureAsync=r.then(i=>{const r=this.createTexture(e,i,t);return n.texture=r,n.abortController=null,this.addToStage(r),{uid:a,texture:r}},e=>{throw n.abortController=null,e})}return n.referenceCount++,new Promise((e,t)=>{Object(j["r"])(r,()=>{t(Object(j["f"])())}),n.textureAsync.then(e,t)}).catch(e=>{throw this.release(a),e})}fromData(e,t){const i=this.makeUid(e);let r=this._textureRequests.get(i);return r||(r={referenceCount:0,texture:t(),textureAsync:null,abortController:null},this.addToStage(r.texture),this._textureRequests.set(i,r)),r.referenceCount++,{uid:i,texture:r.texture}}release(e){if(!this._textureRequests)return;const t=this._textureRequests.get(e);t?(t.referenceCount<1&&console.warn("TextureCollection: reference count is < 1 for "+e),t.referenceCount--,t.referenceCount<1&&this._frameTask.schedule(()=>this.releaseNow(e))):console.warn(`TextureCollection: texture doesn't exist: '${e}'`)}get test(){return{textureRequests:this._textureRequests}}releaseNow(e){if(!this._textureRequests)return;const t=this._textureRequests.get(e);!t||t.referenceCount>0||(this.releaseTextureRequest(t),this._textureRequests.delete(e))}releaseTextureRequest(e){e.texture?this.removeFromStage(e.texture):e.abortController&&(e.abortController.abort(),e.abortController=null)}createTexture(e,t,i){const r={...this._textureOptions,powerOfTwoResizeMode:2};if(Object(_["w"])(e)){if(i||0===t.width&&0===t.height){const e=t.width?t.height/t.width:1;i=i||64,e>1?(t.width=Math.round(i/e),t.height=i):(t.width=i,t.height=Math.round(i*e))}this._stage.renderView&&Object(pb["b"])(this._stage.renderView.renderingContext).svgAlwaysPremultipliesAlpha&&(r.preMultiplyAlpha=!1)}return r.width=t.width,r.height=t.height,new fb["a"](t,r)}addToStage(e){this._stage.add(e)}removeFromStage(e){this._stage.remove(e)}makeUid(e,t){return null!=t?`${e}.${t}px`:e}}class bb{constructor(e){this.textures=null,this.streamDataRequester=null,this.graphicsOwners=[],this.screenSizePerspectiveHandles=null,this.cimSymbolRasterizer=null,this.viewState=e.viewState,this.view=e.view,this.pointsOfInterest=e.pointsOfInterest,this.objectResourceCache=e.objectResourceCache,this.streamDataRequester=e.resourceController.createStreamDataRequester(4),this.textures=new mb(this.streamDataRequester,e.view._stage,{preMultiplyAlpha:!0,wrap:{s:33071,t:33071}},e.resourceController.scheduler);const t=Object(V["e"])(this.view.spatialReference).radius;this.screenSizePerspectiveSettings=Object(Ad["d"])(e.viewingMode,t),this.screenSizePerspectiveSettingsLabels=Object(Ad["c"])(e.viewingMode,t)}destroy(){this.textures.destroy(),this.textures=null,this.streamDataRequester=null}addGraphicsOwner(e){if(!e)return{remove(){}};this.graphicsOwners.push(e);const t="layer"in e?e.watch("layer.screenSizePerspectiveEnabled",()=>this.updateScreenSizePerspectiveEnabled()):null;return this.updateScreenSizePerspectiveEnabled(),{remove:()=>{t&&(t.remove(),Object(ub["l"])(this.graphicsOwners,e),this.updateScreenSizePerspectiveEnabled())}}}updateScreenSizePerspectiveEnabled(){const e=this.graphicsOwners.some(e=>!0===e.get("layer.screenSizePerspectiveEnabled"));if(e&&!this.screenSizePerspectiveHandles){this.screenSizePerspectiveHandles=new we["a"];const e=()=>this.updateScreenSizePerspectiveSettings();this.screenSizePerspectiveHandles.add([this.pointsOfInterest.centerOnSurfaceInfrequent.watch("distance",e,!0),this.viewState.events.on("camera-projection-changed",e)]),this.updateScreenSizePerspectiveSettings()}else!e&&this.screenSizePerspectiveHandles&&(this.screenSizePerspectiveHandles.destroy(),this.screenSizePerspectiveHandles=null)}updateScreenSizePerspectiveSettings(){const e=this.pointsOfInterest;gb.distance=e.centerOnSurfaceInfrequent.distance,gb.fovY=this.viewState.camera.fovY,this.screenSizePerspectiveSettings.update(gb),this.screenSizePerspectiveSettingsLabels.update(gb),this.view._stage.renderView.setNeedsRender()}}const gb={distance:0,fovY:0};var vb=i("6005"),yb=i("a957"),Ob=i("7533");i("1fd7");class _b{constructor(e,t,i=""){this.graphics=e,this._symbol=new Ob["a"]({symbolLayers:[new vb["a"]({material:{color:t},outline:{color:[255,255,255],size:1},resource:{primitive:"circle"}}),new yb["a"]({text:i,halo:{color:"white",size:1/.75},material:{color:t},size:12})]})}showPoint(e,t){if(Object(p["j"])(t))return;this.remove();const i=new C["a"]({x:e[0],y:e[1],z:e[2],spatialReference:t});this._graphic=new R["a"]({geometry:i,symbol:this._symbol}),this.graphics.add(this._graphic)}remove(){Object(p["k"])(this._graphic)&&(this.graphics.remove(this._graphic),this._graphic=null)}}let xb=class extends je["a"]{constructor(e){super(e),this.handles=new we["a"]}destroy(){this.handles.destroy()}};Object(d["a"])([Object(g["b"])({constructOnly:!0})],xb.prototype,"renderCoordsHelper",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],xb.prototype,"surface",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],xb.prototype,"state",void 0),xb=Object(d["a"])([Object(y["a"])("esri.views.3d.support.PointOfInterest")],xb);const jb=Array;let wb=class extends xb{constructor(e){super(e),this._dirty=!1,this._propertiesPool=new Bp["a"]({location:C["a"],renderLocation:jb},this),this._estimatedSurfaceAltitude=0,this._pendingElevationQueryController=null,this.cameraName="camera",this.renderLocation=Object(M["e"])(),this.tmpPoint=new C["a"]}initialize(){if(this.scheduler&&this.handles.add(this.scheduler.registerTask(this.task,()=>this._update(),()=>this._needsUpdate())),this._update(),this.map){const e=()=>this._setDirty();this.handles.add(Object(L["b"])(this.map,"ground.layers","change",e,e,e))}}destroy(){this._cancelPendingRequest(),this._propertiesPool.destroy(),this._propertiesPool=null}get _camera(){return this.state[this.cameraName]}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}get scale(){const e=this._camera,t=Object(It["p"])(e.eye,this.renderLocation),i={renderCoordsHelper:this.renderCoordsHelper,state:{camera:e}};return Fl(i,t,0)}get updating(){return this._dirty||null!=this._pendingElevationQueryController}updateRenderLocation(){this._setDirty(),this._updateRenderLocation()}update(){this._update(),this._updateRenderLocation()}_setDirty(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))}_needsUpdate(){return!this._pendingElevationQueryController&&this._dirty}_cancelPendingRequest(){const e=this._pendingElevationQueryController;e&&(this._pendingElevationQueryController=null,e.abort(),this.notifyChange("updating"))}_update(){if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),!this.map||!this.map.ground)return void this._updateSurfaceAltitude(0);this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this.tmpPoint,this.state.spatialReference);let e=Object(j["e"])();this.map.ground.queryElevation(this.tmpPoint,{signal:e.signal,cache:this.cache}).then(e=>this._updateSurfaceAltitude(e.geometry.z)).catch(e=>{Object(j["n"])(e)||this._updateSurfaceAltitude(0)}).catch(()=>{}).then(()=>{this._pendingElevationQueryController===e&&(this._pendingElevationQueryController=null,this.notifyChange("updating")),e=null}),this._pendingElevationQueryController=e}_updateSurfaceAltitude(e){this._estimatedSurfaceAltitude!==e&&(this._estimatedSurfaceAltitude=e,this._updateRenderLocation())}_updateRenderLocation(){Object(It["l"])(Sb,this._camera.eye),this.renderCoordsHelper.setAltitude(this._estimatedSurfaceAltitude,Sb),Object(It["r"])(this._get("renderLocation"),Sb)||this._set("renderLocation",Object(It["l"])(this._propertiesPool.get("renderLocation"),Sb))}};Object(d["a"])([Object(g["b"])({constructOnly:!0})],wb.prototype,"scheduler",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],wb.prototype,"cache",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],wb.prototype,"task",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],wb.prototype,"cameraName",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],wb.prototype,"location",null),Object(d["a"])([Object(g["b"])({constructOnly:!0})],wb.prototype,"map",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],wb.prototype,"renderLocation",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],wb.prototype,"scale",null),Object(d["a"])([Object(g["b"])({readOnly:!0})],wb.prototype,"updating",null),wb=Object(d["a"])([Object(y["a"])("esri.views.3d.support.CameraOnSurface")],wb);const Sb=Object(M["e"])();var Cb=wb,Tb=Cb;const Pb=Array;let Ab=class extends xb{constructor(e){super(e),this._propertiesPool=new Bp["a"]({location:C["a"],renderLocation:Pb},this),this._currentSurfaceAltitude=0,this._latestSurfaceAltitude=0,this.distance=0,this.renderLocation=Object(M["e"])(),this.updating=!1}initialize(){this._frameWorker=this.scheduler.registerTask(this.task,()=>this._measureSurfaceAltitude(),()=>this.updating),this._measureSurfaceAltitude()}destroy(){this._frameWorker&&(this._frameWorker.remove(),this._frameWorker=null),this._propertiesPool.destroy(),this._propertiesPool=null}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}updateRenderLocation(){this._set("updating",!0),this._updateRenderLocation()}update(){this._measureSurfaceAltitude(),this._updateRenderLocation()}get estimatedSurfaceAltitude(){return this._latestSurfaceAltitude}_measureSurfaceAltitude(){this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this._set("updating",!1)}_updateRenderLocation(){const e=Mb;let t=this.calculateSurfaceIntersection(this._currentSurfaceAltitude,e);const i=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!t&&i&&(t=this.calculateSurfaceIntersection(this._latestSurfaceAltitude,e),t&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));const r=Eb;if(t&&this.latestSurfaceAltitudeChangesDistanceSignificantly(e,r)&&(Object(It["l"])(e,r),this._currentSurfaceAltitude=this._latestSurfaceAltitude),t){const t=Object(It["p"])(this.state.camera.eye,e);t!==this._get("distance")&&this._set("distance",t)}else{const t=this.state.camera;Object(It["f"])(e,t.viewForward,this._get("distance")),Object(It["g"])(e,e,t.eye)}Object(It["r"])(this._get("renderLocation"),e)||this._set("renderLocation",Object(It["l"])(this._propertiesPool.get("renderLocation"),e))}calculateSurfaceIntersection(e,t){const i=this.state.camera;if(!this.renderCoordsHelper.intersectManifold(i.ray,e,t))return!1;if(this.state.isGlobal){const r=Object(V["e"])(this.renderCoordsHelper.spatialReference).radius,a=r+e,n=Object(It["t"])(i.eye),s=n<a*a,o=Object(It["p"])(i.eye,t);if(s&&o>r/4){const e=a-Math.sqrt(n);return Object(It["f"])(t,i.viewForward,e),Object(It["g"])(t,t,i.eye),!0}}else{const e=this.surface.ready&&this.surface.extent;e&&(t[0]=Object(Qe["d"])(t[0],e[0],e[2]),t[1]=Object(Qe["d"])(t[1],e[1],e[3]))}return!0}latestSurfaceAltitudeChangesDistanceSignificantly(e,t){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||null==e)return!1;if(this.calculateSurfaceIntersection(this._latestSurfaceAltitude,t)){const i=this.state.camera.eye,r=Object(It["p"])(i,e),a=Object(It["p"])(i,t),n=Math.abs(a-r);if(dd["a"].TESTS_DISABLE_UPDATE_THRESHOLDS)return!0;if(n/r>Rb)return!0}return!1}};Object(d["a"])([Object(g["b"])({constructOnly:!0})],Ab.prototype,"scheduler",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],Ab.prototype,"task",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],Ab.prototype,"distance",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],Ab.prototype,"estimateSurfaceAltitudeAtCenter",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],Ab.prototype,"location",null),Object(d["a"])([Object(g["b"])({readOnly:!0})],Ab.prototype,"renderLocation",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],Ab.prototype,"updating",void 0),Ab=Object(d["a"])([Object(y["a"])("esri.views.3d.support.CenterOnSurface")],Ab);const Rb=.05,Mb=Object(M["e"])(),Eb=Object(M["e"])();var Db=Ab,Ib=Db;class Lb{constructor(e){this.handles=new we["a"],this.events=new Ce["a"],this.contentLayerViews=e.contentLayerViews,this.handles.add(this.contentLayerViews.on("change",e=>this.layerViewsChanged(e))),this.layerViewsChanged({added:this.contentLayerViews.toArray(),removed:[],moved:[],target:this.contentLayerViews})}destroy(){this.handles&&(this.handles.destroy(),this.handles=null)}layerViewsChanged(e){e.added.forEach(e=>{"esri.views.3d.layers.SceneLayerView3D"===e.declaredClass&&this.handles.add(e.on("visible-geometry-changed",()=>this.contentChanged()),e.uid)}),e.removed.forEach(e=>this.handles.remove(e.uid))}contentChanged(){this.events.emit("request-update",Vb)}}const Vb={};const kb=Array;let Fb=class extends xb{constructor(e){super(e),this._propertiesPool=new Bp["a"]({location:C["a"],renderLocation:kb},this)}destroy(){this._propertiesPool.destroy(),this._propertiesPool=null}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}get renderLocation(){const e=this.centerOnSurface.renderLocation,t=this.renderCoordsHelper,i=this.calculateScreenHorizontalEdgeOnSurface(Gb),r=this.state.camera;t.worldUpAtPosition(e,zb);const a=Math.max(0,(Math.acos(Object(It["i"])(zb,r.viewForward))-.5*Math.PI)*(r.aboveGround?1:-1)),n=this._propertiesPool.get("renderLocation");if(Number.isNaN(a))Object(It["l"])(n,e);else{const t=1-Object(Qe["d"])(a/(.5*Math.PI),0,1);Object(It["j"])(n,e,i,t*t*t)}const s=this._get("renderLocation");return s&&Object(It["C"])(s,n)?s:n}calculateScreenHorizontalEdgeOnSurface(e){const t=this.state.camera,i=t.getRenderCenter(Object(A["e"])());if(i[1]=t.aboveGround?t.padding[2]:t.fullHeight-t.padding[0],this.estimateSurfaceIntersectionAtRenderPoint(i,e))return e;const r=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(t.unprojectFromRenderScreen(i,Ub)){Object(It["k"])(Ub,Ub,t.eye);const i=Object(It["s"])(Ub,Ub);if(this.renderCoordsHelper.intersectManifold(Et["g"].wrap(t.eye,i),r,e))return e}return Object(It["l"])(e,t.eye),this.renderCoordsHelper.setAltitude(r,e),e}update(){}updateRenderLocation(){}};Object(d["a"])([Object(g["b"])({constructOnly:!0})],Fb.prototype,"centerOnSurface",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],Fb.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],Fb.prototype,"location",null),Object(d["a"])([Object(g["b"])({readOnly:!0})],Fb.prototype,"renderLocation",null),Object(d["a"])([Object(g["b"])({readOnly:!0,aliasOf:"centerOnSurface.updating"})],Fb.prototype,"updating",void 0),Fb=Object(d["a"])([Object(y["a"])("esri.views.3d.support.CenterOnSurface")],Fb);const zb=Object(M["e"])(),Ub=Object(M["e"])(),Gb=Object(M["e"])();var Bb=Fb,Hb=Bb;let Nb=class extends je["a"]{constructor(e){super(e),this.location=null,this._updateController=null,this._handles=new we["a"]}get renderLocation(){if(!this.location)return null;const e=Object(M["e"])();return this.view.renderCoordsHelper.toRenderCoords(this.location,e),e}initialize(){this.view.state.isLocal&&(this._handles.add([this.watch(["surfaceView.spatialReference","surfaceView.extent"],()=>this._update()),Object(L["b"])(this,"surface.layers","change",()=>this._update())]),this._update())}destroy(){this._handles.destroy()}_update(){if(this._updateController&&(this._updateController.abort(),this._updateController=null),!this.surfaceView||!this.surfaceView.extent||!this.surfaceView.spatialReference)return void this._set("location",null);const e=Object(F["e"])(this.surfaceView.extent),t=new C["a"]({x:e[0],y:e[1],z:0,spatialReference:this.surfaceView.spatialReference});this.surface&&this.surface.layers.length>0?(this._set("location",null),this._updateController=Object(j["e"])(),this.surface.queryElevation(t,{noDataValue:0,signal:this._updateController.signal,cache:this.cache}).then(e=>{this._updateController=null,this._set("location",e.geometry)}).catch(e=>{Object(j["n"])(e)||e&&"elevation-query:invalid-layer"===e.name||console.error("StableSurfaceCenter failed to update: ",e)})):this._set("location",t)}};Object(d["a"])([Object(g["b"])({constructOnly:!0})],Nb.prototype,"view",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],Nb.prototype,"cache",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0,aliasOf:"view.map.ground"})],Nb.prototype,"surface",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0,aliasOf:"view.basemapTerrain"})],Nb.prototype,"surfaceView",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],Nb.prototype,"location",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],Nb.prototype,"renderLocation",null),Nb=Object(d["a"])([Object(y["a"])("esri.views.3d.terrain.StableSurfaceCenter")],Nb);let qb=class extends je["a"]{constructor(){super(...arguments),this.handles=new we["a"],this._tileGeometryUpdateExtent=Object(F["n"])(),this._tileGeometryUpdateSpatialReference=null,this.events=new Ce["a"],this.updating=!1}initialize(){this.handles.add([this.surface.on("elevation-change",e=>this._tileGeometryChanged(e)),this.scheduler.registerTask(ud["b"].SURFACE_GEOMETRY_UPDATES,()=>this.update(),()=>this.updating)])}destroy(){this.handles&&(this.handles.destroy(),this.handles=null)}update(){this.updating&&(this._centerIntersectsExtent(this._tileGeometryUpdateExtent,this._tileGeometryUpdateSpatialReference)&&this.events.emit("request-update",Wb),Object(F["n"])(this._tileGeometryUpdateExtent),this._set("updating",!1))}_tileGeometryChanged(e){this._tileGeometryUpdateSpatialReference=e.spatialReference,Object(F["p"])(this._tileGeometryUpdateExtent,e.tile.extent),this._set("updating",!0)}_furthestCenterOnSurface(){let e=this.centerOnSurfaces[0];for(let t=1;t<this.centerOnSurfaces.length;t++){const i=this.centerOnSurfaces[t];i.distance>e.distance&&(e=i)}return e}_centerIntersectsExtent(e,t){const i=this.state.camera.eye,r=Qb,a=this._furthestCenterOnSurface();return this.renderCoordsHelper.fromRenderCoords(i,Zb,t),this.renderCoordsHelper.fromRenderCoords(a.renderLocation,$b,t),Zb[0]<$b[0]?(r[0]=Zb[0],r[2]=$b[0]):(r[0]=$b[0],r[2]=Zb[0]),Zb[1]<$b[1]?(r[1]=Zb[1],r[3]=$b[1]):(r[1]=$b[1],r[3]=Zb[1]),Object(F["w"])(r,e)}};Object(d["a"])([Object(g["b"])({constructOnly:!0})],qb.prototype,"state",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],qb.prototype,"centerOnSurfaces",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],qb.prototype,"renderCoordsHelper",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],qb.prototype,"scheduler",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],qb.prototype,"surface",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],qb.prototype,"updating",void 0),qb=Object(d["a"])([Object(y["a"])("esri.views.3d.support.SurfaceGeometryUpdates")],qb);const Wb={},Zb=Object(M["e"])(),$b=Object(M["e"])(),Qb=Object(F["n"])();var Xb=qb,Yb=Xb;let Kb=class extends je["a"]{constructor(e){super(e),this._handles=new we["a"],this._tmpRay=Object(lf["c"])(),this._centerRayDirty=!0,this._surfaceAltitudeAtCenter=0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenter=0,this._contentAltitudeAtCenterDirty=!0,this._propertiesPool=new Bp["a"]({renderPointOfView:Jb},this),this.renderPointOfView=Object(M["e"])(),this._pois=new Array,this._debugCenters=new Map}initialize(){var e;const{state:t,basemapTerrain:i,renderCoordsHelper:r,map:a}=this.view;this._surfaceIntersector=new Gr["a"](t.mode),t.isGlobal?this._surfaceIntersector.options.backfacesTerrain=!1:this._surfaceIntersector.options.backfacesTerrain=!0,this._surfaceIntersector.options.invisibleTerrain=!1,this._contentIntersector=new Gr["a"](t.mode);const n=()=>this._estimateSurfaceAltitudeAtCenter(),s=this.view.resourceController.scheduler,o=Object(p["t"])(null==(e=this.view.basemapTerrain)?void 0:e.elevationQueryCache),c={state:t,scheduler:s,surface:i,renderCoordsHelper:r};this._set("centerOnSurfaceInfrequent",new Ib({...c,task:ud["b"].POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:n})),this._set("centerOnSurfaceFrequent",new Ib({...c,task:ud["b"].POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:n})),this._set("centerOnContent",new Ib({...c,task:ud["b"].POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()})),this._set("cameraOnSurface",new Tb({...c,cache:o,task:ud["b"].POINT_OF_INTEREST_INFREQUENT,map:a})),this._set("contentCameraOnSurface",new Tb({...c,cache:o,task:ud["b"].POINT_OF_INTEREST_INFREQUENT,map:a,cameraName:"contentCamera"})),this._set("surfaceGeometryUpdates",new Yb({...c,centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]})),this._set("contentGeometryUpdates",new Lb({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:r})),this._set("surfaceOrigin",new Nb({cache:o,view:this.view})),this._set("focus",new Hb({state:t,surface:i,renderCoordsHelper:r,centerOnSurface:this.centerOnSurfaceFrequent,estimateSurfaceIntersectionAtRenderPoint:(e,t)=>this._estimateSurfaceIntersectionAtRenderPoint(e,t)})),this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.cameraOnSurface,this.contentCameraOnSurface,this.focus);const l=this.view.graphics;this._debugCenters.set(this.centerOnContent,new _b(l,"red","CenterOnContent")),this._debugCenters.set(this.centerOnSurfaceFrequent,new _b(l,"red","CenterOnSurface")),this._debugCenters.set(this.cameraOnSurface,new _b(l,"blue","CameraOnSurface")),this._debugCenters.set(this.contentCameraOnSurface,new _b(l,"blue","CameraOfInterestOnSurface")),this._debugCenters.set(this.focus,new _b(l,"green","Focus")),this._handles.add([t.watch("camera",e=>this._cameraChanged(e),!0),i.watch("extent",()=>this._updateCenterPointsOfInterest()),this.surfaceGeometryUpdates.events.on("request-update",()=>this._updateCenterPointsOfInterest()),this.contentGeometryUpdates.events.on("request-update",()=>this._updateCenterOnContent()),Object(L["a"])(dd["a"],"SHOW_POI",e=>this._setDebug(e))]),this._cameraChanged(this.view.state.camera);for(const h of this._pois)h.update()}destroy(){this._setDebug(!1),this._handles.destroy(),this._propertiesPool.destroy();for(const e of this._pois)e.destroy();this.surfaceOrigin.destroy()}get updating(){var e;return!!(null!=(e=this.surfaceGeometryUpdates)&&e.updating||this._pois.some(e=>e.updating))}get centerRay(){return this._centerRayDirty&&(this._centerRay=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.camera,this._tmpRay),this._centerRayDirty=!1),this._centerRay}_estimateContentAltitudeAtCenter(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const e=this.centerRay;return Object(p["j"])(e)||(this.view.sceneIntersectionHelper.intersectRay(e,this._contentIntersector,eg,ig)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(eg):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter()),this._contentAltitudeAtCenter}_estimateSurfaceAltitudeAtCenter(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const e=this.centerRay;if(Object(p["j"])(e))return this._surfaceAltitudeAtCenter;const t=e.origin,i=Object(It["g"])(eg,e.origin,e.direction);return this._surfaceIntersector.resetWithRay(e),this._surfaceIntersector.intersect(null,null,this.view.state.camera),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,t,i),this._surfaceIntersector.results.min.getIntersectionPoint(eg)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(eg)),this._surfaceAltitudeAtCenter}_estimateSurfaceIntersectionAtRenderPoint(e,t){const i=Object(lf["f"])(this.view.state.camera,e,tg);if(Object(p["j"])(i))return null;const r=i.origin,a=Object(It["g"])(eg,i.origin,i.direction);return this._surfaceIntersector.resetWithRay(i),this._surfaceIntersector.intersect(null,null,this.view.state.camera),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,r,a),this._surfaceIntersector.results.min.getIntersectionPoint(t)?t:null}_cameraChanged(e){this._updateCenterPointsOfInterest();const t=e.eye;Object(It["r"])(this.renderPointOfView,t)||this._set("renderPointOfView",Object(It["l"])(this._propertiesPool.get("renderPointOfView"),t))}_updateCenterPointsOfInterest(){this._centerRayDirty=!0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenterDirty=!0;for(const e of this._pois)e.updateRenderLocation()}_updateCenterOnContent(){this._contentAltitudeAtCenterDirty=!0,this.centerOnContent.updateRenderLocation()}_setDebug(e){if(!e)return this._debugCenters.forEach(e=>e.remove()),void this._handles.remove("debug");for(const t of this._pois)this._handles.add(Object(L["a"])(t,"renderLocation",e=>this._debugCenters.get(t).showPoint(e,t.renderCoordsHelper.spatialReference)),"debug")}get test(){return{update:()=>{this.surfaceGeometryUpdates.update();for(const e of this._pois)e.update()},surfaceGeometryUpdates:this.surfaceGeometryUpdates}}};Object(d["a"])([Object(g["b"])({readOnly:!0})],Kb.prototype,"centerOnContent",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],Kb.prototype,"centerOnSurfaceFrequent",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],Kb.prototype,"centerOnSurfaceInfrequent",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],Kb.prototype,"cameraOnSurface",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],Kb.prototype,"contentCameraOnSurface",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],Kb.prototype,"focus",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],Kb.prototype,"renderPointOfView",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],Kb.prototype,"surfaceOrigin",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],Kb.prototype,"contentGeometryUpdates",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],Kb.prototype,"surfaceGeometryUpdates",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],Kb.prototype,"view",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],Kb.prototype,"updating",null),Kb=Object(d["a"])([Object(y["a"])("esri.views.3d.support.PointsOfInterest")],Kb);const Jb=Array,eg=Object(M["e"])(),tg=Object(lf["c"])(),ig={exclude:new Set([Ur["e"]])};var rg=Kb,ag=rg,ng=i("4adc"),sg=i("4d10"),og=i("d378"),cg=i("66b9");class lg{constructor(e){this.store=e}destroy(){this.store.destroy()}get(e){return this.store.get(e)}put(e,t){this.store.put(e,t,t.values.byteLength+256)}}var hg=i("1dc3");class dg{constructor(e=0,t=0){this.min=e,this.max=t,this.level=0,this.hasNoDataValues=!1}copyFrom(e){this.min=e.min,this.max=e.max,this.level=e.level,this.hasNoDataValues=e.hasNoDataValues}}class ug{constructor(e,t,i){this.samplerData=null,this.level=e[0],this.i=e[1],this.j=e[2],this.extent=t;const r=i.noDataValue,a=i.values;let n=1/0,s=-1/0,o=!0,c=!1;for(let l=0;l<a.length;l++){const e=a[l];e!==r?(n=e<n?e:n,s=e>s?e:s,o=!1):c=!0}o&&(n=0,s=0),s=s>-3e38?s:0,this.samplerData={pixelData:i.values,width:i.width,height:i.height,noDataValue:r,safeWidth:.99999999*(i.width-1),dx:(i.width-1)/(t[2]-t[0]),dy:(i.width-1)/(t[3]-t[1]),x0:t[0],y1:t[3]},this.bounds=[n,s],this.hasNoDataValues=c}release(){this.samplerData=null,this.bounds=null}computeMinMaxValue(e,t,i,r){r.min=1/0,r.max=-1/0,r.hasNoDataValues=!1;const a=e-this.level;if(a<=0)return r;const n=2**a;if(Math.floor(t/n)!==this.i||Math.floor(i/n)!==this.j)return r;let s=1/0,o=-1/0;const c=this.samplerData.width,l=this.samplerData.pixelData,h=.5*Pe["c"];let d=(c-1)/n,u=(i-this.j*n)*d,p=(t-this.i*n)*d;if(d<1){const e=Math.floor(u),t=Math.floor(p),i=e+t*c,a=l[i],n=l[i+1],s=l[i+c],o=l[i+c+1];if(a+n+s+o<h){const i=u-e,c=p-t,l=Object(Xe["c"])(a,n,s,o,i,c),h=Object(Xe["c"])(a,n,s,o,i+d,c),f=Object(Xe["c"])(a,n,s,o,i,c+d),m=Object(Xe["c"])(a,n,s,o,i+d,c+d);return r.min=Math.min(l,h,f,m),r.max=Math.max(l,h,f,m),r}u=e,p=t,d=1}else u=Math.floor(u),p=Math.floor(p),d=Math.ceil(d);for(let f=u;f<=u+d;f++)for(let e=p;e<=p+d;e++){const t=l[f+e*c];t<h?(s=Math.min(s,t),o=Math.max(o,t)):r.hasNoDataValues=!0}return r.min=s,r.max=o,r}static sample(e,t,i){for(const r of i){if(!r)continue;const i=r.safeWidth,a=r.width,n=r.pixelData;let s=Object(Qe["d"])(r.dy*(r.y1-t),0,i),o=Object(Qe["d"])(r.dx*(e-r.x0),0,i);const c=Math.floor(s),l=Math.floor(o),h=c*a+l,d=h+a,u=n[h],p=n[d],f=n[h+1],m=n[d+1];if(u+p+f+m<.5*Pe["c"]){s-=c,o-=l;const e=u+(f-u)*o;return e+(p+(m-p)*o-e)*s}}return null}}var pg=i("d4ca"),fg=i("7abc"),mg=i("7585");const bg=25,gg=Object(pg["a"])(1e3/bg),vg=20,yg=Object(pg["a"])(1e3/vg);var Og=i("debd");function _g(){var e;const t=null==(e=Og["a"].require)?void 0:e.modules;if(t){const e=Object.keys(t);for(const i of e)-1!==i.search(".glsl")&&delete t[i]}}const xg=3.5,jg=10,wg=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let Sg,Cg=class extends je["a"]{constructor(e){super(e),this._handles=new we["a"],this._overlaySR=null,this._renderSR=null,this._overlaySREqualsRenderSR=!0,this._drapeSources=new Map,this._drapeTargets=new Set,this._drapeSourceTypes=[0,0],this._drapeTargetTypes=[0,0],this._renderedAltitude=0,this._placementDirty=!1,this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this._layerViewsDirty=!0,this._hasUnusedRenderTargets=!1,this._isSpherical=!1,this._longitudeCyclical=null,this._latestOriginId=0,this._maxResolution=Object(u["a"])("esri-mobile")?2048:4096,this._animationTimeLast=0}get _needsUpdate(){return(this._placementDirty||this._layerViewsDirty)&&(this._drapeSources.size>0||this.view.graphics.length>0||dd["a"].OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._overlaySR&&!this.suspended&&this.surface.ready}get view(){return this.surface.view}get updating(){return this._needsUpdate||this.renderer.updating}get hasHighlights(){return this.renderer.hasHighlights}get rendersOccluded(){return this.renderer.rendersOccluded}initialize(){const e=this.view._stage.renderView,t=this.view.state.isGlobal&&Object(p["k"])(this._overlaySR)?Object(Yp["e"])(this._overlaySR):1,i=this.view.resourceController.scheduler;this.renderer=new mg["b"]({renderView:e,globalUnitScale:t,scheduler:i}),this._drapeTargetTypes[0]++,this.renderer.onHasHighlightsChanged=()=>{this._setDrawTexturesDirty(),this.notifyChange("hasHighlights")},this.renderer.onRendersOccludedChanged=()=>{this._setDrawTexturesDirty(),this.notifyChange("rendersOccluded")},this.renderer.onContentChanged=()=>{this._setDrawTexturesDirty()},this.groundIntersector=new Gr["a"](this.view.state.mode),this.groundIntersector.options.backfacesTerrain=!0,this.groundIntersector.options.invisibleTerrain=!0,this.groundIntersector.options.hud=!1,this._handles.add([this.view.watch(["pointsOfInterest.renderPointOfView","pointsOfInterest.centerOnSurfaceFrequent.location","pixelRatio"],()=>this.setOverlayPlacementDirty()),this.surface.on("elevation-change",()=>this.setOverlayPlacementDirty()),this.view.allLayerViews.on("after-changes",()=>this._layerViewsDirty=!0),this.view.on("resize",()=>this.setOverlayPlacementDirty()),Object(w["a"])({preRender:e=>{this.renderer.commitChanges(),this._updateLayerViews(),this.renderer.hasOverlays&&(this._dispatchRendererUpdate(e),this._drawOverlayTextures(this.renderer.overlays)),this._hasUnusedRenderTargets&&this._collectUnusedRenderTargetMemory()}}),i.registerTask(ud["b"].OVERLAY_MANAGER,()=>this._updateOverlays(),()=>this._needsUpdate),this.view._stage.renderView.events.on("force-camera-for-screenshot",e=>{this._updateOverlays(e),this.renderer.hasOverlays&&this._drawOverlayTextures(this.renderer.overlays)})]),this._updateLayerViews()}destroy(){this._drapeSources.forEach((e,t)=>this.unregisterDrapeSource(t)),this._drapeTargets.forEach(e=>this._unregisterDrapeTarget(e)),this._drapeTargetTypes[0]--,this._disposeOverlays(),this.renderer.dispose(),this._handles&&(this._handles.destroy(),this._handles=null),Object(p["k"])(Sg)&&(Sg.remove(),Sg=null)}get hasOverlays(){return this.renderer.hasOverlays}setSpatialReference(e,t){this._overlaySR=e,this._longitudeCyclical=null;const i=this.view.renderSpatialReference;Object(p["k"])(e)&&Object(p["k"])(i)?(this._renderSR=i,this._overlaySREqualsRenderSR=e.equals(this._renderSR),this._isSpherical=t,t&&(this._longitudeCyclical=e.isWebMercator?new Xe["a"](-20037508.342787,20037508.342787):new Xe["a"](-180,180),this.renderer.longitudeCyclical=this._longitudeCyclical),this.renderer&&(this.renderer.globalUnitScale=t&&Object(p["k"])(this._overlaySR)?Object(Yp["e"])(this._overlaySR):1)):this._disposeOverlays()}getGpuMemoryUsage(){return this.renderer.gpuMemoryUsage}_updateLayerViews(){if(!this._layerViewsDirty)return;const e=new Set;for(const t of this.view.allLayerViews.items)e.add(t.uid),"drapeSourceType"in t&&!this._drapeSources.has(t)&&this._registerDrapeSource(t,0),"drapeTargetType"in t&&!this._drapeTargets.has(t)&&this._registerDrapeTarget(t);this._drapeSources.forEach((t,i)=>{0!==t||e.has(i.uid)||this.unregisterDrapeSource(i)}),this._drapeTargets.forEach(t=>{e.has(t.uid)||this._unregisterDrapeTarget(t)}),this.renderer.updateLayerOrder(),this._setDrawTexturesDirty(),this._layerViewsDirty=!1}registerDrapeSource(e){this._registerDrapeSource(e,1)}_registerDrapeSource(e,t){this._drapeSourceTypes[e.drapeSourceType]++,this._drapeSources.set(e,t),this.renderer.forEachOverlay((t,i)=>this._updateDrapeSource(e,i,t)),this._setOverlayContentDirty(),this.notifyChange("_needsUpdate")}_updateDrapeSource(e,t,i){Object(p["k"])(e.setDrapingExtent)&&Object(p["k"])(this._overlaySR)&&e.setDrapingExtent(t,i.extent,this._overlaySR,i.resolution,i.renderLocalOrigin,i.pixelRatio)}unregisterDrapeSource(e){this._drapeSources.has(e)&&(this._drapeSourceTypes[e.drapeSourceType]--,this._drapeSources.delete(e),this._setOverlayContentDirty(),this.notifyChange("_needsUpdate"))}_registerDrapeTarget(e){this._drapeTargets.add(e),this._updateDrapeTarget(e),this._drapeTargetTypes[e.drapeTargetType]++}_updateDrapeTarget(e){this.renderer.forEachOverlay((t,i)=>{const r=t.renderTargets,a=this.needsColorWithoutRasterImage()?r.colorWithoutRasterImage:this.hasDrapedFeatures()?r.color:null,n=r.highlight,s=r.water;e.setDrapingTextures(i,t.extent,a&&a.valid?a.fbo.getTexture():null,n.valid?n.fbo.getTexture():null,s.valid?s.fbo.getTexture():null)})}_unregisterDrapeTarget(e){this._drapeTargets.delete(e),this._drapeTargetTypes[e.drapeTargetType]--}_setOverlayContentDirty(){this.setOverlayPlacementDirty(),this._setDrawTexturesDirty()}setOverlayPlacementDirty(){this._placementDirty=!0}_updateOverlays(e=this.view.state.camera){if(!this._overlaySR)return;this._updateLayerViews();const t=Tg(e.fullWidth,e.fullHeight),i=Math.min(t,this._maxResolution);this._computeOverlayExtents(e,t,Eg);const r=Object(F["B"])(Eg.inner)/Object(F["B"])(Eg.outer);this.renderer.ensureOverlays();const a=this._updateOverlay(0,Eg.inner,i,1),n=this._updateOverlay(1,Eg.outer,i,r);(a||n)&&(this.surface.updateTileOverlayParams(),this._setDrawTexturesDirty()),this._placementDirty=!1,this.surface.updateOverlayOpacity()}_updateOverlay(e,t,i,r){if(Object(p["j"])(this.renderer.overlays))return!1;const a=this.renderer.overlays[e];if(!Pg(t,a.extent)&&i===a.resolution&&a.pixelRatio===r)return!1;Object(F["z"])(a.extent,t),a.resolution=i,a.pixelRatio=r;const n=Object(F["e"])(a.extent);return a.renderLocalOrigin=Object(fg["a"])(n[0],n[1],0,"OV_"+this._latestOriginId++),this._drapeSources.forEach((t,i)=>this._updateDrapeSource(i,e,a)),!0}computeOpacity(e){if(!this.renderer.hasOverlays)return 1;if(e*xg<this._renderedAltitude){const t=(e-this._renderedAltitude/jg)/(this._renderedAltitude/xg-this._renderedAltitude/jg);return Math.sqrt(Object(Qe["d"])(t,0,1))}return 1}setTileParameters(e){const t=e.renderData.overlay;if(Object(p["k"])(this.renderer.overlays)){const i=this.renderer.overlays[0],r=this.renderer.overlays[1],a=Object(F["v"])(e.extent,e.surface.extent,Dg);this._rectInsideRect(a,i.extent)?(this._setTileOverlayData(a,0,t),this._clearTileOverlayData(1,t)):this._rectanglesOverlap(a,i.extent)?(this._setTileOverlayData(a,0,t),this._setTileOverlayData(a,1,t)):this._rectanglesOverlap(a,r.extent)?(this._clearTileOverlayData(0,t),this._setTileOverlayData(a,1,t)):(this._clearTileOverlayData(0,t),this._clearTileOverlayData(1,t))}else this._clearTileOverlayData(0,t),this._clearTileOverlayData(1,t)}overlayPixelSizeInMapUnits(e){if(Object(p["j"])(this.renderer.overlays))return 0;const t=this.renderer.overlays[0],i=this.renderer.overlays[1],r=this._pointIsInExtent(e,t.extent)?t:i;return(r.extent[2]-r.extent[0])/r.resolution}_setTileOverlayData(e,t,i){if(Object(p["j"])(this.renderer.overlays))return;const r=this.renderer.overlays[t].extent;i.setScale(t,(e[2]-e[0])/(r[2]-r[0]),(e[3]-e[1])/(r[3]-r[1]));let a=e[0];if(this._longitudeCyclical){a=this._longitudeCyclical.minimalMonotonic(r[0],a);const t=this._longitudeCyclical.minimalMonotonic(r[0],e[2]);a>t&&(a=t-(e[2]-e[0]))}i.setOffset(t,(a-r[0])/(r[2]-r[0]),(e[1]-r[1])/(r[3]-r[1]))}_clearTileOverlayData(e,t){t.setScale(e,-1,-1),t.setOffset(e,-1,-1)}_disposeOverlays(){this.renderer.disposeOverlays()}async reloadShaders(){_g(),await this.renderer.reloadShaders(),this._updateOverlays()}stopAnimationsAtTime(e){this.renderer.stopAnimationsAtTime(e),this._drawTexturesAnimateDirty=!0}_dispatchRendererUpdate(e){const t=Object(pg["a"])(e.time-this._animationTimeLast);t<yg||(this._animationTimeLast=e.time,this.renderer.updateLogic({dt:t,camera:this.view._stage.camera})&&(this._drawTexturesAnimateDirty=!0))}_setDrawTexturesDirty(){this.renderer.hasOverlays?this._drawTexturesDirty=!0:this.setOverlayPlacementDirty()}_intersectGroundFromView(e,t,i,r){const a=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,Lg,t,i);if(Object(p["j"])(a))return!1;const n=a.origin,s=Object(It["g"])(Mg,a.origin,a.direction);return this.groundIntersector.reset(n,s),this.groundIntersector.intersect([],null,e),this.view.basemapTerrain.intersect(this.groundIntersector,null,n,s),this.groundIntersector.results.min.getIntersectionPoint(r)}_findHorizonBasedPointOfInterest(e,t){let i=.5;const r=.55,a=this.view.renderCoordsHelper.getAltitude(e.eye),n=this.view.pointsOfInterest.centerOnSurfaceFrequent,s=1e-5,o=Object(Qe["d"])(n.estimatedSurfaceAltitude,e.aboveGround?-1/0:a+s,e.aboveGround?a-s:1/0),c=e.aboveGround;if("global"===this.view.viewingMode){const t=Mg;Et["h"].closestPointOnSilhouette(Et["h"].fromRadius(Object(V["e"])(this.view.spatialReference).radius+o),Et["g"].wrap(e.eye,e.viewForward),t),Object(It["k"])(t,t,e.eye);const a=Xe["g"].normalize(Et["j"].angleAroundAxis(e.viewForward,t,e.viewRight))/e.fovY+.5,n=a<=0||a>=1?.5:r;i=c?n*a:a+n*(1-a)}else{const t=.5*Math.PI-Math.acos(-e.viewForward[2]),a=Math.tan(t),n=Object(Lt["d"])(0,a,1,0),s=Object(ui["m"])(n,n,e.projectionMatrix)[1],o=Object(Qe["d"])(.5+.5*s,0,1);i=1===o||0===o?.5:c?o*r:1-(1-o)*r}return!!this._intersectGroundFromView(e,.5,i,t)&&Object(It["A"])(t,e.eye)<n.distance*n.distance}_computeOverlayExtents(e,t,i){const r=this.surface.extent,a=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,n=Object(M["e"])();this._findHorizonBasedPointOfInterest(e,n)||Object(It["l"])(n,a),this._renderedAltitude=this.view.renderCoordsHelper.getAltitude(e.eye);const s=Object(It["p"])(e.eye,n),o=On(this.view.renderCoordsHelper,a,e.eye),c=Math.PI/2-Math.abs(o-Math.PI/2);dd["a"].OVERLAY_SHOW_CENTER?(Object(p["j"])(Sg)&&(Sg=new _b(this.view.graphics,"red")),Sg.showPoint(n,this._renderSR)):Object(p["k"])(Sg)&&Sg.remove(),this._overlaySREqualsRenderSR||Object(z["y"])(n,this._renderSR,n,this._overlaySR);let l=t*e.perRenderPixelRatio*s/2,h=!1,d=1/0;this._isSpherical&&Object(p["k"])(this._overlaySR)&&(this._overlaySR.isWebMercator?(l/=Math.cos(Object(S["h"])(n[1])),d=this.surface.extent[3]):(h=!0,l/=Object(V["e"])(this._overlaySR).metersPerDegree,d=90),l>=d&&(l=d,n[1]=0,this._overlaySR.isWebMercator&&(n[0]=0)));let u=1;h&&(u=1/Math.max(.2,Math.cos(Math.abs(Object(Qe["f"])(n[1])))),l*u>180&&(u=180/l));const f=Math.log(2)/12;l=Math.exp(Math.round(Math.log(l)/f)*f);const m=l*u,b=32,g=.5*t/(b*m),v=.5*t/(b*l);n[0]=Math.round(n[0]*g)/g,n[1]=Math.round(n[1]*v)/v;const y=i.inner;y[0]=n[0]-m,y[1]=n[1]-l,y[2]=n[0]+m,y[3]=n[1]+l,this._isSpherical&&this._shiftExtentToFitBounds(y,1/0,d);const O=i.outer;if(Object(F["z"])(O,y),6*m>r[2]-r[0])Object(F["z"])(O,r);else if(c<=.25*Math.PI)O[0]-=m,O[1]-=l,O[2]+=m,O[3]+=l;else{Object(z["y"])(e.eye,this._renderSR,Mg,this._overlaySR),Object(di["d"])(Rg,n,Mg);let t=-Math.atan2(Rg[1],Rg[0])+.125*Math.PI;t<0&&(t+=2*Math.PI);const i=Math.floor(t/(.25*Math.PI));Object(ui["b"])(Rg,wg[i],2*l),Rg[0]*=u,Rg[2]*=u,Object(ui["a"])(O,O,Rg)}if(this._isSpherical&&(O[0]=this._longitudeCyclical.clamp(O[0]),O[2]=this._longitudeCyclical.clamp(O[2]),O[1]=Math.max(O[1],-d),O[3]=Math.min(O[3],d)),!this._isSpherical&&r){const e=Object(F["v"])(y,r,Dg),t=Object(F["v"])(O,r,Ig);Object(F["g"])(e,t)&&(O[2]=O[0],O[3]=O[1])}}_drawOverlayTextures(e){if(Object(p["j"])(e)||!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return;const t=this._drawOverlay(e,0),i=this._drawOverlay(e,1);0!==t&&0!==i||this.surface.updateTileOverlayParams(),this._collectUnusedRenderTargetMemory(),this._drapeTargets.forEach(e=>this._updateDrapeTarget(e)),this._drawTexturesAnimateDirty=!1,this._drawTexturesDirty?(this._drawTexturesDirty=!1,this.surface.requestRender(),this.surface.pendingUpdates=!0):this.surface.requestRender(0)}_setupGeometryViewsCyclical(e,t,i){this._setupGeometryViewsDirect(e,t,i);const r=.001*this._longitudeCyclical.range;if(t[0]-r<=this._longitudeCyclical.min){const r=e.views[e.numViews++];Object(ui["l"])(r.viewport,0,0,i,i),Object(F["y"])(t,this._longitudeCyclical.range,0,r.extent)}if(t[2]+r>=this._longitudeCyclical.max){const r=e.views[e.numViews++];Object(ui["l"])(r.viewport,0,0,i,i),Object(F["y"])(t,-this._longitudeCyclical.range,0,r.extent)}}_setupGeometryViewsDirect(e,t,i){e.numViews=1;const r=e.views[0];Object(F["z"])(r.extent,t),Object(ui["l"])(r.viewport,0,0,i,i)}_drawOverlay(e,t){const i=e[t],r=i.computeRenderTargetValidityBitfield(),{extent:a,resolution:n,pixelRatio:s}=i;return this._longitudeCyclical?this._setupGeometryViewsCyclical(Ag,a,n):this._setupGeometryViewsDirect(Ag,a,n),Ag.width=n,Ag.height=n,Ag.pixelRatio=s*this.view.state.camera.pixelRatio,Ag.index=t,i.drawRenderTargets(this.renderer,Ag,this.needsColorWithoutRasterImage()),r^i.computeRenderTargetValidityBitfield()?0:1}needsColorWithoutRasterImage(){return this._drapeSourceTypes[0]>0&&this._drapeSourceTypes[1]>0&&this._drapeTargetTypes[1]>0}hasDrapedFeatures(){return this._drapeSourceTypes[1]>0}_collectUnusedRenderTargetMemory(){if(this._hasUnusedRenderTargets=!1,this.renderer.hasOverlays){const e=performance.now();this.renderer.forEachOverlay(t=>this._hasUnusedRenderTargets=t.collectUnusedMemory(e)||this._hasUnusedRenderTargets)}}_rectanglesOverlap(e,t){return this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):Object(F["w"])(e,t)}_rectInsideRect(e,t){return this._longitudeCyclical?this._longitudeCyclical.contains(t[0],t[2],e[0])&&this._longitudeCyclical.contains(t[0],t[2],e[2])&&e[1]>t[1]&&e[3]<t[3]:Object(F["g"])(t,e)}_pointIsInExtent(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];const i=e.x,r=e.y;return i>t[0]&&i<t[2]&&r>t[1]&&r<t[3]}_shiftExtentToFitBounds(e,t,i){let r=0,a=0;e[0]<-t?r=e[0]+t:e[2]>t&&(r=t-e[2]),e[1]<-i?a=e[1]+i:e[3]>i&&(a=i-e[3]),Object(F["y"])(e,r,a)}get test(){return{renderer:this.renderer,update:()=>this._updateOverlays()}}};function Tg(e,t){const i=Math.max(e,t)+256;return Object(Qe["o"])(i)}function Pg(e,t){const i=1e-5,r=dd["a"].TESTS_DISABLE_UPDATE_THRESHOLDS?0:i*Math.max(e[2]-e[0],e[3]-e[1],t[2]-t[0],t[3]-t[1]);for(let a=0;a<4;a++)if(Math.abs(t[a]-e[a])>r)return!0;return!1}Object(d["a"])([Object(g["b"])()],Cg.prototype,"_overlaySR",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],Cg.prototype,"_needsUpdate",null),Object(d["a"])([Object(g["b"])()],Cg.prototype,"_placementDirty",void 0),Object(d["a"])([Object(g["b"])()],Cg.prototype,"_layerViewsDirty",void 0),Object(d["a"])([Object(g["b"])()],Cg.prototype,"renderer",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],Cg.prototype,"surface",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0,aliasOf:"surface.suspended"})],Cg.prototype,"suspended",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],Cg.prototype,"updating",null),Object(d["a"])([Object(g["b"])({type:Boolean})],Cg.prototype,"hasHighlights",null),Object(d["a"])([Object(g["b"])({type:Boolean})],Cg.prototype,"rendersOccluded",null),Cg=Object(d["a"])([Object(y["a"])("esri.views.3d.terrain.OverlayManager")],Cg);const Ag={width:0,height:0,pixelRatio:0,views:[{viewport:Object(F["l"])(),extent:Object(F["l"])()},{viewport:Object(F["l"])(),extent:Object(F["l"])()},{viewport:Object(F["l"])(),extent:Object(F["l"])()}],numViews:0,index:0},Rg=Object(Lt["c"])(),Mg=Object(M["e"])(),Eg={inner:Object(F["l"])(),outer:Object(F["l"])()},Dg=Object(F["l"])(),Ig=Object(F["l"])(),Lg=Et["g"].create();var Vg=i("a03d");class kg{constructor(){this.waitingAgents=new fd["a"],this._upsampleInfo=null,this.loadingAgent=null,this.requestPromise=null,this.requestAbort=null,this.pendingUpdates=0}static acquire(e){const t=Fg.acquire();return t._init(e),t}release(){this.dispose(),zg.delete(this),Fg.release(this)}dispose(){this.loadingAgent=Object(p["f"])(this.loadingAgent),this.abortRequest(),this._unsetUpsampleInfo(),this.pendingUpdates=0,this._data=Object(sb["o"])(this._data)}static prune(){Fg.prune(0)}_init(e){this.waitingAgents.clear(),this._data=Object(sb["o"])(this._data),this.dataMissing=!1,this.dataInvalidated=!1,this._unsetUpsampleInfo(),this.abortRequest(),this.loadingAgent=null,this.pendingUpdates=0,this._pool=e,this.elevationBounds=null}invalidateSourceData(){this.dataInvalidated=!0,this.dataMissing=!1,this._unsetUpsampleInfo()}abortRequest(){this.requestAbort=Object(p["a"])(this.requestAbort),this.requestPromise=null}get upsampleInfo(){return this._upsampleInfo}_unsetUpsampleInfo(){this._upsampleInfo&&(this._upsampleInfo.tile.unrefMapData(),this._pool.release(this._upsampleInfo),this._upsampleInfo=null)}setUpsampleInfo(e,t){if(e!==t&&null!=t){if(null==this._upsampleInfo)this._upsampleInfo=this._pool.acquire();else{if(this._upsampleInfo.tile===t)return;this._upsampleInfo.tile.unrefMapData()}t.refMapData(),Object(Vg["d"])(e,t,this._upsampleInfo)}else this._unsetUpsampleInfo()}get data(){return this._data}set data(e){Object(sb["o"])(this._data),this._data=e}}const Fg=new sp["a"](kg,null,()=>{}),zg=new Map;function Ug(){zg.size>0&&(console.log(zg.size+" live TilePerLayerInfo allocations:"),zg.forEach(e=>console.log(e,"\n")))}var Gg=i("d4de"),Bg=i("e746");class Hg{get updating(){return!!this._tileRequested}init(e,t,i,r){this.tile=e,this._layerIdx=t,this._layerClass=i,this._suspended=r,this._tileLayerInfo=e.getLayerInfo(t,i),this._tileRequested=null;const a=this._findAncestorWithData();this._setUpsampleTile(a)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}dataArrived(e){this._setUpsampleTile(e),this._tileRequested=null,e===this.tile?this.tile.updateRenderData(this._layerClass):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;const e=this._findNextDownload();if(this._tileRequested){if(e===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return e?e.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=e):this._agentDone(),!!this._tileRequested}_findNextDownload(){const e=this._layerIdx,t=this._layerClass,i=this.tile.surface.layerViewByIndex(e,t),r=Object(sb["c"])(i),{minLevel:a,maxLevel:n}=i.dataLevelRange,s=this._desiredMinLevelDelta,o=this._loadingLevelDelta+s,c=this._scaleRangeEnabled?Vg["e"]:()=>!0;let l,h=this.tile,d=0;const u=this._tileLayerInfo.upsampleInfo,f=u?u.tile.level:-1,m=Object(p["i"])(r,"tilemapCache");for(;h&&c(h,r,!1)&&h.level>=a;){const i=h.level,r=h.layerInfo[t][e];if(r.data&&d>=s){i>f&&this._setUpsampleTile(h),r.dataInvalidated&&(l=h);break}if((Object(p["j"])(m)||"unavailable"!==m.getAvailability(h.lij[0],h.lij[1],h.lij[2]))&&i<=n&&!r.data&&!r.dataMissing&&((!l||i%Pe["f"]==0||this.tile.level-l.level<s)&&(l=h),d>=o))break;h=h.parent,d++}return l&&this.tile.level-l.level<s&&this._tileLayerInfo.upsampleInfo&&(l=null),l}_findAncestorWithData(){const e=this.tile.vlevel,t=this._desiredMinLevelDelta;let i;for(let r=this.tile;r;r=r.parent)if(r.hasLayerData(this._layerIdx,this._layerClass)){if(e-r.level>=t)return r;i=r}return i}_setUpsampleTile(e){this._tileLayerInfo.setUpsampleInfo(this.tile,e),this.tile.updateRenderData(this._layerClass)}get test(){return{findNextDownload:()=>this._findNextDownload(),tileLayerInfo:this._tileLayerInfo}}}class Ng extends Hg{get _desiredMinLevelDelta(){throw qg}get _loadingLevelDelta(){throw qg}dispose(){}}const qg=new Error("Abstract method called on TileAgent"),Wg=new Ng;class Zg extends Hg{constructor(){super(...arguments),this._scaleRangeEnabled=!1}get _desiredMinLevelDelta(){return Pe["b"]-(this.tile.vlevel-this.tile.lij[0])}get _loadingLevelDelta(){return 0}}var $g=Zg;class Qg extends Hg{constructor(){super(),this._scaleRangeEnabled=!0}get _desiredMinLevelDelta(){return 0}get _loadingLevelDelta(){return 8}}var Xg=Qg;const Yg=sb["r"],Kg=Object(M["e"])(),Jg=Object(M["e"])(),ev=Object(M["e"])(),tv=Object(Lt["c"])(),iv=.1;class rv{constructor(){this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0}}class av{constructor(e){this._numSubdivisionAtLevel=e,this.lij=[0,0,0],this._children=[null,null,null,null],this._dirty=!0,this._previouslyRendered=!1,this.extent=Object(F["l"])(),this._elevationBounds=Object(hi["b"])(),this.layerInfo=[[],[]],this.extentInRadians=Object(F["l"])(),this.centerAtSeaLevel=Object(M["e"])(),this._center=[Object(M["e"])(),Object(md["b"])(),Object(M["e"])()],this.up=Object(M["h"])(),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=hv,this._mapTileMemory=0,this._mapDataRefCount=0,this._screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0}static prune(){ov.prune(0),cv.prune(0),kg.prune()}get usedMemory(){return this._usedMemory===hv&&this._updateMemoryUsed(),this._usedMemory+(this.isCached?0:this.mapTileMemory)}get cachedMemory(){return this.isCached?this.mapTileMemory:0}get mapTileMemory(){this._usedMemory===hv&&this._updateMemoryUsed();let e=this._mapTileMemory;for(const{data:t}of this.layerInfo[1])t instanceof cg["a"]&&(e+=t.getMemoryUsage());return e}get isCached(){return!this.shouldLoad&&this._mapDataRefCount<=0}get maxTesselation(){return this._maxTesselation}get numSubdivisionsAtLevel(){return this._numSubdivisionAtLevel}get isWithinClippingArea(){return this._isWithinClippingArea}get intersectsClippingArea(){return this._intersectsClippingArea}get clippingArea(){return this._clippingArea}get parent(){return this._parent}get children(){return this._children}get surface(){return this._surface}get elevationBounds(){return this._elevationBounds}get level(){return this.lij[0]}get edgeLen(){return this._edgeLen}get radius(){return this._center[1][3]}get screenDepth(){return this._screenDepth}get visible(){if(this._dirty){this._dirty=!1;const e=this._isVisible(this.surface.frustum);e!==this._visible&&(this._visible=e,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setNeedsRender()),this.updateAgentSuspension()}return this._visible}get loadable(){return this.visible||this._surface.view.state.fixedContentCamera}get rendered(){const e=!!this.renderData;return e!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=e,this._surface.renderer.setNeedsRender()),e}get shouldLoad(){if(!this.loadable)return!1;if(1===this._surface.lodSnapping){const e=this.level-this._surface.snapLevel;if(0===e)return!0;if(1===e)return!1}return this.isLeaf}init(e,t,i){this.lij[0]=e[0],this.lij[1]=e[1],this.lij[2]=e[2],this.ellipsoid=Object(V["e"])(i.tilingScheme.spatialReference),i.tilingScheme.getExtent(e[0],e[1],e[2],this.extent),i.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,i.upsampleMapCache.pop(Object(Vg["i"])(this)),this._edgeLen=0,this._edgeLen2=0,this._center[1][3]=0,this.vlevel=e?e[0]:0,t&&t._elevationBounds?Object(di["c"])(this._elevationBounds,t.elevationBounds):Object(di["s"])(this._elevationBounds,0,0),this._pendingUpdates=0,this.renderData=null,this._screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=t,this.unsetChildren(),this._surface=i,this.updateVisibility();for(const r of Pe["g"]){const e=i.numLayers(r),t=this.layerInfo[r];for(const i of t)i.release();t.length=e;for(let i=0;i<e;i++)t[i]=kg.acquire(this._surface.upsampleInfoPool),0===r&&this.findElevationBoundsForLayer(i,-1)}this.computeElevationBounds(),this._maxTesselation=Math.min(i.tilingScheme.pixelSize,Pe["i"])}release(){Yg(!this.renderData,"tile.renderData was not unloaded"),this._surface.upsampleMapCache.pop(Object(Vg["i"])(this));for(const e of Pe["g"]){for(const t of this.layerInfo[e])t.release();this.layerInfo[e].length=0}this._parent=null,this._surface=null,this._usedMemory=hv}refMapData(){++this._mapDataRefCount,this.isCached||this._surface.upsampleMapCache.pop(Object(Vg["i"])(this))}unrefMapData(){if(--this._mapDataRefCount,this.isCached){const e=this.cachedMemory;e>0&&(this._surface.upsampleMapCache.put(Object(Vg["i"])(this),this,e),this.setMemoryDirty())}}setMemoryDirty(){this._usedMemory=hv}get cpuImageMemorySize(){const e=4,t=this._surface.tilingScheme.pixelSize;return t*t*e}_updateMemoryUsed(){this._usedMemory=0,this._mapTileMemory=0;const e=this.cpuImageMemorySize;for(const t of this.layerInfo[1]){const i=t.data;i instanceof Bg["a"]?this._mapTileMemory+=Object(ii["c"])(i.texture):i instanceof HTMLImageElement||i instanceof ib["a"]?this._mapTileMemory+=e:i instanceof Gg["a"]&&(this._mapTileMemory+=i.getMemoryUsage())}for(const t of this.layerInfo[0])this._usedMemory+=t.data?e:0;this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._mapTileMemory+=Object(ii["c"])(this.renderData.textureDescriptor)),this.isCached&&this._surface.upsampleMapCache.updateSize(Object(Vg["i"])(this),this,this.cachedMemory)}getUsedMemoryForLayer(e,t){const i=this.layerInfo[e][t];if(!i||!i.data)return 0;if(1!==e||this.isCached){if(0===e)return this.cpuImageMemorySize}else{const e=i.data;if(e instanceof Bg["a"])return Object(ii["c"])(e.texture);if(e instanceof HTMLImageElement||e instanceof ib["a"])return this.cpuImageMemorySize;if(e instanceof cg["a"]||e instanceof Gg["a"])return e.getMemoryUsage()}return 0}updateScreenDepth(e){Object(It["l"])(tv,this._center[1]),tv[3]=1,Object(ui["m"])(tv,tv,e),this._screenDepth=tv[2]<0?0:tv[2]/tv[3]}shouldSplit(e,t,i){if(Object(p["k"])(e.frustum)&&!this._isVisible(e.frustum))return 0;const r=this.level;Object(It["k"])(Kg,this._center[1],t);let a=Object(It["t"])(Kg),n=1;Object(It["k"])(Jg,this._center[0],t);const s=Object(It["t"])(Jg);s<a&&(a=s,n=0),Object(It["k"])(Jg,this._center[2],t);const o=Object(It["t"])(Jg);if(o<a&&(a=o,n=2),this._edgeLen2>a&&r<e.maxLod)return 2;const c=Math.sqrt(a),l=e.fovX*c*2,h=this._edgeLen/l,d=()=>{const t=r+Math.ceil(-Object(Qe["m"])(e.relativeWidthLimit/h));return t!==this.vlevel?(this.vlevel=t,4):1};if(1===i&&1===this._surface.snapLevel-r)return r>=e.maxLod?d():2;const u=Object(It["i"])(this.up,Kg),f=this._elevationBounds[1]-this._elevationBounds[0],m=f/this.edgeLen;if(e.aboveGround&&u>0&&m<.001&&u/c-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-m>0)return 0;if(h<e.relativeWidthLimit)return this.vlevel!==this.level?(this.vlevel=this.level,4):0;if(r>=e.maxLod)return d();if(r>6){Object(It["k"])(Jg,this._center[n],t),Object(It["f"])(ev,this.up,u),Object(It["k"])(ev,ev,Jg);const i=Object(It["t"])(ev);if(i>this.radius*this.radius){Object(It["f"])(ev,ev,this.radius/Math.sqrt(i)),Object(It["g"])(ev,ev,this._center[n]),Object(It["k"])(ev,t,ev);const r=Math.min(1,(Math.abs(Object(It["i"])(ev,this.up))+.5*f+this._curvatureHeight)/Object(It["q"])(ev)),a=iv/e.angledSplitBias,s=e.fovY*c*2;if(r*(this._edgeLen/s)<a*e.relativeHeightLimit)return 0}}return 2}setChildren(e,t,i,r){Yg(!!(e&&t&&i&&r),"Null child passed"),this._children[0]=e,this._children[1]=t,this._children[2]=i,this._children[3]=r}unsetChildren(){this._children[0]=null,this._children[1]=null,this._children[2]=null,this._children[3]=null}load(e){this.refMapData();for(const t of Pe["g"])this._createOrUpdateAgents(0,t);e.loadTile(this)}unload(e){e.unloadTile(this);for(const t of Pe["g"]){const e=this.layerInfo[t];for(const t of e)t.loadingAgent&&t.loadingAgent!==Wg&&(sv(t.loadingAgent),t.loadingAgent=null),t.pendingUpdates=0}this.resetPendingUpdate(32),this.resetPendingUpdate(64),this.unrefMapData()}unloadMapData(){const e=this.layerInfo[1];for(const t of e)t.loadingAgent&&t.loadingAgent!==Wg&&(sv(t.loadingAgent),t.loadingAgent=null),t.pendingUpdates=0;this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty()}updateClippingStatus(e){if(Object(F["o"])(e,this._clippingArea))return!1;const t=this._intersectsClippingArea,i=this._isWithinClippingArea;Object(p["k"])(e)?(this._intersectsClippingArea=this.intersectsExtent(e),this._isWithinClippingArea=this.isWithinExtent(e)):(this._intersectsClippingArea=!0,this._isWithinClippingArea=!0),this._clippingArea=e,this.updateVisibility();const r=i&&this._isWithinClippingArea,a=!(i||t||this._isWithinClippingArea||this._intersectsClippingArea);return!this.renderData||r||a||this.setPendingUpdate(32),!0}updateVisibility(){this._dirty=!0,this._surface.setTileTreeDirty()}getLayerInfo(e,t){return this.layerInfo[t][e]}hasLayerData(e,t){const i=this.layerInfo[t][e];return!(!i||!i.data||i.dataInvalidated)}get updating(){if(this.hasPendingUpdates)return!0;for(const e of Pe["g"]){const t=this.layerInfo[e];for(const e of t)if(e.loadingAgent&&e.loadingAgent!==Wg&&e.loadingAgent.updating)return!0}return!1}isSuspended(e){return!!this.hasPendingUpdate(2)||0!==e&&!this.loadable}get hasPendingUpdates(){return 0!==this._pendingUpdates}hasPendingUpdate(e){return(this._pendingUpdates&e)===e}setPendingUpdate(e){this._pendingUpdates|=e,2===e||8===e?this._surface.setTileTreeDirty():this._surface.pendingUpdates=!0}resetPendingUpdate(e){return!!this.hasPendingUpdate(e)&&(this._pendingUpdates&=~e,!0)}requestLayerData(e,t,i){const r=this.layerInfo[t][e];if(r.waitingAgents.has(i))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),i.tile.lij.toString(),t,e),!0;if(r.waitingAgents.push(i),r.data&&!r.dataInvalidated)return console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),i.tile.lij.toString(),t,e),i.dataArrived(this),!0;if(r.requestPromise)return!0;Object(p["a"])(r.requestAbort),r.requestAbort=Object(j["e"])();const a=this._surface.requestTileData(this,e,t,r.requestAbort);if(!a)return r.requestAbort=null,!1;const n=()=>{r.requestPromise===a&&(r.requestPromise=null,r.requestAbort=null)};return r.requestPromise=a,a.then(n,n),!0}get isLeaf(){return null==this._children[0]}hasLij(e){return this.lij[0]===e[0]&&this.lij[1]===e[1]&&this.lij[2]===e[2]}findByLij(e){if(this.hasLij(e))return this;if(this.isLeaf)return null;const t=this._children[0].findByLij(e)||this._children[1].findByLij(e)||this._children[2].findByLij(e)||this._children[3].findByLij(e);return t||null}distanceToSquared(e){return Object(It["t"])(Object(It["k"])(ev,this._center[1],e))}containsPoint(e){const t=this.extent;return e[0]>=t[0]&&e[1]>=t[1]&&e[0]<=t[2]&&e[1]<=t[3]}unrequestLayerData(e,t,i){const r=this.layerInfo[t][e],a=r.waitingAgents,n=null!=a.removeUnordered(i);Yg(n,"agent has not requested this piece of map data"),a.length<1&&(r.abortRequest(),this._updateMemoryUsed())}dataArrived(e,t,i){const r=this.layerInfo[t][e];r.data=i,r.dataInvalidated=!1,r.waitingAgents.forAll(e=>e.dataArrived(this)),r.waitingAgents.clear(),this._updateMemoryUsed()}dataMissing(e,t,i){i.notInTilemap||console.error(`Tile ${this.lij.toString()} layer ${t}/${e} error ${i}`);const r=this.layerInfo[t][e];r.dataMissing=!0,r.waitingAgents.forAll(e=>e.dataMissing()),r.waitingAgents.clear(),this._updateMemoryUsed()}updateRenderData(e){switch(e){case 1:return this.updateTexture();case 0:return this.updateGeometry()}}updateTexture(){this.renderData&&this.setPendingUpdate(64)}updateGeometry(){this.setPendingUpdate(32);for(const e of this.layerInfo[0])e.pendingUpdates|=32}invalidateLayerData(e,t){this.layerInfo[t][e].invalidateSourceData(),this.restartAgents(t)}computeElevationBounds(){Object(di["s"])(this._elevationBounds,Number.MAX_VALUE,-Number.MAX_VALUE);const e=this.layerInfo[0];let t=!0;for(const i of e)Object(p["k"])(i.elevationBounds)&&(this._elevationBounds[0]=Math.min(this._elevationBounds[0],i.elevationBounds.min),this._elevationBounds[1]=Math.max(this._elevationBounds[1],i.elevationBounds.max),i.elevationBounds.hasNoDataValues||(t=!1));t&&(this._elevationBounds[0]=Math.min(this._elevationBounds[0],0),this._elevationBounds[1]=Math.max(this._elevationBounds[1],0)),this.updateRadiusAndCenter(),this._surface.setTileTreeDirty()}_updateCenter(){const e=.5*(this._elevationBounds[0]+this._elevationBounds[1]);Object(It["f"])(ev,this.up,e),Object(It["g"])(this._center[1],this.centerAtSeaLevel,ev),Object(It["f"])(ev,this.up,this._elevationBounds[0]),Object(It["g"])(this._center[0],this.centerAtSeaLevel,ev),Object(It["f"])(ev,this.up,this._elevationBounds[1]),Object(It["g"])(this._center[2],this.centerAtSeaLevel,ev)}findElevationBoundsForLayer(e,t){const i=this.layerInfo[0][e];if(Object(p["j"])(i.elevationBounds)||i.elevationBounds.level<t){const t=this._surface.layerViewByIndex(e,0),r=Object(sb["c"])(t);if(Object(Vg["e"])(this,r,!1)){const t=lv;let r=!1;if(i.data){const e=i.data;t.min=e.bounds[0],t.max=e.bounds[1],t.hasNoDataValues=e.hasNoDataValues,t.level=this.lij[0],r=!0}else{let i,a,n=0;for(let t=this._parent;t&&(!a||n<Pe["b"])&&(n=this.vlevel-t.level,i=a||i,a=t.layerInfo[0][e].data,!(!a&&i&&n>=Pe["b"]));t=t._parent);a=a||i,a&&(a.computeMinMaxValue(this.lij[0],this.lij[1],this.lij[2],t),t.min!==1/0&&(t.level=a.level,r=!0))}r&&(Object(p["j"])(i.elevationBounds)&&(i.elevationBounds=new dg),i.elevationBounds.copyFrom(t))}}}modifyLayers(e,t,i){const r=this.layerInfo[i];for(const s of r)s.loadingAgent&&s.loadingAgent!==Wg&&(sv(s.loadingAgent),s.loadingAgent=null),s.waitingAgents.clear();for(let s=0;s<r.length;++s)void 0===e[s]&&r[s].release();const a=new Array(...r),n=t.length;r.length=n;for(let s=0;s<n;s++){const e=t[s];r[s]=e>-1?a[e]:kg.acquire(this._surface.upsampleInfoPool)}this._updateMemoryUsed()}restartAgents(e){this.renderData&&(this._createOrUpdateAgents(0,e),this.updateRenderData(e))}updateAgents(e){if(this.renderData){const t=this.layerInfo[e];for(const e of t)e.loadingAgent===Wg&&(e.loadingAgent=null);this._createOrUpdateAgents(0,e)}}updateAgentSuspension(){for(const e of Pe["g"]){const t=this.isSuspended(e);for(const i of this.layerInfo[e])i.loadingAgent&&i.loadingAgent!==Wg&&(i.loadingAgent.setSuspension(t),i.loadingAgent===Wg&&this.updateRenderData(e))}}removeLayerAgent(e,t){const i=this.layerInfo[t][e];i.loadingAgent&&i.loadingAgent!==Wg&&i.loadingAgent.dispose(),i.loadingAgent=null}agentDone(e,t){const i=this.layerInfo[t][e];i.loadingAgent=Wg,i.data||i.upsampleInfo||this._createOrUpdateAgents(e+1,t)}_createOrUpdateAgents(e,t){const i=this.isSuspended(t),r=this.layerInfo[t];for(let a=e;a<r.length;++a){const e=r[a];let n=!1;const s=this._surface.layerViewByIndex(a,t),o=Object(sb["c"])(s);if(e.loadingAgent?Object(Vg["e"])(this,o,!1)?(e.loadingAgent!==Wg&&e.loadingAgent.setSuspension(i),e.loadingAgent!==Wg&&(n=e.loadingAgent.update())):e.dispose():Object(Vg["e"])(this,o,!1)&&(e.loadingAgent=nv(this,a,t,i),n=e.loadingAgent.startLoading(),n?e.loadingAgent===Wg&&this.setPendingUpdate(32):(sv(e.loadingAgent),e.loadingAgent=Wg)),e.loadingAgent===Wg&&this.updateRenderData(t),n&&s.isOpaque)return}}isWithinExtent(e){const t=this.extent;return t[0]>=e[0]&&e[2]>=t[2]&&t[1]>=e[1]&&e[3]>=t[3]}intersectsExtent(e){const t=this.extent;return t[2]>=e[0]&&e[2]>=t[0]&&t[3]>=e[1]&&e[3]>=t[1]}get test(){return{cachedMemory:this.cachedMemory}}}function nv(e,t,i,r){const a=0===i?cv.acquire():ov.acquire();return a.init(e,t,i,r),a}function sv(e){e.dispose(),e instanceof $g?cv.release(e):e instanceof Xg&&ov.release(e)}const ov=new sp["a"](Xg),cv=new sp["a"]($g),lv=new dg,hv=-1;var dv=av,uv=i("7c51");class pv{constructor(e,t){this._factoryCallback=e,this._lengthCallback=t,this._pool=new Map}acquire(e){if(!pv.test.disabled){const t=this._pool.get(e);if(t&&0!==t.length)return t.pop()}try{return this._factoryCallback(e)}catch(t){const i=window.performance&&window.performance.memory;let r="";throw i&&(r=`\n  totalJSHeapSize: ${i.totalJSHeapSize}, usedJSHeapSize: ${i.usedJSHeapSize}, jsHeapSizeLimit: ${i.jsHeapSizeLimit}`),console.log("Array allocation of size "+e+" failed: "+t+r),t}}release(e){if(pv.test.disabled)return;const t=this._lengthCallback(e);let i=this._pool.get(t);i||(i=new fd["a"]({shrink:!0}),this._pool.set(t,i)),i.push(e)}clear(){this._pool.clear()}get test(){return{size:this._pool.size}}}pv.test={disabled:!1};const fv=Object(Yt["a"])().vec3f("position").vec2f("uv0"),mv=new pv(e=>fv.createBuffer(e),e=>e.count);class bv{constructor(){this.indices=null,this.vertexAttributes=null,this.boundingBox=Object(bu["k"])(),this.numSurfaceIndices=0,this.numSkirtIndices=0,this.numWithoutSkirtIndices=0,this.numVertsPerRow=0,this.skirtLength=0,this.uvOffsetAndScale=Object(Lt["c"])()}}class gv{constructor(e,t,i){this.values=e,this.numSurfaceIndices=t,this.numSkirtIndices=i}}function vv(){mv.clear(),jv.clear()}function yv(e){mv.release(e.vertexAttributes),e.vertexAttributes=null,e.indices=null}const Ov=65536;function _v(e,t,i,r,a,n,s,o){const c=a[0],l=a[1],h=a[2],d=a[3],u=.1*s.radius*(d-l),p=e.numVertsPerRow-1,f=e.numVertsPerRow-1,m=e.numVertsPerRow*e.numVertsPerRow,b=2*p+2*f,g=mv.acquire(m+b),v=g.position.typedBuffer,y=g.uv0.typedBuffer,O=r.geometryInfo.boundingBox;Object(bu["k"])(O);const _=t[2]-t[0],x=t[3]-t[1],j=h-c,w=i[0],S=i[1],C=i[2];for(let R=0;R<=p;R++){const e=R/p,i=c+e*j;Mv[R]=Math.sin(i),Ev[R]=Math.cos(i),Dv[R]=e,Iv[R]=t[0]+e*_}const T=n&&!!(1&o),P=n&&!!(2&o);let A=0;for(let R=0;R<=f;R++){let i=R/f;const r=Object(Qe["l"])(l,d,i),a=Math.cos(r),o=Math.sin(r);let c;n?(c=s.halfSemiMajorAxis*Math.log((1+o)/(1-o)),i=(c-t[1])/x):c=180*r/Math.PI;for(let t=0;t<=p;t++){const r=Dv[t],n=Mv[t],l=Ev[t];let h=s.radius;e.samplerData&&(h+=ug.sample(Iv[t],c,e.samplerData)||0);const d=l*a*h-w,b=n*a*h-S,g=o*h-C;Cv(d,b,g,O);const _=Pe["e"]*A;v[_+0]=d,v[_+1]=b,v[_+2]=g,y[_+0]=r,y[_+1]=i;const x=Pv(t,R,p,f);if(x>-1){const e=Pe["e"]*(m+x),t=T&&0===R?-1:P&&R===f?1:0,a=0===t?d:-w,n=0===t?b:-S,o=0===t?g:s.radius*t-C;v[e+0]=a,v[e+1]=n,v[e+2]=o,y[e+0]=0===t?Tv(r,i):r,y[e+1]=0===t?u:i,0!==t&&Cv(a,n,o,O)}++A}}r.geometryInfo.numVertsPerRow=e.numVertsPerRow,r.geometryInfo.vertexAttributes=g,r.geometryInfo.skirtLength=u,Object(ui["l"])(r.geometryInfo.uvOffsetAndScale,0,0,1,1),wv(r.geometryInfo,e.numVertsPerRow,n?o:0,e.wireframe)}function xv(e,t,i,r){const a=t[0],n=t[1],s=t[2]-a,o=t[3]-n,c=e.clippingArea,l=Object(p["k"])(c)?Math.max(0,(c[0]-t[0])/s):0,h=Object(p["k"])(c)?Math.max(0,(c[1]-t[1])/o):0,d=Object(p["k"])(c)?Math.min(1,(c[2]-t[0])/s):1,u=Object(p["k"])(c)?Math.min(1,(c[3]-t[1])/o):1,f=d>l?1/(d-l):1,m=u>h?1/(u-h):1,b=-l*f,g=-h*m,v=.1*s,y=e.numVertsPerRow-1,O=e.numVertsPerRow-1,_=e.numVertsPerRow*e.numVertsPerRow,x=2*y+2*O,j=mv.acquire(_+x),w=j.position.typedBuffer,S=j.uv0.typedBuffer,C=r.geometryInfo.boundingBox;Object(bu["k"])(C);let T=0;for(let P=0;P<=O;P++){const t=P/O;let r=g+t*m,l=n+t*o;Object(p["k"])(c)&&(l<c[1]?(l=c[1],r=0):l>c[3]&&(l=c[3],r=1));for(let n=0;n<=y;n++){const t=n/y;let o=b+t*f,h=a+t*s;Object(p["k"])(c)&&(h<c[0]?(h=c[0],o=0):h>c[2]&&(h=c[2],o=1));const d=e.samplerData&&ug.sample(h,l,e.samplerData)||0,u=h-i[0],m=l-i[1],g=d-i[2];Cv(u,m,g,C);const O=Pe["e"]*T;w[O+0]=u,w[O+1]=m,w[O+2]=g,S[O+0]=o,S[O+1]=r;const x=Pv(n,P,y,y);if(x>-1){const e=Pe["e"]*(_+x);w[e+0]=u,w[e+1]=m,w[e+2]=g,S[e+0]=Tv(o,r),S[e+1]=v}++T}}r.geometryInfo.numVertsPerRow=e.numVertsPerRow,r.geometryInfo.vertexAttributes=j,r.geometryInfo.skirtLength=v,Object(ui["l"])(r.geometryInfo.uvOffsetAndScale,l,h,d-l,u-h),wv(r.geometryInfo,e.numVertsPerRow,0,e.wireframe)}const jv=new Map;function wv(e,t,i,r){const a=(2&i)>0,n=t+(r?1024:0)+(a?2048:0);let s=jv.get(n);s||(s=Sv(t,a,r),jv.set(n,s)),e.indices=s.values,e.numSurfaceIndices=s.numSurfaceIndices,e.numSkirtIndices=s.numSkirtIndices,e.numWithoutSkirtIndices=e.numSurfaceIndices+(i?6*(t-1)*(r?2:1):0)}function Sv(e,t,i){const r=e-1,a=e-1,n=e*e,s=2*r+2*a;let o=r*a*2*3,c=6*s,l=6*(2*r+a-1);i&&(o*=2,c*=2,l*=2);const h=n+s>Ov?new Uint32Array(o+c):new Uint16Array(o+c);let d,u,p,f,m=0,b=0,g=o,v=0;for(let y=0;y<=a;y++){t&&(v=0===y?l:y===a?-l:0),g+=v;for(let e=0;e<=r;e++){const t=Pv(e,y,r,a);if(t>-1){const s=Av(e,y,r,a);0!==s&&(d=m,u=n+t,p=n+(0===e&&1===y?0:t+1),f=m+s,i?(h[g+0]=d,h[g+1]=u,h[g+2]=u,h[g+3]=p,h[g+4]=p,h[g+5]=d,h[g+6]=p,h[g+7]=f,h[g+8]=f,h[g+9]=d,h[g+10]=d,h[g+11]=p,g+=12):(h[g+0]=d,h[g+1]=u,h[g+2]=p,h[g+3]=p,h[g+4]=f,h[g+5]=d,g+=6))}++m,e<r&&y<a&&(d=y*(r+1)+e,u=d+1,p=u+(r+1),f=p-1,i?(h[b+0]=d,h[b+1]=u,h[b+2]=u,h[b+3]=p,h[b+4]=p,h[b+5]=d,h[b+6]=p,h[b+7]=f,h[b+8]=f,h[b+9]=d,h[b+10]=d,h[b+11]=p,b+=12):(h[b+0]=d,h[b+1]=u,h[b+2]=p,h[b+3]=p,h[b+4]=f,h[b+5]=d,b+=6))}g-=v}return new gv(h,o,c)}function Cv(e,t,i,r){e<r[0]&&(r[0]=e),e>r[3]&&(r[3]=e),t<r[1]&&(r[1]=t),t>r[4]&&(r[4]=t),i<r[2]&&(r[2]=i),i>r[5]&&(r[5]=i)}function Tv(e,t){const i=t>e?1:0;return 2+4*i+(1-2*i)*(e+t)}function Pv(e,t,i,r){return 0===t?e:e===i?i+t:t===r?i+r+(i-e):0===e&&t>0?2*i+r+(r-t):-1}function Av(e,t,i,r){return 0===t&&e!==i?1:e===i&&t!==r?i+1:t===r&&0!==e?-1:0===e&&0!==t?-(i+1):0}function Rv(e,t,i,r,a,n,s,o,c){const l=n.position,h=n.uv0,d=e[0],u=e[1],f=e[2],m=t[0]-d,b=t[1]-u,g=t[2]-f;r*=3;for(let v=i*=3;v<r;v+=3){const e=a[v],t=a[v+1],i=a[v+2];let r=l.get(e,0),n=l.get(e,1),y=l.get(e,2),O=l.get(t,0),_=l.get(t,1),x=l.get(t,2),j=l.get(i,0),w=l.get(i,1),S=l.get(i,2);h.get(e,0)>=2&&(Object(It["x"])(Lv,r,n,y),s(Lv),r+=Lv[0],n+=Lv[1],y+=Lv[2]),h.get(t,0)>=2&&(Object(It["x"])(Lv,O,_,x),s(Lv),O+=Lv[0],_+=Lv[1],x+=Lv[2]),h.get(i,0)>=2&&(Object(It["x"])(Lv,j,w,S),s(Lv),j+=Lv[0],w+=Lv[1],S+=Lv[2]),Object(p["k"])(o)&&([r,n,y]=o.applyToVertex(r,n,y),[O,_,x]=o.applyToVertex(O,_,x),[j,w,S]=o.applyToVertex(j,w,S));const C=O-r,T=_-n,P=x-y,A=j-r,R=w-n,M=S-y,E=b*M-R*g,D=g*A-M*m,I=m*R-A*b,L=C*E+T*D+P*I;if(Math.abs(L)<=Number.EPSILON)continue;const V=d-r,k=u-n,F=f-y,z=V*E+k*D+F*I;if(L>0){if(z<0||z>L)continue}else if(z>0||z<L)continue;const U=k*P-T*F,G=F*C-P*V,B=V*T-C*k,H=m*U+b*G+g*B;if(L>0){if(H<0||z+H>L)continue}else if(H>0||z+H<L)continue;const N=(A*U+R*G+M*B)/L;N>=0&&c(N,Object(uv["d"])(C,T,P,A,R,M,Vv))}}const Mv=new Array(Pe["i"]+1),Ev=new Array(Pe["i"]+1),Dv=new Array(Pe["i"]+1),Iv=new Array(Pe["i"]+1),Lv=Object(M["e"])(),Vv=Object(M["e"])();class kv extends dv{constructor(e,t,i){super(kv.NumSubdivisionsAtLevel),void 0!==e&&this.init(e,t,i)}init(e,t,i){super.init(e,t,i),this._edgeLen=this.extent[2]-this.extent[0],this._edgeLen2=this._edgeLen*this._edgeLen,this.centerAtSeaLevel[0]=Object(Qe["l"])(this.extent[0],this.extent[2],.5),this.centerAtSeaLevel[1]=Object(Qe["l"])(this.extent[1],this.extent[3],.5),this.centerAtSeaLevel[2]=0,this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateCenter();const e=(this.extent[2]-this.extent[0])*Math.SQRT1_2,t=.5*(this.elevationBounds[0]-this.elevationBounds[1]);this._center[1][3]=Math.sqrt(e*e+t*t)}_isVisible(e){return this.intersectsClippingArea&&Object(op["j"])(e,Object(bu["I"])(this.extent[0],this.extent[1],this.elevationBounds[0],this.extent[2],this.extent[3],this.elevationBounds[1]))}createGeometry(e,t){xv(e,this.extent,t,this.renderData),this.setMemoryDirty()}}kv.NumSubdivisionsAtLevel=[2,2,2,2,2,2,2,2];var Fv=i("70ab");class zv extends dv{constructor(e,t,i){super(Uv),this.obb=new Array(8),this.isWebMercator=!1;for(let r=0;r<8;r++)this.obb[r]=Object(M["e"])();void 0!==e&&this.init(e,t,i)}init(e,t,i){super.init(e,t,i),this.isWebMercator=i.tilingScheme.spatialReference.isWebMercator;const r=this.ellipsoid.radius,a=this.extentInRadians[0],n=this.extentInRadians[1],s=this.extentInRadians[2],o=this.extentInRadians[3],c=e[0],l=Object(Qe["l"])(n,o,.5),h=Object(Qe["l"])(a,s,.5),d=0===c?0:Math.min(Math.abs(n),Math.abs(o));this._edgeLen=(s-a)*Math.cos(d)*r,this._edgeLen2=this._edgeLen*this._edgeLen,this._curvatureHeight=r-Math.sqrt(r*r-this._edgeLen2/4),Object(z["l"])(this.centerAtSeaLevel,h,l,this.ellipsoid.radius,0);const u=Object(M["f"])(this.centerAtSeaLevel);Object(It["s"])(u,u),this.up=u,this._updateOBB(),this.updateRadiusAndCenter()}updateRadiusAndCenter(){if(0===this.lij[0])Object(It["x"])(this._center[1],0,0,0),Object(It["x"])(this._center[0],0,0,0),Object(It["x"])(this._center[2],0,0,0),this.ellipsoid||(this.ellipsoid=Object(V["e"])(this.surface.tilingScheme.spatialReference)),this._center[1][3]=this.ellipsoid.radius+this.elevationBounds[1];else{this._updateCenter();const e=Math.max(Object(It["m"])(this._center[1],this.obb[0]),Object(It["m"])(this._center[1],this.obb[1]));this._center[1][3]=Math.sqrt(e)}}_isVisible(e){if(!this.intersectsClippingArea)return!1;if(this.lij[0]<10)return Object(op["i"])(e,this._center[1]);const t=this.obb;for(let i=0;i<6;i++){let r,a=e[i];for(4===i&&(a=Object(Fv["a"])(a,Gv),Gv[3]-=this.surface.view.state.camera.near),r=0;r<8&&!Object(Fv["r"])(a,t[r]);r++);if(8===r)return!1}return!0}computeElevationBounds(){super.computeElevationBounds(),this._updateOBB()}createGeometry(e,t){const i=this._isPole(this.lij[1],this.lij[0]);_v(e,this.extent,t,this.renderData,this.extentInRadians,this.isWebMercator,this.ellipsoid,i),this.setMemoryDirty()}_updateOBB(){const e=this.extentInRadians,t=this.obb;for(let i=0;i<2;i++){const r=this.elevationBounds[i];let a=4*i;Object(z["l"])(t[a++],e[0],e[1],this.ellipsoid.radius,r),Object(z["l"])(t[a++],e[0],e[3],this.ellipsoid.radius,r),Object(z["l"])(t[a++],e[2],e[3],this.ellipsoid.radius,r),Object(z["l"])(t[a++],e[2],e[1],this.ellipsoid.radius,r)}if(this.isWebMercator){const e=this._isPole(this.lij[1],this.lij[0]);2===e?(Object(It["x"])(t[1],0,0,this.ellipsoid.radius),Object(It["x"])(t[2],0,0,this.ellipsoid.radius),Object(It["x"])(t[5],0,0,this.ellipsoid.radius),Object(It["x"])(t[6],0,0,this.ellipsoid.radius)):1===e&&(Object(It["x"])(t[0],0,0,-this.ellipsoid.radius),Object(It["x"])(t[3],0,0,-this.ellipsoid.radius),Object(It["x"])(t[4],0,0,-this.ellipsoid.radius),Object(It["x"])(t[7],0,0,-this.ellipsoid.radius))}}_isPole(e,t){let i=0;return e===(1<<t)-1&&(i+=1),0===e&&(i+=2),i}}const Uv=[128,64,32,16,16,8,8,4],Gv=Object(Fv["c"])();let Bv=class extends je["a"]{constructor(e){super(e),this._handles=new we["a"]}initialize(){this._handles.add([this.layerViews.on("change",()=>this.notifyChange("stencilEnabledExtents"))])}destroy(){this._handles.destroy(),this._handles=null}get layerViewsExtent(){return this._computeLayerViewsExtent()}get tiledLayersExtent(){return this._computeTiledLayersExtent()}get stencilEnabledExtents(){return this._computeStencilEnabledExtents()}set spatialReference(e){this.tilingScheme||this._set("spatialReference",e)}set tilingScheme(e){this._set("tilingScheme",e),this._set("spatialReference",e.spatialReference)}_computeStencilEnabledExtents(){const e=[];return this.layerViews.forEach(t=>{const i=t.layer;if("IntegratedMeshLayer"===i.operationalLayerType&&null!=this.spatialReference){const t=Wv(i.fullExtent,this.spatialReference);null!=t&&e.push(Object(F["s"])(t))}}),e}};function Hv(e,t){return"spherical"===e?new Nv(t):new qv(t)}Object(d["a"])([Object(g["b"])({readOnly:!0,dependsOn:[]})],Bv.prototype,"layerViewsExtent",null),Object(d["a"])([Object(g["b"])({readOnly:!0,dependsOn:["spatialReference","tilingScheme"]})],Bv.prototype,"tiledLayersExtent",null),Object(d["a"])([Object(g["b"])({readOnly:!0,dependsOn:["spatialReference"]})],Bv.prototype,"stencilEnabledExtents",null),Object(d["a"])([Object(g["b"])()],Bv.prototype,"spatialReference",null),Object(d["a"])([Object(g["b"])()],Bv.prototype,"tilingScheme",null),Object(d["a"])([Object(g["b"])()],Bv.prototype,"defaultTiledLayersExtent",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],Bv.prototype,"layers",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],Bv.prototype,"layerViews",void 0),Bv=Object(d["a"])([Object(y["a"])("esri.views.3d.terrain.SurfaceExtentHelperBase")],Bv);let Nv=class extends Bv{_computeLayerViewsExtent(){return this._getGlobalExtent()}_computeTiledLayersExtent(){return this._getGlobalExtent()}_getGlobalExtent(){return this.spatialReference.isWebMercator?Pe["m"]:Pe["d"]}};Object(d["a"])([Object(g["b"])({dependsOn:["spatialReference"]})],Nv.prototype,"layerViewsExtent",void 0),Nv=Object(d["a"])([Object(y["a"])("esri.views.3d.terrain.SurfaceExtentHelperGlobal")],Nv);let qv=class extends Bv{initialize(){this._handles.add([this.layers.on("change",e=>this._handleLayersChanged(e)),this.layerViews.on("change",()=>this.notifyChange("layerViewsExtent"))])}_handleLayersChanged(e){for(const t of e.removed)this._handles.remove(t.uid);for(const t of e.added)this._handles.add(Object(L["a"])(t,"loaded",()=>this.notifyChange("tiledLayersExtent")),t.uid)}_computeLayerViewsExtent(){const e=Object(F["n"])(),t=this.spatialReference;this.layerViews.forEach(i=>{const r=i.layer;if(i.isResolved()&&("graphics"!==r.type||!r.internal)){const r=Wv("fullExtentInLocalViewSpatialReference"in i&&i.fullExtentInLocalViewSpatialReference||i.layer.fullExtent,t);r&&Object(F["p"])(e,r)}});const i=Object(F["c"])(e)?e:null,r=this._get("layerViewsExtent");return Object(F["o"])(i,r)?r:i}_computeTiledLayersExtent(){const e=this.tilingScheme;if(!e)return null;const t=this.spatialReference,i=Object(F["n"])();this.layers.forEach((function(r){if(r.loaded&&Object(ve["c"])(r)){const{tileInfo:a,fullExtent:n}=Object(sb["d"])(r,t,2);(a&&Object(sb["h"])(r)&&n||a&&e.compatibleWith(a)&&n&&n.spatialReference.equals(t))&&Object(F["p"])(i,n)}})),this.defaultTiledLayersExtent&&Object(F["p"])(i,this.defaultTiledLayersExtent);const r=Object(F["c"])(i)?i:null,a=this._get("tiledLayersExtent");return Object(F["o"])(r,a)?a:r}};function Wv(e,t){return e&&!e.spatialReference.equals(t)&&(e=Object(S["a"])(e.spatialReference,t)?Object(S["d"])(e,t):null),e}qv=Object(d["a"])([Object(y["a"])("esri.views.3d.terrain.SurfaceExtentHelperLocal")],qv);var Zv=i("ee83");let $v=class extends je["a"]{constructor(e){super(e),this._changeHandles=new we["a"]}initialize(){this._changeHandles.add(this.layers.on("change",()=>this._update())),this._changeHandles.add(this.extentHelper.watch("layerViewsExtent",()=>this._setAdHocTilingScheme())),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}destroy(){this._changeHandles.destroy(),this._changeHandles=null,this._waitTask=null}_update(){if(this._waitTask=null,this.tilingSchemeLocked)return;let e;if(this._set("tilingSchemeDone",!1),this.layers.some(t=>!(!Object(ve["c"])(t)||t.isRejected())&&!(t.isFulfilled()&&!Qv(t,this.viewSpatialReference,this.manifold))&&(e=t,"vector-tile"!==t.type&&!Object(sb["h"])(t))),e)if(e.isResolved()){const t=e,{tileInfo:i}=Object(sb["d"])(t,this.viewSpatialReference,this.manifold),r=new Zv["a"](i);this._set("tilingSchemeDone",!0),this._lockTilingScheme(r)}else this._updateWhen(e);else this._set("tilingSchemeDone",!0)}_updateWhen(e){const t=e.when().catch(e=>e).then(()=>{t!==this._waitTask||this.destroyed||this._update()});this._waitTask=t}_lockTilingScheme(e){if("spherical"===this.manifold){const t=e.levels.length-1;e.spatialReference.isWebMercator?e=Zv["a"].makeWebMercatorAuxiliarySphere(t):Object(z["a"])(e.spatialReference)&&(e=Zv["a"].makeGCSWithTileSize(e.spatialReference,e.pixelSize,t))}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this._changeHandles.removeAll(),this._changeHandles.add(this.extentHelper.watch("tiledLayersExtent",()=>this._updateTiledLayerExtent()))}_updateTiledLayerExtent(){this.extent=this.extentHelper.tiledLayersExtent}_setAdHocTilingScheme(){if("spherical"===this.manifold){const e=this.extentHelper.spatialReference,t=Object(z["a"])(e)||Object(Dt["h"])(e)||Object(Dt["i"])(e);e.isWebMercator?this.tilingScheme=Zv["a"].WebMercatorAuxiliarySphere:t&&(this.tilingScheme=Zv["a"].makeGCSWithTileSize(e,256)),this.extent=this.extentHelper.layerViewsExtent}else{const e=this.extentHelper.layerViewsExtent;e&&(this.tilingScheme=Zv["a"].fromExtent(e,this.extentHelper.spatialReference),this.extent=e)}}};function Qv(e,t,i){return!!Object(sb["d"])(e,t,i).tileInfo}Object(d["a"])([Object(g["b"])()],$v.prototype,"tilingScheme",void 0),Object(d["a"])([Object(g["b"])()],$v.prototype,"extent",void 0),Object(d["a"])([Object(g["b"])({value:!1})],$v.prototype,"tilingSchemeLocked",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0,value:!1})],$v.prototype,"tilingSchemeDone",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],$v.prototype,"viewSpatialReference",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],$v.prototype,"layers",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],$v.prototype,"extentHelper",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],$v.prototype,"manifold",void 0),$v=Object(d["a"])([Object(y["a"])("esri.views.3d.terrain.SurfaceTilingSchemeLogic")],$v);var Xv=$v,Yv=Xv,Kv=i("55e6"),Jv=i("d272"),ey=i("df77");class ty{constructor(e){this._getFadeDuration=e,this._fadeStart=0,this._delayedTime=0}clear(){this._current=Object(p["e"])(this._current),this._next=Object(p["e"])(this._next),this._waiting=Object(p["e"])(this._waiting),this._delayed=Object(p["e"])(this._delayed)}get current(){if(Object(p["j"])(this._current))return null;if(!this._isFading){const e=this._delayed||this._waiting||this._next||this._current;e!==this._current&&(this._current=null,this.clear(),this._current=e)}let e=0;if(Object(p["k"])(this._delayed)&&(e=performance.now(),e>=this._delayedTime&&(this._push(this._delayed,0),this._delayed=null)),Object(p["k"])(this._next)){e=e||performance.now();const t=this._fadeDuration;e-this._fadeStart>=t&&(Object(p["e"])(this._current),this._current=this._next,this._next=this._waiting,this._waiting=null,this._fadeStart=e)}return this._current}get next(){return this._next}get fadeFactor(){if(Object(p["j"])(this._next))return 1;const e=performance.now()-this._fadeStart,t=this._fadeDuration;return e>t?0:1-e/t}get isFading(){return Object(p["k"])(this._next)||Object(p["k"])(this._delayed)}push(e,t,i,r,a=0){this._delayed=Object(p["e"])(this._delayed);const n=Object(p["k"])(e)?new iy(e,t,i,r):null;this._push(n,a)}_push(e,t){if(this._isFading||this.clear(),Object(p["j"])(this._current))return void(this._current=e);const i=performance.now();return 0!==t?(this._delayed=e,void(this._delayedTime=i+t)):Object(p["j"])(this._next)?(this._next=e,void(this._fadeStart=i)):void(Object(p["j"])(e)||(Object(p["e"])(this._waiting),this._waiting=e))}get _fadeDuration(){return Object(p["j"])(this._waiting)?this._getFadeDuration():.5*this._getFadeDuration()}get _isFading(){return this._getFadeDuration()>0}}class iy{constructor(e,t,i,r){this.texture=e,e.retain(),this.offsetAndScale=Object(Lt["d"])(t,i,r,r)}destroy(){this.texture.release()}}var ry=ty;class ay{constructor(){this._scales=[-1,-1,-1,-1],this._offsets=[-1,-1,-1,-1]}clear(){this._scales[0]=this._scales[1]=this._scales[2]=this._scales[3]=-1,this._offsets[0]=this._offsets[1]=this._offsets[2]=this._offsets[3]=-1}setScale(e,t,i){this._scales[2*e]=t,this._scales[2*e+1]=i}setOffset(e,t,i){this._offsets[2*e]=t,this._offsets[2*e+1]=i}get scales(){return this._scales}get offsets(){return this._offsets}}var ny=ay;class sy{constructor(){this.geometryInfo=new bv,this._textureRef=new ry(()=>this.tile.surface.textureFadeDuration),this.overlay=new ny}init(e){this.tile=e,this.clear();const t=this.geometryInfo;t.indices=null,t.vertexAttributes=null,Object(bu["k"])(t.boundingBox),t.numSurfaceIndices=0,t.numSkirtIndices=0,t.numWithoutSkirtIndices=0,t.numVertsPerRow=0,this.geometryState={numVertsPerRow:0,samplerData:null,clippingArea:null,wireframe:!1},this.opacity=1,this.localOrigin=null,this.overlay.clear()}clear(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear()}updateGeometry(e,t){return!!this._updateGeometryState(t)&&(this._releaseGeometry(),this._createGeometry(e),!0)}releaseGeometry(){return!!this._releaseGeometry()&&(this.geometryState={numVertsPerRow:0,samplerData:null,clippingArea:null,wireframe:!1},!0)}ensureTexture(e,t){return Object(p["k"])(this._texture)&&this._texture.descriptor.width!==e&&this.releaseTexture(),this._texture||(this._texture=t(),this.tile.setMemoryDirty()),this._texture}releaseTexture(){Object(p["k"])(this._texture)&&(this._texture.release(),this._texture=null,this.tile.setMemoryDirty())}_updateGeometryState(e){const t=this._getElevationInfo(),i=this.tile.level;let r=i<8?this.tile.numSubdivisionsAtLevel[i]+1:2;if(t.samplerData){const e=this.tile.vlevel-i,a=Math.max(i-t.maxTileLevel,Pe["b"]-e),n=this.tile.maxTesselation;r=Object(Qe["d"])(1+(n>>a),2,n+1)}let a=this.tile.clippingArea;this.tile.intersectsClippingArea&&!this.tile.isWithinClippingArea||(a=null);const n=this.geometryState;let s=!1;return n.numVertsPerRow!==r&&(n.numVertsPerRow=r,s=!0),t.changed&&(n.samplerData=t.samplerData,s=!0),Object(ub["e"])(n.clippingArea,a)||(n.clippingArea=a,s=!0),n.wireframe!==e&&(n.wireframe=e,s=!0),s}_createGeometry(e){this.tile.createGeometry(this.geometryState,this.localOrigin);const t=this.geometryInfo.vertexAttributes,i=this.geometryInfo.indices,r=e.gl;this._vao=new ri["a"](e,zt["a"],{geometry:Object(Xt["a"])(t.layout)},{geometry:ei["a"].createVertex(e,r.STATIC_DRAW,t.buffer)},ei["a"].createIndex(e,r.STATIC_DRAW,i))}_releaseGeometry(){return!!this._vao&&(this._vao.dispose(),this._vao=null,yv(this.geometryInfo),!0)}get vao(){return this._vao}setTextureReference(e,t,i,r,a=0){e!==this._texture&&this.releaseTexture(),this._textureRef.push(e,t,i,r,a)}get textureReference(){return this._textureRef.current}get nextTextureReference(){return this._textureRef.next}get textureFadeFactor(){return this._textureRef.fadeFactor}get textureIsFading(){return this._textureRef.isFading}_getElevationInfo(){const e=this.geometryState.samplerData,t=this.tile.layerInfo[0],i=t.length;let r=new Array(i),a=0,n=0,s=!1;for(let o=0;o<i;o++){const i=t[o];if(i.upsampleInfo){const t=i.upsampleInfo.tile,c=t.layerInfo[0][o].data,l=c&&c.samplerData;e&&e[a]===l||(s=!0),r[a++]=l,n=Math.max(n,t.lij[0])}else if(i.data){const t=this.tile.surface.layerViewByIndex(o,0);if(Object(Vg["e"])(this.tile,t.layer,!1)){const t=i.data;e&&e[a]===t.samplerData||(s=!0),r[a++]=t.samplerData,n=this.tile.lij[0]}}}return e&&e.length!==a&&(s=!0),a>0?r.length=a:r=null,{changed:s,samplerData:r,maxTileLevel:n}}get estimatedGeometryMemoryUsage(){return this.geometryInfo.indices.byteLength+this.geometryInfo.vertexAttributes.byteLength}get textureDescriptor(){return Object(p["k"])(this._texture)?this._texture.descriptor:null}get test(){return{hasTexture:null!=this._texture}}}i("9f8b"),i("1956");var oy=i("7c33"),cy=i("d267"),ly=i("beba"),hy=i("ec6a");const dy=.125;class uy{constructor(){this._renderParams={context:null,drawPhase:1,state:new hy["a"]({viewpoint:new I["a"]({targetGeometry:new C["a"](0,0),scale:1,rotation:0}),size:[256,256]}),stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,driverTestResult:null,profiler:null,renderingOptions:null,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1}}dispose(){this._renderParams=null}render(e,t,i,r,a,n,s,o,c,l){const h=n.adjustLevel(t[0]),d=this._renderParams;d.context=e,d.painter=r,d.glyphMosaic=r.glyphMosaic,d.spriteMosaic=r.spriteMosaic,d.pixelRatio=l,d.displayLevel=h,d.requiredLevel=h;const u=n.getScale(t[0]),[p,f]=n.getShift(t,s*u),m=dy*s*u/c,b=i.transforms.dvs;b[0]=m,b[4]=-m,b[6]=-1-p-o[0]*s*2,b[7]=1+f+(1-o[1])*s*2-2,d.state.size[0]=c,d.state.size[1]=c,i.stage||i.attachWithContext(e),i.triangleCount=0,r.drawTile(d,i,a)}}var py=i("affb");class fy extends Bt["a"]{initializeProgram(e){const t=fy.shader.get().build();return new Nt["a"](e.rctx,t.generateSource("vertex"),t.generateSource("fragment"),zt["a"])}initializePipeline(){const e=2===this.configuration.mode?Object(qt["g"])(1,771):1===this.configuration.mode?Object(qt["g"])(0,770):null;return Object(qt["e"])({blending:e,colorWrite:qt["c"]})}}fy.shader=new Gt["a"](py["a"],()=>i.e("chunk-2d0e149c").then(i.bind(null,"7a95")));class my extends Ht["a"]{constructor(){super(...arguments),this.mode=0}}Object(d["a"])([Object(Ht["b"])({count:3})],my.prototype,"mode",void 0);var by=i("f6ac");class gy extends Bt["a"]{get uniformLocationInfos(){return this._uniformLocationInfos||(this._uniformLocationInfos=Object(ly["i"])(this._context,this.program)),this._uniformLocationInfos}initializeProgram(e){const t=gy.shader.get(),i=this.configuration,r=t.build({output:i.colorizerType,applyColormap:i.applyColormap});return this._context=e.rctx,new Nt["a"](e.rctx,r.generateSource("vertex"),r.generateSource("fragment"),zt["a"])}initializePipeline(){const e=2===this.configuration.mode?Object(qt["g"])(1,771):1===this.configuration.mode?Object(qt["g"])(0,770):null;return Object(qt["e"])({blending:e,colorWrite:qt["c"]})}bindPass(e,t){Object(ly["k"])(this.program,this.uniformLocationInfos,t.basic),Object(ly["k"])(this.program,this.uniformLocationInfos,t.common),Object(p["k"])(t.colormap)&&Object(ly["k"])(this.program,this.uniformLocationInfos,t.colormap),0===this.configuration.colorizerType&&Object(p["k"])(t.stretch)?Object(ly["k"])(this.program,this.uniformLocationInfos,t.stretch):2===this.configuration.colorizerType&&Object(p["k"])(t.hillshade)&&Object(ly["k"])(this.program,this.uniformLocationInfos,t.hillshade)}}gy.shader=new Gt["a"](by["a"],()=>i.e("chunk-2d222785").then(i.bind(null,"cf6b")));class vy extends Ht["a"]{constructor(){super(...arguments),this.mode=2,this.colorizerType=0,this.applyColormap=!0}}Object(d["a"])([Object(Ht["b"])({count:3})],vy.prototype,"mode",void 0),Object(d["a"])([Object(Ht["b"])({count:3})],vy.prototype,"colorizerType",void 0),Object(d["a"])([Object(Ht["b"])()],vy.prototype,"applyColormap",void 0);class yy{constructor(e){this.renderingContext=e,this._pools=new Map}acquire(e){return this.getPool(e).acquire()}release(e){this.getPool(e.width).release(e)}clear(){this._pools.forEach(e=>e.destroy()),this._pools.clear()}getPool(e){let t=this._pools.get(e);if(!t){const i=cy["a"].bind(cy["a"],this.renderingContext,{colorTarget:0,depthStencilTarget:1,width:e,height:e});t=new sp["a"](i),this._pools.set(e,t)}return t}}class Oy{constructor(e,t,i){this._rctx=e,this.tileSize=t,this._backgroundIsGrid=!1,this._backgroundTexture=null,this._backgroundColor=null,this._blackTex=null,this._vectorTileHelper=new uy,this._rctx.capabilities.textureFilterAnisotropic&&(this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy),this._vaoQuad=Object(Ii["d"])(this._rctx,oy["b"]);const r=new my;r.mode=2,this._blendLayersTechnique=i.acquire(fy,r),r.mode=1,this._applyOpacityTechnique=i.acquire(fy,r),this._techniqueRep=i,this._blackTex=new Bg["a"](Object(Ii["a"])(this._rctx,[0,0,0,1])),this._fboPool=new yy(this._rctx)}dispose(){this._fboPool&&(this._fboPool.clear(),this._fboPool=null),this._vaoQuad=Object(p["f"])(this._vaoQuad),this._backgroundTexture=Object(p["r"])(this._backgroundTexture),this._blackTex=Object(p["r"])(this._blackTex),this._blendLayersTechnique=Object(p["f"])(this._blendLayersTechnique),this._applyOpacityTechnique=Object(p["f"])(this._applyOpacityTechnique),this._vectorTileHelper=Object(p["f"])(this._vectorTileHelper)}updateTileTexture(e){const t=e.layerInfo[1];for(const p of t)p.pendingUpdates&=-65;if(!e.renderData)return;const i=e.surface,r=i.baseOpacity;let a=0,n=0,s=this.tileSize,o=!1;const c=i.view.pixelRatio;let l=t.length,h=0;for(;h<t.length&&!o;h++){const d=i.layerViewByIndex(h,1),u=d.fullOpacity;if(jy[h]=u,Object(ve["b"])(d.layer)&&l>=t.length&&(l=h),0===u)continue;++n;const f=xy(e,h,wy);f&&(Object(sb["m"])(d)?s=Math.max(s,this.tileSize*c):1===r&&1===u&&(d.isOpaque||this._dataToTexture(f)&&Object(p["k"])(f.sourceLayerInfo.data)&&f.sourceLayerInfo.data.descriptor.isOpaque)&&(o=!0),++a)}this._cleanupFBOPool(c,t.length),s=_y(s);const d=s/this.tileSize,u=h-1;if(0===a){let t=0;return(e.surface.view.layerViewManager.updating||n>0)&&(t=5e3),this._backgroundTexture&&Object(p["j"])(e.renderData.textureReference)&&(t=0),void this._useBackgroundTexture(e,t)}1===a&&(o||this._backgroundIsGrid||Object(p["k"])(this._backgroundColor))&&this._useLayerTexture(e,u,l,jy[u])||this._composeMapLayers(e,u,l,o,jy,s,d)}setBackground(e,t){Object(p["r"])(this._backgroundTexture),this._backgroundIsGrid=t,e instanceof HTMLImageElement?(this._backgroundTexture=this._buildTexture(e),this._backgroundColor=null):(this._backgroundTexture=new Bg["a"](Object(Ii["a"])(this._rctx,e)),this._backgroundColor=Object(Lt["d"])(e[0]||0,e[1]||0,e[2]||0,e[3]||0))}get backgroundIsGrid(){return this._backgroundIsGrid}get backgroundColor(){return this._backgroundColor}_buildTexture(e){if(Object(p["j"])(e))return null;const t={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9987,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},i=this._rctx;let r;if("number"==typeof e)t.width=t.height=e,r=new Bg["a"](new ti["a"](i,t));else if(e instanceof ib["a"])t.isOpaque=e.isOpaque,r=new Bg["a"](new ti["a"](i,t,e.image)),e.release();else try{r=new Bg["a"](new ti["a"](i,t,e))}catch(a){r=new Bg["a"](Object(Ii["c"])(i)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}return i.bindTexture(r.texture,0),r.generateMipmap(),r}_drawQuad(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(5,0,Object(ii["f"])(this._vaoQuad,"geometry"))}_drawRasterData(e,t,i,r,a=1){if(Object(p["j"])(t))return;const n=this._rctx,s=e.program;n.setPipelineState(e.pipeline),n.bindProgram(s),n.bindTexture(t,0),s.setUniform1i("tex",0),s.setUniform1f("scale",i),s.setUniform2f("offset",r[0],r[1]),s.setUniform1f("opacity",a),this._drawQuad(s)}_drawImageryTileData(e,t=1){const i=e.sourceLayerInfo.data;if(Object(p["j"])(i)||!i.source)return;e.tile.surface.layerViewByIndex(e.layerIndex,1).ensureSymbolizerParameters(i);const r=this._getRasterColorizerTechnique(i.symbolizerParameters.type,!!i.symbolizerParameters.colormap),a=this._rctx,n=r.program;if(a.setPipelineState(r.pipeline),a.bindProgram(n),!i.bind(a))return;i.opacity=t,i.scale=e.scale,i.offset=e.offset;const{names:s,textures:o}=i.getTextures();Object(ly["j"])(a,n,s,o);const c=i.getUniforms();r.bindPass(a,c),this._drawQuad(n),a.bindVAO()}_getRasterColorizerTechnique(e,t){const i=["stretch","lut","hillshade"].indexOf(e);return this._rasterColorizerConfig||(this._rasterColorizerConfig=new vy,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.colorizerType=i,this._rasterColorizerConfig.applyColormap=t,this._rasterColorizerTechnique=this._techniqueRep.acquireAndReleaseExisting(gy,this._rasterColorizerConfig,this._rasterColorizerTechnique),this._rasterColorizerTechnique}_drawVectorData(e,t,i,r,a,n,s){const o=t.sourceLayerInfo.data;if(Object(p["j"])(o))return s;const c=this._rctx,l=t.tile.surface.layerViewByIndex(t.layerIndex,1);let h;c.setPipelineState(e.pipeline);const d=r<1;return d?(h=this._fboPool.acquire(a),c.bindFramebuffer(h),c.setClearColor(1,1,1,0),c.clearSafe(16640)):s&&c.clearSafe(256),this._vectorTileHelper.render(c,t.sourceLod,o,l.painter,l.layer.styleRepository,l.schemaHelper,Math.round(1/t.scale),t.offset,this.tileSize,i),!d||(c.bindFramebuffer(n),this._drawRasterData(e,h.colorTexture,1,[0,0],r),this._fboPool.release(h),s)}_useBackgroundTexture(e,t){e.renderData.opacity=e.surface.baseOpacity,e.renderData.compositeBackgroundInShader=!1,e.renderData.layerOpacity=1,e.renderData.baseOpacity=1,e.renderData.setTextureReference(this._backgroundTexture,0,0,1,t)}_useLayerTexture(e,t,i,r){const a=t<i;e.renderData.opacity=a?1:e.surface.baseOpacity,e.renderData.compositeBackgroundInShader=!0,e.renderData.layerOpacity=r,e.renderData.baseOpacity=a?e.surface.baseOpacity:1;const n=xy(e,t,wy);if(this._dataToTexture(n)){const t=n.offset;return e.renderData.setTextureReference(n.sourceLayerInfo.data,t[0],t[1],n.scale),!0}return!1}_composeMapLayers(e,t,i,r,a,n,s){const o=e.renderData.ensureTexture(n,()=>this._buildTexture(n));if(Object(p["j"])(o))return;const c=this._rctx,l=this._fboPool.acquire(n);c.bindFramebuffer(l),c.setViewport(0,0,n,n),c.setClearColor(0,0,0,0),c.setClearDepth(1),c.clearSafe(16640);let h=!1;!r&&Object(p["k"])(this._backgroundTexture)&&this._drawRasterData(this._blendLayersTechnique,this._backgroundTexture.texture,1,hi["a"]);const d=e.surface.baseOpacity;let u=!1;for(let m=t;m>=0;m--){const t=xy(e,m,wy);t&&(m<i&&d<1&&!u&&(this._drawRasterData(this._applyOpacityTechnique,this._blackTex.texture,1,hi["a"],d),u=!0),0!==a[m]&&(Object(sb["n"])(t)?h=this._drawVectorData(this._blendLayersTechnique,t,s,a[m],n,l,h):Object(sb["g"])(t)?this._drawImageryTileData(t,a[m]):this._dataToTexture(t)&&Object(p["k"])(t.sourceLayerInfo.data)&&this._drawRasterData(this._blendLayersTechnique,t.sourceLayerInfo.data.texture,t.scale,t.offset,a[m])))}c.bindTexture(o.texture,0);const f=o.descriptor;c.gl.copyTexImage2D(c.gl.TEXTURE_2D,0,f.pixelFormat,0,0,f.width,f.height,0),o.generateMipmap(),c.bindFramebuffer(null),this._fboPool.release(l),e.renderData.opacity=u?1:d,e.renderData.compositeBackgroundInShader=!1,e.renderData.layerOpacity=1,e.renderData.baseOpacity=1,e.renderData.setTextureReference(o,0,0,1)}_dataToTexture(e){return Object(sb["i"])(e)&&this._rasterDataToTexture(e),Object(sb["k"])(e)}_rasterDataToTexture(e){const t=e.sourceLayerInfo;t.data=this._buildTexture(t.data),e.tile.setMemoryDirty()}_cleanupFBOPool(e,t){e===this._lastPixelRatio&&t===this._lastNumLayers||(this._fboPool.clear(),this._lastPixelRatio=e,this._lastNumLayers=t)}get test(){return{backgroundTexture:this._backgroundTexture}}}function _y(e){const t=Object(Qe["o"])(e),i=t*t,r=e*e;if(i===r)return e;const a=t/2;return i-r<r-a*a?t:a}function xy(e,t,i){i.layerIndex=t;const r=e.layerInfo[1][t];if(r.data)return Object(di["s"])(i.offset,0,0),i.tile=e,i.scale=1,i.sourceLod=e.lij,i.sourceLayerInfo=r,i;const a=r.upsampleInfo;if(a){const e=a.tile.layerInfo[1][t];return i.tile=a.tile,Object(di["c"])(i.offset,a.offset),i.scale=a.scale,i.sourceLod=a.tile.lij,i.sourceLayerInfo=e,i}return null}const jy=new Array,wy={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0};var Sy=i("87b7"),Cy=i("572a");class Ty extends Bt["a"]{initializeProgram(e){const t=Ty.shader.get(),i=this.configuration,r=t.build({overlayMode:i.overlayMode,output:i.output,viewingMode:e.viewingMode,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,textureFadingEnabled:i.textureFadingEnabled&&!i.renderOccluded,hasBackgroundColor:i.hasBackgroundColor,useGrid:i.useGrid,receiveShadows:i.receiveShadows&&!i.renderOccluded,receiveAmbientOcclusion:!1,useOldSceneLightInterface:!0,atmosphere:i.atmosphere,tileBorders:i.tileBorders,screenSizePerspective:i.screenSizePerspective,pbrMode:0,ssrEnabled:i.ssrEnabled,highStepCount:!1});return new Nt["a"](e.rctx,r.generateSource("vertex"),r.generateSource("fragment"),zt["a"])}initializePipeline(){const e=this.configuration,t=e.backfaceCullingEnabled&&!e.renderOccluded;return Object(qt["e"])({blending:e.renderOccluded?Object(qt["g"])(1,771):null,culling:t&&qt["b"],depthTest:!e.renderOccluded&&{func:513},depthWrite:!e.renderOccluded&&qt["d"],colorWrite:qt["c"],stencilTest:e.stencilEnabled?Object(Sy["c"])(1):null})}}Ty.shader=new Gt["a"](Cy["a"],()=>i.e("chunk-2d0dacb2").then(i.bind(null,"6cb1")));class Py extends Ht["a"]{constructor(){super(...arguments),this.output=0,this.overlayMode=0,this.atmosphere=!1,this.receiveShadows=!1,this.slicePlaneEnabled=!1,this.backfaceCullingEnabled=!1,this.stencilEnabled=!1,this.textureFadingEnabled=!1,this.hasBackgroundColor=!1,this.useGrid=!1,this.renderOccluded=!1,this.ssrEnabled=!1,this.tileBorders=!1,this.screenSizePerspective=!1}}Object(d["a"])([Object(Ht["b"])({count:8})],Py.prototype,"output",void 0),Object(d["a"])([Object(Ht["b"])({count:3})],Py.prototype,"overlayMode",void 0),Object(d["a"])([Object(Ht["b"])()],Py.prototype,"atmosphere",void 0),Object(d["a"])([Object(Ht["b"])()],Py.prototype,"receiveShadows",void 0),Object(d["a"])([Object(Ht["b"])()],Py.prototype,"slicePlaneEnabled",void 0),Object(d["a"])([Object(Ht["b"])()],Py.prototype,"backfaceCullingEnabled",void 0),Object(d["a"])([Object(Ht["b"])()],Py.prototype,"stencilEnabled",void 0),Object(d["a"])([Object(Ht["b"])()],Py.prototype,"textureFadingEnabled",void 0),Object(d["a"])([Object(Ht["b"])()],Py.prototype,"hasBackgroundColor",void 0),Object(d["a"])([Object(Ht["b"])()],Py.prototype,"useGrid",void 0),Object(d["a"])([Object(Ht["b"])()],Py.prototype,"renderOccluded",void 0),Object(d["a"])([Object(Ht["b"])()],Py.prototype,"ssrEnabled",void 0),Object(d["a"])([Object(Ht["b"])()],Py.prototype,"tileBorders",void 0),Object(d["a"])([Object(Ht["b"])()],Py.prototype,"screenSizePerspective",void 0);var Ay=i("c514"),Ry=Object(yr["b"])((function(e){var t;void 0!==(t=function(){var e=function(e){window.console&&window.console.log&&window.console.log(e)},t=function(t){window.console&&window.console.error?window.console.error(t):e(t)},i={enable:{1:{0:!0}},disable:{1:{0:!0}},getParameter:{1:{0:!0}},drawArrays:{3:{0:!0}},drawElements:{4:{0:!0,2:!0}},createShader:{1:{0:!0}},getShaderParameter:{2:{1:!0}},getProgramParameter:{2:{1:!0}},getShaderPrecisionFormat:{2:{0:!0,1:!0}},getVertexAttrib:{2:{1:!0}},vertexAttribPointer:{6:{2:!0}},bindTexture:{2:{0:!0}},activeTexture:{1:{0:!0}},getTexParameter:{2:{0:!0,1:!0}},texParameterf:{3:{0:!0,1:!0}},texParameteri:{3:{0:!0,1:!0,2:!0}},texImage2D:{9:{0:!0,2:!0,6:!0,7:!0},6:{0:!0,2:!0,3:!0,4:!0}},texSubImage2D:{9:{0:!0,6:!0,7:!0},7:{0:!0,4:!0,5:!0}},copyTexImage2D:{8:{0:!0,2:!0}},copyTexSubImage2D:{8:{0:!0}},generateMipmap:{1:{0:!0}},compressedTexImage2D:{7:{0:!0,2:!0}},compressedTexSubImage2D:{8:{0:!0,6:!0}},bindBuffer:{2:{0:!0}},bufferData:{3:{0:!0,2:!0}},bufferSubData:{3:{0:!0}},getBufferParameter:{2:{0:!0,1:!0}},pixelStorei:{2:{0:!0,1:!0}},readPixels:{7:{4:!0,5:!0}},bindRenderbuffer:{2:{0:!0}},bindFramebuffer:{2:{0:!0}},checkFramebufferStatus:{1:{0:!0}},framebufferRenderbuffer:{4:{0:!0,1:!0,2:!0}},framebufferTexture2D:{5:{0:!0,1:!0,2:!0}},getFramebufferAttachmentParameter:{3:{0:!0,1:!0,2:!0}},getRenderbufferParameter:{2:{0:!0,1:!0}},renderbufferStorage:{4:{0:!0,1:!0}},clear:{1:{0:{enumBitwiseOr:["COLOR_BUFFER_BIT","DEPTH_BUFFER_BIT","STENCIL_BUFFER_BIT"]}}},depthFunc:{1:{0:!0}},blendFunc:{2:{0:!0,1:!0}},blendFuncSeparate:{4:{0:!0,1:!0,2:!0,3:!0}},blendEquation:{1:{0:!0}},blendEquationSeparate:{2:{0:!0,1:!0}},stencilFunc:{3:{0:!0}},stencilFuncSeparate:{4:{0:!0,1:!0}},stencilMaskSeparate:{2:{0:!0}},stencilOp:{3:{0:!0,1:!0,2:!0}},stencilOpSeparate:{4:{0:!0,1:!0,2:!0,3:!0}},cullFace:{1:{0:!0}},frontFace:{1:{0:!0}},drawArraysInstancedANGLE:{4:{0:!0}},drawElementsInstancedANGLE:{5:{0:!0,2:!0}},blendEquationEXT:{1:{0:!0}}},r=null,a=null;function n(e){if(null==r)for(var t in r={},a={},e)"number"==typeof e[t]&&(r[e[t]]=t,a[t]=e[t])}function s(){if(null==r)throw"WebGLDebugUtils.init(ctx) not called"}function o(e){return s(),void 0!==r[e]}function c(e){s();var t=r[e];return void 0!==t?"gl."+t:"/*UNKNOWN WebGL ENUM*/ 0x"+e.toString(16)}function l(e,t,r,n){var s;if(void 0!==(s=i[e])&&void 0!==(s=s[t])&&s[r]){if("object"==typeof s[r]&&void 0!==s[r].enumBitwiseOr){for(var o=s[r].enumBitwiseOr,l=0,h=[],d=0;d<o.length;++d){var u=a[o[d]];0!=(n&u)&&(l|=u,h.push(c(u)))}return l===n?h.join(" | "):c(n)}return c(n)}return null===n?"null":void 0===n?"undefined":n.toString()}function h(e,t){for(var i="",r=t.length,a=0;a<r;++a)i+=(0==a?"":", ")+l(e,r,a,t[a]);return i}function d(e,t,i){e.__defineGetter__(i,(function(){return t[i]})),e.__defineSetter__(i,(function(e){t[i]=e}))}function u(e,i,r,a){a=a||e,n(e),i=i||function(e,i,r){for(var a="",n=r.length,s=0;s<n;++s)a+=(0==s?"":", ")+l(i,n,s,r[s]);t("WebGL error "+c(e)+" in "+i+"("+a+")")};var s={};function o(e,t){return function(){r&&r(t,arguments);var n=e[t].apply(e,arguments),o=a.getError();return 0!=o&&(s[o]=!0,i(o,t,arguments)),n}}var h={};for(var p in e)if("function"==typeof e[p])if("getExtension"!=p)h[p]=o(e,p);else{var f=o(e,p);h[p]=function(){return u(f.apply(e,arguments),i,r,a)}}else d(h,e,p);return h.getError=function(){for(var t in s)if(s.hasOwnProperty(t)&&s[t])return s[t]=!1,t;return e.NO_ERROR},h}function p(e){var t=e.getParameter(e.MAX_VERTEX_ATTRIBS),i=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,i);for(var r=0;r<t;++r)e.disableVertexAttribArray(r),e.vertexAttribPointer(r,4,e.FLOAT,!1,0,0),e.vertexAttrib1f(r,0);e.deleteBuffer(i);var a=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS);for(r=0;r<a;++r)e.activeTexture(e.TEXTURE0+r),e.bindTexture(e.TEXTURE_CUBE_MAP,null),e.bindTexture(e.TEXTURE_2D,null);for(e.activeTexture(e.TEXTURE0),e.useProgram(null),e.bindBuffer(e.ARRAY_BUFFER,null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindRenderbuffer(e.RENDERBUFFER,null),e.disable(e.BLEND),e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST),e.disable(e.DITHER),e.disable(e.SCISSOR_TEST),e.blendColor(0,0,0,0),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ONE,e.ZERO),e.clearColor(0,0,0,0),e.clearDepth(1),e.clearStencil(-1),e.colorMask(!0,!0,!0,!0),e.cullFace(e.BACK),e.depthFunc(e.LESS),e.depthMask(!0),e.depthRange(0,1),e.frontFace(e.CCW),e.hint(e.GENERATE_MIPMAP_HINT,e.DONT_CARE),e.lineWidth(1),e.pixelStorei(e.PACK_ALIGNMENT,4),e.pixelStorei(e.UNPACK_ALIGNMENT,4),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),e.UNPACK_COLORSPACE_CONVERSION_WEBGL&&e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,e.BROWSER_DEFAULT_WEBGL),e.polygonOffset(0,0),e.sampleCoverage(1,!1),e.scissor(0,0,e.canvas.width,e.canvas.height),e.stencilFunc(e.ALWAYS,0,4294967295),e.stencilMask(4294967295),e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.viewport(0,0,e.canvas.width,e.canvas.height),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT);e.getError(););}function f(e){var t,i,r=[],a=[],n={},s=1,o=!1,c=[],l=0,h=0,u=!1,f=0,m={};function b(e){return"function"==typeof e?e:function(t){e.handleEvent(t)}}e.getContext=(i=e.getContext,function(){var r=i.apply(e,arguments);if(r instanceof WebGLRenderingContext){if(r!=t){if(t)throw"got different context";n=S(t=r)}return n}return r});var g=function(e){r.push(b(e))},v=function(e){a.push(b(e))};function y(e){var t=e.addEventListener;e.addEventListener=function(i,r,a){switch(i){case"webglcontextlost":g(r);break;case"webglcontextrestored":v(r);break;default:t.apply(e,arguments)}}}function O(){for(var e=Object.keys(m),t=0;t<e.length;++t)delete m[e]}function _(){++h,o||l==h&&e.loseContext()}function x(e,t){var i=e[t];return function(){if(_(),!o)return i.apply(e,arguments)}}function j(){for(var e=0;e<c.length;++e){var i=c[e];i instanceof WebGLBuffer?t.deleteBuffer(i):i instanceof WebGLFramebuffer?t.deleteFramebuffer(i):i instanceof WebGLProgram?t.deleteProgram(i):i instanceof WebGLRenderbuffer?t.deleteRenderbuffer(i):i instanceof WebGLShader?t.deleteShader(i):i instanceof WebGLTexture&&t.deleteTexture(i)}}function w(e){return{statusMessage:e,preventDefault:function(){u=!0}}}return y(e),e.loseContext=function(){if(!o){for(o=!0,l=0,++s;t.getError(););O(),m[t.CONTEXT_LOST_WEBGL]=!0;var i=w("context lost"),a=r.slice();setTimeout((function(){for(var t=0;t<a.length;++t)a[t](i);f>=0&&setTimeout((function(){e.restoreContext()}),f)}),0)}},e.restoreContext=function(){o&&a.length&&setTimeout((function(){if(!u)throw"can not restore. webglcontestlost listener did not call event.preventDefault";j(),p(t),o=!1,h=0,u=!1;for(var e=a.slice(),i=w("context restored"),r=0;r<e.length;++r)e[r](i)}),0)},e.loseContextInNCalls=function(e){if(o)throw"You can not ask a lost contet to be lost";l=h+e},e.getNumCalls=function(){return h},e.setRestoreTimeout=function(e){f=e},e;function S(e){for(var i in e)"function"==typeof e[i]?n[i]=x(e,i):d(n,e,i);n.getError=function(){if(_(),!o)for(;e=t.getError();)m[e]=!0;for(var e in m)if(m[e])return delete m[e],e;return n.NO_ERROR};for(var r=["createBuffer","createFramebuffer","createProgram","createRenderbuffer","createShader","createTexture"],a=0;a<r.length;++a){var l=r[a];n[l]=function(t){return function(){if(_(),o)return null;var i=t.apply(e,arguments);return i.__webglDebugContextLostId__=s,c.push(i),i}}(e[l])}var h=["getActiveAttrib","getActiveUniform","getBufferParameter","getContextAttributes","getAttachedShaders","getFramebufferAttachmentParameter","getParameter","getProgramParameter","getProgramInfoLog","getRenderbufferParameter","getShaderParameter","getShaderInfoLog","getShaderSource","getTexParameter","getUniform","getUniformLocation","getVertexAttrib"];for(a=0;a<h.length;++a)l=h[a],n[l]=function(t){return function(){return _(),o?null:t.apply(e,arguments)}}(n[l]);var u=["isBuffer","isEnabled","isFramebuffer","isProgram","isRenderbuffer","isShader","isTexture"];for(a=0;a<u.length;++a)l=u[a],n[l]=function(t){return function(){return _(),!o&&t.apply(e,arguments)}}(n[l]);return n.checkFramebufferStatus=function(t){return function(){return _(),o?n.FRAMEBUFFER_UNSUPPORTED:t.apply(e,arguments)}}(n.checkFramebufferStatus),n.getAttribLocation=function(t){return function(){return _(),o?-1:t.apply(e,arguments)}}(n.getAttribLocation),n.getVertexAttribOffset=function(t){return function(){return _(),o?0:t.apply(e,arguments)}}(n.getVertexAttribOffset),n.isContextLost=function(){return o},n}}return{init:n,mightBeEnum:o,glEnumToString:c,glFunctionArgToString:l,glFunctionArgsToString:h,makeDebugContext:u,makeLostContextSimulatingCanvas:f,resetToInitialState:p}}())&&(e.exports=t)}));let My=null;const Ey=[];let Dy=!1;function Iy(){Dy&&(My=[])}function Ly(e){Dy&&null!=My&&My.push(e)}function Vy(){if(Dy){const e=My;return My=null,e&&(Ey.forEach(t=>t(e)),Ey.length=0),e}return null}function ky(e){return Dy?Object(Ay["a"])(e)?(console.warn("WebGL tracer is not supported on a WebGL2 Context"),e):Ry.makeDebugContext(e,void 0,(e,t)=>{Dy&&My&&My.push("gl."+e+"("+Ry.glFunctionArgsToString(e,t)+")")}):e}const Fy=7,zy=10,Uy=Object(bu["h"])(),Gy=Object(Lt["c"])();class By{constructor(){this.extent=Object(Lt["c"])(),this.minLevel=0,this.maxLevel=0,this.callback=null}}let Hy=class extends je["a"]{constructor(e){super(e),this.type="Terrain",this.isGround=!0,this.tileSize=256,this.rctx=null,this._isTransparent=!1,this.renderDataPool=new sp["a"](sy),this.patchGroups=new fd["a"]({allocator:e=>e||{root:null,origin:null,patches:new fd["a"]},deallocator:e=>(e.root=null,e.origin=null,e.patches.clear(),e)}),this.patchGroupsDirty=!0,this.patchGroupsMap=new Map,this.tileIterator=new Vg["b"],this.highestVisibleLODTile=null,this.visible=!0,this._opaque=!0,this._skirtScale=1,this._velvetOverground=!0,this.castShadows=!0,this._ssrEnabled=!1,this.emptyTex=null,this.tileRenderer=null,this.tileBackgroundInitialized=!1,this.tileBackgroundUpdating=!1,this.stencilEnabledLayerExtents=[],this.numTrianglesRendered=0,this.numTilesRendered=0,this.numTilesCulled=0,this.numOriginsRendered=0,this.clippingExtent=null,this.overlayOpacity=1,this.needsHighlight=!1,this.renderOccludedFlags=1,this.visibleScaleRangeQueries=new fd["a"]({initialSize:10}),this.visibleScaleRangeQueriesInvPtr=0,this.visibleScaleRangeQueryQueue=new fd["a"]({initialSize:30}),this.visibleScaleRangeQueryPool=new sp["a"](By)}destroy(){vv()}install(e){const t=[2,7,9];e.addRenderPlugin(t,this)}uninstall(e){e.removeRenderPlugin(this)}get updating(){return!this.tileBackgroundInitialized||this.tileBackgroundUpdating}get canRender(){return this.visible&&!!this.rootTiles&&this.tileBackgroundInitialized&&!this.renderingDisabled}set renderingDisabled(e){this._set("renderingDisabled",!!e),this.setNeedsRender()}set opaque(e){this._opaque!==e&&(this._opaque=e,this.setNeedsRender())}get needsLinearDepth(){return this.overlayRenderer.hasWater}get opaque(){return this._opaque&&!this.shaderTechniqueConfig.slicePlaneEnabled}set isTransparent(e){this._isTransparent!==e&&(this._isTransparent=e,this.setNeedsRender())}get isTransparent(){return this._isTransparent}set skirtScale(e){e!==this._skirtScale&&(this._skirtScale=e,this.setNeedsRender())}get skirtScale(){return this._skirtScale}get renderPatchBorders(){return!!this.shaderTechniqueConfig.tileBorders}set renderPatchBorders(e){this.shaderTechniqueConfig.tileBorders!==e&&(this.shaderTechniqueConfig.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get cullBackFaces(){return this.shaderTechniqueConfig.backfaceCullingEnabled}set cullBackFaces(e){this.shaderTechniqueConfig.backfaceCullingEnabled!==e&&(this.shaderTechniqueConfig.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender())}set renderOrder(e){this._set("renderOrder",e),this.setNeedsRender()}set velvetOverground(e){this._velvetOverground!==e&&(this._velvetOverground=e,this.setNeedsRender())}get intersectionHandlerId(){return Ur["e"]}get slicePlane(){return this.shaderTechniqueConfig.slicePlaneEnabled}set slicePlane(e){this.shaderTechniqueConfig.slicePlaneEnabled!==e&&(this.shaderTechniqueConfig.slicePlaneEnabled=e,this.setNeedsRender())}set textureFadingEnabled(e){this.shaderTechniqueConfig.textureFadingEnabled!==e&&(this.shaderTechniqueConfig.textureFadingEnabled=e,this.setNeedsRender())}setDebugScreenSizePerspective(e){this.shaderTechniqueConfig.screenSizePerspective!==e&&(this.shaderTechniqueConfig.screenSizePerspective=e,this.setNeedsRender())}setRootTiles(e){this.rootTiles=e,this.setNeedsRender()}setNeedsHighlight(e){this.needsHighlight=e,this.setNeedsRender()}setRenderOccludedOverlay(e){this.renderOccludedFlags=e?mg["c"]:1,this.setNeedsRender()}setStencilEnabledLayerExtents(e){this.stencilEnabledLayerExtents=e,this.setNeedsRender()}setTileSize(e){this.tileSize=e,this.tileRenderer&&(this.tileRenderer.tileSize=e),this.setNeedsRender()}loadTile(e){e.renderData||(e.renderData=this.renderDataPool.acquire(),e.renderData.init(e),e.renderData.localOrigin=this._getLocalOriginOfTile(e)),this.updateTileGeometry(e),this.updateTileTexture(e)}queryVisibleLevelRange(e,t,i,r){const a=this.visibleScaleRangeQueryPool.acquire();Object(ui["c"])(a.extent,e),a.minLevel=t||-Number.MAX_VALUE,a.maxLevel=null!=i?i:Number.MAX_VALUE,a.callback=r,this.visibleScaleRangeQueryQueue.push(a),this.setNeedsRender()}updateTileTexture(e){this.tileRenderer&&this.tileBackgroundInitialized&&(this.tileRenderer.updateTileTexture(e),this.setNeedsRender(),e.resetPendingUpdate(64))}updateTileGeometry(e){for(const t of e.layerInfo[0])t.pendingUpdates&=-33;e.resetPendingUpdate(32),e.renderData.updateGeometry(this.rctx,this.wireframe)&&this.setNeedsRender()}unloadTile(e){e.renderData&&(this.releaseTileGeometry(e.renderData),e.renderData.clear(),e.renderData=null,e.setMemoryDirty(),this.setNeedsRender())}_getLocalOriginOfTile(e){const t=zy-Fy,i=Math.max(0,Math.floor((e.lij[0]-t)/Fy)*Fy);if("spherical"===this.manifold&&0===i)return M["b"];for(;e.parent&&e.lij[0]>i;)e=e.parent;return e.centerAtSeaLevel}setVisibility(e){this.visible=e,this.setNeedsRender()}getStats(){return{numTilesRendered:this.numTilesRendered,numTilesCulled:this.numTilesCulled,numTrianglesRendered:this.numTrianglesRendered,numOriginsRendered:this.numOriginsRendered}}set wireframe(e){this._get("wireframe")!==e&&(this._set("wireframe",e),this.rootTiles&&(Object(Vg["k"])(this.rootTiles,t=>{t.renderData&&t.renderData.updateGeometry(this.rctx,e)}),this.setNeedsRender()))}setNeedsRender(e=1){this.patchGroupsDirty=!0,this.context.requestRender(e)}setTileBackground(e){this.tileBackground=e,this._updateTileBackground()}initializeRenderContext(e){this.context=e,this.rctx=e.renderContext.rctx,this.shaderTechniques=e.shaderTechniqueRep,this.shaderTechniqueConfig=new Py,this.tileRenderer=new Oy(this.rctx,this.tileSize,this.shaderTechniques),this.tileBackground&&this._updateTileBackground(),this.emptyTex=Object(Ii["c"])(this.rctx)}uninitializeRenderContext(){null!=this.emptyTex&&(this.emptyTex.dispose(),this.emptyTex=null),this.tileRenderer&&(this.tileRenderer.dispose(),this.tileRenderer=null)}intersect(e,t,i,r){if(!this.rootTiles||e.options.selectOpaqueTerrainOnly&&e.options.selectionMode&&!this._opaque)return;const a=Qy,n=Xy;Object(It["k"])(a,r,i),Object(It["x"])(n,1/a[0],1/a[1],1/a[2]);const s=e.results.min,o=e.results.max,c=e.results.ground,l=0===e.options.store,h=!!e.results.ground.target;let d;const u=this.clippingExtent,f=this.tileIterator;f.reset(this.rootTiles);const m=Object(Ur["h"])(e.verticalOffset);for(;!f.done;){const b=f.next();if(null===b.renderData||h&&this._useStencilForTile(b))continue;if(e.options.invisibleTerrain){if(!b.visible&&u&&!b.intersectsExtent(u))continue}else if(!b.visible)continue;const g=b.renderData.geometryInfo;Object(bu["C"])(Uy,g.boundingBox);const v=b.renderData.localOrigin;Object(p["k"])(m)&&(m.localOrigin=v,m.applyToAabb(Uy));const y=-this._skirtScale*g.skirtLength;if(0!==y){const e=b.up;Object(bu["p"])(Uy,y*e[0],y*e[1],y*e[2])}const O=Uy;Object(It["k"])(Yy,i,v);const _=l&&null!=s.dist?s.dist:1/0;if(!Object(uv["g"])(O,Yy,n,e.tolerance,_))continue;const x=(e,t,i,r)=>{e.set(void 0,Object(Vg["i"])(t),i,r,kt["a"],void 0),e.intersector=Jy,e.target={type:"external",metadata:{tile:t}}},j=(n,l)=>{if(n>=0&&(e.options.backfacesTerrain||Object(It["i"])(l,a)<0)&&(e.options.invisibleTerrain||!e.options.selectionMode||null==t||t(i,r,n))){if((null==c.dist||n<c.dist)&&x(c,b,n,l),e.options.isFiltered)return;2===e.options.store&&(Object(p["j"])(d)?(d=new Ur["b"](e.ray),x(d,b,n,l),e.results.all.push(d)):n<d.dist&&x(d,b,n,l)),(null==s.dist||n<s.dist)&&x(s,b,n,l),0!==e.options.store&&(null==o.dist||n>o.dist)&&x(o,b,n,l)}},w=Ky;Object(It["k"])(w,r,v);const S=g.indices,C=g.vertexAttributes,T={data:C.getField("position",Kv["u"]).typedBuffer,size:3,stride:C.stride/4},P=g.numWithoutSkirtIndices/3;if(Object(uv["j"])(Yy,w,0,P,S,T,null,m,j),0!==y){const e="spherical"===this.manifold?e=>Object(It["f"])(e,e,y/Object(It["q"])(Object(It["g"])(e,e,v))):e=>Object(It["x"])(e,0,0,y),t=S.length/3;Rv(Yy,w,P,t,S,C,e,m,j)}}}render(e){if(9===e.slot){if(0==(e.renderOccludedMask&mg["c"]))return!1}else{const t=this.opaque?2:7;if(e.slot!==t)return!1}Ly("# BEGIN RENDER TERRAIN");const t=e.pass,i=1===e.scenelightingData.globalFactor,r=this._updatePatchGroups();switch(t){case 0:{const t=e.shadowMap&&e.shadowMap.enabled;this.shaderTechniqueConfig.receiveShadows!==t&&(this.shaderTechniqueConfig.receiveShadows=t);const i=this.overlayRenderer.isEmpty()?0:this.overlayRenderer.hasWater?2:1;this.shaderTechniqueConfig.overlayMode!==i&&(this.shaderTechniqueConfig.overlayMode=i);const a=9===e.slot?3:1;this._renderMaterialPass(e,0,r,a);break}case 4:case 6:this.castShadows&&i&&this._renderAuxiliaryPass(e,3,r,0);break;case 2:this.isTransparent&&this.overlayRenderer.isEmpty()||this._renderAuxiliaryPass(e,1,r,0);break;case 3:this._renderAuxiliaryPass(e,2,r,0);break;case 5:this.needsHighlight&&(this._renderAuxiliaryPass(e,4,r,2),e.rctx.clearSafe(256))}return Ly("# END RENDER TERRAIN"),0!==this.visibleScaleRangeQueryQueue.length&&this.setNeedsRender(),!0}_renderMaterialPass(e,t,i,r){const a=e.rctx,n=e.camera;this._ssrEnabled=e.ssrParams.ssrEnabled,this._setTerrainTechnique(t,3===r);const s=this.shaderTechnique.program;e.rctx.bindProgram(s),a.bindProgram(s),1===r&&e.ssrParams&&(e.ssrParams.lastFrameColorTextureUnit=9,e.ssrParams.linearDepthTextureUnit=8,ey["a"].bindUniforms(s,a,e.ssrParams)),e.shadowMap&&e.shadowMap.bind(s,7),e.ssaoHelper&&e.ssaoHelper.setUniforms(s,6),s.setUniform1i("tex",0),s.setUniform1i("texNext",1),this._bindOverlayData(s,r),s.setUniformMatrix4fv("viewNormal",n.viewInverseTransposeMatrix),Kt["a"].bindProjectionMatrix(s,n.projectionMatrix),e.scenelightingData.setUniforms(s,!0);const o=n.viewMatrix;Object(It["x"])($y,o[12],o[13],o[14]),Object(It["s"])($y,$y),s.setUniform3fv("viewDirection",$y),this.numTilesRendered=0,this.numTilesCulled=0,this.numTrianglesRendered=0,this.numOriginsRendered=0,this._prepareScaleRangeQueries(),this.opaque?this._renderPatchGroups(e,s,i,r):e.offscreenRenderingHelper.renderToTargets(()=>this._renderPatchGroups(e,s,i,r),e.offscreenRenderingHelper.tmpColor,e.offscreenRenderingHelper.mainDepth,[0,0,0,0]),this._processScaleRangeQueries()}_renderAuxiliaryPass(e,t,i,r){this._setTerrainTechnique(t,3===r);const a=this.shaderTechnique.program;if(e.rctx.bindProgram(a),5===e.pass){const t=e.offscreenRenderingHelper;e.rctx.bindTexture(t.depthTexture,6),a.setUniform1i("depthTex",6),a.setUniform4f("highlightViewportPixelSz",0,0,1/t.width,1/t.height)}else a.setUniformMatrix4fv("viewNormal",e.camera.viewInverseTransposeMatrix),2!==e.pass&&4!==e.pass&&6!==e.pass||a.setUniform2fv("nearFar",e.camera.nearFar);this._renderPatchGroupsAuxiliary(e,a,i,r)}_updateTileBackground(){if(!this.tileRenderer)return;this.tileBackgroundUpdating=!0;const e=()=>{this.tileBackgroundInitialized=!0,this.tileBackgroundUpdating=!1,this.shaderTechniqueConfig.useGrid=this.tileRenderer.backgroundIsGrid,this.shaderTechniqueConfig.hasBackgroundColor=!this.tileRenderer.backgroundIsGrid&&!!Object(p["k"])(this.tileRenderer.backgroundColor),this.rootTiles&&Object(Vg["k"])(this.rootTiles,e=>{this.tileRenderer.updateTileTexture(e),this.setNeedsRender()}),this.setNeedsRender()};if("string"==typeof this.tileBackground){const t=this.tileBackground;Object(Ft["a"])(t).then(i=>{t===this.tileBackground&&this.tileRenderer&&(this.tileRenderer.setBackground(i,this.tileBackground===Pe["a"]),e())})}else{const t=this.tileBackground?ee["a"].toUnitRGBA(this.tileBackground):[0,0,0,0];this.tileRenderer.setBackground(t,!1),e()}}_updatePatchGroups(){const e=this.patchGroups;if(!this.patchGroupsDirty)return e;if(this.highestVisibleLODTile=null,this._renderCollectOrigins(e),0!==this.renderOrder){for(let t=0;t<e.length;t++)Object(Vg["g"])(this.renderOrder,e.data[t].patches);e.sort((e,t)=>qy(e,t,this.renderOrder))}return this.patchGroupsDirty=!1,e}_renderCollectOrigins(e){const t=this.rootTiles,i="spherical"===this.manifold;e.clear();for(const r of t){const t=e.pushNew();t.root=r,t.origin=i?M["b"]:r.centerAtSeaLevel,t.patches.clear(),this._renderCollectOriginsForRoot(e,t)}e.filterInPlace(e=>e.patches.length>0)}_renderCollectOriginsForRoot(e,t){const i=this.tileIterator;i.resetOne(t.root);const r=this.patchGroupsMap;for(r.clear(),r.set(t.origin,t);!i.done;){const t=i.next(),a=t.renderData;if(!a||t.visible){if(t.lij[0]%Fy==0){const i=e.pushNew();i.root=t,i.origin=t.centerAtSeaLevel,r.set(t.centerAtSeaLevel,i),i.patches.clear()}if(t.rendered){if(a){const e=r.get(a.localOrigin);e&&e.patches.push(t),(!this.highestVisibleLODTile||t.vlevel>this.highestVisibleLODTile.vlevel)&&(this.highestVisibleLODTile=t),i.skipSubtree()}}else this.numTilesCulled++}else this.numTilesCulled++,i.skipSubtree()}}_scaleQueriesForTile(e){const t=e.extent,i=e.lij[0];let r=0;for(;r<this.visibleScaleRangeQueriesInvPtr;){const e=this.visibleScaleRangeQueries.data[r],a=e.extent;i>=e.minLevel&&i<=e.maxLevel&&a[0]<=t[2]&&a[2]>=t[0]&&a[1]<=t[3]&&a[3]>=t[1]?(this.visibleScaleRangeQueries.swapElements(r,this.visibleScaleRangeQueriesInvPtr-1),this.visibleScaleRangeQueriesInvPtr--):r++}}_useStencilForTile(e){for(const t of this.stencilEnabledLayerExtents)if(e.intersectsExtent(t))return!0;return!1}_renderPatchGroupsAuxiliary(e,t,i,r){this.shaderTechnique.bindPipelineState(e.rctx);const a=this.stencilEnabledLayerExtents.length>0;t.setUniformMatrix4fv("proj",e.camera.projectionMatrix),t.setUniform1f("skirtScale",this._skirtScale),0!==r&&this._bindOverlayData(t,r);for(let n=0;n<i.length;n++){const s=i.data[n];this._bindPatchGroupData(t,s,e.camera.eye,e.camera.viewMatrix);for(let i=0;i<s.patches.length;i++)this._renderPatch(e.rctx,t,s.patches.data[i],4,a,r)}e.rctx.bindVAO(null)}_renderPatchGroups(e,t,i,r){const a=e.rctx,n=e.camera,s=n.viewMatrix;if(this.shaderTechnique.bindPipelineState(a),this.shaderTechniqueConfig.screenSizePerspective&&this.pointsOfInterest){const e=Object(Ad["d"])("spherical"===this.manifold?1:2,this.ellipsoidRadius),i=this.pointsOfInterest.centerOnSurfaceFrequent.distance;e.update({distance:i,fovY:n.fovY}),Object(uv["a"])(e,t,"screenSizePerspective")}const o=this.stencilEnabledLayerExtents.length>0,c=3===r;c&&(a.bindTexture(this.emptyTex,0),t.setUniform1f("blend",1),t.setUniform4fv("texOffsetAndScale",Lt["b"]));const l=Object(p["k"])(this.tileRenderer.backgroundColor)?this.tileRenderer.backgroundColor:Lt["b"];this.shaderTechniqueConfig.hasBackgroundColor&&t.setUniform4fv("backgroundColor",l);const h=c?0:this._skirtScale;t.setUniform1f("skirtScale",h);const d=this.wireframe?1:4;for(let u=0;u<i.length;u++){const l=i.data[u],h=l.patches;if(0===h.length)continue;this._bindPatchGroupData(t,l,n.eye,s);const f=e.sliceHelper&&e.sliceHelper.plane;Jv["a"].bindUniforms(t,this.shaderTechnique.configuration,f,l.origin),e.shadowMap&&e.shadowMap.bindView(t,l.origin),this.numOriginsRendered++;for(let e=0;e<h.length;e++){const i=h.data[e],n=i.renderData.textureReference;if(Object(p["j"])(n))continue;if(Ly("# RENDER TILE "+Object(Vg["i"])(i)+", screenDepth:"+i.screenDepth),!c){this._scaleQueriesForTile(i),Wy(i.renderData.geometryInfo.uvOffsetAndScale,n.offsetAndScale,Gy),t.setUniform4fv("texOffsetAndScale",Gy),a.bindTexture(n.texture.texture,0);const e=i.renderData.textureFadeFactor,r=e<1?i.renderData.nextTextureReference:null;this.shaderTechniqueConfig.textureFadingEnabled&&Object(p["k"])(r)?(Wy(i.renderData.geometryInfo.uvOffsetAndScale,r.offsetAndScale,Gy),t.setUniform1f("textureFadeFactor",e),t.setUniform4fv("nextTexOffsetAndScale",Gy),a.bindTexture(r.texture.texture,1)):(t.setUniform1f("textureFadeFactor",1),a.bindTexture(this.emptyTex,1)),i.renderData.textureIsFading&&this.setNeedsRender(),t.setUniform1f("opacity",i.renderData.opacity),t.setUniform1i("compositeBackground",i.renderData.compositeBackgroundInShader?1:0),t.setUniform1f("textureOpacity",i.renderData.layerOpacity),t.setUniform1f("baseOpacity",i.renderData.baseOpacity)}const s=this._renderPatch(a,t,i,d,o,r);i.renderOrder=this.numTilesRendered,this.numTilesRendered++,this.numTrianglesRendered+=s/3}}a.bindVAO(null)}_renderPatch(e,t,i,r,a,n){0!==n&&this._bindOverlayPatchData(t,i.renderData.overlay),a&&(this._useStencilForTile(i)?this.stencilShaderTechnique.bindPipelineState(e):this.shaderTechnique.bindPipelineState(e));const s=0===this._skirtScale?i.renderData.geometryInfo.numWithoutSkirtIndices:i.renderData.vao.indexBuffer.size;return e.bindVAO(i.renderData.vao),t.assertCompatibleVertexAttributeLocations(i.renderData.vao),e.drawElements(r,s,i.renderData.vao.indexBuffer.indexType,0),s}_bindPatchGroupData(e,t,i,r){e.setUniform3fv("origin",t.origin),Object(Vt["t"])(Zy,r,t.origin),e.setUniformMatrix4fv("view",Zy),e.setUniform3f("camPos",i[0]-t.origin[0],i[1]-t.origin[1],i[2]-t.origin[2])}_bindOverlayData(e,t){e.setUniform1i("ovInnerColorTex",2),e.setUniform1i("ovOuterColorTex",3),e.setUniform1i("ovInnerWaterTex",4),e.setUniform1i("ovOuterWaterTex",5),e.setUniform1f("overlayOpacity",this.overlayOpacity);const i=this.overlayRenderer.overlays,r=e=>{if(Object(p["k"])(i)){const r=i[e],a=(1===t?r.renderTargets.color:2===t?r.renderTargets.highlight:r.renderTargets.occluded).fbo.getTexture();this.rctx.bindTexture(a,2+e);const n=1===t?r.renderTargets.water:null;if(n){const t=n.fbo.getTexture();this.rctx.bindTexture(t,4+e)}else this.rctx.bindTexture(this.emptyTex,4+e)}else this.rctx.bindTexture(this.emptyTex,2+e),this.rctx.bindTexture(this.emptyTex,4+e)};r(0),r(1)}_bindOverlayPatchData(e,t){e.setUniform4fv("overlayTexOffset",t.offsets),e.setUniform4fv("overlayTexScale",t.scales)}_setTerrainTechnique(e,t){if(this.shaderTechniqueConfig.output=e,0===e){const e="spherical"===this.manifold;this.shaderTechniqueConfig.atmosphere=e&&this._velvetOverground,this.shaderTechniqueConfig.ssrEnabled=this._ssrEnabled}this.shaderTechniqueConfig.renderOccluded=t,this.shaderTechniqueConfig.stencilEnabled=!1,this.shaderTechnique=this.shaderTechniques.acquireAndReleaseExisting(Ty,this.shaderTechniqueConfig,this.shaderTechnique),this.shaderTechniqueConfig.stencilEnabled=!0,this.stencilShaderTechnique=this.shaderTechniques.acquireAndReleaseExisting(Ty,this.shaderTechniqueConfig,this.stencilShaderTechnique)}releaseTileGeometry(e){e.releaseGeometry()&&this.setNeedsRender(),this.renderDataPool.release(e)}_prepareScaleRangeQueries(){const e=this.visibleScaleRangeQueries,t=this.visibleScaleRangeQueryQueue;for(;e.length<e.data.length&&t.length>0;){const i=t.pop();e.push(i)}this.visibleScaleRangeQueriesInvPtr=e.length}_processScaleRangeQueries(){const e=this.visibleScaleRangeQueries,t=this.visibleScaleRangeQueryPool;for(let i=0;i<e.length;i++){const r=e.data[i];t.release(r),r.callback(i>=this.visibleScaleRangeQueriesInvPtr),r.callback=null}e.clear()}get test(){return{tileRenderer:this.tileRenderer}}};Object(d["a"])([Object(g["b"])()],Hy.prototype,"tileBackgroundInitialized",void 0),Object(d["a"])([Object(g["b"])()],Hy.prototype,"tileBackgroundUpdating",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],Hy.prototype,"manifold",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],Hy.prototype,"overlayRenderer",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],Hy.prototype,"ellipsoidRadius",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],Hy.prototype,"updating",null),Object(d["a"])([Object(g["b"])({value:!1})],Hy.prototype,"renderingDisabled",null),Object(d["a"])([Object(g["b"])()],Hy.prototype,"renderPatchBorders",null),Object(d["a"])([Object(g["b"])()],Hy.prototype,"cullBackFaces",null),Object(d["a"])([Object(g["b"])({value:1})],Hy.prototype,"renderOrder",null),Object(d["a"])([Object(g["b"])()],Hy.prototype,"wireframe",null),Hy=Object(d["a"])([Object(y["a"])("esri.views.3d.terrain.TerrainRenderer")],Hy);var Ny=Hy;function qy(e,t,i){return 0===e.patches.length?-i:0===t.patches.length?i:Object(Vg["c"])(e.patches.data[0],t.patches.data[0],i)}function Wy(e,t,i){const r=e[0]*t[2]+t[0],a=e[1]*t[3]+t[1],n=e[2]*t[2],s=e[3]*t[3];Object(ui["l"])(i,r,a,n,s)}const Zy=Object(kt["b"])(),$y=Object(M["e"])(),Qy=Object(M["e"])(),Xy=Object(M["e"])(),Yy=Object(M["e"])(),Ky=Object(M["e"])(),Jy="TerrainRenderer";var eO=Ny;class tO{constructor(){this.numNodes=0,this.numLeaves=0,this.numVisible=0,this.numRendered=0,this.numSplit=0,this.numMerged=0,this.numRenderedPerLevel=new Array,this.numLoadedPerLevel=new Array}}var iO=tO;class rO{constructor(){this.offset=Object(hi["b"])(),this.scale=0,this.tile=null}init(e,t,i,r){this.tile=e,this.offset[0]=t,this.offset[1]=i,this.scale=r}dispose(){this.tile=null,this.offset[0]=0,this.offset[1]=0,this.scale=0}}const aO=f["a"].getLogger("esri.views.3d.terrain.TerrainSurface"),nO=.25;let sO=class extends(Ce["a"].EventedMixin(je["a"])){constructor(e){super(e),this._elevationBounds=new dg,this._rootExtent=Object(F["l"])(),this._iteratorPool=new sp["a"](Vg["b"],e=>e.remove=()=>this._iteratorPool.release(e)),this._postorderIterator=new Vg["a"],this.pendingUpdates=!1,this._asyncWorkItems=0,this._allTilesDirty=!0,this._allTilesSorted=!0,this._visible=!1,this._usedMemory=uO,this._performanceInfo=new iO,this._viewChanged=!1,this._inFrameTask=!1,this._viewChangeUpdateDirty=!1,this._overlayOpacity=1,this._eyePosRenderSR=Object(M["e"])(),this._eyePosSurfaceSR=Object(M["e"])(),this._splitLimits=new rv,this._snapLevel=1/0,this._frustum=Et["d"].create(),this._viewProjectionMatrix=Object(kt["b"])(),this._layerViews=[new Array,new Array],this._layerIndexByUid=[new Map,new Map],this._basemapLayerViewHandles=new Map,this._handles=new we["a"],this._allTiles=new fd["a"],this._upsampleInfoPool=new sp["a"](rO),this._getElevationData={spatialReference:null,rootTiles:null},this.maxTextureScale=1.2,this.rootTiles=null,this.backgroundImage=Pe["a"],this.backgroundColor=null,this._layerViewsDirty=!1}initialize(){this._stage=this.view._stage,this._lercDecoder=Object(og["a"])(this.view.resourceController.scheduler),this._tilePool="planar"===this.manifold?new sp["a"](kv):new sp["a"](zv);const e=this.view.resourceController.memoryController;this._upsampleMapCache=e.getMemCache("esri.views.3d.terrain.upsample",e=>e.unloadMapData()),this._elevationQueryCache=new lg(e.getMemCache("elevation-query")),this._set("overlayManager",new Cg({surface:this})),this._handles.add([this.watch("overlayManager.hasHighlights",e=>this._renderer.setNeedsHighlight(e)),this.watch("overlayManager.rendersOccluded",e=>this._renderer.setRenderOccludedOverlay(e))],"overlayManager"),this._renderer=new eO({manifold:this.manifold,overlayRenderer:this.overlayManager.renderer,ellipsoidRadius:Object(V["e"])(this.view.spatialReference).radius}),this._renderer.install(this.view._stage),this._handles.add([Object(L["a"])(this,"baseOpacity",e=>{this._handleLayerViewChanges(),this._updateBaseOpacity(e)},!0),Object(L["a"])(this,"_background",()=>{this._handleLayerViewChanges(),this._renderer.setTileBackground(this._background)},!0),this.view.watch("pointsOfInterest",e=>{this._renderer.pointsOfInterest=e,this._handles.remove("poi"),e&&this._handles.add(e.focus.watch("renderLocation",()=>this._allTilesSorted=!1),"poi")}),Object(L["a"])(dd["a"],"TERRAIN_TILE_TREE_SHOW_TILES",e=>{e&&!this._treeDebugger?i.e("chunk-5d24f1e4").then(i.bind(null,"2944")).then(({TerrainTileTree3DDebugger:e})=>{!this._treeDebugger&&dd["a"].TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new e({view:this.view}))}):e||!this._treeDebugger||dd["a"].TERRAIN_TILE_TREE_SHOW_TILES||(this._treeDebugger.destroy(),this._treeDebugger=null)})]);const t={layers:this.view.map.allLayers,layerViews:this.view.allLayerViews,spatialReference:this.view.spatialReference};this.extentHelper=Hv(this.manifold,t),this._handles.add(Object(L["a"])(this.extentHelper,"stencilEnabledExtents",e=>this._renderer.setStencilEnabledLayerExtents(e)),"extentHelper");const r=this.view.defaultsFromMap?new sg["a"]({root:this.view.map,rootCollectionNames:this.view.defaultsFromMap.mapCollectionPaths,getChildrenFunction:e=>e.layers}):this.view.map.allLayers,a=new Yv({layers:r,extentHelper:this.extentHelper,manifold:this.manifold,viewSpatialReference:this.view.spatialReference});this._set("tilingSchemeLogic",a),this._handles.add([this.tilingSchemeLogic.watch("tilingScheme",()=>this._updateTilingSchemeAndExtent(),!0),this.tilingSchemeLogic.watch("extent",()=>this._updateTilingSchemeAndExtent(),!0)],"tilingSchemeLogic"),this._updateTilingSchemeAndExtent(),this._elevationDataRequester=this.view.resourceController.createStreamDataRequester(0),this._mapDataRequester=this.view.resourceController.createStreamDataRequester(1);const n=this.view.resourceController.scheduler;this._frameTask=n.registerTask(ud["b"].TERRAIN_SURFACE,e=>this._update(e),()=>this.updating&&this.ready&&!this.suspended),this.view.resourceController.memoryController.events.on("quality-changed",()=>this._viewChangeUpdate()),this._handles.add([this.view.on("resize",()=>this._viewChangeUpdate()),this.view.watch("state.camera",()=>this._viewChangeUpdate(),!0),this.view.watch("state.contentCamera",()=>this._viewChangeUpdate()),this.view.watch("qualitySettings.tiledSurface.lodBias",()=>this._viewChangeUpdate()),Object(L["a"])(this.view,"qualitySettings.tiledSurface.textureFadeDuration",e=>this._renderer.textureFadingEnabled=e>0),this.view.watch("lodSnapping",()=>this._viewChangeUpdate()),this.view.watch("clippingArea",()=>this._clippingChanged())]),this._handles.add(this.view.allLayerViews.on("after-changes",()=>this._layerViewsDirty=!0)),this._layerViewsDirty=!0,this._handleLayerViewChanges(),this._updateClippingExtent(),this.notifyChange("extent")}destroy(){this._frameTask.remove(),this._handles.destroy(),Object(og["b"])(this._lercDecoder),this._lercDecoder=null,this._removeAllTiles(),this._upsampleMapCache=Object(p["e"])(this._upsampleMapCache),this._elevationQueryCache=Object(p["e"])(this._elevationQueryCache),this._set("tilingSchemeLogic",Object(p["e"])(this.tilingSchemeLogic)),this.extentHelper=Object(p["e"])(this.extentHelper),this._basemapLayerViewHandles.forEach((e,t)=>this._unregisterTiledLayerView(t)),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",Object(p["e"])(this.overlayManager)),this._tilePool=Object(p["e"])(this._tilePool),dv.prune(),this._treeDebugger&&(this._treeDebugger.destroy(),this._treeDebugger=null),this._renderer.uninstall(this._stage),this._renderer=Object(p["e"])(this._renderer),this._iteratorPool=Object(p["e"])(this._iteratorPool),this._set("view",null),this._stage=null,this._upsampleInfoPool=Object(p["e"])(this._upsampleInfoPool),Object(cg["b"])(),Ug()}get renderer(){return this._renderer}get frustum(){return this._frustum}get snapLevel(){var e,t;const i=null==(e=this.view.pointsOfInterest)||null==(t=e.contentCameraOnSurface)?void 0:t.scale;if(i){const e=this.view.state.contentCamera;let t=Gl(this.view,e.eye,e.viewForward,e.up).tilt;t>90&&(t=180-t);const r=2*(t/90)**2,a=ah(this.view,i)-r;Math.abs(this._snapLevel-a)>nO&&(Math.round(a)!==Math.round(this._snapLevel)&&(this._viewChanged=!0),this._snapLevel=a)}return Math.round(this._snapLevel)}get lodSnapping(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences?1:0}get upsampleInfoPool(){return this._upsampleInfoPool}get upsampleMapCache(){return this._upsampleMapCache}get elevationQueryCache(){return this._elevationQueryCache}get mapTileRequester(){return this._mapDataRequester}get extent(){return Object(p["u"])(this._clippingExtent,this._rootExtent)}get updating(){return!!((this.pendingUpdates||this._viewChanged||this._allTilesDirty||this._asyncWorkItems>0||!this._allTilesSorted||this._renderer.updating||this._layerViewsDirty)&&this.ready&&!this.suspended||this.overlayManager.updating||this._frameTask.updating)}get ready(){return!!this.rootTiles}set renderOrder(e){this._renderer.renderOrder=e,this._set("renderOrder",e)}set skirtScale(e){this._renderer.skirtScale=e}get skirtScale(){return this._renderer.skirtScale}get spatialReference(){const e=this.tilingScheme&&this.tilingScheme.spatialReference||null;return this._getElevationData.spatialReference=e,e}get _background(){return null!=this.backgroundColor?this.backgroundColor:this.backgroundImage}set slicePlaneEnabled(e){var t;this._renderer.slicePlane=e,this._set("slicePlaneEnabled",e),null==(t=this._stage)||t.renderView.setRenderParameters({opaqueTerrain:this.opaque})}set velvetOverground(e){e!==this.velvetOverground&&(this._renderer.velvetOverground=e),this._set("velvetOverground",e)}set visible(e){e!==this._visible&&(this._visible=e,this._renderer.setVisibility(e),this.suspended=!e)}get opaque(){return this._renderer.opaque}set suspended(e){this._set("suspended",e),this._viewChangeUpdate()}intersect(e,t,i,r){this._renderer.intersect(e,t,i,r)}getElevation(e,t,i,r){const a=this._getElevationData.rootTiles;if(!a||!a.length)return null;if(0===a[0].layerInfo[0].length)return null;const n=pO;if(n[0]=e,n[1]=t,n[2]=i,!Object(z["y"])(n,r,n,this._getElevationData.spatialReference))return aO.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;for(let s of a){if(!s.containsPoint(n))continue;for(;s&&!s.rendered&&!s.isLeaf;){let e=0;n[0]>.5*(s.extent[0]+s.extent[2])&&(e+=1),n[1]<.5*(s.extent[1]+s.extent[3])&&(e+=2),s=s.children[e]}const e=s.renderData,t=e&&e.geometryState?e.geometryState.samplerData:null;return t?ug.sample(n[0],n[1],t):null}return null}get elevationBounds(){return this._elevationBounds}getScale(e){if(this.tilingScheme){if(!Object(z["t"])(e,pO,this.spatialReference))return aO.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;const t=this.rootTiles;if(t)for(let e of t)if(e.containsPoint(pO)){for(;null!=e.children[0];){let t=0;pO[0]>e.children[0].extent[2]&&(t+=1),pO[1]<e.children[0].extent[1]&&(t+=2),e=e.children[t]}return this._getLodBiasCorrectedScale(e.level)}}return 1e100}queryVisibleScaleRange(e,t,i,r){const a=t?this.tilingScheme.levelAtScale(t):0,n=i?this.tilingScheme.levelAtScale(i):1/0,s=this.lodBias;this._renderer.queryVisibleLevelRange(e,a+s,n+s,r)}_updateBaseOpacity(e){const t=this._renderer.opaque;this._renderer.opaque=e>=1,this._renderer.isTransparent=this._allTransparentSurfaceLayers();const i=t!==this._renderer.opaque;var r;i&&(null==(r=this._stage)||r.renderView.setRenderParameters({opaqueTerrain:this.opaque})),this._updateTileTextures(i)}_updateTilingSchemeAndExtent(){const e=this.tilingSchemeLogic.extent,t=e&&!Object(F["o"])(e,this._dataExtent);t&&(Object(p["k"])(this._dataExtent)?Object(F["z"])(this._dataExtent,e):this._dataExtent=Object(F["l"])(e));const i=this.tilingSchemeLogic.tilingScheme,r=i!==this.tilingScheme;r&&(Object(sb["r"])(!!i,"tiling scheme cannot be reset to undefined"),this.tilingScheme&&this._removeAllTiles(),this._set("tilingScheme",i),this._updateClippingExtent(),i&&(this._updateTiledLayers(),this._renderer.setTileSize(i.pixelSize),this.overlayManager.setSpatialReference(i.spatialReference,"spherical"===this.manifold))),(t||r)&&this._updateRootTiles()}_acquireTile(e,t,i,r){const a=this._tilePool.acquire();return mO[0]=e,mO[1]=t,mO[2]=i,a.init(mO,r,this),a}_updateRootTiles(){const e=this._clippingExtent||this._dataExtent,t=this.tilingScheme;if(Object(p["j"])(e)||!t)return;const i=fO;let r=t.rootTilesInExtent(e,i,5*Pe["j"]);const a=e=>{const t=this._acquireTile(0,e[1],e[2],null);return 2===t.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping)&&t.setPendingUpdate(2),this._loadTile(t),t};if(this.rootTiles){if(r.length>Pe["j"])return void aO.warn(Pe["k"]);const e=this.rootTiles.map(e=>e.lij),t=Object(ub["d"])(e,r,cO);if(t.removed.length>0||t.added.length>0){const e=this.rootTiles.filter(e=>!(t.removed.findIndex(cO.bind(null,e.lij))>-1)||(this._purgeTile(e),!1));t.added.forEach(t=>e.push(a(t))),this._setRootTiles(e)}}else r.length>Pe["j"]&&(aO.warn(Pe["l"]),r=t.rootTilesInExtent(e,i,Pe["j"])),this._setRootTiles(r.map(e=>a(e)));Object(F["o"])(i,this._rootExtent)||(this._rootExtent=Object(F["l"])(i),this._hasFixedExtent()||this.notifyChange("extent")),this.visible=!0,this._viewChangeUpdate(),this.overlayManager.setOverlayPlacementDirty(),this.notifyChange("ready")}_setRootTiles(e){if(this._set("rootTiles",e),this._allTiles.clear(),e){const t=this._iteratorPool.acquire();for(t.reset(e);!t.done;)this._allTiles.push(t.next());t.remove()}this._getElevationData.rootTiles=e,this._renderer.setRootTiles(this.rootTiles),this._updateTileVisibility(e)}_runViewChangeUpdateIfDirty(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())}_viewChangeUpdate(){this._stage&&!this.suspended&&this.tilingScheme&&this._visible&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateSkirts(),this.updateOverlayOpacity(),this._updateTileVisibility(this.rootTiles)))}_updateClippingStatus(e){e.updateClippingStatus(this._clippingExtent)&&e.resetPendingUpdate(32)&&this._updateTileGeometry(e)}_updateTileVisibility(e){if(!e)return;const t=this._iteratorPool.acquire();let i,r;for(t.reset(e),Object(Vg["f"])(e)?(i=this._elevationBounds.min,r=this._elevationBounds.max):(i=1/0,r=-1/0);!t.done;){const e=t.next();this._updateClippingStatus(e),e.updateVisibility(),e.setPendingUpdate(16),e.loadable?(e.updateScreenDepth(this._viewProjectionMatrix),e.renderData&&(i=Math.min(e.elevationBounds[0],i),r=Math.max(e.elevationBounds[1],r))):t.skipSubtree()}t.remove(),this._viewChanged=!0,this._allTilesDirty=!0,isFinite(i)&&isFinite(r)&&(this._elevationBounds.min===i&&this._elevationBounds.max===r||(this._elevationBounds.min=i,this._elevationBounds.max=r,this.emit("elevation-bounds-change",null)))}_updateViewDependentParameters(){const e=this.view.state.camera,t=this.view.state.contentCamera,i=Math.tan(.5*t.fovX),r=Math.tan(.5*t.fovY),a=this.tilingScheme.pixelSize,n=2**-this.lodBias*e.pixelRatio;this._splitLimits.aboveGround=e.aboveGround,this._splitLimits.fovX=i,this._splitLimits.fovY=r,this._splitLimits.relativeWidthLimit=a/e.width*this.maxTextureScale*n,this._splitLimits.relativeHeightLimit=a/e.height*this.maxTextureScale*n,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?(Object(p["j"])(this._splitLimits.frustum)&&(this._splitLimits.frustum=Et["d"].create()),Et["d"].copy(t.frustum,this._splitLimits.frustum)):this._splitLimits.frustum=null,Et["d"].copy(e.frustum,this._frustum),Object(Vt["m"])(this._viewProjectionMatrix,t.projectionMatrix,t.viewMatrix),Object(It["l"])(this._eyePosRenderSR,t.eye),Object(z["y"])(e.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)}_updateSkirts(){const e=this.view.state.camera,t=this.view.state.constraints.collision.enabled?0:1.11*e.near;this.skirtScale=Object(sb["b"])(this,this._eyePosSurfaceSR,t)}_updateRenderData(e){e.rendered&&!e.shouldLoad&&(hO(e)?this._loadChildren(e):dO(e)&&this._loadParent(e))}_updateTileGeometry(e){e.updateVisibility(),this._renderer.updateTileGeometry(e),this._elevationUpdate(e),this._usedMemory=uO}_elevationUpdate(e){gO.spatialReference=this.spatialReference,gO.tile=e,gO.extent=e.extent,this.emit("elevation-change",gO),Object(F["h"])(e.extent,this._eyePosSurfaceSR)&&this._updateSkirts()}_update(e){this._handleLayerViewChanges(e),this._frameTask.processQueue(e),this._inFrameTask=!0,this.pendingUpdates=!1,this._updateTileStatus(e),this._sortTiles(e),this._mergeAndSplit(e),e.run(()=>this._updateElevation(e)),e.run(()=>this._updateTextures(e)),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),e.done&&(this.pendingUpdates=!0)}_updateTileStatus(e){if(!this._viewChanged||!this.rootTiles||e.done)return;this._viewChanged=!1;const t=this._iteratorPool.acquire();for(t.reset(this.rootTiles);!t.done;){const e=t.next();if(e.loadable){const i=e.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping);if(2===i){e.resetPendingUpdate(8),e.isLeaf&&(e.setPendingUpdate(2),t.skipSubtree());continue}e.resetPendingUpdate(2)&&e.updateAgentSuspension(),4===i&&e.updateAgents(0)}if(t.skipSubtree(),!e.isLeaf){e.setPendingUpdate(8),e.resetPendingUpdate(2);const t=this._iteratorPool.acquire();t.resetOne(e);for(let e=t.next();!t.done;e=t.next())this._updateClippingStatus(e),e.updateVisibility(),e.loadable&&e.updateScreenDepth(this._viewProjectionMatrix);t.remove()}}t.remove(),this.pendingUpdates=!0,e.madeProgress()}_sortTiles(e){e.done||this._allTilesSorted||(Object(Vg["h"])(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),e.madeProgress())}_mergeAndSplit(e){if(this.suspended||!this._allTilesDirty||e.done)return;this._allTilesDirty=!1,this.pendingUpdates=!0;let t=0;for(;!e.done;){let i=!1;t=0;const r=!this._allTiles.some(r=>(t+=r.usedMemory,r.resetPendingUpdate(8)?(this._mergeTile(r),i=!0,e.madeProgress()):r.resetPendingUpdate(2)&&(this._splitTile(r),i=!0,e.madeProgress()),r.resetPendingUpdate(16)&&(this._updateRenderData(r),e.madeProgress()),e.done));if(i&&(this._allTilesSorted=!1,this._allTilesDirty=!0),r){if(this._usedMemory=t,!i)break}else this._allTilesDirty=!0}0===t&&(this._allTilesDirty=!0),this._sortTiles(e)}_updateElevation(e){return this._allTiles.some(t=>(t.resetPendingUpdate(32)&&(this._updateTileGeometry(t),e.madeProgress()),e.done)),e.hasProgressed}_updateTextures(e){return this._allTiles.some(t=>(t.resetPendingUpdate(64)&&(this._renderer.updateTileTexture(t),this._usedMemory=uO,e.madeProgress()),e.done)),e.hasProgressed}_updateClippingExtent(){if(!this.spatialReference)return!1;const e=Object(F["l"])();let t=null;return Object(Dp["b"])(this.view.clippingArea,e,this.spatialReference)&&(t=e),!Object(F["o"])(t,this._clippingExtent)&&(this._clippingExtent=t,this._renderer.clippingExtent=t,this.notifyChange("extent"),this.updateTileOverlayParams(),this.overlayManager.setOverlayPlacementDirty(),!0)}_clippingChanged(){this._updateClippingExtent()&&this._updateRootTiles()}get lodBias(){const e=this.view.resourceController.memoryController.memoryFactor;return this.view.qualitySettings.tiledSurface.lodBias-(1-e)*Pe["h"]}_getLodBiasCorrectedScale(e){const t=this.tilingScheme.levels,i=Object(Qe["d"])(e-this.lodBias,0,t.length-1),r=i-Math.floor(i);return t[Math.floor(i)].scale*(1-r)+t[Math.ceil(i)].scale*r}_removeAllTiles(){this.rootTiles&&(this.rootTiles.forEach(e=>this._purgeTile(e)),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this.visible=!1}_purgeChildTiles(e){if(e.isLeaf)return!1;let t=this._purgeTile(e.children[0]);return t=this._purgeTile(e.children[1])||t,t=this._purgeTile(e.children[2])||t,t=this._purgeTile(e.children[3])||t,e.unsetChildren(),t}_purgeTile(e){const t=this._purgeChildTiles(e)||e.rendered;return this._allTiles.removeUnordered(e),e.unload(this._renderer),this._tilePool.release(e),t}_splitTile(e){Object(sb["r"])(e.isLeaf,"tile that is already split should not be split again!");const t=e.level+1,i=2*e.lij[1],r=2*e.lij[2];e.setChildren(this._createTile(t,i,r,e),this._createTile(t,i,r+1,e),this._createTile(t,i+1,r,e),this._createTile(t,i+1,r+1,e)),e.setPendingUpdate(16),e.updateAgentSuspension(),this._allTiles.pushArray(e.children),this._allTilesDirty=!0,this._emitTileScaleChange(e,t),++this._performanceInfo.numSplit}_emitTileScaleChange(e,t=e.level){vO.spatialReference=this.spatialReference,vO.extent=e.extent,vO.scale=this._getLodBiasCorrectedScale(t),this.emit("scale-change",vO)}_createTile(e,t,i,r){Object(sb["r"])(!!r,"_createTile sanity check");const a=this._acquireTile(e,t,i,r);return a.updateClippingStatus(this._clippingExtent),a.loadable&&(a.updateScreenDepth(this._viewProjectionMatrix),2===a.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping)&&a.setPendingUpdate(2)),a}_mergeTile(e){Object(sb["r"])(!e.hasPendingUpdate(2),"_mergeTile sanity check"),this._purgeChildTiles(e)&&(Object(sb["r"])(!e.renderData,"_mergeTile sanity check"),this._loadTile(e)),this._allTilesDirty=!0,++this._performanceInfo.numMerged,this._emitTileScaleChange(e)}_loadChildren(e){Object(sb["r"])(e.rendered,"parent should be rendered"),e.unload(this._renderer),this._loadTile(e.children[0]),this._loadTile(e.children[1]),this._loadTile(e.children[2]),this._loadTile(e.children[3])}_loadParent(e){const t=e.parent;this._unloadChildren(t),this._loadTile(t)}_unloadChildren(e){e.isLeaf||(this._unloadChildren(e.children[0]),e.children[0].unload(this._renderer),this._unloadChildren(e.children[1]),e.children[1].unload(this._renderer),this._unloadChildren(e.children[2]),e.children[2].unload(this._renderer),this._unloadChildren(e.children[3]),e.children[3].unload(this._renderer))}_loadTile(e){e.load(this._renderer),e.setPendingUpdate(16),this.pendingUpdates=!0,this.overlayManager&&this.overlayManager.hasOverlays&&this.overlayManager.setTileParameters(e),this._elevationUpdate(e)}_elevationDataArrived(e,t,i){const r=new ug(e.lij,e.extent,i);e.dataArrived(t,0,r);const a=[e],n=e.level,s=this._iteratorPool.acquire();for(s.reset(a);!s.done;){const e=s.next();e.findElevationBoundsForLayer(t,n),e.computeElevationBounds()}s.remove(),this._updateTileVisibility(a)}_handleLayerViewChanges(e=ud["d"]){if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let t=!1;const i=new Set;let r=-1;for(const a of this.view.allLayerViews.items)if(i.add(a.uid),Object(sb["j"])(a))if(this._basemapLayerViewHandles.has(a.uid)){const e=this.layerClassFromLayerView(a),i=this._layerIndexByUid[e].get(a.uid);i<r&&(t=!0),r=i}else this._registerTiledLayerView(a),a.layer.loaded&&(t=!0);this._basemapLayerViewHandles.forEach((e,r)=>{i.has(r)||(this._unregisterTiledLayerView(r),t=!0)}),t&&this._updateTiledLayers(),this._renderer.isTransparent=this._allTransparentSurfaceLayers(),e.madeProgress()}_allTransparentSurfaceLayers(){let e=0===this.view.map.ground.opacity;for(const t of this.view.allLayerViews.items)if(Object(sb["j"])(t)&&!Object(sb["e"])(t)&&!Object(ve["b"])(t.layer)&&0!==t.fullOpacity)return e=!1,e;return e}layerClassFromLayerView(e){return Object(sb["e"])(e)?0:1}_registerTiledLayerView(e){const t=[],i=this.layerClassFromLayerView(e);t.push(e.watch("suspended",()=>this._updateTiledLayers())),t.push(e.watch("fullOpacity",()=>this._updateTileTextures(!1))),t.push(e.layer.watch("scaleRangeId",()=>this._restartAllAgents(i))),e.on("data-changed",()=>{const t=this._layerIndexByUid[i].get(e.uid);null!=t&&this._invalidateLayerData(t,i)}),this._basemapLayerViewHandles.set(e.uid,t)}_unregisterTiledLayerView(e){const t=this._basemapLayerViewHandles.get(e);if(t){for(let e=0;e<t.length;e++)t[e].remove();this._basemapLayerViewHandles.delete(e)}}_updateTiledLayers(){if(!this.tilingScheme||this.view.suspended)return;const e=this.view.allLayerViews,t=[[],[]];let i=null;const r=Object(F["n"])();e.forEach(e=>{const a=e.layer;if(!a||e.suspended||!Object(sb["j"])(e))return;const n=e.fullExtent;if(!n)return void aO.warn("Terrain: Map or elevation layer does not have fullExtent: "+a.id);if(!this.tilingScheme.compatibleWith(e.tileInfo))return void aO.warn("Terrain: tiling scheme of layer "+a.id+" is incompatible with other tiled layers, will not be drawn");Object(F["p"])(r,n);const s=this.layerClassFromLayerView(e);if(1===s){const t=e.displayLevelRange;t.maxLevel!==1/0&&(null===i||t.maxLevel>i)&&(i=t.maxLevel)}t[s].push(e)});for(const a of Pe["g"]){const e=this._layerViews[a],i=t[a];i.reverse();const r=i.length;let n=e.length!==r;const s=new Array(r),o=new Array(e.length);this._layerIndexByUid[a].clear();for(let t=0;t<r;t++){const r=i[t].uid;this._layerIndexByUid[a].set(r,t);const c=e.indexOf(i[t]);s[t]=c,t!==c&&(n=!0),c>-1&&(o[c]=t)}if(n){const e=this._postorderIterator;for(e.reset(this.rootTiles);!e.done;)e.next().modifyLayers(o,s,a);this._layerViews[a]=i,this._restartAllAgents(a),this._updateTileVisibility(this.rootTiles)}}this.tilingScheme.ensureMaxLod(i)&&this._viewChangeUpdate()}_restartAllAgents(e){const t=this._postorderIterator;for(t.reset(this.rootTiles);!t.done;){const i=t.next();i.restartAgents(e),0===e&&i.computeElevationBounds()}}_hasFixedExtent(){return!!this._clippingExtent}layerViewByIndex(e,t){return this._layerViews[t][e]}numLayers(e){return this._layerViews[e].length}_updateTileTextures(e){this._allTiles.forAll(t=>{t.updateAgents(1),e?this.renderer.updateTileTexture(t):t.updateRenderData(1)}),this._renderer.isTransparent=this._allTransparentSurfaceLayers()}_invalidateLayerData(e,t){this._allTiles.forAll(i=>i.removeLayerAgent(e,t)),this._allTiles.forAll(i=>i.invalidateLayerData(e,t))}setTileTreeDirty(){this._allTilesDirty=!0}requestRender(e=1){this.renderer.setNeedsRender(e)}requestTileData(e,t,i,r){const a=this.layerViewByIndex(t,i),n=a.layer;return!n.tilemapCache||Object(sb["m"])(a)?this._requestTileData(e,i,a,r):(++this._asyncWorkItems,n.tilemapCache.fetchAvailability(e.lij[0],e.lij[1],e.lij[2],{...r,timeout:6e3}).then(()=>--this._asyncWorkItems).catch(t=>{throw--this._asyncWorkItems,Object(j["n"])(t)||this._dataMissing(e,i,a,{notInTilemap:!0}),t}).then(()=>this._frameTask.schedule(()=>this._requestTileData(e,i,a,r),r.signal)))}_requestTileData(e,t,i,r){return 0===t?this._requestElevationTileData(e,i,r):this._requestMapTileData(e,i,r)}_requestElevationTileData(e,t,i){if(!Object(sb["e"])(t))return void Object(sb["r"])(!1,"_requestElevationTileData can only be called for elevation layer views");const r=r=>{if(--this._asyncWorkItems,Object(j["o"])(i))return;const a=this._layerIndexByUid[0].get(t.uid);null!=a?(this._usedMemory=uO,this.pendingUpdates=!0,this._elevationDataArrived(e,a,r)):aO.warn("TerrainSurface: received data from unknown layer %d %s",0,e.lij.toString())},a=i=>{--this._asyncWorkItems,Object(j["n"])(i)||(this._dataMissing(e,0,t,i),this.pendingUpdates=!0)};if(++this._asyncWorkItems,Object(sb["q"])(t.layer))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],{noDataValue:Pe["c"],signal:i.signal}).then(e=>{if(Object(j["o"])(i))return aO.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void a(Object(j["f"])());this._frameTask.schedule(()=>r(e),i.signal)},a);const n=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);return this._elevationDataRequester.request(n,"binary",i).then(e=>this._lercDecoder.decode(e,{noDataValue:Pe["c"]},i.signal)).then(e=>{r({values:e.pixelData,width:e.width,height:e.height,noDataValue:e.noDataValue,minValue:e.minValue,maxValue:e.maxValue})},a)}_requestMapTileData(e,t,i){if(t instanceof hg["default"])return Promise.reject();++this._asyncWorkItems;const r=r=>this._frameTask.schedule(()=>{--this._asyncWorkItems,this.pendingUpdates=!0,Object(j["o"])(i)?Object(sb["o"])(r):this._mapTileDataArrived(e,t,r)},i.signal).catch(e=>a(e,r)),a=(r,a=null)=>this._frameTask.schedule(()=>{--this._asyncWorkItems,Object(sb["o"])(a),Object(j["o"])(i)||(this._dataMissing(e,1,t,r),this.pendingUpdates=!0)});if(Object(sb["m"])(t)){const n=t.schemaHelper.getLevelRowColumn(e.lij);return t.tileHandler.getVectorTile(n[0],n[1],n[2],i).then(r,a)}if(Object(sb["f"])(t))return t.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then(r,a);if(Object(sb["q"])(t.layer)&&Object(sb["l"])(t))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then(e=>{if(Object(j["o"])(i))return aO.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void a(Object(j["f"])());r(e)},a);let n=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);lO(t)&&t.refreshTimestamp&&(n+=`${n.indexOf("?")>-1?"&":"?"}_ts=${t.refreshTimestamp}`);const s=t.hasMixedImageFormats?"image+type":"image";return this._mapDataRequester.request(n,s,i).then(r,a)}_mapTileDataArrived(e,t,i){const r=this._layerIndexByUid[1].get(t.uid);null!=r?e.dataArrived(r,1,i):(Object(sb["o"])(i),aO.warn("TerrainSurface: received data from unknown layer"))}_dataMissing(e,t,i,r){const a=this._layerIndexByUid[t].get(i.uid);null!=a?e.dataMissing(a,t,r):aO.warn("TerrainSurface: received data from unknown layer")}updateTileOverlayParams(){this.rootTiles&&this.overlayManager&&(this._allTiles.forAll(e=>{e.renderData&&this.overlayManager.setTileParameters(e)}),this._renderer.setNeedsRender())}updateOverlayOpacity(){if(!this.overlayManager)return;const e=this._eyePosSurfaceSR[2],t=this.overlayManager.computeOpacity(e);t!==this._overlayOpacity&&(this._overlayOpacity=t,this._renderer.overlayOpacity=t,this._renderer.setNeedsRender())}get performanceInfo(){const e=this._performanceInfo;return e.numNodes=this._allTiles.length,e.numLeaves=e.numVisible=e.numRendered=e.numLoadedPerLevel.length=e.numRenderedPerLevel.length=0,this._allTiles.forAll(t=>{t.isLeaf&&e.numLeaves++;const i=t.level;t.renderData&&(e.numLoadedPerLevel[i]=(e.numLoadedPerLevel[i]||0)+1),t.visible&&(e.numVisible++,t.rendered&&(e.numRenderedPerLevel[i]=(e.numRenderedPerLevel[i]||0)+1,e.numRendered++))}),e}getUsedMemory(){return this.tilingScheme?(this._usedMemory===uO&&(this._usedMemory=0,this._allTiles.forAll(e=>this._usedMemory+=e.usedMemory)),this._usedMemory):0}getUsedMemoryForLayerView(e){let t=0;const i=this.layerClassFromLayerView(e),r=this._layerIndexByUid[i].get(e.uid);return this._allTiles.forAll(e=>t+=e.getUsedMemoryForLayer(i,r)),t}getTile(e){if(Object(p["j"])(e))return null;const t=e.split("/").map(e=>+e);if(0===t[0])return this.rootTiles.find(e=>e.lij[1]===t[1]&&e.lij[2]===t[2]);const i=2**t[0],r=Math.floor(t[1]/i),a=Math.floor(t[2]/i);let n;if(this.rootTiles.some(e=>e.lij[1]===r&&e.lij[2]===a&&(n=e,!0)),n){let e=1<<t[0]-1;for(;n.lij[0]<t[0];){let i=t[1]&e?2:0;if((t[2]&e)>0&&i++,!n.children[i])return null;n=n.children[i],e>>=1}return Object(sb["r"])(n.lij[0]===t[0]&&n.lij[1]===t[1]&&n.lij[2]===t[2],"not the right tile?"),n}return null}get test(){const e=this;return{renderer:e._renderer,lercDecoder:e._lercDecoder,forceReload:()=>{e._mergeTile(e.rootTiles[0]),e._viewChangeUpdate()},getTiles:()=>e._allTiles.toArray(),getRenderedTiles:()=>(bO.clear(),e._allTiles.forAll(e=>{e.visible&&e.rendered&&bO.push(e)}),Object(Vg["g"])(e.renderOrder,bO),bO.toArray())}}};Object(d["a"])([Object(g["b"])()],sO.prototype,"_renderer",void 0),Object(d["a"])([Object(g["b"])()],sO.prototype,"pendingUpdates",void 0),Object(d["a"])([Object(g["b"])()],sO.prototype,"_asyncWorkItems",void 0),Object(d["a"])([Object(g["b"])()],sO.prototype,"_allTilesDirty",void 0),Object(d["a"])([Object(g["b"])()],sO.prototype,"_allTilesSorted",void 0),Object(d["a"])([Object(g["b"])()],sO.prototype,"_viewChanged",void 0),Object(d["a"])([Object(g["b"])()],sO.prototype,"_frameTask",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],sO.prototype,"snapLevel",null),Object(d["a"])([Object(g["b"])({readOnly:!0})],sO.prototype,"lodSnapping",null),Object(d["a"])([Object(g["b"])({constructOnly:!0})],sO.prototype,"view",void 0),Object(d["a"])([Object(ng["a"])("_renderer.cullBackFaces")],sO.prototype,"cullBackFaces",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0,dependsOn:[]})],sO.prototype,"extent",null),Object(d["a"])([Object(g["b"])({readOnly:!0})],sO.prototype,"updating",null),Object(d["a"])([Object(g["b"])({aliasOf:"view.map.ground.opacity"})],sO.prototype,"baseOpacity",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],sO.prototype,"overlayManager",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],sO.prototype,"manifold",void 0),Object(d["a"])([Object(g["b"])()],sO.prototype,"maxTextureScale",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],sO.prototype,"ready",null),Object(d["a"])([Object(g["b"])({value:1})],sO.prototype,"renderOrder",null),Object(d["a"])([Object(g["b"])({readOnly:!0})],sO.prototype,"rootTiles",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],sO.prototype,"spatialReference",null),Object(d["a"])([Object(g["b"])()],sO.prototype,"backgroundImage",void 0),Object(d["a"])([Object(g["b"])({type:ee["a"],aliasOf:"view.map.ground.surfaceColor"})],sO.prototype,"backgroundColor",void 0),Object(d["a"])([Object(g["b"])()],sO.prototype,"_background",null),Object(d["a"])([Object(g["b"])({value:!1})],sO.prototype,"slicePlaneEnabled",null),Object(d["a"])([Object(g["b"])({readOnly:!0})],sO.prototype,"tilingScheme",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeLocked"})],sO.prototype,"tilingSchemeLocked",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeDone"})],sO.prototype,"tilingSchemeDone",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],sO.prototype,"tilingSchemeLogic",void 0),Object(d["a"])([Object(g["b"])({value:!0})],sO.prototype,"velvetOverground",null),Object(d["a"])([Object(ng["a"])("_renderer.wireframe")],sO.prototype,"wireframe",void 0),Object(d["a"])([Object(g["b"])({value:!1})],sO.prototype,"suspended",null),Object(d["a"])([Object(g["b"])({readOnly:!0,aliasOf:"view.qualitySettings.tiledSurface.textureFadeDuration"})],sO.prototype,"textureFadeDuration",void 0),Object(d["a"])([Object(g["b"])()],sO.prototype,"_layerViewsDirty",void 0),Object(d["a"])([Object(ng["a"])("_renderer.renderPatchBorders")],sO.prototype,"renderPatchBorders",void 0),Object(d["a"])([Object(ng["a"])("_renderer.renderingDisabled")],sO.prototype,"renderingDisabled",void 0),sO=Object(d["a"])([Object(y["a"])("esri.views.3d.terrain.TerrainSurface")],sO);var oO=sO;function cO(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function lO(e){return null!=e.refreshInterval}function hO(e){return!e.isLeaf&&(e.children[0].shouldLoad||e.children[1].shouldLoad||e.children[2].shouldLoad||e.children[3].shouldLoad||hO(e.children[0])||hO(e.children[1])||hO(e.children[2])||hO(e.children[3]))}function dO(e){return e.isLeaf&&e.parent&&e.parent.shouldLoad}const uO=-1,pO=Object(Lt["c"])(),fO=Object(F["l"])(),mO=[0,0,0],bO=new fd["a"],gO={spatialReference:null,tile:null,extent:null,context:"ground"},vO={spatialReference:null,extent:null,scale:0};var yO=oO,OO=i("697e"),_O=i("70a2"),xO=i("fdc9"),jO=i("6061");let wO=class extends je["a"]{constructor(e){super(e),this._residentGeomRecords=new Map,this._dirtyGeomRecords=new Map,this.dirty=!1}commit(e){this.dirty=!1,this._dirtyGeomRecords.forEach((t,i)=>this.commitLayer(i,e))}commitLayer(e,t){const i=this._dirtyGeomRecords.get(e);i&&(i.forEach((i,r)=>{const a=this._ensureGeomRecord(e,r);i.forEach((e,i)=>{const n=e[0],s=e[1],o=e[2];let c=!1;if(2&s){const e=a.get(i);if(e){const i=e[1];if(4&o){const e=this.model.getObject(r);this.model.updateRenderGeometryTransformation(e,n,i)&&(c=!0)}c||t.updates.push({renderGeometry:i,updateType:o})}else Object(Mi["a"])(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid update")}if(4&s||c){const e=a.get(i);e?(t.removes.push(e[1]),a.delete(i),e[0].disposed&&OO["a"].pool.release(e[0])):4===s&&Object(Mi["a"])(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid remove")}if(1&s||c){const e=this.model.getObject(r),s=this.model.getRenderGeometry(e,n),o=[n,s];t.adds.push(s),a.set(i,o)}}),0===a.size&&this._residentGeomRecords.get(e).delete(r)}),0===this._residentGeomRecords.get(e).size&&this._residentGeomRecords.delete(e),this._dirtyGeomRecords.delete(e))}getResidentRenderGeometries(e,t){const i=this._residentGeomRecords.get(e);i&&i.forEach(e=>e.forEach(e=>t.push(e[1])))}_objectStateChanged(e,t){for(const i of t.geometryRecords)this._updateOrCreateDirtyRecord(t,i,null,2,0,0,2,5,e)}visibilityChanged(e){this._objectStateChanged(1,e)}highlightChanged(e){this._objectStateChanged(8,e)}occlusionChanged(e){this._objectStateChanged(16,e)}vertexAttrsUpdated(e){this._updateOrCreateDirtyRecord(e.object,e.record,null,2,0,0,2,5,2)}layerAdded(e){e.getObjects().forAll(t=>this._layerObjectAdded(e,t))}layerRemoved(e){e.getObjects().forAll(t=>this._layerObjectRemoved(e,t))}layerObjectAdded(e){this._layerObjectAdded(e.layer,e.object)}_layerObjectAdded(e,t){const i=e.id,r=t.geometryRecords;for(let a=0;a<r.length;a++)this._objectGeometryAdded(t,r[a],i)}layerObjectRemoved(e){this._layerObjectRemoved(e.layer,e.object)}layerObjectsAdded(e){for(const t of e.objects)this._layerObjectAdded(e.layer,t)}layerObjectsRemoved(e){for(const t of e.objects)this._layerObjectRemoved(e.layer,t)}_layerObjectRemoved(e,t){const i=e.id,r=t.geometryRecords;for(let a=0;a<r.length;a++)this._objectGeometryRemoved(t,r[a],i)}shaderTransformationChanged(e){const t=this._residentGeomRecords.get(e.id);t&&t.forEach((e,t)=>{const i=this.model.getObject(t);i&&i.hasVolativeTransformation()&&e.forEach(e=>{e[1].shaderTransformationChanged()})})}objectTransformation(e){const t=this._getParentLayerId(e),i=e.id;this._ensureGeomRecord(t,i).forEach(i=>{this._updateOrCreateDirtyRecord(e,i[0],t,2,0,0,2,5,4)})}objectGeometryAdded(e){this._objectGeometryAdded(e.object,e.record)}_objectGeometryAdded(e,t,i=null){this._updateOrCreateDirtyRecord(e,t,i,1,4,0,0,0)}objectGeometryRemoved(e){this._objectGeometryRemoved(e.object,e.record)}_objectGeometryRemoved(e,t,i=null){this._updateOrCreateDirtyRecord(e,t,i,4,1,2,0,0)}_updateOrCreateDirtyRecord(e,t,i,r,a,n,s,o,c){i=Object(p["u"])(i,this._getParentLayerId(e));const l=e.id,h=t.id,d=this._ensureDirtyRecord(i,l),u=d.get(h);if(u){const e=u[1];e&a?(d.delete(h),u[0].disposed&&OO["a"].pool.release(u[0])):e&n?(u[1]=r,u[2]=c):e&s?u[2]|=c:e&o||Object(Mi["a"])(!1,"ModelDirtySet.objectGeometryAdded: inconsistent state")}else d.set(h,[t,r,c]);this.dirty=this._hasDirtyGeometryRecords}_ensureGeomRecord(e,t){let i=this._residentGeomRecords.get(e);i||(i=new Map,this._residentGeomRecords.set(e,i));let r=i.get(t);return r||(r=new Map,i.set(t,r)),r}get _hasDirtyGeometryRecords(){return Object(pd["b"])(this._dirtyGeomRecords,e=>Object(pd["b"])(e,e=>e&&e.size>0))}_ensureDirtyRecord(e,t){let i=this._dirtyGeomRecords.get(e);i||(i=new Map,this._dirtyGeomRecords.set(e,i));let r=i.get(t);return r||(r=new Map,i.set(t,r)),r}_getParentLayerId(e){return Object(p["k"])(e.parentLayer)?e.parentLayer.id:Uu["a"]}formatDebugInfo(){const e=["ADD","UPD",void 0,"REM"];let t="";return this._dirtyGeomRecords.forEach((i,r)=>{i.forEach((i,a)=>{t.length>0&&(t+="\n"),t+=r+"."+a;const n=[];i.forEach(e=>{const t=e[1];n[t]||(n[t]=[]),n[t].push(e[0].geometry.id)});for(let r=0;r<n.length;r++)if(n[r]){t+=" "+e[r-1]+": ";for(let e=0;e<n[r].length;e++)t+=n[r][e]+", "}})}),t}get test(){const e=this;return{get residentLayerCount(){return e._residentGeomRecords.size},get residentObjectCount(){return Array.from(e._residentGeomRecords.values()).reduce((e,t)=>e+t.size,0)}}}};Object(d["a"])([Object(g["b"])({constructOnly:!0})],wO.prototype,"model",void 0),Object(d["a"])([Object(g["b"])()],wO.prototype,"dirty",void 0),wO=Object(d["a"])([Object(y["a"])("esri.views.3d.webgl-engine.lib.ModelDirtySet")],wO);var SO=wO,CO=SO;const TO=Mi["a"],PO=Mi["h"],AO=1e4,RO=10;let MO=class extends je["a"]{constructor(){super(),this.dirtySet=new CO({model:this}),this._id2origin=new Map,this._content=new Map}getObject(e){return this._content.get(e)}add(e){const t=e.id;TO(!this._content.has(t),"Model/Stage already contains object to be added"),this._content.set(t,e),Object(hu["b"])(e)&&this.dirtySet.layerAdded(e)}remove(e){TO(this._content.has(e.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(e.id),e.unload(),Object(hu["b"])(e)&&this.dirtySet.layerRemoved(e)}addMany(e){for(const t of e)TO(!this._content.has(t.id),"Model/Stage already contains object to be added"),this._content.set(t.id,t)}removeMany(e){for(const t of e)TO(this._content.has(t.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(t.id),t.unload()}forEachOfType(e,t){this._content.forEach(i=>{i.type===e&&t(i)})}_getOrigin(e){let t=0;const i=e[3]*RO/AO;i>1&&(t=Math.ceil(PO(i,2)));const r=2**t*AO,a=Math.round(e[0]/r),n=Math.round(e[1]/r),s=Math.round(e[2]/r),o=t+"_"+a+"_"+n+"_"+s;let c=this._id2origin.get(o);return null==c&&(c=Object(fg["a"])(a*r,n*r,s*r,o),this._id2origin.set(o,c)),c}getRenderGeometry(e,t){const i=t.geometry,r=e.getCombinedStaticTransformation(t),a=Object(Xe["j"])(r),n=t.origin,s=new jO["a"](i,t.material,null,null,i.boundingInfo,r,t.shaderTransformation,a,e.castShadow);return s.id=t.id,s.origin=n||this._getOrigin(s.boundingSphere),s.instanceParameters=t.instanceParameters,s}updateRenderGeometryTransformation(e,t,i){const r=e.getCombinedStaticTransformation(t,i.transformation);i.updateTransformation(r);const a=this._getOrigin(i.boundingSphere);return i.origin!==a}getStats(){const e={},t=Array.from(this._content.values());for(let i=0;i<5;++i)e[i]=t.filter(e=>e.type===i).length;return{contentTypes:e,dirtySet:this.dirtySet.formatDebugInfo()}}get test(){return{content:Array.from(this._content.values())}}};Object(d["a"])([Object(g["b"])({constructOnly:!0})],MO.prototype,"dirtySet",void 0),MO=Object(d["a"])([Object(y["a"])("esri.views.3d.webgl-engine.parts.Model")],MO);var EO=i("cc15"),DO=i("6df2"),IO=i("eaa4"),LO=i("0e88"),VO=i("caca"),kO=i("3544"),FO=i("8c71"),zO=i("caf1"),UO=i("cee3"),GO=i("a21b");class BO{constructor(e){this._totalCount=e,this._indexRanges=[0,e]}componentCount(){const e=this._indexRanges;let t=0;for(let i=0;i<e.length;i+=2)t+=e[i+1];return t}reset(e){"all"===e||e.length===this._totalCount?this._indexRanges=[0,this._totalCount]:this._indexRanges=HO(e)}forEachComponent(e){const t=this._indexRanges;for(let i=0;i<t.length;i+=2){const r=t[i],a=r+t[i+1];for(let t=r;t<a;t++)if(!e(t))return!1}return!0}forEachComponentRange(e){const t=this._indexRanges;for(let i=0;i<t.length;i+=2){const r=t[i];if(!e(r,r+t[i+1]))return!1}return!0}computeOffsetRanges(e){const t=new Array(this._indexRanges.length),i=this._indexRanges;for(let r=0;r<i.length;r+=2){const a=i[r],n=a+i[r+1],s=e[a],o=e[n];t[r]=s,t[r+1]=o-s}return t}}function HO(e){const t=new Array;if(0===e.length)return t;let i=e[0],r=1;for(let a=1;a<e.length;a++){const n=e[a];i+r===n?r+=1:(t.push(i),t.push(r),i=n,r=1)}return t.push(i),t.push(r),t}class NO extends _O["a"]{constructor(e,t){super(),this.pickability=null,this.highlightCounts=null,this.cachedGeometryRanges=null,this.cachedHighlightRanges=null,this.cachedDefaultRanges=null,this.offsets=Object(GO["m"])(t);const i=this.count;this.visibility=new BO(i),this.materialDataBuffer=e.getBuffer(i),this.materialDataIndices=new Uint16Array(i);for(let r=0;r<i;r++)this.materialDataIndices[r]=this.materialDataBuffer.acquireIndex()}dispose(){super.dispose();for(let e=0;e<this.count;e++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[e])}get count(){return this.offsets.length-1}get geometryRanges(){return Object(p["j"])(this.cachedGeometryRanges)&&(this.cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this.cachedGeometryRanges}get highlightRanges(){return Object(p["j"])(this.highlightCounts)?null:(this.updateCachedHighlightRanges(),this.cachedHighlightRanges)}get defaultShadowMapRanges(){return Object(p["j"])(this.highlightCounts)?this.geometryRanges:(this.updateCachedHighlightRanges(),this.cachedDefaultRanges)}highlightsDirty(){this.cachedHighlightRanges=null,this.cachedDefaultRanges=null}visibilityDirty(){this.cachedGeometryRanges=null,this.highlightsDirty()}updateCachedHighlightRanges(){if((Object(p["j"])(this.cachedHighlightRanges)||Object(p["j"])(this.cachedDefaultRanges))&&Object(p["k"])(this.highlightCounts)){const{highlightRanges:e,defaultRanges:t}=qO(this.highlightCounts,this.visibility,this.offsets);this.cachedHighlightRanges=e,this.cachedDefaultRanges=t}}}function qO(e,t,i){const r=[],a=[];let n=i.length,s=i.length;return t.forEachComponent(t=>(e[t]>0?(n!==t-1&&(r.length&&r.push(i[n+1]-r[r.length-1]),r.push(i[t])),n=t):(s!==t-1&&(a.length&&a.push(i[s+1]-a[a.length-1]),a.push(i[t])),s=t),!0)),r.length&&r.push(i[n+1]-r[r.length-1]),a.length&&a.push(i[s+1]-a[a.length-1]),{highlightRanges:r,defaultRanges:a}}var WO=NO;function ZO(e){return"function"==typeof e}const $O=1;class QO extends _O["a"]{constructor(){super(...arguments),this._bucket=null,this._bucketIndex=0}get bucketKey(){return this._bucket.key}}class XO{constructor(){this._buckets=new Map}add(e,t){const i=this._getBucket(e);t._bucket=i,t._bucketIndex=i.count,i.data.push(t),++i.statistics.added}remove(e){++e._bucket.statistics.removed;const t=e._bucket.data,i=t[t.length-1];t[e._bucketIndex]=i,i._bucketIndex=e._bucketIndex,t.pop(),e._bucket=null,e._bucketIndex=0}updateKey(e,t){this.remove(e),this.add(t,e)}getBucket(e){return this._getBucket(e).data}getPerformanceInfo(e){return this._getBucket(e).statistics}forEach(e){this._buckets.forEach(t=>e(t.data,t.key))}get count(){let e=0;return this._buckets.forEach(t=>e+=t.count),e}_getBucket(e){const t=this._buckets.get(e);if(t)return t;const i=new YO(e);return this._buckets.set(e,i),i}}class YO{constructor(e){this.key=e,this.data=new Array,this.statistics={added:0,removed:0}}get count(){return this.data.length}}class KO extends QO{get visible(){return!!(this.bucketKey&$O)}}Object(d["a"])([Object(_O["c"])()],KO.prototype,"renderable",void 0),Object(d["a"])([Object(_O["c"])()],KO.prototype,"components",void 0);var JO=KO;function e_(e,t,i,r){if(i>=t)return e;null==e&&(e=i_());const a=e.isVisibleBit;let n=e.data;const s=a_(n),o=i/s|0,c=i-s*o,l=(t-1)/s|0,h=n,d=r===a;if(!(i<h.length*s)&&d){const e=1.5,t=o+1,i=Math.ceil(h.length*e),r=l+1;let a=Math.max(t,i);a=Math.min(a,r),n=new Uint32Array(a),n.set(h)}return o<n.length&&(n[o]=n_(n[o],c,d)),e.data=n,e}function t_(e,t){if(null==e)return!0;const{isVisibleBit:i,data:r}=e,a=a_(r);return t<r.length*a?r_(i,r,t,a):!e.isVisibleBit}function i_(e=!0){return{isVisibleBit:!e,data:new Uint32Array(0)}}function r_(e,t,i,r){const a=i/r|0,n=i-a*r;return s_(t[a],n)===e}function a_(e){const t=8;return e.BYTES_PER_ELEMENT*t}function n_(e,t,i){return e&~(1<<t)|(i?1:0)<<t}function s_(e,t){return 0!=(e&1<<t)}var o_=i("1038");class c_{constructor(e,t){this._indices=Object(p["k"])(e.indices)?e.indices:Object(o_["d"])(e.positions.length/3),this._positions=new Kv["u"](e.positions),this._components=t}getComponentAabb(e,t){if(Object(p["k"])(this._perComponentAabbs)){for(let i=0;i<6;i++)t[i]=this._perComponentAabbs[6*e+i];return t}return this._computePerComponentAabbs(),this.getComponentAabb(e,t)}getComponentPositions(e,t){t.indices=this._indices,t.data=this._positions.typedBuffer,t.stride=this._positions.typedBufferStride,t.startIndex=this._components.offsets[e],t.endIndex=this._components.offsets[e+1]}intersect(e,t,i,r,a,n){const s={data:this._positions.typedBuffer,stride:this._positions.typedBufferStride,size:3},o=this._indices,c=this._components.offsets,l=Object(uv["c"])(e,t,l_);this._components.visibility.forEachComponent(h=>{if(!t_(this._components.pickability,h))return!0;const d=this.getComponentAabb(h,h_);if(Object(p["k"])(a)&&a.applyToAabb(d),!Object(uv["f"])(d,e,l,i))return!0;const u=c[h]/3,f=c[h+1]/3;return Object(uv["j"])(e,t,u,f,o,s,void 0,a,(e,t,i)=>n(h,e,Object(It["y"])(t,t,r),i)),!0})}_computePerComponentAabbs(){const e=this._components.count;this._perComponentAabbs=new Float32Array(6*e);for(let t=0;t<e;t++)this._computeAABB(t)}_computeAABB(e){const t=this._indices,i=this._positions,r=this._components.offsets,a=r[e],n=r[e+1],s=[0,0,0],o=[1/0,1/0,1/0],c=[-1/0,-1/0,-1/0];for(let h=a;h<n;h++){const e=t[h];i.getVec(e,s),Object(It["D"])(o,o,s),Object(It["E"])(c,c,s)}let l=6*e;this._perComponentAabbs[l++]=o[0],this._perComponentAabbs[l++]=o[1],this._perComponentAabbs[l++]=o[2],this._perComponentAabbs[l++]=c[0],this._perComponentAabbs[l++]=c[1],this._perComponentAabbs[l]=c[2]}get positions(){return this._positions}get indices(){return this._indices}}const l_=Object(M["e"])(),h_=Object(bu["h"])();var d_=c_;class u_ extends _O["a"]{constructor(){super(...arguments),this.meta={cameraDepthSquared:0,gpuMemoryEstimate:0}}}Object(d["a"])([Object(_O["c"])()],u_.prototype,"geometry",void 0);var p_=u_;class f_ extends _O["a"]{constructor(e,t,i,r){super(),this.primitiveType=t,this.parameters=i,this.indexed=r,this.vao=e}}Object(d["a"])([Object(_O["c"])()],f_.prototype,"vao",void 0);var m_=i("b139"),b_=i("04f0");function g_(e,t){return{near:e,far:t}}function v_(e){return e?y_(e,1/0,-1/0):g_(1/0,-1/0)}function y_(e,t,i){return e.near=t,e.far=i,e}function O_(e,t,i=e){return i.near=Math.min(e.near,t.near),i.far=Math.max(e.far,t.far),i}function __(e,t){return e.near<=t&&t<=e.far}function x_(e,t){const i=v_(),{eye:r,frustum:a,viewForward:n}=e;for(let s=0;s<t.length;s++){const e=t[s].obb,o=Object(It["i"])(Object(It["w"])(F_,e.center,r),n),c=Object(UO["k"])(e,n);if(__(i,o-c)&&__(i,o+c))continue;const l=L_(e,a);if(-1===l)continue;if(0===l){w_.far=o+c,w_.near=o-c,O_(i,w_);continue}const h=j_.pushNew();h.near=o-c,h.far=o+c,h.mask=l,h.object=t[s]}for(let s=0;s<j_.length;s++){const e=j_.data[s];__(i,e.near)&&__(i,e.far)||(w_.far=e.far,w_.near=1/0,0===E_(e.object.obb,r,T_,t=>{let i=P_;for(let r=0;r<I_&&t.length>0;r++){if(0==(e.mask&1<<r))continue;A_(a[r],t,i);const n=t;t=i,i=n}for(let e=0;e<t.length;e+=3){Object(It["x"])(S_,t.data[e+0],t.data[e+1],t.data[e+2]);const i=Object(It["i"])(Object(It["w"])(S_,S_,r),n);w_.near=Math.min(w_.near,i)}})&&(w_.near=0),O_(i,w_))}return j_.length=0,i}const j_=new fd["a"]({allocator:e=>e||{near:1/0,far:-1/0,mask:0,object:null},deallocator:e=>(e.object=null,e)}),w_=v_(),S_=Object(M["e"])(),C_=Object(M["e"])(),T_=new fd["a"]({deallocator:null}),P_=new fd["a"]({deallocator:null});function A_(e,t,i){i.length=0;const r=t.length-3;R_(S_,t,r);const a=Object(Fv["m"])(e,S_);a<=0&&(i.push(S_[0]),i.push(S_[1]),i.push(S_[2]));let n=0,s=a;for(;n<r;n+=3){R_(C_,t,n);const r=Object(Fv["m"])(e,C_);s*r<0&&(Object(It["j"])(S_,C_,S_,r/(r-s)),M_(i,S_)),r<=0&&M_(i,C_),s=r,Object(It["l"])(S_,C_)}s*a<0&&(R_(C_,t,r),Object(It["j"])(S_,C_,S_,a/(a-s)),M_(i,S_))}function R_(e,t,i){return Object(It["x"])(e,t.data[i+0],t.data[i+1],t.data[i+2])}function M_(e,t){e.push(t[0]),e.push(t[1]),e.push(t[2])}function E_(e,t,i,r){Object(b_["b"])(k_,e.quaternion),Object(It["w"])(F_,t,e.center),Object(It["v"])(F_,F_,k_);const a=8*((F_[0]<-e.halfSize[0]?-1:F_[0]>e.halfSize[0]?1:0)+3*(F_[1]<-e.halfSize[1]?-1:F_[1]>e.halfSize[1]?1:0)+9*(F_[2]<-e.halfSize[2]?-1:F_[2]>e.halfSize[2]?1:0)+13),n=D_[a];if(0===n)return n;Object(Jn["g"])(V_,e.quaternion),Object(Jn["c"])(V_,V_,e.halfSize);const s=(t,i)=>{const r=D_[a+i+1];return Object(It["x"])(t,((1&r)<<1)-1,(2&r)-1,((4&r)>>1)-1),Object(It["y"])(t,t,V_),Object(It["g"])(t,e.center,t)};return i.length=0,M_(i,s(z_,0)),M_(i,s(U_,1)),M_(i,s(F_,2)),M_(i,s(G_,3)),r(i),1===n||(i.length=0,M_(i,z_),M_(i,G_),M_(i,s(F_,4)),M_(i,s(B_,5)),r(i),2===n||(i.length=0,M_(i,z_),M_(i,B_),M_(i,s(F_,6)),M_(i,U_),r(i))),n}const D_=(()=>{const e=new Int8Array(216);let t=0;const i=i=>{for(let r=0;r<i.length;r++)e[t+r]=i[r];t+=8};return i([3,0,6,2,3,1,5,4]),i([2,0,2,3,1,5,4,0]),i([3,1,0,2,3,7,5,4]),i([2,0,1,3,2,6,4,0]),i([1,0,1,3,2,0,0,0]),i([2,1,5,7,3,2,0,0]),i([3,2,0,1,3,7,6,4]),i([2,2,0,1,3,7,6,0]),i([3,3,0,1,5,7,6,2]),i([2,0,1,5,4,6,2,0]),i([1,0,1,5,4,0,0,0]),i([2,1,3,7,5,4,0,0]),i([1,0,2,6,4,0,0,0]),i([0,0,0,0,0,0,0,0]),i([1,1,3,7,5,0,0,0]),i([2,2,3,7,6,4,0,0]),i([1,2,3,7,6,0,0,0]),i([2,3,1,5,7,6,2,0]),i([3,4,0,1,5,7,6,2]),i([2,5,7,6,4,0,1,0]),i([3,5,0,1,3,7,6,4]),i([2,4,5,7,6,2,0,0]),i([1,4,5,7,6,0,0,0]),i([2,5,1,3,7,6,4,0]),i([3,6,0,2,3,7,5,4]),i([2,6,2,3,7,5,4,0]),i([3,7,6,2,3,1,5,4]),e})(),I_=4;function L_(e,t){let i=0;for(let r=0;r<I_;r++){const a=Object(UO["g"])(e,t[r]);if(a>0)return-1;0===a&&(i|=1<<r)}return i}const V_=Object(Kn["a"])(),k_=Object(m_["a"])(),F_=Object(M["e"])(),z_=Object(M["e"])(),U_=Object(M["e"])(),G_=Object(M["e"])(),B_=Object(M["e"])();class H_{constructor(e){this._objects=e}submit(e,t){this._objects.preSubmit(t);const i=this._objects.visibleObjects;for(let r=0;r<i.length;r++){const t=i[r];t.renderable.material.submit(e,t)}}queryShadowCasterDepthRange(e){return this._objects.visibleObjects.length?x_(e,this._objects.visibleObjects):null}}var N_=i("7752"),q_=i("6a07"),W_=i("7438"),Z_=i("6a21"),$_=i("a7d7"),Q_=i("bc40"),X_=i("e66f");const Y_={DIFFUSE:0,COMPONENT_COLOR:1,NORMAL:2,EMISSION:3,OCCLUSION:4,METALLIC_ROUGHNESS:5,OVERLAY0_COLOR:2,OVERLAY1_COLOR:3,OVERLAY0_NORMAL:4,OVERLAY1_NORMAL:5,SSAO:6,SHADOW_MAP:7,PREPASS_LINEAR_DEPTH:8,LAST_FRAME_COLOR:9,TERRAIN_LINEAR_DEPTH:10,GEOMETRY_LINEAR_DEPTH:11};class K_ extends Bt["a"]{bindPass(e,t){const i=this.program;Q_["a"].bindViewProjTransform(i,t.viewTransform),Jv["a"].bindUniforms(this.program,this.configuration,t.slicePlane),0===t.identifier&&void 0!==t.ssrParams&&(t.ssrParams.lastFrameColorTextureUnit=Y_.LAST_FRAME_COLOR,t.ssrParams.linearDepthTextureUnit=Y_.PREPASS_LINEAR_DEPTH,ey["a"].bindUniforms(this.program,e,t.ssrParams)),0===t.identifier&&(i.setUniformMatrix3fv("uTransformNormal_ViewFromGlobal",t.transformNormal_ViewFromGlobal),2===t.subPass&&i.setUniform2fv("cameraNearFar",t.cameraNearFar),0!==t.subPass&&1!==t.subPass||!t.multipassTerrainParams.multipassTerrainEnabled||(this.program.setUniform2fv("cameraNearFar",t.cameraNearFar),i.setUniform2fv("inverseViewport",t.inverseViewport),t.multipassTerrainParams.terrainLinearDepthTexture&&(i.setUniform1i("terrainDepthTexture",Y_.TERRAIN_LINEAR_DEPTH),e.bindTexture(t.multipassTerrainParams.terrainLinearDepthTexture,Y_.TERRAIN_LINEAR_DEPTH))),0===t.subPass&&(t.ambientOcclusionEnabled&&t.ambientOcclusion.bind(i,Y_.SSAO),t.shadowsEnabled&&t.shadowMap.bind(i,Y_.SHADOW_MAP),t.lighting.setUniforms(this.program,t.integratedMesh))),1===t.identifier&&this.program.setUniform2fv("cameraNearFar",t.cameraNearFar),2===t.identifier&&q_["a"].bindOutputHighlight(e,this.program,t)}bindDraw(e,t){if(Q_["a"].bindModelTransform(this.program,e),this.program.setUniformMatrix3fv("uTransformNormal_GlobalFromModel",e.transformNormal_GlobalFromModel),t.isIntegratedMesh){const i=t.overlayTexScale,r=t.overlayTexOffset;this.program.setUniform4fv("overlayTexOffset",[e.toMapSpace[0]*i[0]+r[0],e.toMapSpace[1]*i[1]+r[1],e.toMapSpace[0]*i[2]+r[2],e.toMapSpace[1]*i[3]+r[3]]),this.program.setUniform4fv("overlayTexScale",[e.toMapSpace[2]*i[0],e.toMapSpace[3]*i[1],e.toMapSpace[2]*i[2],e.toMapSpace[3]*i[3]])}}bindMaterial(e,t,i){const r=this.program;r.setUniform4fv("uBaseColor",t.baseColor),r.setUniform1f("uObjectOpacity",t.objectOpacity),r.setUniform1f("textureAlphaCutoff",t.alphaCutoff),1===t.componentParameters.type?t.componentParameters.texture.bind(r,{texName:"uComponentColorTex",invDimName:"uComponentColorTexInvDim",unit:Y_.COMPONENT_COLOR}):(r.setUniform4fv("uExternalColor",t.componentParameters.externalColor),r.setUniform1i("uExternalColorMixMode",t.componentParameters.externalColorMixMode)),Object(p["k"])(t.baseColorTexture)&&t.baseColorTexture.bind(e,r,"uBaseColorTexture",Y_.DIFFUSE,"uBaseColorTextureSize"),0!==this.configuration.output&&7!==this.configuration.output||($_["b"].bindUniforms(this.program,t,this.configuration.isSchematic),Object(p["k"])(t.metallicRoughnessTexture)&&t.metallicRoughnessTexture.bind(e,r,"texMetallicRoughness",Y_.METALLIC_ROUGHNESS,"texMetallicRoughnessSize"),Object(p["k"])(t.emissionTexture)&&t.emissionTexture.bind(e,r,"texEmission",Y_.EMISSION,"texEmissionSize"),Object(p["k"])(t.occlusionTexture)&&t.occlusionTexture.bind(e,r,"texOcclusion",Y_.OCCLUSION,"texOcclusionSize"),Object(p["k"])(t.normalTexture)&&t.normalTexture.bind(e,r,"normalTexture",Y_.NORMAL,"normalTextureSize")),t.isIntegratedMesh&&(0===i.identifier&&0===i.subPass?(e.bindTexture(Object(p["t"])(t.overlayColorInner),Y_.OVERLAY0_COLOR),e.bindTexture(Object(p["t"])(t.overlayColorOuter),Y_.OVERLAY1_COLOR),e.bindTexture(Object(p["t"])(t.overlayNormalInner),Y_.OVERLAY0_NORMAL),e.bindTexture(Object(p["t"])(t.overlayNormalOuter),Y_.OVERLAY1_NORMAL),r.setUniform1i("ovInnerNormalTex",Y_.OVERLAY0_NORMAL),r.setUniform1i("ovOuterNormalTex",Y_.OVERLAY1_NORMAL)):2===i.identifier&&(e.bindTexture(Object(p["t"])(t.overlayHighlightInner),Y_.OVERLAY0_COLOR),e.bindTexture(Object(p["t"])(t.overlayHighlightOuter),Y_.OVERLAY1_COLOR)),r.setUniform1i("ovInnerColorTex",Y_.OVERLAY0_COLOR),r.setUniform1i("ovOuterColorTex",Y_.OVERLAY1_COLOR),r.setUniform1f("overlayOpacity",1))}initializeProgram(e){const t=K_.shader.get(),i=this.configuration,r=t.build({multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround,OITEnabled:0===i.transparencyPassType,output:i.output,normalType:0===i.integratedMeshMode?i.hasNormals?1:3:2,attributeColor:i.hasVertexColors,attributeTextureCoordinates:i.vertexTextureCoordinates,componentData:i.componentData,alphaDiscardMode:i.alphaDiscardMode,baseColorTexture:i.baseColorTexture,doubleSidedMode:i.doubleSidedMode,receiveAmbientOcclusion:i.receiveAmbientOcclusion,receiveShadows:i.receiveShadows,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,viewingMode:e.viewingMode,vertexDiscardMode:i.vertexDiscardMode,pbrMode:3===i.integratedMeshMode?4:i.usePBR?i.isSchematic?2:1:0,hasMetalnessAndRoughnessTexture:i.hasMetalnessAndRoughnessTexture,hasEmissionTexture:i.hasEmissionTexture,hasOcclusionTexture:i.hasOcclusionTexture,hasNormalTexture:i.hasNormalTexture,vertexTangets:!1,useOldSceneLightInterface:!1,supportsTextureAtlas:!0,doublePrecisionRequiresObfuscation:Object(Z_["b"])(e.rctx),overlayEnabled:2===i.integratedMeshMode||3===i.integratedMeshMode,ssrEnabled:i.ssrEnabled,highStepCount:!1,ellipsoidMode:i.ellipsoidMode});return new Nt["a"](e.rctx,r.generateSource("vertex"),r.generateSource("fragment"),t.attributeLocations)}setPipelineState(e){const t=this.configuration,i=0!==t.integratedMeshMode,r=3===e,a=2===e;return Object(qt["e"])({blending:0!==t.output&&7!==t.output||!t.blendingEnabled?null:r?W_["f"]:Object(W_["a"])(e),culling:J_[t.cullFace],depthTest:{func:Object(W_["b"])(e)},depthWrite:r||a?qt["d"]:null,colorWrite:qt["c"],stencilWrite:i||t.sceneHasOcludees?Sy["j"]:null,stencilTest:i?Object(Sy["d"])(1):t.sceneHasOcludees?Sy["e"]:null,polygonOffset:r||a?t.polygonOffsetEnabled?{factor:2,units:2}:null:W_["d"]})}initializePipeline(){return this.setPipelineState(this.configuration.transparencyPassType)}}K_.shader=new Gt["a"](X_["a"],()=>i.e("chunk-2d0c8f4a").then(i.bind(null,"56a4")));const J_=[];J_[0]=null,J_[2]={face:1029,mode:2305},J_[1]={face:1028,mode:2305};class ex extends Q_["a"].ModelTransform{constructor(){super(...arguments),this.transformNormal_GlobalFromModel=Object(Kn["a"])(),this.toMapSpace=Object(Lt["c"])()}}class tx extends Ht["a"]{constructor(){super(...arguments),this.output=0,this.hasVertexColors=!1,this.hasNormals=!1,this.vertexTextureCoordinates=0,this.componentData=0,this.slicePlaneEnabled=!1,this.cullFace=2,this.baseColorTexture=!1,this.receiveAmbientOcclusion=!0,this.receiveShadows=!0,this.vertexDiscardMode=0,this.doubleSidedMode=2,this.blendingEnabled=!0,this.alphaDiscardMode=1,this.integratedMeshMode=0,this.ssrEnabled=!1,this.polygonOffsetEnabled=!1,this.usePBR=!1,this.isSchematic=!1,this.hasMetalnessAndRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.sceneHasOcludees=!1,this.transparencyPassType=3,this.ellipsoidMode=1,this.multipassTerrainEnabled=!1,this.cullAboveGround=!0}}Object(d["a"])([Object(Ht["b"])({count:8})],tx.prototype,"output",void 0),Object(d["a"])([Object(Ht["b"])()],tx.prototype,"hasVertexColors",void 0),Object(d["a"])([Object(Ht["b"])()],tx.prototype,"hasNormals",void 0),Object(d["a"])([Object(Ht["b"])({count:3})],tx.prototype,"vertexTextureCoordinates",void 0),Object(d["a"])([Object(Ht["b"])({count:2})],tx.prototype,"componentData",void 0),Object(d["a"])([Object(Ht["b"])()],tx.prototype,"slicePlaneEnabled",void 0),Object(d["a"])([Object(Ht["b"])({count:3})],tx.prototype,"cullFace",void 0),Object(d["a"])([Object(Ht["b"])()],tx.prototype,"baseColorTexture",void 0),Object(d["a"])([Object(Ht["b"])()],tx.prototype,"receiveAmbientOcclusion",void 0),Object(d["a"])([Object(Ht["b"])()],tx.prototype,"receiveShadows",void 0),Object(d["a"])([Object(Ht["b"])({count:3})],tx.prototype,"vertexDiscardMode",void 0),Object(d["a"])([Object(Ht["b"])({count:3})],tx.prototype,"doubleSidedMode",void 0),Object(d["a"])([Object(Ht["b"])()],tx.prototype,"blendingEnabled",void 0),Object(d["a"])([Object(Ht["b"])({count:4})],tx.prototype,"alphaDiscardMode",void 0),Object(d["a"])([Object(Ht["b"])({count:4})],tx.prototype,"integratedMeshMode",void 0),Object(d["a"])([Object(Ht["b"])()],tx.prototype,"ssrEnabled",void 0),Object(d["a"])([Object(Ht["b"])()],tx.prototype,"polygonOffsetEnabled",void 0),Object(d["a"])([Object(Ht["b"])()],tx.prototype,"usePBR",void 0),Object(d["a"])([Object(Ht["b"])()],tx.prototype,"isSchematic",void 0),Object(d["a"])([Object(Ht["b"])()],tx.prototype,"hasMetalnessAndRoughnessTexture",void 0),Object(d["a"])([Object(Ht["b"])()],tx.prototype,"hasEmissionTexture",void 0),Object(d["a"])([Object(Ht["b"])()],tx.prototype,"hasOcclusionTexture",void 0),Object(d["a"])([Object(Ht["b"])()],tx.prototype,"hasNormalTexture",void 0),Object(d["a"])([Object(Ht["b"])()],tx.prototype,"sceneHasOcludees",void 0),Object(d["a"])([Object(Ht["b"])({count:4})],tx.prototype,"transparencyPassType",void 0),Object(d["a"])([Object(Ht["b"])({count:4})],tx.prototype,"ellipsoidMode",void 0),Object(d["a"])([Object(Ht["b"])()],tx.prototype,"multipassTerrainEnabled",void 0),Object(d["a"])([Object(Ht["b"])()],tx.prototype,"cullAboveGround",void 0);var ix=i("47f8"),rx=i("ebd5");class ax{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){if(this._dirty=!1,null!=this._parameterBlocks)for(const e of this._parameterBlocks)this[e]._setClean()}get dirty(){return this._dirty||this._checkParameterBlocksDirty()}_checkParameterBlocksDirty(){if(null==this._parameterBlocks)return!1;for(const e of this._parameterBlocks)if(this[e].dirty)return!0;return!1}}class nx{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){this._dirty=!1}get dirty(){return this._dirty}}function sx(e={}){return(t,i)=>{var r;const a=null!=(r=t._parameterCount)?r:0;if(t._parameterCount=a+1,e.vectorOps){const r=e.vectorOps;Object.defineProperty(t,i,{get(){return this[a]},set(e){const t=this[a];if(null==t)this[a]=e;else{if(r.equals(t,e))return;r.copy(t,e)}this._setDirty()}})}else Object.defineProperty(t,i,{get(){return this[a]},set(t){this[a]!==t&&(e.dispose&&this[a]&&this[a].dispose(),this[a]=t,this._setDirty())}})}}function ox(){return(e,t)=>{var i;const r=null!=(i=e._parameterCount)?i:0;e._parameterCount=r+1,e._parameterBlocks=e._parameterBlocks||[],e._parameterBlocks.push(r),Object.defineProperty(e,t,{get(){return this[r]},set(e){this[r]!==e&&(this[r]=e,this._setDirty())}})}}class cx extends ax{constructor(){super(),this.baseColor=Object(Pm["c"])(1,1,1,1),this.usePBR=!1,this.hasParametersFromSource=!1,this.mrrFactors=Object(ix["d"])(1,1,.5),this.emissiveFactor=Object(ix["d"])(0,0,0),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null,this.overlayTexOffset=Object(Lt["d"])(-1,-1,-1,-1),this.overlayTexScale=Object(Lt["d"])(0,0,0,0),this.overlayColorInner=null,this.overlayColorOuter=null,this.overlayHighlightInner=null,this.overlayHighlightOuter=null,this.overlayNormalInner=null,this.overlayNormalOuter=null,this.objectOpacity=1,this.commonMaterialParameters=new lx,this.componentParameters=new hx,this.alphaCutoff=rx["b"],this.alphaDiscardMode=1,this.isIntegratedMesh=!1,this.polygonOffsetEnabled=!1,this.ellipsoidMode=1,this.sceneHasOcludees=!1,this._techniqueConfig=new tx}dispose(e){this._technique&&(e.release(this._technique),this._technique=void 0),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null}getTechnique(e,t,i){const r=this._techniqueConfig;if(r.hasVertexColors=i.colors,r.hasNormals=i.normals,r.vertexTextureCoordinates=i.textureCoordinates,r.usePBR=this.usePBR,r.hasMetalnessAndRoughnessTexture=Object(p["k"])(this.metallicRoughnessTexture),r.hasEmissionTexture=Object(p["k"])(this.emissionTexture),r.hasOcclusionTexture=Object(p["k"])(this.occlusionTexture),r.hasNormalTexture=Object(p["k"])(this.normalTexture),r.transparencyPassType=0===t.identifier&&null!=t.transparencyPassType?t.transparencyPassType:3,r.multipassTerrainEnabled=0===t.identifier&&null!=t.multipassTerrainParams&&t.multipassTerrainParams.multipassTerrainEnabled,r.cullAboveGround=0===t.identifier&&null!=t.multipassTerrainParams&&t.multipassTerrainParams.cullAboveGround,r.ellipsoidMode=this.ellipsoidMode,this.dirty){r.componentData=this.componentParameters.type,r.cullFace=this.commonMaterialParameters.cullFace,r.doubleSidedMode=this.commonMaterialParameters.doubleSided?1:0,r.baseColorTexture=Object(p["k"])(this.baseColorTexture),r.isSchematic=this.hasParametersFromSource&&!Object(p["k"])(this.baseColorTexture);const e=this._computeWhichMaterialPass();r.blendingEnabled=1===e||2===e,r.alphaDiscardMode=this.alphaDiscardMode,r.integratedMeshMode=this.isIntegratedMesh?this.overlayColorInner||this.overlayColorOuter?this.overlayNormalInner||this.overlayNormalOuter?3:2:1:0,r.polygonOffsetEnabled=this.polygonOffsetEnabled,this._setClean()}return r.slicePlaneEnabled=t.slicePlaneEnabled&&this.commonMaterialParameters.slicePlaneEnabled,1===t.identifier?(r.output=3,r.vertexDiscardMode=0):2===t.identifier?(r.output=4,r.vertexDiscardMode=0):(2===this._computeWhichMaterialPass()?r.vertexDiscardMode=t.transparent?2:1:r.vertexDiscardMode=0,r.output=ux(t.subPass),1===t.subPass&&(r.sceneHasOcludees=t.sceneHasOcludees),0===t.subPass?(r.receiveAmbientOcclusion=t.ambientOcclusionEnabled,r.sceneHasOcludees=t.sceneHasOcludees,r.receiveShadows=t.shadowsEnabled,r.ssrEnabled=t.ssrParams.ssrEnabled):(r.receiveAmbientOcclusion=!1,r.receiveShadows=!1)),this._technique=e.repository.acquireAndReleaseExisting(K_,r,this._technique),this._technique}submit(e,t){const i=t.renderable.geometry,r=t.components,a=t.renderable.drawParameters,n=t.renderable.meta.cameraDepthSquared,s=r.geometryRanges,o=r.highlightRanges,c=r.defaultShadowMapRanges;switch(this._computeWhichMaterialPass()){case 0:e.materialOpaque.submitDraw(this,i,s,a,n);break;case 1:e.materialTransparent.submitDraw(this,i,s,a,n);break;case 2:e.materialOpaque.submitDraw(this,i,s,a,n),e.materialTransparent.submitDraw(this,i,s,a,n);break;case 3:e.materialIntegratedMesh.submitDraw(this,i,s,a,n),(this.overlayHighlightInner||this.overlayHighlightOuter)&&e.highlightIntegratedMesh.submitDraw(this,i,s,a,n)}Object(p["k"])(e.shadowMap)&&2!==this.componentParameters.castShadows&&e.shadowMap.submitDraw(this,i,s,a,n),Object(p["k"])(e.highlight)&&Object(p["k"])(o)&&e.highlight.submitDraw(this,i,o,a,n),Object(p["k"])(e.highlightShadowMap)&&2!==this.componentParameters.castShadows&&Object(p["k"])(o)&&e.highlightShadowMap.submitDraw(this,i,o,a,n),Object(p["k"])(e.defaultShadowMap)&&2!==this.componentParameters.castShadows&&Object(p["k"])(c)&&e.defaultShadowMap.submitDraw(this,i,c,a,n)}get attributeLocations(){return X_["b"]}_computeWhichMaterialPass(){return this.isIntegratedMesh?3:this.objectOpacity<1?1:0===this.componentParameters.opaqueOverride?0:this.baseColor[3]<1||0===this.alphaDiscardMode||3===this.alphaDiscardMode?1:2===this.componentParameters.transparent?0:0===this.componentParameters.transparent?1:2}}Object(d["a"])([sx({vectorOps:ui["n"]})],cx.prototype,"baseColor",void 0),Object(d["a"])([sx()],cx.prototype,"usePBR",void 0),Object(d["a"])([sx()],cx.prototype,"hasParametersFromSource",void 0),Object(d["a"])([sx({vectorOps:It["a"]})],cx.prototype,"mrrFactors",void 0),Object(d["a"])([sx({vectorOps:It["a"]})],cx.prototype,"emissiveFactor",void 0),Object(d["a"])([sx({dispose:!0})],cx.prototype,"baseColorTexture",void 0),Object(d["a"])([sx({dispose:!0})],cx.prototype,"metallicRoughnessTexture",void 0),Object(d["a"])([sx({dispose:!0})],cx.prototype,"emissionTexture",void 0),Object(d["a"])([sx({dispose:!0})],cx.prototype,"occlusionTexture",void 0),Object(d["a"])([sx({dispose:!0})],cx.prototype,"normalTexture",void 0),Object(d["a"])([sx({vectorOps:{equals:ui["g"],copy:ui["c"]}})],cx.prototype,"overlayTexOffset",void 0),Object(d["a"])([sx({vectorOps:{equals:ui["g"],copy:ui["c"]}})],cx.prototype,"overlayTexScale",void 0),Object(d["a"])([sx()],cx.prototype,"overlayColorInner",void 0),Object(d["a"])([sx()],cx.prototype,"overlayColorOuter",void 0),Object(d["a"])([sx()],cx.prototype,"overlayHighlightInner",void 0),Object(d["a"])([sx()],cx.prototype,"overlayHighlightOuter",void 0),Object(d["a"])([sx()],cx.prototype,"overlayNormalInner",void 0),Object(d["a"])([sx()],cx.prototype,"overlayNormalOuter",void 0),Object(d["a"])([sx()],cx.prototype,"objectOpacity",void 0),Object(d["a"])([ox()],cx.prototype,"commonMaterialParameters",void 0),Object(d["a"])([ox()],cx.prototype,"componentParameters",void 0),Object(d["a"])([sx()],cx.prototype,"alphaCutoff",void 0),Object(d["a"])([sx()],cx.prototype,"alphaDiscardMode",void 0),Object(d["a"])([sx()],cx.prototype,"isIntegratedMesh",void 0),Object(d["a"])([sx()],cx.prototype,"polygonOffsetEnabled",void 0),Object(d["a"])([sx()],cx.prototype,"ellipsoidMode",void 0),Object(d["a"])([sx()],cx.prototype,"sceneHasOcludees",void 0);class lx extends nx{constructor(){super(...arguments),this.doubleSided=!1,this.cullFace=2,this.slicePlaneEnabled=!0}}Object(d["a"])([sx()],lx.prototype,"doubleSided",void 0),Object(d["a"])([sx()],lx.prototype,"cullFace",void 0),Object(d["a"])([sx()],lx.prototype,"slicePlaneEnabled",void 0);class hx extends nx{constructor(){super(...arguments),this.externalColor=Object(Pm["c"])(1,1,1,1),this.externalColorMixMode=1,this.castShadows=0}get transparent(){return this.externalColor[3]<1?0:2}get opaqueOverride(){return 3===this.externalColorMixMode&&1===this.externalColor[3]?0:2}get visible(){return this.externalColor[3]>0?0:2}get type(){return 0}}Object(d["a"])([sx({vectorOps:ui["n"]})],hx.prototype,"externalColor",void 0),Object(d["a"])([sx()],hx.prototype,"externalColorMixMode",void 0),Object(d["a"])([sx()],hx.prototype,"castShadows",void 0);class dx extends nx{constructor(){super(...arguments),this.texture=null,this.transparent=2,this.opaqueOverride=2,this.castShadows=2}get type(){return 1}}function ux(e){switch(e){case 0:return 0;case 1:return 7;case 2:return 1;case 3:return 2;case 4:return 8}}Object(d["a"])([sx()],dx.prototype,"texture",void 0),Object(d["a"])([sx()],dx.prototype,"transparent",void 0),Object(d["a"])([sx()],dx.prototype,"opaqueOverride",void 0),Object(d["a"])([sx()],dx.prototype,"castShadows",void 0);class px{constructor(e){this._low=Object(ix["c"])(),this._high=Object(ix["c"])(),e&&this.set(e)}get low(){return this._low}get high(){return this._high}set(e){const t=this._low,i=this._high;Object(It["l"])(t,e),Object(It["w"])(i,e,t)}setElements(e,t,i){Object(It["x"])(fx,e,t,i),this.set(fx)}get(e){return Object(It["g"])(e,this._low,this._high)}getLowScaled(e){return Object(It["f"])(e,this._low,1)}}const fx=Object(M["e"])();class mx{constructor(e){this.maxCount=e,this._nextIndex=0,this.recycledIndices=[]}get activeCount(){return this._nextIndex-this.recycledIndices.length}get availableCount(){return this.recycledIndices.length+this.maxCount-this._nextIndex}acquire(){return this.recycledIndices.length>0?this.recycledIndices.pop():this.availableCount?this._nextIndex++:void 0}release(e){this.recycledIndices.push(e)}}class bx{constructor(e,t=1){this.rctx=e,this.fieldCount=t,this.textureWidth=4096,this.dirty=!0,this.texture=new ti["a"](this.rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,width:this.textureWidth,height:1,flipped:!1}),this.data=new Kv["J"](new ArrayBuffer(4*this.textureWidth))}dispose(){this.texture.dispose(),this.texture=void 0,this.data=void 0}setData(e,t,i,r,a,n){const s=e*this.fieldCount+t;this.dirty=!0,this.data.set(s,0,i),this.data.set(s,1,r),this.data.set(s,2,a),this.data.set(s,3,n)}setDataElement(e,t,i,r){const a=e*this.fieldCount+t;this.dirty=!0,this.data.set(a,i,r)}resizeToFit(e){const t=e*this.fieldCount;if(t>=this.data.count){const e=Math.ceil((t+1)/this.textureWidth)*this.textureWidth,i=new Kv["J"](new ArrayBuffer(4*e));i.typedBuffer.set(this.data.typedBuffer),this.data=i}}updateTexture(){if(!this.dirty)return;const e=this.texture.descriptor.width,t=this.texture.descriptor.height;this.data.count>e*t&&this.texture.resize(e,this.data.count/e),this.texture.setData(this.data.typedBuffer),this.dirty=!1}bind(e,t){this.rctx.bindTexture(this.texture,t.unit),e.setUniform1i(t.texName,t.unit),e.setUniform2f(t.invDimName,1/this.texture.descriptor.width,1/this.texture.descriptor.height)}}const gx=65536;class vx{constructor(e,t=1){this.textureBuffer=new bx(e,t),this.indexManager=new mx(gx)}dispose(){this.textureBuffer.dispose(),this.textureBuffer=void 0}get availableCount(){return this.indexManager.availableCount}get activeCount(){return this.indexManager.activeCount}acquireIndex(){const e=this.indexManager.acquire();return this.textureBuffer.resizeToFit(e),e}releaseIndex(e){this.indexManager.release(e)}}class yx{constructor(e,t=1){this.rctx=e,this.fieldCount=t,this.buffers=[]}garbageCollect(){this.buffers=this.buffers.filter(e=>0!==e.activeCount||(e.dispose(),!1))}destroy(){this.buffers.forEach(e=>e.dispose()),this.buffers=[]}getBuffer(e){for(const i of this.buffers)if(i.availableCount>=e)return i;if(e>gx)return null;const t=new vx(this.rctx,this.fieldCount);return this.buffers.push(t),t}updateTextures(){for(const e of this.buffers)e.textureBuffer.updateTexture()}}const Ox=f["a"].getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");class _x{constructor(e){this._renderManager=e,this._objects=new XO,this._renderSubmit=new H_(this),this._renderManager.register(this._renderSubmit),this._componentBufferManager=new yx(e.rctx)}dispose(){Object(Mi["a"])(0===this._objects.count,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy()}createObject(e){const t=new JO;return t.toMapSpace=e.toMapSpace.slice(),t.transform=e.transform,t.obb=Object(UO["b"])(e.obb),t.components=new WO(this._componentBufferManager,e.geometry.componentOffsets),t.renderable=this._createRenderable(e,t.components),t.intersectionGeometry=new d_(e.geometry.positionData,t.components),this._objects.add(e.visible?$O:0,t),t}destroyObject(e){const t=e;this._objects.remove(t),t.dispose(),this._notifyDirty()}setObjectVisibility(e,t){const i=e;if(t!==i.visible){const e=t?i.bucketKey|$O:i.bucketKey&~$O;this._objects.updateKey(i,e),this._notifyDirty()}}preSubmit(e){const t=e.camera.eye;this._objects.forEach((e,i)=>{i&$O&&e.forEach(e=>{const i=Object(It["m"])(t,e.obb.center);e.renderable.meta.cameraDepthSquared=i})})}getMaterial(e){return e.renderable.material}updateMaterial(e,t){const i=e.renderable.material;t(i),i.dirty&&this._notifyDirty()}setAllComponentVisibilities(e,t){const i=e;i.components.visibility.reset(t),i.components.visibilityDirty(),this._notifyDirty()}forEachVisibleComponent(e,t){return e.components.visibility.forEachComponent(t)}getComponentCount(e){const t=e,i=t.components.visibility.componentCount();return{visible:i,invisible:t.components.count-i}}setComponentData(e,t){const i=e,r=i.renderable.material;if(ZO(t)){const e=i.components,a=e.materialDataBuffer,n=e.materialDataIndices,s={castShadows:!0,pickable:!0,externalColor:Object(Pm["b"])(),externalColorMixMode:1},o=a.textureBuffer,c=new Uint8Array(4),l=new Uint32Array(c.buffer);let h=0,d=0,u=0,p=!1,f=0;for(let i=0;i<e.count;i++)t(i,s),h+=+(s.externalColor[3]<1),d+=+(3===s.externalColorMixMode&&1===s.externalColor[3]),u+=+s.castShadows,Object(zO["a"])(s.externalColor,s.externalColorMixMode,c),c[2]=254&c[2]|+s.castShadows,o.setData(n[i],0,c[0],c[1],c[2],c[3]),p=p||i>0&&f!==l[0],f=l[0],s.pickable!==t_(e.pickability,i)&&(e.pickability=e_(e.pickability,e.count,i,s.pickable));p?(r.componentParameters=new dx,r.componentParameters.castShadows=jx(u,e.count),r.componentParameters.transparent=jx(h,e.count),r.componentParameters.opaqueOverride=jx(d,e.count),r.componentParameters.texture=o,o.updateTexture()):(r.componentParameters=new hx,r.componentParameters.castShadows=s.castShadows?0:2,r.componentParameters.externalColor=s.externalColor,r.componentParameters.externalColorMixMode=s.externalColorMixMode)}else r.componentParameters=new hx,r.componentParameters.castShadows=t.castShadows?0:2,r.componentParameters.externalColor=t.externalColor,r.componentParameters.externalColorMixMode=t.externalColorMixMode;this._notifyDirty()}getComponentAabb(e,t,i){return e.intersectionGeometry.getComponentAabb(t,i)}getComponentObb(e){return e.obb}getObjectTransform(e){return e.transform}getComponentPositions(e,t,i){return e.intersectionGeometry.getComponentPositions(t,i)}intersect(e,t,i,r,a,n){const s=e;Object(p["k"])(a)&&(a.localOrigin=s.transform.position);const o=Object(Jn["d"])(wx,s.transform.rotationScale);Object(It["w"])(Sx,t,s.transform.position),Object(It["w"])(Cx,i,s.transform.position),Object(It["y"])(Sx,Sx,o),Object(It["y"])(Cx,Cx,o);const c=Object(Jn["n"])(wx,o);return s.intersectionGeometry.intersect(Sx,Cx,r,c,a,n)}addEdges(e,t,i,r){const a=e,{indices:n,positions:s}=a.intersectionGeometry,o=a.components.offsets;return t.addComponentObject(e,a.transform,a.obb.center,s,n,o,i,r)}addComponentHighlight(e,t){const i=e.components;Object(p["j"])(i.highlightCounts)&&(i.highlightCounts=new Uint32Array(i.count+1)),0===i.highlightCounts[t]++&&(i.highlightsDirty(),this._notifyDirty()),i.highlightCounts[i.count]++}removeComponentHighlight(e,t){const i=e.components;if(Object(p["j"])(i.highlightCounts))return void Ox.warn("Removing non-existing highlight.");const r=i.highlightCounts[t],a=i.highlightCounts[i.count];if(0!==r){if(r>1)return i.highlightCounts[t]=r-1,void(i.highlightCounts[i.count]=a-1);i.highlightCounts[t]=0,i.highlightsDirty(),this._notifyDirty(),1===a?i.highlightCounts=null:i.highlightCounts[i.count]=a-1}else Ox.warn("Removing non-existing highlight.")}clearHighlights(e){const t=e.components;Object(p["k"])(t.highlightCounts)&&(t.highlightCounts=null,t.highlightsDirty(),this._notifyDirty())}getObjectGPUMemoryUsage(e){return e.renderable.meta.gpuMemoryEstimate}get visibleObjects(){return this._objects.getBucket($O)}get performanceInfo(){const e=this._objects.getPerformanceInfo($O);return{shown:e.added,hidden:e.removed}}_createRenderable(e,t){const i=this._renderManager.rctx,r=e.geometry,a=r.vertices.layoutParameters,n=ei["a"].createVertex(i,35044,r.vertices.data),s=Object(p["c"])(r.indices,e=>ei["a"].createIndex(i,35044,e)),o=Object(Xt["a"])(Object(N_["a"])(a)),c=new Uint16Array(r.vertices.count);for(let g=0;g<t.count;g++){const e=t.offsets[g],i=t.offsets[g+1],a=t.materialDataIndices[g];if(Object(p["k"])(r.indices))for(let t=e;t<i;t++)c[r.indices[t]]=a;else for(let t=e;t<i;t++)c[t]=a}const l=ei["a"].createVertex(i,35044,c.buffer),h=new px(e.transform.position),d=Object(FO["a"])(e.transform.rotationScale);Object(Jn["d"])(d,d),Object(Jn["n"])(d,d);const u=new ex;Object(It["l"])(u.worldFromModel_TL,h.low),Object(It["l"])(u.worldFromModel_TH,h.high),Object(Jn["e"])(u.worldFromModel_RS,e.transform.rotationScale),Object(Jn["e"])(u.transformNormal_GlobalFromModel,d),Object(ui["c"])(u.toMapSpace,e.toMapSpace);const f=new cx,m=new ri["a"](i,f.attributeLocations,{data:o,componentIndices:xx},{data:n,componentIndices:l},Object(p["t"])(s)),b=new p_;return b.material=f,b.drawParameters=u,b.geometry=new f_(m,r.primitiveType,a,Object(p["k"])(s)),b.meta.cameraDepthSquared=.5,b.meta.gpuMemoryEstimate=n.byteSize+l.byteSize+(Object(p["k"])(s)?s.byteSize:0),b}_notifyDirty(){this._renderManager.notifyDirty()}}const xx=Object(Xt["a"])(Object(Yt["a"])().u16("componentIndex"));function jx(e,t){return e===t?0:0===e?2:1}const wx=Object(FO["b"])(),Sx=Object(M["e"])(),Cx=Object(M["e"])();var Tx=i("e508");class Px extends Bt["a"]{initializeProgram(e){const t=Px.shader.get().build(this.configuration);return new Nt["a"](e.rctx,t.generateSource("vertex"),t.generateSource("fragment"),zt["a"])}initializePipeline(){if(2===this.configuration.function)return Object(qt["e"])({colorWrite:{r:!1,g:!0,b:!1,a:!1}});switch(this.configuration.alphaMode){case 0:return Object(qt["e"])({colorWrite:qt["c"]});case 1:return Object(qt["e"])({blending:Object(qt["f"])(770,1,771,771),colorWrite:qt["c"]});default:return Object(qt["e"])({blending:Object(qt["g"])(1,771),colorWrite:qt["c"]})}}}Px.shader=new Gt["a"](Tx["a"],()=>i.e("chunk-2d217e1d").then(i.bind(null,"c92c")));class Ax extends Ht["a"]{constructor(){super(...arguments),this.function=0,this.alphaMode=0,this.hasOpacityFactor=!1}}Object(d["a"])([Object(Ht["b"])({count:4})],Ax.prototype,"function",void 0),Object(d["a"])([Object(Ht["b"])({count:3})],Ax.prototype,"alphaMode",void 0),Object(d["a"])([Object(Ht["b"])()],Ax.prototype,"hasOpacityFactor",void 0);class Rx{constructor(e,t){this._rctx=e,this._techniqueRepository=t,this._techniques=new Set}dispose(){this._techniques.forEach(e=>this._techniqueRepository.release(e)),this._techniques.clear(),Object(p["k"])(this._vao)&&(this._vao.dispose(),this._vao=null)}composite(e,t=0,i=1){this.compositeInternal(e,t,i,0)}compositeTransparent(e,t,i,r=1){const a=this._rctx;Mx.alphaMode=1,Mx.function=3,Mx.hasOpacityFactor=1!==r;const n=this._techniqueRepository.acquire(Px,Mx);a.bindProgram(n.program),n.bindPipelineState(a),n.program.setUniform1i("colorTexture",1),a.bindTexture(e,1),n.program.setUniform1i("alphaTexture",2),a.bindTexture(t,2),n.program.setUniform1i("frontFaceTexture",3),a.bindTexture(i,3);const s=this.ensureVAO();a.bindVAO(s),a.drawArrays(5,0,Object(ii["f"])(s,"geometry")),this._techniqueRepository.release(n)}compositeSpecial(e,t){this.compositeInternal(e,0,1,t)}compositeInternal(e,t,i,r){const a=this._rctx;Mx.alphaMode=t,Mx.function=r,Mx.hasOpacityFactor=1!==i;const n=this._techniqueRepository.acquire(Px,Mx);a.bindProgram(n.program),n.bindPipelineState(a),n.program.setUniform1i("tex",1),Mx.hasOpacityFactor&&n.program.setUniform1f("opacity",i),a.bindTexture(e,1);const s=this.ensureVAO();a.bindVAO(s),a.drawArrays(5,0,Object(ii["f"])(s,"geometry")),this._techniqueRepository.release(n)}ensureVAO(){return Object(p["j"])(this._vao)&&(this._vao=Object(Ii["d"])(this._rctx)),this._vao}}const Mx=new Ax;var Ex=Rx;const Dx=1e4,Ix=100,Lx=500,Vx=500,kx=.1;function Fx(e,t,i){return Object(Mi["n"])(t,e)*(i[1]-i[0])+i[0]}function zx(e,t,i){if(t.size<Dx)return ej.compute(e,t);const r=v_();return i.forAll(t=>{t.isVisible&&O_(r,Ux(e,t))}),r}function Ux(e,t){if(!t.isVisible)return;const i=v_(),r=t.getObjects(),a=t.getSpatialQueryAccelerator();return Object(p["k"])(a)?Gx(i,e,a):Bx(i,e,r),i}function Gx(e,t,i){const r=t.eye,a=t.viewForward,n=t.frustum,s=e=>e.isVisible,o=i.objectCount;if(o<Lx)y_(Kx,t.near,Math.min(e.near,t.far)),i.forEachInDepthRange(r,a,"front-to-back",Kx,(i,r)=>{Hx(e,t,i),Kx.far=e.near,r.setRange(Kx)},n,s),y_(Kx,Math.max(e.far,t.near),t.far),i.forEachInDepthRange(r,a,"back-to-front",Kx,(i,r)=>{Hx(e,t,i),Kx.near=e.far,r.setRange(Kx)},n,s);else{const r=Math.max(Math.min(o,Vx),Math.ceil(o*kx)),c=i.findClosest(a,"front-to-back",n,s,r),l=i.findClosest(a,"back-to-front",n,s,r);c&&l&&(qx(e,t,c.getBounds()),qx(e,t,l.getBounds()))}}function Bx(e,t,i){Jx.clear(),i.forAll(e=>{e.isVisible&&0!==e.getNumGeometryRecords()&&Jx.add(e)}),Jx.empty||(Jx.sort(t),y_(Kx,t.near,Math.min(e.near,t.far)),Jx.forEachInDepthRange(Kx,"front-to-back",(i,r)=>{r<e.near&&Hx(e,t,i)}),y_(Kx,Math.max(e.far,t.near),t.far),Jx.forEachInDepthRange(Kx,"back-to-front",(t,i,r)=>{e.far=Math.max(e.far,r)}))}function Hx(e,t,i){if(!i.isVisible)return;if(!Et["d"].intersectsSphere(t.frustum,i.getBounds()))return;const r=i.transformation,a=Yx;i.geometryRecords.forEach(i=>{Object(Vt["m"])(a,r,i.getShaderTransformation());const n=Object(Xe["j"])(a);Nx(e,t,i.geometry.boundingInfo,a,n)})}function Nx(e,t,i,r,a){if(Object(p["j"])(i))return;const n=t.eye,s=t.viewForward;Object(It["n"])(Xx,i.center,r);const o=s[0]*(Xx[0]-n[0])+s[1]*(Xx[1]-n[1])+s[2]*(Xx[2]-n[2]);if(Xx[3]=i.radius*a,!(o-Xx[3]>e.near&&o+Xx[3]<e.far)&&Et["d"].intersectsSphere(t.frustum,Xx))if(i.radius>Ix&&i.getChildren()){const n=i.getChildren();for(let i=0;i<8;++i)n[i]&&Nx(e,t,n[i],r,a)}else tj.unionDepthRangeWithAABB(e,t.viewProjectionMatrix,r,i.bbMin,i.bbMax)}function qx(e,t,i){const r=t.eye,a=t.viewForward,n=(i[0]-r[0])*a[0]+(i[1]-r[1])*a[1]+(i[2]-r[2])*a[2];e.near=Math.min(e.near,n-i[3]),e.far=Math.max(e.far,n+i[3])}class Wx{constructor(){this._items=new fd["a"]({allocator:e=>e||{obj:null,distance:0,near:0,far:0},deallocator:e=>(e.obj=null,e.distance=0,e.near=0,e.far=0,e)})}get length(){return this._items.length}get empty(){return 0===this._items.length}clear(){this._items.clear()}add(e){this._items.pushNew().obj=e}sort(e){const t=e.eye,i=e.viewForward;this._items.forAll(e=>{const r=e.obj.getBounds(),a=(r[0]-t[0])*i[0]+(r[1]-t[1])*i[1]+(r[2]-t[2])*i[2];e.distance=a,e.near=a-r[3],e.far=a+r[3]}),this._items.sort((e,t)=>e.distance-t.distance)}forEachInDepthRange(e,t,i){if("front-to-back"===t)for(let r=0;r<this._items.length;++r){const t=this._items.data[r];t.far<e.near||t.near>e.far||i(t.obj,t.near,t.far)}else for(let r=this._items.length-1;r>=0;--r){const t=this._items.data[r];t.far<e.near||t.near>e.far||i(t.obj,t.near,t.far)}}}class Zx{constructor(){this.view=Object(kt["b"])(),this.viewProj=Object(kt["b"])(),this.frustum=Et["d"].create(),this.geometries=[],this.near=[],this.far=[],this.nearCandidates=[],this.farCandidates=[],this.range={near:0,far:0},this.looseRange={near:0,far:0}}compute(e,t){this.reset(),Object(Vt["c"])(this.view,e.viewMatrix),Object(Vt["m"])(this.viewProj,e.projectionMatrix,this.view),Et["d"].copy(e.frustum,this.frustum);const i=this.view,r=i[2],a=i[6],n=i[10],s=i[14],o=this.range;let c=0;if(t.forEach(e=>{if(!e.instanceParameters.visible)return;if(!e.castShadow)return;let t;e.hasShaderTransformation?(e.computeBoundingSphere(e.getShaderTransformation(),1,Xx),t=Xx):t=e.boundingSphere;const i=r*t[0]+a*t[1]+n*t[2]+s,o=i-t[3],l=i+t[3];this.geometries[c]=e,this.near[c]=-l,this.far[c]=-o,++c}),0===this.geometries.length)return o;for(let u=0;u<this.geometries.length;++u)this.near[u]>o.far&&(o.far=this.near[u]),this.near[u]>2&&this.far[u]<o.near&&(o.near=this.far[u]);const l=this.looseRange;l.near=Math.max(.5*o.near,2),l.far=2*o.far;let h=0,d=0;for(let u=0;u<this.geometries.length;++u)this.near[u]<o.near&&(this.near[u]>=l.near?o.near=this.near[u]:this.nearCandidates[h++]=u),this.far[u]>o.far&&(this.far[u]<=l.far?o.far=this.far[u]:this.farCandidates[d++]=u);if(0===this.nearCandidates.length&&0===this.farCandidates.length)return o;this.nearCandidates.sort((e,t)=>this.near[e]<this.near[t]?-1:this.near[e]>this.near[t]?1:0),this.farCandidates.sort((e,t)=>this.far[e]<this.far[t]?1:this.far[e]>this.far[t]?-1:0);for(let u=0;u<this.nearCandidates.length;++u){const e=this.nearCandidates[u];if(this.near[e]<o.near){const t=this.geometries[e],i=t.boundingInfo;this.includeNearBoundingInfoRec(i,t.getShaderTransformation())}}for(let u=0;u<this.farCandidates.length;++u){const e=this.farCandidates[u];if(this.far[e]>o.far){const t=this.geometries[e],i=t.boundingInfo;this.includeFarBoundingInfoRec(i,t.getShaderTransformation())}}return o}reset(){this.geometries.length=0,this.near.length=0,this.far.length=0,this.nearCandidates.length=0,this.farCandidates.length=0,this.range.near=Number.MAX_VALUE,this.range.far=-Number.MAX_VALUE}includeNearBoundingInfoRec(e,t){if(Object(p["j"])(e))return;const i=e.getCenter();Object(It["n"])(Xx,i,t);const r=Object(Xe["j"])(t),a=Xx[0],n=Xx[1],s=Xx[2],o=e.getBSRadius()*r,c=this.frustum;if(c[0][0]*a+c[0][1]*n+c[0][2]*s+c[0][3]>o||c[1][0]*a+c[1][1]*n+c[1][2]*s+c[1][3]>o||c[2][0]*a+c[2][1]*n+c[2][2]*s+c[2][3]>o||c[3][0]*a+c[3][1]*n+c[3][2]*s+c[3][3]>o)return;const l=this.view[2]*a+this.view[6]*n+this.view[10]*s+this.view[14],h=l+o;if(!(-(l-o)<2||-h>=this.range.near))if(-h>this.looseRange.near)this.range.near=-h;else{if(o>Ix){const i=e.getChildren();if(void 0!==i){for(let e=0;e<8;++e)void 0!==i[e]&&this.includeNearBoundingInfoRec(i[e],t);return}}tj.unionDepthRangeWithAABB(this.range,this.viewProj,t,e.getBBMin(),e.getBBMax())}}includeFarBoundingInfoRec(e,t){if(Object(p["j"])(e))return;let i=e.getBSRadius();const r=e.getCenter();Object(It["n"])(Xx,r,t);const a=Object(Xe["j"])(t),n=Xx[0],s=Xx[1],o=Xx[2];i*=a;const c=this.frustum;if(c[0][0]*n+c[0][1]*s+c[0][2]*o+c[0][3]>i||c[1][0]*n+c[1][1]*s+c[1][2]*o+c[1][3]>i||c[2][0]*n+c[2][1]*s+c[2][2]*o+c[2][3]>i||c[3][0]*n+c[3][1]*s+c[3][2]*o+c[3][3]>i)return;const l=this.view[2]*n+this.view[6]*s+this.view[10]*o+this.view[14]-i;if(!(-l<=this.range.far))if(-l<this.looseRange.far)this.range.far=-l;else{if(i>Ix){const i=e.getChildren();if(void 0!==i){for(let e=0;e<8;++e)void 0!==i[e]&&this.includeFarBoundingInfoRec(i[e],t);return}}tj.unionDepthRangeWithAABB(this.range,this.viewProj,t,e.getBBMin(),e.getBBMax())}}}class $x{constructor(){this.modelViewProj=Object(kt["b"])(),this.clipPosition=[Object(Lt["c"])(),Object(Lt["c"])(),Object(Lt["c"])(),Object(Lt["c"])(),Object(Lt["c"])(),Object(Lt["c"])(),Object(Lt["c"])(),Object(Lt["c"])()]}unionDepthRangeWithAABB(e,t,i,r,a){const n=this.modelViewProj;Object(Vt["m"])(n,t,i);let s=!1;for(let o=0;o<8;++o){const e=this.clipPosition[o],t=0===o||3===o||4===o||7===o?r[0]:a[0],i=0===o||1===o||4===o||5===o?r[1]:a[1],s=o<4?r[2]:a[2];e[0]=n[0]*t+n[4]*i+n[8]*s+n[12],e[1]=n[1]*t+n[5]*i+n[9]*s+n[13],e[2]=n[2]*t+n[6]*i+n[10]*s+n[14],e[3]=n[3]*t+n[7]*i+n[11]*s+n[15]}for(let o=0;o<12;++o){const t=this.clipPosition[Qx[o][0]],i=this.clipPosition[Qx[o][1]],r=this.clipPosition[Qx[o][2]],a=this.clipTriangle(t,i,r);let n=!0;for(let e=0;e<a.length;++e)if(a[e][3]>=2){n=!1;break}if(!n){s=!0;for(let t=0;t<a.length;++t){const i=a[t][3];i<e.near&&(e.near=i),i>e.far&&(e.far=i)}}}return s}inside(e,t){return 0===t?e[0]>=-e[3]:1===t?e[1]>=-e[3]:2===t?e[0]<=e[3]:3===t?e[1]<=e[3]:void Object(Mi["a"])(!1)}intersect(e,t,i){let r=0;return 0===i?r=(-e[3]-e[0])/(t[0]-e[0]+t[3]-e[3]):1===i?r=(-e[3]-e[1])/(t[1]-e[1]+t[3]-e[3]):2===i?r=(e[3]-e[0])/(t[0]-e[0]-t[3]+e[3]):3===i&&(r=(e[3]-e[1])/(t[1]-e[1]-t[3]+e[3])),Object(ui["j"])(Object(Lt["c"])(),e,t,r)}clipTriangle(e,t,i){let r=[e,t,i];for(let a=0;a<4;++a){const e=r;r=[];for(let t=0;t<e.length;++t){const i=e[t],n=e[(t+1)%e.length];this.inside(n,a)?(this.inside(i,a)||r.push(this.intersect(i,n,a)),r.push(n)):this.inside(i,a)&&r.push(this.intersect(i,n,a))}}return r}}const Qx=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],Xx=Et["h"].create(),Yx=Object(kt["b"])(),Kx=v_(),Jx=new Wx,ej=new Zx,tj=new $x;var ij=i("3886"),rj=i("690a");function aj(){const e=new rj["a"];return e.attributes.add("position","vec2"),e.vertex.uniforms.add("proj","mat4"),e.vertex.uniforms.add("drawPosition","vec4"),e.varyings.add("vUV","vec2"),e.vertex.code.add(ij["a"]`
    void main(void) {
      vUV = position;
      gl_Position = vec4(drawPosition.xy + vec2(position - 0.5) * drawPosition.zw, 0.0, 1.0);
    }
  `),e.fragment.uniforms.add("textureInput","sampler2D"),e.fragment.uniforms.add("textureMask","sampler2D"),e.fragment.uniforms.add("textureOverlay","sampler2D"),e.fragment.uniforms.add("maskEnabled","bool"),e.fragment.uniforms.add("overlayEnabled","bool"),e.fragment.code.add(ij["a"]`
    const float barrelFactor = 1.1;

    vec2 barrel(vec2 uv) {
      vec2 uvn = uv * 2.0 - 1.0;

      if (uvn.x == 0.0 && uvn.y == 0.0) {
        return vec2(0.5, 0.5);
      }

      float theta = atan(uvn.y, uvn.x);
      float r = pow(length(uvn), barrelFactor);
      return r * vec2(cos(theta), sin(theta)) * 0.5 + 0.5;
    }

    void main() {
      float mask = maskEnabled ? texture2D(textureMask, vUV).a : 1.0;
      vec4 inputColor = texture2D(textureInput, barrel(vUV)) * mask;
      vec4 overlayColor = overlayEnabled ? texture2D(textureOverlay, vUV) : vec4(0);

      gl_FragColor = overlayColor + (1.0 - overlayColor.a) * inputColor;
    }
  `),e}var nj=i("5015");let sj=class extends je["a"]{constructor(){super(...arguments),this._handles=new we["a"],this._magnifier=null,this._imageSources=null,this._imageLoadTask=null,this._resources=null,this.events=new Ce["a"],this.tmpScreenPoint=Object(A["g"])(),this.tmpRenderPoint=Object(A["d"])()}get updating(){return Object(p["j"])(this._imageSources)&&Object(p["k"])(this._imageLoadTask)&&!this._imageLoadTask.task.finished}get magnifier(){return this._magnifier}set magnifier(e){if(e===this._magnifier)return;this._handles.removeAll(),this._magnifier=e;const t=()=>{this.updateResourceLoading(),this.events.emit("request-render")};Object(p["k"])(this._magnifier)&&this._handles.add(this._magnifier.watch("version",t)),t()}get enabled(){return Object(p["k"])(this._validMagnifier)}get _validMagnifier(){return Object(p["k"])(this._magnifier)&&this._magnifier.visible&&Object(p["k"])(this._magnifier.position)&&this._magnifier.size>0?this._magnifier:null}get factor(){return Object(p["k"])(this._magnifier)&&this._magnifier.factor||1}dispose(){this._magnifier=null,this._handles.destroy(),Object(p["k"])(this._imageLoadTask)&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this.disposeResources()}render(e,t){const i=this._validMagnifier;if(Object(p["j"])(i))return;const r=t.camera.pixelRatio,a=Math.ceil(r*i.size);if(this.updateResources(e,a),Object(p["j"])(this._resources))return;const n=this._resources.textures,s=Math.ceil(1/this.factor*a);n.input.resize(s,s);const o=t.camera.fullWidth,c=t.camera.fullHeight;Object(A["j"])(i.position,this.tmpScreenPoint);const l=t.camera.screenToRender(this.tmpScreenPoint,this.tmpRenderPoint),h=.5*s,d=.5*s;l[0]=Object(Qe["d"])(l[0],h,o-h-1),l[1]=Object(Qe["d"])(l[1],d,c-d-1);const u=Math.floor(l[0]-h),f=Math.floor(l[1]-d);e.bindTexture(n.input,0),e.gl.copyTexImage2D(n.input.descriptor.target,0,n.input.descriptor.pixelFormat,u,f,s,s,0);const m=i.offset.x*r,b=i.offset.y*r,g=(l[0]+m)/o*2-1,v=(l[1]-b)/c*2-1,y=a/o*2,O=a/c*2;e.bindVAO(this._resources.vao),e.bindTexture(n.overlay,1),e.bindTexture(n.mask,2);const _=this._resources.program;e.bindProgram(_),_.setUniform1i("textureInput",0),_.setUniform1i("textureOverlay",1),_.setUniform1i("textureMask",2),_.setUniform4f("drawPosition",g,v,y,O),_.setUniform1i("maskEnabled",i.maskEnabled?1:0),_.setUniform1i("overlayEnabled",i.overlayEnabled?1:0),e.setPipelineState(this._resources.pipelineState),e.drawArrays(5,0,4)}updateResourceLoading(){const e=this._validMagnifier;if(Object(p["j"])(e))return;const t=e.maskUrl,i=e.overlayUrl;!Object(p["k"])(this._imageLoadTask)||this._imageLoadTask.maskUrl===t&&this._imageLoadTask.overlayUrl===i||(this._imageLoadTask.task.abort(),this._imageLoadTask=null,this._imageSources=null),Object(p["k"])(this._imageSources)||Object(p["k"])(this._imageLoadTask)||(this._imageLoadTask={maskUrl:t,overlayUrl:i,task:Object(j["i"])(async e=>{const r=Object(p["j"])(t)||Object(p["j"])(i)?Object(nj["a"])(e):null,a=Object(p["k"])(t)?Object(Ft["a"])(t,{signal:e}):r.then(e=>e.mask),n=Object(p["k"])(i)?Object(Ft["a"])(i,{signal:e}):r.then(e=>e.overlay);this._imageSources={mask:await a,overlay:await n},this.disposeResources(),this.events.emit("request-render")})},this._imageLoadTask.task.promise.then(()=>this.notifyChange("updating"),()=>this.notifyChange("updating")))}updateResources(e,t){if(!this.enabled)return void this.disposeResources();if(Object(p["k"])(this._resources)){if(this._resources.textures.size!==t){const i=this.createTextureResources(e,t);if(Object(p["j"])(i))return void this.disposeResources();this.disposeTextureResources(this._resources.textures),this._resources.textures=i}return}const i=this.createTextureResources(e,t);Object(p["j"])(i)||(this._resources={textures:i,program:this.createProgram(e),vao:this.createVAO(e),pipelineState:Object(qt["e"])({blending:Object(qt["g"])(1,771),depthTest:null,depthWrite:null,colorWrite:qt["c"]})})}disposeResources(){Object(p["j"])(this._resources)||(this.disposeTextureResources(this._resources.textures),this._resources.program.dispose(),this._resources.vao.dispose(),this._resources=null)}disposeTextureResources(e){e.mask.dispose(),e.overlay.dispose(),e.input.dispose()}createTextureResources(e,t){if(Object(p["j"])(this._imageSources))return null;this._imageSources.overlay.width=t,this._imageSources.overlay.height=t,this._imageSources.mask.width=t,this._imageSources.mask.height=t;const i=new ti["a"](e,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0,preMultiplyAlpha:!Object(_["w"])(this._imageSources.overlay.src)||!Object(pb["b"])(e).svgAlwaysPremultipliesAlpha},this._imageSources.overlay),r=new ti["a"](e,{target:3553,pixelFormat:6406,internalFormat:6406,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},this._imageSources.mask);return{input:new ti["a"](e,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1}),mask:r,overlay:i,size:t}}createProgram(e){const t=aj();return new Nt["a"](e,t.generateSource("vertex"),t.generateSource("fragment"),this.attributeLocations)}createVAO(e){return Object(Ii["d"])(e,oy["a"],this.attributeLocations,0,1)}get attributeLocations(){return{position:0}}};Object(d["a"])([Object(g["b"])()],sj.prototype,"_imageSources",void 0),Object(d["a"])([Object(g["b"])()],sj.prototype,"_imageLoadTask",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],sj.prototype,"updating",null),sj=Object(d["a"])([Object(y["a"])("esri/views/3d/webgl-engine/lib/MagnifierHelper")],sj);class oj{constructor(e,t=.9){this._alpha=.9,this._startTime=0,this._count=0,this._sum=0,this._smooth=0,this._min=0,this._max=0,this._name=e,this._alpha=t,this.reset()}reset(){this._count=0,this._sum=0,this._smooth=0,this._min=1/0,this._max=0}get name(){return this._name}get count(){return this._count}get average(){return this._count>0?this._sum/this._count:0}get smooth(){return this._smooth}get min(){return this._min}get max(){return this._max}begin(){this._startTime=performance.now()}end(){const e=performance.now()-this._startTime;this._count+=1,this._sum+=e,this._smooth=this._alpha*e+(1-this._alpha)*this._smooth,this._min=Math.min(this._min,e),this._max=Math.max(this._max,e)}toJSON(){return{name:this.name,count:this.count,average:this.average,smooth:this.smooth,min:this.min,max:this.max}}}!function(e){const t=1e3,i={},r={};function a(t){return t in i||(i[t]=new e(t)),i[t]}function n(e){a(e).begin()}function s(e,i=!0){a(e).end();const n=performance.now();i&&(!(e in r)||n>=r[e]+t)&&(o(e),r[e]=n)}function o(e){console.log(a(e).toJSON())}function c(){for(const e in i)o(e)}e.get=a,e.begin=n,e.end=s,e.log=o,e.logAll=c}(oj||(oj={}));var cj=oj,lj=cj,hj=i("b616"),dj=i("35b3"),uj=i("d6e5"),pj=i("9def"),fj=i("a326"),mj=i("b852"),bj=i("191a"),gj=i("2245");class vj{constructor(){this.identifier=0,this.transparent=!1,this.integratedMesh=!1,this.viewTransform=new Q_["a"].ViewProjectionTransform,this.transformNormal_ViewFromGlobal=Object(Kn["a"])(),this.cameraNearFar=Object(hi["b"])(),this.inverseViewport=Object(hi["b"])(),this.slicePlane=Et["b"].create(),this.slicePlaneEnabled=!0,this.ambientOcclusionEnabled=!0,this.shadowsEnabled=!0,this.sceneHasOcludees=!1,this.transparencyPassType=3}}class yj{constructor(){this.identifier=1,this.viewTransform=new Q_["a"].ViewProjectionTransform,this.cameraNearFar=Object(hi["b"])(),this.slicePlane=Et["b"].create()}}class Oj{constructor(){this.identifier=2,this.viewTransform=new Q_["a"].ViewProjectionTransform,this.slicePlane=Et["b"].create(),this.inverseViewport=Object(hi["b"])(),this.viewport=Object(Lt["c"])()}}class _j{constructor(e,t,i=0){this._rctx=e,this._techniqueRepository=t,this._sorting=i,this._draws=new fd["a"]({initialSize:32,allocator:e=>e||{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._passBoundTechniques=new Set,this._previouslyBoundMaterials=new Map,this._previouslyBoundDraw=new Map}submitDraw(e,t,i,r,a){const n=this._draws.pushNew();n.geometry=t,n.geometryRanges=i,n.material=e,n.bindDrawParams=r,n.depthSquaredHint=a,n.indexType=t.indexed?t.vao.indexBuffer.indexType:0}dispatch(e){const t=this._rctx;this._passBoundTechniques.clear(),this._previouslyBoundMaterials.clear(),this._previouslyBoundDraw.clear();let i=null;const r={repository:this._techniqueRepository},a=this._draws.length;for(let n=0;n<a;n++){const a=this._draws.data[n],s=a.geometry,o=a.material.getTechnique(r,e,s.parameters);if(this._passBoundTechniques.has(o)||(o.bindPass(t,e),this._passBoundTechniques.add(o)),t.bindVAO(s.vao),o===i&&3===o.configuration.transparencyPassType||(t.bindProgram(o.program),t.setPipelineState(o.pipeline),i=o),this._previouslyBoundMaterials.get(o)!==a.material&&(o.bindMaterial(t,a.material,e),this._previouslyBoundMaterials.set(o,a.material)),this._previouslyBoundDraw.get(o)!==a.bindDrawParams&&(o.bindDraw(a.bindDrawParams,a.material,e),this._previouslyBoundMaterials.set(o,a.material)),0!==a.indexType){const e=xj.get(a.indexType);for(let i=0;i<a.geometryRanges.length;i+=2){const r=a.geometryRanges[i],n=a.geometryRanges[i+1];t.drawElements(s.primitiveType,n,a.indexType,r*e)}}else for(let e=0;e<a.geometryRanges.length;e+=2){const i=a.geometryRanges[e],r=a.geometryRanges[e+1];t.drawArrays(s.primitiveType,i,r)}}}prepareSubmit(){this._draws.clear()}finishSubmit(){const e=0===this._sorting?1:-1;this._draws.sort((t,i)=>{const r=e*(t.depthSquaredHint-i.depthSquaredHint);return 0!==r?r:t.geometry.vao.size-i.geometry.vao.size})}get count(){return this._draws.length}}const xj=new Map;xj.set(5121,1),xj.set(5123,2),xj.set(5125,4);class jj{constructor(e,t){this.rctx=e,this.shaderTechniqueRepository=t,this.canRender=!0,this._materialPassParams=new vj,this._shadowPassParams=new yj,this._highlightPassParams=new Oj,this._systems=new Set,this._passes=new Array,this._shadowMapPass=this._registerPass(new _j(e,this.shaderTechniqueRepository)),this.passes={materialOpaque:this._registerPass(new _j(e,this.shaderTechniqueRepository)),materialTransparent:this._registerPass(new _j(e,this.shaderTechniqueRepository,1)),materialIntegratedMesh:this._registerPass(new _j(e,this.shaderTechniqueRepository)),shadowMap:this._shadowMapPass,highlight:this._registerPass(new _j(e,this.shaderTechniqueRepository)),highlightIntegratedMesh:this._registerPass(new _j(e,this.shaderTechniqueRepository)),highlightShadowMap:this._registerPass(new _j(e,this.shaderTechniqueRepository)),defaultShadowMap:this._registerPass(new _j(e,this.shaderTechniqueRepository))}}register(e){this._systems.add(e)}prepareRender(e){0!==this._systems.size&&(this._passes.forEach(e=>e.prepareSubmit()),this._systems.forEach(t=>{t.submit(this.passes,{camera:e})}),this._passes.forEach(e=>e.finishSubmit()),this.shaderTechniqueRepository.frameUpdate())}render(e){if(0===this._systems.size)return!1;if(4===e.slot)switch(this._configure(e),e.pass){case 0:this._materialPassParams.subPass=0,this._configureMaterialColorPass(e),this.passes.materialOpaque.dispatch(this._materialPassParams);break;case 2:this._materialPassParams.subPass=2,this.passes.materialOpaque.dispatch(this._materialPassParams);break;case 3:this._materialPassParams.subPass=3,this.passes.materialOpaque.dispatch(this._materialPassParams);break;case 5:this.passes.highlight.dispatch(this._highlightPassParams);break;case 4:this._shadowMapPass.dispatch(this._shadowPassParams);break;case 7:Object(p["k"])(this.passes.highlightShadowMap)&&this.passes.highlightShadowMap.dispatch(this._shadowPassParams);break;case 6:Object(p["k"])(this.passes.defaultShadowMap)&&this.passes.defaultShadowMap.dispatch(this._shadowPassParams)}if(6===e.slot)switch(this._configure(e),e.pass){case 0:this._materialPassParams.subPass=0,this._configureMaterialColorPass(e),this.passes.materialTransparent.dispatch(this._materialPassParams);break;case 1:this._materialPassParams.subPass=1,this._configureMaterialColorPass(e),this.passes.materialTransparent.dispatch(this._materialPassParams);break;case 2:this._materialPassParams.subPass=2,this.passes.materialTransparent.dispatch(this._materialPassParams);break;case 3:this._materialPassParams.subPass=3,this.passes.materialTransparent.dispatch(this._materialPassParams)}if(1===e.slot)switch(this._configure(e),e.pass){case 0:this._materialPassParams.subPass=0,this._configureMaterialColorPass(e),this._materialPassParams.ssrParams=e.ssrParams,this.passes.materialIntegratedMesh.dispatch(this._materialPassParams);break;case 2:this._materialPassParams.subPass=2,this.passes.materialIntegratedMesh.dispatch(this._materialPassParams);break;case 3:this._materialPassParams.subPass=3,this.passes.materialIntegratedMesh.dispatch(this._materialPassParams);break;case 5:this.passes.highlightIntegratedMesh.dispatch(this._highlightPassParams)}return!0}notifyDirty(){this.context.requestRender()}slots(){return[4,6,1]}initializeRenderContext(e){this.context=e}uninitializeRenderContext(){}queryDepthRange(e){const t={near:1/0,far:-1/0};return this._systems.forEach(i=>{const r=i.queryShadowCasterDepthRange(e);Object(p["k"])(r)&&O_(t,r,t)}),t}get shadowCastingEnabled(){return Object(p["k"])(this.passes.shadowMap)}set shadowCastingEnabled(e){e?(this._materialPassParams.shadowsEnabled=!0,this.passes.shadowMap=this._shadowMapPass):(this._materialPassParams.shadowsEnabled=!1,this.passes.shadowMap=null)}get screenSpaceReflectionsEnabled(){return Object(p["k"])(this._materialPassParams.ssrParams.ssrEnabled)}set screenSpaceReflectionsEnabled(e){this._materialPassParams.ssrParams.ssrEnabled=!!e}_configureMaterialColorPass(e){this._materialPassParams.shadowMap={bind:(t,i)=>{e.shadowMap.bind(t,i);const r=this._materialPassParams.viewTransform;Object(It["g"])(wj,r.worldFromView_TL,r.worldFromView_TH),e.shadowMap.bindView(t,wj)}},this._materialPassParams.ambientOcclusion={bind:(t,i)=>{e.ssaoHelper.setUniforms(t,i)}},this._materialPassParams.ambientOcclusionEnabled=!!e.ssaoHelper&&e.ssaoHelper.enabled,this._materialPassParams.sceneHasOcludees=e.hasOccludees}_configure(e){const t=4===e.pass||7===e.pass||6===e.pass?this._shadowPassParams:5===e.pass?this._highlightPassParams:this._materialPassParams;this._updateParameters(e,t)}_updateParameters(e,t){const i=e.camera,r=i.viewInverseTransposeMatrix;Object(It["x"])(wj,r[3],r[7],r[11]),Cj.set(wj),Object(It["l"])(t.viewTransform.worldFromView_TH,Cj.high),Object(It["l"])(t.viewTransform.worldFromView_TL,Cj.low),Object(Jn["f"])(t.viewTransform.viewFromCameraRelative_RS,i.viewMatrix),Object(Vt["c"])(t.viewTransform.projFromView,i.projectionMatrix),0===t.identifier?(this._materialPassParams.transparent=6===e.slot,this._materialPassParams.integratedMesh=1===e.slot,this._materialPassParams.lighting=e.scenelightingData,Object(Jn["n"])(Sj,t.viewTransform.viewFromCameraRelative_RS),Object(Jn["d"])(t.transformNormal_ViewFromGlobal,Sj),Object(di["s"])(t.cameraNearFar,i.near,i.far)):1===t.identifier?Object(di["s"])(t.cameraNearFar,i.near,i.far):2===t.identifier&&(t.highlightDepthTexture=e.highlightDepthTexture,Object(ui["c"])(t.viewport,i.fullViewport)),0!==t.identifier&&2!==t.identifier||(t.inverseViewport[0]=1/i.fullViewport[2],t.inverseViewport[1]=1/i.fullViewport[3]),Et["b"].copyWithoutVerify(e.sliceHelper.plane,t.slicePlane),Object(It["k"])(t.slicePlane.origin,t.slicePlane.origin,wj),t.slicePlaneEnabled=e.sliceHelper.isEnabled,this._materialPassParams.transparencyPassType=e.transparencyPassType,this._materialPassParams.multipassTerrainParams=e.multipassTerrainParams}_registerPass(e){return this._passes.push(e),e}get needsHighlight(){return this.passes.highlight.count>0||this.passes.highlightIntegratedMesh.count>0}}const wj=Object(M["e"])(),Sj=Object(Kn["a"])(),Cj=new px;var Tj=i("ce99");const Pj=8.6,Aj=.4;class Rj extends Bt["a"]{initializeProgram(e){const t=Rj.shader.get().build(this.configuration);return new Nt["a"](e.rctx,t.generateSource("vertex"),t.generateSource("fragment"),zt["a"])}bindApplyPass(e){this.program.setUniform1i("tex",0),this.program.setUniform1i("origin",1),this.configuration.gridOptimization&&this.program.setUniform1i("coverageTex",2),this.program.setUniform4fv("color",e.color),this.program.setUniform4fv("haloColor",e.haloColor),this.program.setUniform1f("outlineSize",Pj),this.program.setUniform1f("blurSize",Aj),this.program.setUniform4f("opacities",e.haloOpacity,e.haloOpacityOccluded,e.fillOpacity,e.fillOpacityOccluded)}initializePipeline(){return 1===this.configuration.highlightStage?Object(qt["e"])({blending:Object(qt["f"])(770,1,771,771),colorWrite:qt["c"]}):Object(qt["e"])({colorWrite:qt["c"]})}get primitiveType(){return this.configuration.gridOptimization?4:5}}Rj.shader=new Gt["a"](Tj["a"],()=>i.e("chunk-2d0f0fc1").then(i.bind(null,"9f64")));class Mj extends Ht["a"]{constructor(){super(...arguments),this.highlightStage=0,this.gridOptimization=!1}}Object(d["a"])([Object(Ht["b"])({count:3})],Mj.prototype,"highlightStage",void 0),Object(d["a"])([Object(Ht["b"])()],Mj.prototype,"gridOptimization",void 0);const Ej=32;class Dj{constructor(e,t){this._rctx=t,this._grid={coverageMipmap:null,vao:null,verticalCellCount:0,horizontalCellCount:0,cellPixelSize:0,mipmapLevels:0,viewportWidth:0,viewportHeight:0},this.quadVAO=Object(Ii["d"])(this._rctx);const i={colorTarget:0,depthStencilTarget:0,width:0,height:0},r={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0};this.blur0Fbo=new cy["a"](this._rctx,i,r),this.blur1Fbo=new cy["a"](this._rctx,i,r),this.viewportToRestore=Object(Lt["c"])(),this.defaultOptions={color:Object(Pm["c"])(1,0,1,1),haloColor:Object(Pm["c"])(1,0,1,1),haloOpacity:1,fillOpacity:.2,haloOpacityOccluded:.25,fillOpacityOccluded:.05,shadowColor:Object(Pm["c"])(1,0,1,1),shadowOpacity:.15,occludedShadowOpacity:.075};const a=new Mj,n=(t,i)=>e.acquireAndReleaseExisting(Rj,t,i);a.highlightStage=0,a.gridOptimization=!1,this.blurTechnique=n(a,this.blurTechnique),a.highlightStage=0,a.gridOptimization=!0,this.blurGridTechnique=n(a,this.blurGridTechnique),a.highlightStage=1,a.gridOptimization=!1,this.applyTechnique=n(a,this.applyTechnique),a.highlightStage=1,a.gridOptimization=!0,this.applyGridTechnique=n(a,this.applyGridTechnique),a.highlightStage=2,a.gridOptimization=!1,this.downsampleTechnique=n(a,this.downsampleTechnique)}dispose(){if(null!=!this.quadVAO){if(this._grid.coverageMipmap)for(let e=1;e<this._grid.coverageMipmap.length;e++)this._grid.coverageMipmap[e].dispose();this._grid.vao&&this._grid.vao.dispose(!0),this.quadVAO.dispose(!0),this.blur1Fbo.dispose(),this.blur0Fbo.dispose(),this.quadVAO=null,this.blur0Fbo=null,this.blur1Fbo=null}}get profilingCallback(){return dd["a"].HIGHLIGHTS_PROFILE_TO_CONSOLE?e=>console.log(e):null}setDefaultOptions(e){this.defaultOptions=e}render(e,t,i){const r=e.pixelRatio,a=dd["a"].HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED,n=this._rctx;Object(ui["c"])(this.viewportToRestore,e.fullViewport);const s=e.fullWidth,o=e.fullHeight,c=Math.ceil(s/r),l=Math.ceil(o/r);this.blur0Fbo.resize(c,l),this.blur1Fbo.resize(c,l),n.bindVAO(this.quadVAO);let h=null,d=null;a?(this._gridUpdateResources(t,Ej),this._gridComputeMipmap(),h=this._grid.vao,d=this.blurGridTechnique,n.bindTexture(this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture,1),d.program.setUniform1i("coverageTex",1)):(h=this.quadVAO,d=this.blurTechnique),d.bindPipelineState(n),n.bindProgram(d.program),n.bindVAO(h),n.bindFramebuffer(this.blur0Fbo),n.setViewport(0,0,c,l),n.setClearColor(0,0,0,0),n.clear(16384),d.program.setUniform1i("tex",0),n.bindTexture(t.colorTexture,0),d.program.setUniform2f("blurSize",1/c,0),n.drawArrays(d.primitiveType,0,Object(ii["f"])(h,"geometry")),n.bindFramebuffer(this.blur1Fbo),n.clear(16384),n.bindTexture(this.blur0Fbo.colorTexture,0),d.program.setUniform2f("blurSize",0,1/l),n.drawArrays(d.primitiveType,0,Object(ii["f"])(h,"geometry"));const u=a?this.applyGridTechnique:this.applyTechnique;if(n.bindFramebuffer(i),u.bindPipelineState(n),n.setViewport(this.viewportToRestore[0],this.viewportToRestore[1],this.viewportToRestore[2],this.viewportToRestore[3]),n.bindProgram(u.program),n.bindTexture(this.blur1Fbo.colorTexture,0),n.bindTexture(t.colorTexture,1),a){const e=this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture;n.bindTexture(e,2)}u.bindApplyPass(this.defaultOptions),n.drawArrays(u.primitiveType,0,Object(ii["f"])(h,"geometry")),n.bindVAO(null)}_gridUpdateResources(e,t){const i=this._rctx,r=this._grid;let a=!1;if(null===r.coverageMipmap&&(r.coverageMipmap=[e],a=!0),r.viewportWidth===e.width&&r.viewportHeight===e.height||(a=!0,r.viewportWidth=e.width,r.viewportHeight=e.height),r.coverageMipmap[0]=e,r.cellPixelSize!==t&&(r.cellPixelSize=t,a=!0),a){for(let e=1;e<r.coverageMipmap.length;e++)r.coverageMipmap[e].dispose();r.mipmapLevels=Math.ceil(Math.log(r.cellPixelSize)*Math.LOG2E),r.coverageMipmap.length=r.mipmapLevels+1;for(let e=0;e<r.mipmapLevels;e++){const t=r.coverageMipmap[e],a={target:3553,pixelFormat:6407,dataType:33635,samplingMode:9729,wrapMode:33071,width:Math.ceil(t.width/2),height:Math.ceil(t.height/2)},n={colorTarget:0,depthStencilTarget:0,width:Math.ceil(t.width/2),height:Math.ceil(t.height/2)};r.coverageMipmap[e+1]=new cy["a"](i,n,a)}}const n=Math.ceil(e.height/r.cellPixelSize),s=Math.ceil(e.width/r.cellPixelSize);if(!r.vao||r.verticalCellCount!==n||r.horizontalCellCount!==s){r.verticalCellCount=n,r.horizontalCellCount=s;const e=n+1,t=s+1,a=1/n,o=1/s,c=6,l=4,h=new Float32Array(c*l*e*t);let d=0;for(let i=0;i<e;i++)for(let e=0;e<t;e++)h[d+0]=(e-.5)*o*2-1,h[d+1]=(i-.5)*a*2-1,h[d+2]=e*o,h[d+3]=i*a,h[d+4]=(e+.5)*o*2-1,h[d+5]=(i-.5)*a*2-1,h[d+6]=e*o,h[d+7]=i*a,h[d+8]=(e-.5)*o*2-1,h[d+9]=(i+.5)*a*2-1,h[d+10]=e*o,h[d+11]=i*a,h[d+12]=(e-.5)*o*2-1,h[d+13]=(i+.5)*a*2-1,h[d+14]=e*o,h[d+15]=i*a,h[d+16]=(e+.5)*o*2-1,h[d+17]=(i-.5)*a*2-1,h[d+18]=e*o,h[d+19]=i*a,h[d+20]=(e+.5)*o*2-1,h[d+21]=(i+.5)*a*2-1,h[d+22]=e*o,h[d+23]=i*a,d+=c*l;r.vao&&r.vao.dispose(!0),r.vao=new ri["a"](i,zt["a"],{geometry:oy["b"]},{geometry:ei["a"].createVertex(i,35044,h)})}}_gridComputeMipmap(){const e=this._rctx,t=this._grid,i=this.downsampleTechnique.program;this.downsampleTechnique.bindPipelineState(e),e.bindVAO(this.quadVAO);for(let r=0;r<t.mipmapLevels;r++){e.bindFramebuffer(t.coverageMipmap[r+1]),e.bindTexture(t.coverageMipmap[r].colorTexture,0);const a=t.coverageMipmap[r+1].width,n=t.coverageMipmap[r+1].height;e.bindProgram(i),i.setUniform1i("tex",0),i.setUniform2f("invFramebufferDim",1/a,1/n),e.setViewport(0,0,a,n),e.drawArrays(5,0,Object(ii["f"])(this.quadVAO,"geometry"))}}getGpuMemoryUsage(){let e=Object(ii["c"])(this.blur0Fbo)+Object(ii["c"])(this.blur1Fbo);if(this._grid.coverageMipmap)for(const t of this._grid.coverageMipmap)e+=Object(ii["c"])(t);return e}get test(){return{coverage:this._grid.coverageMipmap,blur:[this.blur0Fbo,this.blur1Fbo]}}}var Ij=Dj,Lj=i("91b0");const Vj={dataType:5121,internalFormat:6408},kj={};class Fj{constructor(e){this.rctx=e,this._activeTargets=new Set,this._depthTextures=new Map,this._depthBuffers=new Map,this._colorTextures=new Map,this._framebuffers=new Map,this._nextId=1,this.depthTextureSupported=e.capabilities.depthTexture}dispose(){this._depthBuffers.forEach(e=>e.dispose()),this._depthBuffers.clear(),this._depthTextures.forEach(e=>e.dispose()),this._depthTextures.clear(),this._colorTextures.forEach(e=>e.dispose()),this._colorTextures.clear(),this._framebuffers.forEach(e=>e.dispose()),this._framebuffers.clear()}disposeTargetResource(e){const t=e.id;this._activeTargets.has(t)&&(this._activeTargets.delete(t),this._depthTextures.has(t)&&(this._depthTextures.get(t).dispose(),this._depthTextures.delete(t)),this._depthBuffers.has(t)&&(this._depthBuffers.get(t).dispose(),this._depthBuffers.delete(t)),this._colorTextures.has(t)&&(this._colorTextures.get(t).dispose(),this._colorTextures.delete(t)))}getDepthTexture(e,t){if(!this.depthTextureSupported)return;let i=this._depthTextures.get(e.id);return i&&(i.descriptor.width===t.width&&i.descriptor.height===t.height||(i.dispose(),i=void 0)),i||(i=new ti["a"](this.rctx,{target:3553,pixelFormat:34041,dataType:34042,samplingMode:9728,wrapMode:33071,width:t.width,height:t.height}),this._depthTextures.set(e.id,i),this._activeTargets.add(e.id)),i}getAllocatedDepthTexture(e){return this._depthTextures.get(e.id)}getDepthBuffer(e,t){if(this.depthTextureSupported)return;let i=this._depthBuffers.get(e.id);return i?i.descriptor.width===t.width&&i.descriptor.height===t.height||i.resize(t.width,t.height):(i=new Lj["a"](this.rctx,{internalFormat:34041,...t}),this._depthBuffers.set(e.id,i),this._activeTargets.add(e.id)),i}getColorTexture(e,t){let i=this._colorTextures.get(e.id);return i&&(i.descriptor.width===t.width&&i.descriptor.height===t.height||(i.dispose(),i=void 0)),i||(i=new ti["a"](this.rctx,{target:3553,pixelFormat:6408,internalFormat:e.internalFormat,dataType:e.dataType,samplingMode:null!=e.samplingMode?e.samplingMode:9729,wrapMode:33071,width:t.width,height:t.height}),this._colorTextures.set(e.id,i),this._activeTargets.add(e.id)),i}getAllocatedColorTexture(e){return this._colorTextures.get(e.id)}registerDepthTarget(e={}){return{id:this._nextId++,...kj,...e}}registerColorTarget(e={}){return{id:this._nextId++,...Vj,...e}}getFramebuffer(e,t,i){const r=this.getKey(t,i);let a=this._framebuffers.get(r);const n=this.getColorTexture(t,e);if(this.depthTextureSupported){const t=i?this.getDepthTexture(i,e):void 0;return a?((a.width!==e.width||a.height!==e.height||a.colorTexture!==n||a.depthStencilTexture!==t)&&(a.detachColorTexture(),a.detachDepthStencilTexture(),a.resize(e.width,e.height),a.attachColorTexture(n),a.attachDepthStencilTexture(t)),a):(a=i?new cy["a"](this.rctx,{colorTarget:0,depthStencilTarget:4},n,t):new cy["a"](this.rctx,{colorTarget:0,depthStencilTarget:0},n),this._framebuffers.set(r,a),a)}{const t=i?this.getDepthBuffer(i,e):void 0;return a?((a.width!==e.width||a.height!==e.height||a.colorTexture!==n)&&(a.detachColorTexture(),a.detachDepthStencilBuffer(),a.resize(e.width,e.height),a.attachColorTexture(n),a.attachDepthStencilBuffer(t)),a):(a=new cy["a"](this.rctx,{colorTarget:0,depthStencilTarget:i?3:0},n,t),this._framebuffers.set(r,a),a)}}getKey(e,t){return`${e.id}_${t?t.id:"X"}_${e.name}${t?"_"+t.name:""}`}getGpuMemoryUsage(){let e=0;const t=new Set,i=i=>{t.has(i)||(t.add(i),e+=Object(ii["c"])(i))};return this._depthTextures.forEach(i),this._colorTextures.forEach(i),this._depthBuffers.forEach(i),this._framebuffers.forEach(i),e}}class zj{constructor(e,t){this._rctx=e,this._compositingHelper=t,this._currentRenderTarget=0,this.dimensions={width:4,height:4},this._needLastFrameColorTexture=!1,this._background={type:"color",color:[0,0,0,1]};const i=this._rctx,r=i.isWebGL2Context();this.renderTargetHelper=new Fj(i);const a=this.renderTargetHelper;this.mainColorTarget0=a.registerColorTarget({name:"mainColorTarget0"}),this.mainColorTarget1=a.registerColorTarget({name:"mainColorTarget1"}),this.frontFaceTarget=a.registerColorTarget({name:"frontFaceTarget"});const n=e=>a.registerColorTarget({name:e,dataType:5126,internalFormat:r?34836:6408,samplingMode:9728});this.colorFloatTarget=n("colorFloatTarget"),this.alphaFloatTarget=n("alphaFloatTarget"),this.mainDepth=a.registerDepthTarget({name:"mainDepth"}),this.linearDepth=a.registerColorTarget({name:"linearDepth",samplingMode:9728}),this.terrainLinearDepth=a.registerColorTarget({name:"terrainLinearDepth"}),this.geometryLinearDepth=a.registerColorTarget({name:"geometryLinearDepth"}),this.normal=a.registerColorTarget({name:"normal"}),this.highlight=a.registerColorTarget({name:"highlight",internalFormat:r?32854:6408,dataType:32819}),this.hudVisibility=a.registerColorTarget({name:"hudVisibility",internalFormat:r?32854:6408,dataType:32819}),this.tmpColor=a.registerColorTarget({name:"tmpColor"}),this.tmpDepth=a.registerDepthTarget({name:"tmpDepth"}),this.hudColor=a.registerColorTarget({name:"hudColor"})}dispose(){this.renderTargetHelper.dispose()}get width(){return this.dimensions.width}get height(){return this.dimensions.height}set background(e){this._background=e}get background(){return this._background}get currentColorTarget(){return 0===this._currentRenderTarget?this.mainColorTarget0:this.mainColorTarget1}get previousColorTarget(){return 0===this._currentRenderTarget?this.mainColorTarget1:this.mainColorTarget0}get currentRenderTarget(){return this._currentRenderTarget}get framebuffer(){return this.getFramebuffer(this.currentColorTarget,this.mainDepth)}getFramebuffer(e,t){return this.renderTargetHelper.getFramebuffer(this.dimensions,e,t)}get colorTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.currentColorTarget)}get depthTexture(){return this.renderTargetHelper.getAllocatedDepthTexture(this.mainDepth)}get linearDepthTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.linearDepth)}get terrainLinearDepthTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.terrainLinearDepth)}get geometryLinearDepthTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.geometryLinearDepth)}get lastFrameColorTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.previousColorTarget)}get normalTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.normal)}get highlightTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.highlight)}get hudVisibilityTexture(){return this.getColorTexture(this.hudVisibility)}get tmpColorTexture(){return this.getColorTexture(this.tmpColor)}get hudColorTexture(){return this.getColorTexture(this.hudColor)}get mainColorTexture(){return this.getColorTexture(this.currentColorTarget)}advanceCurrentRenderTarget(){this._currentRenderTarget=0===this._currentRenderTarget&&this._needLastFrameColorTexture?1:0}initializeFrame(e){const t=this._rctx;this.dimensions.width=e.fullWidth,this.dimensions.height=e.fullHeight,this.bindTarget(this.currentColorTarget,this.mainDepth),t.setClearStencil(0);const i=this._background.color;t.setClearColor(i[0]*i[3],i[1]*i[3],i[2]*i[3],i[3]),t.clearSafe(17664)}composite(){this._compositingHelper.composite(this.colorTexture,0)}renderTmpAndCompositeToMain(e,t,i=!1){this.renderToTargets(e,this.tmpColor,i?this.tmpDepth:this.mainDepth,Uj),this._compositingHelper.composite(this.getColorTexture(this.tmpColor),t)}renderHUDVisibility(e){this.renderToTargets(e,this.hudVisibility,this.mainDepth,Gj)}compositeTransparentTerrainOntoHUDVisibility(){this.renderToTargets(()=>{this._compositingHelper.compositeSpecial(this.getColorTexture(this.tmpColor),2)},this.hudVisibility,this.tmpDepth)}renderOITPass(e,t,i){let r,a;switch(t){case 0:r=this.colorFloatTarget,a=[0,0,0,0];break;case 1:r=this.alphaFloatTarget,a=[1,1,1,1];break;case 2:r=this.frontFaceTarget,a=[0,0,0,0]}i?this.renderToTargets(e,r,this.tmpDepth,a,!0,!0):this.renderToTargets(e,r,this.mainDepth,a,!1)}compositeTransparentTerrainOntoMain(){this.bindFramebuffer(),this._compositingHelper.composite(this.getColorTexture(this.tmpColor),2)}compositeOccludedOntoMain(e){this.bindFramebuffer(),this._compositingHelper.composite(this.getColorTexture(this.tmpColor),2,e)}compositeTransparentOntoOpaque(e){e?(this.bindTarget(this.hudColor,this.tmpDepth),this._rctx.setClearColor(0,0,0,1e-13),this._rctx.clearSafe(16384,255)):this.bindFramebuffer(),this._compositingHelper.compositeTransparent(this.getColorTexture(this.colorFloatTarget),this.getColorTexture(this.alphaFloatTarget),this.getColorTexture(this.frontFaceTarget))}bindFramebuffer(){this._rctx.bindFramebuffer(this.framebuffer)}renderDepthDetached(e){this.bindTarget(this.currentColorTarget),e(),this.bindTarget(this.currentColorTarget,this.mainDepth)}disposeTarget(e){this.renderTargetHelper.disposeTargetResource(e)}set needLastFrameColorTexture(e){!e&&this._needLastFrameColorTexture&&(this._currentRenderTarget=0,this.disposeTarget(this.mainColorTarget1)),this._needLastFrameColorTexture=e}get needLastFrameColorTexture(){return this._needLastFrameColorTexture}renderToTargets(e,t,i,r,a,n){const s=this._rctx,o=this.bindTarget(t,i);let c=0;if(r){const e=1e-13,t=Math.max(e,r[3]);s.setClearColor(r[0],r[1],r[2],t),c|=16384}return a&&(c|=256),n&&(c|=1024),c&&s.clearSafe(c,!0===n?255:!1===n?0:n),e(),s.gl.flush(),this.bindTarget(this.currentColorTarget,this.mainDepth),o}bindTarget(e,t){const i=this.renderTargetHelper.getFramebuffer(this.dimensions,e,t);return this._rctx.bindFramebuffer(i),i}getColorTexture(e){return this.renderTargetHelper.getColorTexture(e,this.dimensions)}getGpuMemoryUsage(){let e=0;return this.renderTargetHelper&&(e+=this.renderTargetHelper.getGpuMemoryUsage()),e}}const Uj=[0,0,0,0],Gj=[0,1,0,1];class Bj{constructor(e){this.context=e,this.renderPlugins=new Array,this.slots=[];for(let t=0;t<23;++t)this.slots[t]=[]}add(e,t){this.renderPlugins.push(t);for(let i=0;i<e.length;++i){const r=e[i];this.slots[r].push(t)}t.initializeRenderContext(this.context),this.context.requestRender()}remove(e){const t=this.renderPlugins.length;this.renderPlugins=this.renderPlugins.filter(t=>t!==e),Object(Mi["a"])(this.renderPlugins.length<t,"Removing non-added render plugin");for(let i=0;i<this.slots.length;++i)this.slots[i]=this.slots[i].filter(t=>t!==e);e.uninitializeRenderContext(),this.context.requestRender()}prepareRender(e){for(const t of this.renderPlugins)t.prepareRender&&t.prepareRender(e)}render(){const e=this.slots[this.context.renderContext.slot];let t=!1;for(const i of e)i.canRender&&i.render(this.context.renderContext)&&(t=!0);return t}queryDepthRange(e){const t=Hj;t.near=1/0,t.far=-1/0;for(const i of this.renderPlugins)if(i.queryDepthRange){const r=i.queryDepthRange(e);r&&O_(t,r,t)}return t}get needsHighlight(){return this.renderPlugins.some(e=>e.needsHighlight)}get needsLinearDepth(){return this.renderPlugins.some(e=>e.needsLinearDepth)}get needsLaserlineWithContrastControl(){const e=this.slots[17];return!!e&&e.length>0}get renderOccludedFlags(){let e=0;return this.renderPlugins.forEach(t=>{t.renderOccludedFlags&&(e|=t.renderOccludedFlags)}),e}}const Hj={near:0,far:0};var Nj=i("65c9");class qj extends Bt["a"]{initializeProgram(e){const t=qj.shader.get().build(this.configuration);return new Nt["a"](e.rctx,t.generateSource("vertex"),t.generateSource("fragment"),zt["a"])}initializePipeline(e){return Object(qt["e"])({blending:Object(qt["f"])(770,1,771,771),colorWrite:qt["c"],depthTest:null,depthWrite:null})}bindPass(e,t,i){e.bindTexture(t.depthMap,2),e.bindTexture(t.highlightMap,3),this.program.setUniform4fv("color",t.color),this.program.setUniform1f("opacity",t.opacity),this.program.setUniform1f("occludedOpacity",t.occludedOpacity),this.program.setUniform1f("terminationFactor",t.terminationFactor),this.program.setUniform2fv("nearFar",t.nearFar),this.program.setUniformMatrix4fv("inverseView",t.inverseView),this.program.setUniform4fv("projInfo",t.projInfo),this.program.setUniform2fv("zScale",t.zScale),this.program.setUniform1i("depthMap",2),this.program.setUniform3fv("lightingMainDirectionView",t.lightDirView),this.program.setUniform1i("highlightMap",3),this.program.setUniform2fv("texelSize",t.texelSize),t.shadowMap.setUniforms(this.program),t.shadowMap.bindView(this.program,t.origin),t.shadowMap.bindSnapshot(t.highlightSnapshotSlot,6),this.program.setUniform1i("highlightDepthTex",6),t.shadowMap.bindSnapshot(t.defaultSnapshotSlot,7),this.program.setUniform1i("defaultDepthTex",7)}get primitiveType(){return 5}}qj.shader=new Gt["a"](Nj["a"],()=>i.e("chunk-2d0bd404").then(i.bind(null,"2acb")));class Wj extends Ht["a"]{constructor(){super(...arguments),this.highlightedThreshold=.99999,this.selfShadowThreshold=.025}}Object(d["a"])([Object(Ht["b"])()],Wj.prototype,"highlightedThreshold",void 0),Object(d["a"])([Object(Ht["b"])()],Wj.prototype,"selfShadowThreshold",void 0);const Zj=.001953125,$j=4e4,Qj=5e4;class Xj{constructor(e,t,i,r){this._rctx=t,this.highlightShadowMapSlot=i,this.defaultSnapshotSlot=r,this._opacityElevationFactor=1,this._dayNightTerminatorFactor=1,this._maxOpacity=1,this._defaultOptions={shadowColor:Object(Pm["c"])(1,0,1,1),shadowOpacity:.2,occludedShadowOpacity:.1};const a=new Wj;this._shadowHighlightTechnique=e.acquireAndReleaseExisting(qj,a,this._shadowHighlightTechnique),this._viewingMode=e.viewingMode,this._quadVAO=Object(Ii["d"])(this._rctx)}render(e,t,i,r,a,n){if(Object(Mi["a"])(this._quadVAO),!i.enabled||!this.wouldRender)return;const s=this._rctx,o=this._quadVAO,c=this._shadowHighlightTechnique,l=rw,h=iw,d=aw,u=tw,p=ew,f=Jj,m=this.defaultSnapshotSlot,b=this.highlightShadowMapSlot,g=this._defaultOptions,v=g.shadowColor,y=g.shadowOpacity,O=g.occludedShadowOpacity,_=this._opacityElevationFactor*this._dayNightTerminatorFactor,x=Object(di["s"])(Yj,1/t.descriptor.width,1/t.descriptor.height);Object(It["n"])(f,r,e.viewInverseTransposeMatrix),Object(It["s"])(f,f),Object(It["l"])(p,e.center),Object(di["c"])(u,e.nearFar),Object(Mi["f"])(e.projectionMatrix,e.fullWidth,e.fullHeight,l,h),Object(Vt["t"])(d,e.viewMatrix,e.center),Object(Vt["a"])(d,d),s.bindFramebuffer(n),s.bindProgram(c.program),c.bindPipelineState(s),c.bindPass(s,{color:v,opacity:y,occludedOpacity:O,terminationFactor:_,defaultSnapshotSlot:m,highlightSnapshotSlot:b,shadowMappingEnabled:i.enabled,shadowMap:i,origin:p,zScale:h,inverseView:d,projInfo:l,nearFar:u,depthMap:t,lightDirView:f,highlightMap:a.colorTexture,texelSize:x}),s.bindVAO(o),s.drawArrays(c.primitiveType,0,Object(ii["f"])(o,"geometry"))}getGpuMemoryUsage(){return this._quadVAO?this._quadVAO.size:0}setDefaultOptions(e){this._defaultOptions=e,this._updateMaxOpacity()}setup(e,t){const i=e.relativeElevation;this._opacityElevationFactor=1-Object(Qe["t"])($j,Qj,i),this._dayNightTerminatorFactor=this._evaluateDayNightTerminatorFactor(e.center,t)}dispose(){this._quadVAO&&(this._quadVAO.dispose(),this._quadVAO=null)}get wouldRender(){return this._maxOpacity*this._opacityElevationFactor*this._dayNightTerminatorFactor>=Zj}_updateMaxOpacity(){const e=this._defaultOptions,t=e.shadowColor,i=Math.max(e.shadowOpacity,e.occludedShadowOpacity);this._maxOpacity=i*t[3]}_evaluateDayNightTerminatorFactor(e,t){const i=1===this._viewingMode?Object(It["s"])(Kj,e):Object(It["x"])(Kj,0,0,1),r=Object(It["i"])(i,t);return Object(Qe["t"])(0,1,Object(Qe["i"])(30*r,0,1))}}const Yj=Object(hi["b"])(),Kj=Object(M["e"])(),Jj=Object(M["e"])(),ew=Object(M["e"])(),tw=Object(hi["b"])(),iw=Object(hi["b"])(),rw=Object(Lt["c"])(),aw=Object(kt["b"])();var nw=Xj,sw=i("8dd3");class ow{constructor(){this.camera=new Yn["a"],this.lightMat=Object(kt["b"])()}}class cw{constructor(e,t,i=0){this.rctx=e,this.viewingMode=t,this._enabled=!1,this.snapshots=[],this.textureSize=0,this.maxTextureSize=0,this.numCascades=1,this.maxNumCascades=4,this.splitSchemeLambda=0,this.warp=!0,this.cascadeDistances=[0,0,0,0,0],this.cascades=[],this.emptyTexture=Object(Ii["a"])(this.rctx,[1,1,1,1]),this.maxTextureSize=this.rctx.parameters.maxTextureSize;for(let r=0;r<4;++r)this.cascades.push(new ow);this.snapshotCount=i}dispose(){this.emptyTexture.dispose(),this.emptyTexture=null,this.discardDepthTexture(),this.discardAllSnapshots()}set maxCascades(e){this.maxNumCascades=Object(Qe["d"])(Math.floor(e),1,4)}get maxCascades(){return this.maxNumCascades}set enabled(e){this._enabled=e,e||(this.discardDepthTexture(),this.discardAllSnapshots())}get enabled(){return this._enabled}get snapshotCount(){return this.snapshots.length}set snapshotCount(e){const t=this.snapshots.length;if(e>t){const i=e-t;this.snapshots.length=e;for(let e=0;e<i;++e)this.snapshots[t+e]=null}else if(e<this.snapshotCount){const i=t-e;for(let t=0;t<i;++t)this.discardSnapshot(e+t);this.snapshots.length=e}}getDepthTexture(){return this.depthTexture}getSnapshot(e){return this.snapshots[e]}getCascades(){for(let e=0;e<this.numCascades;++e)jw[e]=this.cascades[e];return jw.length=this.numCascades,jw}prepare(e,t,i){Object(Mi["a"])(this.enabled),this.textureSize=this.computeTextureSize(e.fullWidth,e.fullHeight),this.assertDepthTexture();const{near:r,far:a}=this.clampNearFar(i);this.computeCascadeDistances(a,r),this.setupMatrices(e,t);const n=e.viewMatrix,s=e.projectionMatrix;for(let o=0;o<this.numCascades;++o)this.constructCascade(o,s,n,t);this.lastOrigin=null,this.clear()}finish(e){Object(Mi["a"])(this.enabled),this.rctx.bindFramebuffer(e)}bind(e,t=sw["a"].SHADOW_MAP){const i=this.rctx;i.bindTexture(this.enabled?this.depthTexture:this.emptyTexture,t),i.bindProgram(e),e.setUniform1i("uShadowMapTex",t),this.setUniforms(e)}bindToAllPrograms(e){const t=e.getProgramsUsingUniform("uShadowMapDistance");for(let i=0;i<t.length;i++)this.bind(t[i],sw["a"].SHADOW_MAP)}bindView(e,t){if(!this.enabled)return;const i=this.lastOrigin;if(!i||i[0]!==t[0]||i[1]!==t[1]||i[2]!==t[2]){this.lastOrigin=this.lastOrigin||Object(M["e"])(),Object(It["l"])(this.lastOrigin,t);for(let e=0;e<this.numCascades;++e){Object(Vt["t"])(ww,this.cascades[e].lightMat,t);for(let t=0;t<16;++t)Sw[16*e+t]=ww[t]}}e.setUniformMatrix4fv("uShadowMapMatrix",Sw)}setUniforms(e){this.rctx.bindProgram(e),e.setUniform1f("uDepthHalfPixelSz",this.enabled?.5/this.textureSize:-1),e.setUniform1i("uShadowMapNum",this.numCascades),e.setUniform4f("uShadowMapDistance",this.cascadeDistances[0],this.numCascades>1?this.cascadeDistances[1]:1/0,this.numCascades>2?this.cascadeDistances[2]:1/0,this.numCascades>3?this.cascadeDistances[3]:1/0)}bindSnapshot(e,t){this.rctx.bindTexture(this.enabled?this.snapshots[e]:this.emptyTexture,t)}takeCascadeSnapshotTo(e,t){Object(Mi["a"])(this.enabled);const i=this.rctx;this.assertSnapshot(t),this.bindFbo(),i.bindTexture(this.snapshots[t],sw["a"].SHADOW_MAP),i.gl.copyTexSubImage2D(3553,0,e.camera.viewport[0],e.camera.viewport[1],e.camera.viewport[0],e.camera.viewport[1],e.camera.viewport[2],e.camera.viewport[3]),i.bindTexture(null,sw["a"].SHADOW_MAP)}clear(){const e=this.rctx;this.bindFbo(),e.setClearColor(1,1,1,1),e.clearSafe(16640)}computeTextureSize(e,t){const i=.5*Math.log(e*e+t*t)*Math.LOG2E,r=.35,a=2**Math.round(i+r);return Math.min(this.maxTextureSize,2*a)}assertDepthTexture(){if(null!=this.depthTexture&&this.depthTexture.descriptor.width===this.textureSize)return;this.discardDepthTexture();const e={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0,width:this.textureSize,height:this.textureSize};this.depthTexture=new ti["a"](this.rctx,e),this.fbo=new cy["a"](this.rctx,{colorTarget:0,depthStencilTarget:1,width:this.textureSize,height:this.textureSize},this.depthTexture)}assertSnapshot(e){const t=this.snapshots[e];if(null!==t&&t.descriptor.width===this.textureSize)return;this.discardSnapshot(e);const i={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0,width:this.textureSize,height:this.textureSize};this.snapshots[e]=new ti["a"](this.rctx,i)}discardDepthTexture(){this.fbo&&(this.fbo.dispose(),this.fbo=null),this.depthTexture&&(this.depthTexture.dispose(),this.depthTexture=null)}discardSnapshot(e){this.snapshots[e]&&(this.snapshots[e].dispose(),this.snapshots[e]=null)}discardAllSnapshots(){for(let e=0;e<this.snapshotCount;++e)this.discardSnapshot(e)}bindFbo(){const e=this.rctx;e.bindFramebuffer(this.fbo),e.bindTexture(null,sw["a"].SHADOW_MAP)}constructCascade(e,t,i,r){const a=this.cascades[e],n=-this.cascadeDistances[e],s=-this.cascadeDistances[e+1],o=(t[10]*n+t[14])/Math.abs(t[11]*n+t[15]),c=(t[10]*s+t[14])/Math.abs(t[11]*s+t[15]);Object(Mi["a"])(o<c);for(let h=0;h<8;++h){Object(ui["l"])(uw,h%4==0||h%4==3?-1:1,h%4==0||h%4==1?-1:1,h<4?o:c,1),Object(ui["m"])(pw[h],uw,dw);for(let e=0;e<3;++e)pw[h][e]/=pw[h][3]}Object(It["u"])(xw,pw[0]),Object(Vt["t"])(lw,_w,xw),a.camera.viewMatrix=lw;for(let h=0;h<8;++h)Object(It["n"])(pw[h],pw[h],a.camera.viewMatrix);Object(It["l"])(fw,pw[0]),Object(It["l"])(mw,pw[0]);for(let h=1;h<8;++h)for(let e=0;e<3;++e)fw[e]=Math.min(fw[e],pw[h][e]),mw[e]=Math.max(mw[e],pw[h][e]);fw[2]-=200,mw[2]+=200,a.camera.near=-mw[2],a.camera.far=-fw[2],this.warp?this.constructTrapezoidalProjection(i,r,a):this.constructOrthogonalProjection(a),Object(Vt["m"])(a.lightMat,a.camera.projectionMatrix,a.camera.viewMatrix);const l=this.textureSize/2;a.camera.viewport[0]=e%2==0?0:l,a.camera.viewport[1]=0===Math.floor(e/2)?0:l,a.camera.viewport[2]=l,a.camera.viewport[3]=l}constructOrthogonalProjection(e){Object(Vt["o"])(e.camera.projectionMatrix,fw[0],mw[0],fw[1],mw[1],e.camera.near,e.camera.far)}constructTrapezoidalProjection(e,t,i){const r=1/pw[0][3],a=1/pw[4][3];Object(Mi["a"])(r<a);let n=r+Math.sqrt(r*a);const s=Math.sin(Object(Qe["b"])(e[2]*t[0]+e[6]*t[1]+e[10]*t[2]));n/=s,Vw(pw,n,s,bw,gw,vw,yw,Ow),Bw(bw,gw,yw,Ow,i.camera.projectionMatrix),i.camera.projectionMatrix[10]=2/(fw[2]-mw[2]),i.camera.projectionMatrix[14]=-(fw[2]+mw[2])/(fw[2]-mw[2])}setupMatrices(e,t){Object(Vt["m"])(hw,e.projectionMatrix,e.viewMatrix),Object(Vt["a"])(dw,hw);const i=1===this.viewingMode?e.eye:Object(It["x"])(xw,0,0,1);Object(Vt["l"])(_w,[0,0,0],[-t[0],-t[1],-t[2]],i)}clampNearFar(e){let{near:t,far:i}=e;return t<2&&(t=2),i<2&&(i=2),t>=i&&(t=2,i=4),{near:t,far:i}}computeCascadeDistances(e,t){this.numCascades=Math.min(1+Math.floor(Object(Mi["h"])(e/t,4)),this.maxNumCascades);const i=(e-t)/this.numCascades,r=(e/t)**(1/this.numCascades);let a=t,n=t;for(let s=0;s<this.numCascades+1;++s)this.cascadeDistances[s]=Object(Qe["l"])(a,n,this.splitSchemeLambda),a*=r,n+=i}getGpuMemoryUsage(){return this.snapshots.reduce((e,t)=>e+Object(ii["c"])(t),Object(ii["c"])(this.fbo))}get test(){const e=this;return{maxNumCascades:this.maxNumCascades,cascades:this.cascades,textureSize:this.textureSize,set splitSchemeLambda(t){e.splitSchemeLambda=t},get splitSchemeLambda(){return e.splitSchemeLambda},set warp(t){e.warp=t},get warp(){return e.warp}}}}const lw=Object(kt["b"])(),hw=Object(kt["b"])(),dw=Object(kt["b"])(),uw=Object(Lt["c"])(),pw=[];for(let FC=0;FC<8;++FC)pw.push(Object(Lt["c"])());const fw=Object(M["e"])(),mw=Object(M["e"])(),bw=Object(hi["b"])(),gw=Object(hi["b"])(),vw=Object(hi["b"])(),yw=Object(hi["b"])(),Ow=Object(hi["b"])(),_w=Object(kt["b"])(),xw=Object(M["e"])(),jw=[],ww=Object(kt["b"])(),Sw=new Float32Array(64),Cw=Object(hi["b"])(),Tw=Object(hi["b"])(),Pw=[Object(hi["b"])(),Object(hi["b"])(),Object(hi["b"])(),Object(hi["b"])()],Aw=Object(hi["b"])(),Rw=Object(hi["b"])(),Mw=Object(hi["b"])(),Ew=Object(hi["b"])(),Dw=Object(hi["b"])(),Iw=Object(hi["b"])(),Lw=Object(hi["b"])();function Vw(e,t,i,r,a,n,s,o){Object(di["s"])(Cw,0,0);for(let _=0;_<4;++_)Object(di["h"])(Cw,Cw,e[_]);Object(di["a"])(Cw,Cw,.25),Object(di["s"])(Tw,0,0);for(let _=4;_<8;++_)Object(di["h"])(Tw,Tw,e[_]);Object(di["a"])(Tw,Tw,.25),Object(di["m"])(Pw[0],e[4],e[5],.5),Object(di["m"])(Pw[1],e[5],e[6],.5),Object(di["m"])(Pw[2],e[6],e[7],.5),Object(di["m"])(Pw[3],e[7],e[4],.5);let c=0,l=Object(di["j"])(Pw[0],Cw);for(let _=1;_<4;++_){const e=Object(di["j"])(Pw[_],Cw);e<l&&(l=e,c=_)}Object(di["d"])(Aw,Pw[c],e[c+4]);const h=Aw[0];let d,u;Aw[0]=-Aw[1],Aw[1]=h,Object(di["d"])(Rw,Tw,Cw),Object(di["g"])(Rw,Aw)<0&&Object(di["n"])(Aw,Aw),Object(di["m"])(Aw,Aw,Rw,i),Object(di["e"])(Aw,Aw),d=u=Object(di["g"])(Object(di["d"])(Mw,e[0],Cw),Aw);for(let _=1;_<8;++_){const t=Object(di["g"])(Object(di["d"])(Mw,e[_],Cw),Aw);t<d?d=t:t>u&&(u=t)}Object(di["c"])(r,Cw),Object(di["a"])(Mw,Aw,d-t),Object(di["h"])(r,r,Mw);let p=-1,f=1,m=0,b=0;for(let _=0;_<8;++_){Object(di["d"])(Ew,e[_],r),Object(di["e"])(Ew,Ew);const t=Aw[0]*Ew[1]-Aw[1]*Ew[0];t>0?t>p&&(p=t,m=_):t<f&&(f=t,b=_)}Object(Mi["o"])(p>0,"leftArea"),Object(Mi["o"])(f<0,"rightArea"),Object(di["a"])(Dw,Aw,d),Object(di["h"])(Dw,Dw,Cw),Object(di["a"])(Iw,Aw,u),Object(di["h"])(Iw,Iw,Cw),Lw[0]=-Aw[1],Lw[1]=Aw[0];const g=Object(Mi["l"])(r,e[b],Iw,Object(di["h"])(Mw,Iw,Lw),1,a),v=Object(Mi["l"])(r,e[m],Iw,Mw,1,n),y=Object(Mi["l"])(r,e[m],Dw,Object(di["h"])(Mw,Dw,Lw),1,s),O=Object(Mi["l"])(r,e[b],Dw,Mw,1,o);Object(Mi["o"])(g,"rayRay"),Object(Mi["o"])(v,"rayRay"),Object(Mi["o"])(y,"rayRay"),Object(Mi["o"])(O,"rayRay")}function kw(e,t){return 3*t+e}const Fw=Object(hi["b"])();function zw(e,t){return Object(di["s"])(Fw,e[t],e[t+3]),Fw}const Uw=Object(hi["b"])(),Gw=Object(Kn["a"])();function Bw(e,t,i,r,a){Object(di["d"])(Uw,i,r),Object(di["a"])(Uw,Uw,.5),Gw[0]=Uw[0],Gw[1]=Uw[1],Gw[2]=0,Gw[3]=Uw[1],Gw[4]=-Uw[0],Gw[5]=0,Gw[6]=Uw[0]*Uw[0]+Uw[1]*Uw[1],Gw[7]=Uw[0]*Uw[1]-Uw[1]*Uw[0],Gw[8]=1,Gw[kw(0,2)]=-Object(di["g"])(zw(Gw,0),e),Gw[kw(1,2)]=-Object(di["g"])(zw(Gw,1),e);let n=Object(di["g"])(zw(Gw,0),i)+Gw[kw(0,2)],s=Object(di["g"])(zw(Gw,1),i)+Gw[kw(1,2)],o=Object(di["g"])(zw(Gw,0),r)+Gw[kw(0,2)],c=Object(di["g"])(zw(Gw,1),r)+Gw[kw(1,2)];n=-(n+o)/(s+c),Gw[kw(0,0)]+=Gw[kw(1,0)]*n,Gw[kw(0,1)]+=Gw[kw(1,1)]*n,Gw[kw(0,2)]+=Gw[kw(1,2)]*n,n=1/(Object(di["g"])(zw(Gw,0),i)+Gw[kw(0,2)]),s=1/(Object(di["g"])(zw(Gw,1),i)+Gw[kw(1,2)]),Gw[kw(0,0)]*=n,Gw[kw(0,1)]*=n,Gw[kw(0,2)]*=n,Gw[kw(1,0)]*=s,Gw[kw(1,1)]*=s,Gw[kw(1,2)]*=s,Gw[kw(2,0)]=Gw[kw(1,0)],Gw[kw(2,1)]=Gw[kw(1,1)],Gw[kw(2,2)]=Gw[kw(1,2)],Gw[kw(1,2)]+=1,n=Object(di["g"])(zw(Gw,1),t)+Gw[kw(1,2)],s=Object(di["g"])(zw(Gw,2),t)+Gw[kw(2,2)],o=Object(di["g"])(zw(Gw,1),i)+Gw[kw(1,2)],c=Object(di["g"])(zw(Gw,2),i)+Gw[kw(2,2)],n=-.5*(n/s+o/c),Gw[kw(1,0)]+=Gw[kw(2,0)]*n,Gw[kw(1,1)]+=Gw[kw(2,1)]*n,Gw[kw(1,2)]+=Gw[kw(2,2)]*n,n=Object(di["g"])(zw(Gw,1),t)+Gw[kw(1,2)],s=Object(di["g"])(zw(Gw,2),t)+Gw[kw(2,2)],o=-s/n,Gw[kw(1,0)]*=o,Gw[kw(1,1)]*=o,Gw[kw(1,2)]*=o,a[0]=Gw[0],a[1]=Gw[1],a[2]=0,a[3]=Gw[2],a[4]=Gw[3],a[5]=Gw[4],a[6]=0,a[7]=Gw[5],a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=Gw[6],a[13]=Gw[7],a[14]=0,a[15]=Gw[8]}var Hw=cw;const Nw=Et["b"].create();class qw{constructor(){this._worldPlane=Nw}get isEnabled(){return this.plane!==Nw}get plane(){return this._worldPlane}set plane(e){this._worldPlane=e||Nw}}var Ww=qw;class Zw{constructor(e){this.resourceLoadingPromise=null,this.isEnabled=!1,this.vertexAttributeLocations={vPosition:0},this.vertexBufferLayout=[{name:"vPosition",count:2,type:5126,offset:0,stride:8,normalized:!1}],this.rctx=e}loadResources(e){if(!this.data||!this.textureArea||!this.textureSearch){const t=this.resourceLoadingPromise||this.loadDataModule().then(()=>this.loadTextures());return e&&t.then(e),this.resourceLoadingPromise||(this.resourceLoadingPromise=t,t.then(()=>this.resourceLoadingPromise=null)),!1}return!0}loadDataModule(){return this.data?Promise.resolve():i.e("chunk-2d21aaeb").then(i.bind(null,"bd0c")).then(e=>{this.data=e})}loadTextures(){return Promise.all([this.loadTextureFromBase64(this.data.areaTexture,9729,6407),this.loadTextureFromBase64(this.data.searchTexure,9728,6409)]).then(([e,t])=>{this.textureArea=e,this.textureSearch=t})}get isLoadingResources(){return null!=this.resourceLoadingPromise}enable(){if(this.isEnabled)return!0;if(!this.loadResources())return!1;const e=this.rctx;this.programEdgeDetect=new Nt["a"](e,this.data.edgeDetectShader.vertex,this.data.edgeDetectShader.fragment,this.vertexAttributeLocations),this.programBlendWeights=new Nt["a"](e,this.data.blendWeightShader.vertex,this.data.blendWeightShader.fragment,this.vertexAttributeLocations),this.programBlur=new Nt["a"](e,this.data.blurShader.vertex,this.data.blurShader.fragment,this.vertexAttributeLocations),this.pipelineState=Object(qt["e"])({colorWrite:qt["c"]});const t=new Float32Array([-1,-1,3,-1,-1,3]);return this.vao=new ri["a"](e,this.vertexAttributeLocations,{geometry:this.vertexBufferLayout},{geometry:ei["a"].createVertex(e,35044,t)}),this.tmpFramebufferEdges=new cy["a"](this.rctx,{colorTarget:0,depthStencilTarget:0},{target:3553,pixelFormat:6407,dataType:5121,samplingMode:9729,wrapMode:33071,width:4,height:4}),this.tmpFramebufferBlend=new cy["a"](this.rctx,{colorTarget:0,depthStencilTarget:0},{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:4,height:4}),this.isEnabled=!0,!0}disable(){this.isEnabled&&(this.programEdgeDetect.dispose(),this.programEdgeDetect=null,this.programBlendWeights.dispose(),this.programBlendWeights=null,this.programBlur.dispose(),this.programBlur=null,this.vao.dispose(),this.vao=null,this.textureArea.dispose(),this.textureArea=null,this.textureSearch.dispose(),this.textureSearch=null,this.tmpFramebufferBlend.dispose(),this.tmpFramebufferBlend=null,this.tmpFramebufferEdges.dispose(),this.tmpFramebufferEdges=null,this.isEnabled=!1)}render(e){this.enable();const t=this.rctx,i=t.getBoundFramebufferObject(),r={x:0,y:0,width:e.colorTexture.descriptor.width,height:e.colorTexture.descriptor.height};t.bindVAO(this.vao),t.setPipelineState(this.pipelineState),t.setViewport(r.x,r.y,r.width,r.height),this.tmpFramebufferEdges.resize(r.width,r.height),t.bindFramebuffer(this.tmpFramebufferEdges),t.setClearColor(0,0,0,1),t.clear(16384),t.bindProgram(this.programEdgeDetect),t.bindTexture(e.colorTexture,0),this.programEdgeDetect.setUniform1i("tColor",0),this.programEdgeDetect.setUniform4f("uResolution",1/r.width,1/r.height,r.width,r.height),t.drawArrays(4,0,3),this.tmpFramebufferBlend.resize(r.width,r.height),t.bindFramebuffer(this.tmpFramebufferBlend),t.setClearColor(0,0,1,1),t.clear(16384),t.bindProgram(this.programBlendWeights),this.programBlendWeights.setUniform4f("uResolution",1/r.width,1/r.height,r.width,r.height),t.bindTexture(this.textureSearch,1),this.programBlendWeights.setUniform1i("tSearch",1),t.bindTexture(this.textureArea,2),this.programBlendWeights.setUniform1i("tArea",2),t.bindTexture(this.tmpFramebufferEdges.colorTexture,3),this.programBlendWeights.setUniform1i("tEdges",3),t.drawArrays(4,0,3),t.bindFramebuffer(i),t.setClearColor(0,1,0,1),t.clear(16384),t.bindProgram(this.programBlur),this.programBlur.setUniform4f("uResolution",1/r.width,1/r.height,r.width,r.height),t.bindTexture(e.colorTexture,0),this.programBlur.setUniform1i("tColor",0),t.bindTexture(this.tmpFramebufferBlend.colorTexture,1),this.programBlur.setUniform1i("tBlendWeights",1),t.drawArrays(4,0,3)}loadTextureFromBase64(e,t,i){const r=new ti["a"](this.rctx,{pixelFormat:i,dataType:5121,wrapMode:33071,samplingMode:t},null);return Object(Ft["a"])(e).then(e=>(r.resize(e.width,e.height),r.setData(e),r))}}var $w=Zw,Qw=i("36df");class Xw extends Bt["a"]{initializeProgram(e){const t=Xw.shader.get(),i=this.configuration,r=t.build({output:i.output,samples:i.samples,radius:i.radius});return new Nt["a"](e.rctx,r.generateSource("vertex"),r.generateSource("fragment"),zt["a"])}initializePipeline(){return Object(qt["e"])({colorWrite:qt["c"]})}}Xw.shader=new Gt["a"](Qw["a"],()=>i.e("chunk-2d0ab6a6").then(i.bind(null,"14d1")));class Yw extends Ht["a"]{constructor(){super(...arguments),this.output=0,this.samples=64,this.radius=4}}Object(d["a"])([Object(Ht["b"])({count:2})],Yw.prototype,"output",void 0),Object(d["a"])([Object(Ht["b"])()],Yw.prototype,"samples",void 0),Object(d["a"])([Object(Ht["b"])()],Yw.prototype,"radius",void 0);const Kw=f["a"].getLogger("esri.views.3d.webgl-engine.lib.SSAOHelper"),Jw=4;class eS{constructor(e,t,i){this._enabled=!1,this._BLUR_F=2,this._attenuation=.5,this._radius=3,this._samples=16,this._viewportToRestore=Object(Lt["c"])(),this.quadVAO=null,this._rctx=t,this._techniqueRep=e,this._requestRender=i,this._ssaoTechniqueConfig=new Yw,this._emptyTexture=Object(Ii["a"])(t,[1,1,1,1])}dispose(){this._emptyTexture.dispose(),this._emptyTexture=null,Object(p["k"])(this.quadVAO)&&(this.quadVAO=Object(p["f"])(this.quadVAO))}get isSupported(){const e=this._rctx,t=-1!==e.parameters.versionString.indexOf("WebGL 0.93"),i=-1!==e.parameters.versionString.indexOf("WebGL 0.94");return!(t||i)}set enabled(e){e?this.enable():this.disable()}get enabled(){return this._enabled}set attenuation(e){this._attenuation=e}get attenuation(){return this._attenuation}set radius(e){this._radius=e}get radius(){return this._radius}get filterRadius(){return Jw}set samples(e){this._samples=e,this._enabled&&this.selectPrograms()}get samples(){return this._samples}computeSSAO(e,t,i){if(!this._noiseTexture)return;Object(Mi["a"])(this.enabled);const r=this._rctx,a=e.fullViewport,n=a[2],s=a[3],o=n/this._BLUR_F,c=s/this._BLUR_F;this._ssaoFBO.resize(n,s),this._blur0FBO.resize(o,c),this._blur1FBO.resize(o,c);const l=1,h=1,d=n*l,u=s*h;r.bindFramebuffer(this._ssaoFBO),Object(ui["c"])(this._viewportToRestore,e.fullViewport),r.setViewport(0,0,n,s);const f=this._ssaoTechnique.program,m=this._blurTechnique.program;r.bindProgram(f),r.setPipelineState(this._ssaoTechnique.pipeline),f.setUniform2f("rnmScale",n/this._noiseTexture.descriptor.width,s/this._noiseTexture.descriptor.height),f.setUniform3fv("pSphere",this._samples<=8?this._data.random8:this._samples<=16?this._data.random16:this._samples<=32?this._data.random32:this._data.random64);const b=this._data.minDiscrepancy,g=this._samples<b.length?b[this._samples]:5779;f.setUniform1f("numSpiralTurns",g);const v=iS,y=tS;Object(Mi["f"])(e.projectionMatrix,e.fullWidth,e.fullHeight,v,y),f.setUniform4fv("projInfo",v),f.setUniform2fv("zScale",y),f.setUniform2f("nearFar",e.near,e.far);let O=1/e.computeRenderPixelSizeAtDist(1);f.setUniform1f("projScale",O*l),f.setUniform2f("screenDimensions",d,u);let _=2*this._radius;const x=Object(It["p"])(e.eye,e.center);_=20*e.computeRenderPixelSizeAtDist(x),_=Math.max(.1,_),f.setUniform1f("radius",_),f.setUniform1f("intensity",4*this._attenuation/_**6),f.setUniform1i("rnm",0),f.setUniform1i("normalMap",1),f.setUniform1i("depthMap",2),r.bindTexture(this._noiseTexture,0),r.bindTexture(i,1),r.bindTexture(t,2),Object(p["k"])(this.quadVAO)||(this.quadVAO=Object(Ii["d"])(this._rctx));const j=this.quadVAO;r.bindVAO(j),r.drawArrays(5,0,Object(ii["f"])(j,"geometry"));const w=(Jw+1)/2,S=1/(2*w*w);r.bindTexture(this._ssaoFBO.colorTexture,0),r.setViewport(0,0,d/this._BLUR_F,u/this._BLUR_F),r.bindFramebuffer(this._blur0FBO),r.bindProgram(m),m.setUniform2f("screenDimensions",d,u),m.setUniform1i("tex",0),m.setUniform1i("normalMap",1),m.setUniform1i("depthMap",2),m.setUniform2f("blurSize",0,this._BLUR_F*l/u),m.setUniform1i("radius",Jw),m.setUniform1f("g_BlurFalloff",S),m.setUniform2f("nearFar",e.near,e.far),x>5e4&&(O=Math.max(0,O-(x-5e4))),m.setUniform1f("projScale",O),m.setUniform2f("zScale",1,0),r.drawArrays(5,0,Object(ii["f"])(j,"geometry")),m.setUniform2f("blurSize",this._BLUR_F*h/d,0),r.bindFramebuffer(this._blur1FBO),r.bindTexture(this._blur0FBO.colorTexture,0),r.drawArrays(5,0,Object(ii["f"])(j,"geometry")),r.setViewport(this._viewportToRestore[0],this._viewportToRestore[1],this._viewportToRestore[2],this._viewportToRestore[3])}setUniforms(e,t){const i=this.enabled&&this._noiseTexture,r=this._rctx;r.bindTexture(i?this._blur1FBO.colorTexture:this._emptyTexture,t),r.setActiveTexture(0),e.setUniform1i("ssaoTex",t),i?e.setUniform4f("viewportPixelSz",this._viewportToRestore[0],this._viewportToRestore[1],1/this._ssaoFBO.width,1/this._ssaoFBO.height):e.setUniform4f("viewportPixelSz",-1,-1,-1,-1)}bindToAllPrograms(e){const t=e.getProgramsUsingUniform("viewportPixelSz");for(const i of t)this.setUniforms(i,sw["a"].SSAO)}selectPrograms(){const e=this._samples<=8?8:this._samples<=16?16:this._samples<=32?32:64;this._ssaoTechniqueConfig.samples=e,this._ssaoTechniqueConfig.radius=Jw,this._ssaoTechniqueConfig.output=0,this._ssaoTechnique=this._techniqueRep.acquireAndReleaseExisting(Xw,this._ssaoTechniqueConfig,this._ssaoTechnique),this._ssaoTechniqueConfig.output=1,this._blurTechnique=this._techniqueRep.acquireAndReleaseExisting(Xw,this._ssaoTechniqueConfig,this._blurTechnique)}enable(){this.enabled||(this.isSupported?(this._enabled=!0,this.loadResources(()=>{this._enabled&&this.initialize()})):Kw.warn("SSAO is not supported for this browser or hardware"))}loadResources(e){this._data?e():i.e("chunk-2d0be660").then(i.bind(null,"2fa7")).then(t=>{this._data=t,e()})}initialize(){const e={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0},t={colorTarget:0,depthStencilTarget:0};this._ssaoFBO=new cy["a"](this._rctx,t,e),this._blur0FBO=new cy["a"](this._rctx,t,e),this._blur1FBO=new cy["a"](this._rctx,t,e),Object(Ft["a"])(this._data.noiseTexture).then(e=>{this._enabled&&(this._noiseTexture=new ti["a"](this._rctx,{target:3553,pixelFormat:6408,dataType:5121,hasMipmap:!0,width:e.width,height:e.height},e),this._requestRender())}),this.selectPrograms()}disable(){this.enabled&&(this._enabled=!1,this._noiseTexture&&(this._noiseTexture.dispose(),this._noiseTexture=null),this._blur1FBO&&(this._blur1FBO.dispose(),this._blur1FBO=null),this._blur0FBO&&(this._blur0FBO.dispose(),this._blur0FBO=null),this._ssaoFBO&&(this._ssaoFBO.dispose(),this._ssaoFBO=null))}getGpuMemoryUsage(){return Object(ii["c"])(this._blur0FBO)+Object(ii["c"])(this._blur1FBO)+Object(ii["c"])(this._ssaoFBO)}get test(){return{ssao:this._ssaoFBO,blur:this._blur1FBO}}}const tS=Object(hi["b"])(),iS=Object(Lt["c"])();var rS=eS,aS=i("5a22"),nS=i("adf1"),sS=i("4c96");function oS(e,t){const i=t,r=-e[0],a=-e[1],n=-e[2],s=i[3],o=i[7],c=i[11],l=i[15];i[0]+=s*r,i[1]+=s*a,i[2]+=s*n,i[4]+=o*r,i[5]+=o*a,i[6]+=o*n,i[8]+=c*r,i[9]+=c*a,i[10]+=c*n,i[12]+=l*r,i[13]+=l*a,i[14]+=l*n}function cS(e,t){const i=t,r=e[0],a=e[1],n=e[2];i[12]+=r*i[0]+a*i[4]+n*i[8],i[13]+=r*i[1]+a*i[5]+n*i[9],i[14]+=r*i[2]+a*i[6]+n*i[10],i[14]+=r*i[3]+a*i[7]+n*i[11]}class lS{constructor(e){this.factory=e,this.originData=new Map}acquire(e){return this.register(this.factory.getOrigin(e))}register(e){const t=this.originData.get(e.id);return t?(t.refCount++,t.origin):(this.originData.set(e.id,{refCount:1,viewMatrix:Object(kt["b"])(),origin:e}),e)}release(e){const t=this.originData.get(e.id);t&&(t.refCount--,0===t.refCount&&this.originData.delete(e.id))}updateViewMatrices(e){this.originData.forEach(t=>{Object(Vt["c"])(t.viewMatrix,e),cS(t.origin.vec3,t.viewMatrix)})}getViewMatrix(e){return this.originData.get(e.id).viewMatrix}}var hS=i("0c9d"),dS=i("7e0c"),uS=i("c6d7"),pS=i("5e2a");const fS=-4e-4,mS=.5;class bS extends Bt["a"]{bindPass(e,t){const i=this.program,{edgeRenderParameters:r,bindParameters:a}=t;Q_["a"].bindViewProjTransform(i,r.viewProjectionTransform),i.setUniformMatrix3fv("uTransformNormal_ViewFromGlobal",r.transformNormal_ViewFromGlobal),i.setUniformMatrix4fv("uProj",a.camera.projectionMatrix),i.setUniform2f("uDepthBias",mS,fS),i.setUniform2f("uPixelToNDC",2/a.camera.fullViewport[2],2/a.camera.fullViewport[3]),i.setUniform2f("uNDCToPixel",a.camera.fullViewport[2]/2,a.camera.fullViewport[3]/2),i.setUniform1f("uDistanceFalloffFactor",r.distanceFalloffFactor),i.setUniform2f("uViewportDimInv",1/a.camera.fullViewport[2],1/a.camera.fullViewport[3]),i.setUniform1f("uPixelRatio",a.camera.pixelRatio||1)}initializeProgram(e){const t=bS.shader.get(),i=this.configuration,r=t.build({slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,silhouette:i.silhouette,legacy:i.legacy,antialiasing:i.antialiasing,mode:i.mode,doublePrecisionRequiresObfuscation:i.doublePrecisionRequiresObfuscation,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new Nt["a"](e.rctx,r.generateSource("vertex"),r.generateSource("fragment"),t.attributeLocations)}initializePipeline(e){const t=e.rctx.capabilities.blendMinMax;return Object(qt["e"])(t?{blending:Object(qt["f"])(1,1,0,1,32774,t.MAX),depthTest:{func:515},colorWrite:qt["c"]}:{depthTest:{func:515},depthWrite:qt["d"],colorWrite:qt["c"]})}}bS.shader=new Gt["a"](pS["a"],()=>i.e("chunk-2d21444b").then(i.bind(null,"afe5"))),function(e){class t extends Ht["a"]{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.silhouette=!1,this.legacy=!1,this.antialiasing=!1,this.mode=0,this.doublePrecisionRequiresObfuscation=!1,this.multipassTerrainEnabled=!1,this.cullAboveGround=!0}}Object(d["a"])([Object(Ht["b"])()],t.prototype,"slicePlaneEnabled",void 0),Object(d["a"])([Object(Ht["b"])()],t.prototype,"silhouette",void 0),Object(d["a"])([Object(Ht["b"])()],t.prototype,"legacy",void 0),Object(d["a"])([Object(Ht["b"])()],t.prototype,"antialiasing",void 0),Object(d["a"])([Object(Ht["b"])({count:3})],t.prototype,"mode",void 0),Object(d["a"])([Object(Ht["b"])()],t.prototype,"doublePrecisionRequiresObfuscation",void 0),Object(d["a"])([Object(Ht["b"])()],t.prototype,"multipassTerrainEnabled",void 0),Object(d["a"])([Object(Ht["b"])()],t.prototype,"cullAboveGround",void 0),e.Configuration=t}(bS||(bS={}));const gS=8,vS=128,yS={type:"uber",slicePlaneEnabled:!1,sliceHighlightDisabled:!1,strokesTexture:null,legacy:!0};class OS{constructor(){this._value=0}get value(){return this._value}increment(){this._value++}decrement(){this._value--}}const _S={solid:0,sketch:1,uber:2};class xS{constructor(e,t,i){this.rctx=e,this.shaderTechniqueRepository=t,this.config=new bS.Configuration,this.technique=null,this.refCount=new OS,this.renderables=new Set,this.sortedRenderables={1:{1:new fd["a"],2:new fd["a"]},2:{1:new fd["a"],2:new fd["a"]}},this.renderablesDirty=!1,this.settings={...yS,...i},this.key=xS.getKey(this.settings.type,this.settings.slicePlaneEnabled,this.settings.legacy);const r=this.settings.strokesTexture.variants;this.writerSettings={variants:r,reducedPrecision:dd["a"].DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES},this.config.legacy=this.settings.legacy,this.config.mode=_S[this.settings.type],this.config.silhouette=!1,this.config.antialiasing=!!this.rctx.capabilities.blendMinMax,this.config.slicePlaneEnabled=this.settings.slicePlaneEnabled,this.config.doublePrecisionRequiresObfuscation=Object(Z_["b"])(e)}dispose(){this.technique&&(this.shaderTechniqueRepository.release(this.technique),this.technique=null)}addRenderable(e){this.renderables.add(e),this.renderablesDirty=!0}removeRenderable(e){this.renderables.delete(e),this.renderablesDirty=!0}setRenderablesDirty(){this.renderablesDirty=!0}forEachRenderable(e,t){this.renderablesDirty&&this.sortRenderables(),this.sortedRenderables[t][1].forAll(e),this.sortedRenderables[t][2].forAll(e)}setMultipassParameters(e){this.config.multipassTerrainEnabled=!!e.multipassTerrainEnabled&&e.multipassTerrainEnabled,this.config.cullAboveGround=!!e.cullAboveGround&&e.cullAboveGround}bindRegularEdges(e,t){this.setMultipassParameters(e),this.config.silhouette=!1,this.technique=this.shaderTechniqueRepository.acquireAndReleaseExisting(bS,this.config,this.technique),this.technique.bindPass(this.rctx,{bindParameters:e,edgeRenderParameters:t}),this.rctx.setPipelineState(this.technique.pipeline),this.rctx.bindProgram(this.technique.program)}bindSilhouetteEdges(e,t){this.setMultipassParameters(e),this.config.silhouette=!0,this.technique=this.shaderTechniqueRepository.acquireAndReleaseExisting(bS,this.config,this.technique),this.technique.bindPass(this.rctx,{bindParameters:e,edgeRenderParameters:t}),this.rctx.setPipelineState(this.technique.pipeline),this.rctx.bindProgram(this.technique.program)}renderRegularEdges(e,t,i){this.render(this.technique.program,e,e.regular.vao,t,i)}renderSilhouetteEdges(e,t,i){this.render(this.technique.program,e,e.silhouette.vao,t,i)}render(e,t,i,r,a){this.setUniforms(e,t,r),this.rctx.bindVAO(i),this.rctx.capabilities.instancing.drawArraysInstanced(6,0,4,a)}setUniforms(e,t,i){if(t.components.buffer.textureBuffer.bind(e,jS),i.multipassTerrainEnabled&&(e.setUniform2fv("cameraNearFar",i.camera.nearFar),e.setUniform2fv("inverseViewport",i.inverseViewport),Object(uS["a"])(e,this.rctx,i)),"origin"in t.transform)e.setUniformMatrix4fv("uView",i.localViewMatrixForEdges),e.setUniformMatrix4fv("uModel",t.transform.modelMatrix),Jv["a"].bindUniforms(e,this.settings,i.slicePlane,t.transform.origin.vec3);else{const r=new px(t.transform.position),a=Object(Jn["n"])(wS,Object(Jn["d"])(wS,t.transform.rotationScale)),n=new ex;Object(It["l"])(n.worldFromModel_TL,r.low),Object(It["l"])(n.worldFromModel_TH,r.high),Object(Jn["e"])(n.worldFromModel_RS,t.transform.rotationScale),Object(Jn["e"])(n.transformNormal_GlobalFromModel,a),Q_["a"].bindModelTransform(e,n),e.setUniformMatrix3fv("uTransformNormal_GlobalFromModel",n.transformNormal_GlobalFromModel);const s=i.camera.viewInverseTransposeMatrix,o=Object(It["x"])(SS,s[3],s[7],s[11]);Jv["a"].bindUniforms(e,this.settings,i.slicePlane,o)}"uber"!==this.settings.type&&"sketch"!==this.settings.type||this.setSketchUniforms(e),e.setUniform1f("uWorldLineRadiusPerDistance",Math.tan(i.camera.fovY/2)/(i.camera.fullViewport[3]/2))}setSketchUniforms(e){const t=this.settings.strokesTexture,i=t.texture;Object(p["j"])(i)||(this.rctx.bindTexture(i,0),e.setUniform1i("uStrokesTexture",0),e.setUniform2f("uStrokesTextureScale",1/i.descriptor.width,1/i.descriptor.height),e.setUniform1f("uStrokesLog2Resolution",Object(Qe["m"])(t.resolution)),e.setUniform1f("uStrokesNormalizationScale",t.normalizationScale),e.setUniform1f("uStrokesAmplitude",t.amplitude),e.setUniform1f("uStrokeVariants",t.variants))}sortRenderables(){this.renderablesDirty=!1,this.sortedRenderables[1][1].clear(),this.sortedRenderables[1][2].clear(),this.sortedRenderables[2][1].clear(),this.sortedRenderables[2][2].clear(),this.renderables.forEach(e=>{0!==e.objectTransparency&&0!==e.edgeTransparency&&this.sortedRenderables[e.objectTransparency][e.edgeTransparency].push(e)});const e=(e,t)=>"origin"in e.transform&&"origin"in t.transform?e.transform.origin.id<t.transform.origin.id?-1:e.transform.origin.id>t.transform.origin.id?1:0:0;this.sortedRenderables[1][1].sort(e),this.sortedRenderables[1][2].sort(e),this.sortedRenderables[2][1].sort(e),this.sortedRenderables[2][2].sort(e)}static getKey(e,t,i){return`edges-t:${e}:${t}:${i}`}}const jS={texName:"uComponentDataTex",invDimName:"uComponentDataTexInvDim",unit:2},wS=Object(FO["b"])(),SS=Object(M["e"])();var CS=i("78ba"),TS=i("0480"),PS=i("2273");class AS extends CS["a"]{constructor(e){super("EdgeProcessingWorker","wrappedWork",e)}async process(e,t,i){if(i)return Object(PS["work"])(e);const r=this._packInput(e),a=await this.invoke(r,t);return this._unpackOutput(a)}getTransferList(e){return[e.dataBuffer]}_packInput(e){return{dataBuffer:e.data.buffer,writerSettings:e.writerSettings,skipDeduplicate:e.skipDeduplicate,indicesBuffer:e.indices.buffer,indicesType:Object(GO["j"])(e.indices)?"Uint32Array":"Uint16Array",indicesLength:e.indicesLength}}_unpackOutput(e){return{regular:{instancesData:Object(TS["b"])(e.regular.instancesData),lodInfo:{lengths:new Float32Array(e.regular.lodInfo.lengths)}},silhouette:{instancesData:Object(TS["b"])(e.silhouette.instancesData),lodInfo:{lengths:new Float32Array(e.silhouette.lodInfo.lengths)}},averageEdgeLength:e.averageEdgeLength}}}var RS=AS;function MS(e){const t=4,i=VS.resolution,r=i/2,a=new Uint8Array(t*i*i),n=t*i*r,s=VS.amplitude,o=2*s,c=t*i,l=Object(Qe["m"])(i)+1,h=VS.strokes.length;let d=(l-1)*h*c;for(const{distance:p,pressure:f}of VS.strokes){let e=p,i=f,r=d;for(let s=0;s<l;s++){0!==s&&(e=ES(e,0),i=ES(i,1));for(let s=0;s<VS.resolution;s++){const c=.5+(e?e[s%e.length]/o:0),l=i?i[s%i.length]:1;Object(Mi["i"])(c,a,r),Object(Mi["i"])(l,a,r+n),r+=t}r-=c*(h+1)}d+=c}const u=new ti["a"](e,{pixelFormat:6408,dataType:5121,hasMipmap:!1,samplingMode:9729,width:i,height:i,wrapMode:10497},a);return new LS(i,o,s,h,u)}function ES(e,t){if(!e)return null;const i=e.length/2,r=DS*i,a=new Array(i);let n=0;const s=1===t;for(let o=0;o<e.length;o+=2){const t=(e[o]+e[o+1])/2;a[n++]=s?Math.min(r,1-(1-t)*IS):Math.min(r,t*IS)}return a}const DS=.1,IS=.5;class LS{constructor(e,t,i,r,a){this.resolution=e,this.normalizationScale=t,this.amplitude=i,this.variants=r,this.texture=a}dispose(){this.texture=Object(p["f"])(this.texture)}}const VS={amplitude:8,resolution:256,strokes:[{distance:[-1.59027,-1.59426,-1.59674,-1.59766,-1.59702,-1.59479,-1.59095,-1.5855,-1.57843,-1.56973,-1.55942,-1.5475,-1.53398,-1.5189,-1.50226,-1.4841,-1.46446,-1.44337,-1.42088,-1.39703,-1.37188,-1.34547,-1.31786,-1.28912,-1.2593,-1.22847,-1.19668,-1.16402,-1.13053,-1.09629,-1.06137,-1.02582,-.98972,-.95313,-.91611,-.87872,-.84102,-.80306,-.76488,-.72654,-.68807,-.64952,-.61092,-.57232,-.53375,-.49527,-.45692,-.41874,-.38078,-.34309,-.3057,-.26867,-.23204,-.19585,-.16015,-.12497,-.09036,-.05634,-.02296,.00977,.04183,.07321,.10389,.13386,.16313,.19169,.21956,.24672,.27321,.299,.32413,.34858,.37237,.3955,.41798,.43981,.461,.48154,.50145,.52073,.53939,.55744,.57488,.5917,.6079,.62347,.63837,.65259,.66609,.67885,.69083,.70201,.71235,.72183,.73042,.73812,.7449,.75076,.7557,.75973,.76284,.76507,.76642,.76692,.76659,.76545,.76352,.76083,.7574,.75324,.74837,.74279,.73652,.72959,.72199,.71377,.70493,.69553,.68558,.67515,.66426,.65298,.64135,.62944,.6173,.60499,.59257,.58008,.56759,.55513,.54275,.5305,.51842,.50654,.4949,.48353,.47246,.4617,.45128,.44121,.43149,.42213,.41313,.40448,.39617,.38818,.3805,.37309,.36594,.35902,.35229,.34572,.33927,.33292,.32663,.32035,.31407,.30774,.30135,.29486,.28824,.28148,.27454,.26739,.26002,.25241,.24454,.23639,.22796,.21922,.21016,.20076,.19098,.18082,.17023,.1592,.14768,.13566,.1231,.10996,.09624,.08188,.06688,.05121,.03485,.01778,0,-.0185,-.03771,-.05763,-.07824,-.09952,-.12144,-.14396,-.16706,-.19069,-.21481,-.23938,-.26436,-.28971,-.31539,-.34136,-.36759,-.39404,-.42067,-.44746,-.47437,-.50136,-.52839,-.55544,-.58248,-.60948,-.63642,-.66329,-.6901,-.71684,-.74352,-.77015,-.79675,-.82332,-.84988,-.87644,-.90301,-.92958,-.95615,-.98272,-1.00926,-1.03575,-1.06217,-1.08847,-1.11463,-1.1406,-1.16633,-1.19178,-1.2169,-1.24164,-1.26595,-1.28979,-1.31312,-1.3359,-1.35809,-1.37963,-1.4005,-1.42064,-1.44,-1.45853,-1.47616,-1.49285,-1.50853,-1.52313,-1.53659,-1.54886,-1.55986,-1.56955,-1.57788,-1.5848],pressure:[-.01365,-.00206,.01025,.02327,.03696,.05129,.06619,.08163,.09755,.11393,.1307,.14784,.16531,.18308,.20111,.21938,.23786,.25651,.2753,.29419,.31315,.33215,.35115,.37015,.38913,.40806,.42694,.44576,.46449,.48313,.50167,.5201,.53839,.55653,.57448,.59222,.60971,.62692,.6438,.66033,.67648,.69221,.70753,.72242,.73688,.75093,.76456,.77779,.79063,.80309,.81517,.82686,.83817,.84911,.85967,.86987,.87972,.88924,.89845,.90734,.91594,.92425,.93229,.94005,.94754,.95475,.96166,.96826,.97451,.9804,.98588,.99092,.99549,.99957,.99685,.99381,.99131,.98936,.98796,.98711,.98681,.98706,.98787,.98923,.99113,.99357,.99654,1,.99607,.99171,.98695,.98181,.97634,.97057,.96452,.95824,.95175,.94506,.93818,.93113,.92389,.91647,.90887,.90109,.89314,.88501,.87672,.86831,.85978,.85119,.84256,.83393,.82533,.8168,.80836,.80002,.79181,.78374,.77582,.7681,.76059,.75331,.74629,.73955,.73311,.72697,.72116,.71568,.71054,.70572,.70121,.697,.69304,.68931,.68576,.68236,.67905,.67582,.67262,.66941,.66619,.66291,.65957,.65613,.65259,.64892,.6451,.6411,.6369,.63248,.62783,.62295,.61783,.61247,.60688,.60104,.59498,.58868,.58216,.57542,.56845,.56125,.5538,.5461,.53813,.52986,.52129,.51239,.50316,.49359,.4837,.47349,.46299,.45223,.44124,.43005,.41869,.40719,.39557,.38386,.37207,.36023,.34836,.33648,.32464,.31287,.30119,.28963,.27822,.26698,.25594,.2451,.23448,.22409,.21391,.20394,.19415,.18452,.17503,.16565,.15636,.14713,.13794,.1288,.11968,.11058,.10151,.09247,.08346,.07447,.06552,.05659,.0477,.03885,.03007,.02137,.01278,.00433,-.00393,-.012,-.01983,-.02738,-.03463,-.04155,-.0481,-.05429,-.0601,-.06553,-.07057,-.07524,-.07954,-.08347,-.08703,-.09022,-.09303,-.09544,-.09744,-.09898,-.10004,-.10059,-.1006,-.10005,-.09892,-.0972,-.09487,-.09192,-.08833,-.08409,-.07918,-.07357,-.06724,-.06019,-.0524,-.04386,-.03455,-.02448]},{distance:[-3.46259,-3.47131,-3.47668,-3.47863,-3.47712,-3.4721,-3.46352,-3.45138,-3.43566,-3.41635,-3.39347,-3.36704,-3.33709,-3.30368,-3.26684,-3.22667,-3.18322,-3.1366,-3.08689,-3.0342,-2.97865,-2.92036,-2.85946,-2.79607,-2.73034,-2.66241,-2.59242,-2.52052,-2.44686,-2.37159,-2.29485,-2.2168,-2.13757,-2.05731,-1.97616,-1.89426,-1.81174,-1.72875,-1.64543,-1.56191,-1.47833,-1.39483,-1.3115,-1.22847,-1.14581,-1.06361,-.98193,-.90083,-.82036,-.74054,-.66141,-.583,-.50532,-.4284,-.35228,-.277,-.20261,-.12916,-.05672,.01463,.08485,.15384,.22153,.28784,.35269,.41602,.47776,.53787,.59629,.653,.70799,.76123,.81274,.86253,.9106,.95698,1.0017,1.04477,1.0862,1.126,1.16415,1.20065,1.23546,1.26857,1.29994,1.32953,1.35731,1.38321,1.40719,1.42921,1.44922,1.46719,1.48309,1.49691,1.50862,1.51825,1.52581,1.53133,1.53486,1.53644,1.53616,1.53409,1.53031,1.52493,1.51803,1.50972,1.50009,1.48924,1.47725,1.46421,1.45019,1.43527,1.4195,1.40295,1.38568,1.36778,1.34929,1.3303,1.31087,1.29108,1.27099,1.25066,1.23018,1.2096,1.18898,1.16838,1.14785,1.12745,1.10721,1.08719,1.06741,1.04791,1.02871,1.00986,.99136,.97324,.95551,.93819,.92127,.90476,.88866,.87296,.85767,.84277,.82823,.81406,.80022,.7867,.77346,.76049,.74774,.73519,.72278,.71049,.69827,.68606,.67381,.66145,.64893,.63618,.62313,.60973,.5959,.5816,.56675,.5513,.53516,.51826,.50053,.4819,.46231,.44169,.42002,.39725,.37336,.34834,.32219,.2949,.2665,.23698,.20638,.17469,.14193,.10809,.07316,.03714,0,-.03827,-.07772,-.11836,-.16022,-.20332,-.24768,-.29332,-.34024,-.38844,-.43788,-.48854,-.54036,-.59329,-.64724,-.70211,-.75782,-.81425,-.87128,-.92881,-.98674,-1.04498,-1.10346,-1.1621,-1.22086,-1.27969,-1.33854,-1.3974,-1.45625,-1.51511,-1.57396,-1.63283,-1.69173,-1.75067,-1.80968,-1.86875,-1.9279,-1.98712,-2.04639,-2.10568,-2.16495,-2.22416,-2.28322,-2.34208,-2.40063,-2.4588,-2.51647,-2.57354,-2.62989,-2.68543,-2.74002,-2.79357,-2.84597,-2.89711,-2.94689,-2.99521,-3.04195,-3.087,-3.13023,-3.17152,-3.21075,-3.24779,-3.28252,-3.3148,-3.34451,-3.37154,-3.39577,-3.41709,-3.43539,-3.45059],pressure:[.87183,.87151,.87129,.87118,.87117,.87128,.87149,.87182,.87225,.8728,.87347,.87424,.87513,.87613,.87723,.87845,.87978,.88122,.88276,.88441,.88616,.88801,.88996,.892,.89414,.89637,.89868,.90108,.90356,.90611,.90874,.91144,.91421,.91704,.91993,.92287,.92587,.92892,.93201,.93514,.93831,.94151,.94474,.94799,.95126,.95456,.95786,.96118,.9645,.96783,.97116,.97448,.9778,.98111,.98441,.9877,.99096,.99421,.99742,.99938,.99622,.9931,.99001,.98697,.98397,.98101,.97811,.97526,.97246,.96972,.96703,.96441,.96185,.95935,.95691,.95455,.95225,.95002,.94786,.94577,.94376,.94182,.93995,.93817,.93646,.93483,.93328,.93181,.93042,.92911,.92788,.92673,.92566,.92467,.92376,.92293,.92217,.92149,.92088,.92034,.91987,.91947,.91913,.91886,.91864,.91849,.91838,.91833,.91834,.91839,.91849,.91863,.91883,.91907,.91935,.91968,.92005,.92046,.92092,.92142,.92195,.92253,.92314,.9238,.92449,.92521,.92598,.92677,.9276,.92847,.92936,.93029,.93125,.93224,.93325,.9343,.93537,.93646,.93758,.93872,.93988,.94106,.94225,.94346,.94469,.94593,.94718,.94844,.94971,.95098,.95226,.95354,.95482,.9561,.95738,.95867,.95995,.96122,.9625,.96377,.96504,.9663,.96757,.96883,.97009,.97135,.97261,.97387,.97513,.9764,.97767,.97895,.98023,.98153,.98284,.98416,.98549,.98684,.98821,.9896,.99101,.99244,.99389,.99537,.99688,.99842,1,.99839,.99675,.99508,.99336,.99161,.98982,.98799,.98613,.98422,.98228,.98029,.97827,.97622,.97414,.97202,.96987,.9677,.96551,.9633,.96107,.95882,.95656,.9543,.95202,.94975,.94747,.94519,.94292,.94065,.93838,.93613,.93388,.93164,.92941,.9272,.92499,.9228,.92062,.91846,.91631,.91418,.91207,.90998,.90792,.90588,.90387,.90189,.89995,.89804,.89617,.89434,.89256,.89083,.88914,.88752,.88595,.88443,.88299,.88161,.8803,.87907,.87791,.87683,.87584,.87494,.87412,.8734,.87278,.87225]},{distance:[.39335,.43437,.47737,.52234,.56923,.61801,.66864,.72109,.7753,.83123,.88882,.94801,1.00875,1.07097,1.13461,1.1996,1.26586,1.33333,1.40193,1.47158,1.54221,1.61373,1.68607,1.75913,1.83284,1.90711,1.98186,2.05699,2.13243,2.20809,2.28387,2.35971,2.4355,2.51117,2.58663,2.66179,2.73658,2.81092,2.88473,2.95792,3.03043,3.10217,3.17308,3.24309,3.31211,3.3801,3.44697,3.51267,3.57712,3.64028,3.70208,3.76247,3.8214,3.87881,3.93467,3.98892,4.04152,4.09244,4.14164,4.18908,4.23474,4.27859,4.32061,4.36077,4.39905,4.43544,4.46992,4.50249,4.53314,4.56185,4.58864,4.61349,4.63642,4.65745,4.67657,4.69381,4.7092,4.72274,4.73447,4.74441,4.75259,4.75903,4.76376,4.76682,4.76822,4.768,4.76618,4.76279,4.75786,4.75142,4.74348,4.73409,4.72326,4.71102,4.69739,4.68241,4.6661,4.64849,4.6296,4.60948,4.58816,4.56567,4.54204,4.51732,4.49154,4.46473,4.43694,4.4082,4.37854,4.348,4.31662,4.28443,4.25145,4.21773,4.1833,4.14819,4.11243,4.07606,4.03912,4.00162,3.96361,3.92512,3.88618,3.84683,3.80708,3.76697,3.72653,3.68579,3.64478,3.60351,3.56202,3.52033,3.47845,3.43642,3.39425,3.35196,3.30957,3.2671,3.22455,3.18196,3.13933,3.09668,3.05402,3.01136,2.96873,2.92613,2.88357,2.84108,2.79865,2.75631,2.71407,2.67195,2.62994,2.58807,2.54634,2.50477,2.46338,2.42216,2.38114,2.34032,2.29971,2.25933,2.21916,2.17923,2.13954,2.10008,2.06087,2.02189,1.98316,1.94468,1.90644,1.86845,1.83069,1.79316,1.75586,1.71877,1.68189,1.6452,1.60868,1.57232,1.53611,1.50004,1.46407,1.4282,1.39241,1.35668,1.321,1.28535,1.24972,1.2141,1.17849,1.14286,1.10723,1.07158,1.03593,1.00028,.96464,.92902,.89344,.85793,.8225,.78719,.75203,.71705,.68231,.64784,.61369,.57991,.54656,.51368,.48134,.44959,.41849,.3881,.35848,.32967,.30174,.27474,.24872,.22373,.19982,.17702,.15539,.13497,.11579,.09791,.08137,.06621,.05248,.04022,.02948,.02029,.01271,.00677,.00252,0,-76e-5,27e-5,.00314,.00788,.01451,.02307,.03357,.04604,.0605,.07697,.09546,.11599,.13858,.16322,.18992,.21869,.24952,.28241,.31735,.35434],pressure:[.95248,.95236,.95228,.95223,.95222,.95224,.95231,.95241,.95256,.95274,.95296,.95322,.95352,.95385,.95423,.95465,.9551,.9556,.95613,.9567,.95731,.95796,.95864,.95936,.96012,.96091,.96173,.96259,.96348,.9644,.96535,.96633,.96734,.96838,.96944,.97053,.97164,.97277,.97393,.9751,.97629,.9775,.97873,.97997,.98122,.98249,.98376,.98505,.98634,.98763,.98893,.99023,.99154,.99284,.99414,.99544,.99673,.99802,.9993,.99942,.99816,.99691,.99568,.99445,.99324,.99205,.99087,.98972,.98858,.98746,.98636,.98528,.98423,.9832,.98219,.98121,.98025,.97931,.9784,.97752,.97666,.97582,.97501,.97423,.97347,.97274,.97203,.97135,.9707,.97007,.96948,.9689,.96836,.96784,.96735,.96689,.96646,.96605,.96567,.96533,.965,.96471,.96445,.96421,.964,.96382,.96367,.96355,.96346,.96339,.96335,.96334,.96336,.9634,.96348,.96358,.9637,.96385,.96403,.96423,.96446,.96471,.96499,.96529,.96561,.96595,.96631,.96669,.96709,.96751,.96795,.9684,.96887,.96935,.96984,.97035,.97087,.9714,.97194,.97249,.97304,.97361,.97418,.97476,.97534,.97592,.97651,.97711,.9777,.9783,.9789,.9795,.9801,.9807,.9813,.9819,.9825,.98309,.98369,.98428,.98486,.98545,.98603,.98661,.98718,.98775,.98832,.98888,.98944,.99,.99056,.99112,.99167,.99223,.99279,.99335,.99392,.99449,.99507,.99565,.99624,.99684,.99745,.99807,.9987,.99934,1,.99933,.99866,.99797,.99727,.99656,.99583,.9951,.99435,.99359,.99283,.99205,.99126,.99046,.98966,.98885,.98803,.9872,.98637,.98554,.9847,.98387,.98303,.98219,.98134,.9805,.97967,.97883,.978,.97717,.97634,.97552,.97471,.97389,.97309,.97229,.9715,.97071,.96993,.96915,.96838,.96762,.96687,.96612,.96539,.96466,.96395,.96324,.96255,.96187,.9612,.96055,.95991,.95929,.95869,.95811,.95754,.957,.95648,.95599,.95552,.95508,.95467,.95428,.95393,.9536,.95331,.95305,.95283,.95264]},{distance:[2.85606,2.86149,2.86432,2.8645,2.862,2.85686,2.84912,2.83886,2.82618,2.81117,2.79393,2.77456,2.75314,2.72975,2.70447,2.67734,2.64844,2.61784,2.58564,2.55196,2.5169,2.48057,2.44305,2.40438,2.36462,2.32383,2.28208,2.23943,2.19591,2.15153,2.10628,2.06016,2.01321,1.96548,1.91702,1.86793,1.8183,1.76829,1.71803,1.66767,1.61737,1.56726,1.51746,1.46803,1.41902,1.37044,1.32228,1.27452,1.22716,1.18023,1.13376,1.08781,1.04244,.99769,.95357,.91003,.86701,.82447,.78238,.74069,.69938,.65836,.61758,.57699,.53656,.49627,.45611,.41611,.37632,.33683,.29776,.25924,.22141,.18441,.14839,.11346,.07972,.04727,.01619,-.01348,-.0417,-.0684,-.09351,-.11698,-.13875,-.1588,-.17713,-.19381,-.20889,-.22242,-.23444,-.24501,-.25421,-.26216,-.26897,-.27473,-.27951,-.28336,-.28631,-.28836,-.28948,-.28963,-.28873,-.28673,-.28355,-.27916,-.27354,-.26673,-.25878,-.2498,-.23992,-.22929,-.21802,-.20623,-.19398,-.18134,-.16836,-.1551,-.14163,-.12809,-.11461,-.1013,-.08826,-.07557,-.06335,-.0517,-.04077,-.03065,-.02143,-.01321,-.00606,0,.00496,.00888,.01181,.01385,.01511,.0157,.01574,.01533,.01458,.01358,.0124,.01112,.00979,.00851,.00738,.0065,.006,.00596,.00646,.00754,.00924,.01161,.01471,.01858,.02323,.02865,.03481,.04169,.0493,.05765,.06677,.07671,.08754,.09934,.11222,.12628,.14159,.15823,.17624,.19561,.21632,.23828,.26142,.28563,.31083,.33696,.36397,.39185,.42057,.4501,.48036,.51125,.54264,.5744,.60646,.63871,.67105,.70337,.73556,.76751,.79918,.83048,.86139,.8919,.92202,.95184,.98144,1.01094,1.04045,1.0701,1.10002,1.13029,1.16103,1.1923,1.22416,1.25664,1.28979,1.32364,1.35824,1.39363,1.42985,1.4669,1.50475,1.54332,1.58252,1.62227,1.6625,1.70312,1.744,1.78501,1.82598,1.8668,1.90734,1.94754,1.98732,2.02666,2.06555,2.10402,2.1421,2.17985,2.2173,2.25448,2.29139,2.328,2.36424,2.4,2.43515,2.46955,2.50309,2.53565,2.56717,2.59761,2.62692,2.65505,2.68191,2.7074,2.73138,2.75375,2.7744,2.79324,2.81017,2.82504,2.83772,2.8481],pressure:[.22758,.23641,.24578,.25568,.26609,.27699,.28835,.30016,.31237,.32495,.33789,.35113,.36466,.37843,.39241,.40658,.4209,.43535,.44989,.4645,.47916,.49385,.50853,.5232,.53784,.55243,.56696,.58141,.59578,.61004,.62419,.63821,.65209,.6658,.67934,.69268,.70582,.71873,.73139,.7438,.75594,.76779,.77935,.79061,.80156,.81221,.82254,.83258,.84231,.85176,.86091,.86978,.87837,.88669,.89473,.9025,.91,.91725,.92425,.931,.93752,.9438,.94985,.95566,.96124,.96658,.97168,.97652,.98109,.98539,.98939,.99309,.99646,.99949,.99783,.99552,.99361,.99209,.99098,.99029,.99003,.99019,.99079,.99181,.99324,.9951,.99735,1,.99698,.99361,.98992,.98592,.98163,.97709,.97231,.96731,.96212,.95676,.95122,.94554,.93973,.93378,.92773,.92157,.91532,.90899,.90258,.89612,.88961,.88308,.87653,.87,.8635,.85705,.85068,.8444,.83823,.83219,.82628,.82052,.81493,.80952,.8043,.79929,.7945,.78994,.78561,.78151,.77765,.77402,.77062,.76742,.76443,.76161,.75896,.75645,.75406,.75175,.74951,.7473,.74511,.74289,.74064,.73833,.73592,.73341,.73078,.728,.72507,.72197,.71869,.71522,.71156,.70769,.70363,.69936,.69489,.69021,.68533,.68023,.67492,.66939,.66363,.65765,.65145,.64501,.63833,.63143,.62428,.61691,.60931,.60148,.59344,.58521,.57679,.5682,.55948,.55063,.54167,.53264,.52354,.51439,.50522,.49603,.48686,.47773,.46865,.45964,.45072,.44192,.43324,.42469,.41629,.40804,.39994,.392,.3842,.37655,.36903,.36164,.35437,.3472,.34012,.33312,.3262,.31933,.31251,.30574,.299,.2923,.28563,.27899,.27239,.26583,.25933,.25288,.24652,.24025,.2341,.22808,.22221,.21653,.21104,.20576,.20072,.19592,.19138,.18712,.18313,.17943,.17602,.17292,.17013,.16766,.16551,.16369,.16222,.1611,.16036,.16001,.16007,.16055,.16148,.16286,.16471,.16705,.16988,.17321,.17706,.18144,.18636,.19182,.19785,.20443,.21158,.2193]},{distance:[-2.31317,-2.3191,-2.32189,-2.32154,-2.31811,-2.31174,-2.30254,-2.29062,-2.27609,-2.25904,-2.23954,-2.21767,-2.19355,-2.16732,-2.13907,-2.10885,-2.07672,-2.04268,-2.00677,-1.96911,-1.92985,-1.88914,-1.84713,-1.80397,-1.75979,-1.71467,-1.66864,-1.62171,-1.57395,-1.52546,-1.47625,-1.42628,-1.3755,-1.32384,-1.27131,-1.218,-1.16408,-1.10972,-1.05508,-1.00031,-.94551,-.89077,-.83615,-.7817,-.72757,-.6739,-.62076,-.56821,-.51625,-.46484,-.41397,-.36366,-.314,-.26506,-.21689,-.16957,-.12316,-.07766,-.03301,.01085,.05399,.09643,.13827,.17967,.22079,.26176,.30265,.34342,.38397,.42414,.46381,.50285,.54115,.57863,.61524,.65093,.6856,.71914,.75153,.78275,.81283,.84182,.86972,.89651,.92208,.94634,.96919,.99052,1.01025,1.02835,1.04484,1.05976,1.07309,1.08479,1.09492,1.1036,1.11096,1.11714,1.12224,1.12627,1.12916,1.13083,1.13125,1.13036,1.12816,1.12466,1.11992,1.11397,1.10677,1.09827,1.08849,1.07746,1.06527,1.05203,1.03786,1.02283,1.00695,.99025,.97279,.9546,.93573,.9163,.8965,.8765,.85647,.83652,.81687,.79775,.77939,.76199,.74568,.73049,.71635,.70316,.69082,.67925,.66834,.65804,.64831,.63911,.63032,.62184,.61363,.60564,.59788,.59036,.58308,.57597,.5689,.56177,.55447,.5469,.53896,.53062,.5219,.51283,.5034,.49355,.48335,.47287,.46223,.45154,.44085,.43012,.41923,.40805,.39648,.38441,.37176,.35849,.34458,.32999,.31461,.29833,.28109,.26288,.2437,.22361,.20265,.18082,.15807,.13434,.1096,.0838,.0569,.02894,0,-.0298,-.0604,-.09173,-.12364,-.15594,-.18843,-.22092,-.25331,-.28559,-.31781,-.35006,-.38244,-.41502,-.44785,-.48098,-.5144,-.54811,-.58218,-.61666,-.65153,-.68677,-.72232,-.75807,-.79397,-.83002,-.86628,-.90281,-.93968,-.97693,-1.01465,-1.05282,-1.09139,-1.13031,-1.16956,-1.20917,-1.24905,-1.28907,-1.32908,-1.36891,-1.40844,-1.44765,-1.48658,-1.52527,-1.56376,-1.60206,-1.64016,-1.67801,-1.71552,-1.75264,-1.78936,-1.8257,-1.86161,-1.89702,-1.93182,-1.96584,-1.99894,-2.03102,-2.06203,-2.0919,-2.12056,-2.14794,-2.17397,-2.19852,-2.22138,-2.24235,-2.26129,-2.27805,-2.29243,-2.30422],pressure:[.9681,.97424,.98046,.98674,.99309,.9995,.99404,.98754,.981,.97444,.96785,.96124,.95462,.94801,.94139,.93479,.92822,.92167,.91515,.90868,.90225,.89589,.88959,.88336,.87722,.87115,.86519,.85932,.85356,.84792,.84239,.83699,.83173,.8266,.82162,.81679,.81211,.80759,.80324,.79906,.79505,.79121,.78756,.78409,.78081,.77771,.77481,.77211,.76959,.76728,.76516,.76324,.76153,.76001,.75869,.75757,.75665,.75593,.7554,.75507,.75493,.75498,.75523,.75565,.75627,.75706,.75803,.75917,.76049,.76197,.76361,.76541,.76737,.76947,.77172,.77409,.7766,.77923,.78198,.78484,.7878,.79086,.79401,.79724,.80055,.80394,.8074,.81092,.8145,.81813,.82182,.82556,.82934,.83317,.83703,.84093,.84487,.84884,.85284,.85687,.86094,.86503,.86915,.87329,.87746,.88166,.88587,.89011,.89436,.89863,.90291,.9072,.91149,.91579,.92009,.92438,.92867,.93295,.9372,.94144,.94566,.94985,.954,.95812,.96219,.96623,.97021,.97415,.97802,.98184,.9856,.9893,.99293,.9965,1,.99657,.9932,.98991,.98668,.98352,.98042,.97738,.9744,.97148,.9686,.96577,.96298,.96023,.95751,.95482,.95214,.94949,.94684,.9442,.94156,.93892,.93627,.93361,.93094,.92825,.92555,.92284,.9201,.91735,.91458,.91179,.90899,.90616,.90332,.90047,.8976,.89472,.89183,.88893,.88603,.88314,.88024,.87735,.87448,.87162,.86878,.86597,.86319,.86044,.85774,.85508,.85247,.84993,.84744,.84503,.84269,.84042,.83825,.83616,.83417,.83227,.83048,.8288,.82724,.82578,.82445,.82324,.82215,.82119,.82037,.81967,.81911,.81868,.81839,.81824,.81823,.81835,.81862,.81903,.81957,.82026,.82109,.82206,.82317,.82443,.82583,.82737,.82906,.83089,.83287,.83499,.83726,.83968,.84223,.84494,.84778,.85077,.8539,.85717,.86058,.86412,.86781,.87163,.87559,.87968,.88391,.88826,.89275,.89737,.90211,.90698,.91198,.91709,.92233,.92768,.93315,.93873,.94441,.95019,.95607,.96205]},{distance:[4.72925,4.81721,4.9037,4.98859,5.07177,5.15311,5.23249,5.3098,5.38491,5.45772,5.52811,5.59598,5.66122,5.72375,5.78346,5.84028,5.8941,5.94486,5.99248,6.03689,6.07803,6.11584,6.15028,6.18128,6.20882,6.23285,6.25336,6.27031,6.28369,6.29348,6.29969,6.3023,6.30133,6.29678,6.28867,6.27703,6.26187,6.24324,6.22116,6.19567,6.16683,6.13468,6.09928,6.06068,6.01896,5.97417,5.92639,5.87569,5.82217,5.76589,5.70696,5.64545,5.58147,5.5151,5.44644,5.37559,5.30265,5.2277,5.15085,5.0722,4.99184,4.90987,4.82639,4.74151,4.65533,4.56794,4.47945,4.38996,4.29959,4.20843,4.11658,4.02416,3.93125,3.83796,3.74437,3.65057,3.55666,3.46272,3.36884,3.27509,3.18155,3.08831,2.99545,2.90303,2.81114,2.71984,2.62922,2.53933,2.45026,2.36207,2.27484,2.18862,2.10349,2.01951,1.93675,1.85528,1.77515,1.69644,1.61919,1.54348,1.46935,1.39685,1.32605,1.25698,1.18967,1.12417,1.06049,.99863,.93862,.88044,.82408,.76953,.71676,.66574,.61644,.56882,.52282,.47841,.43553,.39413,.35414,.31551,.27817,.24206,.20712,.17328,.14048,.10866,.07776,.04772,.01848,-.00999,-.03776,-.06487,-.09134,-.11721,-.14251,-.16725,-.19144,-.21509,-.2382,-.26076,-.28275,-.30416,-.32496,-.34511,-.36459,-.38334,-.40134,-.41852,-.43485,-.45026,-.46471,-.47815,-.49052,-.50179,-.51189,-.52081,-.52849,-.5349,-.54003,-.54383,-.54627,-.54734,-.54702,-.54528,-.54211,-.53752,-.53149,-.52403,-.51515,-.50487,-.4932,-.48015,-.46575,-.45001,-.43297,-.41463,-.39503,-.37419,-.35213,-.32887,-.30443,-.27885,-.25214,-.22432,-.19541,-.16544,-.13442,-.10235,-.06926,-.03514,0,.03616,.07336,.11159,.15088,.19125,.23272,.27531,.31906,.36401,.41019,.45764,.5064,.55651,.60802,.66096,.71538,.77129,.82874,.88776,.94836,1.01056,1.07438,1.13982,1.20687,1.27554,1.34581,1.41766,1.49107,1.56599,1.64239,1.72025,1.79951,1.88013,1.96209,2.04532,2.12979,2.21546,2.30226,2.39017,2.47911,2.56905,2.65991,2.75164,2.84416,2.93742,3.03133,3.12582,3.2208,3.31619,3.41191,3.50785,3.60393,3.70006,3.79612,3.89202,3.98765,4.08291,4.17767,4.27182,4.36525,4.45783,4.54944,4.63995],pressure:[.30942,.30838,.30765,.30724,.30715,.30738,.30795,.30884,.31007,.31164,.31354,.31578,.31837,.32129,.32455,.32815,.33209,.33636,.34097,.34591,.35117,.35675,.36265,.36887,.37539,.38221,.38933,.39674,.40442,.41238,.4206,.42907,.43779,.44675,.45593,.46533,.47493,.48473,.49471,.50486,.51517,.52563,.53623,.54694,.55777,.5687,.57971,.59079,.60194,.61313,.62435,.6356,.64686,.65811,.66935,.68056,.69174,.70286,.71391,.72489,.73579,.74659,.75728,.76785,.7783,.7886,.79876,.80877,.81861,.82827,.83776,.84706,.85617,.86507,.87378,.88227,.89056,.89863,.90649,.91412,.92153,.92872,.93568,.94241,.94892,.95519,.96122,.96702,.97258,.97791,.98299,.98783,.99242,.99677,.99911,.99525,.99164,.98827,.98515,.98228,.97966,.97728,.97514,.97324,.97159,.97017,.96898,.96801,.96727,.96674,.96641,.96629,.96635,.96661,.96703,.96762,.96838,.96928,.97032,.97149,.97279,.9742,.97572,.97734,.97905,.98085,.98273,.98468,.98669,.98877,.99091,.99311,.99535,.99765,1,.9976,.99516,.99267,.99014,.98755,.98491,.98222,.97947,.97666,.97378,.97083,.96781,.96471,.96153,.95826,.9549,.95144,.94787,.9442,.94042,.93651,.93249,.92834,.92407,.91966,.91512,.91045,.90564,.90069,.8956,.89037,.885,.87949,.87384,.86806,.86214,.85608,.84988,.84356,.83711,.83053,.82383,.81702,.81009,.80306,.79594,.78872,.78141,.77403,.76657,.75905,.75148,.74385,.73619,.72849,.72076,.71302,.70526,.69749,.68972,.68195,.67419,.66644,.65871,.65099,.64329,.63561,.62795,.62032,.61271,.60512,.59755,.59001,.58248,.57497,.56749,.56002,.55256,.54512,.5377,.5303,.52291,.51554,.50819,.50087,.49358,.48632,.4791,.47192,.4648,.45773,.45072,.44378,.43692,.43015,.42346,.41687,.41039,.40403,.39779,.39168,.38571,.37989,.37423,.36873,.36342,.35828,.35335,.34862,.34409,.3398,.33573,.3319,.32831,.32498,.32192,.31912,.3166,.31436,.31242,.31077]}]};function kS(e){let t=null;for(const i of e){const e=i.type;if(US(i))if(Object(p["j"])(t))t=e;else if(t!==e)return"uber"}return Object(p["k"])(t)?t:"solid"}function FS(e){let t=0;for(const{material:i}of e)if(US(i)){if(i.color[3]*i.opacity<1)return 1;t=2}return t}function zS(e){let t=0;for(const{material:i}of e)if(US(i)){switch(i.objectTransparency){case 1:case 0:return 1;case 2:if(i.opacity<1)return 1}t=2}return t}function US(e){return e.size*e.color[3]*e.opacity>0}function GS(e,t,i,r){return i*(r/e)*2*Math.tan(.5*t)}function BS(e,t){const i=Object(ub["b"])(e,t,!0);return-1===i?t<e[0]?0:e.length:i}function HS(e,t,i){return e.length-BS(e,t*i.minimumEdgeLength)}function NS(e,t,i,r){for(let a=0;a<e.length;a++){const n=e[a].index,s=t[a],o=t[a+1];if(r)for(let e=s;e<o;e++){const t=r[e];i.set(t,n)}else for(let e=s;e<o;e++)i.set(e,n)}}let qS=class extends je["a"]{constructor(e){super(e),this.updatingHandles=new Yi["a"],this.perObjectData=new Map,this.renderers=new Map,this.localOrigins=new lS(new nS["a"]),this.numberOfRenderedEdges=0,this.gpuMemoryUsage=0,this.workerAbort=Object(j["e"])(),this.tmpModelPosition=Object(M["e"])(),this.tmpCameraPosition=Object(M["e"])()}initialize(){this.worker=new RS(this.scheduler),this.componentColorManager=new yx(this.rctx,2);const e=hS["e"].createBuffer(4);for(let t=0;t<4;t++)e.sideness.set(t,0,0===t||3===t?0:1),e.sideness.set(t,1,0===t||1===t?0:1);this.verticesBufferObject=ei["a"].createVertex(this.rctx,35044,e.buffer)}destroy(){this.destroyed||(this.perObjectData.forEach((e,t)=>{this.perObjectData.delete(t),e.renderables.forEach(e=>{this.removeRenderable(e)})}),this.strokesTexture=Object(p["f"])(this.strokesTexture),this.componentColorManager=Object(p["e"])(this.componentColorManager),this.workerAbort.abort(),this.worker.destroy(),this.verticesBufferObject=Object(p["f"])(this.verticesBufferObject),this.perObjectData.clear(),this.renderers.clear(),this.updatingHandles.destroy())}get updating(){return this.updatingHandles.updating}get usedMemory(){return this.gpuMemoryUsage}get numberOfRenderedPrimitives(){return this.numberOfRenderedEdges}shouldRender(){return this.renderers.size>0}async addComponentObject(e,t,i,r,a,n,s,o){if(this.hasObject(e))return;let c;const l=new $S(new Promise(e=>c=e),i);this.perObjectData.set(e,l),await this.updatingHandles.addPromise(this.addComponentGeometry(t,l,r,a,n,s,o)),this.setNeedsRender(),c()}async addOrUpdateObject3D(e,t,i,r){const a=new Array;let n;const s=new $S(new Promise(e=>n=e)),o=this.perObjectData.get(e);if(this.perObjectData.set(e,s),i.mergeGeometries&&e.geometries.length>1&&ZS(e))a.push(this.addObjectMergedGeometries(e,s,t,i,r));else for(let c=0;c<e.geometries.length;c++){const n=e.geometries[c],o=e.geometryRecords[c];o.material.supportsEdges&&a.push(this.addGeometry(e,s,n,o,t[0],i,r))}await this.updatingHandles.addPromise(Promise.all(a)),o&&o.waitLoaded(()=>{o.renderables.forEach(e=>this.removeRenderable(e)),this.setNeedsRender()},this.updatingHandles),this.setNeedsRender(),n()}hasObject(e){return this.perObjectData.has(e)}async updateAllComponentOpacities(e,t){const i=t instanceof Array?e=>t[e]:()=>t;(await this.updatingHandles.addPromise(this.getObjectEntry(e))).renderables.forEach(e=>{const t=e.components.meta.length;for(let r=0;r<t;r++){const t=i(r),a=e.components.meta[r],n=a.index;a.material.opacity=t,e.components.buffer.textureBuffer.setDataElement(n,1,3,255*t)}this.updateTransparency(e)}),this.setNeedsRender()}async updateAllComponentMaterials(e,t,i,r){const a=e instanceof aS["a"],n=!!i.slicePlaneEnabled,s=kS(t),o=xS.getKey(s,n,a);(await this.updatingHandles.addPromise(this.getObjectEntry(e))).renderables.forEach(e=>{if(o!==e.rendererKey){const t=this.renderers.get(e.rendererKey),i=this.acquireRenderer(s,n,a);t.removeRenderable(e),t.refCount.decrement(),e.rendererKey=o,i.addRenderable(e)}for(let i=0;i<t.length;i++)e.components.meta[i].material=t[i];r&&this.updateComponentBuffer(e.components),this.updateTransparency(e)}),this.setNeedsRender()}async updateObjectVisibility(e,t){(await this.updatingHandles.addPromise(this.getObjectEntry(e))).renderables.forEach(e=>e.visible=t),this.setNeedsRender()}removeObject(e){const t=this.perObjectData.get(e);t&&(this.perObjectData.delete(e),t.waitLoaded(()=>{t.renderables.forEach(e=>this.removeRenderable(e)),this.setNeedsRender()},this.updatingHandles))}async getObjectEntry(e){const t=this.perObjectData.get(e);if(!t)throw"no object";return await t.loaded,t}removeAll(){this.perObjectData.forEach((e,t)=>this.removeObject(t))}render(e,t){if(Object(p["j"])(this.componentColorManager))return;this.localOrigins.updateViewMatrices(e.camera.viewMatrix);const i=e.camera.viewInverseTransposeMatrix,r=Object(M["e"])(),a=new px,n=new Q_["a"].ViewProjectionTransform,s=Object(Kn["a"])();Object(It["x"])(r,i[3],i[7],i[11]),a.set(r),Object(It["l"])(n.worldFromView_TH,a.high),Object(It["l"])(n.worldFromView_TL,a.low),Object(Jn["f"])(n.viewFromCameraRelative_RS,e.camera.viewMatrix),Object(Vt["c"])(n.projFromView,e.camera.projectionMatrix);const o=Object(Kn["a"])();Object(Jn["n"])(o,n.viewFromCameraRelative_RS),Object(Jn["d"])(s,o),this.renderers.forEach(e=>{0===e.refCount.value&&(this.renderers.delete(e.key),e.dispose())}),this.componentColorManager.garbageCollect(),this.componentColorManager.updateTextures();let c=0,l=0;if(this.renderers.forEach(e=>e.forEachRenderable(e=>{c+=e.statistics.averageEdgeLength,l++},t)),0===l)return;const h={distanceFalloffFactor:40*c/l,minimumEdgeLength:GS(e.camera.fullViewport[3],e.camera.fovY,1,3.5*e.camera.pixelRatio),transparency:t,viewProjectionTransform:n,transformNormal_ViewFromGlobal:s};this.updateObjectCameraDistances(e),this.numberOfRenderedEdges=0,this.renderers.forEach(t=>{this.renderRegularEdges(t,e,h),this.renderSilhouetteEdges(t,e,h)})}updateTransparency(e){const t=FS(e.components.meta),i=zS(e.components.meta);t===e.edgeTransparency&&i===e.objectTransparency||(e.edgeTransparency=t,e.objectTransparency=i,this.renderers.get(e.rendererKey).setRenderablesDirty())}computeModelTransformWithLocalOrigin(e,t,i){if(e.getCombinedStaticTransformation(t,i),t.origin)this.localOrigins.register(t.origin);else{const e=Object(It["x"])(this.tmpModelPosition,i[12],i[13],i[14]);t.origin=this.localOrigins.acquire(e)}return oS(t.origin.vec3,i),i}updateComponentBuffer(e){const{meta:t,buffer:i}=e;for(let r=0;r<t.length;r++){const e=t[r].material,a=t[r].index,n=Object(Qe["d"])(Math.round(e.size*gS),0,255),s=Object(Qe["d"])(e.extensionLength,-vS,255-vS)+vS,o="solid"===e.type?0:1,c=255*e.opacity,l=e.color,h=255*l[0],d=255*l[1],u=255*l[2],p=255*l[3];i.textureBuffer.setData(a,0,h,d,u,p),i.textureBuffer.setData(a,1,n,s,o,c)}}createComponentBuffers(e){if(Object(p["j"])(this.componentColorManager))return null;const t=new Array,i=this.componentColorManager.getBuffer(e.length);for(let a=0;a<e.length;a++){const r=e[a],n=i.acquireIndex();t.push({index:n,material:r})}const r={meta:t,buffer:i};return this.updateComponentBuffer(r),r}extractEdges(e,t,i,r,a,n=a.length){return this.worker.process({data:t,indices:a,indicesLength:n,writerSettings:e,skipDeduplicate:i},this.workerAbort.signal,r)}createEdgeResources(e){const t={};if(Object(p["j"])(this.verticesBufferObject))return t;if(e.regular.lodInfo.lengths.length>0){const i=new ri["a"](this.rctx,hS["b"],{vertices:hS["f"],instances:dS["a"].glLayout},{vertices:this.verticesBufferObject,instances:ei["a"].createVertex(this.rctx,35044,e.regular.instancesData.buffer)});t.regular={vao:i,lod:e.regular.lodInfo}}if(e.silhouette.lodInfo.lengths.length>0){const i=new ri["a"](this.rctx,hS["b"],{vertices:hS["f"],instances:dS["b"].glLayout},{vertices:this.verticesBufferObject,instances:ei["a"].createVertex(this.rctx,35044,e.silhouette.instancesData.buffer)});t.silhouette={vao:i,lod:e.silhouette.lodInfo}}return t}async addGeometry(e,t,i,r,a,n,s){const o={position:i.vertexAttributes.get("position"),indices:i.indices.get("position"),modelTransform:this.computeModelTransformWithLocalOrigin(e,r,Object(kt["b"])()),origin:r.origin};return this.addPositionData(t,o,i.edgeIndicesLength,a,n,s)}async addPositionData(e,t,i,r,a,n=!1){const s=this.createComponentBuffers([r]);if(Object(p["j"])(s)||i<=0)return;const o=this.acquireRenderer(r.type,!!a.slicePlaneEnabled),{modelTransform:c,origin:l}=t,h=t.indices,d=t.position,u=d.data.length/d.size,f=hS["a"].createBuffer(u);for(let p=0;p<u;p++)f.position.set(p,0,d.data[p*d.size+0]),f.position.set(p,1,d.data[p*d.size+1]),f.position.set(p,2,d.data[p*d.size+2]);NS(s.meta,[0,f.componentIndex.count],f.componentIndex);const m=await this.updatingHandles.addPromise(this.extractEdges(o.writerSettings,f,!1,n,h,i)),{regular:b,silhouette:g}=this.createEdgeResources(m),v=(b?b.vao.size:0)+(g?g.vao.size:0),y={regular:b,silhouette:g,transform:{modelMatrix:c,origin:l},statistics:{gpuMemoryUsage:v,averageEdgeLength:m.averageEdgeLength},components:s,visible:!0,edgeTransparency:FS(s.meta),objectTransparency:zS(s.meta),distanceToCamera:0,rendererKey:o.key};e.renderables.push(y),o.addRenderable(y),this.gpuMemoryUsage+=v}async addComponentGeometry(e,t,i,r,a,n,s){const o=this.createComponentBuffers(n);if(Object(p["j"])(o))return;const c=kS(n),l=this.acquireRenderer(c,s.slicePlaneEnabled||!1,!1),h=hS["a"].createBuffer(i.count);Object(sS["a"])(h.position,i),NS(o.meta,a,h.componentIndex,r);const d=!0,u=l.writerSettings,f=await this.updatingHandles.addPromise(this.extractEdges(u,h,d,!1,r)),{regular:m,silhouette:b}=this.createEdgeResources(f),g=(m?m.vao.size:0)+(b?b.vao.size:0),v={regular:m,silhouette:b,transform:e,statistics:{gpuMemoryUsage:g,averageEdgeLength:f.averageEdgeLength},components:o,visible:!0,edgeTransparency:FS(o.meta),objectTransparency:zS(o.meta),distanceToCamera:0,rendererKey:l.key};t.renderables.push(v),l.addRenderable(v),this.gpuMemoryUsage+=g}async addObjectMergedGeometries(e,t,i,r,a){const n=new Map;let s=0,o=null,c=null;for(let b=0;b<e.geometries.length;b++){const t=e.geometries[b],i=e.geometryRecords[b];if(!i.material.supportsEdges)continue;!c&&i.origin&&(c=i);const r=t.indices.get("position");s+=t.edgeIndicesLength,null!=o&&o!==Uint16Array||(o=Object(GO["i"])(r)?Uint16Array:Uint32Array)}const l=s?new o(s):null,h=[];let d=0;for(let b=0;b<e.geometries.length;b++){const t=e.geometries[b];if(!e.geometryRecords[b].material.supportsEdges)continue;const i=t.vertexAttributes.get("position"),r=t.indices.get("position");let a=n.get(i.data);if(null==a){a=h.length/3;for(let e=0;e<i.data.length;e+=i.size)h.push(i.data[e+0]),h.push(i.data[e+1]),h.push(i.data[e+2]);n.set(i.data,a)}if(r)for(let e=0;e<t.edgeIndicesLength;e++)l[d++]=a+r[e]}const u=c||e.geometryRecords[0],p=this.computeModelTransformWithLocalOrigin(e,u,Object(kt["b"])()),f=u.origin;for(let b=0;b<e.geometryRecords.length;b++)e.geometryRecords[b].origin=f;const m={position:{data:h,size:3},indices:l,modelTransform:p,origin:f};await this.updatingHandles.addPromise(this.addPositionData(t,m,l.length,i[0],r,a))}acquireRenderer(e,t,i=!0){const r=xS.getKey(e,t,i);let a=this.renderers.get(r);return Object(p["j"])(this.strokesTexture)&&(this.strokesTexture=MS(this.rctx)),a||(a=new xS(this.rctx,this.techniqueRepository,{type:e,slicePlaneEnabled:t,strokesTexture:this.strokesTexture,legacy:i}),this.renderers.set(r,a)),a.refCount.increment(),a}removeRenderable(e){const t=this.renderers.get(e.rendererKey);if(t){t.removeRenderable(e),t.refCount.decrement(),WS(e),"origin"in e.transform&&this.localOrigins.release(e.transform.origin),this.gpuMemoryUsage-=e.statistics.gpuMemoryUsage;for(const t of e.components.meta)e.components.buffer.releaseIndex(t.index)}}updateObjectCameraDistances(e){const t=e.camera.viewInverseTransposeMatrix;Object(It["x"])(this.tmpCameraPosition,t[3],t[7],t[11]),this.perObjectData.forEach((e,t)=>{const i=Object(p["k"])(e.center)?e.center:Object(md["c"])(t.getBounds()),r=Object(It["p"])(i,this.tmpCameraPosition);e.renderables.forEach(e=>e.distanceToCamera=r)})}renderRegularEdges(e,t,i){e.bindRegularEdges(t,i);const r=i.transparency;e.forEachRenderable(r=>{if(!r.visible||!r.regular)return;const a=HS(r.regular.lod.lengths,r.distanceToCamera,i);"origin"in r.transform&&(t.localViewMatrixForEdges=this.localOrigins.getViewMatrix(r.transform.origin)),e.renderRegularEdges(r,t,a),this.numberOfRenderedEdges+=a},r)}renderSilhouetteEdges(e,t,i){e.bindSilhouetteEdges(t,i);const r=i.transparency;e.forEachRenderable(r=>{if(!r.visible||!r.silhouette)return;const a=HS(r.silhouette.lod.lengths,r.distanceToCamera,i);"origin"in r.transform&&(t.localViewMatrixForEdges=this.localOrigins.getViewMatrix(r.transform.origin)),e.renderSilhouetteEdges(r,t,a),this.numberOfRenderedEdges+=a},r)}};function WS(e){e.regular&&(e.regular.vao.vertexBuffers.instances.dispose(),e.regular.vao.dispose(!1),e.regular.vao=null),e.silhouette&&(e.silhouette.vao.vertexBuffers.instances.dispose(),e.silhouette.vao.dispose(!1),e.silhouette.vao=null)}function ZS(e){let t=null,i=null;for(let r=0;r<e.geometries.length;r++){const a=e.geometryRecords[r];if(a.material.supportsEdges){if(t){if(!Object(ub["e"])(t,a.transformation))return!1}else t=a.transformation;if(!i&&a.origin)i=a;else if(i&&a.origin&&i.origin.id!==a.origin.id)return!1}}return!0}Object(d["a"])([Object(g["b"])({constructOnly:!0})],qS.prototype,"rctx",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],qS.prototype,"techniqueRepository",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],qS.prototype,"setNeedsRender",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],qS.prototype,"scheduler",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],qS.prototype,"updatingHandles",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],qS.prototype,"updating",null),qS=Object(d["a"])([Object(y["a"])("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView")],qS);class $S{constructor(e,t=null){this.center=t,this.renderables=new Array,this.loaded=e,this.loaded.then(()=>this.loaded=!0)}waitLoaded(e,t){!0===this.loaded?e():t.addPromise(this.loaded.then(()=>e()))}}class QS{constructor(e,t,i,r,a,n,s,o,c){this._materialRep=e,this._shaderTechniqueRepository=i,this._rctx=r,this._compositingHelper=a,this._magnifierHelper=n,this.requestRender=s,this._stage=c,this._materialRenderers=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._hasWater=!1,this._camera=new Yn["a"](Object(M["g"])(0,100,-100)),this._content=new Map,this._isRendering=!1,this._bindParameters={slot:null,camera:null,inverseViewport:Object(hi["b"])(),shadowMappingEnabled:!1,ssaoEnabled:!1,origin:null,screenToWorldRatio:null,screenToWorldRatioGlobalWM:null,slicePlane:null,highlightDepthTexture:null,hasOccludees:!1,linearDepthTexture:null,linearDepthTextureUnit:0,terrainLinearDepthTexture:null,geometryLinearDepthTexture:null,multipassTerrainEnabled:!1,multipassGeometryEnabled:!1,cullAboveGround:!0,lastFrameColorTexture:null,lastFrameColorTextureUnit:0,reprojectionMat:null,ssrEnabled:!1,lighting:new gj["a"]},this._fallbackDepthStencilTexture=null,this.performanceInfo=new mj["a"],this._antialiasing=1,this._oitEnabled=!1,this._multipassTerrain=!0,this._opaqueTerrain=!0,this._handles=new we["a"],this.renderHiddenTransparentEdges=()=>{},this._smaaPass=new $w(this._rctx),this._oitEnabled=this._hasOITSupport,this.camera.viewport[2]=o[0],this.camera.viewport[3]=o[1],this.requestRender(),this._offscreenRendering=new zj(this._rctx,this._compositingHelper),this._sliceHelper=new Ww,this._shadowMap=new Hw(this._rctx,i.viewingMode,2),this._ssaoHelper=new rS(i,this._rctx,()=>this.requestRender()),this._highlightHelper=new Ij(i,this._rctx),this._shadowHighlightHelper=new nw(i,this._rctx,0,1),this._renderContext=new uj["a"](this._rctx,this._offscreenRendering,this._bindParameters.lighting,this._shadowMap,this._ssaoHelper,this._sliceHelper),this._renderPlugins=new Bj({renderContext:this._renderContext,shaderTechniqueRep:i,textureRep:t,materialRep:this._materialRep,requestRender:this.requestRender}),this.renderPassManager=new jj(this._rctx,this._shaderTechniqueRepository),this._renderPlugins.add(this.renderPassManager.slots(),this.renderPassManager),this._renderContext.ssrParams={camera:null,linearDepthTexture:null,linearDepthTextureUnit:0,lastFrameColorTexture:null,lastFrameColorTextureUnit:0,reprojectionMat:null,ssrEnabled:!1},this._renderContext.multipassTerrainParams={camera:null,multipassTerrainEnabled:!1,cullAboveGround:!0,terrainLinearDepthTexture:null},this._renderContext.multipassGeometryParams={multipassGeometryEnabled:!1,geometryLinearDepthTexture:null},this._handles.add(Object(L["a"])(dd["a"],"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",e=>{this.renderHiddenTransparentEdges=e?()=>this.renderEdges(1):()=>{},this.requestRender()}))}dispose(){this._handles.destroy(),this._smaaPass.disable(),this._materialRenderers.forEach(e=>e.dispose()),this._materialRenderers.clear(),this._edgeView=Object(p["e"])(this._edgeView),this._offscreenRendering.dispose(),this._fallbackDepthStencilTexture=Object(p["f"])(this._fallbackDepthStencilTexture),this._shadowMap.enabled=!1,this._shadowMap.dispose(),this._ssaoHelper.enabled=!1,this._ssaoHelper.dispose(),this._highlightHelper.dispose(),this._shadowHighlightHelper.dispose(),hj["a"].prune(),this._content.clear()}get updating(){return 1===this._antialiasing&&this._smaaPass.isLoadingResources||Object(p["k"])(this._edgeView)&&this._edgeView.updating||!this.isCameraFinal}ensureEdgeView(){return Object(p["j"])(this._edgeView)&&(this._edgeView=new qS({rctx:this._rctx,techniqueRepository:this._shaderTechniqueRepository,setNeedsRender:()=>this.requestRender(),scheduler:this._stage.scheduler}),this._handles.add(this._edgeView.watch("updating",()=>this.requestRender(),!0)),this.requestRender()),this._edgeView}set camera(e){this._camera.copyFrom(e),this.requestRender()}get camera(){return this._camera}get edgeView(){return this._edgeView}get isCameraFinal(){return null===this._bindParameters.reprojectionMat||Object(Vt["j"])(this._bindParameters.reprojectionMat,iC)}get hasShadowsEnabled(){var e;return!(null==(e=this._shadowMap)||!e.enabled)}setLighting(e){this._bindParameters.lighting.set(e)}setRenderParameters(e){const{renderPassManager:t,_shadowMap:i,_ssaoHelper:r}=this;void 0!==e.screenSpaceReflectionsEnabled&&t.screenSpaceReflectionsEnabled!==e.screenSpaceReflectionsEnabled&&(t.screenSpaceReflectionsEnabled=e.screenSpaceReflectionsEnabled,this.requestRender()),void 0===e.shadowMap||i.enabled===e.shadowMap&&t.shadowCastingEnabled===e.shadowMap||(i.enabled=e.shadowMap,t.shadowCastingEnabled=e.shadowMap,this.requestRender()),void 0!==e.shadowMapMaxCascades&&i.maxCascades!==e.shadowMapMaxCascades&&(i.maxCascades=e.shadowMapMaxCascades,this.requestRender()),void 0!==e.ssao&&r.enabled!==e.ssao&&(r.enabled=e.ssao,this.requestRender()),void 0!==e.ssaoAttenuation&&r.attenuation!==e.ssaoAttenuation&&(r.attenuation=e.ssaoAttenuation,this.requestRender()),void 0!==e.ssaoRadius&&r.radius!==e.ssaoRadius&&(r.radius=e.ssaoRadius,this.requestRender()),void 0!==e.ssaoSamples&&r.samples!==e.ssaoSamples&&(r.samples=e.ssaoSamples,this.requestRender()),e.background&&this._offscreenRendering.background!==e.background&&(this._offscreenRendering.background=e.background,this.requestRender());const a=e.antialiasingEnabled?1:0;void 0!==e.antialiasingEnabled&&this._antialiasing!==a&&(this._antialiasing=a,this.requestRender()),void 0!==e.highQualityTransparency&&this._multipassTerrain!==e.highQualityTransparency&&(this._multipassTerrain=e.highQualityTransparency,this._oitEnabled=e.highQualityTransparency&&this._hasOITSupport,this.requestRender()),void 0!==e.defaultHighlightOptions&&(this._highlightHelper.setDefaultOptions(e.defaultHighlightOptions),this._shadowHighlightHelper.setDefaultOptions(e.defaultHighlightOptions),this.requestRender()),void 0!==e.slicePlane&&this._sliceHelper.plane!==e.slicePlane&&(this._sliceHelper.plane=Object(p["t"])(e.slicePlane),this.requestRender());const n=this._rctx.parameters.maxTextureImageUnits>=10&&e.waterReflectionEnabled;void 0!==e.waterReflectionEnabled&&this._waterReflectionEnabled!==n&&(this._waterReflectionEnabled=n,this.requestRender()),void 0!==e.opaqueTerrain&&this._opaqueTerrain!==e.opaqueTerrain&&(this._opaqueTerrain=e.opaqueTerrain,this.requestRender())}get hasSlicePlane(){return!!this._sliceHelper.plane}get renderPlugins(){return this._renderPlugins}get canRender(){return this._camera.fullWidth>0&&this._camera.fullHeight>0}get _hasOITSupport(){return this._rctx.capabilities.textureFloat&&this._rctx.capabilities.textureFloat.textureFloat&&this._rctx.capabilities.colorBufferFloat&&this._rctx.capabilities.colorBufferFloat.textureFloat}getFramebufferTexture(e){switch(e){case"color":return this._offscreenRendering.colorTexture;case"hudVisibility":return this._offscreenRendering.hudVisibilityTexture;case"shadowMap":return this._shadowMap&&this._shadowMap.getDepthTexture();case"linearDepth":return this._offscreenRendering.linearDepthTexture;case"normals":return this._offscreenRendering.normalTexture;case"highlight":return this._offscreenRendering.highlightTexture;default:return null}}modify(e){this._isRendering&&console.warn("Renderer.modify called while rendering");const{adds:t,removes:i,updates:r}=e;if(0===t.length&&0===i.length&&0===r.length)return;i.forAll(({id:e})=>this._content.delete(e)),t.forAll(e=>this._content.set(e.id,e));const a=Object(pj["a"])(e);let n=!1;a.forEach((e,t)=>{let i=this._materialRenderers.get(t);if(!i){if(!(e.adds.length>0))return;i=new bj["a"](this._rctx,this._materialRep,t),this._materialRenderers.set(t,i)}i.modify(e),i.isEmpty&&(n=!0)}),n&&this._materialRenderers.forEach((e,t)=>{e.isEmpty&&(this._materialRenderers.delete(t),e.dispose())}),this._hasHighlights=Object(pd["b"])(this._materialRenderers,e=>e.hasHighlights),this._hasOccludees=Object(pd["b"])(this._materialRenderers,e=>e.hasOccludees),this._hasWater=Object(pd["b"])(this._materialRenderers,e=>e.hasWater),this.requestRender()}updateLogic(e){let t=!1;return this._materialRenderers.forEach(i=>{i.updateLogic&&(t=i.updateLogic(e)||t)}),t}render(e,t,i){this._isRendering=!0,this.performanceInfo.prerender(this._rctx),this.setLighting(this._stage.lighting),this._renderContext.hasOccludees=this._hasOccludees,this._renderContext.transparencyPassType=3,this._bindParameters.transparencyPassType=3;const r=this._offscreenRendering;r.needLastFrameColorTexture=this._waterReflectionEnabled,r.advanceCurrentRenderTarget();const a=this._sliceHelper.plane;i&&(this._sliceHelper.plane=null),this._rctx.bindFramebuffer(e),t.setGLViewport(this._rctx),this._renderPlugins.prepareRender(t),this.performanceInfo.advance(0),this._shadowHighlightHelper.setup(t,this._stage.mainLightDirection),this.renderShadowMap(e,t,this._stage.mainLightDirection),this.performanceInfo.advance(1),r.initializeFrame(t),this.ensureBindParameters(t),this.renderLinearDepth(),this.performanceInfo.advance(2),this.renderNormal(),this.performanceInfo.advance(3),this.ensureBindParametersSSR(),this._ssaoHelper.enabled&&this._ssaoHelper.computeSSAO(t,r.linearDepthTexture,r.normalTexture),this._ssaoHelper.bindToAllPrograms(this._shaderTechniqueRepository),this.performanceInfo.advance(4),this.performanceInfo.stats.reset(),this._renderContext.pass=0,r.bindFramebuffer(),this.renderSlot(0),this.renderOpaqueGeometry(),this.performanceInfo.advance(5);const n=this._multipassTerrain&&!this._opaqueTerrain;this.renderTerrainLinearDepth(n),this.setMultipassFlags(n),this.setTerrainCulling(n),this.renderEdges(2),this.performanceInfo.advance(6),this.renderHiddenTransparentEdges(),this._oitEnabled?this.renderOrderIndependentTransparency(()=>this.renderTransparentGeometry(),!1):this.renderTransparentGeometry(),this.performanceInfo.advance(7),this.renderGeometryLinearDepth(n);const s={hudVisibility:!1,transparentTerrain:!1};s.hudVisibility=this.renderHUDVisibility(),n||this.renderInternalSlot(20),this.performanceInfo.advance(9),this.renderEdges(1,n),this.performanceInfo.advance(8),s.transparentTerrain=this.renderTransparentTerrain(),s.transparentTerrain&&s.hudVisibility&&(r.compositeTransparentTerrainOntoHUDVisibility(),n&&this.renderLineCallouts(0),this.renderHUD(0,r.framebuffer),this.performanceInfo.advance(16)),this.performanceInfo.advance(10),this.setTerrainCulling(!1),s.transparentTerrain&&(r.compositeTransparentTerrainOntoMain(),n&&(this.renderEdges(2),this.performanceInfo.advance(6),this._oitEnabled?this.renderOrderIndependentTransparency(()=>this.renderTransparentGeometry(),!1):this.renderTransparentGeometry(),this.performanceInfo.advance(7),this.renderEdges(1),this.performanceInfo.advance(8))),n&&this.renderLineCallouts(1),this.setMultipassFlags(!1),r.renderToTargets(()=>{this.renderInternalSlot(8),this.renderSlot(15),this.renderSlot(16)},r.currentColorTarget,r.mainDepth),this.performanceInfo.advance(11),this._renderPlugins.needsLaserlineWithContrastControl&&r.renderTmpAndCompositeToMain(()=>{this.renderSlot(17)},2),this.performanceInfo.advance(12),this.renderOccluded(),this.performanceInfo.advance(13);const o=!i&&this._magnifierHelper.enabled,c=o&&Object(p["j"])(e)?this._offscreenRendering.getFramebuffer(this._offscreenRendering.tmpColor,this._offscreenRendering.tmpDepth):e;this._rctx.bindFramebuffer(c),this.renderAntiAliasing(this._antialiasing,this._offscreenRendering.colorTexture)||this._compositingHelper.composite(this._offscreenRendering.colorTexture,0),this.performanceInfo.advance(14),this.renderHUD(1,c),this.performanceInfo.advance(17),this.renderHighlights(c,r.linearDepthTexture),this.performanceInfo.advance(15),o&&this._magnifierHelper.render(this._rctx,this._bindParameters),c!==e&&(this._rctx.bindFramebuffer(e),this._compositingHelper.composite(this._offscreenRendering.tmpColorTexture,0)),this._renderContext.lastFrameCamera.copyFrom(this._renderContext.camera),this._sliceHelper.plane=a,this._isRendering=!1,this.onPostRender&&this.onPostRender(),this.performanceInfo.postrender()}readDepthPixels(e,t,i,r,a){const n=this._offscreenRendering.bindTarget(this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth);if(!this.needsLinearDepth()){this._renderContext.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0);const e=17664;this._rctx.clearSafe(e,255),this.renderGeometryAndTransparentTerrainPass(2),this._rctx.gl.flush(),this._rctx.gl.finish()}n.readPixels(e,t,i,r,6408,5121,a)}setMultipassFlags(e){this._renderContext.multipassTerrainParams.multipassTerrainEnabled=this._bindParameters.multipassTerrainEnabled=e,this._renderContext.multipassGeometryParams.multipassGeometryEnabled=this._bindParameters.multipassGeometryEnabled=e}setTerrainCulling(e){this._renderContext.multipassTerrainParams.cullAboveGround=this._bindParameters.cullAboveGround=e}renderSlot(e){return this._renderContext.slot=e,this._renderPlugins.render()}renderEdges(e,t=!1){const i=this._edgeView;Object(p["k"])(i)&&i.shouldRender()&&this._offscreenRendering.renderTmpAndCompositeToMain(()=>i.render(this._bindParameters,e),1,t)}renderShadowMap(e,t,i){const r=this._shadowMap;if(r.enabled){dd["a"].ENABLE_PROFILE_DEPTH_RANGE&&lj.begin("depthRange");const a=this.computeDepthRange(t);dd["a"].ENABLE_PROFILE_DEPTH_RANGE&&lj.end("depthRange"),r.prepare(t,i,a);const n=r.getCascades();if(this.needsShadowHighlight()){const e=this._shadowHighlightHelper;for(let t=0;t<n.length;++t){const i=n[t];i.camera.setGLViewport(this._rctx),this.ensureCameraBindParameters(i.camera),this.renderGeometryAndTransparentTerrainPass(7),r.takeCascadeSnapshotTo(i,e.highlightShadowMapSlot)}r.clear();for(let t=0;t<n.length;++t){const i=n[t];i.camera.setGLViewport(this._rctx),this.ensureCameraBindParameters(i.camera),this.renderGeometryAndTransparentTerrainPass(6),r.takeCascadeSnapshotTo(i,e.defaultSnapshotSlot),this.renderGeometryAndTransparentTerrainPass(7)}}else for(let e=0;e<n.length;++e){const t=n[e];t.camera.setGLViewport(this._rctx),this.ensureCameraBindParameters(t.camera),this.renderGeometryAndTransparentTerrainPass(4)}r.finish(e),t.setGLViewport(this._rctx)}r.bindToAllPrograms(this._shaderTechniqueRepository)}needsLinearDepth(){return this._ssaoHelper.enabled||this._renderPlugins.needsLinearDepth||this._hasWater&&this._waterReflectionEnabled||this.needsShadowHighlight()}renderLinearDepth(){this.needsLinearDepth()?this._offscreenRendering.renderToTargets(()=>this.renderGeometryAndTransparentTerrainPass(2),this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.linearDepth)}renderTerrainLinearDepth(e){if(e){const e=this._renderContext.pass;this._renderContext.pass=2,this._offscreenRendering.renderToTargets(()=>this.renderTransparentTerrain(),this._offscreenRendering.terrainLinearDepth,this._offscreenRendering.tmpDepth,[-1e10,-1e10,-1e10,1],!0,!0),this._renderContext.pass=e}else this._offscreenRendering.disposeTarget(this._offscreenRendering.terrainLinearDepth);this._renderContext.multipassTerrainParams.terrainLinearDepthTexture=this._bindParameters.terrainLinearDepthTexture=this._offscreenRendering.terrainLinearDepthTexture}renderGeometryLinearDepth(e){if(e){const e=this._renderContext.pass;this._offscreenRendering.renderToTargets(()=>this.renderGeometryPass(2),this._offscreenRendering.geometryLinearDepth,this._offscreenRendering.tmpDepth,[1,1,1,1],!0,!0),this._renderContext.pass=e}else this._offscreenRendering.disposeTarget(this._offscreenRendering.geometryLinearDepth);this._renderContext.multipassGeometryParams.geometryLinearDepthTexture=this._bindParameters.geometryLinearDepthTexture=this._offscreenRendering.geometryLinearDepthTexture}needsNormal(){return this._ssaoHelper.enabled}renderNormal(){this.needsNormal()?this._offscreenRendering.renderToTargets(()=>{this.renderGeometryAndTransparentTerrainPass(3)},this._offscreenRendering.normal,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.normal)}computeDepthRange(e){const t=zx(e,this._content,this._stage.layers);return O_(t,this.renderPlugins.queryDepthRange(e)),t.near=Math.max(e.near,t.near),t.far=Math.min(e.far,t.far),t}renderGeometryAndTransparentTerrainPass(e){this._renderContext.pass=e,this.renderGeometryPass(e),this.renderTransparentTerrain()}renderGeometryPass(e){this._renderContext.pass=e,this.renderOpaqueGeometry(),this.renderTransparentGeometry()}renderOpaqueGeometry(){this.renderSlot(1),this.renderSlot(2),this.renderInternalSlot(3),this.renderSlot(4),this._bindParameters.ssaoEnabled&&this._renderContext.ssaoHelper.bindToAllPrograms(this._shaderTechniqueRepository),this.renderSlot(14)}renderTransparentGeometry(){this.renderInternalSlot(5),this.renderSlot(6),this._bindParameters.ssaoEnabled&&this._renderContext.ssaoHelper.bindToAllPrograms(this._shaderTechniqueRepository)}renderTransparentTerrain(){return this.renderSlot(7)}renderHUDVisibility(){let e=!1;return this._renderContext.offscreenRenderingHelper&&this._renderContext.offscreenRenderingHelper.renderHUDVisibility(()=>{this._bindParameters.hudVisibilityTexture=this._renderContext.offscreenRenderingHelper?this._renderContext.offscreenRenderingHelper.hudVisibilityTexture:null,e=this.renderInternalSlot(12)}),e}renderLineCallouts(e){this._bindParameters.renderTransparentlyOccludedHUD=e,0===e?this._offscreenRendering.renderToTargets(()=>this.renderInternalSlot(20),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this.renderInternalSlot(20)}renderHUD(e,t){this._oitEnabled?(this.renderOrderIndependentTransparency(()=>this.renderHUDElements(e),!0),this._rctx.bindFramebuffer(t),this._compositingHelper.composite(this._offscreenRendering.hudColorTexture,2)):0===e?this._offscreenRendering.renderToTargets(()=>this.renderHUDElements(0),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this.renderHUDElements(e)}renderHUDElements(e){this._bindParameters.renderTransparentlyOccludedHUD=e,this.renderInternalSlot(21),this.renderInternalSlot(18),this.renderInternalSlot(19)}needsHighlight(){return this._hasHighlights||this._renderPlugins.needsHighlight}needsShadowHighlight(){return this._shadowMap.enabled&&this._shadowHighlightHelper.wouldRender&&this.needsHighlight()}renderHighlights(e,t){if(!this.needsHighlight())return void this._offscreenRendering.disposeTarget(this._offscreenRendering.highlight);const i=this._highlightHelper,r=i.profilingCallback&&Object(fj["a"])(this._renderContext.rctx);this._renderContext.highlightDepthTexture=this._bindParameters.highlightDepthTexture;const a=this._offscreenRendering.renderToTargets(()=>{this.renderGeometryAndTransparentTerrainPass(5),this._rctx.clearSafe(256),this.renderHUDElements(2)},this._offscreenRendering.highlight,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0);this.needsShadowHighlight()&&this._shadowHighlightHelper.render(this._renderContext.camera,t,this._shadowMap,this._stage.mainLightDirection,a,e),i.render(this._renderContext.camera,a,e),Object(p["k"])(r)&&i.profilingCallback&&r.stop(e=>{i.profilingCallback&&i.profilingCallback(e)})}renderOrderIndependentTransparency(e,t){const i=i=>{this._renderContext.transparencyPassType=i,this._bindParameters.transparencyPassType=this._renderContext.transparencyPassType,this._offscreenRendering.renderOITPass(()=>e(),i,t)},r=this._renderContext.pass;this._renderContext.pass=1,i(1),this._renderContext.pass=0,i(0),i(2),this._offscreenRendering.compositeTransparentOntoOpaque(t),this._renderContext.transparencyPassType=3,this._bindParameters.transparencyPassType=this._renderContext.transparencyPassType,this._renderContext.pass=r}renderOccluded(){let e=0;this._materialRenderers.forEach((t,i)=>{i&&i.isVisible()&&8===i.renderOccluded&&(e|=i.renderOccluded,YS.push(i))});const t=this._offscreenRendering,i=(i,r,n=(()=>a(r)),s=!0,o=!0)=>{0!=(e&r)&&(t.renderToTargets(n,t.tmpColor,t.mainDepth,[0,0,0,0],s,o),t.compositeOccludedOntoMain(i))};0!==YS.length&&(this.renderInternalSlot(10,YS),i(.5,8,()=>this.renderInternalSlot(11,YS),!1,!1),YS.length=0),this._materialRenderers.forEach((t,i)=>{i&&i.isVisible()&&(4===i.renderOccluded||2===i.renderOccluded||16===i.renderOccluded)&&(e|=i.renderOccluded,XS.push(i))});const r=this._renderPlugins.renderOccludedFlags;if(e|=r,!e)return;const a=e=>{this._renderContext.renderOccludedMask=e,r>1&&this.renderSlot(9),this.renderInternalSlot(3,XS),this.renderInternalSlot(5,XS),this.renderInternalSlot(8,XS),this._renderContext.resetRenderOccludedMask()};this._renderContext.pass=0,i(.5,4,()=>a(4),!0,2),i(.5,2,()=>a(2),!0,2),i(1,16,()=>a(16),!0,2),XS.length=0}renderAntiAliasing(e,t){if(1===e){if(this._smaaPass.loadResources(()=>this.requestRender()),this._smaaPass.enable())return this._smaaPass.render({colorTexture:t}),!0}else this._smaaPass.disable();return!1}ensureCameraBindParameters(e){this._renderContext.camera=e,this._bindParameters.camera=this._renderContext.camera,this._bindParameters.inverseViewport[0]=1/this._renderContext.camera.fullViewport[2],this._bindParameters.inverseViewport[1]=1/this._renderContext.camera.fullViewport[3]}ensureBindParameters(e){this.ensureCameraBindParameters(e);const t=this._renderContext.offscreenRenderingHelper;this._bindParameters.shadowMap=this._renderContext.shadowMap,this._bindParameters.shadowMappingEnabled=!!this._renderContext.shadowMap&&this._renderContext.shadowMap.enabled,this._bindParameters.ssaoEnabled=!!this._renderContext.ssaoHelper&&this._renderContext.ssaoHelper.enabled,this._bindParameters.slicePlane=this._renderContext.sliceHelper&&this._renderContext.sliceHelper.plane,this._bindParameters.hasOccludees=this._renderContext.hasOccludees,this._bindParameters.linearDepthTextureUnit=3,this._bindParameters.lastFrameColorTextureUnit=4,this._renderContext.multipassTerrainParams.camera=this._renderContext.camera,this._bindParameters.hudVisibilityTexture=t?t.hudVisibilityTexture:null,this._bindParameters.highlightDepthTexture=t&&t.depthTexture||this.getFallbackDepthTexture()}ensureBindParametersSSR(){this._waterReflectionEnabled?(Object(Vt["t"])(KS,this._renderContext.lastFrameCamera.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:[0,0,0]),Object(Vt["t"])(eC,this._renderContext.camera.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:[0,0,0]),Object(Vt["a"])(eC,eC),Object(Vt["a"])(JS,this._renderContext.camera.projectionMatrix),Object(Vt["m"])(tC,eC,JS),Object(Vt["m"])(tC,KS,tC),Object(Vt["m"])(tC,this._renderContext.lastFrameCamera.projectionMatrix,tC),this._renderContext.ssrParams.camera=this._renderContext.camera,this._renderContext.ssrParams.reprojectionMat=this._bindParameters.reprojectionMat=tC,this._renderContext.ssrParams.linearDepthTexture=this._bindParameters.linearDepthTexture=this._offscreenRendering.linearDepthTexture,this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=this._offscreenRendering.lastFrameColorTexture):this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=null,this._renderContext.ssrParams.ssrEnabled=this._bindParameters.ssrEnabled=this._waterReflectionEnabled}renderInternalSlot(e,t){const i=0===this._renderContext.pass?this.performanceInfo.stats:null;let r=!1;return this._bindParameters.slot=e,Object(p["k"])(t)?t.forEach(t=>{if(!Object(dj["c"])(t,this._renderContext))return;const i=this._materialRenderers.get(t);Object(p["k"])(i)&&(r=i.render(e,this._renderContext,this._bindParameters)||r)}):this._materialRenderers.forEach((t,a)=>{Object(dj["c"])(a,this._renderContext)&&(r=t.render(e,this._renderContext,this._bindParameters,i)||r)}),r}getFallbackDepthTexture(){return this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=Object(Ii["b"])(this._rctx)),this._fallbackDepthStencilTexture}getGpuMemoryUsage(){return{offscreen:this._offscreenRendering?this._offscreenRendering.getGpuMemoryUsage():0,highlights:(this._highlightHelper?this._highlightHelper.getGpuMemoryUsage():0)+(this._shadowHighlightHelper?this._shadowHighlightHelper.getGpuMemoryUsage():0),shadows:this._shadowMap?this._shadowMap.getGpuMemoryUsage():0,ssao:this._ssaoHelper?this._ssaoHelper.getGpuMemoryUsage():0}}get test(){return{antialiasing:this._antialiasing,offscreen:this._offscreenRendering,shadowMap:this._shadowMap,ssao:this._ssaoHelper,highlight:this._highlightHelper,materialRenderers:this._materialRenderers,oitEnabled:this._oitEnabled,shadowHighlights:this._shadowHighlightHelper}}}const XS=[],YS=[],KS=Object(kt["b"])(),JS=Object(kt["b"])(),eC=Object(kt["b"])(),tC=Object(kt["b"])(),iC=Object(kt["b"])();var rC=QS,aC=i("7aed");const nC=f["a"].getLogger("esri.views.3d.webgl-engine.lib.TextureRepository"),sC=8;class oC{constructor(e,t,i){this._stage=e,this.rctx=i,this._idToRefCountedTexture=new Map,this._textureTechniqueConfig=new aC["b"],this._loadingCount=0,this._frameUpdates=new Map,this._fallbackTextureData=new Uint8Array(sC*sC*4),this._fallbackTextureTransparentData=new Uint8Array(sC*sC*4),this.events=new Ce["a"],this._textureTechnique=t.acquireAndReleaseExisting(aC["a"],this._textureTechniqueConfig,this._textureTechnique);for(let r=0;r<this._fallbackTextureData.length;++r)this._fallbackTextureData[r]=255,this._fallbackTextureTransparentData[r]=(r+1)%4!=0?255:0;this._fallbackTextureDesc={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:sC,height:sC,maxAnisotropy:this.rctx.parameters.maxMaxAnisotropy},this._frameTask=Object(p["k"])(e.scheduler)?e.scheduler.registerTask(ud["b"].TEXTURE_UNLOAD,e=>this._frameTask.processQueue(e),()=>!1):ud["a"]}dispose(){this._frameTask.remove(),Object(p["k"])(this._fallbackTexture)&&(this._fallbackTexture.dispose(),this._fallbackTexture=null),Object(p["k"])(this._fallbackTextureTransparent)&&(this._fallbackTextureTransparent.dispose(),this._fallbackTextureTransparent=null),this._stage.forEachOfType(4,e=>e.unload())}acquire(e,t=!1,i){const r=this._getOrCreateRef(e,t,i);return r.ref(),r}update(){let e=!1;this._frameUpdates.forEach(t=>{const i=t.texture.frameUpdate(this.rctx,this._textureTechnique,t.previousToken);i>=0&&i!==t.previousToken&&(t.previousToken=i,e=!0)}),e&&this.events.emit("changed",0)}_getOrCreateRef(e,t,i){const r=this._idToRefCountedTexture.get(e);return r||this._createNewRef(e,t,i)}_createNewRef(e,t,i){const r=this._stage.getObject(e);Object(Mi["a"])(void 0!==r);const a=r.events.on("unloaded",()=>{a.remove(),this._onTextureUnloaded(e)}),n=new cC;this._idToRefCountedTexture.set(e,n);const s=r.load(this.rctx,this._textureTechnique);this._loadingCount++;const o=t=>(this._loadingCount--,this._updateGLTexture(n,t),i&&i(n),r.requiresFrameUpdates&&this._frameUpdates.set(e,{texture:r,previousToken:-1}),n),c=e=>{this._loadingCount--,Object(j["n"])(e)||nC.error(e)};return Object(j["p"])(s)?(this._updateGLTexture(n,t?this.fallbackTextureTransparent:this.fallbackTexture),s.then(o,c)):o(s),n}_updateGLTexture(e,t){e.glTexture=t,this.events.emit("changed",1)}release(e){const t=this._idToRefCountedTexture.get(e);if(t&&(t.unref(),t.isUnreferenced)){const i=this._stage.getObject(e);this._frameTask.schedule(()=>{t.isUnreferenced&&i.unload()})}}getTexture(e){return this._stage.getObject(e)}get loadingCount(){return this._loadingCount}_onTextureUnloaded(e){this._idToRefCountedTexture.delete(e),this._frameUpdates.delete(e)}get fallbackTexture(){return Object(p["j"])(this._fallbackTexture)&&(this._fallbackTexture=new ti["a"](this.rctx,this._fallbackTextureDesc,this._fallbackTextureData)),this._fallbackTexture}get fallbackTextureTransparent(){return Object(p["j"])(this._fallbackTextureTransparent)&&(this._fallbackTextureTransparent=new ti["a"](this.rctx,this._fallbackTextureDesc,this._fallbackTextureTransparentData)),this._fallbackTextureTransparent}}class cC{constructor(){this._refCount=0,this.glTexture=null}get isUnreferenced(){return 0===this._refCount}ref(){++this._refCount}unref(){0!==this._refCount?--this._refCount:nC.error("Cannot dereference texture that has no references!")}}const lC=f["a"].getLogger("esri.views.3d.webgl-engine.materials.internal.waterMaterialUtils");let hC=class extends je["a"]{constructor(){super(...arguments),this.data=[],this.loadingState=0}dispose(){this.loadingState=0,this.data.forEach(e=>{e.dispose(),e=null}),this.data=null}getTextureProps(e,t,i=!1){return{target:3553,pixelFormat:6408,dataType:5121,wrapMode:10497,samplingMode:9987,hasMipmap:i,maxAnisotropy:8,width:e,height:t}}get updating(){return 1===this.loadingState}get ready(){return 2===this.loadingState}loadTextures(e){const t=[Object(Xi["b"])("esri/images/materials/water/normals.jpg"),Object(Xi["b"])("esri/images/materials/water/perturbation.jpg")];this.loadingState=1,Promise.all(t.map(e=>Object(Ft["a"])(e))).then(t=>{t.forEach((t,i)=>{this.data[i]=new ti["a"](e,this.getTextureProps(t.width,t.height,!0),t)}),this.loadingState=2}).catch(e=>{lC.error("Failed to load textures for water material.",e),this.loadingState=0})}bindRepo(e){for(let t=0;t<this.data.length;t++)e.bindTexture(this.data[t],t)}};Object(d["a"])([Object(g["b"])()],hC.prototype,"loadingState",void 0),Object(d["a"])([Object(g["b"])({type:Boolean,readOnly:!0})],hC.prototype,"updating",null),hC=Object(d["a"])([Object(y["a"])("esri.views.3d.webgl-engine.materials.internal.WaterTextureRepository")],hC);class dC extends _O["a"]{constructor(e,t,i,r=null,a,n=!0){super(),this._rctx=e,this._renderScene=t,this._requestRenderScene=i,this._renderOverlay=r,this.forceCameraHook=a,this.supersample=n,this._screenshotQueue=[]}dispose(){this._rctx=null}takeScreenshot(e){this._requestRenderScene();const t=Object(j["h"])();return this._screenshotQueue.push({settings:e,resolver:t}),t.promise}update(e){if(0!==this._screenshotQueue.length){for(const t of this._screenshotQueue){if(this.isDisposed){t.resolver.reject();continue}const i={...t.settings,pixelRatio:t.settings.pixelRatio*e.viewCamera.pixelRatio},r=this._ensureScreenshotEncodeCanvas(),a=this._renderScreenshot(e,i),n=Object(be["b"])(a,i,r,{flipY:!0,premultipliedAlpha:!0});t.resolver(n)}this._screenshotQueue=[]}}_renderScreenshotOverlay(e,t,i){if(Object(p["j"])(this._renderOverlay))return;e.width=t.width,e.height=t.height;const r=e.getContext("2d"),a=i.pixelRatio;r.save(),r.translate(0,t.height),r.scale(1,-1),i.region&&r.translate(-i.region.x,-i.region.y),r.scale(a,a),this._renderOverlay(e,t),r.restore()}_readbackScreenshot(e){return e.resample?this._readbackScreenshotResampled(e):this._readbackScreenshotImmediate(e)}_readbackScreenshotResampled(e){const{framebufferWidth:t,framebufferHeight:i,region:r,resample:a}=e,n=this._ensureScreenshotEncodeCanvas(),s=Object(be["a"])(t,i,n);this._rctx.gl.readPixels(0,0,t,i,6408,5121,new Uint8Array(s.data.buffer)),this._renderScreenshotOverlay(n,s,{...e,region:null});const o=Object(be["a"])(r.width,r.height,n);return Object(be["c"])(s,o,!0,a.region.x,i-(a.region.y+a.region.height),a.region.width,a.region.height)}_readbackScreenshotImmediate(e){const{framebufferHeight:t,region:i}=e,r=this._ensureScreenshotEncodeCanvas(),a=Object(be["a"])(i.width,i.height,r);return this._rctx.gl.readPixels(i.x,t-(i.y+i.height),i.width,i.height,6408,5121,new Uint8Array(a.data.buffer)),this._renderScreenshotOverlay(r,a,e),a}_renderScreenshot(e,t){let i=null;const r=e.viewCamera,{framebufferWidth:a,framebufferHeight:n}=t;let s=!1;const o=t.disableDecorations&&e.frameHasDecorations,c=a!==r.fullWidth||n!==r.fullHeight,l=t.ignorePadding&&r.pixelRatio!==t.pixelRatio,h=c||o||l;if(h){const e=r.clone();if(t.ignorePadding){const i=Object(Lt["f"])(e.padding);for(let r=0;r<4;r++)i[r]=Math.round(i[r]/e.pixelRatio*t.pixelRatio);e.padding=i}e.fullWidth=a,e.fullHeight=n,e.pixelRatio=t.pixelRatio;const o=r.fovX-e.fovX,c=r.fovY-e.fovY;o<0&&o<c?e.fovX=r.fovX:c<0&&c<o&&(e.fovY=r.fovY),this.forceCameraHook(e),s=!0,i=new cy["a"](this._rctx,{width:e.fullWidth,height:e.fullHeight,colorTarget:0,depthStencilTarget:3}),this._renderScene(i,e,t.disableDecorations)}const d=this._readbackScreenshot(t);if(h&&!this._rctx.contextAttributes.alpha)for(let u=3;u<d.data.length;u+=4)d.data[u]=255;return i&&i.dispose(),this._rctx.bindFramebuffer(null),s&&this.forceCameraHook(r),d}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas}}const uC=f["a"].getLogger("esri.views.3d.webgl-engine.parts.View");let pC=null,fC=class extends(Object(_O["b"])(je["a"])){constructor(e){super({}),this.events=new Ce["a"],this._stippleTextureRepository=new kO["a"],this.waterTextureRepository=new hC,this._magnifierHelper=new sj,this._commonUniformStore=new IO["a"],this._componentObjectCollection=null,this._needsUpdate=!0,this._needsRender=!0,this._idleSuspend=!0,this._logicUpdateLast=0,this._container=e.container,this._initializeContext(e.options),Object(L["a"])(this.waterTextureRepository,"loadingState",()=>this.setNeedsRender()),this._magnifierHelper.events.on("request-render",()=>this.setNeedsRender()),this._shaderTechniqueRepository=new LO["a"]({rctx:this._rctx,viewingMode:e.options.viewingMode,commonUniformStore:this._commonUniformStore,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:this.waterTextureRepository}),this._textureRepository=new oC(e,this._shaderTechniqueRepository,this._rctx),this._textureRepository.events.on("changed",e=>this.setNeedsRender(e)),this._materialRepository=new VO["a"](this._textureRepository,this._shaderTechniqueRepository,()=>this.setNeedsRender()),this._compositingHelper=new Ex(this._rctx,this._shaderTechniqueRepository);const t=this._container.getBoundingClientRect();this._renderer=new rC(this._materialRepository,this._textureRepository,this._shaderTechniqueRepository,this._rctx,this._compositingHelper,this._magnifierHelper,(e=1)=>this.setNeedsRender(e),[t.width,t.height],e),this._screenshotManager=new dC(this._rctx,(e,t,i)=>this._render(e,t,i),()=>this.setNeedsRender(),e.options.screenshot.renderOverlay,e=>this.events.emit("force-camera-for-screenshot",e)),this._registerFrameTask(e)}normalizeCtorArgs(){return{}}dispose(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas),this._frameTask&&(this._frameTask.remove(),this._frameTask=null),this._shaderTechniqueRepository.dispose(),this._shaderTechniqueRepository=null,Object(pb["a"])(this._rctx),super.dispose(),this._rctx=null}get performanceInfo(){const e=this._rctx.gl;return{renderer:this._renderer.performanceInfo,textureMemory:void 0!==e.getUsedTextureMemory?e.getUsedTextureMemory():void 0,renderbufferMemory:void 0!==e.getUsedRenderbufferMemory?e.getUsedRenderbufferMemory():void 0,VBOMemory:void 0!==e.getUsedVBOMemory?e.getUsedVBOMemory():void 0}}setNeedsRender(e=1){1===e?this._needsUpdate||(this._needsUpdate=!0,this.notifyChange("updating")):this._needsRender=!0}get canRender(){return this._renderer.canRender}get needsUpdate(){return this._needsUpdate}get updating(){return this.evaluateUpdating()}evaluateUpdating(){return this.needsUpdate||this._renderer.updating||this._textureRepository.loadingCount>0||this.waterTextureRepository.updating||this._magnifierHelper.updating}ensureEdgeView(){return this._renderer.ensureEdgeView()}get edgeView(){return this._renderer.edgeView}get textureRepository(){return this._textureRepository}get compositingHelper(){return this._compositingHelper}set magnifier(e){this._magnifierHelper.magnifier=e}setRenderParameters(e){void 0!==e.idleSuspend&&this._idleSuspend!==!!e.idleSuspend&&(this._idleSuspend=!!e.idleSuspend,this.setNeedsRender()),this._renderer.setRenderParameters(e)}get renderingContext(){return this._rctx}has(e){switch(e){case 0:return!!this._rctx.capabilities.compressedTextureETC;case 1:return!!this._rctx.capabilities.compressedTextureS3TC;case 2:return!!this._rctx.capabilities.shaderTextureLOD;case 3:return this._renderer.hasShadowsEnabled;default:return!1}}modify(e){this._renderer.modify(e),e.clear()}set camera(e){this._renderer.camera=e}get camera(){return this._renderer.camera}get canvas(){return this._canvas}takeScreenshot(e){return this._screenshotManager.takeScreenshot(e)}getMinimalDepthForArea(e,t,i,r=80,a=1){const n=r*i.pixelRatio,s=i.constrainWindowSize(e,t,n,a);pC=new Uint8Array(4*s[2]*s[3]),this._renderer.readDepthPixels(s[0],s[1],s[2],s[3],pC);let o=Number.MAX_VALUE;for(let c=0;c<s[2]*s[3];c++){const e=Fx(4*c,pC,i.nearFar);o>e&&e!==i.nearFar[0]&&e!==i.nearFar[1]&&(o=e)}return o===Number.MAX_VALUE?void 0:o}get renderPlugins(){return this._renderer.renderPlugins}get test(){return{renderer:this._renderer}}getGpuMemoryUsage(){return this._renderer.getGpuMemoryUsage()}async hotReloadShaders(){_g(),await this._shaderTechniqueRepository.hotReload(),this.setNeedsRender()}_registerFrameTask(e){const t={viewCamera:this._renderer.camera,frameHasDecorations:!1};let i=!1;const r={preRender:t=>{i=this.evaluateUpdating(),Iy(),e.commitDirtyLayers();const r=Object(pg["a"])(t.time-this._logicUpdateLast);if(r>gg){const e={camera:this._renderer.camera,dt:r};this._logicUpdateLast=t.time,this._renderer.updateLogic(e)&&this.setNeedsRender(0)}},render:()=>{!this.needsUpdate&&!this._needsRender&&this._idleSuspend&&this._renderer.isCameraFinal||!this.canRender||(this._needsRender=!1,this._needsUpdate=!1,this._render(null,this._renderer.camera,!1))},postRender:()=>{i===this.updating&&i===this.evaluateUpdating()||this.notifyChange("updating"),Vy()},update:()=>{t.viewCamera=this._renderer.camera,t.frameHasDecorations=this._renderer.hasSlicePlane||this._magnifierHelper.enabled,this._textureRepository.update(),this._screenshotManager.update(t)}};this._frameTask=Object(w["a"])(r)}_initializeContext(e){this._canvas=e.canvas,this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const t={alpha:e.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:null==e.stencil||e.stencil,powerPreference:"high-performance"},i=ky(Object(EO["b"])(this._canvas,t,e.renderContext)),r={disabledExtensions:e.deactivatedWebGLExtensions||{},debugWebGLExtensions:e.debugWebGLExtensions||{}};this._rctx=new DO["a"](i,r),Object(pb["b"])(this._rctx),null!=this._rctx.parameters.maxMaxAnisotropy&&(this._rctx.parameters.maxMaxAnisotropy=Math.min(this._rctx.parameters.maxMaxAnisotropy,8)),this._loadShaderOnlyExtensions(this._rctx),!e.alpha&&this._rctx.contextAttributes.alpha&&uC.error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&Object(u["a"])("safari")>=11&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas)}_render(e,t,i){this._renderer.render(e,t,i)}_loadShaderOnlyExtensions(e){const t=e.capabilities;t.enable("standardDerivatives"),t.enable("shaderTextureLOD"),t.enable("textureFloat")}get componentObjectCollection(){return Object(p["j"])(this._componentObjectCollection)&&(this._componentObjectCollection=new _x(this._renderer.renderPassManager)),this._componentObjectCollection}set componentObjectCollection(e){this._componentObjectCollection=e}};var mC;Object(d["a"])([Object(g["b"])({type:Boolean,readOnly:!0,dependsOn:["waterTextureRepository.updating","_magnifierHelper.updating"]})],fC.prototype,"updating",null),Object(d["a"])([Object(_O["c"])()],fC.prototype,"_rctx",void 0),Object(d["a"])([Object(_O["c"])()],fC.prototype,"_container",void 0),Object(d["a"])([Object(_O["c"])()],fC.prototype,"_canvas",void 0),Object(d["a"])([Object(_O["c"])()],fC.prototype,"_stippleTextureRepository",void 0),Object(d["a"])([Object(_O["c"])(),Object(g["b"])()],fC.prototype,"waterTextureRepository",void 0),Object(d["a"])([Object(_O["c"])(),Object(g["b"])()],fC.prototype,"_magnifierHelper",void 0),Object(d["a"])([Object(_O["c"])()],fC.prototype,"_textureRepository",void 0),Object(d["a"])([Object(_O["c"])()],fC.prototype,"_commonUniformStore",void 0),Object(d["a"])([Object(_O["c"])()],fC.prototype,"_compositingHelper",void 0),Object(d["a"])([Object(_O["c"])()],fC.prototype,"_renderer",void 0),Object(d["a"])([Object(_O["c"])()],fC.prototype,"_screenshotManager",void 0),Object(d["a"])([Object(_O["c"])()],fC.prototype,"componentObjectCollection",null),Object(d["a"])([Object(_O["c"])()],fC.prototype,"_componentObjectCollection",void 0),fC=Object(d["a"])([Object(y["a"])("esri.views.3d.webgl-engine.parts.RenderView")],fC);let bC=mC=class extends(Object(_O["b"])(je["a"])){constructor(e){super(e),this._handles=new we["a"],this._model=new MO,this._layers=new fd["a"],this._mainLightDirection=Object(M["g"])(0,1,0),this._changeSet=new xO["a"],this._layerSyncSet=new Set}initialize(){this._set("renderView",new fC(this)),this.setLighting({lights:[new Mr["c"](Object(M["g"])(.7,.7,.7)),new Mr["a"](Object(M["g"])(.3,.3,.3))],groundLightingFactor:.5,globalFactor:.5}),this._handles.add(this.scheduler.registerTask(ud["b"].STAGE,()=>this._processDirty(),()=>this._model.dirtySet.dirty))}destroy(){OO["a"].pool.prune(0),this._handles.destroy(),this.dispose()}get updating(){return this._model.dirtySet.dirty||this.renderView.updating}get mainLightDirection(){return this._mainLightDirection}get lighting(){return this._lighting}setLighting(e){Object(It["x"])(this._mainLightDirection,0,0,0);for(const t of e.lights)if(t instanceof Mr["c"]){Object(It["u"])(this._mainLightDirection,t.direction);break}this._lighting=e,this.renderView.setNeedsRender()}add(e){this._model.add(e),Object(hu["b"])(e)&&(e.attachStage(this),this._addLayer(e)),this.renderView.setNeedsRender()}remove(e){Object(p["j"])(e)||(this.renderView.setNeedsRender(),this._model.remove(e),Object(hu["b"])(e)&&(this._removeLayer(e),e.detachStage()))}addMany(e){Object(p["k"])(e)&&(this._model.addMany(e),this.renderView.setNeedsRender())}removeMany(e){Object(p["k"])(e)&&(this._model.removeMany(e),this.renderView.setNeedsRender())}forEachOfType(e,t){this._model.forEachOfType(e,t)}handleEvent(e,t){this.destroyed||(this._model.dirtySet[e](t),this.renderView.setNeedsRender())}_processDirty(){const e=this._model.dirtySet;mC.DebugSettings.logDirtySet&&console.log("Dirty set: "+e.formatDebugInfo()),e.commit(this._changeSet),mC.DebugSettings.logDirtySet&&(console.log("RGs add: "+this._changeSet.adds.map(e=>e.id)),console.log("RGs remove: "+this._changeSet.removes.map(e=>e.id))),this._layerSyncSet.clear(),this.renderView.modify(this._changeSet),this.renderView.setNeedsRender()}processDirtyLayer(e){this._layerSyncSet.add(e),this.renderView.setNeedsRender()}commitDirtyLayers(){if(0===this._layerSyncSet.size)return;const e=this._model.dirtySet;for(const t of this._layerSyncSet)e.commitLayer(t,this._changeSet);this._layerSyncSet.clear(),this.renderView.modify(this._changeSet),this.renderView.setNeedsRender()}getObject(e){return this._model.getObject(e)}get camera(){return this.renderView.camera}set camera(e){this.renderView.camera=e}get layers(){return this._layers}_addLayer(e){this._layers.some(t=>t===e)||this._layers.push(e)}_removeLayer(e){this._processDirty(),null!=this._layers.removeUnordered(e)&&(this._model.dirtySet.getResidentRenderGeometries(e.id,this._changeSet.removes),this.renderView.modify(this._changeSet))}addRenderPlugin(e,t){"intersect"in t&&this.sceneIntersectionHelper.addIntersectionHandler(t),this.renderView.renderPlugins.add(e,t)}removeRenderPlugin(e){"intersect"in e&&this.sceneIntersectionHelper.removeIntersectionHandler(e),this.renderView.renderPlugins.remove(e)}get performanceInfo(){return{renderView:this.renderView.performanceInfo,model:this._model.getStats()}}get test(){const e=this;return{getCount:t=>e._model.test.content.filter(e=>e.type===t).length,stopAnimations:t=>e._model.test.content.filter(e=>3===e.type).forEach(e=>Object(p["c"])(e.animation,e=>e.stopAtTime(t))),model:e._model}}};async function gC(e,t){if("2d"===e.type)return e.hitTest(t);const i=await e.hitTest(t),r=i.results[0],a=i.results.findIndex(e=>e.distance!==r.distance);return-1!==a&&(i.results=i.results.slice(0,a)),i}bC.DebugSettings={endFrameContentValidation:!1,logDirtySet:!1},Object(d["a"])([Object(g["b"])({constructOnly:!0})],bC.prototype,"scheduler",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],bC.prototype,"options",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],bC.prototype,"sceneIntersectionHelper",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],bC.prototype,"viewingMode",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],bC.prototype,"container",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],bC.prototype,"_handles",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],bC.prototype,"updating",null),Object(d["a"])([Object(g["b"])({constructOnly:!0})],bC.prototype,"_model",void 0),Object(d["a"])([Object(_O["c"])(),Object(g["b"])()],bC.prototype,"renderView",void 0),bC=mC=Object(d["a"])([Object(y["a"])("esri.views.3d.webgl-engine.Stage")],bC);var vC=i("ca85");let yC=class extends vC["a"]{constructor(e){super(e),this.components=["attribution","zoom","navigation-toggle","compass"]}};Object(d["a"])([Object(g["b"])()],yC.prototype,"components",void 0),yC=Object(d["a"])([Object(y["a"])("esri.views.ui.3d.DefaultUI3D")],yC);var OC=yC,_C=OC;const xC=f["a"].getLogger("esri.views.SceneView");let jC=class extends(Object(ye["a"])(Object(_e["a"])(Object(Ve["a"])(Fe["a"])))){constructor(e){super(e),this._clippingArea=null,this._userClippingArea=null,this._initialDefaultSpatialReference=null,this._defaults={},this._externallySet={environment:!1},this._createGraphicsViewController=null,this._resolveWhenReady=[],this.propertiesPool=new Bp["a"]({slicePlane:Mt["a"]},this),this._resourceController=ab(this),this._defaultToMapOptions={include:new Set},this._defaultHitTestOptions={exclude:new Set},this.deconflictor=new tu({view:this}),this.labeler=new Yu({view:this,deconflictor:this.deconflictor.labels}),this.sharedSymbolResources=null,this.basemapTerrain=null,this.elevationProvider=null,this.camera=null,this.canvas=null,this.center=null,this.constraints=new yt,this.environmentManager=new zr,this.extent=null,this.floors=new P["a"],this.windowDevicePixelRatio=1,this.fullOpacity=1,this.graphicsView=null,this.groundView=null,this.navigating=!1,this.map=null,this.screenSizePerspectiveEnabled=!0,this.state=new Xp,this.scale=null,this.spatialReference=null,this.isHeightModelInfoRequired=!0,this.alphaCompositingEnabled=!1,this.supersampleScreenhotsEnabled=!0,this.type="3d",this.ui=new _C,this._numUpdating=0,this._lastUpdateTime=0,this.updatingProgress=.5,this.viewpoint=null,this.zoom=null,this.highlightOptions=new Mm,Object(fe["a"])(),e&&e.environment||(this._defaults.environment=new Rt,this.environment=this._defaults.environment);const t=e=>{Object(p["k"])(e)&&4===e.type||(this.notifyChange("dataExtent"),this.updatingChanged(),this.map&&this.map.allLayers.forEach(async e=>{try{await e.when()}catch{}this.updatingChanged()}))};this.handles.add([Object(L["b"])(this,"map.allLayers","after-changes",t,t,t,!0),this.allLayerViews.on("after-changes",e=>this._updateUpdatingMonitors(e)),this.watch("map",e=>{e&&e.load&&e.load().catch(()=>{})})]),this.inputManager=new sd({view:this});const i=()=>{const e=window.devicePixelRatio;e!==this.windowDevicePixelRatio&&(this.windowDevicePixelRatio=e,this.notifyChange("pixelRatio"))};this.stateManager=new pm({view:this,updateDevicePixelRatio:i})}initialize(){this.groundView=new Le({view:this}),this._updateUpdatingMonitors();const e=()=>this._updateDefaultToMapOptions();this.handles.add(Object(L["b"])(this,"map.allLayers","after-changes",e,e,e)),this.updatingHandles.add(this.qualitySettings,"memoryLimit",e=>{this.resourceController&&(this.resourceController.memoryController.maxMemory=e)},2),this.updatingHandles.add(this.qualitySettings,"additionalCacheMemory",e=>{this.resourceController&&(this.resourceController.memoryController.additionalCacheMemory=e)},2),this.updatingHandles.add(this.qualitySettings,"frameRate",e=>Object(w["c"])(e>0?1e3/Math.ceil(e):0),2),this.updatingHandles.add(dd["a"],"SCENEVIEW_LOCKING_LOG",e=>this.defaultsFromMap.logDebugInformation=e,2),this.updatingHandles.add(this,"map.ground",e,3),this.updatingHandles.add(this,"map.ground.opacity",()=>this._updateDefaultHitTestOptions(),3),this.handles.add(this.watch("spatialReference",()=>this.notifyChange("clippingArea"),!0))}destroy(){this.destroyed||(this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._exitSurface(),this._disposeGraphicsView(),this.sharedSymbolResources&&(this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null),this.labeler.destroy(),this._set("labeler",null),this.deconflictor.destroy(),this._set("deconflictor",null),this._resourceController.destroy(),this._resourceController=null,this.stateManager.destroy(),this._set("stateManager",null),this.inputManager.destroy(),this._set("inputManager",null),this.propertiesPool.destroy(),this.handles.remove("updatingMonitors"),this.environmentManager.destroy(),this._set("environmentManager",null),this.groundView.destroy(),this.groundView=null)}get renderSpatialReference(){return this.renderCoordsHelper&&this.renderCoordsHelper.spatialReference}get basemapSpatialReference(){return this.basemapTerrain&&this.basemapTerrain.spatialReference}get clippingArea(){if("global"===this.viewingMode)return null;let e=this._userClippingArea||this.get("map.clippingArea");if(!this._userClippingArea&&!this.get("map.clippingEnabled")||!e)return this._clippingArea=null,null;if(!(e instanceof T["a"]))return xC.error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea;if(this.spatialReference){if(!Object(S["a"])(e.spatialReference,this.spatialReference))return xC.error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea;e=Object(S["d"])(e,this.spatialReference)}return this._clippingArea&&e&&this._clippingArea.equals(e)?this._clippingArea:(this._clippingArea=e,e)}set clippingArea(e){this.ready&&"global"===this.viewingMode&&e?xC.error("#clippingArea=","Clipping area is only supported in local viewingMode"):(this._userClippingArea=e,this.notifyChange("clippingArea"))}get dataExtent(){const e=this.spatialReference||c["a"].WGS84;let t,i=this.clippingArea;i&&(i=Object(S["d"])(i,e));const r=r=>{let a=Object(S["d"])(r,e);a&&(i&&(a=a.intersection(i),!a)||(Object(p["k"])(t)?t.union(a):t=a))},a=this.basemapTerrain;if(a&&a.spatialReference&&r(new T["a"]({xmin:a.extent[0],ymin:a.extent[1],zmin:0,xmax:a.extent[2],ymax:a.extent[3],zmax:0,spatialReference:a.spatialReference})),this.map){const e=e=>{!e.fullExtent||"graphics"===e.type&&e.internal||r(e.fullExtent)};this.map.allLayers.forEach(t=>e(t))}return Object(p["j"])(t)?new T["a"]({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0,spatialReference:e}):(t.hasZ?(t.zmin=Math.min(0,t.zmin),t.zmax=Math.max(0,t.zmax)):(t.zmin=0,t.zmax=0),t)}set environment(e){e!==this._defaults.environment&&(this._externallySet.environment=!0),this._set("environment",e)}castEnvironment(e){return e?e instanceof Rt?e:e instanceof pe?null!=this.environment?this.environment.cloneWithWebsceneEnvironment(e):Rt.fromWebsceneEnvironment(e):Object(m["m"])(Rt,e):new Rt}get pixelRatio(){return Math.min(this.windowDevicePixelRatio,this.maximumPixelRatio)}set pixelRatio(e){Object(p["k"])(e)?this._override("pixelRatio",e):this._clearOverride("pixelRatio")}get maximumPixelRatio(){let e=1/0;const{maximumPixelRatio:t,maximumRenderResolution:i}=this.qualitySettings;if(null!=t&&(e=Math.min(e,t)),null!=i){const t=i/Math.max(this.width,this.height);e=Math.min(e,t)}return e}set maximumPixelRatio(e){Object(p["k"])(e)?this._override("maximumPixelRatio",e):this._clearOverride("maximumPixelRatio")}get groundExtent(){const e=this._get("basemapTerrain");if(e&&e.spatialReference){const t=e.extent;return new T["a"]({xmin:t[0],ymin:t[1],xmax:t[2],ymax:t[3],spatialReference:e.spatialReference})}const t=this.spatialReference||c["a"].WGS84;return new T["a"]({spatialReference:t})}get initialExtentRequired(){return this.stateManager&&!this.stateManager.hasInitialView}get interacting(){return this.navigating||Object(p["k"])(this.activeTool)}get stationary(){return!this.animation&&!this.resizing&&(Object(p["j"])(this.state)||this.state.stationary)}set qualityProfile(e){Tm.isValidProfile(e)&&(Tm.apply(e,this.qualitySettings),this._set("qualityProfile",e))}get qualityProfile(){return this._get("qualityProfile")||Tm.getDefaultProfile()}set slicePlane(e){if(this._stage.renderView.setRenderParameters({slicePlane:e}),Object(p["j"])(e))return void this._set("slicePlane",null);const t=this.propertiesPool.get("slicePlane");Et["b"].copy(e,t),this._set("slicePlane",t)}get resolution(){return null!=this.spatialReference?Object(ge["a"])(this.scale,this.spatialReference):0}get heightModelInfo(){const e=this.getDefaultHeightModelInfo();return null!=e?k["a"].deriveUnitFromSR(e,this.spatialReference):null}get updating(){var e,t,i;let r=0,a=0,n=!1;this.allLayerViews.forEach(e=>{if(e.isFulfilled()){if(e.updating){if(n=!0,e.suspended)return;++a,r+="updatingProgress"in e?e.updatingProgress:.5}}else++a});for(const s of[this.graphicsView,this.basemapView,this.basemapTerrain,this.layerViewManager,this._resourceController,this._stage,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this.updatingHandles,this.featureTreeDebugger])if(Object(p["k"])(s)&&s.updating){const e=.1;a+=e,r+=.5*e}for(const s of[this.deconflictor,this.labeler])Object(p["k"])(s)&&s.updating&&(++a,r+=s.updatingProgress);if(n=!!(n||a>0||!this.ready||!this.stationary||this._createGraphicsViewController||null!=(e=this.inputManager)&&e.hasPendingInputs||null!=(t=this.map)&&null!=(i=t.allLayers)&&i.some(e=>!e.isFulfilled())),n?(this._numUpdating=Math.max(a,this._numUpdating),r+=this._numUpdating-a):this._numUpdating=0,this._numUpdating>0?r/=this._numUpdating:r=n?.5:1,this._get("updatingProgress")!==r){const e=this._resourceController.scheduler.now;if(r<1){const t=Math.min((e-this._lastUpdateTime)/2e3,1);r=this.updatingProgress*(1-t)+r*t}this._set("updatingProgress",r),this._lastUpdateTime=n&&r<1?e:0}return n}get viewingMode(){const e=this.get("map.initialViewProperties.viewingMode");if(e)return e;const t=this.spatialReference;return!t||U(t,"global")?"global":"local"}set viewingMode(e){this.ready?xC.error("#viewingMode","viewingMode cannot be set once view is ready"):["local","global"].indexOf(e)>=0?this._override("viewingMode",e):void 0===e&&this._clearOverride("viewingMode")}get resourceController(){return this._resourceController}get performanceInfo(){return new db(this)}on(e,t,i,r){const a=this.viewEvents.on(e,t,i,r);return a||super.on(e,t)}hasEventListener(e){return super.hasEventListener(e)||this.viewEvents.hasHandler(e)}toMap(e,t){if(!this.ready)return xC.error("#toMap()","Scene view cannot be used before it is ready"),null;const i=t?this.externalToInternalIntersectOptions(t):this._defaultToMapOptions,r=Object(p["k"])(i.graphics)&&(Object(p["k"])(i.graphics.include)||Object(p["k"])(i.graphics.exclude)),a=Object(ke["d"])(e)?Object(ke["c"])(this,e):e,n=Object(A["j"])(a);i.enableDraped=i.include&&!i.include.has(Ur["e"])||i.exclude&&i.exclude.has(Ur["e"]);const s=this.sceneIntersectionHelper,o=new Gr["a"](this.state.mode);if(o.options.selectionMode=!0,o.options.store=r?2:0,s.intersectIntersectorScreen(n,o,i),r){for(const e of o.results.all){const t=e.toGraphic(this);if(Object(p["j"])(t))return this._intersectResultToMapPoint(e);if(this._testGraphicUidFilter(i.graphics,t))return this._intersectResultToMapPoint(e)}return null}return this._intersectResultToMapPoint(o.results.min)}toScreen(e){if(!this.ready)return xC.error("#toScreen()","Scene view cannot be used before it is ready"),null;const t=Object(p["u"])(null==e.z&&Object(xe["b"])(this.elevationProvider,e),0);return Object(z["t"])(e,CC,this.renderSpatialReference,t),this.state.camera.projectToScreen(CC,TC),Object(A["f"])(TC[0],TC[1])}pixelSizeAt(e){return this.ready?e?(Object(z["t"])(e,CC,this.renderSpatialReference),this.state.camera.computeScreenPixelSizeAt(CC)):0:(xC.error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null)}overlayPixelSizeInMapUnits(e){const t=this.basemapTerrain.overlayManager;return t?t.overlayPixelSizeInMapUnits(e):1}hitTest(e,t){if(!this.ready)return xC.error("#hitTest()","Scene view cannot be used before it is ready"),null;const i=Object(ke["d"])(e)?Object(ke["c"])(this,e):e,r=Object(A["g"])(i.x,i.y),a=t?this.externalToInternalIntersectOptions(t):this._defaultHitTestOptions;a.requiresGroundFeedback=!0,a.enableDraped=!0;const n=new Gr["a"](this.state.mode);n.options.selectionMode=!0,n.options.store=2,this.sceneIntersectionHelper.intersectIntersectorScreen(r,n,a);const s=this._intersectResultsToHits(n.results.all,a.graphics),o=n.results.ground,c=o.toOwner(this),l=Object(p["k"])(c)&&"type"in c&&"integrated-mesh"===c.type?c:null,h={screenPoint:i,results:s,ground:{mapPoint:this._intersectResultToMapPoint(o),distance:o.hasIntersectionPoint?o.distanceInRenderSpace:0,layer:l}};return dd["a"].SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(h.intersector=n),Promise.resolve(h)}popupHitTest(e){return gC(this,e).then(({results:t,ground:i})=>{let r=null;return!(0===t.length||Math.abs(t[0].distance-i.distance)<1e-5)||i.layer&&"integrated-mesh"===i.layer.type||(r=i.mapPoint),{results:t,screenPoint:e,mapPoint:r}})}goTo(e,t){return this.updatingHandles.addPromise(this.stateManager.goTo(e,t))}whenLayerView(e){return super.whenLayerView(e)}getAnalysisView(e){return super.getAnalysisView(e)}whenAnalysisView(e){return super.whenAnalysisView(e)}takeScreenshot(e){return this.whenReady().then(()=>{const t=Object(be["e"])(e,this);return t.pixelRatio/=this.pixelRatio,this._stage.renderView.takeScreenshot(Object(be["d"])(t,this.supersampleScreenhotsEnabled,this.padding))})}addUpdatingPromise(e){return this.updatingHandles.addPromise(e)}importLayerView(e){return We.importLayerView(e)}hasLayerViewModule(e){return We.hasLayerViewModule(e)}async createAnalysisView(e){return od(this,e)}async createAnalysisController(e){return cd(this,e)}forceDOMReadyCycle(){this.forceReadyCycle()}getDefaultSpatialReference(){return this.get("map.initialViewProperties.spatialReference")||this.get("defaultsFromMap.spatialReference")||this.get("defaultsFromMap.isSpatialReferenceDone")&&this._initialDefaultSpatialReference||null}async validate(){let e=Object(Ue["a"])();if(Object(u["a"])("safari")&&Object(u["a"])("safari")<9&&(e=new O["a"]("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:Object(u["a"])("safari")})),Object(p["k"])(e))throw xC.warn("#validate()",e.message),e}isSpatialReferenceSupported(e,t,i){const r=e.isGeographic,a=e.isWebMercator,n=U(e,"global"),s="local"===this.viewingMode,o=!(!this._isOverridden("viewingMode")&&!this.get("map.initialViewProperties.viewingMode"));if(o){if(s&&r)return i?i(`Layer ${t.id} is ignored because it is GCS and viewing mode is local`):xC.warnOnce("Geographic coordinate systems are not supported in local viewing mode."),!1;if(!s&&!n)return i?i(`Layer ${t.id} is ignored because its spatial reference is not supported in global viewing mode`):xC.warnOnce("Spatial reference defined on view not supported in global viewing mode."),!1}else if(r&&!n)return i?i(`Layer ${t.id} is ignored because its spatial reference is geographic but unsupported`):xC.warnOnce("Spatial reference is geographic but not supported."),!1;if(t)if(Object(ve["c"])(t)){let r;if(o)r=null!=Object(sb["d"])(t,e,Ge(this.viewingMode)).tileInfo;else{let i=Object(sb["d"])(t,e,1);null==i.tileInfo&&(i=Object(sb["d"])(t,e,2),null!=i.tileInfo&&a&&!this.ready&&(this.viewingMode="local")),r=null!=i.tileInfo}if(!r)return i&&i(`Layer ${t.id} is ignored because it is tiled but\n            its tiling scheme is not supported or compatible with the viewing mode`),!1}else if((e.isWGS84||a)&&!s)return null==this._initialDefaultSpatialReference&&(this._initialDefaultSpatialReference=e),o||this.ready||(this.viewingMode="global",i&&i("Viewing mode locked to global due to reprojectable layer "+t.id)),i&&i(`Layer ${t.id} is ignored because it supports server-side reprojection`),!1;return!0}whenReady(){return new Promise(e=>{this.ready?e(this):this._resolveWhenReady.push(e)})}computeMapPointFromVec3d(e,t){let i=this.spatialReference||c["a"].WGS84;return Object(z["y"])(e,this.renderSpatialReference,e,i)||(i=c["a"].WGS84,Object(z["y"])(e,this.renderSpatialReference,e,i)),t?(t.x=e[0],t.y=e[1],t.z=e[2],t.spatialReference=i):t=new C["a"](e,i),t}trackGraphicState(e){if(!e.graphic)return xC.error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;const t=this.getViewForGraphic(e.graphic);let i=null,r=!1;const a=t=>{!r&&Object(p["k"])(t)&&"graphics3d"in t&&t.graphics3d&&t.graphics3d.graphicsCore&&(i=t.graphics3d.graphicsCore.trackGraphicState(e))};return Object(p["k"])(t)?a(t):this.whenViewForGraphic(e.graphic,{waitForLayer:!0}).then(e=>a(e),()=>{}).catch(()=>{}),{remove:()=>{r=!0,Object(p["k"])(i)&&(i.remove(),i=null)}}}highlight(e){if(Array.isArray(e))return Object(b["b"])(e.map(e=>this.highlight(e)));if(P["a"].isCollection(e))return Object(b["b"])(e.toArray().map(e=>this.highlight(e)));const t=this.getViewForGraphic(e);return t&&"highlight"in t?t.highlight(e):Object(b["c"])()}maskOccludee(e){if(!e)return xC.error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;const t=this.getViewForGraphic(e);let i=null,r=!1;const a=t=>{!r&&Object(p["k"])(t)&&"graphics3d"in t&&Object(Oe["c"])(t)&&(i=t.maskOccludee(e))};return Object(p["k"])(t)?a(t):this.whenViewForGraphic(e,{waitForLayer:!0}).then(e=>a(e),()=>{}).catch(()=>{}),{remove:()=>{r=!0,Object(p["k"])(i)&&(i.remove(),i=null)}}}getViewForGraphic(e){return e.layer===this.graphics?this.graphicsView:e.layer?this.allLayerViews.find(t=>t.layer===e.layer):null}graphicChanged(e){Object(p["k"])(this.graphicsView)&&this.graphicsView.graphicChanged(e)}async whenViewForGraphic(e,t){if(e.layer===this)return await Object(L["k"])(this,"graphicsView"),this.graphicsView;if(!e.layer||!this.map)throw new O["a"]("no-view-for-graphic");return t&&t.waitForLayer&&!this.map.allLayers.includes(e.layer)?new Promise((t,i)=>{const r=this.map.allLayers.on("change",a=>{-1!==a.added.indexOf(e.layer)&&(r.remove(),this.whenLayerView(e.layer).then(t,i))})}):this.whenLayerView(e.layer)}externalToInternalIntersectOptions(e){const t=this._externalToInternalRenderItems(e.include,0),i=this._externalToInternalRenderItems(e.exclude,1);return{include:t.layerUids,exclude:i.layerUids,graphics:{include:t.graphicUids,exclude:i.graphicUids}}}_intersectResultToMapPoint(e,t){return e.getIntersectionPoint(CC)?(t=this.computeMapPointFromVec3d(CC,t),"TerrainRenderer"===e.intersector&&this.basemapTerrain&&(t.z=Object(p["u"])(Object(xe["b"])(this.basemapTerrain,t),0)),t):null}_intersectResultsToHits(e,t){const i=new Array;let r=null;for(let a=0;a<e.length;a++){const n=e[a],s=n.toOwner(this);if(Object(p["k"])(s)&&(s===this.map.ground||"type"in s&&"integrated-mesh"===s.type))break;const o=n.toGraphic(this);if(!Object(p["k"])(o))continue;if(Object(p["j"])(r)&&a!==e.length-1&&(r=new Set),Object(p["k"])(r)){const e=this._getGraphicFilterUid(o);if(r.has(e))continue;r.add(e)}if(!this._testGraphicUidFilter(t,o))continue;const c=this._intersectResultToMapPoint(n),l=n.distanceInRenderSpace;i.push({graphic:o,mapPoint:c,distance:l})}return i}_getGraphicFilterUid(e){if(e.layer&&"objectIdField"in e.layer){const t=e.attributes[e.layer.objectIdField];if(t)return`o-${e.layer.id}-${t}`}return"u-"+e.uid}_testGraphicUidFilter(e,t){const i=this._getGraphicFilterUid(t);return Object(p["j"])(e)||(Object(p["j"])(e.include)||e.include.has(i))&&(Object(p["j"])(e.exclude)||!e.exclude.has(i))}_externalToInternalRenderItems(e,t,i={layerUids:null,graphicUids:null}){return e?(e instanceof R["a"]?(SC(i,this._getGraphicFilterUid(e)),0===t&&(Object(p["k"])(this.graphicsView)&&e.layer===this?wC(i,this.graphicsView.graphics3d.layer.id):e.layer&&wC(i,e.layer.uid))):"forEach"in e?e.forEach(e=>{Array.isArray(e)?this._externalToInternalRenderItems(e,t,i):P["a"].isCollection(e)?e===this.graphics&&Object(p["k"])(this.graphicsView)?wC(i,this.graphicsView.graphics3d.layer.id):this._externalToInternalRenderItems(e,t,i):e instanceof D["a"]?e===this.map.ground&&wC(i,Ur["e"]):this._externalToInternalRenderItems(e,t,i)}):wC(i,e.uid),i):i}_viewingModeToManifold(e){switch(e){case 1:return"spherical";case 2:return"planar"}}_initBasemapTerrain(e){this._set("basemapTerrain",new yO({view:this,manifold:this._viewingModeToManifold(e)})),this._set("elevationProvider",new xm({view:this})),this.elevationProvider.register("ground",this.basemapTerrain)}_exitBasemapTerrain(){this.basemapTerrain&&(this.elevationProvider.unregister(this.basemapTerrain),this.elevationProvider.destroy(),this._set("elevationProvider",null),this.basemapTerrain.destroy(),this._set("basemapTerrain",null))}_initGlobe(e){this._initCoordinateSystem(e),this.state.init(e,this.spatialReference),this._initBasemapTerrain(e),this._set("pointsOfInterest",new ag({view:this})),this._set("featureTiles",new Gp({renderCoordsHelper:this.renderCoordsHelper,cameraOnSurface:this.pointsOfInterest.contentCameraOnSurface,focus:this.pointsOfInterest.focus,tilingSchemeOwner:this.basemapTerrain,viewState:this.state,scheduler:this._resourceController.scheduler,terrain:this.basemapTerrain}));const t=()=>{const e=this.basemapTerrain&&this.basemapTerrain.extent;if(this.clippingArea||e)if(e&&this.basemapTerrain.spatialReference){const e=Object(F["A"])(this.basemapTerrain.extent,this.basemapTerrain.spatialReference);this.clippingArea?this.featureTiles.filterExtent=e.intersection(this.clippingArea):this.featureTiles.filterExtent=e}else this.featureTiles.filterExtent=this.clippingArea;else this.featureTiles.filterExtent=null};this.handles.add([this.updatingHandles.add(dd["a"],"FEATURE_TILE_TREE_SHOW_TILES",e=>{e&&this.featureTiles&&!this.featureTreeDebugger?this.updatingHandles.addPromise(i.e("chunk-17816536").then(i.bind(null,"8e36"))).then(({FeatureTileTree3DDebugger:e})=>{!this.featureTreeDebugger&&dd["a"].FEATURE_TILE_TREE_SHOW_TILES&&(this.featureTreeDebugger=new e({view:this}))}):e||!this.featureTreeDebugger||dd["a"].FEATURE_TILE_TREE_SHOW_TILES||(this.featureTreeDebugger.destroy(),this.featureTreeDebugger=null)},3),this.updatingHandles.add(this,"clippingArea",t,3),this.updatingHandles.add(this,"basemapTerrain.extent",t,3)],"feature-tiles"),this.stateManager.init()}_exitGlobe(){this.state&&(this.stateManager.deinit(),this.handles.remove("render-coords-helper"),this.handles.remove("feature-tiles"),this.featureTiles.destroy(),this._set("featureTiles",null),this.pointsOfInterest.destroy(),this._set("pointsOfInterest",null),this._exitBasemapTerrain(),this.state.exit(),this._exitCoordinateSystem())}_initCoordinateSystem(e){if(this.spatialReference){const t=this.spatialReference;this.mapCoordsHelper&&this.mapCoordsHelper.spatialReference.equals(t)||this._set("mapCoordsHelper",new Im(this.map,t));const i=1===e,r=i?Object(V["g"])(t):t;r!==this.renderSpatialReference&&(this._set("renderCoordsHelper",Nm.createMode(e,r)),i||this.handles.add(this.watch("basemapTerrain.extent",e=>{0===e[0]&&0===e[1]&&0===e[2]&&0===e[3]||(this.renderCoordsHelper.extent=e)},!0),"render-coords-helper"),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(Gr["a"].DEFAULT_TOLERANCE/this.renderCoordsHelper.unitInMeters))}else this._set("mapCoordsHelper",null),this._set("renderCoordsHelper",null)}_exitCoordinateSystem(){this.mapCoordsHelper&&(this.handles.remove("render-coords-helper"),this._set("renderCoordsHelper",null),this._set("mapCoordsHelper",null))}updatingChanged(){this.notifyChange("updating")}_updateUpdatingMonitors(e=null){Object(p["k"])(e)&&4===e.type||(this.handles.remove("updatingMonitors"),this.allLayerViews.forEach(e=>{e.destroyed||(this.handles.add([e.watch(["updating","updatingProgress"],()=>this.updatingChanged(),!0)],"updatingMonitors"),e.when(()=>this.updatingChanged(),()=>this.updatingChanged()))}),this.updatingChanged())}_renderScreenshotOverlay(e,t){if(!this.overlay||!this.overlay.hasVisibleItems)return;const i=e.getContext("2d");i.putImageData(t,0,0),this.overlay.renderCanvas(e);const r=i.getImageData(0,0,t.width,t.height);for(let a=0;a<r.data.length;a++)t.data[a]=r.data[a]}_initStage(e){const t={renderContext:this.renderContext,deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,viewingMode:e,alpha:this.alphaCompositingEnabled,canvas:this.renderCanvas,screenshot:{renderOverlay:(e,t)=>this._renderScreenshotOverlay(e,t)}},i=new fm(e,{forEachLayer:e=>this._stage.layers.forAll(e)},this);this._set("sceneIntersectionHelper",i);const r=Object(me["a"])(this.surface);this._stage=new bC({scheduler:this.resourceController.scheduler,viewingMode:e,container:r,options:t,sceneIntersectionHelper:i}),this._lostWebGLContextHandle=Object(x["c"])(this._stage.renderView.canvas,"webglcontextlost",()=>this.fatalError=new O["a"]("webgl-context-lost")),this.handles.add([this.updatingHandles.add(this.qualitySettings,"antialiasingEnabled",()=>{this._stage.renderView.setRenderParameters({antialiasingEnabled:this.qualitySettings.antialiasingEnabled})},2),this.updatingHandles.add(this.qualitySettings,"highQualityTransparency",()=>{this._stage.renderView.setRenderParameters({highQualityTransparency:this.qualitySettings.highQualityTransparency})},2),Object(L["a"])(this,"magnifier",e=>this._stage.renderView.magnifier=e,!0)],"stage");const a=()=>{this._stage.renderView.setRenderParameters({defaultHighlightOptions:Mm.toEngineOptions(this.highlightOptions)})};for(const n of["highlightOptions","highlightOptions.color","highlightOptions.haloColor","highlightOptions.haloOpacity","highlightOptions.fillOpacity","highlightOptions.shadowOpacity","highlightOptions.shadowColor","highlightOptions.shadowDifference"])this.handles.add(this.updatingHandles.add(this,n,a),"stage");a(),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(Gr["a"].DEFAULT_TOLERANCE/this.renderCoordsHelper.unitInMeters),this._set("canvas",this._stage.renderView.canvas)}_exitStage(){this._set("sceneIntersectionHelper",null),this._stage.destroy(),this._stage=null,this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null,this.handles.remove("stage"),this._set("canvas",null)}_initSurface(e){this._exitSurface(),this._initStage(e),this._initGlobe(e),this.sharedSymbolResources=new bb({view:this,viewingMode:e,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state,objectResourceCache:new ip})}_exitSurface(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitGlobe(),this._exitStage())}_createGraphicsViewIfNeeded(){if(this.graphicsView||this._createGraphicsViewController)return;if(0===this.graphics.length)return;this.handles.remove("graphics-view"),this._createGraphicsViewController=Object(j["e"])();const e=()=>{this._createGraphicsViewController=null,this.updatingChanged()};this._createGraphicsViewAsync(this._createGraphicsViewController.signal).then(e,e),this.updatingChanged()}async _createGraphicsViewAsync(e){const t=(await Promise.all([i.e("chunk-66a552f7"),i.e("chunk-1d31f51e")]).then(i.bind(null,"3c0a"))).default;Object(j["w"])(e),await Object(L["m"])(this.basemapTerrain,"ready",e),this._set("graphicsView",new t({view:this}))}_disposeGraphicsView(){this._createGraphicsViewController&&(this._createGraphicsViewController.abort(),this._createGraphicsViewController=null),this.handles.remove("graphics-view"),Object(p["k"])(this.graphicsView)&&(this.handles.remove(this.graphicsView.graphics3d.layer.id),this.graphicsView.destroy(),this._set("graphicsView",null))}_startup(){const e=Ge(this.viewingMode);if(1===e&&(this._clippingArea=null),this._set("ready",!0),this._initSurface(e),this.handles.add(Object(L["b"])(this,"graphics","after-changes",()=>this._createGraphicsViewIfNeeded()),"graphics-view"),this._createGraphicsViewIfNeeded(),!this._externallySet.environment){const e=this.get("map.initialViewProperties.environment");e&&(this.environment=e)}this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect();const t=this._resolveWhenReady;this._resolveWhenReady=[],t.forEach(e=>e(this))}_teardown(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this.labeler.dispose(),this._disposeGraphicsView(),this.handles.remove("graphics-view"),this._exitSurface(),this._set("ready",!1)}_updateDefaultToMapOptions(){if(this._defaultToMapOptions.include.clear(),this.map){this.map.ground&&this._defaultToMapOptions.include.add(Ur["e"]);for(const e of this.map.allLayers.items)"integrated-mesh"===e.type&&this._defaultToMapOptions.include.add(e.uid)}}_updateDefaultHitTestOptions(){if(this._defaultHitTestOptions.exclude.clear(),this.map){this.map.ground&&this.map.ground.opacity<1&&this._defaultHitTestOptions.exclude.add(Ur["e"]);for(const e of this.map.allLayers.items)"integrated-mesh"===e.type&&e.opacity<1&&this._defaultToMapOptions.exclude.add(e.uid)}}};function wC(e,t){e.layerUids||(e.layerUids=new Set),e.layerUids.add(t)}function SC(e,t){e.graphicUids||(e.graphicUids=new Set),e.graphicUids.add(t)}Object(d["a"])([Object(g["b"])()],jC.prototype,"_resourceController",void 0),Object(d["a"])([Object(g["b"])()],jC.prototype,"_stage",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],jC.prototype,"deconflictor",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],jC.prototype,"labeler",void 0),Object(d["a"])([Object(g["b"])({type:ze["a"],readOnly:!0,aliasOf:"state.animation"})],jC.prototype,"animation",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],jC.prototype,"basemapTerrain",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],jC.prototype,"elevationProvider",void 0),Object(d["a"])([Object(g["b"])({type:E["a"],aliasOf:"stateManager.camera"})],jC.prototype,"camera",void 0),Object(d["a"])([Object(g["b"])({type:E["a"],aliasOf:"stateManager.contentCamera"})],jC.prototype,"contentCamera",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],jC.prototype,"canvas",void 0),Object(d["a"])([Object(g["b"])({type:C["a"],aliasOf:"stateManager.center"})],jC.prototype,"center",void 0),Object(d["a"])([Object(g["b"])({type:T["a"],dependsOn:["map.clippingArea?","map.clippingEnabled?","viewingMode"]})],jC.prototype,"clippingArea",null),Object(d["a"])([Object(g["b"])({type:yt})],jC.prototype,"constraints",void 0),Object(d["a"])([Object(g["b"])({type:T["a"],dependsOn:["basemapTerrain.extent","clippingArea","map"],readOnly:!0})],jC.prototype,"dataExtent",null),Object(d["a"])([Object(g["b"])({value:null,type:Rt})],jC.prototype,"environment",null),Object(d["a"])([Object(v["a"])("environment")],jC.prototype,"castEnvironment",null),Object(d["a"])([Object(g["b"])({readOnly:!0})],jC.prototype,"environmentManager",void 0),Object(d["a"])([Object(g["b"])({type:T["a"],aliasOf:"stateManager.extent"})],jC.prototype,"extent",void 0),Object(d["a"])([Object(g["b"])()],jC.prototype,"floors",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0,aliasOf:"stateManager.screenCenter"})],jC.prototype,"screenCenter",void 0),Object(d["a"])([Object(g["b"])({type:Number})],jC.prototype,"pixelRatio",null),Object(d["a"])([Object(g["b"])({type:Number,dependsOn:["qualitySettings.maximumPixelRatio","qualitySettings.maximumRenderResolution","size"]})],jC.prototype,"maximumPixelRatio",null),Object(d["a"])([Object(g["b"])({aliasOf:"stateManager.frustum"})],jC.prototype,"frustum",void 0),Object(d["a"])([Object(g["b"])({type:Number,readOnly:!0})],jC.prototype,"fullOpacity",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],jC.prototype,"graphicsView",void 0),Object(d["a"])([Object(g["b"])({type:T["a"],dependsOn:["basemapTerrain.extent"],readOnly:!0})],jC.prototype,"groundExtent",null),Object(d["a"])([Object(g["b"])()],jC.prototype,"groundView",void 0),Object(d["a"])([Object(g["b"])({type:Boolean})],jC.prototype,"initialExtentRequired",null),Object(d["a"])([Object(g["b"])({type:Boolean,readOnly:!0})],jC.prototype,"interacting",null),Object(d["a"])([Object(g["b"])()],jC.prototype,"stationary",null),Object(d["a"])([Object(g["b"])({aliasOf:"state.navigating"})],jC.prototype,"navigating",void 0),Object(d["a"])([Object(g["b"])()],jC.prototype,"map",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],jC.prototype,"mapCoordsHelper",void 0),Object(d["a"])([Object(g["b"])({aliasOf:"stateManager.padding"})],jC.prototype,"padding",void 0),Object(d["a"])([Object(g["b"])({type:ag,readOnly:!0})],jC.prototype,"pointsOfInterest",void 0),Object(d["a"])([Object(g["b"])({type:Gp,readOnly:!0})],jC.prototype,"featureTiles",void 0),Object(d["a"])([Object(g["b"])()],jC.prototype,"featureTreeDebugger",void 0),Object(d["a"])([Object(g["b"])({type:Boolean})],jC.prototype,"screenSizePerspectiveEnabled",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],jC.prototype,"deactivatedWebGLExtensions",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],jC.prototype,"debugWebGLExtensions",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],jC.prototype,"renderCanvas",void 0),Object(d["a"])([Object(g["b"])({constructOnly:!0})],jC.prototype,"state",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],jC.prototype,"inputManager",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],jC.prototype,"stateManager",void 0),Object(d["a"])([Object(g["b"])({type:["low","medium","high"]})],jC.prototype,"qualityProfile",null),Object(d["a"])([Object(g["b"])({type:Bm,get(){let e=this._get("qualitySettings");return e||(e=new Bm,Tm.apply(this.qualityProfile,e)),e}})],jC.prototype,"qualitySettings",void 0),Object(d["a"])([Object(g["b"])()],jC.prototype,"slicePlane",null),Object(d["a"])([Object(g["b"])({dependsOn:["viewingMode"]})],jC.prototype,"preconditionsReady",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],jC.prototype,"renderCoordsHelper",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],jC.prototype,"sceneIntersectionHelper",void 0),Object(d["a"])([Object(g["b"])({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],jC.prototype,"resolution",null),Object(d["a"])([Object(g["b"])({type:Number,aliasOf:"stateManager.scale"})],jC.prototype,"scale",void 0),Object(d["a"])([Object(g["b"])({dependsOn:[]})],jC.prototype,"heightModelInfo",null),Object(d["a"])([Object(g["b"])({dependsOn:["map.initialViewProperties?.spatialReference","defaultsFromMap.isSpatialReferenceDone"]})],jC.prototype,"spatialReference",void 0),Object(d["a"])([Object(g["b"])({type:Boolean,constructOnly:!0})],jC.prototype,"alphaCompositingEnabled",void 0),Object(d["a"])([Object(g["b"])({type:Boolean})],jC.prototype,"supersampleScreenhotsEnabled",void 0),Object(d["a"])([Object(g["b"])({readOnly:!0})],jC.prototype,"type",void 0),Object(d["a"])([Object(g["b"])({type:_C})],jC.prototype,"ui",void 0),Object(d["a"])([Object(g["b"])({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","_resourceController.updating","_stage.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.hasPendingInputs"]})],jC.prototype,"updating",null),Object(d["a"])([Object(g["b"])({type:Number,readOnly:!0,dependsOn:["updating"]})],jC.prototype,"updatingProgress",void 0),Object(d["a"])([Object(g["b"])({type:["global","local"],dependsOn:["map.initialViewProperties?.viewingMode","spatialReference"]})],jC.prototype,"viewingMode",null),Object(d["a"])([Object(g["b"])({type:I["a"],aliasOf:"stateManager.viewpoint"})],jC.prototype,"viewpoint",void 0),Object(d["a"])([Object(g["b"])({type:Number,aliasOf:"stateManager.zoom"})],jC.prototype,"zoom",void 0),Object(d["a"])([Object(g["b"])({type:Mm})],jC.prototype,"highlightOptions",void 0),jC=Object(d["a"])([Object(y["a"])("esri.views.SceneView")],jC);const CC=Object(M["e"])(),TC=Object(A["g"])();var PC=jC,AC=PC,RC=i("f6ad"),MC=i("ce0b"),EC=(i("e1bb"),i("ff57")),DC=i("955e"),IC={name:"Symbol3D",components:{},data:function(){return{}},mounted:function(){this.init(),this.initTreeLayer(),this.initPolygonLayer(),this.initBind(),this.initDraw()},methods:{init:function(){var e=new h["a"]({basemap:"topo",ground:"world-elevation"}),t=new AC({container:this.$refs["dom"],map:e,center:[113.54766657989391,22.76579858397575],camera:{position:{x:12639861.409218187,y:2602892.6764444276,z:526.4768209708855,spatialReference:{wkid:102100}},tilt:55,fov:56,heading:14},environment:{lighting:{directShadowsEnabled:!0,ambientOcclusionEnabled:!0}}}),i=new RC["a"]({view:t});t.ui.add(i,{position:"bottom-left"}),this.map=e,window._view=this.view=t},initTreeLayer:function(){var e=this.getPoleData(),t=new EC["a"]({symbol:{type:"point-3d",symbolLayers:[{type:"object",resource:{href:"".concat("/","/static/gltf/Light_On_Post_-_Light_on.glb")},material:{color:"red"},width:3,height:20,depth:3}]},label:"tree",visualVariables:[{type:"color",field:"storage",stops:[{value:0,color:"#f7fcb9"},{value:1e4,color:"#31a354"}],legendOptions:{title:"storage"}}]}),i=new l["default"]({title:"路灯",id:"treeLayer",source:[],fields:[{name:"ObjectID",alias:"ObjectID",type:"oid"},{name:"title",alias:"title",type:"string"},{name:"height",alias:"height",type:"integer"},{name:"storage",alias:"storage",type:"integer"},{name:"lngLat",type:"string"}],outFields:["*"],objectIdField:"ObjectID",renderer:t,spatialReference:{wkid:4326},geometryType:"point",popupTemplate:{title:"{title}",content:[{type:"fields",fieldInfos:[{fieldName:"height",label:"高度",visible:!1},{fieldName:"lngLat",label:"经纬度"}]}]}});this.map.add(i),i.applyEdits({addFeatures:e}).then((function(e){console.log("addFeatures:".concat(e.addFeatureResults.length))}))},getPoleData:function(){var e=[[113.54792137639583,22.76428599456751],[113.54765412242253,22.7645254364563],[113.54735692251681,22.764795140355677],[113.54702860471272,22.76506775836771],[113.54679495179647,22.765300693788106],[113.54646512296225,22.76559071514216],[113.54617641385929,22.765827763813054],[113.54593925816756,22.76606520027423],[113.54827733113964,22.764491562772694],[113.54796603753947,22.76473897646235],[113.54763653901325,22.765032958471586],[113.54732237877924,22.765279382463525],[113.54707593274021,22.76552142913973],[113.54678867579418,22.76580299973701],[113.54648139141185,22.76606877290851],[113.54620133835031,22.766407902370602]],t=[];return e.forEach((function(e){var i=new R["a"]({geometry:{type:"point",longitude:e[0],latitude:e[1],spatialReference:{wkid:102100}},attributes:{storage:1e3+parseInt(5e3*Math.random()),height:50,id:(new Date).getTime(),lngLat:e}});t.push(i)})),t},initPolygonLayer:function(){var e=this;return Object(n["a"])(regeneratorRuntime.mark((function t(){var i,r,a;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return i=new EC["a"]({symbol:{type:"polygon-3d",symbolLayers:[{type:"extrude",size:100,material:{color:"#fff"},edges:{type:"solid",color:[50,50,50,.5]}}]},visualVariables:[{type:"size",field:"height"}]}),r=new l["default"]({title:"建筑",id:"polygonLayer",source:[],fields:[{name:"ObjectID",alias:"ObjectID",type:"oid"},{name:"height",type:"integer"},{name:"name",type:"string"}],outFields:["*"],objectIdField:"ObjectID",renderer:i,spatialReference:{wkid:4326},geometryType:"mesh",popupTemplate:{title:"建筑{name}",content:[{type:"fields",fieldInfos:[{fieldName:"height",label:"高度",visible:!1}]}]}}),e.map.add(r),t.next=5,e.getPolygonData();case 5:a=t.sent,r.applyEdits({addFeatures:a}).then((function(e){console.log("addFeatures:".concat(e.addFeatureResults.length))})).catch((function(e){}));case 7:case"end":return t.stop()}}),t)})))()},getPolygonData:function(){return new Promise((function(e){o.a.get("".concat("/","/static/nsBuildingData.json")).then((function(t){var i=t.data.data,r=[];i.forEach((function(e){var t=e.coordinates,i=e.features,a=new R["a"]({geometry:{type:"polygon",rings:t,spatialReference:{wkid:102100}},attributes:{name:i.name,height:i.height||50+parseInt(100*Math.random())}});r.push(a)})),e(r)}))}))},initBind:function(){this.view.on("click",(function(e){var t=e.mapPoint,i=t.longitude,r=t.latitude;console.log("[".concat([i,r],"]"))}))},initDraw:function(){var e=new MC["a"]({id:"canvas",title:"绘制面板"});this.map.add(e);var t=new DC["a"]({layer:e,view:this.view,creationMode:"update"});this.view.ui.add(t,"top-right"),t.on("update",(function(e){if(e.graphics[0].geometry){var t=e.graphics[0].geometry,i="";switch(t.type){case"point":i="x:".concat(t.x,", y:").concat(t.y);break;case"polyline":i=JSON.stringify(t.paths);break;case"polygon":i=JSON.stringify(t.rings);break}console.log(i)}})),this.sketch=t}}},LC=IC,VC=i("2877"),kC=Object(VC["a"])(LC,r,a,!1,null,"a45d3850",null);t["default"]=kC.exports},"7cb4":function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));var r=i("3886"),a=i("dfaf"),n=i("5211");function s(e,t){e.include(a["a"],t),e.fragment.code.add(r["a"]`
  struct TextureLookupParameter {
    vec2 uv;
    ${t.supportsTextureAtlas?"vec2 size;":""}
  } vtc;
  `),1===t.attributeTextureCoordinates&&e.fragment.code.add(r["a"]`
      vec4 textureLookup(sampler2D tex, TextureLookupParameter params) {
        return texture2D(tex, params.uv);
      }
    `),2===t.attributeTextureCoordinates&&(e.include(n["a"]),e.fragment.code.add(r["a"]`
    vec4 textureLookup(sampler2D tex, TextureLookupParameter params) {
        return textureAtlasLookup(tex, params.size, params.uv, vuvRegion);
      }
    `))}},"7cfb":function(e,t,i){"use strict";function r(e,t,i){const r=e.typedBuffer,a=e.typedBufferStride,n=t.typedBuffer,s=t.typedBufferStride,o=i?i.count:t.count;let c=(i&&i.dstIndex?i.dstIndex:0)*a,l=(i&&i.srcIndex?i.srcIndex:0)*s;for(let h=0;h<o;++h)r[c]=n[l],c+=a,l+=s}function a(e,t){const i=e.count;t||(t=new e.TypedArrayConstructor(i));for(let r=0;r<i;r++)t[r]=e.get(r);return t}i.d(t,"a",(function(){return a}));Object.freeze({__proto__:null,copy:r,makeDense:a})},"7d11":function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));var r=i("3886"),a=i("c332"),n=i("bc40");function s(e,t){0===t.normalType||1===t.normalType?(e.include(a["a"],t),e.varyings.add("vNormalWorld","vec3"),e.varyings.add("vNormalView","vec3"),e.vertex.uniforms.add("uTransformNormal_GlobalFromModel","mat3"),e.vertex.uniforms.add("uTransformNormal_ViewFromGlobal","mat3"),e.vertex.code.add(r["a"]`
      void forwardNormal() {
        vNormalWorld = uTransformNormal_GlobalFromModel * normalModel();
        vNormalView = uTransformNormal_ViewFromGlobal * vNormalWorld;
      }
    `)):2===t.normalType?(e.include(n["a"],t),e.varyings.add("vNormalWorld","vec3"),e.vertex.code.add(r["a"]`
    void forwardNormal() {
      vNormalWorld = ${1===t.viewingMode?r["a"]`normalize(vPositionWorldCameraRelative);`:r["a"]`vec3(0.0, 0.0, 1.0);`}
    }
    `)):e.vertex.code.add(r["a"]`
      void forwardNormal() {}
    `)}!function(e){function t(e,t){e.setUniformMatrix4fv("viewNormal",t)}e.bindUniforms=t}(s||(s={}))},"7dcb":function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));class r{}},"7e0c":function(e,t,i){"use strict";i.d(t,"a",(function(){return g})),i.d(t,"b",(function(){return v}));var r=i("880d"),a=i("0b2d"),n=i("e431"),s=i("2ebb"),o=i("0c9d");class c{updateSettings(e){this.settings=e,this.edgeHashFunction=e.reducedPrecision?p:u}write(e,t,i){const r=this.edgeHashFunction(i);O.seed=r;const a=O.getIntRange(0,255),n=O.getIntRange(0,this.settings.variants-1),s=.7,o=O.getFloat(),c=255*(.5*b(-(1-Math.min(o/s,1))+Math.max(0,o-s)/(1-s),1.2)+.5);e.position0.setVec(t,i.position0),e.position1.setVec(t,i.position1),e.componentIndex.set(t,i.componentIndex),e.variantOffset.set(t,a),e.variantStroke.set(t,n),e.variantExtension.set(t,c)}trim(e,t){return e.slice(0,t)}}const l=new Float32Array(6),h=new Uint32Array(l.buffer),d=new Uint32Array(1);function u(e){const t=l;t[0]=e.position0[0],t[1]=e.position0[1],t[2]=e.position0[2],t[3]=e.position1[0],t[4]=e.position1[1],t[5]=e.position1[2],d[0]=5381;for(let i=0;i<h.length;i++)d[0]=31*d[0]+h[i];return d[0]}function p(e){const t=l;t[0]=m(e.position0[0]),t[1]=m(e.position0[1]),t[2]=m(e.position0[2]),t[3]=m(e.position1[0]),t[4]=m(e.position1[1]),t[5]=m(e.position1[2]),d[0]=5381;for(let i=0;i<h.length;i++)d[0]=31*d[0]+h[i];return d[0]}const f=1e4;function m(e){return Math.round(e*f)/f}function b(e,t){const i=e<0?-1:1;return Math.abs(e)**t*i}class g{constructor(){this.commonWriter=new c}updateSettings(e){this.commonWriter.updateSettings(e)}allocate(e){return o["c"].createBuffer(e)}write(e,t,i){this.commonWriter.write(e,t,i),Object(n["g"])(y,i.faceNormal0,i.faceNormal1),Object(n["s"])(y,y),e.normal.setVec(t,y)}trim(e,t){return this.commonWriter.trim(e,t)}}g.Layout=o["c"],g.glLayout=Object(s["a"])(o["c"],{divisor:1});class v{constructor(){this.commonWriter=new c}updateSettings(e){this.commonWriter.updateSettings(e)}allocate(e){return o["d"].createBuffer(e)}write(e,t,i){this.commonWriter.write(e,t,i),e.normalA.setVec(t,i.faceNormal0),e.normalB.setVec(t,i.faceNormal1)}trim(e,t){return this.commonWriter.trim(e,t)}}v.Layout=o["d"],v.glLayout=Object(s["a"])(o["d"],{divisor:1});const y=Object(a["e"])(),O=new r["a"]},"7e21":function(e,t,i){"use strict";i.d(t,"a",(function(){return p}));var r=i("3886"),a=i("4db9"),n=i("d272"),s=i("6a07"),o=i("be24"),c=i("ebd5"),l=i("c2d1"),h=i("dfaf"),d=i("c332"),u=i("7d11");function p(e,t){const i=e.vertex.code,p=e.fragment.code;1!==t.output&&3!==t.output||(e.include(a["a"],{linearDepth:!0}),e.include(h["a"],t),e.include(o["a"],t),e.include(l["a"],t),e.include(n["a"],t),e.vertex.uniforms.add("cameraNearFar","vec2"),e.varyings.add("depth","float"),t.hasColorTexture&&e.fragment.uniforms.add("tex","sampler2D"),i.add(r["a"]`
      void main(void) {
        vpos = calculateVPos();
        vpos = subtractOrigin(vpos);
        vpos = addVerticalOffset(vpos, localOrigin);
        gl_Position = transformPositionWithDepth(proj, view, vpos, cameraNearFar, depth);
        forwardTextureCoordinates();
      }
    `),e.include(c["a"],t),p.add(r["a"]`
      void main(void) {
        discardBySlice(vpos);
        ${t.hasColorTexture?r["a"]`
        vec4 texColor = texture2D(tex, vuv0);
        discardOrAdjustAlpha(texColor);`:""}
        outputDepth(depth);
      }
    `)),2===t.output&&(e.include(a["a"],{linearDepth:!1}),e.include(d["a"],t),e.include(u["a"],t),e.include(h["a"],t),e.include(o["a"],t),t.hasColorTexture&&e.fragment.uniforms.add("tex","sampler2D"),e.vertex.uniforms.add("viewNormal","mat4"),e.varyings.add("vPositionView","vec3"),i.add(r["a"]`
      void main(void) {
        vpos = calculateVPos();
        vpos = subtractOrigin(vpos);
        ${0===t.normalType?r["a"]`
        vNormalWorld = dpNormalView(vvLocalNormal(normalModel()));`:""}
        vpos = addVerticalOffset(vpos, localOrigin);
        gl_Position = transformPosition(proj, view, vpos);
        forwardTextureCoordinates();
      }
    `),e.include(n["a"],t),e.include(c["a"],t),p.add(r["a"]`
      void main() {
        discardBySlice(vpos);
        ${t.hasColorTexture?r["a"]`
        vec4 texColor = texture2D(tex, vuv0);
        discardOrAdjustAlpha(texColor);`:""}

        ${3===t.normalType?r["a"]`
            vec3 normal = screenDerivativeNormal(vPositionView);`:r["a"]`
            vec3 normal = normalize(vNormalWorld);
            if (gl_FrontFacing == false) normal = -normal;`}
        gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);
      }
    `)),4===t.output&&(e.include(a["a"],{linearDepth:!1}),e.include(h["a"],t),e.include(o["a"],t),t.hasColorTexture&&e.fragment.uniforms.add("tex","sampler2D"),i.add(r["a"]`
      void main(void) {
        vpos = calculateVPos();
        vpos = subtractOrigin(vpos);
        vpos = addVerticalOffset(vpos, localOrigin);
        gl_Position = transformPosition(proj, view, vpos);
        forwardTextureCoordinates();
      }
    `),e.include(n["a"],t),e.include(c["a"],t),e.include(s["a"]),p.add(r["a"]`
      void main() {
        discardBySlice(vpos);
        ${t.hasColorTexture?r["a"]`
        vec4 texColor = texture2D(tex, vuv0);
        discardOrAdjustAlpha(texColor);`:""}
        outputHighlight();
      }
    `))}},"7f60":function(e,t,i){"use strict";i.d(t,"a",(function(){return b})),i.d(t,"b",(function(){return g}));i("c120");var r=i("b2b2"),a=i("e92d"),n=i("38a4"),s=i("9ef0"),o=i("0b2d"),c=i("0fc4"),l=i("ba58"),h=i("2e0f"),d=i("e9d6"),u=i("0eb9"),p=i("5e82"),f=i("a803");const m=a["a"].getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayer");class b extends p["a"]{constructor(e,t,i,r){super(),this._elevationInfoOverride=null,this.complexity=null,this.logger=m,this._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0},this.symbol=e,this.symbolLayer=t,this._context=i,this._renderPriority=r.renderPriority,this._renderPriorityStep=r.renderPriorityStep,this._elevationContext=new u["a"],this.complexity=this.computeComplexity(),this._updateDrivenProperties(r.ignoreDrivers),this._updateElevationContext()}getCachedSize(){return null}get extentPadding(){return 0}get needsDrivenTransparentPass(){return this._drivenProperties.opacity&&!this._drivenProperties.opacityAlwaysOpaque}_logGeometryCreationWarnings(e,t,i,r){const a=e.projectionSuccess,n="polygons"in e?e.polygons:null,s=r+" geometry failed to be created";let o=null;a?!t.length||1===t.length&&!t[0].length?o=`${s} (no ${i} were defined)`:Array.isArray(t)&&Array.isArray(t[0])?n&&0===n.length&&"rings"===i&&t.length>0&&t[0].length>2&&(o=s+" (filled rings should use clockwise winding - try reversing the order of vertices)"):o=`${s} (${i} should be defined as a 2D array)`:o=s+" (failed to project geometry to view spatial reference)",o&&m.warnOncePerTick(o)}_validateGeometry(e,t=null,i=null){if(Object(r["k"])(t)&&!t.includes(e.type))return this.logger.warn("unsupported geometry type for "+i+" symbol: "+e.type),!1;if("point"===e.type){const t=e;if(!Object(n["j"])(t.x)||!Object(n["j"])(t.y))return m.warn("point coordinate is not a valid number, graphic skipped"),!1}return!0}_defaultElevationInfoNoZ(){return v}_defaultElevationInfoZ(){return y}_updateElevationContext(){Object(r["k"])(this._elevationInfoOverride)?(this._elevationContext.setFromElevationInfo(this._elevationInfoOverride),this._elevationContext.updateFeatureExpressionInfoContext(null)):this._context.layer.elevationInfo?(this._elevationContext.setFromElevationInfo(this._context.layer.elevationInfo),this._elevationContext.updateFeatureExpressionInfoContext(this._context.featureExpressionInfoContext)):this._elevationContext.reset()}getDefaultElevationInfo(e){return e.hasZ?this._defaultElevationInfoZ():this._defaultElevationInfoNoZ()}getGeometryElevationMode(e,t=this.getDefaultElevationInfo(e)){return this._elevationContext.mode||t.mode}setElevationInfoOverride(e){this._elevationInfoOverride=e,this._updateElevationContext()}setGraphicElevationContext(e,t){const i=Object(r["t"])(e.geometry),a=this.getDefaultElevationInfo(i);t.unit=null!=this._elevationContext.unit?this._elevationContext.unit:a.unit,t.mode=this.getGeometryElevationMode(i,a),t.offsetMeters=Object(r["u"])(this._elevationContext.meterUnitOffset,Object(r["u"])(a.offset,0));const n=!this._elevationOptions.supportsOnTheGround&&"on-the-ground"===t.mode;n&&(t.mode="relative-to-ground",t.offsetMeters=0);const s=n?d["h"]:this._elevationContext.featureExpressionInfoContext;return t.updateFeatureExpressionInfoContext(s,e,this._context.layer),t}prepareSymbolLayerPatch(e){}updateGeometry(e,t){return!1}onRemoveGraphic(e){}_updateDrivenProperties(e){const t={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1};if(e)return void(this._drivenProperties=t);const i=this._context.renderer;i&&"visualVariables"in i&&i.visualVariables&&i.visualVariables.forEach(e=>{switch(e.type){case"color":if(t.color=!0,e.stops)for(let i=0;i<e.stops.length;i++){const r=e.stops[i].color;r&&(t.opacity=!0,r.a<1&&(t.opacityAlwaysOpaque=!1))}break;case"opacity":t.opacity=!0,t.opacityAlwaysOpaque=!1;break;case"size":t.size=!0}}),this._drivenProperties=t}_getLayerOpacity(){if(this._context.layerView&&"fullOpacity"in this._context.layerView)return this._context.layerView.fullOpacity;const e=this._context.layer.opacity;return null==e?1:e}_getCombinedOpacity(e,t=O){let i=1;return this.draped||(i*=this._getLayerOpacity()),this._drivenProperties.opacity||(Object(r["k"])(e)?i*=e.a:t.hasIntrinsicColor||(i=0)),i}_getCombinedOpacityAndColor(e,t=O){const i=this._getCombinedOpacity(e,t);if(this._drivenProperties.color)return Object(l["g"])(null,i);const a=Object(r["k"])(e)?s["a"].toUnitRGB(e):o["a"];return Object(l["g"])(a,i)}_getVertexOpacityAndColor(e,t=null){const i=this._drivenProperties.color?e.color:null,a=this._drivenProperties.opacity?e.opacity:null,n=Object(l["g"])(i,a);return Object(r["k"])(t)&&(n[0]*=t,n[1]*=t,n[2]*=t,n[3]*=t),n}isFastUpdatesEnabled(){return this._fastUpdates&&this._fastUpdates.enabled}computeComplexity(){return Object(f["c"])(this.symbol,this.symbolLayer)}destroy(){this.abortLoad()}globalPropertyChanged(e,t,i){switch(e){case"opacity":return this.layerOpacityChanged(t,i);case"elevationInfo":{const e=this._elevationContext.mode;return this._updateElevationContext(),this.layerElevationInfoChanged(t,i,e)!==h["a"].RECREATE}case"slicePlaneEnabled":return this.slicePlaneEnabledChanged(t,i);case"physicalBasedRenderingEnabled":return this.physicalBasedRenderingChanged();case"pixelRatio":return this.pixelRatioChanged();default:return!1}}updateGraphics3DGraphicElevationInfo(e,t,i){let a=h["a"].UPDATE;return e.forEach(e=>{const n=t(e);if(Object(r["k"])(n)){const t=e.graphic;this.setGraphicElevationContext(t,n.elevationContext),n.needsElevationUpdates=i(n.elevationContext.mode)}else a=h["a"].RECREATE}),a}applyRendererDiff(e,t){return!1}getFastUpdateAttrValues(e){if(!this._fastUpdates.enabled)return null;const t=this._fastUpdates.visualVariables,i=t.size?g(t.size.field,e):0,r=t.color?g(t.color.field,e):0,a=t.opacity?g(t.opacity.field,e):0;return Object(c["d"])(i,r,a,0)}get draped(){return this._draped}ensureDrapedStatus(e){return null==this._draped?(this._draped=e,!0):(e!==this.draped&&m.warnOnce("A symbol can only produce either draped or non-draped visualizations. Use two separate symbol instances for draped and non-draped graphics if necessary."),!1)}}function g(e,t){const i=null!=e?t.attributes[e]:0;return null!=i&&isFinite(i)?i:0}const v={mode:"on-the-ground",offset:0,unit:"meters"},y={mode:"absolute-height",offset:0,unit:"meters"},O={hasIntrinsicColor:!1}},8418:function(e,t,i){"use strict";var r=i("c04e"),a=i("9bf2"),n=i("5c6c");e.exports=function(e,t,i){var s=r(t);s in e?a.f(e,s,n(0,i)):e[s]=i}},"851f":function(e,t,i){"use strict";i.d(t,"a",(function(){return p})),i.d(t,"b",(function(){return f}));i("c120");var r=i("b2b2"),a=i("e92d"),n=i("9786"),s=i("4ae5"),o=i("2172"),c=(i("e06a"),i("8048")),l=i("9180");const h=a["a"].getLogger("esri.layers.support.ElevationSampler");class d{queryElevation(e){return f(e.clone(),this)}on(){return O}projectIfRequired(e,t){return m(e,t)}}class u extends d{constructor(e,t,i){super(),this.tile=e,this.noDataValue=i,this.extent=Object(l["A"])(e.tile.extent,t.spatialReference);const r=Object(c["e"])(t.spatialReference),a=t.lodAt(e.tile.level).resolution*r;this.demResolution={min:a,max:a}}get spatialReference(){return this.extent.spatialReference}contains(e){const t=this.projectIfRequired(e,this.spatialReference);return Object(o["e"])(this.extent,t)}elevationAt(e){const t=this.projectIfRequired(e,this.spatialReference);if(!t)return null;if(!this.contains(e)){const t=this.extent,i=`${t.xmin}, ${t.ymin}, ${t.xmax}, ${t.ymax}`;h.warn("#elevationAt()",`Point used to sample elevation (${e.x}, ${e.y}) is outside of the sampler extent (${i})`)}return this.tile.sample(t.x,t.y)}}class p extends d{constructor(e,t,i){let r;super(),"number"==typeof t?(this.noDataValue=t,r=null):(r=t,this.noDataValue=i),this.samplers=r?e.map(e=>new u(e,r,this.noDataValue)):e;const a=this.samplers[0];if(a){this.extent=a.extent.clone();const{min:e,max:t}=a.demResolution;this.demResolution={min:e,max:t};for(let i=1;i<this.samplers.length;i++){const e=this.samplers[i];this.extent.union(e.extent),this.demResolution.min=Math.min(this.demResolution.min,e.demResolution.min),this.demResolution.max=Math.max(this.demResolution.max,e.demResolution.max)}}else this.extent=Object(l["A"])(Object(l["l"])(),r.spatialReference),this.demResolution={min:0,max:0}}get spatialReference(){return this.extent.spatialReference}elevationAt(e){const t=this.projectIfRequired(e,this.spatialReference);if(!t)return null;for(const i of this.samplers)if(i.contains(t))return i.elevationAt(t);return h.warn("#elevationAt()",`Point used to sample elevation (${e.x}, ${e.y}) is outside of the sampler`),null}}function f(e,t){const i=m(e,t.spatialReference);if(!i)return null;switch(e.type){case"point":b(e,i,t);break;case"polyline":g(e,i,t);break;case"multipoint":v(e,i,t)}return e}function m(e,t){const i=e.spatialReference;return i.equals(t)?e:Object(n["a"])(i,t)?Object(n["d"])(e,t):(h.error(`Cannot project geometry spatial reference (wkid:${i.wkid}) to elevation sampler spatial reference (wkid:${t.wkid})`),null)}function b(e,t,i){e.z=Object(r["u"])(i.elevationAt(t),0)}function g(e,t,i){y.spatialReference=t.spatialReference;const a=e.hasM&&!e.hasZ;for(let n=0;n<e.paths.length;n++){const s=e.paths[n],o=t.paths[n];for(let e=0;e<s.length;e++){const t=s[e],n=o[e];y.x=n[0],y.y=n[1],a&&(t[3]=t[2]),t[2]=Object(r["u"])(i.elevationAt(y),0)}}e.hasZ=!0}function v(e,t,i){y.spatialReference=t.spatialReference;const a=e.hasM&&!e.hasZ;for(let n=0;n<e.points.length;n++){const s=e.points[n],o=t.points[n];y.x=o[0],y.y=o[1],a&&(s[3]=s[2]),s[2]=Object(r["u"])(i.elevationAt(y),0)}e.hasZ=!0}const y=new s["a"],O={remove(){}}},8675:function(e,t,i){"use strict";i.d(t,"a",(function(){return c})),i.d(t,"b",(function(){return o})),i.d(t,"c",(function(){return n})),i.d(t,"d",(function(){return s}));var r=i("fc00"),a=i("5957");const n=Object(r["a"])().vec3f("position"),s=Object(r["a"])().vec3f("position").vec2f("uv0"),o=Object(r["a"])().vec3f("position").vec4u8("color");class c{constructor(e){this.vertexBufferLayout=e}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get("position").length}write(e,t,i,r){Object(a["c"])(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,i,r)}}},"86ba":function(e,t,i){"use strict";i.d(t,"a",(function(){return k}));var r=i("b2b2"),a=i("e92d"),n=i("38a4"),s=i("a915"),o=i("0b2d"),c=i("e431"),l=i("3349"),h=i("fc00"),d=i("d0ac"),u=i("1153"),p=i("1038"),f=i("b623"),m=i("d7f7"),b=i("35b3"),g=i("b4c8"),v=i("a4ee"),y=i("c3a4"),O=i("ca98"),_=i("da35"),x=i("8e37"),j=i("189c"),w=i("8e97"),S=i("d272"),C=i("6a07"),T=i("be24"),P=i("7438"),A=i("c6d7"),R=i("87b7"),M=i("9a68");const E={position:0,subdivisionFactor:1,uv0:2,auxpos1:3,auxpos2:4,size:6,sizeFeatureAttribute:6,color:5,colorFeatureAttribute:5,opacityFeatureAttribute:7};class D extends O["a"]{constructor(e,t){super(e,t),this.stipplePattern=null,this.stippleTextureBind=null,this.stippleTextureRepository=e.stippleTextureRepository}initializeProgram(e){const t=D.shader.get(),i=this.configuration,r=t.build({OITEnabled:0===i.transparencyPassType,output:i.output,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,stippleEnabled:i.stippleEnabled,stippleOffColorEnabled:i.stippleOffColorEnabled,stippleUVMaxEnabled:i.stippleIntegerRepeatsEnabled,stippleIntegerRepeatsEnabled:i.stippleIntegerRepeatsEnabled,roundCaps:i.roundCaps,roundJoins:i.roundJoins,vvColor:i.vvColor,vvSize:i.vvSize,vvInstancingEnabled:!0,vvOpacity:i.vvOpacity,falloffEnabled:i.falloffEnabled,innerColorEnabled:i.innerColorEnabled,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new x["a"](e.rctx,r.generateSource("vertex"),r.generateSource("fragment"),E)}dispose(){super.dispose(),this.stippleTextureRepository.release(this.stipplePattern),this.stipplePattern=null,this.stippleTextureBind=null}bindPass(e,t,i){if(w["a"].bindProjectionMatrix(this.program,i.camera.projectionMatrix),4===this.configuration.output&&C["a"].bindOutputHighlight(e,this.program,i),i.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",i.inverseViewport),Object(A["a"])(this.program,e,i)),this.program.setUniform1f("intrinsicWidth",t.width),this.program.setUniform4fv("intrinsicColor",t.color),this.program.setUniform1f("miterLimit","miter"!==t.join?0:t.miterLimit),this.program.setUniform2fv("cameraNearFar",i.camera.nearFar),this.program.setUniform1f("pixelRatio",i.camera.pixelRatio),this.program.setUniform2f("screenSize",i.camera.fullViewport[2],i.camera.fullViewport[3]),T["a"].bindUniformsWithOpacity(this.program,t),this.stipplePattern!==t.stipplePattern){const e=t.stipplePattern;this.stippleTextureBind=this.stippleTextureRepository.swap(this.stipplePattern,e),this.stipplePattern=e}if(this.configuration.stippleEnabled){const a=Object(r["k"])(this.stippleTextureBind)?this.stippleTextureBind(e,0)*i.camera.pixelRatio:1;if(this.program.setUniform1i("stipplePatternTexture",0),this.program.setUniform1f("stipplePatternPixelSizeInv",1/a),this.configuration.stippleOffColorEnabled){const e=Object(r["t"])(t.stippleOffColor);this.program.setUniform4f("stippleOffColor",e[0],e[1],e[2],e.length>3?e[3]:1)}}this.configuration.falloffEnabled&&this.program.setUniform1f("falloff",t.falloff),this.configuration.innerColorEnabled&&(this.program.setUniform4fv("innerColor",Object(r["u"])(t.innerColor,t.color)),this.program.setUniform1f("innerWidth",t.innerWidth*i.camera.pixelRatio))}bindDraw(e){w["a"].bindView(this.program,e),S["a"].bindUniformsWithOrigin(this.program,this.configuration,e)}setPipelineState(e,t){const i=this.configuration,r=3===e,a=2===e;return Object(j["e"])({blending:0===i.output||7===i.output?r?P["f"]:Object(P["a"])(e):null,depthTest:{func:Object(P["b"])(e)},depthWrite:r?!i.transparent&&i.writeDepth&&j["d"]:Object(P["c"])(e),colorWrite:j["c"],stencilWrite:i.sceneHasOcludees?R["j"]:null,stencilTest:i.sceneHasOcludees?t?R["f"]:R["e"]:null,polygonOffset:r||a?i.polygonOffset&&I:P["d"]})}initializePipeline(){const e=this.configuration,t=e.polygonOffset&&I;return e.occluder&&(this._occluderPipelineTransparent=Object(j["e"])({blending:P["f"],polygonOffset:t,depthTest:R["a"],depthWrite:null,colorWrite:j["c"],stencilWrite:null,stencilTest:R["h"]}),this._occluderPipelineOpaque=Object(j["e"])({blending:P["f"],polygonOffset:t,depthTest:R["a"],depthWrite:null,colorWrite:j["c"],stencilWrite:R["i"],stencilTest:R["g"]}),this._occluderPipelineMaskWrite=Object(j["e"])({blending:null,polygonOffset:t,depthTest:R["b"],depthWrite:null,colorWrite:null,stencilWrite:R["j"],stencilTest:R["f"]})),this._occludeePipelineState=this.setPipelineState(this.configuration.transparencyPassType,!0),this.setPipelineState(this.configuration.transparencyPassType,!1)}get primitiveType(){return 5}getPipelineState(e,t){return t?this._occludeePipelineState:this.configuration.occluder?11===e?this._occluderPipelineTransparent:10===e?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:this.pipeline}}D.shader=new y["a"](M["a"],()=>i.e("chunk-2d213386").then(i.bind(null,"ac6d")));const I={factor:0,units:-4};class L extends _["a"]{constructor(){super(...arguments),this.output=0,this.occluder=!1,this.slicePlaneEnabled=!1,this.transparent=!1,this.polygonOffset=!1,this.writeDepth=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stippleIntegerRepeatsEnabled=!1,this.roundCaps=!1,this.roundJoins=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.falloffEnabled=!1,this.innerColorEnabled=!1,this.sceneHasOcludees=!1,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!0}}Object(v["a"])([Object(_["b"])({count:8})],L.prototype,"output",void 0),Object(v["a"])([Object(_["b"])()],L.prototype,"occluder",void 0),Object(v["a"])([Object(_["b"])()],L.prototype,"slicePlaneEnabled",void 0),Object(v["a"])([Object(_["b"])()],L.prototype,"transparent",void 0),Object(v["a"])([Object(_["b"])()],L.prototype,"polygonOffset",void 0),Object(v["a"])([Object(_["b"])()],L.prototype,"writeDepth",void 0),Object(v["a"])([Object(_["b"])()],L.prototype,"stippleEnabled",void 0),Object(v["a"])([Object(_["b"])()],L.prototype,"stippleOffColorEnabled",void 0),Object(v["a"])([Object(_["b"])()],L.prototype,"stippleIntegerRepeatsEnabled",void 0),Object(v["a"])([Object(_["b"])()],L.prototype,"roundCaps",void 0),Object(v["a"])([Object(_["b"])()],L.prototype,"roundJoins",void 0),Object(v["a"])([Object(_["b"])()],L.prototype,"vvSize",void 0),Object(v["a"])([Object(_["b"])()],L.prototype,"vvColor",void 0),Object(v["a"])([Object(_["b"])()],L.prototype,"vvOpacity",void 0),Object(v["a"])([Object(_["b"])()],L.prototype,"falloffEnabled",void 0),Object(v["a"])([Object(_["b"])()],L.prototype,"innerColorEnabled",void 0),Object(v["a"])([Object(_["b"])()],L.prototype,"sceneHasOcludees",void 0),Object(v["a"])([Object(_["b"])({count:4})],L.prototype,"transparencyPassType",void 0),Object(v["a"])([Object(_["b"])()],L.prototype,"multipassTerrainEnabled",void 0),Object(v["a"])([Object(_["b"])()],L.prototype,"cullAboveGround",void 0);const V=a["a"].getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial");class k extends b["a"]{constructor(e){super(e,z),this._vertexAttributeLocations=E,this.techniqueConfig=new L,this.layout=this.createLayout()}isClosed(e,t){return H(this.params,e,t)}dispose(){}getPassParameters(){return this.params}getTechniqueConfig(e,t){this.techniqueConfig.output=e;const i=Object(r["k"])(this.params.stipplePattern);return this.techniqueConfig.stippleEnabled=i,this.techniqueConfig.stippleIntegerRepeatsEnabled=i&&this.params.stippleIntegerRepeats,this.techniqueConfig.stippleOffColorEnabled=i&&Object(r["k"])(this.params.stippleOffColor),this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.sceneHasOcludees=this.params.sceneHasOcludees,this.techniqueConfig.roundJoins="round"===this.params.join,this.techniqueConfig.roundCaps="round"===this.params.cap,this.techniqueConfig.transparent=this.params.transparent,this.techniqueConfig.polygonOffset=this.params.polygonOffset,this.techniqueConfig.writeDepth=this.params.writeDepth,this.techniqueConfig.vvColor=this.params.vvColorEnabled,this.techniqueConfig.vvOpacity=this.params.vvOpacityEnabled,this.techniqueConfig.vvSize=this.params.vvSizeEnabled,this.techniqueConfig.innerColorEnabled=this.params.innerWidth>0&&Object(r["k"])(this.params.innerColor),this.techniqueConfig.falloffEnabled=this.params.falloff>0,this.techniqueConfig.occluder=8===this.params.renderOccluded,this.techniqueConfig.transparencyPassType=t?t.transparencyPassType:3,this.techniqueConfig.multipassTerrainEnabled=!!t&&t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=!t||t.cullAboveGround,this.techniqueConfig}intersect(e,t,i,r,a,n,s,o,c){c?this.intersectDrapedLineGeometry(e,r,n,s):this.intersectLineGeometry(e,t,i,r,this.params.width,s)}intersectDrapedLineGeometry(e,t,i,r){if(!t.options.selectionMode)return;const a=e.vertexAttributes.get("position").data,s=e.vertexAttributes.get("size");let o=this.params.width;if(this.params.vvSizeEnabled){const t=e.vertexAttributes.get("sizeFeatureAttribute").data[0];o*=Object(n["d"])(this.params.vvSizeOffset[0]+t*this.params.vvSizeFactor[0],this.params.vvSizeMinSize[0],this.params.vvSizeMaxSize[0])}else s&&(o*=s.data[0]);const c=i[0],l=i[1],h=(o/2+4)*e.screenToWorldRatio;let d=Number.MAX_VALUE;for(let u=0;u<a.length-5;u+=3){const e=a[u],t=a[u+1],i=c-e,r=l-t,s=a[u+3]-e,o=a[u+4]-t,h=Object(n["d"])((s*i+o*r)/(s*s+o*o),0,1),p=s*h-i,f=o*h-r,m=p*p+f*f;m<d&&(d=m)}d<h*h&&r()}intersectLineGeometry(e,t,i,r,a,s){if(!r.options.selectionMode||Object(f["e"])(t))return;if(!Object(u["g"])(i))return void V.error("intersection assumes a translation-only matrix");const o=e.vertexAttributes,h=o.get("position").data;let p=a;if(this.params.vvSizeEnabled){const e=o.get("sizeFeatureAttribute").data[0];p*=Object(n["d"])(this.params.vvSizeOffset[0]+e*this.params.vvSizeFactor[0],this.params.vvSizeMinSize[0],this.params.vvSizeMaxSize[0])}else o.has("size")&&(p*=o.get("size").data[0]);const m=r.camera,b=X;Object(l["c"])(b,r.point);const g=p*m.pixelRatio/2+4*m.pixelRatio;Object(c["x"])(se[0],b[0]-g,b[1]+g,0),Object(c["x"])(se[1],b[0]+g,b[1]+g,0),Object(c["x"])(se[2],b[0]+g,b[1]-g,0),Object(c["x"])(se[3],b[0]-g,b[1]-g,0);for(let n=0;n<4;n++)if(!m.unprojectFromRenderScreen(se[n],oe[n]))return;d["f"].fromPoints(m.eye,oe[0],oe[1],ce),d["f"].fromPoints(m.eye,oe[1],oe[2],le),d["f"].fromPoints(m.eye,oe[2],oe[3],he),d["f"].fromPoints(m.eye,oe[3],oe[0],de);let v=Number.MAX_VALUE;const y=B(this.params,o,e.indices)?h.length-2:h.length-5;for(let n=0;n<y;n+=3){W[0]=h[n]+i[12],W[1]=h[n+1]+i[13],W[2]=h[n+2]+i[14];const e=(n+3)%h.length;if(Z[0]=h[e]+i[12],Z[1]=h[e+1]+i[13],Z[2]=h[e+2]+i[14],d["f"].signedDistance(ce,W)<0&&d["f"].signedDistance(ce,Z)<0||d["f"].signedDistance(le,W)<0&&d["f"].signedDistance(le,Z)<0||d["f"].signedDistance(he,W)<0&&d["f"].signedDistance(he,Z)<0||d["f"].signedDistance(de,W)<0&&d["f"].signedDistance(de,Z)<0)continue;if(m.projectToRenderScreen(W,Y),m.projectToRenderScreen(Z,K),Y[2]<0&&K[2]>0){Object(c["k"])($,W,Z);const e=m.frustum,t=-d["f"].signedDistance(e[4],W)/Object(c["i"])($,d["f"].normal(e[4]));Object(c["f"])($,$,t),Object(c["g"])(W,W,$),m.projectToRenderScreen(W,Y)}else if(Y[2]>0&&K[2]<0){Object(c["k"])($,Z,W);const e=m.frustum,t=-d["f"].signedDistance(e[4],Z)/Object(c["i"])($,d["f"].normal(e[4]));Object(c["f"])($,$,t),Object(c["g"])(Z,Z,$),m.projectToRenderScreen(Z,K)}else if(Y[2]<0&&K[2]<0)continue;Y[2]=0,K[2]=0;const t=d["e"].distance2(d["e"].fromPoints(Y,K,te),b);t<v&&(v=t,Object(c["l"])(J,W),Object(c["l"])(ee,Z))}const O=r.rayBeginPoint,_=r.rayEndPoint;if(v<g*g){let e=Number.MAX_VALUE;if(d["e"].closestLineSegmentPoint(d["e"].fromPoints(J,ee,te),d["e"].fromPoints(O,_,ie),Q)){Object(c["k"])(Q,Q,O);const t=Object(c["q"])(Q);Object(c["f"])(Q,Q,1/t),e=t/Object(c["p"])(O,_)}s(e,Q)}}computeAttachmentOrigin(e,t){const i=e.vertexAttributes;if(!i)return null;const r=e.indices,a=i.get("position");return Object(p["a"])(a,r?r.get("position"):null,r&&B(this.params,i,r),t)}createLayout(){const e=Object(h["a"])().vec3f("position").f32("subdivisionFactor").vec2f("uv0").vec3f("auxpos1").vec3f("auxpos2");return this.params.vvSizeEnabled?e.f32("sizeFeatureAttribute"):e.f32("size"),this.params.vvColorEnabled?e.f32("colorFeatureAttribute"):e.vec4f("color"),this.params.vvOpacityEnabled&&e.f32("opacityFeatureAttribute"),e}createBufferWriter(){return new U(this.layout,this.params)}getGLMaterial(e){return 0===e.output||7===e.output||4===e.output||1===e.output?new F(e):void 0}validateParameterValues(e){"miter"!==e.join&&(e.miterLimit=0),this.requiresTransparent(e)&&(e.transparent=!0)}requiresTransparent(e){return!!((e.color&&e.color[3])<1||e.innerWidth>0&&this.colorRequiresTransparent(e.innerColor)||e.stipplePattern&&this.colorRequiresTransparent(e.stippleOffColor)||e.falloff>0)}colorRequiresTransparent(e){return Object(r["k"])(e)&&e[3]<1&&e[3]>0}}class F extends m["a"]{constructor(e){super(e),this.updateParameters()}updateParameters(e){this.technique=this.techniqueRep.acquireAndReleaseExisting(D,this.material.getTechniqueConfig(this.output,e),this.technique)}beginSlot(e){return this.technique.configuration.occluder?3===e||10===e||11===e:0===this.output||7===this.output?(this.targetSlot=this.technique.configuration.writeDepth?5:8,e===this.targetSlot):3===e}_updateOccludeeState(e){e.hasOccludees!==this.material.params.sceneHasOcludees&&this.material.setParameterValues({sceneHasOcludees:e.hasOccludees})}ensureParameters(e){0!==this.output&&7!==this.output||this._updateOccludeeState(e),this.updateParameters(e)}bind(e,t){e.bindProgram(this.technique.program),this.technique.bindPass(e,this.material.getPassParameters(),t)}getPipelineState(e,t){return this.technique.getPipelineState(e,t)}}const z={width:0,color:[1,1,1,1],join:"miter",cap:"butt",miterLimit:5,writeDepth:!0,polygonOffset:!1,stipplePattern:null,stippleIntegerRepeats:!1,stippleOffColor:null,slicePlaneEnabled:!1,vvFastUpdate:!1,transparent:!1,isClosed:!1,falloff:0,innerWidth:0,innerColor:null,sceneHasOcludees:!1,...b["b"],...g["a"].Default};class U{constructor(e,t){switch(this.params=t,this.numJoinSubdivisions=0,this.vertexBufferLayout=e,this.params.join){case"miter":case"bevel":this.numJoinSubdivisions=t.stipplePattern?1:0;break;case"round":this.numJoinSubdivisions=q}}isClosed(e){return B(this.params,e.vertexAttributes,e.indices)}numCapSubdivisions(e){if(this.isClosed(e))return 0;switch(this.params.cap){case"butt":return 0;case"square":return 1;case"round":return N}}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){const t=2*this.numCapSubdivisions(e)+2,i=e.indices.get("position").length/2+1,r=this.isClosed(e);let a=r?2:2*t;const n=r?0:1,s=r?i:i-1;if(e.vertexAttributes.has("subdivisions")){const t=e.vertexAttributes.get("subdivisions").data;for(let e=n;e<s;++e)a+=4+2*t[e]}else a+=(s-n)*(2*this.numJoinSubdivisions+4);return a+=2,a}write(e,t,i,r){const a=re,n=ae,s=ne,o=t.vertexAttributes.get("position").data,l=t.indices&&t.indices.get("position"),h=this.numCapSubdivisions(t);l&&l.length!==2*(o.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");let d=null;t.vertexAttributes.has("subdivisions")&&(d=t.vertexAttributes.get("subdivisions").data);let u=1,p=0;this.params.vvSizeEnabled?p=t.vertexAttributes.get("sizeFeatureAttribute").data[0]:t.vertexAttributes.has("size")&&(u=t.vertexAttributes.get("size").data[0]);let f=[1,1,1,1],m=0;this.params.vvColorEnabled?m=t.vertexAttributes.get("colorFeatureAttribute").data[0]:t.vertexAttributes.has("color")&&(f=t.vertexAttributes.get("color").data);let b=0;this.params.vvOpacityEnabled&&(b=t.vertexAttributes.get("opacityFeatureAttribute").data[0]);const g=o.length/3,v=e.transformation,y=new Float32Array(i.buffer),O=this.vertexBufferLayout.stride/4;let _=r*O;const x=_,j=(e,t,i,r,a,n,s)=>{if(y[_++]=t[0],y[_++]=t[1],y[_++]=t[2],y[_++]=r,y[_++]=a,y[_++]=n,y[_++]=e[0],y[_++]=e[1],y[_++]=e[2],y[_++]=i[0],y[_++]=i[1],y[_++]=i[2],this.params.vvSizeEnabled?y[_++]=p:y[_++]=u,this.params.vvColorEnabled)y[_++]=m;else{const e=Math.min(4*s,f.length-4);y[_++]=f[e+0],y[_++]=f[e+1],y[_++]=f[e+2],y[_++]=f[e+3]}this.params.vvOpacityEnabled&&(y[_++]=b)};_+=O,Object(c["x"])(n,o[0],o[1],o[2]),v&&Object(c["n"])(n,n,v);const w=this.isClosed(t);if(w){const e=o.length-3;Object(c["x"])(a,o[e],o[e+1],o[e+2]),v&&Object(c["n"])(a,a,v)}else{Object(c["l"])(a,n),Object(c["x"])(s,o[3],o[4],o[5]),v&&Object(c["n"])(s,s,v);for(let e=0;e<h;++e){const t=1-e/h;j(a,n,s,t,1,-4,0),j(a,n,s,t,1,4,0)}j(a,n,s,0,0,-4,0),j(a,n,s,0,0,4,0),Object(c["l"])(a,n),Object(c["l"])(n,s)}const S=w?g:g-1;for(let C=w?0:1;C<S;C++){const e=(C+1)%g*3;Object(c["x"])(s,o[e+0],o[e+1],o[e+2]),v&&Object(c["n"])(s,s,v),j(a,n,s,0,1,-1,C),j(a,n,s,0,1,1,C);const t=d?d[C]:this.numJoinSubdivisions;for(let i=0;i<t;++i){const e=(i+1)/(t+1);j(a,n,s,e,1,-2,C),j(a,n,s,e,1,2,C)}j(a,n,s,1,0,-2,C),j(a,n,s,1,0,2,C),Object(c["l"])(a,n),Object(c["l"])(n,s)}if(w)_=G(y,x+O,y,_,2*O);else{j(a,n,s,0,1,-5,S),j(a,n,s,0,1,5,S);for(let e=0;e<h;++e){const t=(e+1)/h;j(a,n,s,t,1,-5,S),j(a,n,s,t,1,5,S)}}G(y,x+O,y,x,O),_=G(y,_-O,y,_,O)}}function G(e,t,i,r,a){for(let n=0;n<a;n++)i[r++]=e[t++];return r}function B(e,t,i){return H(e,t.get("position").data,i?i.get("position"):null)}function H(e,t,i){return!!e.isClosed&&(i?i.length>2:t.length>6)}const N=3,q=1,W=Object(o["e"])(),Z=Object(o["e"])(),$=Object(o["e"])(),Q=Object(o["e"])(),X=Object(o["e"])(),Y=Object(s["e"])(),K=Object(s["e"])(),J=Object(o["e"])(),ee=Object(o["e"])(),te=d["e"].create(),ie=d["e"].create(),re=Object(o["e"])(),ae=Object(o["e"])(),ne=Object(o["e"])(),se=[Object(s["e"])(),Object(s["e"])(),Object(s["e"])(),Object(s["e"])()],oe=[Object(o["e"])(),Object(o["e"])(),Object(o["e"])(),Object(o["e"])()],ce=d["f"].create(),le=d["f"].create(),he=d["f"].create(),de=d["f"].create()},"89cb":function(e,t,i){"use strict";var r=i("e92d"),a=i("ce50"),n=i("008c");function s(e,t,i,a,n){const s=e.referencesGeometry()&&n?c(t,a,n):t,o=e.repurposeFeature(s);try{return e.evaluate({...i,$feature:o})}catch(l){return r["a"].getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",l),null}}const o=new Map;function c(e,t,i){const{transform:r,hasZ:a,hasM:n}=i;o.has(t)||o.set(t,l(t));const s=o.get(t)(e.geometry,r,a,n);return{...e,geometry:s}}function l(e){const t={};switch(e){case"esriGeometryPoint":return(e,i,r,a)=>Object(n["e"])(i,t,e,r,a);case"esriGeometryPolygon":return(e,i,r,a)=>Object(n["f"])(i,t,e,r,a);case"esriGeometryPolyline":return(e,i,r,a)=>Object(n["g"])(i,t,e,r,a);case"esriGeometryMultipoint":return(e,i,r,a)=>Object(n["d"])(i,t,e,r,a);default:return r["a"].getLogger("esri.views.2d.support.arcadeOnDemand").error(new a["a"]("mapview-arcade","Unable to handle geometryType: "+e)),e=>e}}t["a"]=s},"8b1a":function(e,t,i){"use strict";i.d(t,"a",(function(){return m}));var r=i("7f83"),a=i("4ae5"),n=(i("e06a"),i("0b2d")),s=i("e431"),o=i("02f1"),c=i("0fc4"),l=i("3349"),h=i("7577"),d=i("f091");class u{constructor(e,t){this.spatialReference=e,this.viewingMode=t,this._unnormalizationInfo=g(e,t)}tag(e){return e}createNew(){return this.tag(Object(o["b"])())}fromPoint(e){return this.tag(Object(o["f"])(e.x,e.y))}fromArray(e){return this.tag(Object(o["f"])(e[0],e[1]))}toArray(e){return[e[0],e[1]]}clone(e){return this.tag(Object(o["e"])(e))}toPoint(e,t){return t.x=e[0],t.y=e[1],t.hasZ=!1,t.hasM=!1,t.spatialReference=this.spatialReference,t}createPoint(e){return new a["a"]({x:e[0],y:e[1],z:void 0,m:void 0,spatialReference:this.spatialReference})}createPointFromArray(e){return new a["a"]({x:e[0],y:e[1],z:void 0,m:void 0,spatialReference:this.spatialReference})}createDehydratedPoint(e){return{x:e[0],y:e[1],z:void 0,m:void 0,hasZ:!1,hasM:!1,spatialReference:this.spatialReference,type:"point"}}lerp(e,t,i,r){return Object(l["m"])(r,e,t,i)}addDelta(e,t,i){e[0]+=t,e[1]+=i}scale(e,t,i,r){const a=d["c"].get(),n=Object(l["d"])(a,e,t),s=Object(l["a"])(a,i,Object(l["g"])(i,n));Object(l["p"])(e,e,s,r-1)}rotate(e,t,i){Object(l["r"])(e,e,t,i)}pointToArray(e){return[e.x,e.y]}getZ(e,t){return t}hasZ(){return!1}unnormalize(e){b(e,this._unnormalizationInfo)}fromXYZ(e){return this.tag(Object(o["f"])(e[0],e[1]))}toXYZ(e,t=0){return Object(n["g"])(e[0],e[1],t)}}class p{constructor(e,t,i){this.valueType=e,this.spatialReference=t,this._unnormalizationInfo=g(t,i)}tag(e){return e}createNew(){return this.tag(Object(n["e"])())}fromPoint(e){return this.tag(Object(n["g"])(e.x,e.y,0===this.valueType?e.z:e.m))}fromArray(e){return this.tag(Object(n["g"])(e[0],e[1],e[2]||0))}toArray(e){return[e[0],e[1],e[2]]}clone(e){return this.tag(Object(n["f"])(e))}toPoint(e,t){return t.x=e[0],t.y=e[1],0===this.valueType?(t.z=e[2],t.hasZ=!0,t.hasM=!1):(t.m=e[2],t.hasZ=!1,t.hasM=!0),t.spatialReference=this.spatialReference,t}createPoint(e){return new a["a"]({x:e[0],y:e[1],z:0===this.valueType?e[2]:void 0,m:1===this.valueType?e[2]:void 0,spatialReference:this.spatialReference})}createPointFromArray(e){return new a["a"]({x:e[0],y:e[1],z:0===this.valueType?e[2]:void 0,m:1===this.valueType?e[2]:void 0,spatialReference:this.spatialReference})}createDehydratedPoint(e){const t=0===this.valueType,i=1===this.valueType;return{x:e[0],y:e[1],z:t?e[2]:void 0,m:i?e[2]:void 0,hasZ:t,hasM:i,spatialReference:this.spatialReference,type:"point"}}lerp(e,t,i,r){return Object(s["j"])(r,e,t,i)}addDelta(e,t,i,r){e[0]+=t,e[1]+=i,0===this.valueType&&(e[2]+=r)}scale(e,t,i,r){const a=d["c"].get(),n=Object(l["d"])(a,e,t),s=Object(l["a"])(a,i,Object(l["g"])(i,n));Object(l["p"])(e,e,s,r-1)}rotate(e,t,i){Object(l["r"])(e,e,t,i)}pointToArray(e){return 0===this.valueType?[e.x,e.y,e.z]:[e.x,e.y,e.m]}getZ(e,t){return 0===this.valueType?e[2]:t}hasZ(){return 0===this.valueType}unnormalize(e){b(e,this._unnormalizationInfo)}fromXYZ(e,t=0,i=0){return this.tag(Object(n["g"])(e[0],e[1],0===this.valueType?e.length>2?e[2]:t:i))}toXYZ(e,t=0){return this.tag(Object(n["g"])(e[0],e[1],0===this.valueType?e[2]:t))}}class f{constructor(e,t){this.spatialReference=e,this._unnormalizationInfo=g(e,t)}tag(e){return e}createNew(){return this.tag(Object(c["c"])())}fromPoint(e){return this.tag(Object(c["d"])(e.x,e.y,e.z,e.m))}fromArray(e){return this.tag(Object(c["d"])(e[0],e[1],e[2]||0,e[3]||0))}toArray(e){return[e[0],e[1],e[2],e[3]]}clone(e){return this.tag(Object(c["g"])(e))}toPoint(e,t){return t.x=e[0],t.y=e[1],t.z=e[2],t.m=e[3],t.hasZ=!0,t.hasM=!0,t.spatialReference=this.spatialReference,t}createPoint(e){return new a["a"]({x:e[0],y:e[1],z:e[2],m:e[3],spatialReference:this.spatialReference})}createPointFromArray(e){return new a["a"]({x:e[0],y:e[1],z:e[2],m:e[3],spatialReference:this.spatialReference})}createDehydratedPoint(e){return{x:e[0],y:e[1],z:e[2],m:e[3],hasZ:!0,hasM:!0,spatialReference:this.spatialReference,type:"point"}}lerp(e,t,i,r){return Object(h["j"])(r,e,t,i)}addDelta(e,t,i,r){e[0]+=t,e[1]+=i,e[2]+=r}scale(e,t,i,r){const a=d["c"].get(),n=Object(l["d"])(a,e,t),s=Object(l["a"])(a,i,Object(l["g"])(i,n));Object(l["p"])(e,e,s,r-1)}rotate(e,t,i){Object(l["r"])(e,e,t,i)}pointToArray(e){return[e.x,e.y,e.z,e.m]}getZ(e){return e[2]}hasZ(){return!0}unnormalize(e){b(e,this._unnormalizationInfo)}fromXYZ(e,t=0,i=0){return this.tag(Object(c["d"])(e[0],e[1],e.length>2?e[2]:t,i))}toXYZ(e){return Object(n["g"])(e[0],e[1],e[2])}}function m(e,t,i,r){return e&&t?new f(i,r):t?new p(1,i,r):e?new p(0,i,r):new u(i,r)}function b(e,t){if(!t.supported)return;let i=1/0,r=-1/0;const a=t.upperBoundX-t.lowerBoundX;e.forEach(e=>{let n=e.pos[0];for(;n<t.lowerBoundX;)n+=a;for(;n>t.upperBoundX;)n-=a;i=Math.min(i,n),r=Math.max(r,n),e.pos[0]=n});const n=r-i;a-n<n&&e.forEach(e=>{e.pos[0]<0&&(e.pos[0]+=a)})}function g(e,t){const i=Object(r["d"])(e);return"global"===t&&i?{supported:!0,lowerBoundX:i.valid[0],upperBoundX:i.valid[1]}:{supported:!1,lowerBoundX:null,upperBoundX:null}}},"8b9d":function(e,t,i){"use strict";i.d(t,"a",(function(){return K})),i.d(t,"b",(function(){return k})),i.d(t,"c",(function(){return F})),i.d(t,"d",(function(){return J})),i.d(t,"e",(function(){return N})),i.d(t,"f",(function(){return U})),i.d(t,"g",(function(){return W})),i.d(t,"h",(function(){return z})),i.d(t,"i",(function(){return Q})),i.d(t,"j",(function(){return q})),i.d(t,"k",(function(){return $})),i.d(t,"l",(function(){return G})),i.d(t,"m",(function(){return B})),i.d(t,"n",(function(){return Z})),i.d(t,"o",(function(){return X})),i.d(t,"p",(function(){return ee})),i.d(t,"q",(function(){return Y})),i.d(t,"r",(function(){return D}));var r=i("b2b2"),a=i("f20e"),n=i("2650"),s=(i("173c"),i("3af9")),o=i("66b9"),c=i("d4de"),l=i("ce50"),h=i("0b2d"),d=i("e431"),u=i("9180"),p=i("ee83"),f=i("2ec5");const m=Object(h["e"])(),b=Object(h["e"])(),g=Object(h["e"])(),v=Object(h["e"])();function y(e,t,i=0){const r=e.extent;if(0===i)return Object(u["h"])(r,t);const a=Math.min(r[2]-r[0],r[3]-r[1]);return Object(u["j"])(r,t,i*a)}function O(e,t,i,r){Object(d["l"])(m,i),m[r]=t[r];const a=Object(d["k"])(m,m,t),n=Object(d["k"])(b,e,t),s=Object(d["i"])(n,a),o=Object(d["i"])(a,a);let c;c=s<=0?t:o<=s?i:Object(d["g"])(m,t,Object(d["f"])(a,a,s/o));const l=Object(d["k"])(m,e,c);return Math.PI/2-Math.atan(l[2]/Math.sqrt(l[0]*l[0]+l[1]*l[1]))}function _(e,t){const i=e.elevationBounds,r=e.extent,a=.5*(i.min+i.max);g[0]=r[0],g[1]=r[1],g[2]=a,v[0]=r[2],v[1]=r[3],v[2]=a;let n=1/0,s=1/0;return t[0]<g[0]?n=O(t,g,v,0):t[0]>v[0]&&(n=O(t,v,g,0)),t[1]<g[1]?s=O(t,g,v,1):t[1]>v[1]&&(s=O(t,v,g,1)),Math.min(n,s)}function x(e,t,i){if(e.spatialReference.isGeographic)return new l["a"]("tilingscheme:local-gcs-not-supported","Geographic coordinate systems are not supported in local scenes");const r=p["a"].checkUnsupported(e);if(r)return r;const a=j(e,i);return a||(t&&!e.spatialReference.equals(t)?new l["a"]("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the local scene"):null)}function j(e,t){const i=e.lods,r=i[0].resolution*2**i[0].level,a=[r*e.size[0],r*e.size[1]],n=[e.origin.x,e.origin.y],s=Object(u["s"])(t),o=Object(u["l"])();p["a"].computeRowColExtent(s,a,n,o);const c=(o[2]-o[0])*(o[3]-o[1]);if(c>f["j"]){const t=i[0].scale*2**i[0].level;let a=Math.max((s[3]-s[1])/e.size[1],(s[2]-s[0])/e.size[0])*t/r;const n=Math.floor(Math.log(a)/Math.log(10));return a=Math.ceil(a/10**n)*10**n,new l["a"]("tilingscheme:too-many-root-tiles","Scale of level 0 of the tiling scheme (1:"+Math.floor(t).toLocaleString()+") is too large for the layer's extent. Suggested scale: 1:"+a.toLocaleString()+".",{level0Scale:t,suggestedLevel0Scale:a,requiredNumRootTiles:c,allowedNumRootTiles:f["j"]})}return null}var w=Object.freeze({__proto__:null,isInsideExtent:y,tiltOnEdge:O,tiltToExtentEdge:_,checkIfTileInfoSupportedForViewSR:x}),S=i("7f83"),C=i("8188");function T(){return!0}function P(){return 0}function A(e,t){const i=e.lods.length-1,r=e.spatialReference,a=Object(C["a"])(r)||Object(S["h"])(r)||Object(S["i"])(r);if(r.isWebMercator){if(!p["a"].makeWebMercatorAuxiliarySphere(i).compatibleWith(e))return new l["a"]("tilingscheme:incompatible-global-web-mercator","The tiling scheme is not compatible with the ArcGIS Online Web Mercator tiling scheme")}else{if(!a)return new l["a"]("tilingscheme:global-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in global scenes");if(!p["a"].makeGCSWithTileSize(e.spatialReference,e.size[0],i).compatibleWith(e))return e.spatialReference.isWGS84?new l["a"]("tilingscheme:incompatible-global-wgs84","The tiling scheme is not compatible with the ArcGIS Online WGS84 tiling scheme"):new l["a"]("tilingscheme:incompatible-global","The tiling scheme is not compatible with the ArcGIS Online tiling scheme")}if(t&&!e.spatialReference.equals(t))return new l["a"]("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the global scene")}var R=Object.freeze({__proto__:null,isInsideExtent:T,tiltToExtentEdge:P,checkIfTileInfoSupportedForViewSR:A}),M=i("e746");const E={planar:w,spherical:R};function D(e,t){e||console.warn("Terrain: "+t)}const I=1.2,L=80/180*Math.PI,V=110/180*Math.PI;function k(e,t,i){const a=E[e.manifold];let n;if(a.isInsideExtent(e,t))n=Object(r["u"])(e.getElevation(t[0],t[1],t[1],e.spatialReference),0);else{if(!a.isInsideExtent(e,t,I))return 0;const i=a.tiltToExtentEdge(e,t);if(i>L&&i<V)return 0;const r=e.elevationBounds;n=.5*(r.min+r.max)}const s=t[2]-n;return Math.abs(s)<i?0:s<0?-1:1}function F(e){return U(e)?{fullExtent:e.fullExtent,minScale:e.layer.minScale,maxScale:e.layer.maxScale,tilemapCache:null}:e.layer}function z(e){return"imagery-tile"===e.type||"wcs"===e.type}function U(e){return e&&"esri.views.3d.layers.ImageryTileLayerView3D"===e.declaredClass}function G(e){return e&&"esri.views.3d.layers.TileLayerView3D"===e.declaredClass}function B(e){return e&&"esri.views.3d.layers.VectorTileLayerView3D"===e.declaredClass}function H(e){return e&&"esri.views.3d.layers.WMTSLayerView3D"===e.declaredClass}function N(e){return e&&"esri.views.3d.layers.ElevationLayerView3D"===e.declaredClass}function q(e){return e&&(G(e)||U(e)||N(e)||B(e)||H(e))}function W(e){return e&&e.sourceLayerInfo&&e.sourceLayerInfo.data instanceof c["a"]}function Z(e){return e&&e.sourceLayerInfo&&e.sourceLayerInfo.data instanceof o["a"]}function $(e){return e&&e.sourceLayerInfo&&e.sourceLayerInfo.data instanceof M["a"]}function Q(e){const t=e&&e.sourceLayerInfo&&e.sourceLayerInfo.data;return t instanceof HTMLImageElement||t instanceof s["a"]||t instanceof HTMLCanvasElement||t instanceof ImageData}function X(e){return Object(r["k"])(e)&&"release"in e&&e.release(),null}function Y(e){return e.fetchTile&&!(e.fetchTile===n["default"].prototype.fetchTile||e.fetchTile===a["default"].prototype.fetchTile)}function K(e,t,i,r){let a;return a=2===r||"planar"===r?"planar":"spherical",E[a].checkIfTileInfoSupportedForViewSR(e,i,t)}function J(e,t,i){let r,a;if("wmts"===e.type){const n=e.activeLayer;if(n){const e=n.tileMatrixSet;if(e)r=e.tileInfo,a=e.fullExtent;else{const e=n.tileMatrixSets;if(e){const r=e.find(e=>null==K(e.tileInfo,e.fullExtent,t,i));if(r)return{tileInfo:r.tileInfo,fullExtent:r.fullExtent}}}}}else a=z(e)?e.getCompatibleFullExtent(t):e.fullExtent,r="vector-tile"!==e.type||ee.force512VTL?z(e)?e.getCompatibleTileInfo(t,a):e.tileInfo:e.compatibleTileInfo256;return r&&a&&null==K(r,a,t,i)?{tileInfo:r,fullExtent:a}:{tileInfo:null,fullExtent:null}}const ee={force512VTL:!1}},"8c4b":function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i("38a4");function a(e,t,i){var a;const l=e.byteLength/(4*t),h=new Uint32Array(e,0,l*t);let d=new Uint32Array(l);const u=null!=(a=null==i?void 0:i.minReduction)?a:0,p=(null==i?void 0:i.originalIndices)||null,f=p?p.length:0,m=(null==i?void 0:i.componentOffsets)||null;let b=0;if(m)for(let r=0;r<m.length-1;r++){const e=m[r+1]-m[r];e>b&&(b=e)}else b=l;const g=Math.floor(1.1*b)+1;(null==c||c.length<2*g)&&(c=new Uint32Array(Object(r["o"])(2*g)));for(let r=0;r<2*g;r++)c[r]=0;let v=0;const y=!!m&&!!p,O=y?f:l,_=y?new Uint32Array(f):null,x=1.96;let j=0!==u?Math.ceil(4*x*x/(u*u)*u*(1-u)):O,w=1,S=m?m[1]:O;for(let r=0;r<O;r++){if(r===j){const e=1-v/r;if(e+x*Math.sqrt(e*(1-e)/r)<u)return null;j*=2}if(r===S){for(let e=0;e<2*g;e++)c[e]=0;if(p)for(let e=m[w-1];e<m[w];e++)_[e]=d[p[e]];S=m[++w]}const e=y?p[r]:r,i=e*t,a=o(h,i,t);let s=a%g,l=v;for(;0!==c[2*s+1];){if(c[2*s]===a){const e=c[2*s+1]-1;if(n(h,i,e*t,t)){l=d[e];break}}s++,s>=g&&(s-=g)}l===v&&(c[2*s]=a,c[2*s+1]=e+1,v++),d[e]=l}if(0!==u&&1-v/l<u)return null;if(y){for(let e=m[w-1];e<_.length;e++)_[e]=d[p[e]];d=_}const C=new Uint32Array(t*v);v=0;for(let r=0;r<O;r++)d[r]===v&&(s(h,(y?p[r]:r)*t,C,v*t,t),v++);if(p&&!y){const e=new Uint32Array(f);for(let t=0;t<e.length;t++)e[t]=d[p[t]];d=e}return{buffer:C.buffer,indices:d,uniqueCount:v}}function n(e,t,i,r){for(let a=0;a<r;a++)if(e[t+a]!==e[i+a])return!1;return!0}function s(e,t,i,r,a){for(let n=0;n<a;n++)i[r+n]=e[t+n]}function o(e,t,i){let r=0;for(let a=0;a<i;a++)r=e[t+a]+r|0,r=r+(r<<11)+(r>>>2)|0;return r>>>0}let c=null},"8c81":function(e,t,i){"use strict";i.d(t,"a",(function(){return x})),i.d(t,"b",(function(){return j})),i.d(t,"c",(function(){return h})),i.d(t,"d",(function(){return V})),i.d(t,"e",(function(){return c})),i.d(t,"f",(function(){return I})),i.d(t,"g",(function(){return s})),i.d(t,"h",(function(){return T})),i.d(t,"i",(function(){return C})),i.d(t,"j",(function(){return S})),i.d(t,"k",(function(){return A})),i.d(t,"l",(function(){return o})),i.d(t,"m",(function(){return w})),i.d(t,"n",(function(){return r})),i.d(t,"o",(function(){return L})),i.d(t,"p",(function(){return a})),i.d(t,"q",(function(){return D})),i.d(t,"r",(function(){return f})),i.d(t,"s",(function(){return m})),i.d(t,"t",(function(){return b})),i.d(t,"u",(function(){return g})),i.d(t,"v",(function(){return p})),i.d(t,"w",(function(){return u})),i.d(t,"x",(function(){return v})),i.d(t,"y",(function(){return y})),i.d(t,"z",(function(){return O})),i.d(t,"A",(function(){return _})),i.d(t,"B",(function(){return d})),i.d(t,"C",(function(){return l})),i.d(t,"D",(function(){return P})),i.d(t,"E",(function(){return n})),i.d(t,"F",(function(){return E})),i.d(t,"G",(function(){return M})),i.d(t,"H",(function(){return R}));const r=1e-30,a=4294967295,n=512,s=8,o=29,c=16,l=8,h={metrics:{width:15,height:17,left:0,top:-7,advance:14}},d=0,u=0,p=0,f=1,m=2,b=3,g=4,v=5,y=6,O=5,_=6,x=1,j=2,w=2,S=1,C=2,T=4,P=2.5,A=6,R=5,M=6,E=1.15,D=2,I=7,L=500,V=128},"8e6f":function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));var r=i("b33e"),a=i("55f0");class n extends r["a"]{constructor(e,t,i){super(e,t,i)}value(e){const t=super.value(e);return Math.exp(t)}valueDelta(e,t){const i=super.value(e),r=super.value(e+t)-i;return Math.exp(r)}}class s extends a["a"]{constructor(e=2.5,t=.01,i=.95,r=12){super(e,t,i,r)}add(e,t){super.add(Math.log(e),t)}createMomentum(e,t,i){return new n(e,t,i)}}},"8f1c":function(e,t,i){"use strict";i.d(t,"a",(function(){return m}));i("c120");var r=i("b2b2"),a=i("0b2d"),n=i("e431"),s=i("af40"),o=i("7577"),c=i("5ef2"),l=i("19b9"),h=i("d0ac"),d=i("caf7"),u=i("86ba"),p=i("647b"),f=i("5fae");class m extends f["a"]{constructor(e){super(e),this._ray=h["g"].create(),this._externalResources=null,this._handles=new s["a"],this._isWorldDown=!1,this._start=Object(a["e"])(),this._end=Object(a["g"])(1,0,0),this._width=1,this._color=Object(c["c"])(1,0,1,1),this._polygonOffset=!1,this._writeDepthEnabled=!0,this._innerWidth=0,this._innerColor=Object(c["c"])(1,1,1,1),this._stippleIntegerRepeats=!0,this._stipplePattern=null,this._stippleOffColor=null,this._falloff=0,this._extensionType=0,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=4,this._fadedExtensions=_,this.applyProps(e)}createExternalResources(){const e=new u["a"](this.materialParameters);this._handles.add(this.view.state.watch("camera",()=>{this.updateGeometry()}));const t=new p["a"]({view:this.view,attached:this._laserlineEnabled});this._externalResources={material:e,laserline:t}}destroyExternalResources(){Object(r["k"])(this._externalResources)&&this._externalResources.laserline.destroy(),this._externalResources=null,this._handles.removeAll()}forEachExternalMaterial(e){Object(r["k"])(this._externalResources)&&e(this._externalResources.material)}createGeometries(e){const t=[Object(a["e"])(),Object(a["e"])()],i=3===this.extensionType;i&&t.push(Object(a["e"])(),Object(a["e"])());const n=i?new Float32Array([1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0]):null,s=d["a"].createPolylineGeometry(t,null,n);e.addGeometry(s,Object(r["t"])(this._externalResources).material),this.updateVertices(s)}updateVisibility(e){super.updateVisibility(e),Object(r["k"])(this._externalResources)&&(this._externalResources.laserline.visible=e)}setStartEndFromWorldDownAtLocation(e){this._isWorldDown=!0,Object(n["l"])(this._start,e),this.view.renderCoordsHelper.worldUpAtPosition(e,this._end),Object(n["k"])(this._end,e,this._end),h["g"].fromPoints(this._start,this._end,this._ray),this.updateGeometry()}get start(){return this._start}set start(e){this._isWorldDown=!1,Object(n["r"])(this._start,e)||(Object(n["l"])(this._start,e),h["g"].fromPoints(this._start,this._end,this._ray),this.updateGeometry())}get end(){return this._end}set end(e){this._isWorldDown=!1,Object(n["r"])(this._end,e)||(Object(n["l"])(this._end,e),h["g"].fromPoints(this._start,this._end,this._ray),this.updateGeometry())}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this.updateMaterial())}get color(){return this._color}set color(e){Object(o["g"])(e,this._color)||(Object(o["c"])(this._color,e),this.updateMaterial())}get polygonOffset(){return this._polygonOffset}set polygonOffset(e){e!==this._polygonOffset&&(this._polygonOffset=e,this.updateMaterial())}get writeDepthEnabled(){return this._writeDepthEnabled}set writeDepthEnabled(e){this._writeDepthEnabled!==e&&(this._writeDepthEnabled=e,this.updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this.updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){Object(o["g"])(e,this._innerColor)||(Object(o["c"])(this._innerColor,e),this.updateMaterial())}get stippleIntegerRepeats(){return this._stippleIntegerRepeats}set stippleIntegerRepeats(e){e!==this._stippleIntegerRepeats&&(this._stippleIntegerRepeats=e,this.updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){const t=Object(r["k"])(e)!==Object(r["k"])(this._stipplePattern);this._stipplePattern=e,t?this.recreate():this.updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){(Object(r["j"])(e)||Object(r["j"])(this._stippleOffColor)||!Object(o["g"])(e,this._stippleOffColor))&&(this._stippleOffColor=Object(r["k"])(e)?Object(c["a"])(e):null,this.updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this.updateMaterial())}get extensionType(){return this._extensionType}set extensionType(e){e!==this._extensionType&&(this._extensionType=e,this.updateGeometry())}get _laserlineAttached(){return this._laserlineEnabled&&Object(r["k"])(this._laserlineStyle)}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,Object(r["k"])(this._externalResources)&&(this._externalResources.laserline.attached=this._laserlineAttached,Object(r["k"])(e)&&(this._externalResources.laserline.style=e))}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,Object(r["k"])(this._externalResources)&&(this._externalResources.laserline.attached=this._laserlineAttached))}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this.updateMaterial())}get fadedExtensions(){return this._fadedExtensions}set fadedExtensions(e){this._fadedExtensions=Object(r["u"])(e,_),this.recreateGeometry()}updateMaterial(){Object(r["j"])(this._externalResources)||this._externalResources.material.setParameterValues(this.materialParameters)}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stippleIntegerRepeats:this._stippleIntegerRepeats,innerWidth:this._innerWidth,innerColor:this._innerColor,falloff:this._falloff,polygonOffset:this._polygonOffset,renderOccluded:this._renderOccluded,writeDepth:this._writeDepthEnabled}}updateGeometry(){Object(r["k"])(this.object)&&this.updateVertices(this.object.geometries[0])}updateVertices(e){const t=3===this._extensionType?this.updateLineSegmentFinite(y):this.updateLineSegmentInfinite(this._extensionType,y);this.updateVertexAttributes(e,t),Object(r["k"])(this._externalResources)&&(this._externalResources.laserline.intersectsLine=t)}updateLineSegmentFinite(e){return h["e"].fromPoints(this._start,this._end,e)}updateLineSegmentInfinite(e,t){const i=this.view.state.camera;switch(Object(l["e"])(this._ray,b),e){case 0:b.c0=-Number.MAX_VALUE;break;case 1:case 2:{const e=this._ray.origin,t=Object(r["u"])(this.view.elevationProvider.getElevation(e[0],e[1],e[2],this.view.renderCoordsHelper.spatialReference,"ground"),0),i=this.view.renderCoordsHelper.getAltitude(e);this._isWorldDown&&i<t&&Object(n["u"])(b.ray.direction,b.ray.direction),2===this._extensionType&&null!=t&&(b.c1=Math.abs(i-t));break}}if(!h["d"].intersectClipRay(i.frustum,b))return h["e"].fromPoints(this._start,this._end,t);const a=Object(l["f"])(b,g),s=Object(l["d"])(b,v);return h["e"].fromPoints(a,s,t)}updateVertexAttributes(e,t){const i=e.getMutableAttribute("position").data;if(3===this.extensionType){const e=h["e"].pointAt(t,-this.fadedExtensions.start,g);i[0]=e[0],i[1]=e[1],i[2]=e[2];const r=h["e"].pointAt(t,0,g);i[3]=r[0],i[4]=r[1],i[5]=r[2];const a=h["e"].pointAt(t,1,g);i[6]=a[0],i[7]=a[1],i[8]=a[2];const n=h["e"].pointAt(t,1+this.fadedExtensions.end,g);i[9]=n[0],i[10]=n[1],i[11]=n[2]}else{const e=h["e"].pointAt(t,0,g);i[0]=e[0],i[1]=e[1],i[2]=e[2];const r=h["e"].pointAt(t,1,g);i[3]=r[0],i[4]=r[1],i[5]=r[2]}Object(r["k"])(this.object)&&this.object.geometryVertexAttrsUpdated(0)}}const b=Object(l["b"])(),g=Object(a["e"])(),v=Object(a["e"])(),y=h["e"].create(),O=1/3,_={start:O,end:O}},"901e":function(e,t,i){"use strict";var r=i("229e");class a{constructor(e,t){if(this.backgroundBucketIds=[],this._uidToLayer=new Map,this._layerByName={},this._runningId=0,e.layers||(e.layers=[]),this.version=parseFloat(e.version),this.sprite=t?t.spriteUrl:e.sprite,this.glyphs=t?t.glyphsUrl:e.glyphs,this.layers=e.layers.map((e,t,i)=>this._create(e,t,i)),this.layers){let e;for(let t=0;t<this.layers.length;t++)e=this.layers[t],this._layerByName[e.id.toLowerCase()]=e,this._uidToLayer.set(e.uid,e),0===e.type&&this.backgroundBucketIds.push(e.id)}this._identifyRefLayers()}isPainterDataDriven(e){const t=this._layerByName[e.toLowerCase()];return!!t&&t.isPainterDataDriven()}getStyleLayerId(e){return e>=this.layers.length?null:this.layers[e].id}getStyleLayerByUID(e){const t=this._uidToLayer.get(e);return null!=t?t:null}getStyleLayerIndex(e){const t=this._layerByName[e.toLowerCase()];return t?this.layers.indexOf(t):-1}setStyleLayer(e,t){if(!e||!e.id)return;t&&t>=this.layers.length&&(t=this.layers.length-1);let i,r=!0;const n=this._layerByName[e.id.toLowerCase()];if(n){const s=this.layers.indexOf(n);t||(t=s),t===s?(r=!1,i=a._recreateLayer(e,n),this.layers[t]=i):(this.layers.splice(s,1),i=this._create(e,t,this.layers),this.layers.splice(t,0,i))}else i=this._create(e,t,this.layers),!t||t>=this.layers.length?this.layers.push(i):this.layers.splice(t,0,i);this._layerByName[e.id.toLowerCase()]=i,this._uidToLayer.set(i.uid,i),r&&this._recomputeZValues(),this._identifyRefLayers()}getStyleLayer(e){const t=this._layerByName[e.toLowerCase()];return t?{type:t.typeName,id:t.id,source:t.source,"source-layer":t.sourceLayer,minzoom:t.minzoom,maxzoom:t.maxzoom,filter:t.filter,layout:t.layout,paint:t.paint}:null}deleteStyleLayer(e){const t=this._layerByName[e.toLowerCase()];if(t){delete this._layerByName[e.toLowerCase()],this._uidToLayer.delete(t.uid);const i=this.layers.indexOf(t);this.layers.splice(i,1),this._recomputeZValues(),this._identifyRefLayers()}}getLayerById(e){return this._layerByName[e.toLowerCase()]}getLayoutProperties(e){const t=this._layerByName[e.toLowerCase()];return t?t.layout:null}getPaintProperties(e){const t=this._layerByName[e.toLowerCase()];return t?t.paint:null}setPaintProperties(e,t){const i=this._layerByName[e.toLowerCase()];if(!i)return"";const r={type:i.typeName,id:i.id,source:i.source,"source-layer":i.sourceLayer,minzoom:i.minzoom,maxzoom:i.maxzoom,filter:i.filter,layout:i.layout,paint:t},n=a._recreateLayer(r,i),s=this.layers.indexOf(i);return this.layers[s]=n,this._layerByName[i.id.toLowerCase()]=n,this._uidToLayer.set(i.uid,n),i.id}setLayoutProperties(e,t){const i=this._layerByName[e.toLowerCase()];if(!i)return"";const r={type:i.typeName,id:i.id,source:i.source,"source-layer":i.sourceLayer,minzoom:i.minzoom,maxzoom:i.maxzoom,filter:i.filter,layout:t,paint:i.paint},n=a._recreateLayer(r,i),s=this.layers.indexOf(i);return this.layers[s]=n,this._layerByName[i.id.toLowerCase()]=n,this._uidToLayer.set(i.uid,n),i.id}setStyleLayerVisibility(e,t){const i=this._layerByName[e.toLowerCase()];if(!i)return;const r=i.layout||{};r.visibility=t;const n={type:i.typeName,id:i.id,source:i.source,"source-layer":i.sourceLayer,minzoom:i.minzoom,maxzoom:i.maxzoom,filter:i.filter,layout:r,paint:i.paint},s=a._recreateLayer(n,i),o=this.layers.indexOf(i);this.layers[o]=s,this._layerByName[i.id.toLowerCase()]=s,this._uidToLayer.set(i.uid,s)}getStyleLayerVisibility(e){var t;const i=this._layerByName[e.toLowerCase()];if(!i)return"none";const r=i.layout;return null!=(t=null==r?void 0:r.visibility)?t:"visible"}_recomputeZValues(){const e=this.layers,t=1/(e.length+1);for(let i=0;i<e.length;i++)e[i].z=1-(1+i)*t}_identifyRefLayers(){const e=[],t=[];let i=0;for(const r of this.layers){if(1===r.type){const t=r;let a=r.source+"|"+r.sourceLayer;a+="|"+JSON.stringify(r.layout&&r.layout.visibility),a+="|"+JSON.stringify(r.minzoom),a+="|"+JSON.stringify(r.maxzoom),a+="|"+JSON.stringify(r.filter),(t.hasDataDrivenFill||t.hasDataDrivenOutline)&&(a+="|"+JSON.stringify(i)),e.push({key:a,layer:r})}if(2===r.type){const e=r;let a=r.source+"|"+r.sourceLayer;a+="|"+JSON.stringify(r.layout&&r.layout.visibility),a+="|"+JSON.stringify(r.minzoom),a+="|"+JSON.stringify(r.maxzoom),a+="|"+JSON.stringify(r.filter),a+="|"+JSON.stringify(r.layout&&r.layout["line-cap"]),a+="|"+JSON.stringify(r.layout&&r.layout["line-join"]),e.hasDataDrivenLine&&(a+="|"+JSON.stringify(i)),t.push({key:a,layer:r})}++i}this._assignRefLayers(e),this._assignRefLayers(t)}_assignRefLayers(e){let t,i;e.sort((e,t)=>e.key<t.key?-1:e.key>t.key?1:0);const r=e.length;for(let a=0;a<r;a++){const n=e[a];if(n.key===t)n.layer.refLayerId=i;else if(t=n.key,i=n.layer.id,1===n.layer.type&&!n.layer.getPaintProperty("fill-outline-color"))for(let s=a+1;s<r;s++){const r=e[s];if(r.key!==t)break;if(r.layer.getPaintProperty("fill-outline-color")){e[a]=r,e[s]=n,i=r.layer.id;break}}}}_create(e,t,i){const a=1-(1+t)*(1/(i.length+1)),n=this._runningId++;switch(e.type){case"background":return new r["a"](0,e,a,n);case"fill":return new r["c"](1,e,a,n);case"line":return new r["e"](2,e,a,n);case"symbol":return new r["f"](3,e,a,n);case"raster":throw new Error("Unsupported vector tile raster layer");case"circle":return new r["b"](4,e,a,n)}throw new Error("Unknown vector tile layer")}static _recreateLayer(e,t){switch(e.type){case"background":return new r["a"](0,e,t.z,t.uid);case"fill":return new r["c"](1,e,t.z,t.uid);case"line":return new r["e"](2,e,t.z,t.uid);case"symbol":return new r["f"](3,e,t.z,t.uid);case"raster":throw new Error("Unsupported vector tile raster layer");case"circle":return new r["b"](4,e,t.z,t.uid)}}}t["a"]=a},9250:function(e,t,i){"use strict";i.d(t,"a",(function(){return d}));i("c120");var r=i("b2b2"),a=i("0b2d"),n=i("e431"),s=i("afe1"),o=i("d0ac"),c=i("b623"),l=i("a978");const h=1e-5;class d{constructor(e){this.options=new l["a"],this.results=new l["c"],this.transform=new l["d"],this.performanceInfo={queryDuration:0,numObjectsTested:0},this.tolerance=h,this.verticalOffset=null,this._ray={origin:Object(a["e"])(),direction:Object(a["e"])()},this._rayEndPoint=Object(a["e"])(),this._rayStartPointTransformed=Object(a["e"])(),this._rayEndPointTransformed=Object(a["e"])(),this.viewingMode=null==e?1:e}get ray(){return this._ray}get rayBeginPoint(){return this._ray.origin}get rayEndPoint(){return this._rayEndPoint}reset(e,t){this.resetWithRay(o["g"].fromPoints(e,t,this._ray))}resetWithRay(e){e!==this._ray&&o["g"].copy(e,this._ray),0!==this.options.verticalOffset?2===this.viewingMode?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,Object(n["g"])(this._rayEndPoint,this._ray.origin,this._ray.direction),this._numObjectsTested=0,this.results.init(this._ray)}intersect(e,t,i,a,n,s){this.point=t,this.camera=i,this.filterPredicate=n,this.tolerance=null==a?h:a;const o=Object(l["g"])(this.verticalOffset),c=s?e=>{s(e)&&this.intersectObject(e)}:e=>{this.intersectObject(e)};if(e&&e.length>0)for(const l of e){const e=l.getSpatialQueryAccelerator&&l.getSpatialQueryAccelerator();Object(r["k"])(e)?(Object(r["k"])(o)?e.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,c,o):e.forEachAlongRay(this._ray.origin,this._ray.direction,c),this.options.selectionMode&&this.options.hud&&e.forEachDegenerateObject(c)):l.getObjects().forAll(e=>c(e))}this.sortResults()}intersectObject(e){this._numObjectsTested++;const t=e.geometryRecords;if(!t)return;const i=e.id,a=e.transformation;let o;const h=Object(l["g"])(this.verticalOffset);for(const d of t){const{geometry:t,material:u,instanceParameters:p}=d;if(Object(c["e"])(p))continue;o=t.id,this.transform.setAndInvalidateLazyTransforms(a,d.getShaderTransformation()),Object(n["n"])(this._rayStartPointTransformed,this._ray.origin,this.transform.inverse),Object(n["n"])(this._rayEndPointTransformed,this._rayEndPoint,this.transform.inverse);const f=this.transform.transform;Object(r["k"])(h)&&(h.objectTransform=this.transform),u.intersect(t,p,this.transform.transform,this,this._rayStartPointTransformed,this._rayEndPointTransformed,(t,a,n,c,h,d)=>{if(t>=0){if(Object(r["k"])(this.filterPredicate)&&!this.filterPredicate(this._ray.origin,this._rayEndPoint,t))return;const u="Object3D "+i;if(h)return void((null==this.results.hud.dist||t<this.results.hud.dist)&&this.results.hud.set(e,u,t,a,s["a"],c,d,o,n));const p=i=>i.set(e,u,t,a,f,c,null,o,n);if((null==this.results.min.drapedLayerOrder||c>=this.results.min.drapedLayerOrder)&&(null==this.results.min.dist||t<this.results.min.dist)&&p(this.results.min),0!==this.options.store&&(null==this.results.max.drapedLayerOrder||c<this.results.max.drapedLayerOrder)&&(null==this.results.max.dist||t>this.results.max.dist)&&p(this.results.max),2===this.options.store){const e=new l["b"](this._ray);p(e),this.results.all.push(e)}}},d.shaderTransformation)}}sortResults(){this.results.all.sort((e,t)=>e.dist!==t.dist?e.dist-t.dist:e.drapedLayerOrder!==t.drapedLayerOrder?(void 0!==e.drapedLayerOrder?e.drapedLayerOrder:Number.MAX_VALUE)-(void 0!==t.drapedLayerOrder?t.drapedLayerOrder:Number.MAX_VALUE):(void 0!==t.drapedLayerGraphicOrder?t.drapedLayerGraphicOrder:Number.MIN_VALUE)-(void 0!==e.drapedLayerGraphicOrder?e.drapedLayerGraphicOrder:Number.MIN_VALUE))}}d.DEFAULT_TOLERANCE=h},"92af":function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i("df3b");class a extends r["a"]{constructor({coordinateHelper:e,targetPoint:t,objectId:i,constraint:r}){super(e,t,r),this.objectId=i}}},"94a6":function(e,t,i){"use strict";i.r(t),i.d(t,"fetch",(function(){return z})),i.d(t,"gltfToEngineResources",(function(){return G})),i.d(t,"parseUrl",(function(){return U}));var r=i("b2b2"),a=i("0b2d"),n=i("e431"),s=i("d791"),o=i("49b8"),c=i("dae5"),l=i("afe1"),h=i("1c92"),d=i("55e6"),u=i("668b"),p=i("4261"),f=i("0278"),m=i("dbad"),b=i("1e2c"),g=i("2b60"),v=i("82b9");function y(e,t,i){const r=e.typedBuffer,a=e.typedBufferStride,n=t.typedBuffer,s=t.typedBufferStride,o=i?i.count:t.count;let c=(i&&i.dstIndex?i.dstIndex:0)*a,l=(i&&i.srcIndex?i.srcIndex:0)*s;for(let h=0;h<o;++h)r[c]=n[l],r[c+1]=n[l+1],c+=a,l+=s}function O(e,t,i){const r=e.typedBuffer,a=e.typedBufferStride,n=t.typedBuffer,s=t.typedBufferStride,o=i?i.count:t.count;let c=(i&&i.dstIndex?i.dstIndex:0)*a,l=(i&&i.srcIndex?i.srcIndex:0)*s;if(Object(v["b"])(t.elementType)){const e=Object(v["d"])(t.elementType);if(Object(v["c"])(t.elementType))for(let t=0;t<o;++t)r[c]=Math.max(n[l]/e,-1),r[c+1]=Math.max(n[l+1]/e,-1),c+=a,l+=s;else for(let t=0;t<o;++t)r[c]=n[l]/e,r[c+1]=n[l+1]/e,c+=a,l+=s}else y(e,t,i);return e}Object.freeze({__proto__:null,copy:y,normalizeIntegerBuffer:O});var _=i("4c96");function x(e,t,i){const r=e.typedBuffer,a=e.typedBufferStride,n=t.typedBuffer,s=t.typedBufferStride,o=i?i.count:t.count;let c=(i&&i.dstIndex?i.dstIndex:0)*a,l=(i&&i.srcIndex?i.srcIndex:0)*s;for(let h=0;h<o;++h)r[c]=n[l],r[c+1]=n[l+1],r[c+2]=n[l+2],r[c+3]=n[l+3],c+=a,l+=s}function j(e,t,i,r,a,n){const s=e.typedBuffer,o=e.typedBufferStride,c=n?n.count:e.count;let l=(n&&n.dstIndex?n.dstIndex:0)*o;for(let h=0;h<c;++h)s[l]=t,s[l+1]=i,s[l+2]=r,s[l+3]=a,l+=o}Object.freeze({__proto__:null,copy:x,fill:j});function w(e,t,i){const r=e.typedBuffer,a=e.typedBufferStride,n=t.typedBuffer,s=t.typedBufferStride,o=i?i.count:t.count;let c=(i&&i.dstIndex?i.dstIndex:0)*a,l=(i&&i.srcIndex?i.srcIndex:0)*s;for(let h=0;h<o;++h){for(let e=0;e<9;++e)r[c+e]=n[l+e];c+=a,l+=s}}Object.freeze({__proto__:null,copy:w});function S(e,t,i){const r=e.typedBuffer,a=e.typedBufferStride,n=t.typedBuffer,s=t.typedBufferStride,o=i?i.count:t.count;let c=(i&&i.dstIndex?i.dstIndex:0)*a,l=(i&&i.srcIndex?i.srcIndex:0)*s;for(let h=0;h<o;++h){for(let e=0;e<16;++e)r[c+e]=n[l+e];c+=a,l+=s}}Object.freeze({__proto__:null,copy:S}),i("7cfb");function C(e,t){return new e(new ArrayBuffer(t*e.ElementCount*Object(v["a"])(e.ElementType)))}var T=i("3c3b"),P=i("a21b"),A=i("1038");function R(e){return"number"==typeof e?Object(A["d"])(e):Object(P["i"])(e)||Object(P["k"])(e)?new Uint32Array(e):e}function M(e){const t="number"==typeof e?e:e.length;if(t<3)return new Uint16Array(0);const i=t-2,r=i<=65536?new Uint16Array(3*i):new Uint32Array(3*i);if("number"==typeof e){let e=0;for(let t=0;t<i;t+=1)t%2==0?(r[e++]=t,r[e++]=t+1,r[e++]=t+2):(r[e++]=t+1,r[e++]=t,r[e++]=t+2)}else{let t=0;for(let a=0;a<i;a+=1)if(a%2==0){const i=e[a],n=e[a+1],s=e[a+2];r[t++]=i,r[t++]=n,r[t++]=s}else{const i=e[a+1],n=e[a],s=e[a+2];r[t++]=i,r[t++]=n,r[t++]=s}}return r}function E(e){const t="number"==typeof e?e:e.length;if(t<3)return new Uint16Array(0);const i=t-2,r=i<=65536?new Uint16Array(3*i):new Uint32Array(3*i);if("number"==typeof e){let e=0;for(let t=0;t<i;++t)r[e++]=0,r[e++]=t+1,r[e++]=t+2;return r}{const t=e[0];let a=e[1],n=0;for(let s=0;s<i;++s){const i=e[s+2];r[n++]=t,r[n++]=a,r[n++]=i,a=i}return r}}var D=i("22f5"),I=i("da6c");function L(e,t,i){if(e.count!==t.count)return void I["a"].error("source and destination buffers need to have the same number of elements");const r=e.count,a=i[0],n=i[1],s=i[2],o=i[3],c=i[4],l=i[5],h=i[6],d=i[7],u=i[8],p=i[9],f=i[10],m=i[11],b=i[12],g=i[13],v=i[14],y=i[15],O=e.typedBuffer,_=e.typedBufferStride,x=t.typedBuffer,j=t.typedBufferStride;for(let w=0;w<r;w++){const e=w*_,t=w*j,i=x[t],r=x[t+1],S=x[t+2],C=x[t+3];O[e]=a*i+c*r+u*S+b*C,O[e+1]=n*i+l*r+p*S+g*C,O[e+2]=s*i+h*r+f*S+v*C,O[e+3]=o*i+d*r+m*S+y*C}}function V(e,t,i){if(e.count!==t.count)return void I["a"].error("source and destination buffers need to have the same number of elements");const r=e.count,a=i[0],n=i[1],s=i[2],o=i[3],c=i[4],l=i[5],h=i[6],d=i[7],u=i[8],p=e.typedBuffer,f=e.typedBufferStride,m=t.typedBuffer,b=t.typedBufferStride;for(let g=0;g<r;g++){const e=g*f,t=g*b,i=m[t],r=m[t+1],v=m[t+2],y=m[t+3];p[e]=a*i+o*r+h*v,p[e+1]=n*i+c*r+d*v,p[e+2]=s*i+l*r+u*v,p[e+3]=y}}function k(e,t,i){const r=Math.min(e.count,t.count),a=e.typedBuffer,n=e.typedBufferStride,s=t.typedBuffer,o=t.typedBufferStride;for(let c=0;c<r;c++){const e=c*n,t=c*o;a[e]=i*s[t],a[e+1]=i*s[t+1],a[e+2]=i*s[t+2],a[e+3]=i*s[t+3]}}function F(e,t,i){const r=Math.min(e.count,t.count),a=e.typedBuffer,n=e.typedBufferStride,s=t.typedBuffer,o=t.typedBufferStride;for(let c=0;c<r;c++){const e=c*n,t=c*o;a[e]=s[t]>>i,a[e+1]=s[t+1]>>i,a[e+2]=s[t+2]>>i,a[e+3]=s[t+3]>>i}}Object.freeze({__proto__:null,transformMat4:L,transformMat3:V,scale:k,shiftRight:F});async function z(e,t){const i=U(Object(o["a"])(e));if("wosr"===i.fileType){const e=await(t.cache?t.cache.loadWOSR(i.url,t):Object(D["a"])(i.url,t)),r=Object(D["b"])(e,t);return{lods:[r],referenceBoundingBox:r.boundingBox,isEsriSymbolResource:!1,isWosr:!0,remove:e.remove}}const a=await(t.cache?t.cache.loadGLTF(i.url,t,t.usePBR):Object(T["a"])(new g["a"](t.streamDataRequester),i.url,t,t.usePBR)),n=Object(r["i"])(a.model.meta,"ESRI_proxyEllipsoid");a.meta.isEsriSymbolResource&&Object(r["k"])(n)&&-1!==a.meta.uri.indexOf("/RealisticTrees/")&&N(a,n);const s=a.meta.isEsriSymbolResource?{usePBR:t.usePBR,isSchematic:!1,treeRendering:a.customMeta.esriTreeRendering,mrrFactors:[0,1,.2]}:{usePBR:t.usePBR,isSchematic:!1,mrrFactors:[0,1,.5]},c={...t.materialParamsMixin,treeRendering:a.customMeta.esriTreeRendering};if(null!=i.specifiedLodIndex){const e=G(a,s,c,i.specifiedLodIndex);let t=e[0].boundingBox;return 0!==i.specifiedLodIndex&&(t=G(a,s,c,0)[0].boundingBox),{lods:e,referenceBoundingBox:t,isEsriSymbolResource:a.meta.isEsriSymbolResource,isWosr:!1,remove:a.remove}}const l=G(a,s,c);return{lods:l,referenceBoundingBox:l[0].boundingBox,isEsriSymbolResource:a.meta.isEsriSymbolResource,isWosr:!1,remove:a.remove}}function U(e){const t=e.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return t?{fileType:"gltf",url:t[1],specifiedLodIndex:null!=t[4]?Number(t[4]):null}:e.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:e,specifiedLodIndex:null}:{fileType:"unknown",url:e,specifiedLodIndex:null}}function G(e,t,i,a){const n=e.model,s=Object(c["a"])(),o=new Array,l=new Map,g=new Map;return n.lods.forEach((e,c)=>{if(void 0!==a&&c!==a)return;const v={name:e.name,stageResources:{textures:new Array,materials:new Array,geometries:new Array},lodThreshold:Object(r["k"])(e.lodThreshold)?e.lodThreshold:null,pivotOffset:[0,0,0],numberOfVertices:0,boundingBox:Object(p["k"])()};o.push(v),e.parts.forEach(e=>{const a=e.material+(e.attributes.normal?"_normal":"")+(e.attributes.color?"_color":"")+(e.attributes.texCoord0?"_texCoord0":"")+(e.attributes.tangent?"_tangent":""),o=n.materials.get(e.material),c=Object(r["k"])(e.attributes.texCoord0),y=Object(r["k"])(e.attributes.normal);if(!l.has(a)){if(c){if(Object(r["k"])(o.textureColor)&&!g.has(o.textureColor)){const e=n.textures.get(o.textureColor),t={...e.parameters,preMultiplyAlpha:!0};g.set(o.textureColor,new b["a"](e.data,t))}if(Object(r["k"])(o.textureNormal)&&!g.has(o.textureNormal)){const e=n.textures.get(o.textureNormal),t={...e.parameters,preMultiplyAlpha:!0};g.set(o.textureNormal,new b["a"](e.data,t))}if(Object(r["k"])(o.textureOcclusion)&&!g.has(o.textureOcclusion)){const e=n.textures.get(o.textureOcclusion),t={...e.parameters,preMultiplyAlpha:!0};g.set(o.textureOcclusion,new b["a"](e.data,t))}if(Object(r["k"])(o.textureEmissive)&&!g.has(o.textureEmissive)){const e=n.textures.get(o.textureEmissive),t={...e.parameters,preMultiplyAlpha:!0};g.set(o.textureEmissive,new b["a"](e.data,t))}if(Object(r["k"])(o.textureMetallicRoughness)&&!g.has(o.textureMetallicRoughness)){const e=n.textures.get(o.textureMetallicRoughness),t={...e.parameters,preMultiplyAlpha:!0};g.set(o.textureMetallicRoughness,new b["a"](e.data,t))}}const s=o.color[0]**(1/m["a"]),h=o.color[1]**(1/m["a"]),d=o.color[2]**(1/m["a"]),u=o.emissiveFactor[0]**(1/m["a"]),p=o.emissiveFactor[1]**(1/m["a"]),f=o.emissiveFactor[2]**(1/m["a"]);l.set(a,new m["b"]({...t,transparent:"BLEND"===o.alphaMode,textureAlphaMode:B(o.alphaMode),textureAlphaCutoff:o.alphaCutoff,diffuse:[s,h,d],ambient:[s,h,d],opacity:o.opacity,doubleSided:o.doubleSided,doubleSidedType:"winding-order",cullFace:o.doubleSided?0:2,vertexColors:!!e.attributes.color,vertexTangents:!!e.attributes.tangent,normals:y?"default":"screenDerivative",castShadows:!0,receiveSSAO:!0,textureId:Object(r["k"])(o.textureColor)&&c?g.get(o.textureColor).id:void 0,colorMixMode:o.colorMixMode,normalTextureId:Object(r["k"])(o.textureNormal)&&c?g.get(o.textureNormal).id:void 0,textureAlphaPremultiplied:!0,occlusionTextureId:Object(r["k"])(o.textureOcclusion)&&c?g.get(o.textureOcclusion).id:void 0,emissiveTextureId:Object(r["k"])(o.textureEmissive)&&c?g.get(o.textureEmissive).id:void 0,metallicRoughnessTextureId:Object(r["k"])(o.textureMetallicRoughness)&&c?g.get(o.textureMetallicRoughness).id:void 0,emissiveFactor:[u,p,f],mrrFactors:[o.metallicFactor,o.roughnessFactor,t.mrrFactors[2]],isSchematic:!1,...i}))}const w=H(e.indices||e.attributes.position.count,e.primitiveType),S=e.attributes.position.count,T=C(d["u"],S);Object(u["c"])(T,e.attributes.position,e.transform);const P=[["position",{data:T.typedBuffer,size:T.elementCount,exclusive:!0}]],A=[["position",w]];if(Object(r["k"])(e.attributes.normal)){const t=C(d["u"],S);Object(h["k"])(s,e.transform),Object(u["a"])(t,e.attributes.normal,s),P.push(["normal",{data:t.typedBuffer,size:t.elementCount,exclusive:!0}]),A.push(["normal",w])}if(Object(r["k"])(e.attributes.tangent)){const t=C(d["C"],S);Object(h["k"])(s,e.transform),V(t,e.attributes.tangent,s),P.push(["tangent",{data:t.typedBuffer,size:t.elementCount,exclusive:!0}]),A.push(["tangent",w])}if(Object(r["k"])(e.attributes.texCoord0)){const t=C(d["m"],S);O(t,e.attributes.texCoord0),P.push(["uv0",{data:t.typedBuffer,size:t.elementCount,exclusive:!0}]),A.push(["uv0",w])}if(Object(r["k"])(e.attributes.color)){const t=C(d["J"],S);if(4===e.attributes.color.elementCount)e.attributes.color instanceof d["C"]?k(t,e.attributes.color,255):e.attributes.color instanceof d["J"]?x(t,e.attributes.color):e.attributes.color instanceof d["H"]&&k(t,e.attributes.color,1/256);else{j(t,255,255,255,255);const i=new d["B"](t.buffer,0,4);e.attributes.color instanceof d["u"]?Object(u["b"])(i,e.attributes.color,255):e.attributes.color instanceof d["B"]?Object(_["a"])(i,e.attributes.color):e.attributes.color instanceof d["z"]&&Object(u["b"])(i,e.attributes.color,1/256)}P.push(["color",{data:t.typedBuffer,size:t.elementCount,exclusive:!0}]),A.push(["color",w])}const R=new f["a"](P,A);v.stageResources.geometries.push(R),v.stageResources.materials.push(l.get(a)),c&&(Object(r["k"])(o.textureColor)&&v.stageResources.textures.push(g.get(o.textureColor)),Object(r["k"])(o.textureNormal)&&v.stageResources.textures.push(g.get(o.textureNormal)),Object(r["k"])(o.textureOcclusion)&&v.stageResources.textures.push(g.get(o.textureOcclusion)),Object(r["k"])(o.textureEmissive)&&v.stageResources.textures.push(g.get(o.textureEmissive)),Object(r["k"])(o.textureMetallicRoughness)&&v.stageResources.textures.push(g.get(o.textureMetallicRoughness))),v.numberOfVertices+=S;const M=R.boundingInfo;Object(r["k"])(M)&&(Object(p["r"])(v.boundingBox,M.getBBMin()),Object(p["r"])(v.boundingBox,M.getBBMax()))})}),o}function B(e){switch(e){case"BLEND":return 0;case"MASK":return 2;case"OPAQUE":return 1;default:return 0}}function H(e,t){switch(t){case 4:return R(e);case 5:return M(e);case 6:return E(e)}}function N(e,t){for(let i=0;i<e.model.lods.length;++i){const o=e.model.lods[i];e.customMeta.esriTreeRendering=!0;for(const c of o.parts){const o=c.attributes.normal;if(Object(r["j"])(o))return;const h=c.attributes.position,u=h.count,p=Object(a["e"])(),f=Object(a["e"])(),m=Object(a["e"])(),b=C(d["J"],u),g=C(d["u"],u),v=Object(s["a"])(Object(l["b"])(),c.transform);for(let r=0;r<u;r++){h.getVec(r,f),o.getVec(r,p),Object(n["n"])(f,f,c.transform),Object(n["k"])(m,f,t.center),Object(n["c"])(m,m,t.radius);const a=m[2],s=Object(n["q"])(m),l=Math.min(.45+.55*s*s,1);Object(n["c"])(m,m,t.radius),Object(n["n"])(m,m,v),Object(n["s"])(m,m),i+1!==e.model.lods.length&&e.model.lods.length>1&&Object(n["j"])(m,m,p,a>-1?.2:Math.min(-4*a-3.8,1)),g.setVec(r,m),b.set(r,0,255*l),b.set(r,1,255*l),b.set(r,2,255*l),b.set(r,3,255)}c.attributes.normal=g,c.attributes.color=b}}}},"955e":function(e,t,i){"use strict";var r=i("a4ee"),a=(i("c120"),i("e92d")),n=i("59b2"),s=i("4adc"),o=i("1a3e"),c=i("d386"),l=(i("e041"),i("8eed"),i("f402"),i("9d83")),h=i("2c4f"),d=i("255d"),u=(i("1b8f"),i("702a")),p=i("755e"),f=i("feab"),m=i("26fd"),b=i("121a"),g=(i("cea0"),i("fc29")),v=i("c9fb");let y=class extends g["a"]{constructor(e){super(e),this.layer=null,this.enabled=!0,this.updating=!1,this.availability=1}};Object(r["a"])([Object(n["b"])({constructOnly:!0})],y.prototype,"layer",void 0),Object(r["a"])([Object(n["b"])()],y.prototype,"enabled",void 0),Object(r["a"])([Object(n["b"])()],y.prototype,"updating",void 0),Object(r["a"])([Object(n["b"])()],y.prototype,"availability",void 0),y=Object(r["a"])([Object(c["a"])("esri.views.interactive.snapping.SnappingLayerSource")],y);var O=y,_=O;let x=class extends g["a"]{constructor(e){super(e),this.enabled=!1,this.enabledToggled=!1,this.selfEnabled=!0,this.featureEnabled=!0,this.featureSources=new h["a"],this.distance=v["a"].distance,this.touchSensitivityMultiplier=v["a"].touchSensitivityMultiplier}get effectiveEnabled(){return this.enabledToggled?!this.enabled:this.enabled}get effectiveSelfEnabled(){return this.effectiveEnabled&&this.selfEnabled}get effectiveFeatureEnabled(){return this.effectiveEnabled&&this.featureEnabled}};Object(r["a"])([Object(n["b"])()],x.prototype,"enabled",void 0),Object(r["a"])([Object(n["b"])()],x.prototype,"enabledToggled",void 0),Object(r["a"])([Object(n["b"])()],x.prototype,"selfEnabled",void 0),Object(r["a"])([Object(n["b"])()],x.prototype,"featureEnabled",void 0),Object(r["a"])([Object(n["b"])({type:h["a"].ofType(_)})],x.prototype,"featureSources",void 0),Object(r["a"])([Object(n["b"])()],x.prototype,"distance",void 0),Object(r["a"])([Object(n["b"])()],x.prototype,"touchSensitivityMultiplier",void 0),Object(r["a"])([Object(n["b"])({readOnly:!0})],x.prototype,"effectiveEnabled",null),Object(r["a"])([Object(n["b"])({readOnly:!0})],x.prototype,"effectiveSelfEnabled",null),Object(r["a"])([Object(n["b"])({readOnly:!0})],x.prototype,"effectiveFeatureEnabled",null),x=Object(r["a"])([Object(c["a"])("esri.views.interactive.snapping.SnappingOptions")],x);var j=x,w=j,S=i("b2b2"),C=i("ce50"),T=i("f4cc"),P=i("4ae5"),A=i("32ed"),R=(i("e06a"),i("ce6d")),M=i("4cac"),E=i("a915"),D=i("db52"),I=i("0d76"),L=i("4dc9"),V=i("1fd7"),k=i("8d60"),F=i("af40"),z=i("3795"),U=i("f694"),G=i("ce0b"),B=i("2589"),H=i("7aa6"),N=i("412f"),q=i("1a54"),W=i("1381"),Z=i("8b1a"),$=i("6ae9"),Q=i("27df"),X=i("1f1c");let Y=class extends R["a"].EventedAccessor{constructor(e){var t;super(e),this._hasZ=null,this._snappingTask=null,this._stagedVertex=null,this._stagedVertexUnsnapped=null,this._lastVertexUnsnapped=null,this._nativeEventHistory={undoStack:[],redoStack:[]},this.interactiveUndoDisabled=!1,this.history=[],this.redoHistory=[],this.snapToScene=!1,this.view=null,this.elevationInfo=null,this.defaultZ=0,this._coordinateHelper=Object(Z["a"])(e.hasZ,!1,e.view.spatialReference,"local"),this._snappingManager=e.snappingManager,this._editGeometry=new Q["a"](new $["c"](this._coordinateHelper),null!=(t=e.editGeometryType)?t:"polygon"),this._snappingContext=new X["a"]({geometry:this._editGeometry,elevationInfo:{mode:"on-the-ground",offset:0},pointer:"mouse",visualizer:new W["a"]}),this._activeComponent=new $["a"](this._editGeometry.editGeometry),this._editGeometry.editGeometry.components.push(this._activeComponent)}destroy(){this._snappingTask=Object(S["a"])(this._snappingTask),Object(S["k"])(this._snappingManager)&&this._snappingManager.doneSnapping(),this._editGeometry.destroy()}get _committedVertices(){return this._editGeometry.editGeometry.components[0].vertices.map(e=>e.pos)}get vertices(){return Object(S["k"])(this._stagedVertex)?[...this._committedVertices,this._coordinateHelper.pointToArray(this._stagedVertex)]:this._committedVertices}get hasZ(){return Object(S["k"])(this._hasZ)?this._hasZ:"3d"===this.view.type}set hasZ(e){this._hasZ=e,this.notifyChange("hasZ")}canUndo(){return this._editGeometry.editGeometry.canUndo}canRedo(){return this._editGeometry.editGeometry.canRedo}undo(){this.canUndo()&&this._editGeometry.undo()}redo(){this.canRedo()&&this._editGeometry.redo()}getCoordsFromScreenPoint(e){const t=this.screenToMap(e);return Object(S["k"])(t)?t.hasZ?[t.x,t.y,t.z]:[t.x,t.y]:null}getCoordsAndPointFromScreenPoint(e){const t=this.screenToMap(e);return Object(S["k"])(t)?t.hasZ?{vertex:[t.x,t.y,t.z],mapPoint:t}:{vertex:[t.x,t.y],mapPoint:t}:null}_pushCursorVertex(e){const t=Object(q["k"])(e[0],e[1],null,this.view.spatialReference);this._stagedVertexUnsnapped=t,Object(S["j"])(this._snappingManager)?this._stagedVertex=t:(this._stagedVertex=this._snappingManager.update(t,this._snappingContext),this._snappingTask=Object(T["i"])(async e=>{if(Object(S["k"])(this._snappingManager)){const i=await this._snappingManager.snap(t,this._snappingContext,e);return i.valid&&(this._stagedVertex=i.apply(),this.notifyChange("vertices")),i}return null}))}_popCursorVertex(){this._stagedVertex=null,this._stagedVertexUnsnapped=null,this.notifyChange("vertices")}getGeometryZValue(){return this.defaultZ}screenToMap(e){let t=null;if("3d"===this.view.type)if(this.hasZ){const i=Object(S["u"])(this.elevationInfo,K);t=this.view.sceneIntersectionHelper.intersectElevationFromScreen(Object(E["g"])(e.x,e.y),i,this.getGeometryZValue())}else{const i=Object(S["u"])(this.elevationInfo,J);t=this.view.sceneIntersectionHelper.intersectElevationFromScreen(Object(E["g"])(e.x,e.y),i,0),Object(S["k"])(t)&&(t.z=void 0)}else t=this.view.toMap(e),Object(S["k"])(t)&&(t.z=this.hasZ?this.getGeometryZValue():void 0);return t}_isDuplicateOfLastVertex(e){const t=this._editGeometry.editGeometry.components[0].getLastVertex();if(Object(S["k"])(t)&&e[0]===t[0]&&e[1]===t[1])return!0;const{x:i,y:r}=this._coordinateHelper.createDehydratedPoint(e);return!(!Object(S["k"])(this._lastVertexUnsnapped)||i!==this._lastVertexUnsnapped.x||r!==this._lastVertexUnsnapped.y)}};Object(r["a"])([Object(n["b"])({readOnly:!0})],Y.prototype,"vertices",null),Object(r["a"])([Object(n["b"])({type:Boolean,nonNullable:!0})],Y.prototype,"interactiveUndoDisabled",void 0),Object(r["a"])([Object(n["b"])({readOnly:!0})],Y.prototype,"history",void 0),Object(r["a"])([Object(n["b"])({readOnly:!0})],Y.prototype,"redoHistory",void 0),Object(r["a"])([Object(n["b"])()],Y.prototype,"snapToScene",void 0),Object(r["a"])([Object(n["b"])()],Y.prototype,"view",void 0),Object(r["a"])([Object(n["b"])()],Y.prototype,"elevationInfo",void 0),Object(r["a"])([Object(n["b"])({nonNullable:!0})],Y.prototype,"defaultZ",void 0),Object(r["a"])([Object(n["b"])()],Y.prototype,"hasZ",null),Y=Object(r["a"])([Object(c["a"])("esri.views.draw.DrawAction")],Y);const K={mode:"absolute-height",offset:0},J={mode:"on-the-ground",offset:0};var ee=Y,te=ee;class ie{constructor(e,t,i,r){this.view=e,this.native=t,this.vertexIndex=i,this.vertices=r,this.defaultPrevented=!1,this.type="vertex-add"}preventDefault(){this.defaultPrevented=!0}}class re{constructor(e,t,i,r){this.view=e,this.native=t,this.vertexIndex=i,this.vertices=r,this.defaultPrevented=!1,this.type="vertex-remove"}preventDefault(){this.defaultPrevented=!0}}class ae{constructor(e,t,i,r,a=null){this.view=e,this.native=t,this.vertexIndex=i,this.vertices=r,this.mapPoint=a,this.coordinates=null,this.defaultPrevented=!1,this.type="cursor-update",this.coordinates=1===r.length?r[0]:null}preventDefault(){this.defaultPrevented=!0}}class ne{constructor(e,t){this.native=e,this.vertices=t,this.coordinates=null,this.defaultPrevented=!1,this.type="draw-complete",this.coordinates=1===t.length?t[0]:null}preventDefault(){this.defaultPrevented=!0}}const se={drawCompleteKey:"c",redoKey:"r",undoKey:"z",vertexAddKey:"f",panKey:" "};let oe=class extends te{constructor(e){super(e),this._cursorScreenPoint=null,this._popVertexOnPointerMove=!1,this._addVertexOnPointerUp=!1,this._activePointerId=null,this._viewHandles=new F["a"],this._undoRedoHandles=new F["a"]}initialize(){this._addViewHandles(),this._addUndoRedoHandles()}destroy(){this._removeViewHandles(),this._viewHandles.destroy(),this._removeUndoRedoHandles(),this._undoRedoHandles.destroy(),this.emit("destroy")}undo(){super.undo(),this.notifyChange("vertices")}redo(){super.redo(),this.notifyChange("vertices")}complete(){this._completeDrawing()}_addViewHandles(){this._removeViewHandles(),this._viewHandles.add([this.view.on("click",e=>{e.stopPropagation()},B["b"].TOOL),this.view.on("pointer-down",e=>{this._shouldHandlePointerEvent(e)&&(this._snappingTask=Object(S["a"])(this._snappingTask),this._activePointerId=e.pointerId,this._addVertexOnPointerUp=!0,this._cursorScreenPoint=Object(N["a"])(e),"touch"===e.pointerType&&this._updateCursor(e.native))},B["b"].TOOL),this.view.on("pointer-move",e=>{this._popVertexOnPointerMove&&(this.undo(),this._popVertexOnPointerMove=!1),this._snappingTask=Object(S["a"])(this._snappingTask),this._cursorScreenPoint=Object(N["a"])(e),"touch"!==e.pointerType&&this._updateCursor(e.native)},B["b"].TOOL),this.view.on("pointer-drag",e=>{this._shouldHandlePointerEvent(e)&&(this._snappingTask=Object(S["a"])(this._snappingTask),this._addVertexOnPointerUp=!1)},B["b"].TOOL),this.view.on("pointer-up",e=>{if(this._shouldHandlePointerEvent(e))if(this._snappingTask=Object(S["a"])(this._snappingTask),this._activePointerId=null,this._addVertexOnPointerUp)this._vertexAddHandler(e);else{const t="touch"===e.pointerType;this._updateCursor(e.native,t)}},B["b"].TOOL),this.view.on("drag",["Shift"],e=>{e.stopPropagation()},B["b"].TOOL),this.view.on("double-click",e=>{e.stopPropagation(),this._drawCompleteHandler(e)},B["b"].TOOL),this.view.on("double-click",["Control"],e=>{e.stopPropagation(),this._drawCompleteHandler(e)},B["b"].TOOL),this.view.on("key-down",e=>{const{key:t,repeat:i}=e;t===se.vertexAddKey&&!i&&this._cursorScreenPoint?(e.stopPropagation(),this._snappingTask=Object(S["a"])(this._snappingTask),this._vertexAddHandler(e)):t===se.drawCompleteKey&&!i&&this._cursorScreenPoint&&this.vertices.length>2?(e.stopPropagation(),this._snappingTask=Object(S["a"])(this._snappingTask),this._vertexAddHandler(e),this._drawCompleteHandler(e)):t!==se.undoKey||this.interactiveUndoDisabled||i?t!==se.redoKey||this.interactiveUndoDisabled||i?t!==se.panKey||i||e.stopPropagation():(e.stopPropagation(),this.redo()):(e.stopPropagation(),this.undo())},B["b"].TOOL),this.view.on("key-up",e=>{e.key===se.panKey&&e.stopPropagation()},B["b"].TOOL)])}_addUndoRedoHandles(){this._removeUndoRedoHandles(),this._undoRedoHandles.add([this._editGeometry.on("vertex-remove",e=>{if(this.notifyChange("vertices"),"undo"===e.operation){const t=this._nativeEventHistory.undoStack.pop();this._nativeEventHistory.redoStack.push(t);const i=[...this._committedVertices];Object(S["k"])(this._stagedVertex)&&i.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("undo",new re(this.view,t,e.vertices[0].index,i))}}),this._editGeometry.on("vertex-add",e=>{if(this.notifyChange("vertices"),"apply"===e.operation){const e=this._nativeEventHistory.undoStack[this._nativeEventHistory.undoStack.length],t=this._committedVertices.length-1,i=new ie(this.view,e,t,this.vertices);this.emit("vertex-add",i),i.defaultPrevented&&(this._popVertexOnPointerMove=!0)}else if("redo"===e.operation){const t=this._nativeEventHistory.redoStack.pop();this._nativeEventHistory.undoStack.push(t);const i=[...this._committedVertices];Object(S["k"])(this._stagedVertex)&&i.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("redo",new ie(this.view,t,e.vertices[0].index,i))}})])}_removeViewHandles(){this._viewHandles.removeAll()}_removeUndoRedoHandles(){this._undoRedoHandles.removeAll()}_addVertex(e,t){const i=this._coordinateHelper.fromArray(e);if(this._isDuplicateOfLastVertex(i))return;this._lastVertexUnsnapped=this._stagedVertexUnsnapped,this._popCursorVertex(),this._editGeometry.appendVertex(i);const r=t||new Event("placeholder");this._nativeEventHistory.undoStack.push(r)}_updateCursor(e,t=!1){if(this._popCursorVertex(),!this._cursorScreenPoint)return;const i=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);if(Object(S["k"])(i)&&!t){this._pushCursorVertex(i.vertex);const t=()=>new ae(this.view,e,this._activeComponent.vertices.length,this.vertices,Object(S["k"])(this._stagedVertex)?new P["a"](this._stagedVertex):null);this.emit("cursor-update",t()),Object(S["k"])(this._snappingTask)&&this._snappingTask.promise.then(e=>{e.valid&&this.emit("cursor-update",t())},()=>{})}}_completeDrawing(e){if(this._activePointerId=null,this._popCursorVertex(),this._snappingTask=Object(S["a"])(this._snappingTask),Object(S["k"])(this._snappingManager)&&this._snappingManager.doneSnapping(),this.vertices.length<2)return;const t=new ne(e,this.vertices);this.emit("draw-complete",t),t.defaultPrevented||this._removeViewHandles()}_shouldHandlePointerEvent(e){return ce(e)&&(Object(S["j"])(this._activePointerId)||this._activePointerId===e.pointerId)}_vertexAddHandler(e){const t=Object(S["k"])(this._stagedVertex)?this._coordinateHelper.pointToArray(this._stagedVertex):this.getCoordsFromScreenPoint(this._cursorScreenPoint);Object(S["k"])(t)&&this._addVertex(t,e.native)}_drawCompleteHandler(e){this._completeDrawing(e.native)}};function ce(e){return"mouse"!==e.pointerType||0===e.button}oe=Object(r["a"])([Object(c["a"])("esri.views.draw.MultipointDrawAction")],oe);Object.freeze({__proto__:null,get MultipointDrawAction(){return oe}});var le=i("e20b"),he=i("6469"),de=i("025c"),ue=i("4772");let pe=class extends(R["a"].EventedMixin(ue["a"])){constructor(e){super(e),this.drawOperation=null,this.hasZ=!0,this.defaultZ=0,this.elevationInfo=null,this.snapToScene=null,this.mode=null,this.geometryType=null,this.type="draw-3d"}initialize(){const e=Object(S["u"])(this.elevationInfo,{mode:this.hasZ?"absolute-height":"on-the-ground",offset:0});this.drawOperation=new he["a"]({view:this.view,manipulators:this.manipulators,geometryType:this.geometryType,drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,snappingDrawSurface:new de["b"](this.view,e),elevationDrawSurface:new de["a"](e,this.defaultZ,this.view),hasM:!1,elevationInfo:e}),this.drawOperation.on("vertex-add",e=>this.onVertexAdd(e)),this.drawOperation.on("vertex-remove",e=>this.onVertexRemove(e)),this.drawOperation.on("vertex-update",e=>this.onVertexUpdate(e)),this.drawOperation.on("cursor-update",e=>this.onCursorUpdate(e)),this.drawOperation.on("complete",e=>this.onComplete(e))}destroy(){this.drawOperation.destroy(),this.drawOperation=null,this._set("view",null)}onInputEvent(e){this.drawOperation.onInputEvent(e)}set enabled(e){this.drawOperation.interactive=e,this._set("enabled",e)}reset(){}get canRedo(){return this.drawOperation.canRedo}redo(){this.drawOperation.redo()}get canUndo(){return this.drawOperation.canUndo}undo(){this.drawOperation.undo()}completeCreateOperation(){this.drawOperation.complete()}activate(){}deactivate(){this.drawOperation.isCompleted||this.drawOperation.cancel()}getVertexCoords(){return this.drawOperation.vertices}onVertexAdd(e){this.emit("vertex-add",e)}onVertexRemove(e){this.emit("vertex-remove",e)}onVertexUpdate(e){this.emit("vertex-update",e)}onCursorUpdate(e){this.emit("cursor-update",e)}onComplete(e){this.emit("complete",e)}};Object(r["a"])([Object(n["b"])({constructOnly:!0,nonNullable:!0})],pe.prototype,"view",void 0),Object(r["a"])([Object(n["b"])({value:!0})],pe.prototype,"enabled",null),Object(r["a"])([Object(n["b"])({constructOnly:!0})],pe.prototype,"hasZ",void 0),Object(r["a"])([Object(n["b"])({constructOnly:!0,nonNullable:!0})],pe.prototype,"defaultZ",void 0),Object(r["a"])([Object(n["b"])({constructOnly:!0})],pe.prototype,"elevationInfo",void 0),Object(r["a"])([Object(n["b"])()],pe.prototype,"snapToScene",void 0),Object(r["a"])([Object(n["b"])({constructOnly:!0})],pe.prototype,"mode",void 0),Object(r["a"])([Object(n["b"])({constructOnly:!0})],pe.prototype,"geometryType",void 0),Object(r["a"])([Object(n["b"])({readOnly:!0})],pe.prototype,"type",void 0),pe=Object(r["a"])([Object(c["a"])("esri.views.3d.interactive.editingTools.draw.DrawTool")],pe);let fe=class extends te{constructor(e){super(e),this._cursorScreenPoint=null,this._addVertexOnPointerUp=!1,this._activePointerId=null,this._viewHandles=new F["a"]}initialize(){"2d"===this.view.type?this._addViewHandles():this._addDrawTool(this.view)}destroy(){"2d"===this.view.type?(this._removeViewHandles(),this._viewHandles.destroy()):this._removeDrawTool(),this.emit("destroy")}get coordinates(){return Object(le["c"])(a["a"].getLogger("esri.views.draw.PointDrawAction"),"coordinates",{replacement:"vertices",version:"4.19"}),this.vertices[0]}complete(){"2d"===this.view.type?this._cursorScreenPoint&&this._completeDrawing():this._drawTool.completeCreateOperation()}_addViewHandles(){this._removeViewHandles(),this._viewHandles.add([this.view.on("pointer-down",e=>{this._shouldHandlePointerEvent(e)&&(this._snappingTask=Object(S["a"])(this._snappingTask),this._activePointerId=e.pointerId,this._addVertexOnPointerUp=!0,this._cursorScreenPoint=Object(N["a"])(e),"touch"===e.pointerType&&this._updateCursor(e.native))},B["b"].TOOL),this.view.on("pointer-move",e=>{this._snappingTask=Object(S["a"])(this._snappingTask),this._cursorScreenPoint=Object(N["a"])(e),"touch"!==e.pointerType&&this._updateCursor(e.native)},B["b"].TOOL),this.view.on("pointer-drag",e=>{this._shouldHandlePointerEvent(e)&&(this._snappingTask=Object(S["a"])(this._snappingTask),this._addVertexOnPointerUp=!1)},B["b"].TOOL),this.view.on("pointer-up",e=>{if(this._shouldHandlePointerEvent(e))if(this._snappingTask=Object(S["a"])(this._snappingTask),this._activePointerId=null,this._addVertexOnPointerUp)e.stopPropagation(),this._vertexAddHandler();else{const t="touch"===e.pointerType;this._updateCursor(e.native,t)}},B["b"].TOOL),this.view.on("drag",["Shift"],e=>{e.stopPropagation()},B["b"].TOOL),this.view.on("key-down",e=>{e.key===se.drawCompleteKey&&this._cursorScreenPoint&&(this._snappingTask=Object(S["a"])(this._snappingTask),this._vertexAddHandler())},B["b"].TOOL)])}_removeViewHandles(){this._viewHandles.removeAll()}_addDrawTool(e){this._drawTool=new pe({view:e,elevationInfo:this.elevationInfo,hasZ:this.hasZ,geometryType:"point",mode:"click"}),this.view.toolViewManager.tools.push(this._drawTool),this.view.activeTool=this._drawTool,this._drawTool.on("cursor-update",e=>{1===e.vertices.length&&this.emit("cursor-update",new ae(this.view,null,e.vertices[0].vertexIndex,this._drawTool.getVertexCoords()))}),this._drawTool.on("complete",e=>{this.emit("draw-complete",new ne(null,this._drawTool.getVertexCoords())),this._removeDrawTool()})}_removeDrawTool(){Object(S["k"])(this._drawTool)&&(this.view.tools.remove(this._drawTool),this._drawTool.destroy(),this._drawTool=null)}_addVertex(e){const t=this._coordinateHelper.fromArray(e);this._isDuplicateOfLastVertex(t)||(this._lastVertexUnsnapped=this._stagedVertexUnsnapped,this._popCursorVertex(),this._editGeometry.appendVertex(t),this.notifyChange("vertices"))}_updateCursor(e,t=!1){if(this._popCursorVertex(),!this._cursorScreenPoint)return;const i=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);if(Object(S["k"])(i)&&!t){this._pushCursorVertex(i.vertex);const t=()=>new ae(this.view,e,this._activeComponent.vertices.length,this.vertices,Object(S["k"])(this._stagedVertex)?new P["a"](this._stagedVertex):null);this.emit("cursor-update",t()),Object(S["k"])(this._snappingTask)&&this._snappingTask.promise.then(e=>{e.valid&&this.emit("cursor-update",t())},()=>{})}}_completeDrawing(e){this._activePointerId=null,this._popCursorVertex(),this._snappingTask=Object(S["a"])(this._snappingTask),Object(S["k"])(this._snappingManager)&&this._snappingManager.doneSnapping();const t=new ne(e,this.vertices);this.emit("draw-complete",t),t.defaultPrevented||this._removeViewHandles()}_shouldHandlePointerEvent(e){return me(e)&&(Object(S["j"])(this._activePointerId)||this._activePointerId===e.pointerId)}_vertexAddHandler(){const e=Object(S["k"])(this._stagedVertex)?this._coordinateHelper.pointToArray(this._stagedVertex):this.getCoordsFromScreenPoint(this._cursorScreenPoint);Object(S["k"])(e)&&(this._addVertex(e),this._completeDrawing())}};function me(e){return"mouse"!==e.pointerType||0===e.button}Object(r["a"])([Object(n["b"])({readOnly:!0})],fe.prototype,"coordinates",null),fe=Object(r["a"])([Object(c["a"])("esri.views.draw.PointDrawAction")],fe);var be=i("4aea");let ge=class extends te{constructor(e){super(e),this._cursorScreenPoint=null,this._panEnabled=!1,this._popVertexOnPointerMove=!1,this._addVertexOnPointerUp=!1,this._activePointerId=null,this._viewHandles=new F["a"],this._undoRedoHandles=new F["a"],this.mode=be["a"]}initialize(){"2d"===this.view.type?(this._addViewHandles(),this._addUndoRedoHandles()):this._addDrawTool(this.view)}destroy(){"2d"===this.view.type?(this._removeViewHandles(),this._viewHandles.destroy(),this._removeUndoRedoHandles(),this._undoRedoHandles.destroy()):this._removeDrawTool(),this.emit("destroy")}get _dragEnabled(){return"freehand"===this.mode||"hybrid"===this.mode}get _clickEnabled(){return"click"===this.mode||"hybrid"===this.mode}undo(){super.undo(),this.notifyChange("vertices")}redo(){super.redo(),this.notifyChange("vertices")}complete(){"2d"===this.view.type?this._completeDrawing():this._drawTool.completeCreateOperation()}getGeometryZValue(){return this.vertices.length>0&&this.vertices[0].length>2?this.vertices[0][2]:this._get("defaultZ")}_addViewHandles(){this._removeViewHandles(),this._viewHandles.add([this.view.on("click",e=>{e.stopPropagation()},B["b"].TOOL),this.view.on("pointer-down",e=>{this._shouldHandlePointerEvent(e)&&(this._snappingTask=Object(S["a"])(this._snappingTask),this._activePointerId=e.pointerId,this._addVertexOnPointerUp=!0,this._cursorScreenPoint=Object(N["a"])(e),"touch"===e.pointerType&&this._updateCursor(e.native))},B["b"].TOOL),this.view.on("pointer-move",e=>{this._snappingTask=Object(S["a"])(this._snappingTask),this._popVertexOnPointerMove&&(this.undo(),this._popVertexOnPointerMove=!1),this._cursorScreenPoint=Object(N["a"])(e),"touch"!==e.pointerType&&this._updateCursor(e.native)},B["b"].TOOL),this.view.on("pointer-drag",e=>{this._shouldHandlePointerEvent(e)&&(this._snappingTask=Object(S["a"])(this._snappingTask),this._cursorScreenPoint=Object(N["a"])(e),this._dragEnabled&&!this._panEnabled?this._vertexAddHandler(e):this._addVertexOnPointerUp=!1)},B["b"].TOOL),this.view.on("pointer-up",e=>{if(this._shouldHandlePointerEvent(e))if(this._snappingTask=Object(S["a"])(this._snappingTask),this._activePointerId=null,this._addVertexOnPointerUp){if(!this._clickEnabled)return 1===this.vertices.length&&this.vertices.pop(),void this._drawCompleteHandler(e);this._vertexAddHandler(e)}else{const t="touch"===e.pointerType;this._updateCursor(e.native,t)}},B["b"].TOOL),this.view.on("drag",e=>{this._dragEnabled&&Object(S["k"])(this._activePointerId)&&!this._panEnabled&&e.stopPropagation()},B["b"].TOOL),this.view.on("drag",["Shift"],e=>{e.stopPropagation()},B["b"].TOOL),this.view.on("double-click",e=>{e.stopPropagation(),this._drawCompleteHandler(e)},B["b"].TOOL),this.view.on("double-click",["Control"],e=>{e.stopPropagation(),this._drawCompleteHandler(e)},B["b"].TOOL),this.view.on("key-down",e=>{const{key:t,repeat:i}=e;t===se.vertexAddKey&&!i&&this._cursorScreenPoint?(e.stopPropagation(),this._snappingTask=Object(S["a"])(this._snappingTask),this._vertexAddHandler(e)):t===se.drawCompleteKey&&!i&&this._cursorScreenPoint&&this.vertices.length>2?(e.stopPropagation(),this._snappingTask=Object(S["a"])(this._snappingTask),this._vertexAddHandler(e),this._drawCompleteHandler(e)):t!==se.undoKey||this.interactiveUndoDisabled||i?t!==se.redoKey||this.interactiveUndoDisabled||i?t!==se.panKey||i||(e.stopPropagation(),this._panEnabled=!0):(e.stopPropagation(),this.redo()):(e.stopPropagation(),this.undo())},B["b"].TOOL),this.view.on("key-up",e=>{e.key===se.panKey&&(e.stopPropagation(),this._panEnabled=!1)},B["b"].TOOL)])}_addUndoRedoHandles(){this._removeUndoRedoHandles(),this._undoRedoHandles.add([this._editGeometry.on("vertex-remove",e=>{if(this.notifyChange("vertices"),"undo"===e.operation){const t=this._nativeEventHistory.undoStack.pop();this._nativeEventHistory.redoStack.push(t);const i=[...this._committedVertices];Object(S["k"])(this._stagedVertex)&&i.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("undo",new re(this.view,t,e.vertices[0].index,i))}}),this._editGeometry.on("vertex-add",e=>{if(this.notifyChange("vertices"),"apply"===e.operation){const e=this._nativeEventHistory.undoStack[this._nativeEventHistory.undoStack.length],t=this._committedVertices.length-1,i=new ie(this.view,e,t,this.vertices);this.emit("vertex-add",i),i.defaultPrevented&&(this._popVertexOnPointerMove=!0)}else if("redo"===e.operation){const t=this._nativeEventHistory.redoStack.pop();this._nativeEventHistory.undoStack.push(t);const i=[...this._committedVertices];Object(S["k"])(this._stagedVertex)&&i.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("redo",new ie(this.view,t,e.vertices[0].index,i))}})])}_removeViewHandles(){this._viewHandles.removeAll()}_removeUndoRedoHandles(){this._undoRedoHandles.removeAll()}_addDrawTool(e){this._drawTool=new pe({view:e,elevationInfo:this.elevationInfo,hasZ:this.hasZ,geometryType:"polygon",mode:this.mode}),this.view.toolViewManager.tools.push(this._drawTool),this.view.activeTool=this._drawTool,this._drawTool.on("vertex-add",e=>{1===e.vertices.length&&this.emit("vertex-add",new ie(this.view,null,e.vertices[0].vertexIndex,this._drawTool.getVertexCoords()))}),this._drawTool.on("cursor-update",e=>{1===e.vertices.length&&this.emit("cursor-update",new ae(this.view,null,e.vertices[0].vertexIndex,this._drawTool.getVertexCoords()))}),this._drawTool.on("complete",e=>{this.emit("draw-complete",new ne(null,this._drawTool.getVertexCoords())),this._removeDrawTool()})}_removeDrawTool(){Object(S["k"])(this._drawTool)&&(this.view.tools.remove(this._drawTool),this._drawTool.destroy(),this._drawTool=null)}_addVertex(e,t){const i=this._coordinateHelper.fromArray(e);if(this._isDuplicateOfLastVertex(i))return;this._lastVertexUnsnapped=this._stagedVertexUnsnapped,this._popCursorVertex(),this._editGeometry.appendVertex(i);const r=t||new Event("placeholder");this._nativeEventHistory.undoStack.push(r)}_updateCursor(e,t=!1){if(this._popCursorVertex(),!this._cursorScreenPoint)return;const i=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);if(Object(S["k"])(i)&&!t){this._pushCursorVertex(i.vertex);const t=()=>new ae(this.view,e,this._activeComponent.vertices.length,this.vertices,Object(S["k"])(this._stagedVertex)?new P["a"](this._stagedVertex):null);this.emit("cursor-update",t()),Object(S["k"])(this._snappingTask)&&this._snappingTask.promise.then(e=>{e.valid&&this.emit("cursor-update",t())},()=>{})}}_completeDrawing(e){if(this._activePointerId=null,this._popCursorVertex(),this._snappingTask=Object(S["a"])(this._snappingTask),Object(S["k"])(this._snappingManager)&&this._snappingManager.doneSnapping(),this.vertices.length<3)return;const t=new ne(e,this.vertices);this.emit("draw-complete",t),t.defaultPrevented||this._removeViewHandles()}_shouldHandlePointerEvent(e){return ve(e)&&(Object(S["j"])(this._activePointerId)||this._activePointerId===e.pointerId)}_vertexAddHandler(e){const t=Object(S["k"])(this._stagedVertex)?this._coordinateHelper.pointToArray(this._stagedVertex):this.getCoordsFromScreenPoint(this._cursorScreenPoint);Object(S["k"])(t)&&this._addVertex(t,e.native)}_drawCompleteHandler(e){this._completeDrawing(e.native)}};function ve(e){return"mouse"!==e.pointerType||0===e.button}Object(r["a"])([Object(n["b"])()],ge.prototype,"_dragEnabled",null),Object(r["a"])([Object(n["b"])()],ge.prototype,"_clickEnabled",null),Object(r["a"])([Object(n["b"])({type:be["b"]})],ge.prototype,"mode",void 0),ge=Object(r["a"])([Object(c["a"])("esri.views.draw.PolygonDrawAction")],ge);let ye=class extends te{constructor(e){super(e),this._cursorScreenPoint=null,this._panEnabled=!1,this._popVertexOnPointerMove=!1,this._addVertexOnPointerUp=!1,this._activePointerId=null,this._viewHandles=new F["a"],this._undoRedoHandles=new F["a"],this.mode=be["a"]}initialize(){"2d"===this.view.type?(this._addViewHandles(),this._addUndoRedoHandles()):this._addDrawTool(this.view)}destroy(){"2d"===this.view.type?(this._removeViewHandles(),this._viewHandles.destroy(),this._removeUndoRedoHandles(),this._undoRedoHandles.destroy()):this._removeDrawTool(),this.emit("destroy")}get _clickEnabled(){return"click"===this.mode||"hybrid"===this.mode}get _dragEnabled(){return"freehand"===this.mode||"hybrid"===this.mode}undo(){super.undo(),this.notifyChange("vertices")}redo(){super.redo(),this.notifyChange("vertices")}complete(){"2d"===this.view.type?this._completeDrawing():this._drawTool.completeCreateOperation()}_addViewHandles(){this._removeViewHandles(),this._viewHandles.add([this.view.on("click",e=>{e.stopPropagation()},B["b"].TOOL),this.view.on("pointer-down",e=>{this._shouldHandlePointerEvent(e)&&!this._panEnabled&&(this._snappingTask=Object(S["a"])(this._snappingTask),this._activePointerId=e.pointerId,this._addVertexOnPointerUp=!0,this._cursorScreenPoint=Object(N["a"])(e),"touch"===e.pointerType&&this._updateCursor(e.native))},B["b"].TOOL),this.view.on("pointer-move",e=>{this._popVertexOnPointerMove&&(this.undo(),this._popVertexOnPointerMove=!1),this._snappingTask=Object(S["a"])(this._snappingTask),this._cursorScreenPoint=Object(N["a"])(e),"touch"!==e.pointerType&&this._updateCursor(e.native)},B["b"].TOOL),this.view.on("pointer-drag",e=>{this._shouldHandlePointerEvent(e)&&(this._snappingTask=Object(S["a"])(this._snappingTask),this._cursorScreenPoint=Object(N["a"])(e),this._dragEnabled&&!this._panEnabled?this._vertexAddHandler(e):this._addVertexOnPointerUp=!1)},B["b"].TOOL),this.view.on("pointer-up",e=>{if(this._shouldHandlePointerEvent(e))if(this._snappingTask=Object(S["a"])(this._snappingTask),this._activePointerId=null,this._addVertexOnPointerUp){if(!this._clickEnabled)return 1===this.vertices.length&&this.vertices.pop(),void this._drawCompleteHandler(e);this._vertexAddHandler(e)}else{const t="touch"===e.pointerType;this._updateCursor(e.native,t)}},B["b"].TOOL),this.view.on("drag",e=>{this._dragEnabled&&Object(S["k"])(this._activePointerId)&&!this._panEnabled&&e.stopPropagation()},B["b"].TOOL),this.view.on("drag",["Shift"],e=>{e.stopPropagation()},B["b"].TOOL),this.view.on("double-click",e=>{e.stopPropagation(),this._drawCompleteHandler(e)},B["b"].TOOL),this.view.on("double-click",["Control"],e=>{e.stopPropagation(),this._drawCompleteHandler(e)},B["b"].TOOL),this.view.on("key-down",e=>{const{key:t,repeat:i}=e;t===se.vertexAddKey&&!i&&this._cursorScreenPoint?(e.stopPropagation(),this._snappingTask=Object(S["a"])(this._snappingTask),this._vertexAddHandler(e)):t===se.drawCompleteKey&&!i&&this._cursorScreenPoint&&this.vertices.length>1?(e.stopPropagation(),this._snappingTask=Object(S["a"])(this._snappingTask),this._vertexAddHandler(e),this._drawCompleteHandler(e)):t!==se.undoKey||this.interactiveUndoDisabled||i?t!==se.redoKey||this.interactiveUndoDisabled||i?t!==se.panKey||i||(e.stopPropagation(),this._panEnabled=!0):(e.stopPropagation(),this.redo()):(e.stopPropagation(),this.undo())},B["b"].TOOL),this.view.on("key-up",e=>{e.key===se.panKey&&(e.stopPropagation(),this._panEnabled=!1)},B["b"].TOOL)])}_addUndoRedoHandles(){this._removeUndoRedoHandles(),this._undoRedoHandles.add([this._editGeometry.on("vertex-remove",e=>{if(this.notifyChange("vertices"),"undo"===e.operation){const t=this._nativeEventHistory.undoStack.pop();this._nativeEventHistory.redoStack.push(t);const i=[...this._committedVertices];Object(S["k"])(this._stagedVertex)&&i.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("undo",new re(this.view,t,e.vertices[0].index,i))}}),this._editGeometry.on("vertex-add",e=>{if(this.notifyChange("vertices"),"apply"===e.operation){const e=this._nativeEventHistory.undoStack[this._nativeEventHistory.undoStack.length],t=this._committedVertices.length-1,i=new ie(this.view,e,t,this.vertices);this.emit("vertex-add",i),i.defaultPrevented&&(this._popVertexOnPointerMove=!0)}else if("redo"===e.operation){const t=this._nativeEventHistory.redoStack.pop();this._nativeEventHistory.undoStack.push(t);const i=[...this._committedVertices];Object(S["k"])(this._stagedVertex)&&i.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("redo",new ie(this.view,t,e.vertices[0].index,i))}})])}_removeViewHandles(){this._viewHandles.removeAll()}_removeUndoRedoHandles(){this._undoRedoHandles.removeAll()}_addDrawTool(e){this._drawTool=new pe({view:e,elevationInfo:this.elevationInfo,hasZ:this.hasZ,geometryType:"polyline",mode:this.mode}),this.view.toolViewManager.tools.push(this._drawTool),this.view.activeTool=this._drawTool,this._drawTool.on("vertex-add",e=>{1===e.vertices.length&&this.emit("vertex-add",new ie(this.view,null,e.vertices[0].vertexIndex,this._drawTool.getVertexCoords()))}),this._drawTool.on("cursor-update",e=>{1===e.vertices.length&&this.emit("cursor-update",new ae(this.view,null,e.vertices[0].vertexIndex,this._drawTool.getVertexCoords()))}),this._drawTool.on("complete",e=>{this.emit("draw-complete",new ne(null,this._drawTool.getVertexCoords())),this._removeDrawTool()})}_removeDrawTool(){Object(S["k"])(this._drawTool)&&(this.view.tools.remove(this._drawTool),this._drawTool=Object(S["e"])(this._drawTool))}_addVertex(e,t){const i=this._coordinateHelper.fromArray(e);if(this._isDuplicateOfLastVertex(i))return;this._lastVertexUnsnapped=this._stagedVertexUnsnapped,this._popCursorVertex(),this._editGeometry.appendVertex(i);const r=t||new Event("placeholder");this._nativeEventHistory.undoStack.push(r)}_updateCursor(e,t=!1){if(this._popCursorVertex(),!this._cursorScreenPoint)return;const i=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);if(Object(S["k"])(i)&&!t){this._pushCursorVertex(i.vertex);const t=()=>new ae(this.view,e,this._activeComponent.vertices.length,this.vertices,Object(S["k"])(this._stagedVertex)?new P["a"](this._stagedVertex):null);this.emit("cursor-update",t()),Object(S["k"])(this._snappingTask)&&this._snappingTask.promise.then(e=>{e.valid&&this.emit("cursor-update",t())},()=>{})}}_completeDrawing(e){if(this._activePointerId=null,this._popCursorVertex(),this._snappingTask=Object(S["a"])(this._snappingTask),Object(S["k"])(this._snappingManager)&&this._snappingManager.doneSnapping(),this.vertices.length<2)return;const t=new ne(e,this.vertices);this.emit("draw-complete",t),t.defaultPrevented||this._removeViewHandles()}_shouldHandlePointerEvent(e){return Oe(e)&&(Object(S["j"])(this._activePointerId)||this._activePointerId===e.pointerId)}_vertexAddHandler(e){const t=Object(S["k"])(this._stagedVertex)?this._coordinateHelper.pointToArray(this._stagedVertex):this.getCoordsFromScreenPoint(this._cursorScreenPoint);Object(S["k"])(t)&&this._addVertex(t,e.native)}_drawCompleteHandler(e){this._completeDrawing(e.native)}};function Oe(e){return"mouse"!==e.pointerType||0===e.button}Object(r["a"])([Object(n["b"])()],ye.prototype,"_clickEnabled",null),Object(r["a"])([Object(n["b"])()],ye.prototype,"_dragEnabled",null),Object(r["a"])([Object(n["b"])({type:be["b"]})],ye.prototype,"mode",void 0),ye=Object(r["a"])([Object(c["a"])("esri.views.draw.PolylineDrawAction")],ye);var _e=i("a545");const xe=["freehand","click"];let je=class extends te{constructor(e){super(e),this._isDragging=!1,this._panEnabled=!1,this._cursorScreenPoint=null,this._viewHandles=new F["a"],this._activePointerId=null,this._addVertexOnPointerUp=!1,this.viewAlignedCoordinateSystem=null,this.mode="freehand"}initialize(){"2d"===this.view.type?this._addViewHandles():this._addDrawTool(this.view)}destroy(){"2d"===this.view.type?(this._removeViewHandles(),this._viewHandles.destroy()):this._removeDrawTool(),this.emit("destroy")}complete(){"2d"===this.view.type?this._completeDrawing():this._drawTool.completeCreateOperation()}getGeometryZValue(){return this.vertices.length>0&&this.vertices[0].length>2?this.vertices[0][2]:this._get("defaultZ")}_addViewHandles(){this._removeViewHandles(),"click"===this.mode?this._viewHandles.add(this._getClickModeViewHandles()):this._viewHandles.add(this._getDragModeViewHandles())}_getDragModeViewHandles(){return[this.view.on("immediate-click",e=>{if(e.stopPropagation(),e.mapPoint&&!this._panEnabled){const t=this.getCoordsFromScreenPoint(Object(N["a"])(e));Object(S["k"])(t)&&(this._vertexAddHandler(e),this._drawCompleteHandler(e))}},B["b"].TOOL),this.view.on("pointer-down",e=>{this._shouldHandlePointerEvent(e)&&(this._snappingTask=Object(S["a"])(this._snappingTask),this._panEnabled||(this._resetGeometry(),this._addVertexOnPointerUp=!0,this._cursorScreenPoint=Object(N["a"])(e),this._activePointerId=e.pointerId,this._vertexAddHandler(e),this._isDragging=!1,"touch"===e.pointerType&&this._updateCursor(e.native)))},B["b"].TOOL),this.view.on("pointer-move",e=>{this._snappingTask=Object(S["a"])(this._snappingTask),Object(S["j"])(this._activePointerId)&&"touch"!==e.pointerType&&(this._cursorScreenPoint=Object(N["a"])(e),this._updateCursor(e.native))},B["b"].TOOL),this.view.on("pointer-drag",e=>{this._shouldHandlePointerEvent(e)&&(this._snappingTask=Object(S["a"])(this._snappingTask),this._isDragging=!0,this._cursorScreenPoint=Object(N["a"])(e),this._updateCursor(e.native))},B["b"].TOOL),this.view.on("pointer-up",e=>{this._shouldHandlePointerEvent(e)&&this._addVertexOnPointerUp&&(this._snappingTask=Object(S["a"])(this._snappingTask),this._activePointerId=null,this._isDragging&&this._vertexAddHandler(e),2===this._committedVertices.length&&this._drawCompleteHandler(e),this._isDragging=!1)},B["b"].TOOL),this.view.on("key-down",e=>{e.key===se.drawCompleteKey&&this._cursorScreenPoint?(this._snappingTask=Object(S["a"])(this._snappingTask),this._drawCompleteHandler(e)):e.key===se.panKey&&(this._panEnabled=!0)},B["b"].TOOL),this.view.on("key-up",e=>{e.key===se.panKey&&(this._panEnabled=!1)},B["b"].TOOL),this.view.on("drag",e=>{Object(S["k"])(this._activePointerId)&&e.stopPropagation()},B["b"].TOOL),this.view.on("drag",["Shift"],e=>{e.stopPropagation()},B["b"].TOOL)]}_getClickModeViewHandles(){return[this.view.on("pointer-down",e=>{this._snappingTask=Object(S["a"])(this._snappingTask),this._cursorScreenPoint=Object(N["a"])(e),this._activePointerId=e.pointerId,this._isDragging=!1,"touch"===e.pointerType&&this._updateCursor(e.native)},B["b"].TOOL),this.view.on("pointer-move",e=>{this._snappingTask=Object(S["a"])(this._snappingTask),this._cursorScreenPoint=Object(N["a"])(e),Object(S["j"])(this._activePointerId)&&"touch"!==e.pointerType&&this._updateCursor(e.native)},B["b"].TOOL),this.view.on("pointer-drag",e=>{this._shouldHandlePointerEvent(e)&&(this._snappingTask=Object(S["a"])(this._snappingTask),this._isDragging=!0)},B["b"].TOOL),this.view.on("pointer-up",e=>{this._shouldHandlePointerEvent(e)&&(this._snappingTask=Object(S["a"])(this._snappingTask),this._activePointerId=null,e.stopPropagation(),this._isDragging||this._vertexAddHandler(e),2!==this.vertices.length||this._isDragging||this._drawCompleteHandler(e),this._isDragging=!1)},B["b"].TOOL),this.view.on("key-down",e=>{e.key===se.vertexAddKey&&this._cursorScreenPoint&&(this._vertexAddHandler(e),2===this.vertices.length&&this._drawCompleteHandler(e)),e.key===se.drawCompleteKey&&this._cursorScreenPoint&&2===this.vertices.length&&this._drawCompleteHandler(e)},B["b"].TOOL)]}_removeViewHandles(){this._viewHandles.removeAll()}_addDrawTool(e){this._drawTool=new pe({view:e,elevationInfo:this.elevationInfo,hasZ:this.hasZ,geometryType:"segment",mode:this.mode}),this.view.toolViewManager.tools.push(this._drawTool),this.view.activeTool=this._drawTool,this._drawTool.on("vertex-add",e=>{1===e.vertices.length&&this.emit("vertex-add",new ie(this.view,null,e.vertices[0].vertexIndex,this._drawTool.getVertexCoords()))}),this._drawTool.on("cursor-update",e=>{1===e.vertices.length&&this.emit("cursor-update",new ae(this.view,null,e.vertices[0].vertexIndex,this._drawTool.getVertexCoords()))}),this._drawTool.on("complete",e=>{this.emit("draw-complete",new ne(null,this._drawTool.getVertexCoords())),this._removeDrawTool()})}_removeDrawTool(){Object(S["k"])(this._drawTool)&&(this.view.tools.remove(this._drawTool),this._drawTool.destroy(),this._drawTool=null)}_addVertex(e,t){const i=this._coordinateHelper.fromArray(e);if(this._isDuplicateOfLastVertex(i))return;this._lastVertexUnsnapped=this._stagedVertexUnsnapped,this._popCursorVertex(),this._editGeometry.appendVertex(i),1===this._committedVertices.length&&(this.viewAlignedCoordinateSystem=Object(_e["a"])(this.view,this._committedVertices[0]));const r=this._committedVertices.length-1,a=new ie(this.view,t,r,this.vertices);this.emit("vertex-add",a)}_updateCursor(e){if(this._popCursorVertex(),!this._cursorScreenPoint)return;const t=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);if(Object(S["k"])(t)){this._pushCursorVertex(t.vertex);const i=()=>new ae(this.view,e,this._activeComponent.vertices.length,this.vertices,Object(S["k"])(this._stagedVertex)?new P["a"](this._stagedVertex):null);this.emit("cursor-update",i()),Object(S["k"])(this._snappingTask)&&this._snappingTask.promise.then(e=>{e.valid&&this.emit("cursor-update",i())},()=>{})}}_completeDrawing(e){if(this._activePointerId=null,this._popCursorVertex(),this._cursorScreenPoint=null,this._isDragging=!1,this._snappingTask=Object(S["a"])(this._snappingTask),Object(S["k"])(this._snappingManager)&&this._snappingManager.doneSnapping(),this.vertices.length<1)return;const t=new ne(e,this.vertices);this.emit("draw-complete",t),t.defaultPrevented||this._removeViewHandles()}_resetGeometry(){this._editGeometry.destroy(),this._editGeometry=new Q["a"](new $["c"](this._coordinateHelper),"polygon"),this._activeComponent=new $["a"](this._editGeometry.editGeometry),this._editGeometry.editGeometry.components.push(this._activeComponent)}_shouldHandlePointerEvent(e){return we(e)&&(Object(S["j"])(this._activePointerId)||this._activePointerId===e.pointerId)}_vertexAddHandler(e){const t=Object(S["k"])(this._stagedVertex)?this._coordinateHelper.pointToArray(this._stagedVertex):this.getCoordsFromScreenPoint(this._cursorScreenPoint);Object(S["k"])(t)&&this._addVertex(t,e.native)}_drawCompleteHandler(e){this._completeDrawing(e.native)}};function we(e){return"mouse"!==e.pointerType||0===e.button}Object(r["a"])([Object(n["b"])({type:xe})],je.prototype,"mode",void 0),je=Object(r["a"])([Object(c["a"])("esri/views/2d/engine/markup/SegmentDrawAction")],je);let Se=class extends g["a"]{constructor(){super(...arguments),this.activeAction=null,this.type="draw",this.view=null}destroy(){this.activeAction&&(this.activeAction.destroy(),this.activeAction=null)}create(e,t){this.reset();const i={view:this.view,...t};switch(e){case"point":i.editGeometryType="point",this.activeAction=new fe(i);break;case"polyline":i.editGeometryType="polyline",this.activeAction=new ye(i);break;case"multipoint":i.editGeometryType="polygon",this.activeAction=new oe(i);break;case"polygon":i.editGeometryType="polygon",this.activeAction=new ge(i);break;case"rectangle":case"circle":case"ellipse":case"triangle":i.editGeometryType="polygon",this.activeAction=new je(i)}return this.activeAction}complete(){this.activeAction&&this.activeAction.complete(),this.activeAction=null}reset(){this.activeAction&&this.activeAction.destroy(),this.activeAction=null}};Object(r["a"])([Object(n["b"])()],Se.prototype,"activeAction",void 0),Object(r["a"])([Object(n["b"])({readOnly:!0})],Se.prototype,"type",void 0),Object(r["a"])([Object(n["b"])()],Se.prototype,"view",void 0),Se=Object(r["a"])([Object(c["a"])("esri.views.draw.Draw")],Se);var Ce=Se,Te=Ce;function Pe(e){switch(e){case 0:break;case 1:return"not owned by a graphics layer";case 2:return"no geometry";case 3:return"the geometry type is not supported";case 4:return"the elevation mode is not supported";case 5:return"the symbol type is not supported"}return""}var Ae=i("243f"),Re=i("240c"),Me=i("f408");function Ee(e){var t;if("graphics"!==(null==(t=e.layer)?void 0:t.type))return 1;if(Object(S["j"])(e.geometry))return 2;switch(e.geometry.type){case"point":break;case"polygon":case"polyline":return 0;case"multipoint":case"extent":case"mesh":default:return 3}const i=Object(S["k"])(e.symbol)&&"point-3d"===e.symbol.type&&e.symbol.symbolLayers;return i&&i.length>0&&i.some(e=>"object"===e.type)?"on-the-ground"!==Object(Me["e"])(e)&&Object(Me["g"])(e)?4:0:5}let De=null;async function Ie(){return De||(De=await Promise.all([i.e("chunk-2d22cf8c"),i.e("chunk-3529a025")]).then(i.bind(null,"dfd4"))),De}var Le=i("b65e"),Ve=i("9efb"),ke=i("5996"),Fe=i("9096"),ze=i("3349"),Ue=i("6706"),Ge=i("0b2d"),Be=i("28eb"),He=i("92af");let Ne=class extends Fe["a"]{constructor(e){super(e),this.sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null}}}get updating(){return Object(Be["b"])(this.snappingSources,({snappingSource:e})=>e.updating)||this.updatingHandles.updating}get snappingSources(){var e;const t=this._get("snappingSources")||new Map,i=new Map;if(null!=(e=this.options)&&e.featureSources)for(const r of this.options.featureSources.items){const e=r.layer.uid,a=t.get(e);if(a){t.delete(e),i.set(e,a);continue}if(!r.layer.loaded){this.updatingHandles.addPromise(r.layer.load());continue}const n=this.createSourceInfo(r);Object(S["k"])(n)&&i.set(e,n)}for(const[,r]of t)r.destroy();return i}initialize(){var e;this.updatingHandles.add(this,"snappingSources",()=>{this.notifyChange("updating")},1),Object(S["k"])(this.view)&&this.handles.add([null==(e=this.view.refreshManager)?void 0:e.on("refresh",e=>{"interval"===e.trigger&&this.refreshSourceOfLayer(e.layerView.layer)}),this.view.on("layerview-create",e=>this.updateLayerView(e.layer,e.layerView)),this.view.on("layerview-destroy",e=>this.updateLayerView(e.layer,null))])}refreshSourceOfLayer(e){for(const[,{snappingSource:t}]of this.snappingSources)t.layerSource.layer===e&&t.refresh()}updateLayerView(e,t){for(const[,i]of this.snappingSources)i.snappingSource.layerSource.layer===e&&(i.layerView=t)}destroy(){this._set("options",null);for(const[,e]of this.snappingSources)e.destroy()}async fetchCandidates(e,t,i){if(!this.options.effectiveFeatureEnabled)return[];const r=[],a={distance:this.computeScreeenSizeDistanceParameters(e,t),point:e,coordinateHelper:t.coordinateHelper,types:this.types,filter:null};for(const[,{snappingSource:s,layerView:o}]of this.snappingSources)!s.layerSource.enabled||Object(S["k"])(o)&&o.suspended||r.push(s.fetchCandidates(a,i).then(({candidates:e})=>e.filter(e=>!this.candidateIsExcluded(s,e,t.excludeFeature))));const n=(await Object(T["l"])(r)).flat();return Object(T["w"])(i),Object(Ue["e"])(e,n),n}computeScreeenSizeDistanceParameters(e,t){const i=this.options.distance*("touch"===t.pointer?this.options.touchSensitivityMultiplier:1);return Object(S["j"])(this.view)?i:"2d"===this.view.type?i*this.view.resolution:this.computeScreeenSizeDistanceParameters3D(e,i,this.view,t)}computeScreeenSizeDistanceParameters3D(e,t,i,r){const{coordinateHelper:a,elevationInfo:n}=r,s=i.state.camera.computeScreenPixelSizeAt(Object(Ue["a"])(e,a,n,i,We))*i.renderCoordsHelper.unitInMeters/i.mapCoordsHelper.unitInMeters,o=t*s;return{x:o/this.computeScreenMagnitudeOfMapOffset(e,s,0,i,r),y:o/this.computeScreenMagnitudeOfMapOffset(e,0,s,i,r)}}computeScreenMagnitudeOfMapOffset(e,t,i,r,{coordinateHelper:a,elevationInfo:n}){const s=a.clone(e);s[0]+=t,s[1]+=i;const o=Object(Ue["b"])(e,a,n,r),c=Object(Ue["b"])(s,a,n,r),l=c.x-o.x,h=c.y-o.y;return Math.sqrt(l*l+h*h)}get types(){return 3}candidateIsExcluded(e,t,i){if(Object(S["j"])(i))return!1;const r=this.getCandidateObjectId(t);if(Object(S["j"])(r))return!1;const a=e.layerSource.layer;return"graphics"===a.type?i.uid===r:i.sourceLayer===a&&!(!i.attributes||!("objectIdField"in a))&&i.attributes[a.objectIdField]===r}getCandidateObjectId(e){return e instanceof He["a"]?e.objectId:null}createSourceInfo(e){const t=this.createFeatureSnappingSourceType(e);if(Object(S["j"])(t))return null;if("loading"in t)return this.updatingHandles.addPromise(t.loading.then(()=>{this.destroyed||this.notifyChange("snappingSources")})),null;const i=Object(S["k"])(this.view)?this.view.allLayerViews.find(t=>t.layer===e.layer):null;return new qe(t.source,i)}createFeatureSnappingSourceType(e){switch(e.layer.type){case"feature":case"geojson":case"csv":return this.createFeatureSnappingSourceFeatureLayer(e);case"graphics":return this.createFeatureSnappingSourceGraphicsLayer(e)}return null}createFeatureSnappingSourceFeatureLayer(e){switch(e.layer.source.type){case"feature-layer":{const t=this.getSourceModule("featureService");return Object(S["k"])(t.module)?{source:new t.module.FeatureServiceSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:e})}:{loading:t.loader}}case"memory":case"csv":case"geojson":{if("mesh"===e.layer.geometryType)return null;const t=this.getSourceModule("featureCollection");return Object(S["k"])(t.module)?{source:new t.module.FeatureCollectionSnappingSource({layerSource:e})}:{loading:t.loader}}}return null}createFeatureSnappingSourceGraphicsLayer(e){const t=this.getSourceModule("graphics");return Object(S["k"])(t.module)?{source:new t.module.GraphicsSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:e})}:{loading:t.loader}}getSourceModule(e){const t=this.sourceModules[e];if(Object(S["j"])(t.loader)){const i=this.loadSourceModule(e).then(e=>{t.module=e});return t.loader=i,{module:t.module,loader:i}}return{module:t.module,loader:t.loader}}loadSourceModule(e){switch(e){case"featureService":return this.updatingHandles.addPromise(i.e("chunk-6b4e548a").then(i.bind(null,"ba80")));case"featureCollection":return this.updatingHandles.addPromise(i.e("chunk-474e6fbb").then(i.bind(null,"2dca")));case"graphics":return this.updatingHandles.addPromise(Promise.all([i.e("chunk-2d0d03a7"),i.e("chunk-31ca1d6f"),i.e("chunk-59bef320")]).then(i.bind(null,"b234")))}return null}};Object(r["a"])([Object(n["b"])({constructOnly:!0})],Ne.prototype,"spatialReference",void 0),Object(r["a"])([Object(n["b"])({constructOnly:!0})],Ne.prototype,"view",void 0),Object(r["a"])([Object(n["b"])()],Ne.prototype,"options",void 0),Object(r["a"])([Object(n["b"])({readOnly:!0})],Ne.prototype,"updating",null),Object(r["a"])([Object(n["b"])({readOnly:!0})],Ne.prototype,"snappingSources",null),Ne=Object(r["a"])([Object(c["a"])("esri.views.interactive.snapping.FeatureSnappingEngine")],Ne);class qe{constructor(e,t){this.snappingSource=e,this.layerView=t,this.handles=new F["a"];const i=this.snappingSource.layerSource.layer;if("refresh"in i){const t=i;this.handles.add(t.on("refresh",()=>e.refresh()))}this.handles.add([Object(z["a"])(e,"updating",t=>e.layerSource.updating=t,!0),Object(z["a"])(e,"availability",t=>e.layerSource.availability=t,!0)])}destroy(){this.snappingSource.destroy(),this.handles.destroy()}}const We=Object(Ge["e"])();var Ze=i("02f1");class $e{constructor(e,t){this.view=e,this.options=t,this.squaredShortLineThreshold=v["a"].shortLineThreshold*v["a"].shortLineThreshold}snap(e,t){return Object(S["k"])(t.vertexHandle)?"vertex"!==t.vertexHandle.type?[]:this.snapExistingVertex(e,t):this.snapNewVertex(e,t)}edgeExceedsShortLineThreshold(e,t){return this.exceedsShortLineThreshold(e.left.pos,e.right.pos,t)}exceedsShortLineThreshold(e,t,{elevationInfo:i,geometry:r}){const a=r.editGeometry.coordinateHelper;return 0===this.squaredShortLineThreshold||Object(Ue["f"])(Object(Ue["b"])(t,a,i,this.view),Object(Ue["b"])(e,a,i,this.view))>this.squaredShortLineThreshold}squaredProximityTreshold(e){return"touch"===e?this.squaredTouchProximityThreshold:this.squaredMouseProximityTreshold}get squaredMouseProximityTreshold(){return this.options.distance*this.options.distance}get squaredTouchProximityThreshold(){const{distance:e,touchSensitivityMultiplier:t}=this.options,i=e*t;return i*i}}var Qe=i("0f94"),Xe=i("38a4"),Ye=i("e6b5"),Ke=i("df3b"),Je=i("43e0");class et extends Ke["a"]{constructor({coordinateHelper:e,lineStart:t,lineEnd:i,targetPoint:r}){super(e,r,new Je["b"](e,t,i)),this.referenceLineHint=new Ye["a"](2,t,i)}get hints(){return[this.referenceLineHint,new Ye["a"](0,this.lineEndClosestToTarget(),this.targetPoint)]}lineEndClosestToTarget(){const e=this.constraint.start,t=this.constraint.end;return Object(Xe["s"])(Object(ze["g"])(Object(ze["d"])(it,t,e),Object(ze["d"])(tt,this.targetPoint,e)))>0?t:e}}const tt=Object(Ze["b"])(),it=Object(Ze["b"])();class rt extends $e{snapNewVertex(e,t){const i=t.geometry.editGeometry.components[0],r=i.edges.length,a=[];if(r<1)return a;const n=t.coordinateHelper,s=Object(Ue["b"])(e,n,t.elevationInfo,this.view),o=i.edges[r-1];let c=o;do{this.edgeExceedsShortLineThreshold(c,t)&&this._processCandidateProposal(c.left.pos,c.right.pos,e,s,t,a),c=c.left.left}while(c&&c!==o);return a}snapExistingVertex(e,t){const i=[],r=Object(S["t"])(t.vertexHandle),a=r.component;if(a.edges.length<2)return i;const n=t.coordinateHelper,s=Object(Ue["b"])(e,n,t.elevationInfo,this.view),o=r.left,c=r.right;o&&c&&this.edgeExceedsShortLineThreshold(o,t)&&this.edgeExceedsShortLineThreshold(c,t)&&this._processCandidateProposal(o.left.pos,c.right.pos,e,s,t,i);const l=a.edges[0];let h=l;do{h!==r.left&&h!==r.right&&this.edgeExceedsShortLineThreshold(h,t)&&this._processCandidateProposal(h.left.pos,h.right.pos,e,s,t,i),h=h.right.right}while(h&&h!==l);return i}_processCandidateProposal(e,t,i,r,a,n){const s=Object(Qe["g"])(Object(Ze["b"])(),i,e,t),o=a.coordinateHelper,c=o.fromXYZ(s,o.getZ(i,0));Object(Ue["f"])(r,Object(Ue["b"])(c,o,a.elevationInfo,this.view))<this.squaredProximityTreshold(a.pointer)&&n.push(new et({coordinateHelper:a.coordinateHelper,lineStart:e,lineEnd:t,targetPoint:c}))}}var at=i("d232");class nt extends Ke["a"]{constructor({coordinateHelper:e,referenceLine:t,lineStart:i,targetPoint:r}){const a=e.clone(i);Object(ze["d"])(a,Object(ze["h"])(a,a,t.right.pos),t.left.pos),super(e,r,new Je["b"](e,i,a)),this._referenceLines=[{edge:t,fadeLeft:!0,fadeRight:!0}]}get hints(){return[new Ye["a"](0,this.constraint.start,this.targetPoint),new at["a"](this.constraint.start,this.targetPoint),...this._referenceLines.map(e=>new Ye["a"](1,e.edge.left.pos,e.edge.right.pos,e.fadeLeft,e.fadeRight))]}addReferenceLine(e){const t={edge:e,fadeLeft:!0,fadeRight:!0};this._referenceLines.forEach(i=>{e.right.right===i.edge&&(i.fadeLeft=!1,t.fadeRight=!1),e.left.left===i.edge&&(i.fadeRight=!1,t.fadeLeft=!1)}),this._referenceLines.push(t)}}class st extends $e{constructor(){super(...arguments),this._tmpProjection=Object(Ze["b"])()}snapNewVertex(e,t){const i=t.geometry.editGeometry.components[0],r=i.edges.length,a=i.vertices.length,n=[];if(r<2)return n;const s=Object(Ue["b"])(e,t.coordinateHelper,t.elevationInfo,this.view),o=i.vertices[a-1],c=i.vertices[0],l=i.edges[r-1];let h=l;do{this.edgeExceedsShortLineThreshold(h,t)&&(this._checkEdgeForParalleLines(h,o.pos,e,s,t,n),this._checkEdgeForParalleLines(h,c.pos,e,s,t,n)),h=h.left.left}while(h&&h!==l);return n}snapExistingVertex(e,t){const i=[],r=Object(S["t"])(t.vertexHandle),a=r.component;if(a.edges.length<3)return i;const n=Object(Ue["b"])(e,t.coordinateHelper,t.elevationInfo,this.view),s=r.left,o=r.right,c=a.vertices[0],l=a.vertices.length,h=a.vertices[l-1],d=a.edges[0];let u=d;do{u!==s&&u!==o&&this.edgeExceedsShortLineThreshold(u,t)&&(s&&this._checkEdgeForParalleLines(u,s.left.pos,e,n,t,i),o&&this._checkEdgeForParalleLines(u,o.right.pos,e,n,t,i),r===c?this._checkEdgeForParalleLines(u,h.pos,e,n,t,i):r===h&&this._checkEdgeForParalleLines(u,c.pos,e,n,t,i)),u=u.right.right}while(u&&u!==d);return i}_checkEdgeForParalleLines(e,t,i,r,a,n){const s=e.left.pos,o=e.right.pos;if(Object(Qe["g"])(this._tmpProjection,t,s,o),Object(ze["j"])(this._tmpProjection,t)<v["a"].parallelLineThreshold)return;Object(Qe["g"])(this._tmpProjection,i,s,o,t);const c=a.coordinateHelper,l=c.fromXYZ(this._tmpProjection,c.getZ(i,0));if(Object(Ue["f"])(r,Object(Ue["b"])(l,c,a.elevationInfo,this.view))<this.squaredProximityTreshold(a.pointer)){if(this.parallelToPreviousCandidate(e,n))return;n.push(new nt({coordinateHelper:c,referenceLine:e,lineStart:t,targetPoint:l}))}}parallelToPreviousCandidate(e,t){const i=e.left.pos,r=e.right.pos;for(const a of t)if(Object(Qe["g"])(this._tmpProjection,r,a.constraint.start,a.constraint.end,i),Object(ze["j"])(this._tmpProjection,r)<v["a"].parallelLineThreshold)return a.addReferenceLine(e),!0;return!1}}var ot=i("5715");class ct extends Ke["a"]{constructor({coordinateHelper:e,targetPoint:t,constraint:i,previousVertex:r,centerVertex:a}){super(e,t,i),this.previousVertex=r,this.centerVertex=a,this.referenceLine=new Ye["a"](1,r,i.start)}get hints(){return[new Ye["a"](0,this.constraint.start,this.targetPoint),this.referenceLine,new ot["a"](this.previousVertex,this.centerVertex,this.targetPoint)]}}class lt extends $e{constructor(){super(...arguments),this._tmp=Object(Ze["b"])()}snapNewVertex(e,t){const i=t.geometry.editGeometry.components[0],r=i.vertices.length,a=[];if(r<2)return a;const n=Object(Ue["b"])(e,t.coordinateHelper,t.elevationInfo,this.view),s=i.vertices[r-1];this._checkForSnappingCandidate(a,s.left,s.pos,e,s.left.left.pos,s.pos,t,e,n);const o=i.vertices[0];return this._checkForSnappingCandidate(a,o.right,o.pos,e,o.right.right.pos,o.pos,t,e,n),a}snapExistingVertex(e,t){const i=[],r=Object(S["t"])(t.vertexHandle),a=r.component,n=a.vertices.length;if(n<3)return i;const s=Object(Ue["b"])(e,t.coordinateHelper,t.elevationInfo,this.view),o=r.left,c=r.right,l=a.vertices[0],h=a.vertices[n-1];if(!o)return this._checkForSnappingCandidate(i,l.right.right.right,l.right.right.pos,e,l.right.right.right.right.pos,l.right.right.pos,t,e,s),i;if(!c)return this._checkForSnappingCandidate(i,h.left.left.left,h.left.left.pos,e,h.left.left.left.left.pos,h.left.left.pos,t,e,s),i;if(o&&o.left.left){const r=o.left.left;this._checkForSnappingCandidate(i,r,o.left.pos,e,r.left.pos,o.left.pos,t,e,s)}if(c&&c.right.right){const r=c.right.right;this._checkForSnappingCandidate(i,r,c.right.pos,e,r.right.pos,c.right.pos,t,e,s)}return i}_checkForSnappingCandidate(e,t,i,r,a,n,s,o,c){if(!this.edgeExceedsShortLineThreshold(t,s))return;Object(ze["d"])(this._tmp,t.right.pos,t.left.pos);const l=Object(Ze["f"])(this._tmp[1],-this._tmp[0]),h=Object(ze["g"])(l,Object(ze["d"])(this._tmp,r,i))/Object(ze["q"])(l),d=s.coordinateHelper,u=d.fromXYZ(Object(ze["p"])(Object(Ze["b"])(),n,l,h),d.getZ(o,0));Object(Ue["f"])(c,Object(Ue["b"])(u,d,s.elevationInfo,this.view))<this.squaredProximityTreshold(s.pointer)&&e.push(new ct({coordinateHelper:d,targetPoint:u,constraint:new Je["e"](d,n,Object(ze["p"])(d.createNew(),n,l,Object(Xe["s"])(h))),previousVertex:a,centerVertex:n}))}}class ht extends Ke["a"]{constructor({coordinateHelper:e,targetPoint:t,point1:i,point2:r}){super(e,t,new Je["c"](e,Object(ze["m"])(dt,i,r,.5),.5*Object(ze["i"])(i,r))),this.p1=i,this.p2=r}get hints(){return[new Ye["a"](1,this.targetPoint,this.p1),new Ye["a"](1,this.targetPoint,this.p2),new ot["a"](this.p1,this.targetPoint,this.p2)]}}const dt=Object(Ze["b"])();class ut extends $e{snapNewVertex(e,t){const i=t.geometry.editGeometry.components[0],r=[],a=i.vertices.length;if("polygon"!==t.geometry.type||a<2)return r;const n=i.vertices[0],s=i.vertices[a-1];return this._processCandidateProposal(n.pos,s.pos,e,t,r),r}snapExistingVertex(e,t){const i=[],r=Object(S["t"])(t.vertexHandle),a=r.component;return a.edges.length<2?i:"polyline"!==t.geometry.type||0!==r.index&&r.index!==a.vertices.length-1?(this._processCandidateProposal(r.left.left.pos,r.right.right.pos,e,t,i),i):i}_processCandidateProposal(e,t,i,r,a){if(!this.exceedsShortLineThreshold(e,t,r))return;const n=Object(ze["m"])(Object(Ze["b"])(),e,t,.5),s=.5*Object(ze["i"])(e,t),o=Object(Qe["f"])(Object(Ze["b"])(),i,n,s),c=r.coordinateHelper,l=c.fromXYZ(o,c.getZ(i,0)),h=Object(Ue["b"])(i,c,r.elevationInfo,this.view);Object(Ue["f"])(h,Object(Ue["b"])(l,c,r.elevationInfo,this.view))<this.squaredProximityTreshold(r.pointer)&&a.push(new ht({coordinateHelper:c,targetPoint:l,point1:e,point2:t}))}}let pt=class extends g["a"]{constructor(e){super(e),this.updating=!1,this._snappers=new h["a"]}initialize(){this._snappers.push(new st(this.view,this.options),new rt(this.view,this.options),new lt(this.view,this.options),new ut(this.view,this.options))}set options(e){this._set("options",e);for(const t of this._snappers)t.options=e}async fetchCandidates(e,t){if(!this.options.effectiveSelfEnabled)return[];const i=[];for(const r of this._snappers.items)i.push(...r.snap(e,t));return Object(Ue["e"])(e,i),i}};Object(r["a"])([Object(n["b"])({readOnly:!0})],pt.prototype,"updating",void 0),Object(r["a"])([Object(n["b"])({constructOnly:!0})],pt.prototype,"view",void 0),Object(r["a"])([Object(n["b"])()],pt.prototype,"options",null),pt=Object(r["a"])([Object(c["a"])("esri.views.interactive.snapping.SelfSnappingEngine")],pt);var ft=i("e753");class mt extends Ke["a"]{constructor(e,t,i,r){super(e,t,new Je["a"](e,t,i.constraint,r.constraint)),this.first=i,this.second=r}get hints(){return this.first.targetPoint=this.targetPoint,this.second.targetPoint=this.targetPoint,[...this.first.hints,...this.second.hints,new ft["a"](this.targetPoint)]}}let bt=class extends(R["a"].EventedMixin(Fe["a"])){constructor(e){super(e),this.options=new w,this.engines=[],this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this.options=new w}initialize(){this.handles.add([Object(Ve["a"])(()=>{const{effectiveFeatureEnabled:e,effectiveSelfEnabled:t,touchSensitivityMultiplier:i,distance:r}=this.options;return{effectiveFeatureEnabled:e,effectiveSelfEnabled:t,touchSensitivityMultiplier:i,distance:r}},()=>{this.doneSnapping(),this.emit("changed")}),this.watch("options",e=>{for(const t of this.engines)t.options=e},!0),Object(z["a"])(this.view,"ready",e=>this.onViewReady(e),!0)])}destroy(){this.destroyEngines()}get updating(){return this.engines.some(e=>e.updating)}onViewReady(e){var t,i;this.destroyEngines(),e&&(this.engines=[new pt({view:this.view,options:this.options}),new Ne({view:this.view,spatialReference:null!=(t=null==(i=this.view)?void 0:i.spatialReference)?t:ke["a"].WGS84,options:this.options})])}destroyEngines(){for(const e of this.engines)e.destroy();this.engines.length=0}get squaredMouseProximityTreshold(){return this.options.distance*this.options.distance}get squaredTouchProximityThreshold(){const{distance:e,touchSensitivityMultiplier:t}=this.options,i=e*t;return i*i}async snap(e,t,i){const r=t.coordinateHelper.fromPoint(e),a=await this.fetchCandidates(r,t,i);return{get valid(){return!Object(T["o"])(i)},apply:()=>{const{snappedPoint:e,hints:i}=this.processCandidates(r,a,t);return this.removeVisualization(),Object(S["k"])(t.visualizer)&&this.handles.add(t.visualizer.draw(i,{coordinateHelper:t.coordinateHelper,elevationInfo:t.elevationInfo,view:this.view}),gt),e}}}update(e,t){this.removeVisualization();let i=e;const r=[];if(Object(S["k"])(this._currentMainCandidate)){const a=t.coordinateHelper,n=a.fromPoint(e),s=this._currentMainCandidate.constraint.closestTo(n);if(Object(Ue["f"])(Object(Ue["b"])(n,a,t.elevationInfo,this.view),Object(Ue["b"])(s,a,t.elevationInfo,this.view))<this.squaredPointProximityThreshold(t.pointer)){i=a.createDehydratedPoint(s),this._currentMainCandidate.targetPoint=s,r.push(...this._currentMainCandidate.hints);for(const e of this._currentOtherActiveCandidates)e.targetPoint=s,r.push(...e.hints)}else this._currentMainCandidate=null,this._currentOtherActiveCandidates=[]}return Object(S["k"])(t.visualizer)&&this.handles.add(t.visualizer.draw(r,{coordinateHelper:t.coordinateHelper,elevationInfo:t.elevationInfo,view:this.view}),gt),i}doneSnapping(){this.removeVisualization(),this._currentMainCandidate=null,this._currentOtherActiveCandidates=[]}removeVisualization(){this.handles.remove(gt)}async fetchCandidates(e,t,i){return(await Promise.all(this.engines.map(r=>r.fetchCandidates(e,t,i)))).flat()}processCandidates(e,t,i){if(t.length<1)return this.doneSnapping(),{snappedPoint:i.coordinateHelper.toPoint(e,new P["a"]),hints:[]};Object(Ue["e"])(e,t);const r=this._currentMainCandidate;if(Object(S["k"])(r)){const a=this.findOldConstraintInNewCandidates(r,t);if(a>=0){if(!(t[a]instanceof mt))return this.intersectWithOtherCandidates(a,t,e,i);if(Object(ze["j"])(e,r.targetPoint)<this.squaredPointProximityThreshold(i.pointer))return this.updateSnappingCandidate(r,t,i)}}return this.intersectWithOtherCandidates(0,t,e,i)}findOldConstraintInNewCandidates(e,t){return e instanceof mt?this.findOldCandidateIndex(t,e.first)>=0&&this.findOldCandidateIndex(t,e.second)>=0?0:-1:this.findOldCandidateIndex(t,e)}intersectWithOtherCandidates(e,t,i,r){const a=t[e],n=[],s=r.coordinateHelper;for(let o=0;o<t.length;++o){if(o===e)continue;const c=t[o];for(const e of a.constraint.intersect(c.constraint)){const t=s.fromXYZ(e.intersection,a.targetPoint[2]);n.push([new mt(s,t,a,c),Object(Ue["f"])(Object(Ue["b"])(i,r.coordinateHelper,r.elevationInfo,this.view),Object(Ue["b"])(t,r.coordinateHelper,r.elevationInfo,this.view))])}}return n.length>0&&(n.sort((e,t)=>e[1]-t[1]),n[0][1]<this.squaredPointProximityThreshold(r.pointer))?this.updateSnappingCandidate(n[0][0],t,r):this.updateSnappingCandidate(a,t,r)}updateSnappingCandidate(e,t,i){this.doneSnapping(),this._currentMainCandidate=e;const r=this._currentMainCandidate.targetPoint,a=[];a.push(...e.hints);for(const n of t){if(e instanceof mt){if(n.constraint.objectEqual(e.first.constraint)||n.constraint.objectEqual(e.second.constraint))continue}else if(n.constraint.objectEqual(e.constraint))continue;n.constraint.check(r)&&(n.targetPoint=r,this._currentOtherActiveCandidates.push(n),a.push(...n.hints))}return{snappedPoint:i.coordinateHelper.createDehydratedPoint(r),hints:a}}squaredPointProximityThreshold(e){return"touch"===e?this.squaredTouchProximityThreshold:this.squaredMouseProximityTreshold}findOldCandidateIndex(e,t){let i=-1;for(let r=0;r<e.length;++r)if(t.constraint.objectEqual(e[r].constraint)){i=r;break}return i}get test(){return{visualizationsActive:this.handles.has(gt)}}};Object(r["a"])([Object(n["b"])({constructOnly:!0})],bt.prototype,"view",void 0),Object(r["a"])([Object(n["b"])()],bt.prototype,"options",void 0),Object(r["a"])([Object(n["b"])({readOnly:!0})],bt.prototype,"updating",null),Object(r["a"])([Object(n["b"])()],bt.prototype,"engines",void 0),Object(r["a"])([Object(n["b"])()],bt.prototype,"squaredMouseProximityTreshold",null),Object(r["a"])([Object(n["b"])()],bt.prototype,"squaredTouchProximityThreshold",null),bt=Object(r["a"])([Object(c["a"])("esri.views.interactive.snapping.SnappingManager")],bt);const gt="visualization-handle";var vt=i("6c97");let yt=class extends R["a"].EventedAccessor{constructor(e){super(e),this.cancelled=!1,this.history={undo:[],redo:[]},this.type=null}get tool(){if(!this.activeComponent)return null;switch(this.activeComponent.type){case"graphic-mover":case"move-3d":return"move";case"box":case"transform-3d":return"transform";case"reshape":case"reshape-3d":return"reshape";case"draw":case"draw-3d":return null;default:Object(vt["a"])(this.activeComponent)}return null}addToHistory(e){this.history.redo=[],this.history.undo.push(e)}resetHistory(){this.history.redo=[],this.history.undo=[]}canUndo(){return this.history.undo.length>0}canRedo(){return this.history.redo.length>0}complete(){this.reset(),this.onEnd(),this.emit("complete")}cancel(){this.cancelled=!0,this.complete()}reset(){this.activeComponent.reset()}refreshComponent(){const e=this.activeComponent;e&&("box"!==e.type&&"reshape"!==e.type||e.refresh())}set undo(e){this._set("undo",()=>{this.canUndo()&&e()})}set redo(e){this._set("redo",()=>{this.canRedo()&&e()})}};Object(r["a"])([Object(n["b"])()],yt.prototype,"activeComponent",void 0),Object(r["a"])([Object(n["b"])()],yt.prototype,"cancelled",void 0),Object(r["a"])([Object(n["b"])()],yt.prototype,"history",void 0),Object(r["a"])([Object(n["b"])()],yt.prototype,"tool",null),Object(r["a"])([Object(n["b"])()],yt.prototype,"type",void 0),Object(r["a"])([Object(n["b"])()],yt.prototype,"canUndo",null),Object(r["a"])([Object(n["b"])()],yt.prototype,"canRedo",null),Object(r["a"])([Object(n["b"])()],yt.prototype,"onEnd",void 0),Object(r["a"])([Object(n["b"])()],yt.prototype,"undo",null),Object(r["a"])([Object(n["b"])()],yt.prototype,"redo",null),Object(r["a"])([Object(n["b"])()],yt.prototype,"toggleTool",void 0),Object(r["a"])([Object(n["b"])()],yt.prototype,"addToSelection",void 0),Object(r["a"])([Object(n["b"])()],yt.prototype,"removeFromSelection",void 0),yt=Object(r["a"])([Object(c["a"])("esri.widgets.Sketch.support.OperationHandle")],yt);const Ot="esri.widgets.Sketch.SketchViewModel",_t=a["a"].getLogger(Ot),xt={redoKey:"r",undoKey:"z",centerKey:"Alt",constraintKey:"Control",snappingKey:"Control",cancelKey:"Escape",deleteKeys:["Backspace","Delete"],complete:"c",pan:" "},jt={defaultZ:0},wt={enableMidpoints:!0,enableMoveAllGraphics:!0,enableRotation:!0,enableScaling:!0,multipleSelectionEnabled:!0,preserveAspectRatio:!1,toggleToolOnClick:!0,tool:"transform",enableZ:!0,enableMoveGraphic:!0};let St=class extends R["a"].EventedAccessor{constructor(e){super(e),this._activeFillGraphic=null,this._activeLineGraphic=null,this._centerIndicatorGraphic=null,this._centerSymbol=new L["a"]({style:"cross",size:6,color:[255,255,255]}),this._defaultSegmentOffset=48,this._numUpdating=0,this._handles=new F["a"],this._internalGraphicsLayer=new G["a"]({listMode:"hide",internal:!0}),this._lineGraphic=null,this._operationHandle=null,this._vertexGraphics=[],this._viewHandles=new F["a"],this._doUnnormalization=!1,this._moveOperationCloneInfos=[],this.activeFillSymbol=new I["a"]({style:"solid",color:[150,150,150,.2],outline:{color:[50,50,50],width:0}}),this.activeLineSymbol=new M["a"]({data:{type:"CIMSymbolReference",symbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",effects:[{type:"CIMGeometricEffectDashes",dashTemplate:[3.75,3.75],lineDashEnding:"HalfPattern",controlPointEnding:"NoConstraint"}],enable:!0,capStyle:"Butt",joinStyle:"Round",miterLimit:10,width:1.6,color:[255,255,255,255]},{type:"CIMSolidStroke",enable:!0,capStyle:"Butt",joinStyle:"Round",miterLimit:10,width:2,color:[0,0,0,255]}]}}}),this.activeVertexSymbol=new L["a"]({style:"circle",size:6,color:[255,127,0,1],outline:{color:[50,50,50],width:1}}),this.layer=null,this.pointSymbol=new L["a"]({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),this.polygonSymbol=new I["a"]({color:[150,150,150,.2],outline:{color:[50,50,50],width:2}}),this.polylineSymbol=new D["a"]({color:[130,130,130,1],width:2}),this._snappingManager=null,this.updateGraphics=new h["a"],this.updateOnGraphicClick=!0,this.updatePointSymbol=new L["a"]({size:10,color:[0,200,255,.5],outline:{color:"black",width:1}}),this.updatePolygonSymbol=new I["a"]({color:[12,207,255,.2],outline:{join:"round",color:[12,207,255],width:2}}),this.updatePolylineSymbol=new D["a"]({color:[12,207,255],width:2}),this.vertexSymbol=new L["a"]({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),this._moduleLoaderAbortController=null,this._viewReadyAbortController=null,this._originalAutoOpenEnabled=null,this.defaultCreateOptions=jt,this.defaultUpdateOptions=wt,this.snappingOptions=new w}initialize(){this._handles.add([Object(z["e"])(this,"layer",()=>{this.cancel(),this._internalGraphicsLayer.elevationInfo=Object(S["k"])(this.layer)?this.layer.elevationInfo:null}),Object(z["b"])(this,"view.map.layers","change",e=>{e.removed.indexOf(this.layer)>=0&&this.cancel()}),Object(z["b"])(this,"layer.graphics","change",e=>{if(Object(S["k"])(this._operationHandle))for(const t of e.removed)this.updateGraphics.includes(t)&&(this.updateGraphics.length>1?this._operationHandle.removeFromSelection(t):this._operationHandle.cancel())}),Object(z["a"])(this,"layer.elevationInfo",()=>{this.cancel(),this._internalGraphicsLayer.elevationInfo=Object(S["k"])(this.layer)?this.layer.elevationInfo:null},!0),Object(z["a"])(this,"view",e=>{Object(S["e"])(this._snappingManager),e&&(this._snappingManager=new bt({view:e,options:this.snappingOptions}))},!0)])}destroy(){this.cancel(),this._handles=Object(S["e"])(this._handles),this._viewHandles=Object(S["e"])(this._viewHandles),this._removeDefaultLayer(),Object(S["e"])(this._draw),Object(S["e"])(this._snappingManager),this._set("view",null),this.emit("destroy")}get _defaultUpdateTool(){return"3d"===this.view.type?"move":"transform"}get _draw(){return"ready"===this.state||"active"===this.state?new Te({view:this.view}):null}get updating(){return this._numUpdating>0}get activeTool(){return this._operationHandle&&this._operationHandle.tool?this._operationHandle.tool:null}get activeComponent(){return this._operationHandle?this._operationHandle.activeComponent:null}get createGraphic(){return this.view&&"3d"===this.view.type&&Object(S["k"])(this.activeComponent)&&"draw-3d"===this.activeComponent.type?Object(S["t"])(this.activeComponent.createGraphic):this._get("createGraphic")}set defaultCreateOptions(e){this._set("defaultCreateOptions",{...jt,...e})}set defaultUpdateOptions(e){this._set("defaultUpdateOptions",{...wt,...e})}set snappingOptions(e){Object(S["k"])(this._snappingManager)&&(this._snappingManager.options=e),this._set("snappingOptions",e)}get state(){var e;const t=!(null==(e=this.view)||!e.ready||!this.layer),i=this._operationHandle;return t&&i?"active":t?"ready":"disabled"}get view(){return this._get("view")}set view(e){const t=this._get("view");if(t){const{container:e,map:i}=t;e&&(t.cursor=null),i&&i.remove(this._internalGraphicsLayer),this._viewHandles.removeAll(),this.cancel()}this._doUnnormalization=null!=e&&"3d"===e.type&&"global"===e.viewingMode;const i="view-ready";this._handles.remove(i),e&&this._handles.add(Object(z["f"])(e,"ready",t=>{this._viewHandles.removeAll(),t&&this._viewHandles.add(this._generateViewHandles(e))},!0),i),this._set("view",e)}cancel(){this._moduleLoaderAbortController=Object(S["a"])(this._moduleLoaderAbortController),this._viewReadyAbortController=Object(S["a"])(this._viewReadyAbortController),this._operationHandle&&this._operationHandle.cancel()}complete(){this._operationHandle&&this._operationHandle.complete()}delete(){const{state:e,updateGraphics:t}=this;if("active"===e&&t.length){const{activeTool:e,layer:i}=this,r=t.toArray();i.removeMany(r),this.cancel(),this._emitDeleteEvent({graphics:r,tool:e})}}async create(e,t){if(await this._waitViewReady(),"disabled"===this.state)throw this.layer||this._logError("sketch:missing-property","Property 'layer' is missing on SketchViewModel."),this.view||this._logError("sketch:missing-property","Property 'view' is missing on SketchViewModel."),Object(T["f"])();if(this.cancel(),!e)return void this._logError("sketch:missing-parameter","Missing parameter 'tool'.");const i=await this._setupCreateOperation(e,t);if(Object(S["j"])(i)||this.destroyed)return;Object(Le["a"])(this.view,this._internalGraphicsLayer);const r=()=>{if(i===this._operationHandle){const t=this.createGraphic,r=this._operationHandle.cancelled;this._operationHandle.destroy(),this._operationHandle=null,this._set("createGraphic",null),this.view&&this.view.map&&this.view.map.remove(this._internalGraphicsLayer),i.cancelled||null==t||this.layer.add(t),this.emit("create",{graphic:t,state:r?"cancel":"complete",tool:e,toolEventInfo:null,type:"create"})}};i.on("complete",r),this._operationHandle=i,this.view.ready&&Object(H["b"])(this.view)&&this.view.focus()}async update(e,t){await this._waitViewReady();const{layer:i,view:r,state:a}=this;if("disabled"===a)throw r||this._logError("sketch:missing-property","Property 'view' is missing on SketchViewModel."),i||this._logError("sketch:missing-property","Property 'layer' is missing on SketchViewModel."),Object(T["f"])();this.cancel();const n=Array.isArray(e)?e:[e];if(null==e||!n||!n.length)return void this._logError("sketch:missing-parameter","Missing parameter 'graphics'.");if(n.some(e=>e.layer!==i?(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics missing from the supplied GraphicsLayer."),!0):Object(S["j"])(e.geometry)?(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with an unsupported geometry."),!0):"2d"===r.type&&!r.spatialReference.equals(e.geometry.spatialReference)&&(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with a spatial reference different from the supplied MapView."),!0)))return;const s=await this._setupUpdateOperation(n,t);this.destroyed||Object(S["j"])(s)||Rt(s)||(Object(Le["a"])(this.view,this._internalGraphicsLayer),this._setUpdateOperationHandle(s,t),this.emit("update",{graphics:n,state:"start",aborted:!1,tool:s.tool,toolEventInfo:null,type:"update"}))}undo(){this.canUndo()&&this._operationHandle.undo()}redo(){this.canRedo()&&this._operationHandle.redo()}canUndo(){return!(!this._operationHandle||!this._operationHandle.canUndo())}canRedo(){return!(!this._operationHandle||!this._operationHandle.canRedo())}toggleUpdateTool(){this._operationHandle&&this._operationHandle.toggleTool&&this._operationHandle.toggleTool()}async _getFirstHit(e){const t=[];switch(this.view.type){case"2d":{const a=await this.view.hitTest(e);if(a.results.length>0){const e=a.results[0];if(e.graphic){var i,r;const a=e.graphic;"vector-tile"!==(null==(i=a.layer)?void 0:i.type)&&"imagery"!==(null==(r=a.layer)?void 0:r.type)&&t.push(e)}}}break;case"3d":{const i=[this.view.map.ground];this.view.map.allLayers.forEach(e=>{"integrated-mesh"===e.type&&i.push(e)});const r=await this.view.hitTest(e,{exclude:i});if(r.results.length>0){const e=r.results[0];(!r.ground.mapPoint||this.view.map.ground.opacity<1||r.ground.distance-e.distance>-Math.min(3*r.ground.distance,"global"===this.view.viewingMode?Object(U["e"])(this.view.renderCoordsHelper.spatialReference).radius/this.view.renderCoordsHelper.unitInMeters:Number.POSITIVE_INFINITY))&&t.push(e)}}}return{screenPoint:e,results:t}}_generateViewHandles(e){return[e.on("immediate-click",t=>{const{_operationHandle:i,defaultUpdateOptions:r,layer:a,state:n,updateGraphics:s,updateOnGraphicClick:o}=this,c="active"===n&&"create"===i.type;"disabled"!==n&&!c&&o&&(this._beginAsyncOperation(),this._getFirstHit(Object(N["a"])(t)).then(i=>{const r=i.results;if(r.length)for(let o=0;o<r.length;++o){const i=r[o];if(i.graphic){const r=i.graphic;if(s.indexOf(r)>-1||r.layer===a)return t.stopPropagation(),r;"2d"!==e.type||this._isComponentGraphic(r)||"active"!==n||this.cancel()}}else"active"===n&&this.cancel();return null}).then(e=>Object(S["k"])(e)&&-1===s.indexOf(e)?this.update([e],{...r}):null).then(()=>{this._endAsyncOperation()}))},B["b"].WIDGET)]}async _setupCreateOperation(e,t){if(!e)return null;const i={hasZ:"3d"===this.view.type,...this.defaultCreateOptions,...t};let r;if("2d"===this.view.type)switch(e){case"point":r=this._setupCreatePointOperation(e,i);break;case"multipoint":r=await this._setupCreateMultipointOperation(e,i);break;case"polygon":case"polyline":r=await this._setupCreatePolyOperation(e,i);break;case"rectangle":r=await this._setupCreateRectangleOperation(e,i);break;case"circle":r=await this._setupCreateCircleOperation(e,i)}else{const t=await this._setupCreate3DOperation(e,this.view,i);if(Object(S["j"])(t)||Rt(t))return null;r=t}return r}async _setupCreate3DOperation(e,t,r){if("multipoint"===e)return null;const a={point:this.pointSymbol,multipoint:null,polyline:this.polylineSymbol,polygon:this.polygonSymbol,rectangle:this.polygonSymbol,circle:this.polygonSymbol}[e];this._removeCreateOperationGraphics();const n="rectangle"!==e,s="rectangle"!==e;this.snappingOptions.enabledToggled=!1;const o={view:t,mode:"rectangle"===e||"circle"===e?"hybrid":"click",...r,elevationInfo:this.layer.elevationInfo,geometryType:e,createGraphicSymbol:a,snapToScene:!Object(S["k"])(this.layer.elevationInfo)||"absolute-height"===this.layer.elevationInfo.mode,snappingManager:this._snappingManager,forceUniformSize:s,centered:n},c=await this._requireModule(Promise.all([i.e("chunk-2d22cf8c"),i.e("chunk-5fc30fdb")]).then(i.bind(null,"438e")));if(Rt(c))return c;if(this.destroyed)return null;const l=new c.module.DrawGraphicTool(o);this.view.tools.add(l);let h=null;this.view.activeTool=l;const d=[],u=new yt({activeComponent:l,tool:e,type:"update",onEnd:()=>{var e;d.forEach(e=>e.remove()),d.length=0,null==(e=this.view.tools)||e.remove(l),l.destroy()},undo:()=>{l.canUndo&&l.undo()},redo:()=>{l.canRedo&&l.redo()},canUndo:()=>l.canUndo,canRedo:()=>l.canRedo});return d.push(this.view.on("key-down",t=>{t.key===xt.pan?(t.stopPropagation(),t.repeat||(l.enabled=!1)):t.key===xt.complete?(t.stopPropagation(),l.completeCreateOperation()):t.key===xt.undoKey?(t.stopPropagation(),u.undo()):t.key===xt.redoKey?(t.stopPropagation(),u.redo()):t.key!==xt.snappingKey||"rectangle"===e||"circle"===e||t.repeat?t.key!==xt.constraintKey||"rectangle"!==e&&"circle"!==e||t.repeat?t.key===xt.centerKey&&(t.repeat||(l.centered=!n,t.stopPropagation())):(l.forceUniformSize=!s,t.stopPropagation()):(this.snappingOptions.enabledToggled=!0,t.stopPropagation())},B["b"].WIDGET),this.view.on("key-up",t=>{t.key===xt.pan?l.enabled=!0:t.key===xt.snappingKey&&"rectangle"!==e&&"circle"!==e?(this.snappingOptions.enabledToggled=!1,t.stopPropagation()):t.key!==xt.constraintKey||"rectangle"!==e&&"circle"!==e?t.key===xt.centerKey&&(l.centered=n,t.stopPropagation()):(l.forceUniformSize=s,t.stopPropagation())},B["b"].WIDGET),l.on("vertex-add",t=>{switch(h=Object(S["j"])(h)?"start":"active",t.operation){case"apply":this.emit("create",{graphic:Object(S["t"])(l.createGraphic),state:h,tool:this.activeTool,toolEventInfo:t,type:"create"});break;case"undo":this._emitUndoEvent({graphics:[Object(S["t"])(l.createGraphic)],tool:e});break;case"redo":this._emitRedoEvent({graphics:[Object(S["t"])(l.createGraphic)],tool:e})}}),l.on("cursor-update",e=>{l.drawOperation.numCommittedVertices>0&&this.emit("create",{graphic:Object(S["t"])(l.createGraphic),state:"active",tool:this.activeTool,toolEventInfo:{coordinates:e.vertices[0].coordinates,type:"cursor-update"},type:"create"})}),l.on("vertex-remove",t=>{switch(t.operation){case"apply":this.emit("create",{graphic:Object(S["t"])(l.createGraphic),state:"active",tool:this.activeTool,toolEventInfo:t,type:"create"});break;case"undo":this._emitUndoEvent({graphics:[Object(S["t"])(l.createGraphic)],tool:e});break;case"redo":this._emitRedoEvent({graphics:[Object(S["t"])(l.createGraphic)],tool:e})}}),l.on("complete",e=>{this._removeCreateOperationGraphics(),this._set("createGraphic",Object(S["t"])(e.graphic)),h="complete",e.aborted?u&&u.cancel():u&&u.complete()})),u}_setupCreatePointOperation(e,t){const i={elevationInfo:this.layer.elevationInfo,hasZ:t.hasZ,defaultZ:t.defaultZ,snappingManager:this._snappingManager,interactiveUndoDisabled:!0},r=this._draw.create(e,i),a=[r.on("cursor-update",e=>{Object(S["k"])(e.vertexIndex)?this._displayCrosshairCursor():this._displayDefaultCursor()}),r.on("draw-complete",e=>{const t=this.createPointFromVertex(e.vertices[0]),i=new k["a"](t,this.pointSymbol);this._set("createGraphic",i),s&&s.complete()})],n=[this.view.on("key-down",e=>{e.key===xt.cancelKey&&(s&&s.cancel(),e.stopPropagation())},B["b"].WIDGET)],s=this._operationHandleForCreateAction(r,[...a,...n],e);return s}async _setupCreateMultipointOperation(e,t){const i=await Ie(),r={...t,elevationInfo:this.layer.elevationInfo,snappingManager:this._snappingManager,interactiveUndoDisabled:!0},a=this._draw.create(e,r);let n=null;const s=[],o=this._operationHandleForCreateAction(a,s,e);return s.push(a.on("vertex-add",t=>{const{type:r,vertexIndex:a,vertices:s}=t,o=s[a];n=t,this._drawMultipointGraphic(i,s,!0),this.emit("create",{graphic:this.createGraphic,state:1===s.length?"start":"active",tool:e,toolEventInfo:{added:o,vertices:[{coordinates:o,componentIndex:0,vertexIndex:a}],type:r},type:"create"})}),a.on("vertex-remove",t=>{const{type:r,vertexIndex:a,vertices:s}=t,o=s[a];n=t,this._drawMultipointGraphic(i,s,!0),this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{removed:o,vertices:[{coordinates:o,componentIndex:0,vertexIndex:a}],type:r},type:"create"})}),a.on("vertex-update",t=>{const{type:r,vertexIndex:a,vertices:s}=t,o=s[a];n=t,this._drawMultipointGraphic(i,s,!0),this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{type:r,updated:o,vertices:[{coordinates:o,componentIndex:0,vertexIndex:a}]},type:"create"})}),a.on("cursor-update",e=>{n=e}),a.on("draw-complete",e=>{const t=e.vertices.slice(0),r=i.createMultipoint(t,this.view.spatialReference);r&&this.createGraphic&&(this.createGraphic.geometry=r),o&&o.complete()}),a.on("undo",e=>{const t=e.vertices,r=n&&"cursor-update"!==n.type;this._resetCreateOperationGraphics(),t.length&&this._drawMultipointGraphic(i,t,r)}),a.on("redo",e=>{const t=e.vertices,r=n&&"cursor-update"!==n.type;this._resetCreateOperationGraphics(),t.length&&this._drawMultipointGraphic(i,t,r)})),s.push(this.view.on("pointer-move",()=>this._displayCrosshairCursor(),B["b"].WIDGET),this.view.on("key-down",e=>this._getCommonUpdateOperationKeyDownHandlers(o,e),B["b"].WIDGET)),o}async _setupCreatePolyOperation(e,t){const i=await Ie(),r={...t,elevationInfo:this.layer.elevationInfo,snappingManager:this._snappingManager,interactiveUndoDisabled:!0};let a=null;("polyline"===e||"polygon"===e)&&(a=this._draw.create(e,r));let n=null;const s=[a.on("vertex-add",t=>{const{type:r,vertexIndex:a,vertices:s}=t,o=s[a];this._snapLastPolygonVertexToFirst(e,s),n=t,this._drawVertexGraphics(i,e,s,{userClicked:!0}),this.emit("create",{graphic:this.createGraphic,state:1===s.length?"start":"active",tool:e,toolEventInfo:{added:o,vertices:[{coordinates:o,componentIndex:0,vertexIndex:a}],type:r},type:"create"})}),a.on("vertex-remove",t=>{const{type:r,vertexIndex:a,vertices:s}=t,o=s[a];this._snapLastPolygonVertexToFirst(e,s),n=t,this._drawVertexGraphics(i,e,s,{userClicked:!0}),this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{removed:o,vertices:[{coordinates:o,componentIndex:0,vertexIndex:a}],type:r},type:"create"})}),a.on("vertex-update",t=>{const{type:r,vertexIndex:a,vertices:s}=t,o=s[a];this._snapLastPolygonVertexToFirst(e,s),n=t,this._drawVertexGraphics(i,e,s,{userClicked:!0}),this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{type:r,updated:o,vertices:[{coordinates:o,componentIndex:0,vertexIndex:a}]},type:"create"})}),a.on("cursor-update",t=>{const{type:r,vertices:a}=t;if(t.mapPoint&&(this._snapLastPolygonVertexToFirst(e,a),n=t,this._drawVertexGraphics(i,e,a,{userClicked:!1}),a.length>1)){const t=a[a.length-1];this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{coordinates:t,type:r},type:"create"})}}),a.on("draw-complete",t=>{const r=t.vertices.slice(0);let a=null;"polyline"===e?a=i.createPolyline([r],this.view.spatialReference,this._doUnnormalization):"polygon"===e&&(a=i.createPolygon([r],this.view.spatialReference,this._doUnnormalization,!0)),a&&(this.createGraphic.geometry=a),c&&c.complete()}),a.on("undo",t=>{const r=t.vertices,a=n&&"cursor-update"!==n.type;this._resetCreateOperationGraphics(),this._snapLastPolygonVertexToFirst(e,r),r.length&&this._drawVertexGraphics(i,e,r,{userClicked:a})}),a.on("redo",t=>{const r=t.vertices,a=n&&"cursor-update"!==n.type;this._resetCreateOperationGraphics(),this._snapLastPolygonVertexToFirst(e,r),r.length&&this._drawVertexGraphics(i,e,r,{userClicked:a})})],o=[this.view.on("pointer-move",e=>{Object(S["k"])(a.getCoordsFromScreenPoint(Object(E["f"])(e.x,e.y)))?this._displayCrosshairCursor():this._displayDefaultCursor()},B["b"].WIDGET),this.view.on("key-down",e=>{e.key!==xt.snappingKey||e.repeat?e.key===xt.undoKey&&c&&c.canUndo()?(e.stopPropagation(),c.undo()):e.key===xt.redoKey&&c&&c.canRedo()?(e.stopPropagation(),c.redo()):e.key===xt.cancelKey&&c&&c.cancel():(this.snappingOptions.enabledToggled=!0,e.stopPropagation())},B["b"].WIDGET),this.view.on("key-up",e=>{e.key===xt.snappingKey&&(this.snappingOptions.enabledToggled=!1,e.stopPropagation())},B["b"].WIDGET)];if("polygon"===e){const e=(e,t,i)=>{if(!e||!e.layer||!e.visible)return!1;const r=this.view.toScreen(e.geometry);return this._isWithinScreenDistance(r,t,i)},t=t=>{if(!(this._vertexGraphics.length<=2))return e(this._vertexGraphics[0],t,this._getVertexIntersectDistance())};let i=!1;o.push(this.view.on("pointer-move",()=>{i=!1},B["b"].WIDGET),this.view.on("pointer-down",r=>{if(t(r))return i=!0,void r.stopPropagation();this._vertexGraphics.some(t=>e(t,r,this._getVertexIntersectDistance()))&&r.stopPropagation()},B["b"].WIDGET),this.view.on("pointer-up",e=>{i&&(e.stopPropagation(),a.complete())}))}const c=this._operationHandleForCreateAction(a,[...s,...o],e);return c}async _setupCreateCircleOperation(e,t){const i=await Ie(),r={...t,elevationInfo:this.layer.elevationInfo,snappingManager:this._snappingManager,interactiveUndoDisabled:!0},a=this._draw.create(e,r);let n=!1,s=!0;const o=[a.on("vertex-add",t=>{const{type:r,vertexIndex:o,vertices:c}=t,l=c[o];this._drawSegmentGraphic(i,e,c,{centered:s,constrainToggle:n},a.viewAlignedCoordinateSystem),this.emit("create",{graphic:this.createGraphic,state:1===c.length?"start":"active",tool:e,toolEventInfo:{added:l,vertices:[{coordinates:l,componentIndex:0,vertexIndex:o}],type:r},type:"create"})}),a.on("cursor-update",t=>{const{type:r,vertices:o}=t;if(this._drawSegmentGraphic(i,e,o,{centered:s,constrainToggle:n},a.viewAlignedCoordinateSystem),2===o.length){const t=o[o.length-1];this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{coordinates:t,type:r},type:"create"})}}),a.on("draw-complete",e=>{const t=e.vertices.slice(0);let r;1===t.length?(t.push(a.viewAlignedCoordinateSystem.makeMapPoint(t[0][0]+this._defaultSegmentOffset*this.view.resolution,t[0][1])),r=i.createCircle(t,a.viewAlignedCoordinateSystem,!0,this.view.resolution)):r=n?i.createEllipse(t,a.viewAlignedCoordinateSystem,s):i.createCircle(t,a.viewAlignedCoordinateSystem,s,this.view.resolution),this.createGraphic?this.createGraphic.geometry=r:(this._removeCreateGraphic(),this._set("createGraphic",new k["a"](r,this.polygonSymbol))),l&&l.complete()})],c=[this.view.on("pointer-move",e=>{Object(S["k"])(a.getCoordsFromScreenPoint(Object(E["f"])(e.x,e.y)))?this._displayCrosshairCursor():this._displayDefaultCursor()},B["b"].WIDGET),this.view.on("key-down",t=>{t.key===xt.constraintKey?n||(n=!0,this._drawSegmentGraphic(i,e,a.vertices,{centered:s,constrainToggle:n},a.viewAlignedCoordinateSystem)):t.key===xt.centerKey?s&&(s=!1,this._drawSegmentGraphic(i,e,a.vertices,{centered:s,constrainToggle:n},a.viewAlignedCoordinateSystem)):t.key===xt.cancelKey&&l&&l.cancel()},B["b"].WIDGET),this.view.on("key-up",t=>{t.key===xt.constraintKey?(n=!1,this._drawSegmentGraphic(i,e,a.vertices,{centered:s,constrainToggle:n},a.viewAlignedCoordinateSystem)):t.key===xt.centerKey&&(s=!0,this._drawSegmentGraphic(i,e,a.vertices,{centered:s,constrainToggle:n},a.viewAlignedCoordinateSystem))},B["b"].WIDGET)],l=this._operationHandleForCreateAction(a,[...o,...c],e);return l}async _setupCreateRectangleOperation(e,t){const i=await Ie(),r={...t,elevationInfo:this.layer.elevationInfo,snappingManager:this._snappingManager,interactiveUndoDisabled:!0},a=this._draw.create(e,r);let n=!1,s=!1;const o=[a.on("vertex-add",t=>{const{type:r,vertexIndex:o,vertices:c}=t,l=c[o];this._drawSegmentGraphic(i,e,c,{centered:s,constrainToggle:n},a.viewAlignedCoordinateSystem),this.emit("create",{graphic:this.createGraphic,state:1===c.length?"start":"active",tool:e,toolEventInfo:{added:l,vertices:[{coordinates:l,componentIndex:0,vertexIndex:o}],type:r},type:"create"})}),a.on("cursor-update",t=>{const{type:r,vertices:o}=t;if(this._drawSegmentGraphic(i,e,o,{centered:s,constrainToggle:n},a.viewAlignedCoordinateSystem),2===o.length){const t=o[o.length-1];this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{coordinates:t,type:r},type:"create"})}}),a.on("draw-complete",e=>{const t=e.vertices.slice(0);let r=null;1===t.length&&(n=!1,s=!1),r=n?i.createSquare(t,a.viewAlignedCoordinateSystem,s):i.createRectangle(t,a.viewAlignedCoordinateSystem,s),this.createGraphic?this.createGraphic.geometry=r:(this._removeCreateGraphic(),this._set("createGraphic",new k["a"](r,this.polygonSymbol))),l&&l.complete()})],c=[this.view.on("pointer-move",e=>{Object(S["k"])(a.getCoordsFromScreenPoint(Object(E["f"])(e.x,e.y)))?this._displayCrosshairCursor():this._displayDefaultCursor()},B["b"].WIDGET),this.view.on("key-down",t=>{t.key===xt.constraintKey?n||(n=!0,this._drawSegmentGraphic(i,e,a.vertices,{centered:s,constrainToggle:n},a.viewAlignedCoordinateSystem)):t.key===xt.centerKey?s||(s=!0,this._drawSegmentGraphic(i,e,a.vertices,{centered:s,constrainToggle:n},a.viewAlignedCoordinateSystem)):t.key===xt.cancelKey&&l&&l.cancel()},B["b"].WIDGET),this.view.on("key-up",t=>{t.key===xt.constraintKey?(n=!1,this._drawSegmentGraphic(i,e,a.vertices,{centered:s,constrainToggle:n},a.viewAlignedCoordinateSystem)):t.key===xt.centerKey&&(s=!1,this._drawSegmentGraphic(i,e,a.vertices,{centered:s,constrainToggle:n},a.viewAlignedCoordinateSystem))},B["b"].WIDGET)],l=this._operationHandleForCreateAction(a,[...o,...c],e);return l}async _setupUpdateOperation(e,t){const{_defaultUpdateTool:i,defaultUpdateOptions:r,layer:a,view:n}=this,s={...r,...t},o=s.tool||i;for(const c of e)a.remove(c),a.add(c);if("3d"===n.type){if(0===e.length)return null;switch(o){case"move":return this._setupMove3DOperation(e,s,n,o);case"reshape":{if(e.length>1)return this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),null;const t=Object(Re["a"])(e[0]);return 0===t?this._setupReshape3DOperation(e[0],s,n):(this._logError("sketch:reshape",`Reshape operation not supported for provided graphic(s) (${Pe(t)}).`),null)}case"transform":return this._setupGraphicTransform3DOperation(e,s,n)}}if("move"===o)return this._setupMoveOperation(e,s,n);if(e.length>1)return"reshape"===o?(this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),null):this._setupTransformOrReshapeOperation(e,o,s,n);if(1===e.length){const t=e[0],i=Object(S["i"])(t.geometry,"type");if("point"===i||"multipoint"===i)return this._setupMoveOperation(e,s,n);if("transform"===o||"reshape"===o)return this._setupTransformOrReshapeOperation(e,o,s,n)}return null}async _setupMove3DOperation(e,t,r,a,n=!1){for(const i of e){const e=Object(Ae["a"])(i);if(0!==e)return this._logError("sketch:move",`Move operation not supported for provided graphic(s) (${Pe(e)}).`),null}const s=await this._requireModule(Promise.all([i.e("chunk-2d22cf8c"),i.e("chunk-5fc30fdb")]).then(i.bind(null,"438e")));if(Rt(s))return s;const o=new s.module.GraphicMoveTool({view:r,enableZ:t.enableZ,snappingManager:this._snappingManager});this.view.tools.add(o),o.graphics.addMany(e),n||this.updateGraphics.addMany(e);const c=[],l=new yt({activeComponent:o,tool:a,type:"update",onEnd:()=>{var e;c.forEach(e=>e.remove()),c.length=0,null==(e=this.view.tools)||e.remove(o),o.destroyed||o.destroy()},undo:()=>{Ct(l,this.updateGraphics.toArray()),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:a})},redo:()=>{Tt(l,this.updateGraphics.toArray()),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:a})},addToSelection:e=>{this.updateGraphics.push(e),o.graphics.push(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:e=>{const t=this.updateGraphics.indexOf(e);l.history.undo.forEach(e=>e.updates.splice(t,1)),l.history.redo.forEach(e=>e.updates.splice(t,1)),this.updateGraphics.remove(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),0!==this.updateGraphics.length?o.graphics.remove(e):l.complete()},toggleTool:async()=>{if(1!==this.updateGraphics.length||!1===t.toggleToolOnClick)return;if("transform"!==a)return;const e=this.updateGraphics.getItemAt(0);if(0!==Object(Re["a"])(e))return;const i=await this._setupReshape3DOperation(e,t,r,!0);Rt(i)||(l.onEnd(),l.destroy(),this._setUpdateOperationHandle(i,t))}});return c.push(...this._getHandlesForComponent(l,t),this.view.on("immediate-click",e=>this._getCommonUpdateOperationClickHandlers(l,e,t),B["b"].WIDGET),this.view.on("key-down",e=>this._getCommonUpdateOperationKeyDownHandlers(l,e),B["b"].WIDGET)),l}_setupGraphicTransform3DOperation(e,t,i,r=!1){if(1===e.length&&0===Ee(e[0])){const a=e[0];if(Object(S["k"])(a.geometry)&&"point"===a.geometry.type)return this._setupPointTransform3DOperation(a,t,i);if(Object(S["k"])(a.geometry)&&("polygon"===a.geometry.type||"polyline"===a.geometry.type))return this._setupPolyTransform3DOperation(a,t,i,r)}return this._setupMove3DOperation(e,t,i,"transform",r)}async _setupPointTransform3DOperation(e,t,r){const a="transform",{enableRotation:n,enableScaling:s,enableZ:o}=t,c=await this._requireModule(Promise.all([i.e("chunk-2d22cf8c"),i.e("chunk-5fc30fdb")]).then(i.bind(null,"438e")));if(Rt(c))return c;const l=new c.module.GraphicTransformTool({graphic:e,view:r,enableRotation:n,enableScaling:s,enableZ:o,snappingManager:this._snappingManager});this.view.tools.add(l),this.updateGraphics.add(e);const h=[],d=new yt({activeComponent:l,tool:a,type:"update",onEnd:()=>{var e;h.forEach(e=>e.remove()),h.length=0,null==(e=this.view.tools)||e.remove(l),l.destroyed||l.destroy()},undo:()=>{Ct(d,this.updateGraphics.toArray()),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:a})},redo:()=>{Tt(d,this.updateGraphics.toArray()),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:a})},addToSelection:async e=>{this.updateGraphics.add(e);const i=await this._setupMove3DOperation(this.updateGraphics.toArray(),t,r,"transform",!0);Rt(i)||(d.onEnd(),d.destroy(),this._setUpdateOperationHandle(i,t))}});return h.push(...this._getHandlesForComponent(d,t),this.view.on("immediate-click",e=>this._getCommonUpdateOperationClickHandlers(d,e,t),B["b"].WIDGET),this.view.on("key-down",e=>this._getCommonUpdateOperationKeyDownHandlers(d,e),B["b"].WIDGET)),d}async _setupPolyTransform3DOperation(e,t,r,a=!1){const n="transform",{enableRotation:s,enableScaling:o,enableZ:c,preserveAspectRatio:l}=t,h=await this._requireModule(Promise.all([i.e("chunk-2d22cf8c"),i.e("chunk-5fc30fdb")]).then(i.bind(null,"438e")));if(Rt(h))return h;const d=new h.module.ExtentTransformTool({graphic:e,view:r,enableRotation:s,enableScaling:o,enableZ:c,preserveAspectRatio:l});this.view.tools.add(d),a||this.updateGraphics.add(e);const u=[],p=new yt({activeComponent:d,tool:n,type:"update",onEnd:()=>{var e;u.forEach(e=>e.remove()),u.length=0,null==(e=this.view.tools)||e.remove(d),d.destroyed||d.destroy()},canUndo:()=>d.canUndo(),undo:()=>{d.undo(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:n})},canRedo:()=>d.canRedo(),redo:()=>{d.redo(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:n})},addToSelection:async e=>{this.updateGraphics.add(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"});const i=await this._setupMove3DOperation(this.updateGraphics.toArray(),t,r,"transform",!0);Rt(i)||(p.onEnd(),p.destroy(),this._setUpdateOperationHandle(i,t))},removeFromSelection:async e=>{this.updateGraphics.remove(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),p.complete()},toggleTool:async()=>{if(1!==this.updateGraphics.length||!1===t.toggleToolOnClick)return;const e=this.updateGraphics.getItemAt(0);if(0!==Object(Re["a"])(e))return;const i=await this._setupReshape3DOperation(e,t,r,!0);Rt(i)||(p.onEnd(),p.destroy(),this._setUpdateOperationHandle(i,t))}});return u.push(...this._getHandlesForComponent(p,t),this.view.on("immediate-click",e=>this._getCommonUpdateOperationClickHandlers(p,e,t),B["b"].WIDGET),this.view.on("key-down",e=>this._getCommonUpdateOperationKeyDownHandlers(p,e),B["b"].WIDGET),this.view.on("key-down",e=>{e.key!==xt.constraintKey||e.repeat||(d.preserveAspectRatio=!d.preserveAspectRatio,e.stopPropagation())},B["b"].WIDGET),this.view.on("key-up",e=>{e.key===xt.constraintKey&&(d.preserveAspectRatio=!d.preserveAspectRatio,e.stopPropagation())},B["b"].WIDGET)),p}async _setupMoveOperation(e,t,i){const r="move";this.updateGraphics.addMany(e);const a=await this._getGraphicMover(e,t,i);if(Rt(a))return a;this._syncCloneInfos();const n=new yt({activeComponent:a,tool:r,type:"update",onEnd:()=>{var e;this._displayDefaultCursor(),o.forEach(e=>e.remove()),s.forEach(e=>e.remove()),o=[],s=[],a.destroy(),null==(e=this._internalGraphicsLayer)||e.removeMany([...this.updateGraphics.toArray()]),this._removeCloneGraphics()},undo:()=>{const e=this.updateGraphics.toArray();Ct(n,e),this._syncCloneInfos(),this._emitUndoEvent({graphics:e,tool:r})},redo:()=>{const e=this.updateGraphics.toArray();Tt(n,e),this._syncCloneInfos(),this._emitRedoEvent({graphics:e,tool:r})},addToSelection:e=>{this.updateGraphics.push(e),a.graphics=this.updateGraphics.toArray();const t=this._createClone(e);this._moveOperationCloneInfos.push({graphic:e,clone:t}),this._internalGraphicsLayer.add(t),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:e=>{const t=this.updateGraphics.indexOf(e);n.history.undo.forEach(e=>e.updates.splice(t,1)),n.history.redo.forEach(e=>e.updates.splice(t,1));const i=this._moveOperationCloneInfos.findIndex(t=>t.graphic===e),r=this._moveOperationCloneInfos[i];this._internalGraphicsLayer.remove(r.clone),this.updateGraphics.remove(e),this._moveOperationCloneInfos.splice(i,1);const s=this.updateGraphics.toArray();this.emit("update",{graphics:s,state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),0!==this.updateGraphics.length?a.graphics=s:n.complete()}});let s=[i.on("immediate-click",e=>this._getCommonUpdateOperationClickHandlers(n,e,t),B["b"].WIDGET),i.on("key-down",e=>{this._getCommonUpdateOperationKeyDownHandlers(n,e),e.key!==xt.constraintKey||e.repeat||(a.enableMoveAllGraphics=!a.enableMoveAllGraphics)},B["b"].WIDGET),i.on("key-up",e=>{e.key===xt.constraintKey&&(a.enableMoveAllGraphics=!a.enableMoveAllGraphics)},B["b"].WIDGET)],o=this._getHandlesForComponent(n,t);return o.push(a.on("graphic-move",e=>{this._moveOperationCloneInfos.forEach(t=>{const i=e.allGraphics.find(e=>e===t.graphic);i&&(t.clone.geometry=i.geometry)})})),n}_removeCloneGraphics(){if(this._moveOperationCloneInfos.length){for(const{clone:e}of this._moveOperationCloneInfos)this._internalGraphicsLayer.remove(e),e.destroy();this._moveOperationCloneInfos=[]}}_syncCloneInfos(){this._removeCloneGraphics(),this._moveOperationCloneInfos=this._generateCloneInfos(this.updateGraphics.toArray());for(const{clone:e}of this._moveOperationCloneInfos)this._internalGraphicsLayer.add(e)}_generateCloneInfos(e){return(null==e?void 0:e.map(e=>({graphic:e,clone:this._createClone(e)})))||[]}_createClone(e){const t=e.clone();return t.symbol=this._getSymbolForClone(e),t}_getSymbolForClone(e){const t=12;if(Object(S["j"])(e.symbol))return null;switch(e.symbol.type){case"cim":return new L["a"]({style:"circle",size:t,color:[0,0,0,0],outline:{color:[255,127,0,1],width:1}});case"picture-marker":{const{xoffset:t,yoffset:i,height:r,width:a}=e.symbol,n=r===a?a:Math.max(r,a);return new L["a"]({xoffset:t,yoffset:i,size:n,style:"square",color:[0,0,0,0],outline:{color:[255,127,0,1],width:1}})}case"simple-marker":{const{xoffset:t,yoffset:i,size:r,style:a}=e.symbol;return new L["a"]({xoffset:t,yoffset:i,style:"circle"===a?"circle":"square",size:r+2,color:[0,0,0,0],outline:{color:[255,127,0,1],width:1}})}case"simple-fill":return new I["a"]({color:[0,0,0,0],outline:{style:"dash",color:[255,127,0,1],width:1}});case"simple-line":return new D["a"]({color:[255,127,0,1],style:"dash",width:1});case"text":{const{xoffset:i,yoffset:r}=e.symbol;return new L["a"]({xoffset:i,yoffset:r,size:t,color:[0,0,0,0],outline:{color:[255,127,0,1],width:1}})}default:return null}}async _setupReshape3DOperation(e,t,r,a=!1){const n="reshape",s=await this._requireModule(Promise.all([i.e("chunk-2d22cf8c"),i.e("chunk-5fc30fdb")]).then(i.bind(null,"438e")));if(Rt(s))return s;this.snappingOptions.enabledToggled=!1;const o=new s.module.GraphicReshapeTool({view:r,graphic:e,enableZ:t.enableZ,enableMoveGraphic:t.enableMoveGraphic,snappingManager:this._snappingManager});r.tools.add(o),a||this.updateGraphics.add(e);const c=[],l=new yt({activeComponent:o,tool:n,type:"update",onEnd:()=>{var e;c.forEach(e=>e.remove()),c.length=0,null==(e=this.view.tools)||e.remove(o),o.destroyed||o.destroy()},undo:()=>{o.beforeUndo(),Ct(l,this.updateGraphics.toArray()),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:n})},redo:()=>{Tt(l,this.updateGraphics.toArray()),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:n})},addToSelection:async e=>{this.updateGraphics.add(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"});const i=await this._setupMove3DOperation(this.updateGraphics.toArray(),t,r,"transform",!0);Rt(i)||(l.onEnd(),l.destroy(),this._setUpdateOperationHandle(i,t))},removeFromSelection:async e=>{this.updateGraphics.remove(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),l.complete()},toggleTool:async()=>{if(!1===t.toggleToolOnClick)return;const e=await this._setupGraphicTransform3DOperation(this.updateGraphics.toArray(),t,r,!0);Rt(e)||(l.onEnd(),l.destroy(),this._setUpdateOperationHandle(e,t))}});return c.push(...this._getHandlesForComponent(l,t),r.on("immediate-click",e=>this._getCommonUpdateOperationClickHandlers(l,e,t),B["b"].WIDGET),r.on("key-down",e=>{this._getCommonUpdateOperationKeyDownHandlers(l,e),e.key===xt.snappingKey&&(this.snappingOptions.enabledToggled=!0,e.stopPropagation())},B["b"].WIDGET),r.on("key-up",e=>{e.key===xt.snappingKey&&(this.snappingOptions.enabledToggled=!1,e.stopPropagation())},B["b"].WIDGET)),l}async _setupTransformOrReshapeOperation(e,t,i,r){const{multipleSelectionEnabled:a}=i;this.updateGraphics.addMany(e);const n="transform"===t?await this._getBox(e,i,r):await this._getReshape(e,i,r);if(Rt(n))return n;const s=new yt({activeComponent:n,type:"update",onEnd:()=>{c.forEach(e=>e.remove()),o.forEach(e=>e.remove()),c=[],o=[],s.activeComponent&&!s.activeComponent.destroyed&&s.activeComponent.destroy(),this._internalGraphicsLayer.removeMany(this.updateGraphics.toArray())},undo:()=>{Ct(s,this.updateGraphics.toArray()),s.refreshComponent(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:s.tool})},redo:()=>{Tt(s,this.updateGraphics.toArray()),s.refreshComponent(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:s.tool})},addToSelection:e=>{const t=s.activeComponent;this.updateGraphics.add(e),t.graphics=this.updateGraphics.toArray(),t.refresh(),s.resetHistory(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:e=>{const t=s.activeComponent,i=this.updateGraphics.indexOf(e);s.history.undo.forEach(e=>e.updates.splice(i,1)),s.history.redo.forEach(e=>e.updates.splice(i,1)),this.updateGraphics.remove(e);const r=this.updateGraphics.toArray();this.emit("update",{graphics:r,state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),0!==this.updateGraphics.length?t.graphics=r:s.complete()},toggleTool:async()=>{if(this.updateGraphics.length>1)return;let t=null;"transform"===s.tool?t=await this._getReshape(e,i,r):"reshape"===s.tool&&(t=await this._getBox(e,i,r)),Rt(t)||(s.activeComponent.destroy(),s.activeComponent=t,s.activeComponent&&(c.forEach(e=>e.remove()),c=this._getHandlesForComponent(s,i)))}});let o=[r.on("immediate-click",e=>{this._getFirstHit(Object(N["a"])(e)).then(t=>{var i;if(!s)return;if(null==(i=t.results)||!i.length)return void s.complete();const r=s.activeComponent;t.results.some(t=>{if(t.graphic){var i;const n=t.graphic;if("box"===(null==r?void 0:r.type)&&null!=(i=e.native)&&i.shiftKey&&a)return s.addToSelection(n),!0;n.layer===this.layer&&s.complete()}return!1})&&e.stopPropagation()})},B["b"].WIDGET),r.on("key-down",e=>{if(this._getCommonUpdateOperationKeyDownHandlers(s,e),e.key!==xt.snappingKey||e.repeat||(this.snappingOptions.enabledToggled=!0,e.stopPropagation()),e.key===xt.constraintKey&&!e.repeat&&s){const e=s.activeComponent;e&&"box"===e.type&&(e.preserveAspectRatio=!e.preserveAspectRatio)}},B["b"].WIDGET),r.on("key-up",e=>{var t;if(e.key===xt.snappingKey&&"reshape"===(null==s||null==(t=s.activeComponent)?void 0:t.type)&&(this.snappingOptions.enabledToggled=!1,e.stopPropagation()),e.key===xt.constraintKey&&s){const e=s.activeComponent;e&&"box"===e.type&&(e.preserveAspectRatio=!e.preserveAspectRatio)}},B["b"].WIDGET)],c=this._getHandlesForComponent(s,i);return s}async _getGraphicMover(e,t,r){const{enableMoveAllGraphics:a}=t,n=await this._requireModule(i.e("chunk-63e4c91e").then(i.bind(null,"24be")));return Rt(n)?n:new n.module.default({enableMoveAllGraphics:a,graphics:e,view:r,callbacks:{onGraphicMoveStart:({dx:e,dy:t,graphic:i})=>{this._displayGrabbingCursor(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:i,type:"move-start"},type:"update"})},onGraphicMove:({dx:e,dy:t,graphic:i})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:i,type:"move"},type:"update"}),onGraphicMoveStop:({dx:e,dy:t,graphic:i})=>{this._displayPointerCursor(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:i,type:"move-stop"},type:"update"})},onGraphicPointerOver:()=>this._displayPointerCursor(),onGraphicPointerOut:()=>this._displayDefaultCursor()}})}async _getBox(e,t,r){const{enableRotation:a,enableScaling:n,preserveAspectRatio:s}=t,o=await this._requireModule(i.e("chunk-bc5f8c4a").then(i.bind(null,"4c3c")));return Rt(o)?o:new o.module.default({graphics:e,enableRotation:a,enableScaling:n,preserveAspectRatio:s,layer:this._internalGraphicsLayer,view:r,callbacks:{onMoveStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onMove:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onMoveStop:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onScaleStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onScale:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onScaleStop:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onRotateStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onRotate:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onRotateStop:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"})}})}async _getReshape(e,t,r){const{enableMidpoints:a=!0}=t,n=await this._requireModule(i.e("chunk-f6fb21b8").then(i.bind(null,"053b")));return Rt(n)?n:new n.module.default({enableMidpoints:a,graphic:e[0],layer:this._internalGraphicsLayer,snappingManager:this._snappingManager,view:r,callbacks:{onReshapeStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onReshape:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onReshapeStop:({mover:e,type:t})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e,type:t},type:"update"}),onMoveStart:({dx:e,dy:t,mover:i,type:r})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:i,type:r},type:"update"}),onMove:({dx:e,dy:t,mover:i,type:r})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:i,type:r},type:"update"}),onMoveStop:({dx:e,dy:t,mover:i,type:r})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:i,type:r},type:"update"}),onVertexAdd:({added:e,type:t,vertices:i})=>{const r=e.map(e=>Object(A["b"])(e.geometry));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:r,vertices:i,type:t},type:"update"})},onVertexRemove:({removed:e,type:t,vertices:i})=>{const r=e.map(e=>Object(A["b"])(e.geometry));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{removed:r,vertices:i,type:t},type:"update"})}}})}_getHandlesForComponent(e,t){const i=e.activeComponent;switch(i.type){case"graphic-mover":return[i.on("graphic-click",({graphic:t,viewEvent:i})=>{var r;null!=(r=i.native)&&r.shiftKey&&(i.stopPropagation(),e.removeFromSelection(t))}),i.on("graphic-move-start",t=>e.addToHistory(Pt(t.allGraphics)))];case"box":return[i.on("graphic-click",i=>this._onTransformOrReshape2DGraphicClick(e,t,i)),i.on("move-start",t=>e.addToHistory(Pt(t.graphics))),i.on("rotate-start",t=>e.addToHistory(Pt(t.graphics))),i.on("scale-start",t=>e.addToHistory(Pt(t.graphics)))];case"reshape":return[i.on("graphic-click",i=>this._onTransformOrReshape2DGraphicClick(e,t,i)),i.on("move-start",t=>e.addToHistory(Pt([t.mover]))),i.on("reshape-start",t=>e.addToHistory(Pt([t.graphic]))),i.on("vertex-add",t=>e.addToHistory(Pt([t.oldGraphic]))),i.on("vertex-remove",t=>e.addToHistory(Pt([t.oldGraphic])))];case"move-3d":return[i.on("graphic-move-start",t=>{e.addToHistory(Pt(t.allGraphics)),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:0,dy:0,mover:t.allGraphics.length>0?t.allGraphics[0]:null,type:"move-start"},type:"update"})}),i.on("graphic-move",e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e.dx,dy:e.dy,mover:e.allGraphics.length>0?e.allGraphics[0]:null,type:"move"},type:"update"})}),i.on("graphic-move-stop",e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:0,dy:0,mover:e.allGraphics.length>0?e.allGraphics[0]:null,type:"move-stop"},type:"update"})}),i.on("immediate-click",i=>{i.shiftKey?this._toggleSelection([i.graphic],e,t):e.toggleTool()})];case"transform-3d":return[i.on("graphic-translate-start",t=>{e.addToHistory(Pt([t.graphic])),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.graphic,dx:t.dxScreen,dy:t.dyScreen,type:"move-start"},type:"update"})}),i.on("graphic-translate-stop",e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,dx:e.dxScreen,dy:e.dyScreen,type:"move-stop"},type:"update"})}),i.on("graphic-rotate-start",t=>{e.addToHistory(At([t.graphic])),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.graphic,angle:t.angle,type:"rotate-start"},type:"update"})}),i.on("graphic-rotate-stop",e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,angle:e.angle,type:"rotate-stop"},type:"update"})}),i.on("graphic-scale-start",t=>{e.addToHistory(At([t.graphic])),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.graphic,xScale:t.xScale,yScale:t.yScale,type:"scale-start"},type:"update"})}),i.on("graphic-scale-stop",e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,xScale:e.xScale,yScale:e.yScale,type:"scale-stop"},type:"update"})}),i.on("graphic-translate",e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,dx:e.dxScreen,dy:e.dyScreen,type:"move"},type:"update"})}),i.on("graphic-rotate",e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,angle:e.angle,type:"rotate"},type:"update"})}),i.on("graphic-scale",e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,xScale:e.xScale,yScale:e.yScale,type:"scale"},type:"update"})}),i.on("immediate-click",i=>{i.shiftKey?this._toggleSelection([i.graphic],e,t):e.toggleTool()})];case"reshape-3d":return[i.on("reshape",t=>{"reshape-start"===t.type&&e.addToHistory(Pt([t.mover])),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:t,type:"update"})}),i.on("move",t=>{"move-start"===t.type&&e.addToHistory(Pt([t.mover])),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:t,type:"update"})}),i.on("vertex-add",e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:e,type:"update"})}),i.on("vertex-remove",e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:e,type:"update"})}),i.on("immediate-click",i=>{i.shiftKey?this._toggleSelection([i.graphic],e,t):e.toggleTool()})];case"draw":case"draw-3d":return null;default:return}}_onTransformOrReshape2DGraphicClick(e,t,i){var r;const{graphic:a,viewEvent:n}=i;null!=(r=n.native)&&r.shiftKey?(n.stopPropagation(),e.removeFromSelection(a)):t.toggleToolOnClick&&(Object(S["j"])(a.geometry)||"extent"!==a.geometry.type?(n.stopPropagation(),e.toggleTool()):this._logError("sketch:reshape-extent","Reshape operation does not support graphics with geometry of type 'extent'."))}_setUpdateOperationHandle(e,t){this._operationHandle=e;const i=this.view.map;this._disablePopup(t);const r=()=>{if(e===this._operationHandle){const r=this.updateGraphics.toArray(),a=this._operationHandle.tool;this._operationHandle.destroy(),this._operationHandle=null,this._internalGraphicsLayer.removeMany(this.updateGraphics.toArray()),this.updateGraphics.removeAll(),i&&i.remove(this._internalGraphicsLayer),this._restorePopup(t),this.emit("update",{graphics:r,state:"complete",aborted:e.cancelled,tool:a,toolEventInfo:null,type:"update"})}};e.on("complete",r)}_getCommonUpdateOperationClickHandlers(e,t,i){const r=Object(N["a"])(t);this._getFirstHit(r).then(r=>{const a=r.results;a.length&&(t.native.shiftKey&&this._toggleSelection(a.map(e=>e.graphic),e,i)||a.some(e=>e.graphic&&this.updateGraphics.indexOf(e.graphic)>-1))?t.stopPropagation():e.complete()})}_toggleSelection(e,t,i){const r=!!i.multipleSelectionEnabled;return e.some(e=>null!=e&&!(!r||e.layer!==this.layer)&&(-1===this.updateGraphics.indexOf(e)?t.addToSelection(e):t.removeFromSelection(e),!0))}_getCommonUpdateOperationKeyDownHandlers(e,t){if(!e)return;const i=t.key;i===xt.undoKey&&e.canUndo()?(t.stopPropagation(),e.undo()):i===xt.redoKey&&e.canRedo()?(t.stopPropagation(),e.redo()):i===xt.cancelKey?(t.stopPropagation(),e.cancel()):xt.deleteKeys.indexOf(i)>=0&&this._onDeleteKey(t)}_onDeleteKey(e){if(!this._operationHandle||"update"!==this._operationHandle.type)return;const t=this.activeComponent;if(Object(S["j"])(t)||"reshape"===t.type||"reshape-3d"===t.type)return;e.stopPropagation();const i=this.updateGraphics.toArray();this.layer.removeMany(i),this._emitDeleteEvent({graphics:i,tool:this.activeTool})}_drawMultipointGraphic(e,t,i){let r=null;if(!i&&t.length>1){const i=t.slice(0);i.pop(),r=e.createMultipoint(i,this.view.spatialReference)}else r=e.createMultipoint(t,this.view.spatialReference);this.createGraphic?this.createGraphic.geometry=r:this._set("createGraphic",new k["a"](r,this.pointSymbol)),i&&1===t.length&&this._internalGraphicsLayer.add(this.createGraphic)}_drawVertexGraphics(e,t,i,r){if(!i.length)return;const{_doUnnormalization:a,activeLineSymbol:n,activeVertexSymbol:s,polygonSymbol:o,polylineSymbol:c,vertexSymbol:l,view:{spatialReference:h}}=this,d=!(!r||!r.userClicked),u="polygon"===t,p=u?o:c;if(1===i.length){this._removeLineGraphic(),this._removeActiveLineGraphic();const t=this.createPointFromVertex(i[0]),r=u?e.createPolygon([i],h,a,!0):e.createPolyline([i],h,a);this._vertexGraphics.length?this._vertexGraphics[0].geometry=t:this._vertexGraphics.push(new k["a"](t,s)),this.createGraphic?this.createGraphic.set({geometry:r,symbol:p}):this._set("createGraphic",new k["a"](r,p)),d&&this._internalGraphicsLayer.add(this._vertexGraphics[0])}else if(2===i.length){const t=this.createPointFromVertex(i[1]),r=e.createPolyline([i],h,a),n=u?e.createPolygon([i],h,a,!0):e.createPolyline([i],h,a);if(!this._vertexGraphics.length){const e=this.createPointFromVertex(i[0]),t=new k["a"](e,l);this._vertexGraphics.push(t)}if(1===this._vertexGraphics.length){const e=this._vertexGraphics[0],i=new k["a"](t,l);this._removeLineGraphic(),this._removeActiveFillGraphic(),this._vertexGraphics.push(i),this._internalGraphicsLayer.remove(e),this._internalGraphicsLayer.add(e)}else this._vertexGraphics[1].geometry=t;this._showActiveLineGraphic(r);const s=this._vertexGraphics[0];d&&(this._activeLineGraphic.symbol=c,s.symbol=l,this._internalGraphicsLayer.add(this._vertexGraphics[1])),this.createGraphic?this.createGraphic.set({geometry:n,symbol:p}):this._set("createGraphic",new k["a"](n,p)),this._internalGraphicsLayer.remove(s),this._internalGraphicsLayer.add(s)}else if(i.length>2){const r=u?e.createPolygon([i],h,a,!0):e.createPolyline([i],h,a);"polygon"===t&&this._showFillGraphic(r);const o=i.map(e=>e.slice()),f=o.pop(),m=[o[o.length-1],f],b=e.createPolyline([o],h,a),g=e.createPolyline([m],h,a);this._showLineGraphic(b),this._showActiveLineGraphic(g);for(let e=0;e<o.length;e++){const t=this._vertexGraphics[e];if(t)d||e!==this._vertexGraphics.length-1?t.symbol=l:t.symbol=s;else{const t=this.createPointFromVertex(i[e]);this._showVertexGraphic(t)}}if(d){this._activeLineGraphic.symbol=c;const e=i.length-1,t=this.createPointFromVertex(i[e]);this._showVertexGraphic(t)}else this._activeLineGraphic.symbol=n;this.createGraphic?this.createGraphic.set({geometry:r,symbol:p}):(this._removeCreateGraphic(),this._set("createGraphic",new k["a"](r,p)));for(const e of this._vertexGraphics)this._internalGraphicsLayer.remove(e),this._internalGraphicsLayer.add(e)}}_drawSegmentGraphic(e,t,i,r,a){if(!i.length)return;const n=!(null==r||!r.centered),s=!(null==r||!r.constrainToggle);let o;1===i.length?this._removeCenterIndicatorGraphic():("rectangle"===t?o=s?e.createSquare(i,a,n):e.createRectangle(i,a,n):"circle"===t&&(o=s?e.createEllipse(i,a,n):e.createCircle(i,a,n,this.view.resolution)),Object(S["k"])(o)&&o.extent&&o.extent.center&&this._showCenterIndicatorGraphic(o.extent.center)),o?this.createGraphic?this.createGraphic.geometry=o:(this._removeCreateGraphic(),this._set("createGraphic",new k["a"](o,this.polygonSymbol)),this._internalGraphicsLayer.add(this.createGraphic)):this._removeCreateGraphic()}_showCenterIndicatorGraphic(e){this._centerIndicatorGraphic?this._centerIndicatorGraphic.geometry=e:(this._centerIndicatorGraphic=new k["a"](e,this._centerSymbol),this._internalGraphicsLayer.add(this._centerIndicatorGraphic))}_removeCenterIndicatorGraphic(){this._centerIndicatorGraphic&&(this._internalGraphicsLayer.remove(this._centerIndicatorGraphic),this._centerIndicatorGraphic.destroy(),this._centerIndicatorGraphic=null)}_showActiveLineGraphic(e){this._activeLineGraphic?(this._activeLineGraphic.set({geometry:e,symbol:this.activeLineSymbol}),this._internalGraphicsLayer.remove(this._activeLineGraphic)):this._activeLineGraphic=new k["a"](e,this.activeLineSymbol),this._internalGraphicsLayer.add(this._activeLineGraphic)}_showFillGraphic(e){this._activeFillGraphic?(this._activeFillGraphic.set({geometry:e,symbol:this.activeFillSymbol}),this._internalGraphicsLayer.remove(this._activeFillGraphic)):this._activeFillGraphic=new k["a"](e,this.activeFillSymbol),this._internalGraphicsLayer.add(this._activeFillGraphic)}_showLineGraphic(e){this._lineGraphic?(this._lineGraphic.set({geometry:e,symbol:this.polylineSymbol}),this._internalGraphicsLayer.remove(this._lineGraphic)):this._lineGraphic=new k["a"](e,this.polylineSymbol),this._internalGraphicsLayer.add(this._lineGraphic)}_showVertexGraphic(e,t){const i=t?this.activeVertexSymbol:this.vertexSymbol,r=new k["a"](e,i);this._vertexGraphics.push(r),this._internalGraphicsLayer.add(r)}_resetCreateOperationGraphics(){this._removeActiveFillGraphic(),this._removeLineGraphic(),this._removeActiveLineGraphic(),this._removeVertexGraphics(),this._removeCloneGraphics()}_removeCreateGraphic(){this.createGraphic&&(this._internalGraphicsLayer.remove(this.createGraphic),this._set("createGraphic",null))}_removeCreateOperationGraphics(){this._removeCenterIndicatorGraphic(),this._removeActiveLineGraphic(),this._removeActiveFillGraphic(),this._removeLineGraphic(),this._removeVertexGraphics()}_removeActiveLineGraphic(){this._activeLineGraphic&&(this._internalGraphicsLayer.remove(this._activeLineGraphic),this._activeLineGraphic.destroy(),this._activeLineGraphic=null)}_removeActiveFillGraphic(){this._activeFillGraphic&&(this._internalGraphicsLayer.remove(this._activeFillGraphic),this._activeFillGraphic.destroy(),this._activeFillGraphic=null)}_removeLineGraphic(){this._lineGraphic&&(this._internalGraphicsLayer.remove(this._lineGraphic),this._lineGraphic.destroy(),this._lineGraphic=null)}_removeVertexGraphics(){this._vertexGraphics.length&&(this._internalGraphicsLayer.removeMany(this._vertexGraphics),this._vertexGraphics.forEach(e=>e.destroy()),this._vertexGraphics=[])}_removeDefaultLayer(){this._internalGraphicsLayer&&(this.view&&this.view.map&&this.view.map.remove(this._internalGraphicsLayer),this._internalGraphicsLayer.destroy(),this._internalGraphicsLayer=null)}_operationHandleForCreateAction(e,t,i){return new yt({activeComponent:this._draw,tool:i,type:"create",onEnd:()=>{t.forEach(e=>e.remove()),t.length=0,this._removeCreateOperationGraphics(),this._internalGraphicsLayer&&this._internalGraphicsLayer.remove(this.createGraphic),this._displayDefaultCursor()},undo:()=>{e.undo(),this._emitUndoEvent({graphics:[this.createGraphic],tool:i})},redo:()=>{e.redo(),this._emitRedoEvent({graphics:[this.createGraphic],tool:i})},canUndo:()=>e&&e.canUndo(),canRedo:()=>e&&e.canRedo()})}_isComponentGraphic(e){const{activeComponent:t}=this;return!(!e||Object(S["j"])(t))&&(!(!e.attributes||!e.attributes.esriSketchTool)||("box"===t.type||"reshape"===t.type)&&t.isUIGraphic(e))}_snapLastPolygonVertexToFirst(e,t){if("polygon"!==e&&t.length<=2)return;const i=t[0],r=t[t.length-1],a=this.view.toScreen(new P["a"](i[0],i[1],this.view.spatialReference)),n=this.view.toScreen(new P["a"](r[0],r[1],this.view.spatialReference));this._isWithinScreenDistance(a,n,this._getVertexIntersectDistance())&&(r[0]=i[0],r[1]=i[1])}_getVertexIntersectDistance(){const e=3;return this.vertexSymbol&&"simple-marker"===this.vertexSymbol.type?Object(E["h"])(this.vertexSymbol.size)/2+e:e}_isWithinScreenDistance(e,t,i){const r=e.x-t.x,a=e.y-t.y;return Math.sqrt(r*r+a*a)<=i}_displayPointerCursor(){this.view&&this.view.container&&"pointer"!==this.view.cursor&&(this.view.cursor="pointer")}_displayGrabbingCursor(){this.view&&this.view.container&&"grabbing"!==this.view.cursor&&(this.view.cursor="grabbing")}_displayCrosshairCursor(){this.view&&this.view.container&&"crosshair"!==this.view.cursor&&(this.view.cursor="crosshair")}_displayDefaultCursor(){this.view&&this.view.container&&null!==this.view.cursor&&(this.view.cursor=null)}_logError(e,t,i){_t.error(new C["a"](e,t,i))}async _requireModule(e){const t=new AbortController;this._moduleLoaderAbortController=t;const i=await e;return this._moduleLoaderAbortController!==t||t.signal.aborted?{requireError:"aborted"}:{module:i}}_emitUndoEvent(e){this.emit("undo",{...e,type:"undo"})}_emitRedoEvent(e){this.emit("redo",{...e,type:"redo"})}_emitDeleteEvent(e){this.emit("delete",{...e,type:"delete"})}createPointFromVertex(e){return e.length>2?new P["a"](e[0],e[1],e[2],this.view.spatialReference):new P["a"](e[0],e[1],this.view.spatialReference)}test(){return this._operationHandle}wait(){return Object(z["j"])(this,"updating")}_beginAsyncOperation(){this._numUpdating+=1,this.notifyChange("updating")}_endAsyncOperation(){this._numUpdating-=1,this.notifyChange("updating")}_disablePopupEnabled(e){var t;return"3d"!==(null==(t=this.view)?void 0:t.type)||this.updateOnGraphicClick||Object(S["k"])(e)&&e.toggleToolOnClick}_disablePopup(e){if(!this._disablePopupEnabled(e))return;const t=this.view.popup;t&&Object(S["j"])(this._originalAutoOpenEnabled)&&(this._originalAutoOpenEnabled=t.autoOpenEnabled,t.autoOpenEnabled=!1)}_restorePopup(e){if(!this._disablePopupEnabled(e))return;const t=this.view.popup;t&&Object(S["k"])(this._originalAutoOpenEnabled)&&(t.autoOpenEnabled=this._originalAutoOpenEnabled,this._originalAutoOpenEnabled=null)}async _waitViewReady(){this.view&&(Object(S["a"])(this._viewReadyAbortController),this._viewReadyAbortController=Object(T["e"])(),await Object(T["z"])(Object(z["k"])(this.view,"ready"),this._viewReadyAbortController.signal))}};function Ct(e,t){const i=e.history.undo.pop().updates,r=[];t.forEach((e,t)=>{const a=i[t],n={};null!=a&&(Object(S["k"])(a.geometry)&&(n.geometry=e.geometry,e.geometry=a.geometry),Object(S["k"])(a.symbol)&&(n.symbol=e.symbol,e.symbol=a.symbol),r.push(n))}),e.history.redo.push({updates:r})}function Tt(e,t){const i=e.history.redo.pop().updates,r=[];t.forEach((e,t)=>{const a=i[t],n={};null!=a&&(Object(S["k"])(a.geometry)&&(n.geometry=e.geometry,e.geometry=a.geometry),Object(S["k"])(a.symbol)&&(n.symbol=e.symbol,e.symbol=a.symbol),r.push(n))}),e.history.undo.push({updates:r})}function Pt(e){return{updates:e.map(e=>({geometry:e.geometry}))}}function At(e){return{updates:e.map(e=>({symbol:e.symbol}))}}function Rt(e){return"requireError"in e&&"aborted"===e.requireError}Object(r["a"])([Object(n["b"])({readOnly:!0})],St.prototype,"_draw",null),Object(r["a"])([Object(n["b"])()],St.prototype,"updating",null),Object(r["a"])([Object(n["b"])()],St.prototype,"_operationHandle",void 0),Object(r["a"])([Object(n["b"])({readOnly:!0})],St.prototype,"activeTool",null),Object(r["a"])([Object(n["b"])()],St.prototype,"activeFillSymbol",void 0),Object(r["a"])([Object(n["b"])()],St.prototype,"activeLineSymbol",void 0),Object(r["a"])([Object(n["b"])()],St.prototype,"activeVertexSymbol",void 0),Object(r["a"])([Object(n["b"])({readOnly:!0})],St.prototype,"createGraphic",null),Object(r["a"])([Object(n["b"])()],St.prototype,"defaultCreateOptions",null),Object(r["a"])([Object(n["b"])()],St.prototype,"defaultUpdateOptions",null),Object(r["a"])([Object(n["b"])()],St.prototype,"layer",void 0),Object(r["a"])([Object(n["b"])({types:V["e"]})],St.prototype,"pointSymbol",void 0),Object(r["a"])([Object(n["b"])({types:V["e"]})],St.prototype,"polygonSymbol",void 0),Object(r["a"])([Object(n["b"])({types:V["e"]})],St.prototype,"polylineSymbol",void 0),Object(r["a"])([Object(n["b"])({type:w,nonNullable:!0})],St.prototype,"snappingOptions",null),Object(r["a"])([Object(n["b"])()],St.prototype,"_snappingManager",void 0),Object(r["a"])([Object(n["b"])({readOnly:!0})],St.prototype,"state",null),Object(r["a"])([Object(n["b"])({readOnly:!0})],St.prototype,"updateGraphics",void 0),Object(r["a"])([Object(n["b"])()],St.prototype,"updateOnGraphicClick",void 0),Object(r["a"])([Object(n["b"])({types:V["e"]})],St.prototype,"updatePointSymbol",void 0),Object(r["a"])([Object(n["b"])({types:V["e"]})],St.prototype,"updatePolygonSymbol",void 0),Object(r["a"])([Object(n["b"])({types:V["e"]})],St.prototype,"updatePolylineSymbol",void 0),Object(r["a"])([Object(n["b"])({types:V["e"]})],St.prototype,"vertexSymbol",void 0),Object(r["a"])([Object(n["b"])({value:null})],St.prototype,"view",null),Object(r["a"])([Object(n["b"])()],St.prototype,"cancel",null),Object(r["a"])([Object(n["b"])()],St.prototype,"complete",null),Object(r["a"])([Object(n["b"])()],St.prototype,"delete",null),Object(r["a"])([Object(n["b"])()],St.prototype,"create",null),Object(r["a"])([Object(n["b"])()],St.prototype,"update",null),Object(r["a"])([Object(n["b"])()],St.prototype,"undo",null),Object(r["a"])([Object(n["b"])()],St.prototype,"redo",null),Object(r["a"])([Object(n["b"])()],St.prototype,"canUndo",null),Object(r["a"])([Object(n["b"])()],St.prototype,"canRedo",null),Object(r["a"])([Object(n["b"])()],St.prototype,"toggleUpdateTool",null),St=Object(r["a"])([Object(c["a"])(Ot)],St);var Mt=St,Et=Mt;async function Dt(){return Promise.all([i.e("chunk-2d22cf8c"),i.e("chunk-252f2cfc")]).then(i.bind(null,"00ac"))}async function It(){return Dt().then(({contains:e,intersects:t,overlaps:i,simplify:r})=>({contains:e,intersects:t,overlaps:i,simplify:r}))}async function Lt(e){const{selector:t,candidates:i,currentSelection:r,options:a,view:n}=e;if(!(i&&i.length&&r&&n))return{added:[],removed:[]};const{overlaps:s,intersects:o,contains:c}=a,{spatialReference:l}=n;if(!t)return{added:[],removed:r.removeAll()};const h=t,d=await It(),u=[],p=[];return i.forEach(e=>{const t=e.geometry,i=s&&!!d.overlaps(l,h,t),a=o&&!!d.intersects(l,h,t),n=c&&!!d.contains(l,h,t),f=r.includes(e);i||a||n?!f&&u.push(e):f&&p.push(e)}),r.removeMany(p),r.addMany(u),{added:u,removed:p}}let Vt=class extends R["a"].EventedAccessor{constructor(e){super(),this._activeOptions=null,this._dashedFillSymbol=new I["a"]({color:[0,0,0,0],outline:{style:"dash",color:[12,207,255],width:2}}),this._dashedLineSymbol=new D["a"]({style:"dash",color:[12,207,255],width:2}),this._defaultOptions={tool:"rectangle",createOptions:null,selectionOptions:{overlaps:!0,intersects:!0,contains:!1}},this._completed=!1,this._handles=new F["a"],this._sketchViewModel=new Et,this._sketchGraphicsLayer=new G["a"]({listMode:"hide",internal:!0}),this._transparentPointSymbol=new L["a"]({color:[0,0,0,0],outline:{style:"none",width:0}}),this.candidates=null,this.geometry=null,this.options=null,this.selection=new h["a"],this.view=null,this.candidates=e.candidates,this.options=e.options,this.view=e.view;const{_dashedFillSymbol:t,_dashedLineSymbol:i,_sketchViewModel:r,_sketchGraphicsLayer:a,_transparentPointSymbol:n}=this;r.set({layer:a,view:this.view,activePointSymbol:n,activeLineSymbol:i,activeVertexSymbol:n,activeFillSymbol:t,pointSymbol:n,polygonSymbol:t,polylineSymbol:i,vertexSymbol:n}),this._handles.add([r.on("create",e=>this._onSketchEvent(e)),r.on(["undo","redo"],e=>this._onSketchEvent(e))])}initialize(){this._load()}destroy(){this._handles.destroy(),this._handles=null}get state(){const{_completed:e,_sketchViewModel:{state:t}}=this;return e?"complete":"active"===t?"active":"disabled"}cancel(){this._sketchViewModel.cancel()}async _load(){await this.view.whenReady();const{options:e}=this,{tool:t,createOptions:i}=this._activeOptions={...this._defaultOptions,...e};this._sketchViewModel.create(t,i)}_onSketchEvent(e){const t="create"===e.type?e.graphic:e.graphics[0],i=(null==t?void 0:t.geometry)||null,r="create"===e.type&&"cancel"===e.state,a="create"===e.type&&"complete"===e.state;this._processSelectionGeometry(i,a,r)}_processSelectionGeometry(e,t,i){if(this._set("geometry",e),(t||i)&&(this._completed=!0),i)return void this._onComplete([],!0);const{_activeOptions:r,candidates:a,selection:n,view:s}=this;Lt({selector:e,candidates:a,currentSelection:n,options:r.selectionOptions,view:s}).then(({added:e,removed:i})=>{t?this._onComplete(this.selection.toArray(),!1):(e.length||i.length)&&this.emit("selection-change",{added:e,removed:i,type:"selection-change"})})}_onComplete(e,t){this._handles.removeAll(),this.notifyChange("state"),this.emit("complete",{aborted:t,selection:e,type:"complete"})}};Object(r["a"])([Object(n["b"])()],Vt.prototype,"_completed",void 0),Object(r["a"])([Object(n["b"])()],Vt.prototype,"candidates",void 0),Object(r["a"])([Object(n["b"])({readOnly:!0})],Vt.prototype,"geometry",void 0),Object(r["a"])([Object(n["b"])()],Vt.prototype,"options",void 0),Object(r["a"])([Object(n["b"])({readOnly:!0})],Vt.prototype,"selection",void 0),Object(r["a"])([Object(n["b"])({readOnly:!0})],Vt.prototype,"state",null),Object(r["a"])([Object(n["b"])({value:null})],Vt.prototype,"view",void 0),Vt=Object(r["a"])([Object(c["a"])("esri.widgets.support.Selector")],Vt);var kt=Vt,Ft=kt;let zt=class extends(Object(Fe["b"])(g["a"])){constructor(e){super(e),this._defaultSelectionOptions={intersects:!0,overlaps:!0,contains:!0},this.candidates=null,this.options=null,this.view=null}draw(e){const{_defaultSelectionOptions:t,candidates:i,options:r,view:a}=this,n={...t,...r,...null==e?void 0:e.selectionOptions};return new Ft({candidates:i,options:{...e,selectionOptions:n},view:a})}async selectionFrom(e,t){const{_defaultSelectionOptions:i,candidates:r,options:a,view:n}=this,s=new h["a"],o={...i,...a,...t};return await Lt({selector:e,candidates:r,currentSelection:s,options:o,view:n}),s.toArray()}};Object(r["a"])([Object(n["b"])()],zt.prototype,"candidates",void 0),Object(r["a"])([Object(n["b"])()],zt.prototype,"options",void 0),Object(r["a"])([Object(n["b"])({value:null})],zt.prototype,"view",void 0),zt=Object(r["a"])([Object(c["a"])("esri.widgets.support.Selector")],zt);var Ut=zt,Gt=Ut;const Bt={base:"esri-sketch",verticalLayout:"esri-sketch--vertical",panel:"esri-sketch__panel",infoPanel:"esri-sketch__info-panel",section:"esri-sketch__section",toolSection:"esri-sketch__tool-section",infoSection:"esri-sketch__info-section",infoCountSection:"esri-sketch__info-count-section",menuContainer:"esri-sketch__menu-container",menuHeader:"esri-sketch__menu-header",menuTitle:"esri-sketch__menu-title",menuContent:"esri-sketch__menu-content",menuItem:"esri-sketch__menu-item",menuItemWrapper:"esri-sketch__menu-item-wrapper",featureCountBadge:"esri-sketch__feature-count-badge",featureCountText:"esri-sketch__feature-count-text",featureCountNumber:"esri-sketch__feature-count-number",button:"esri-sketch__button",selectedButton:"esri-sketch__button--selected",pointIcon:"esri-icon-map-pin",polygonIcon:"esri-icon-polygon",polylineIcon:"esri-icon-polyline",circleIcon:"esri-icon-radio-unchecked",rectangleIcon:"esri-icon-checkbox-unchecked",cursorIcon:"esri-icon-cursor",resetIcon:"esri-icon-trash",undoIcon:"esri-icon-undo",redoIcon:"esri-icon-redo",settingsIcon:"esri-icon-settings",actionToggle:"esri-sketch__action-toggle",actionToggleOn:"esri-sketch__action-toggle--on",actionTitle:"esri-sketch__item-action-title",actionIcon:"esri-sketch__item-action-icon",rectangleSelectIcon:"esri-icon-cursor-marquee",lassoSelectIcon:"esri-icon-lasso",disabled:"esri-disabled",esriWidget:"esri-widget",rotating:"esri-rotating",widgetIcon:"esri-icon-edit"},Ht={createTools:{point:!0,polyline:!0,polygon:!0,rectangle:!0,circle:!0},selectionTools:{"rectangle-selection":!0,"lasso-selection":!0},undoRedoMenu:!0,settingsMenu:!0};let Nt=class extends b["a"]{constructor(e,t){super(e,t),this._activeCreateOptions=null,this._activeSelectionInfo=null,this._menuOpen=!1,this._selector=new Gt,this.availableCreateTools=["point","polyline","polygon","rectangle","circle"],this.createGraphic=null,this.creationMode="continuous",this.defaultCreateOptions=null,this.defaultUpdateOptions=null,this.iconClass=Bt.widgetIcon,this.label=void 0,this.layer=null,this.messages=null,this.snappingOptions=new w,this.updateGraphics=new h["a"],this.view=null,this.viewModel=new Et,this.visibleElements={...Ht},this._activateCreateTool=this._activateCreateTool.bind(this)}initialize(){const{view:e}=this;this._selector.view=e,this.own([this.viewModel.on("create",()=>this.scheduleRender()),this.viewModel.on("update",()=>this.scheduleRender()),this.viewModel.on("create",e=>this._onCreateOperation(e)),this.viewModel.on("delete",e=>this.emit("delete",e)),this.viewModel.on("undo",()=>this.scheduleRender()),this.viewModel.on("redo",()=>this.scheduleRender()),this.viewModel.watch("view",e=>this._selector.set({view:e})),this.viewModel.watch("state",()=>this.notifyChange("state"))])}get activeTool(){var e;return(null==(e=this._activeSelectionInfo)?void 0:e.tool)||this.viewModel.activeTool}set layout(e){"vertical"!==e&&(e="horizontal"),this._set("layout",e)}get state(){return this._activeSelectionInfo?"active":this.viewModel.state}castVisibleElements(e){return{...Ht,...e,createTools:{...Ht.createTools,...null==e?void 0:e.createTools},selectionTools:{...Ht.selectionTools,...null==e?void 0:e.selectionTools}}}create(e,t){this._activeCreateOptions=t||null,this.viewModel.create(e,t)}update(e,t){return this.viewModel.update(e,t)}complete(){}cancel(){this._cancelSelectionOperation(),this.viewModel.cancel()}undo(){}redo(){}delete(){}render(){const{label:e,layout:t,viewModel:{state:i}}=this;return Object(m["a"])("div",{"aria-label":e,class:this.classes(Bt.base,Bt.esriWidget,{[Bt.disabled]:"disabled"===i,[Bt.verticalLayout]:"vertical"===t})},Object(m["a"])("div",{role:"toolbar",class:Bt.panel},this.renderTopPanelContents()),Object(m["a"])("div",{class:this.classes(Bt.panel,Bt.infoPanel)},this.renderInfoPanelContents()))}renderTopPanelContents(){const e=this.classes(Bt.section,Bt.toolSection),{availableCreateTools:t,visibleElements:i}=this;return[Object(m["a"])("div",{role:"menu",key:"selection-button-container",class:e},this.renderSelectionTools()),t&&t.length?Object(m["a"])("div",{role:"menu",class:e},this.renderDrawButtons()):null,i.undoRedoMenu?Object(m["a"])("div",{role:"menu",key:"undo-redo-menu-button-container",class:e},this.renderUndoRedoMenuButtons()):null,i.settingsMenu?Object(m["a"])("div",{key:"settings-menu-button-container",class:Bt.section},this.renderSettingsMenuButton()):null]}renderInfoPanelContents(){return this._menuOpen?this.renderSettingsMenu():this.updateGraphics.length?[Object(m["a"])("div",{class:this.classes(Bt.section,Bt.infoSection,Bt.infoCountSection),key:"feature-count-container"},this.renderFeatureCount()),Object(m["a"])("div",{class:this.classes(Bt.section,Bt.infoSection),key:"delete-button-container"},this.renderDeleteButton())]:void 0}renderSettingsMenu(){const{settings:e}=this.messages;return[Object(m["a"])("div",{role:"menu",class:Bt.menuContainer,key:"settings-menu-container"},Object(m["a"])("header",{class:Bt.menuHeader,key:"settings-menu-header"},Object(m["a"])("span",{class:Bt.menuTitle},e)),Object(m["a"])("div",{class:Bt.menuContent,key:"settings-menu-content","aria-label":e},Object(m["a"])("div",{class:Bt.menuItemWrapper},this.renderSnappingToggleMenuItem())))]}renderSnappingToggleMenuItem(){var e;return Object(m["a"])("div",{class:Bt.menuItem,"aria-label":null==(e=this.messages)?void 0:e.snappingEnabled,key:"sketch-snapping-action-toggle",role:"menuitem"},this.renderSnappingToggle())}renderSnappingToggle(){const{messages:{snappingEnabled:e},viewModel:{snappingOptions:{enabled:t}}}=this,i=this.classes(Bt.actionToggle,{[Bt.actionToggleOn]:t});return Object(m["a"])("div",{bind:this,role:"button",onclick:this._onSnappingToggleClick,onkeydown:this._onSnappingToggleKeyDown,class:i,tabindex:"0",title:e,"aria-label":e},this.renderActionIcon(),Object(m["a"])("span",{class:Bt.actionTitle},e))}_onSnappingToggleKeyDown(e){const t=Object(l["a"])(e);"Enter"!==t&&" "!==t||(e.preventDefault(),this._toggleSnapping())}_onSnappingToggleClick(e){e.stopPropagation(),this._toggleSnapping()}renderActionIcon(){return Object(m["a"])("span",{key:"action-icon","aria-hidden":"true",class:this.classes(Bt.actionIcon)})}renderFeatureCount(){const{layout:e,messages:t,updateGraphics:{length:i}}=this,r=Object(d["a"])(1===i?t.featureCount:t.featuresCount,{count:i});return Object(m["a"])("div",{class:Bt.featureCountBadge,"aria-label":r},Object(m["a"])("span",{class:Bt.featureCountNumber},"vertical"===e?i:r))}renderDeleteButton(){const e=this.messages.deleteFeature;return Object(m["a"])("button",{"aria-label":e,bind:this,class:this.classes(Bt.button,Bt.resetIcon),onclick:this.delete,title:e,type:"button"})}renderSelectionTools(){return[this.renderDefaultSelectionButton(),this.renderRectangleSelectionButton(),this.renderLassoSelectionButton()]}renderDefaultSelectionButton(){if(!this.viewModel.updateOnGraphicClick)return;const e=this.messages.selectFeature;return Object(m["a"])("button",{"aria-label":e,bind:this,class:this.classes(Bt.button,Bt.cursorIcon,{[Bt.selectedButton]:"ready"===this.state}),onclick:this.cancel,role:"menuitemradio",title:e})}renderRectangleSelectionButton(){var e,t;if("2d"!==(null==(e=this.view)?void 0:e.type)||!this.visibleElements.selectionTools["rectangle-selection"])return;const i=this.messages.selectRectangle;return Object(m["a"])("button",{"aria-label":i,bind:this,class:this.classes(Bt.button,Bt.rectangleSelectIcon,{[Bt.selectedButton]:"rectangle-selection"===(null==(t=this._activeSelectionInfo)?void 0:t.tool)}),onclick:this._activateRectangleSelectTool,role:"menuitemradio",title:i})}renderLassoSelectionButton(){var e,t;if("2d"!==(null==(e=this.view)?void 0:e.type)||!this.visibleElements.selectionTools["lasso-selection"])return;const i=this.messages.selectLasso;return Object(m["a"])("button",{"aria-label":i,bind:this,class:this.classes(Bt.button,Bt.lassoSelectIcon,{[Bt.selectedButton]:"lasso-selection"===(null==(t=this._activeSelectionInfo)?void 0:t.tool)}),onclick:this._activateLassoSelectTool,role:"menuitemradio",title:i})}renderDrawButtons(){const e=this.visibleElements.createTools;return this.availableCreateTools.map(t=>"point"===t&&e.point?this.renderPointButton():"polyline"===t&&e.polyline?this.renderPolylineButton():"polygon"===t&&e.polygon?this.renderPolygonButton():"rectangle"===t&&e.rectangle?this.renderRectangleButton():"circle"===t&&e.circle?this.renderCircleButton():void 0)}renderPointButton(){const e="point",t=this.messages.drawPoint,i=[Bt.button,Bt.pointIcon];return this.activeTool===e&&i.push(Bt.selectedButton),Object(m["a"])("button",{"aria-label":t,bind:this,class:this.classes(i),"data-tool-name":e,onclick:this._activateCreateTool,role:"menuitemradio",title:t,type:"button"})}renderPolygonButton(){const e="polygon",t=this.messages.drawPolygon,i=[Bt.button,Bt.polygonIcon];return this.activeTool===e&&i.push(Bt.selectedButton),Object(m["a"])("button",{"aria-label":t,bind:this,class:this.classes(i),"data-tool-name":e,onclick:this._activateCreateTool,role:"menuitemradio",title:t,type:"button"})}renderPolylineButton(){const e="polyline",t=this.messages.drawPolyline,i=[Bt.button,Bt.polylineIcon];return this.activeTool===e&&i.push(Bt.selectedButton),Object(m["a"])("button",{"aria-label":t,bind:this,class:this.classes(i),"data-tool-name":e,onclick:this._activateCreateTool,role:"menuitemradio",title:t,type:"button"})}renderCircleButton(){const e="circle",t=this.messages.drawCircle,i=[Bt.button,Bt.circleIcon];return this.activeTool===e&&i.push(Bt.selectedButton),Object(m["a"])("button",{"aria-label":t,bind:this,class:this.classes(i),"data-tool-name":e,onclick:this._activateCreateTool,role:"menuitemradio",title:t,type:"button"})}renderRectangleButton(){const e="rectangle",t=this.messages.drawRectangle,i=[Bt.button,Bt.rectangleIcon];return this.activeTool===e&&i.push(Bt.selectedButton),Object(m["a"])("button",{"aria-label":t,bind:this,class:this.classes(i),"data-tool-name":e,onclick:this._activateCreateTool,role:"menuitemradio",title:t,type:"button"})}renderUndoRedoMenuButtons(){return[this.renderUndoButton(),this.renderRedoButton()]}renderUndoButton(){const e=this.messages.undo,t=!this.viewModel.canUndo(),i=Object(u["f"])()?Bt.redoIcon:Bt.undoIcon;return Object(m["a"])("button",{"aria-label":e,bind:this,class:this.classes(Bt.button,i),disabled:t,onclick:this.undo,title:e,type:"button"})}renderRedoButton(){const e=this.messages.redo,t=!this.viewModel.canRedo(),i=Object(u["f"])()?Bt.undoIcon:Bt.redoIcon;return Object(m["a"])("button",{"aria-label":e,bind:this,class:this.classes(Bt.button,i),disabled:t,onclick:this.redo,title:e,type:"button"})}renderSettingsMenuButton(){const e=this.messages.settings,t=[Bt.button,Bt.settingsIcon];return this._menuOpen&&t.push(Bt.selectedButton),Object(m["a"])("button",{"aria-label":e,bind:this,class:this.classes(t),onclick:this._toggleMenu,title:e,type:"button"})}_cancelSelectionOperation(){var e,t;null==(e=this._activeSelectionInfo)||null==(t=e.operation)||t.cancel(),this._activeSelectionInfo=null,this._selector.candidates=null}_activateCreateTool(e){const t=e.target.getAttribute("data-tool-name");this.activeTool!==t?(this._activeSelectionInfo&&this._cancelSelectionOperation(),this.create(t)):this.cancel()}_onCreateOperation(e){if("complete"!==e.state)return;const{creationMode:t}=this,{type:i}=e;if("create"===i){const{tool:i,graphic:r}=e,a=this._activeCreateOptions;this._activeCreateOptions=null,"continuous"===t?this.create(i,a):"update"===t&&this.update([r])}}_toggleMenu(){this._menuOpen=!this._menuOpen,this.scheduleRender()}_toggleSnapping(){const{viewModel:{snappingOptions:e}}=this;this.viewModel.snappingOptions.enabled=!e.enabled,this.scheduleRender()}_onSelectionOperationComplete(e){const{viewModel:{defaultUpdateOptions:t}}=this,{selection:i}=e;if(this._activeSelectionInfo=null,!e.aborted&&i.length){const e=t.tool,r=i.length>1&&"reshape"===e?"transform":e;this.update(i,{...t,tool:r})}this.notifyChange("state")}_activateRectangleSelectTool(){if(this._activeSelectionInfo){const e=this._activeSelectionInfo.tool;if(this._cancelSelectionOperation(),"rectangle-selection"===e)return}else"active"===this.state&&this.cancel();this._selector.candidates=this._getSelectionCandidates();const e=this._selector.draw({tool:"rectangle"});e.once("complete",e=>this._onSelectionOperationComplete(e)),this._activeSelectionInfo={tool:"rectangle-selection",operation:e}}_activateLassoSelectTool(){if(this._activeSelectionInfo){const e=this._activeSelectionInfo.tool;if(this._cancelSelectionOperation(),"lasso-selection"===e)return}else"active"===this.state&&this.cancel();this._selector.candidates=this._getSelectionCandidates();const e=this._selector.draw({tool:"polygon",createOptions:{mode:"freehand"}});e.once("complete",e=>this._onSelectionOperationComplete(e)),this._activeSelectionInfo={tool:"lasso-selection",operation:e}}_getSelectionCandidates(){var e,t;return(null==(e=this.layer)||null==(t=e.graphics)?void 0:t.toArray())||[]}};Object(r["a"])([Object(n["b"])()],Nt.prototype,"_activeSelectionInfo",void 0),Object(r["a"])([Object(n["b"])()],Nt.prototype,"activeTool",null),Object(r["a"])([Object(n["b"])({cast:e=>{if(!e||!e.length)return null;const t=new Set(["point","polyline","polygon","rectangle","circle"]);return e.filter(e=>t.has(e))}})],Nt.prototype,"availableCreateTools",void 0),Object(r["a"])([Object(s["a"])("viewModel.createGraphic")],Nt.prototype,"createGraphic",void 0),Object(r["a"])([Object(n["b"])()],Nt.prototype,"creationMode",void 0),Object(r["a"])([Object(s["a"])("viewModel.defaultCreateOptions")],Nt.prototype,"defaultCreateOptions",void 0),Object(r["a"])([Object(s["a"])("viewModel.defaultUpdateOptions")],Nt.prototype,"defaultUpdateOptions",void 0),Object(r["a"])([Object(n["b"])()],Nt.prototype,"iconClass",void 0),Object(r["a"])([Object(n["b"])({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],Nt.prototype,"label",void 0),Object(r["a"])([Object(s["a"])("viewModel.layer")],Nt.prototype,"layer",void 0),Object(r["a"])([Object(n["b"])({value:"horizontal"})],Nt.prototype,"layout",null),Object(r["a"])([Object(n["b"])(),Object(p["a"])("esri/widgets/Sketch/t9n/Sketch")],Nt.prototype,"messages",void 0),Object(r["a"])([Object(s["a"])("viewModel.snappingOptions")],Nt.prototype,"snappingOptions",void 0),Object(r["a"])([Object(n["b"])()],Nt.prototype,"state",null),Object(r["a"])([Object(s["a"])("viewModel.updateGraphics")],Nt.prototype,"updateGraphics",void 0),Object(r["a"])([Object(s["a"])("viewModel.view")],Nt.prototype,"view",void 0),Object(r["a"])([Object(n["b"])(),Object(f["a"])(["create","update","undo","redo"])],Nt.prototype,"viewModel",void 0),Object(r["a"])([Object(n["b"])()],Nt.prototype,"visibleElements",void 0),Object(r["a"])([Object(o["a"])("visibleElements")],Nt.prototype,"castVisibleElements",null),Object(r["a"])([Object(s["a"])("viewModel.complete")],Nt.prototype,"complete",null),Object(r["a"])([Object(s["a"])("viewModel.undo")],Nt.prototype,"undo",null),Object(r["a"])([Object(s["a"])("viewModel.redo")],Nt.prototype,"redo",null),Object(r["a"])([Object(s["a"])("viewModel.delete")],Nt.prototype,"delete",null),Nt=Object(r["a"])([Object(c["a"])("esri.widgets.Sketch")],Nt);var qt=Nt;t["a"]=qt},9617:function(e,t,i){"use strict";i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return n}));var r=i("3886"),a=i("d047");function n(e){e.include(a["a"]),e.uniforms.add("geometryDepthTexture","sampler2D"),e.uniforms.add("cameraNearFar","vec2"),e.code.add(r["a"]`
    //Compare the linearized depths of the vertex/fragment and the geometry in the scene. If vertex/fragment is behind geometry, don't draw it.
    bool geometryDepthTest(vec2 pos, float elementDepth){

      float geometryDepth = linearDepthFromTexture(geometryDepthTexture, pos, cameraNearFar);
      if(elementDepth < (geometryDepth - 1.0)){
        return true;
      }
      return false;
    }
  `)}function s(e,t,i){i.multipassGeometryEnabled&&i.geometryLinearDepthTexture&&(e.setUniform1i("geometryDepthTexture",11),t.bindTexture(i.geometryLinearDepthTexture,11))}},9651:function(e,t,i){"use strict";i.d(t,"a",(function(){return S}));var r=i("a4ee"),a=(i("c120"),i("e92d")),n=i("59b2"),s=i("1a3e"),o=i("d386"),c=i("ce50"),l=i("e041"),h=(i("8eed"),i("f402"),i("8a44")),d=i("f4cc"),u=i("5815"),p=i("fc29"),f=i("2eab"),m=i("af40"),b=i("3795"),g=i("c24e"),v=i("7ffa"),y=i("b50f");class O{constructor(){this.location={left:0,top:0,width:0,height:0},this._allAvailability="unknown",this.byteSize=40}getAvailability(e,t){if("unknown"!==this._allAvailability)return this._allAvailability;const i=(e-this.location.top)*this.location.width+(t-this.location.left),r=i%8,a=i>>3,n=this._tileAvailabilityBitSet;return a<0||a>n.length?"unknown":n[a]&1<<r?"available":"unavailable"}_updateFromData(e){const t=this.location.width,i=this.location.height;let r=!0,a=!0;const n=Math.ceil(t*i/8),s=new Uint8Array(n);let o=0;for(let c=0;c<e.length;c++){const t=c%8;e[c]?(a=!1,s[o]|=1<<t):r=!1,7===t&&++o}a?this._allAvailability="unavailable":r?this._allAvailability="available":(this._allAvailability="unknown",this._tileAvailabilityBitSet=s,this.byteSize+=s.length)}static fromDefinition(e,t){const i=e.service.request||f["default"],{row:r,col:a,width:n,height:s}=e,o={query:{f:"json"}};return t=t?{...o,...t}:o,i(x(e),t).then(e=>e.data).catch(e=>{if(e&&e.details&&422===e.details.httpStatus)return{location:{top:r,left:a,width:n,height:s},valid:!0,data:Object(y["c"])(n*s,0)};throw e}).then(e=>{if(e.location&&(e.location.top!==r||e.location.left!==a||e.location.width!==n||e.location.height!==s))throw new c["a"]("tilemap:location-mismatch","Tilemap response for different location than requested",{response:e,definition:{top:r,left:a,width:n,height:s}});return O.fromJSON(e)})}static fromJSON(e){O.validateJSON(e);const t=new O;return t.location=Object.freeze(Object(v["a"])(e.location)),t._updateFromData(e.data),Object.freeze(t)}static validateJSON(e){if(!e||!e.location)throw new c["a"]("tilemap:missing-location","Location missing from tilemap response");if(!1===e.valid)throw new c["a"]("tilemap:invalid","Tilemap response was marked as invalid");if(!e.data)throw new c["a"]("tilemap:missing-data","Data missing from tilemap response");if(!Array.isArray(e.data))throw new c["a"]("tilemap:data-mismatch","Data must be an array of numbers");if(e.data.length!==e.location.width*e.location.height)throw new c["a"]("tilemap:data-mismatch","Number of data items does not match width/height of tilemap")}}function _(e){return`${e.level}/${e.row}/${e.col}/${e.width}/${e.height}`}function x(e){let t;if("vector-tile"===e.service.type)t=`${e.service.url}/tilemap/${e.level}/${e.row}/${e.col}/${e.width}/${e.height}`;else{const i=e.service.tileServers;t=`${i&&i.length?i[e.row%i.length]:e.service.url}/tilemap/${e.level}/${e.row}/${e.col}/${e.width}/${e.height}`}const i=e.service.query;return i&&(t=`${t}?${i}`),t}var j;const w=a["a"].getLogger("esri.layers.support.TilemapCache");let S=j=class extends p["a"]{constructor(e){super(e),this._handles=new m["a"],this._pendingTilemapRequests={},this._availableLevels={},this.levels=5,this.cacheByteSize=2097152,this.request=f["default"],this._prefetchingEnabled=!0}initialize(){this._tilemapCache=new g["a"](this.cacheByteSize),this._handles.add([this.watch(["layer.parsedUrl","layer.tileServers?"],()=>this._initializeTilemapDefinition()),Object(b["a"])(this,"layer.tileInfo.lods",e=>this._initializeAvailableLevels(e),!0)]),this._initializeTilemapDefinition()}destroy(){this._handles&&(this._handles.destroy(),this._handles=null)}castLevels(e){return e<=2?(w.error("Minimum levels for Tilemap is 3, but got ",e),3):e}get size(){return 1<<this.levels}fetchTilemap(e,t,i,r){if(!this._availableLevels[e])return Promise.reject(new c["a"]("tilemap-cache:level-unavailable",`Level ${e} is unavailable in the service`));const a=this._tmpTilemapDefinition,n=this._tilemapFromCache(e,t,i,a);if(n)return Promise.resolve(n);const s=r&&r.signal;return r={...r,signal:null},new Promise((e,t)=>{Object(d["r"])(s,()=>t(Object(d["f"])()));const i=_(a);let n=this._pendingTilemapRequests[i];if(!n){n=O.fromDefinition(a,r).then(e=>(this._tilemapCache.put(i,e,e.byteSize),e));const e=()=>delete this._pendingTilemapRequests[i];this._pendingTilemapRequests[i]=n,n.then(e,e)}n.then(e,t)})}getAvailability(e,t,i){if(!this._availableLevels[e])return"unavailable";const r=this._tilemapFromCache(e,t,i,this._tmpTilemapDefinition);return r?r.getAvailability(t,i):"unknown"}getAvailabilityUpsample(e,t,i,r){r.level=e,r.row=t,r.col=i;const a=this.layer.tileInfo;for(a.updateTileInfo(r);;){const e=this.getAvailability(r.level,r.row,r.col);if("unavailable"!==e)return e;if(!a.upsampleTile(r))return"unavailable"}}fetchAvailability(e,t,i,r){return this._availableLevels[e]?this.fetchTilemap(e,t,i,r).catch(e=>e).then(r=>{if(r instanceof O){const a=r.getAvailability(t,i);return"unavailable"===a?Promise.reject(new c["a"]("tile-map:tile-unavailable","Tile is not available",{level:e,row:t,col:i})):a}if(Object(d["n"])(r))throw r;return"unknown"}):Promise.reject(new c["a"]("tilemap-cache:level-unavailable",`Level ${e} is unavailable in the service`))}fetchAvailabilityUpsample(e,t,i,r,a){r.level=e,r.row=t,r.col=i;const n=this.layer.tileInfo;n.updateTileInfo(r);const s=this.fetchAvailability(e,t,i,a).catch(e=>{if(Object(d["n"])(e))throw e;if(n.upsampleTile(r))return this.fetchAvailabilityUpsample(r.level,r.row,r.col,r);throw e});return this._fetchAvailabilityUpsamplePrefetch(r.id,e,t,i,a,s),s}async _fetchAvailabilityUpsamplePrefetch(e,t,i,r,a,n){if(!this._prefetchingEnabled)return;const s="prefetch-"+e;if(this._handles.has(s))return;const o=Object(d["e"])();n.then(()=>o.abort(),()=>o.abort());let c=!1;const l={remove(){c||(c=!0,o.abort())}};if(this._handles.add(l,s),await Object(u["d"])(10,o.signal).catch(()=>{}),c||(c=!0,this._handles.remove(s)),Object(d["o"])(o))return;const h={id:e,level:t,row:i,col:r},p={...a,signal:o.signal},f=this.layer.tileInfo;for(let d=0;j._prefetches.length<j._maxPrefetch&&f.upsampleTile(h);++d){const e=this.fetchAvailability(h.level,h.row,h.col,p);j._prefetches.push(e);const t=()=>{j._prefetches.removeUnordered(e)};e.then(t,t)}}_initializeTilemapDefinition(){if(!this.layer.parsedUrl)return;const e=this.layer.parsedUrl,t=e.query;this._tilemapCache.clear(),this._tmpTilemapDefinition={service:{url:e.path,query:t?Object(l["D"])(t):null,tileServers:this.layer.tileServers,request:this.request,type:this.layer.type},width:this.size,height:this.size,level:0,row:0,col:0}}_tilemapFromCache(e,t,i,r){r.level=e,r.row=t-t%this.size,r.col=i-i%this.size;const a=_(r);return this._tilemapCache.get(a)}_initializeAvailableLevels(e){this._availableLevels={},e&&e.forEach(e=>this._availableLevels[e.level]=!0)}get test(){const e=this;return{get prefetchingEnabled(){return e._prefetchingEnabled},set prefetchingEnabled(t){e._prefetchingEnabled=t},hasTilemap:(t,i,r)=>!!e._tilemapFromCache(t,i,r,e._tmpTilemapDefinition)}}};S._maxPrefetch=4,S._prefetches=new h["a"]({initialSize:j._maxPrefetch}),Object(r["a"])([Object(n["b"])({constructOnly:!0,type:Number})],S.prototype,"levels",void 0),Object(r["a"])([Object(s["a"])("levels")],S.prototype,"castLevels",null),Object(r["a"])([Object(n["b"])({readOnly:!0,type:Number})],S.prototype,"size",null),Object(r["a"])([Object(n["b"])({constructOnly:!0,type:Number})],S.prototype,"cacheByteSize",void 0),Object(r["a"])([Object(n["b"])({constructOnly:!0})],S.prototype,"layer",void 0),Object(r["a"])([Object(n["b"])({constructOnly:!0})],S.prototype,"request",void 0),S=j=Object(r["a"])([Object(o["a"])("esri.layers.support.TilemapCache")],S)},9714:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i("7b7d"),a=i("0646");class n{constructor(e,t){this.owner=t,this.properties={},this.afterDispatchHandle=null;for(const i in e){const t=e[i],a=new r["a"](t,null,null,2,2);this.properties[i]={pool:a,acquired:[]}}this.afterDispatchHandle=Object(a["a"])(()=>this.release())}destroy(){this.afterDispatchHandle&&(this.afterDispatchHandle.remove(),this.afterDispatchHandle=null);for(const e in this.properties){const t=this.properties[e];for(const e of t.acquired)Object(a["b"])(e)||t.pool.release(e);t.pool.destroy(),t.pool=null,t.acquired=null}this.properties=null,this.owner=null}get(e){const t=this.owner._get(e),i=this.properties[e];let r=i.pool.acquire();for(i.acquired.push(r);r===t;)i.acquired.push(r),r=i.pool.acquire();return r}release(){for(const e in this.properties){const t=this.properties[e];let i=0;for(const e of t.acquired)Object(a["b"])(e)?t.acquired[i++]=e:t.pool.release(e);t.acquired.length=i}}}},"998f":function(e,t,i){"use strict";i.d(t,"a",(function(){return m})),i.d(t,"b",(function(){return f}));i("c120");var r=i("b2b2"),a=(i("38a4"),i("0b2d")),n=i("8e37"),s=i("1153"),o=i("7ce4"),c=i("0fa6"),l=i("9a64"),h=i("d267"),d=i("377b");class u{constructor(e){this.context=e,this.svgAlwaysPremultipliesAlpha=!1,this._doublePrecisionRequiresObfuscation=null,Object(d["a"])(e).then(e=>{this.svgAlwaysPremultipliesAlpha=!e})}get doublePrecisionRequiresObfuscation(){if(Object(r["j"])(this._doublePrecisionRequiresObfuscation)){const e=b(this.context,!1),t=b(this.context,!0);this._doublePrecisionRequiresObfuscation=0!==e&&(0===t||e/t>5)}return this._doublePrecisionRequiresObfuscation}}let p=null;function f(e){return(Object(r["j"])(p)||p.context!==e)&&(p=new u(e)),p}function m(e){Object(r["k"])(p)&&p.context===e&&(p=null)}function b(e,t){const i=new h["a"](e,{colorTarget:0,depthStencilTarget:0},{target:3553,wrapMode:33071,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1});function r(i,r){const a=new n["a"](e,`\n\n  precision highp float;\n\n  attribute vec2 a_pos;\n\n  uniform vec3 u_highA;\n  uniform vec3 u_lowA;\n  uniform vec3 u_highB;\n  uniform vec3 u_lowB;\n\n  varying vec4 v_color;\n\n  ${t?"#define DOUBLE_PRECISION_REQUIRES_OBFUSCATION":""}\n\n  #ifdef DOUBLE_PRECISION_REQUIRES_OBFUSCATION\n\n  vec3 dpPlusFrc(vec3 a, vec3 b) {\n    return mix(a, a + b, vec3(notEqual(b, vec3(0))));\n  }\n\n  vec3 dpMinusFrc(vec3 a, vec3 b) {\n    return mix(vec3(0), a - b, vec3(notEqual(a, b)));\n  }\n\n  vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {\n    vec3 t1 = dpPlusFrc(hiA, hiB);\n    vec3 e = dpMinusFrc(t1, hiA);\n    vec3 t2 = dpMinusFrc(hiB, e) + dpMinusFrc(hiA, dpMinusFrc(t1, e)) + loA + loB;\n    return t1 + t2;\n  }\n\n  #else\n\n  vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {\n    vec3 t1 = hiA + hiB;\n    vec3 e = t1 - hiA;\n    vec3 t2 = ((hiB - e) + (hiA - (t1 - e))) + loA + loB;\n    return t1 + t2;\n  }\n\n  #endif\n\n  const float MAX_RGBA_FLOAT =\n    255.0 / 256.0 +\n    255.0 / 256.0 / 256.0 +\n    255.0 / 256.0 / 256.0 / 256.0 +\n    255.0 / 256.0 / 256.0 / 256.0 / 256.0;\n\n  const vec4 FIXED_POINT_FACTORS = vec4(1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0);\n\n  vec4 float2rgba(const float value) {\n    // Make sure value is in the domain we can represent\n    float valueInValidDomain = clamp(value, 0.0, MAX_RGBA_FLOAT);\n\n    // Decompose value in 32bit fixed point parts represented as\n    // uint8 rgba components. Decomposition uses the fractional part after multiplying\n    // by a power of 256 (this removes the bits that are represented in the previous\n    // component) and then converts the fractional part to 8bits.\n    vec4 fixedPointU8 = floor(fract(valueInValidDomain * FIXED_POINT_FACTORS) * 256.0);\n\n    // Convert uint8 values (from 0 to 255) to floating point representation for\n    // the shader\n    const float toU8AsFloat = 1.0 / 255.0;\n\n    return fixedPointU8 * toU8AsFloat;\n  }\n\n  void main() {\n    vec3 val = dpAdd(u_highA, u_lowA, -u_highB, -u_lowB);\n\n    v_color = float2rgba(val.z / 25.0);\n\n    gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);\n  }\n  `,"\n  precision highp float;\n\n  varying vec4 v_color;\n\n  void main() {\n    gl_FragColor = v_color;\n  }\n  ",{a_pos:0}),s=new Float32Array(6);Object(l["a"])(i,s,3);const o=new Float32Array(6);return Object(l["a"])(r,o,3),e.bindProgram(a),a.setUniform3f("u_highA",s[0],s[2],s[4]),a.setUniform3f("u_lowA",s[1],s[3],s[5]),a.setUniform3f("u_highB",o[0],o[2],o[4]),a.setUniform3f("u_lowB",o[1],o[3],o[5]),a}const d=o["a"].createVertex(e,35044,new Uint16Array([0,0,1,0,0,1,1,1])),u=new c["a"](e,{a_pos:0},{geometry:[{name:"a_pos",count:2,type:5123,offset:0,stride:4,normalized:!1}]},{geometry:d}),p=Object(a["g"])(5633261.287538229,2626832.878767164,1434988.0495278358),f=Object(a["g"])(5633271.46742708,2626873.6381334523,1434963.231608387),m=r(p,f),b=e.getBoundFramebufferObject(),{x:g,y:v,width:y,height:O}=e.getViewport();e.bindFramebuffer(i),e.setViewport(0,0,1,1),e.bindVAO(u),e.drawArrays(5,0,4);const _=new Uint8Array(4);i.readPixels(0,0,1,1,6408,5121,_),m.dispose(),u.dispose(!1),d.dispose(),i.dispose(),e.setViewport(g,v,y,O),e.bindFramebuffer(b);const x=(p[2]-f[2])/25,j=Object(s["n"])(_);return Math.abs(x-j)}},"99af":function(e,t,i){"use strict";var r=i("23e7"),a=i("d039"),n=i("e8b5"),s=i("861d"),o=i("7b0b"),c=i("50c4"),l=i("8418"),h=i("65f0"),d=i("1dde"),u=i("b622"),p=i("2d00"),f=u("isConcatSpreadable"),m=9007199254740991,b="Maximum allowed index exceeded",g=p>=51||!a((function(){var e=[];return e[f]=!1,e.concat()[0]!==e})),v=d("concat"),y=function(e){if(!s(e))return!1;var t=e[f];return void 0!==t?!!t:n(e)},O=!g||!v;r({target:"Array",proto:!0,forced:O},{concat:function(e){var t,i,r,a,n,s=o(this),d=h(s,0),u=0;for(t=-1,r=arguments.length;t<r;t++)if(n=-1===t?s:arguments[t],y(n)){if(a=c(n.length),u+a>m)throw TypeError(b);for(i=0;i<a;i++,u++)i in n&&l(d,u,n[i])}else{if(u>=m)throw TypeError(b);l(d,u++,n)}return d.length=u,d}})},"9a68":function(e,t,i){"use strict";i.d(t,"a",(function(){return m})),i.d(t,"b",(function(){return f}));var r=i("3886"),a=i("690a"),n=i("4377"),s=i("d272"),o=i("d047"),c=i("ebd5"),l=i("c6d7"),h=i("e6aa"),d=i("c2d1"),u=i("6750"),p=i("c51b");function f(e){const t=new a["a"];t.extensions.add("GL_OES_standard_derivatives"),t.include(p["a"]),t.include(h["a"],e),t.include(u["a"],e),1===e.output&&t.include(d["a"],e),t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("cameraNearFar","vec2").add("pixelRatio","float").add("miterLimit","float").add("screenSize","vec2"),t.attributes.add("position","vec3"),t.attributes.add("subdivisionFactor","float"),t.attributes.add("uv0","vec2"),t.attributes.add("auxpos1","vec3"),t.attributes.add("auxpos2","vec3"),t.varyings.add("vColor","vec4"),t.varyings.add("vpos","vec3"),t.varyings.add("linearDepth","float"),e.multipassTerrainEnabled&&t.varyings.add("depth","float");const i=e.falloffEnabled,f=e.innerColorEnabled;return f&&t.varyings.add("vLineDistance","float"),i&&t.varyings.add("vLineDistanceNorm","float"),e.falloffEnabled&&t.fragment.uniforms.add("falloff","float"),e.innerColorEnabled&&(t.fragment.uniforms.add("innerColor","vec4"),t.fragment.uniforms.add("innerWidth","float")),t.vertex.code.add(r["a"]`
		#define PERPENDICULAR(v) vec2(v.y, -v.x);
		#define ISOUTSIDE (left.x * right.y - left.y * right.x)*uv0.y > 0.0

		float interp(float ncp, vec4 a, vec4 b) {
			return (-ncp - a.z) / (b.z - a.z);
		}

		vec2 rotate(vec2 v, float a) {
			float s = sin(a);
			float c = cos(a);
			mat2 m = mat2(c, -s, s, c);
			return m * v;
		}
`),t.vertex.code.add(r["a"]`
    vec4 projectAndScale(vec4 pos) {
      vec4 posNdc = proj * pos;

      // Note that posNdc is in -1:1, scaling by screenSize converts this to a coordinate system
      // that is twice scaled (going from -size:size).
      posNdc.xy *= screenSize / posNdc.w;
      return posNdc;
    }
`),t.vertex.code.add(r["a"]`
    void clipAndTransform(inout vec4 pos, inout vec4 prev, inout vec4 next, in bool isStartVertex) {
      float vnp = cameraNearFar[0] * 0.99;

      //current pos behind ncp --> we need to clip
      if(pos.z > -cameraNearFar[0]) {
        if (!isStartVertex) {
          //previous in front of ncp
          if(prev.z < -cameraNearFar[0]) {
            pos = mix(prev, pos, interp(vnp, prev, pos));
            next = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        }
        //next in front of ncp
        if(isStartVertex) {
          if(next.z < -cameraNearFar[0]) {
            pos = mix(pos, next, interp(vnp, pos, next));
            prev = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        }
      } else {
        //current position visible
        //previous behind ncp
        if (prev.z > -cameraNearFar[0]) {
          prev = mix(pos, prev, interp(vnp, pos, prev));
        }
        //next behind ncp
        if (next.z > -cameraNearFar[0]) {
          next = mix(next, pos, interp(vnp, next, pos));
        }
      }

      ${e.multipassTerrainEnabled?"depth = pos.z;":""}
      linearDepth = (-pos.z - cameraNearFar[0]) / (cameraNearFar[1] - cameraNearFar[0]);

      pos = projectAndScale(pos);
      next = projectAndScale(next);
      prev = projectAndScale(prev);
    }
`),t.vertex.code.add(r["a"]`
  void main(void) {
    float coverage = 1.0;
    vpos = position;

    // Check for special value of uv0.y which is used by the Renderer when graphics
    // are removed before the VBO is recompacted. If this is the case, then we just
    // project outside of clip space.
    if (uv0.y == 0.0) {
      // Project out of clip space
      gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
    }
    else {
      bool isStartVertex = abs(abs(uv0.y)-3.0) == 1.0;
      bool isJoin = abs(uv0.y)-3.0 < 0.0;

      float lineWidth = getSize() * pixelRatio;

      // convert sub-pixel coverage to alpha
      if (lineWidth < 1.0) {
        coverage = lineWidth;
        lineWidth = 1.0;
      }else{
        // Ribbon lines cannot properly render non-integer sizes. Round width to integer size if
        // larger than one for better quality. Note that we do render < 1 pixels more or less correctly
        // so we only really care to round anything larger than 1.
        lineWidth = floor(lineWidth + 0.5);
      }

      vec4 pos  = view * vec4(position.xyz, 1.0);
      vec4 prev = view * vec4(auxpos1.xyz, 1.0);
      vec4 next = view * vec4(auxpos2.xyz, 1.0);

      clipAndTransform(pos, prev, next, isStartVertex);

      vec2 left = (pos.xy - prev.xy);
      vec2 right = (next.xy - pos.xy);

      float leftLen = length(left);
      float rightLen = length(right);
  `),e.stippleEnabled&&t.vertex.code.add(r["a"]`
      // uv0.x is either 0 or 1, depending on whether this is considered the start of a line segment
      // or the end. If start, then use pos->next, otherwise use prev->pos to define the line segment
      // vector
      vec4 stippleSegmentInfo = mix(vec4(pos.xy, right), vec4(prev.xy, left), uv0.x);
      vec2 stippleSegmentOrigin = stippleSegmentInfo.xy;

      // Scale s.t. it's in units of stipple pattern size.
      vec2 stippleSegmentDirection = stippleSegmentInfo.zw;
    `),t.vertex.code.add(r["a"]`
    left = (leftLen > 0.001) ? left/leftLen : vec2(0.0, 0.0);
    right = (rightLen > 0.001) ? right/rightLen : vec2(0.0, 0.0);

    vec2 capDisplacementDir = vec2(0, 0);
    vec2 joinDisplacementDir = vec2(0, 0);
    float displacementLen = lineWidth;

    if (isJoin) {

      // JOIN handling ---------------------------------------------------
      // determine if vertex is on the "outside or "inside" of the join
      bool isOutside = ISOUTSIDE;

      // compute miter join position first
      joinDisplacementDir = normalize(left + right);
      joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);

      // compute miter stretch
      if (leftLen > 0.001 && rightLen > 0.001) {
        float nDotSeg = dot(joinDisplacementDir, left);
        displacementLen /= length(nDotSeg * left - joinDisplacementDir);

        // limit displacement of inner vertices
        if (!isOutside) {
          displacementLen = min(displacementLen, min(leftLen, rightLen)/abs(nDotSeg));
        }
      }

      if (isOutside && (displacementLen > miterLimit * lineWidth)) {
    `),e.roundJoins?t.vertex.code.add(r["a"]`
        vec2 startDir;
        vec2 endDir;

        if (leftLen < 0.001) {
          startDir = right;
        }
        else{
          startDir = left;
        }
        startDir = normalize(startDir);
        startDir = PERPENDICULAR(startDir);

        if (rightLen < 0.001) {
          endDir = left;
        }
        else{
          endDir = right;
        }
        endDir = normalize(endDir);
        endDir = PERPENDICULAR(endDir);

        float rotationAngle = acos(clamp(dot(startDir, endDir), -1.0, 1.0));
        joinDisplacementDir = rotate(startDir, -sign(uv0.y) * subdivisionFactor * rotationAngle);
      `):t.vertex.code.add(r["a"]`
        // convert to bevel join if miterLimit is exceeded
        if (leftLen < 0.001) {
          joinDisplacementDir = right;
        }
        else if (rightLen < 0.001) {
          joinDisplacementDir = left;
        }
        else {
          joinDisplacementDir = isStartVertex ? right : left;
        }
        joinDisplacementDir = normalize(joinDisplacementDir);
        joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);
  `),t.vertex.code.add(r["a"]`
        displacementLen = lineWidth;
      }
    } else {
    // CAP handling ---------------------------------------------------
    if (leftLen < 0.001) {
      joinDisplacementDir = right;
    }
    else if (rightLen < 0.001) {
      joinDisplacementDir = left;
    }
    else {
      joinDisplacementDir = isStartVertex ? right : left;
    }
    joinDisplacementDir = normalize(joinDisplacementDir);
    joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);
    displacementLen = lineWidth;

    capDisplacementDir = isStartVertex ? -right : left;
  `),e.roundCaps?t.vertex.code.add(r["a"]`
    float angle = subdivisionFactor*PI*0.5;
    joinDisplacementDir *= cos(angle);
    capDisplacementDir *= sin(angle);
    `):t.vertex.code.add(r["a"]`
    capDisplacementDir *= subdivisionFactor;
    `),t.vertex.code.add(r["a"]`
  }

  // Displacement (in pixels) caused by join/or cap
  vec2 dpos = joinDisplacementDir * sign(uv0.y) * displacementLen + capDisplacementDir * displacementLen;

  ${i||f?r["a"]`float lineDist = lineWidth * sign(uv0.y) * pos.w;`:""}

  ${f?r["a"]`vLineDistance = lineDist;`:""}
  ${i?r["a"]`vLineDistanceNorm = lineDist / lineWidth;`:""}

  pos.xy += dpos;
  `),e.stippleEnabled&&(t.vertex.code.add(r["a"]`
    {
      // Compute the stipple pattern UV coordinate from the actual position, based on the origin
      // and direction of the line segment on which the stipple pattern is based.

      // Project the vector from the origin of the segment to the vertex onto the line segment.
      // Note the 0.5 factor due to projected positions being at twice the screen size scale (see projectAndScale)
      vec2 posVec = pos.xy - stippleSegmentOrigin;

      float stippleSegmentDirectionLength = length(stippleSegmentDirection);
    `),e.stippleIntegerRepeatsEnabled&&t.vertex.code.add(r["a"]`
      float numberOfPatternRepeats = stippleSegmentDirectionLength * 0.5 * stipplePatternPixelSizeInv;
      float roundedNumberOfPatternRepeats = floor(numberOfPatternRepeats);
      stipplePatternUvMax = roundedNumberOfPatternRepeats;
      `),t.vertex.code.add(r["a"]`
      if (stippleSegmentDirectionLength >= 0.001) {
        // Project the vertex position onto the line segment.
        float projectedLength = dot(stippleSegmentDirection, posVec) / stippleSegmentDirectionLength * 0.5;
     ${e.stippleIntegerRepeatsEnabled?"float wholeNumberOfRepeatsScale = roundedNumberOfPatternRepeats / numberOfPatternRepeats;":"float wholeNumberOfRepeatsScale = 1.0;"}
        stipplePatternUv = projectedLength * wholeNumberOfRepeatsScale * stipplePatternPixelSizeInv * pos.w;
        } else {
          stipplePatternUv = 1.0;
        }
      }
    `)),t.vertex.code.add(r["a"]`
      // Convert back into NDC
      pos.xy = pos.xy / screenSize * pos.w;

      vColor = getColor();
      vColor.a *= coverage;

      gl_Position = pos;
    }
  }
  `),e.multipassTerrainEnabled&&(t.fragment.include(o["a"]),t.include(l["b"],e)),t.include(s["a"],e),t.fragment.uniforms.add("intrinsicColor","vec4"),t.fragment.include(n["a"]),t.fragment.code.add(r["a"]`
  void main() {
    discardBySlice(vpos);
    ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
    float stippleAlpha = getStippleAlpha();
    discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);

    vec4 color = intrinsicColor * vColor;
  `),e.innerColorEnabled&&(t.fragment.uniforms.add("pixelRatio","float"),t.fragment.code.add(r["a"]`
    float distToInner = abs(vLineDistance * gl_FragCoord.w) - innerWidth;
    float innerAA = clamp(0.5 - distToInner, 0.0, 1.0);
    float innerAlpha = innerColor.a + color.a * (1.0 - innerColor.a);
    color = mix(color, vec4(innerColor.rgb, innerAlpha), innerAA);
    `)),t.fragment.code.add(r["a"]`
    vec4 finalColor = blendStipple(color, stippleAlpha);
  `),e.falloffEnabled&&t.fragment.code.add(r["a"]`
    finalColor.a *= pow(max(0.0, 1.0 - abs(vLineDistanceNorm * gl_FragCoord.w)), falloff);
    `),t.fragment.code.add(r["a"]`
    if (finalColor.a < ${r["a"].float(c["c"])}) {
      discard;
    }

    ${7===e.output?r["a"]`gl_FragColor = vec4(finalColor.a);`:""}
    ${0===e.output?r["a"]`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${0===e.output&&e.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
    ${4===e.output?r["a"]`gl_FragColor = vec4(1.0);`:""}
    ${1===e.output?r["a"]`outputDepth(linearDepth);`:""}
  }
  `),t}var m=Object.freeze({__proto__:null,build:f})},"9ac8":function(e,t,i){"use strict";i.d(t,"a",(function(){return a})),i.d(t,"b",(function(){return n}));i("c120");var r=i("caf7");function a(e){switch(e){case"sphere":case"cube":case"diamond":case"cylinder":case"cone":case"inverted-cone":case"tetrahedron":return!0}return!1}function n(e,t){const i=(e,i,a=!1)=>({levels:e.map(e=>{const n=i(e.tesselation);return a&&r["a"].cgToGIS(n),{components:[{geometry:n,material:t}],faceCount:n.indexCount/3,minScreenSpaceRadius:e.minScreenSpaceRadius}})});switch(e){case"sphere":return i([{tesselation:0,minScreenSpaceRadius:0},{tesselation:1,minScreenSpaceRadius:8},{tesselation:2,minScreenSpaceRadius:16},{tesselation:3,minScreenSpaceRadius:50},{tesselation:4,minScreenSpaceRadius:250}],e=>r["a"].createPolySphereGeometry(.5,e,!0));case"cube":return i([{tesselation:0,minScreenSpaceRadius:0}],()=>r["a"].createBoxGeometry(1));case"cone":return i(s,e=>r["a"].createConeGeometry(1,.5,e,!1),!0);case"inverted-cone":return i(s,e=>r["a"].createConeGeometry(1,.5,e,!0),!0);case"cylinder":return i(s,e=>r["a"].createCylinderGeometry(1,.5,e,[0,0,1],[0,0,.5]));case"tetrahedron":return i([{tesselation:0,minScreenSpaceRadius:0}],()=>r["a"].createTetrahedronGeometry(1),!0);case"diamond":return i([{tesselation:0,minScreenSpaceRadius:0}],()=>r["a"].createDiamondGeometry(1),!0);default:return}}const s=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}]},"9def":function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i("fdc9");function a(e){const t=new Map,i=e=>{let i=t.get(e);return i||(i=new r["b"],t.set(e,i)),i};return e.adds.forAll(e=>{n(e)&&i(e.material).adds.push(e)}),e.removes.forAll(e=>{n(e)&&i(e.material).removes.push(e)}),e.updates.forAll(e=>{n(e.renderGeometry)&&i(e.renderGeometry.material).updates.push(e)}),t}function n(e){return e.data.indexCount>=1}},"9e77":function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));var r=i("3886"),a=i("d047"),n=i("58c2");function s(e,t){e.extensions.add("GL_OES_standard_derivatives"),e.fragment.include(a["a"]),e.include(n["a"]),e.fragment.uniforms.add("glowColor","vec3"),e.fragment.uniforms.add("glowWidth","float"),e.fragment.uniforms.add("glowFalloff","float"),e.fragment.uniforms.add("innerColor","vec3"),e.fragment.uniforms.add("innerWidth","float"),e.fragment.uniforms.add("depthMap","sampler2D"),e.fragment.uniforms.add("nearFar","vec2"),e.fragment.uniforms.add("frameColor","sampler2D"),t.contrastControlEnabled&&e.fragment.uniforms.add("globalAlphaContrastBoost","float"),e.fragment.code.add(r["a"]`
  vec4 blendPremultiplied(vec4 source, vec4 dest) {
    float oneMinusSourceAlpha = 1.0 - source.a;

    return vec4(
      source.rgb + dest.rgb * oneMinusSourceAlpha,
      source.a + dest.a * oneMinusSourceAlpha
    );
  }
  `),e.fragment.code.add(r["a"]`
  vec4 premultipliedColor(vec3 rgb, float alpha) {
    return vec4(rgb * alpha, alpha);
  }
  `),e.fragment.code.add(r["a"]`
  vec4 laserlineProfile(float dist) {
    if (dist > glowWidth) {
      return vec4(0.0);
    }

    float innerAlpha = (1.0 - smoothstep(0.0, innerWidth, dist));
    float glowAlpha = pow(max(0.0, 1.0 - dist / glowWidth), glowFalloff);

    return blendPremultiplied(
      premultipliedColor(innerColor, innerAlpha),
      premultipliedColor(glowColor, glowAlpha)
    );
  }
  `),e.fragment.code.add(r["a"]`
  bool laserlineReconstructFromDepth(out vec3 pos, out vec3 normal, out float depthDiscontinuityAlpha) {
    float depth = linearDepthFromTexture(depthMap, uv, nearFar);

    if (-depth == nearFar[0]) {
      return false;
    }

    pos = reconstructPosition(gl_FragCoord.xy, depth);
    normal = normalize(cross(dFdx(pos), dFdy(pos)));

    float ddepth = fwidth(depth);
    depthDiscontinuityAlpha = 1.0 - smoothstep(0.0, 0.01, -ddepth / depth);

    return true;
  }
  `),t.contrastControlEnabled?e.fragment.code.add(r["a"]`
    float rgbToLuminance(vec3 color) {
      return dot(vec3(0.2126, 0.7152, 0.0722), color);
    }

    vec4 laserlineOutput(vec4 color) {
      float backgroundLuminance = rgbToLuminance(texture2D(frameColor, uv).rgb);
      float alpha = clamp(globalAlpha * max(backgroundLuminance * globalAlphaContrastBoost, 1.0), 0.0, 1.0);

      return color * alpha;
    }
    `):e.fragment.code.add(r["a"]`
    vec4 laserlineOutput(vec4 color) {
      return color * globalAlpha;
    }
    `)}},"9ee2":function(e,t,i){"use strict";i.d(t,"a",(function(){return a})),i.d(t,"b",(function(){return r}));const r={value:.5,readOnly:!0},a={readOnly:!0,value:.5,get(){return this.updating?this.updatingProgressValue:1}}},a03d:function(e,t,i){"use strict";i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return n})),i.d(t,"c",(function(){return u})),i.d(t,"d",(function(){return f})),i.d(t,"e",(function(){return h})),i.d(t,"f",(function(){return m})),i.d(t,"g",(function(){return d})),i.d(t,"h",(function(){return p})),i.d(t,"i",(function(){return o})),i.d(t,"j",(function(){return b})),i.d(t,"k",(function(){return c}));var r=i("b2b2"),a=i("8a44");class n{constructor(){this._queue=new a["a"],this._last=null,this.remove=()=>{}}get done(){return 0===this._queue.length&&(!this._last||this._last.isLeaf)}resetOne(e){this._queue.clear(),this._queue.push(e),this._last=null}reset(e=null){this._queue.clear(),Object(r["k"])(e)&&this._queue.pushArray(e),this._last=null}skipSubtree(){this._last=null}next(){return this._last&&!this._last.isLeaf&&this._queue.pushArray(this._last.children),this._last=this._queue.pop(),this._last}}class s{constructor(){this.q=new a["a"]}get done(){return 0===this.q.length}reset(e){if(this.q.clear(),e){this.q.pushArray(e);for(let e=0;e<this.q.length;++e){const t=this.q.data[e];t.isLeaf||this.q.pushArray(t.children)}}}next(){return this.q.pop()}}function o(e){return e?e.lij.toString():"null"}function c(e,t){if(Array.isArray(e))for(let i=0;i<e.length;i++)l(e[i],t);else l(e,t)}function l(e,t){if(t(e),!e.isLeaf)for(const i of e.children)l(i,t)}function h(e,t,i){if(Object(r["j"])(t))return!1;const a=t.fullExtent,n=e.extent;if(i){if(n[0]<a.xmin||n[1]<a.ymin||n[2]>a.xmax||n[3]>a.ymax)return!1}else if(a.xmin>n[2]||a.ymin>n[3]||a.xmax<n[0]||a.ymax<n[1])return!1;const s=e.surface.tilingScheme.levels[e.lij[0]].scale;return!(t.minScale>0&&s>1.00000001*t.minScale)&&!(t.maxScale>0&&s<.99999999*t.maxScale)}function d(e,t){t.sort((t,i)=>u(t,i,e))}function u(e,t,i){const r=e.screenDepth,a=t.screenDepth;return r<a?-i:r>a?i:0}function p(e,t){const i=new Map;e.forAll(e=>i.set(e,e.distanceToSquared(t))),e.sort((e,t)=>i.get(e)-i.get(t))}function f(e,t,i){let r=1,a=0,n=0;for(;e!==t;)if(r*=.5,a*=.5,n*=.5,1&e.lij[2]&&(a+=.5),0==(1&e.lij[1])&&(n+=.5),null==(e=e.parent))throw new Error("tile was not a descendant of upsampleTile");i.init(t,a,n,r)}function m(e){for(let t=0;t<e.length;t++){const i=e[t],r=i.parent;if(r)for(let e=0;e<4;e++){const t=r.children[e];if(t&&t!==i&&t.loadable)return!0}}return!1}function b(e,t){if(!e||!t||e[0]===t[0])return!1;const i=e[0]<t[0],r=i?e:t,a=i?t:e,n=1<<a[0]-r[0];return Math.floor(a[1]/n)===r[1]&&Math.floor(a[2]/n)===r[2]}},a326:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i("b2b2");function a(e){const t=e.capabilities.disjointTimerQuery;return Object(r["j"])(t)?null:t.timestampBits()>0?new n(t):o?null:new s(t)}class n{constructor(e){this.timer=e,this.start=e.createQuery(),e.createTimestamp(this.start)}stop(e,t=50){this.end=this.timer.createQuery(),this.timer.createTimestamp(this.end),this.checkQueryResult(e,t)}checkQueryResult(e,t){if(!this.timer.resultAvailable(this.end))return void setTimeout(()=>this.checkQueryResult(e,t),t);if(this.timer.disjoint())return void e(null);const i=this.timer.getResult(this.start),r=this.timer.getResult(this.end);e((r-i)/1e6)}}class s{constructor(e){this.timer=e,this.query=e.createQuery(),o=!0,this.timer.beginTimeElapsed(this.query)}stop(e,t=50){this.timer.endTimeElapsed(),o=!1,this.checkQueryResult(e,t)}checkQueryResult(e,t){const i=this.timer.resultAvailable(this.query),r=this.timer.disjoint();if(!i||r)r?e(null):setTimeout(()=>this.checkQueryResult(e,t),t);else{const t=this.timer.getResult(this.query);e(t/1e6)}}}let o=!1},a37d:function(e,t,i){"use strict";i.d(t,"a",(function(){return o}));var r=i("b2b2"),a=i("9ef0"),n=i("a915"),s=i("0fc4");class o{constructor(e){this.definition=e,this.key=JSON.stringify(e),this.haloSize=Math.round(e.halo.size),this.fillStyle=this.colorToRGBA(e.color),this.haloStyle=this.colorToRGB(e.halo.color)}colorToRGB(e){return`rgb(${e.slice(0,3).map(e=>Math.floor(255*e)).toString()})`}colorToRGBA(e){return`rgba(${e.slice(0,3).map(e=>Math.floor(255*e)).toString()},${e[3]})`}static fromSymbol(e,t=1){const i=Object(r["i"])(e,"material","color"),c=Object(r["k"])(i)?a["a"].toUnitRGBA(i):s["b"],l=e.halo,h=null!=e.size?Object(n["h"])(e.size):12,d={family:e.font&&e.font.family?e.font.family:"sans-serif",weight:e.font&&e.font.weight?e.font.weight:"normal",style:e.font&&e.font.style?e.font.style:"normal"},u=Object(r["k"])(l)&&Object(r["k"])(l.color)&&l.size>0?{size:Object(n["h"])(l.size),color:a["a"].toUnitRGBA(l.color)}:{size:0,color:s["b"]};return new o({size:h,color:c,font:d,halo:u,pixelRatio:t})}}},a445:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i("d7f7"),a=i("f498");class n extends r["a"]{constructor(e){super(e),this.updateParameters()}updateParameters(e){this.technique=this.techniqueRep.acquireAndReleaseExisting(a["a"],this.material.getTechniqueConfig(this.output,e),this.technique)}beginSlot(e){if(2===this.output)return 22===e;if(5===this.output)return null==e;if(4===this.output)return 3===e;let t=3;return this.material.params.transparent&&(t=this.material.params.writeDepth?5:8),e===t}setElapsedTimeUniform(e){const t=.001*this.material.animation.time;e.setUniform1f("timeElapsed",t*this.material.params.animationSpeed)}_updateShadowState(e){e.shadowMappingEnabled!==this.material.params.receiveShadows&&this.material.setParameterValues({receiveShadows:e.shadowMappingEnabled})}_updateSSRState(e){e.ssrEnabled!==this.material.params.ssrEnabled&&this.material.setParameterValues({ssrEnabled:e.ssrEnabled})}ensureResources(e){return this.technique.ensureResource(e)}ensureParameters(e){0===this.output&&(this._updateShadowState(e),this._updateSSRState(e)),this.updateParameters(e)}bind(e,t){e.bindProgram(this.technique.program),this.technique.bindPass(e,this.material.params,t),2!==this.output&&0!==this.output||this.setElapsedTimeUniform(this.technique.program)}}},a545:function(e,t,i){"use strict";i.d(t,"a",(function(){return b})),i.d(t,"b",(function(){return u}));var r=i("b2b2"),a=i("4ae5"),n=(i("e06a"),i("0b2d")),s=i("e431"),o=i("b139"),c=i("04f0"),l=i("a29a"),h=i("f7eb");function d(e,t,i=null){return Object(r["k"])(i)?[e,t,i]:[e,t]}function u(e,t,i=null){return Object(r["k"])(i)?{x:e,y:t,z:i}:{x:e,y:t}}class p{constructor(e){this.spatialReference=e}mapToLocalMultiple(e){return Object(r["g"])(e.map(e=>this.mapToLocal(e)))}get doUnnormalization(){return!1}}class f extends p{constructor(e,t,i=null){super(t),this.defaultZ=i,this.transform=Object(h["b"])(),this.transformInv=Object(h["b"])(),this.transform=Object(h["a"])(e),Object(l["a"])(this.transformInv,this.transform)}makeMapPoint(e,t){return d(e,t,this.defaultZ)}mapToLocal(e){return u(this.transform[0]*e[0]+this.transform[2]*e[1]+this.transform[4],this.transform[1]*e[0]+this.transform[3]*e[1]+this.transform[5])}localToMap(e){return d(this.transformInv[0]*e.x+this.transformInv[2]*e.y+this.transformInv[4],this.transformInv[1]*e.x+this.transformInv[3]*e.y+this.transformInv[5],this.defaultZ)}}class m extends p{constructor(e,t){super(e.spatialReference),this.view=e,this.defaultZ=null,this.pWS=Object(n["e"])(),this.tangentFrameUpWS=Object(n["e"])(),this.tangentFrameRightWS=Object(n["e"])(),this.tangentFrameForwardWS=Object(n["e"])(),this.localFrameRightWS=Object(n["e"])(),this.localFrameUpWS=Object(n["e"])(),this.worldToLocalTransform=Object(o["a"])(),this.localToWorldTransform=Object(o["a"])(),this.scale=1,this.scale=e.resolution,this.referenceMapPoint=t,this.defaultZ=t.hasZ?t.z:null;const i=e.state.camera.viewRight;this.view.renderCoordsHelper.toRenderCoords(this.referenceMapPoint,this.pWS),this.view.renderCoordsHelper.worldBasisAtPosition(this.pWS,0,this.tangentFrameRightWS),this.view.renderCoordsHelper.worldBasisAtPosition(this.pWS,1,this.tangentFrameUpWS),this.view.renderCoordsHelper.worldBasisAtPosition(this.pWS,2,this.tangentFrameForwardWS);const r=Object(n["e"])();Object(s["f"])(r,this.tangentFrameForwardWS,Object(s["i"])(i,this.tangentFrameForwardWS)),Object(s["k"])(this.localFrameRightWS,i,r),Object(s["s"])(this.localFrameRightWS,this.localFrameRightWS),Object(s["h"])(this.localFrameUpWS,this.tangentFrameForwardWS,this.localFrameRightWS),Object(c["f"])(this.worldToLocalTransform,this.localFrameRightWS,this.tangentFrameRightWS),Object(c["d"])(this.localToWorldTransform,this.worldToLocalTransform)}get doUnnormalization(){return"global"===this.view.viewingMode}makeMapPoint(e,t){return d(e,t,this.defaultZ)}mapToLocal(e){const t=Object(n["e"])();this.view.renderCoordsHelper.toRenderCoords(new a["a"]({x:e[0],y:e[1],spatialReference:this.spatialReference}),t),Object(s["v"])(t,t,this.worldToLocalTransform);const i=this.view.renderCoordsHelper.fromRenderCoords(t,this.view.spatialReference);return Object(r["k"])(i)?u(i.x/this.scale,i.y/this.scale):null}localToMap(e){const t=Object(n["e"])();this.view.renderCoordsHelper.toRenderCoords(new a["a"]({x:e.x*this.scale,y:e.y*this.scale,spatialReference:this.spatialReference}),t),Object(s["v"])(t,t,this.localToWorldTransform);const i=this.view.renderCoordsHelper.fromRenderCoords(t,this.view.spatialReference);return Object(r["k"])(i)?d(i.x,i.y,this.defaultZ):null}}function b(e,t){if("2d"===e.type)return new f(e.state.transform,e.spatialReference,t.length>2?t[2]:null);if("3d"===e.type){const i=t.length>2?new a["a"]({x:t[0],y:t[1],z:t[2],spatialReference:e.spatialReference}):new a["a"]({x:t[0],y:t[1],spatialReference:e.spatialReference});return new m(e,i)}return null}},a5b5:function(e,t,i){"use strict";i.d(t,"a",(function(){return r})),i.d(t,"b",(function(){return u})),i.d(t,"c",(function(){return h}));var r,a=i("3886"),n=i("690a"),s=i("7c1d"),o=i("d272"),c=i("d0cb"),l=i("9617");function h(e){const t=new n["a"];return t.include(s["a"]),t.include(c["a"],e),t.include(o["a"],e),t.attributes.add("uv0","vec2"),t.vertex.uniforms.add("lineSize","float").add("pixelToNDC","vec2").add("borderSize","float").add("screenOffset","vec2"),t.varyings.add("coverageSampling","vec4"),t.varyings.add("lineSizes","vec2"),e.multipassGeometryEnabled&&t.varyings.add("depth","float"),t.vertex.code.add(a["a"]`
    void main(void) {
      ProjectHUDAux projectAux;
      vec4 endPoint = projectPositionHUD(projectAux);

      vec3 vpos = projectAux.posModel;
      if (rejectBySlice(vpos)) {
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }
    ${e.occlusionTestEnabled?a["a"]`
      if (!testVisibilityHUD(endPoint)) {
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }`:""}

    ${e.screenSizePerspectiveEnabled?a["a"]`
      vec4 perspectiveFactor = screenSizePerspectiveScaleFactor(projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
      vec2 screenOffsetScaled = applyScreenSizePerspectiveScaleFactorVec2(screenOffset, perspectiveFactor);
        `:a["a"]`
      vec2 screenOffsetScaled = screenOffset;
        `}
      // Add view dependent polygon offset to get exact same original starting point. This is mostly
      // used to get the correct depth value
      vec3 posView = (view * vec4(position, 1.0)).xyz;
      ${e.multipassGeometryEnabled?"depth = posView.z;":""}

      applyHUDViewDependentPolygonOffset(auxpos1.w, projectAux.absCosAngle, posView);
      vec4 startPoint = proj * vec4(posView, 1.0);
      // Apply screen offset to both start and end point
      vec2 screenOffsetNorm = screenOffsetScaled * 2.0 / viewport.zw;
      startPoint.xy += screenOffsetNorm * startPoint.w;
      endPoint.xy += screenOffsetNorm * endPoint.w;
      // Align start and end to pixel origin
      vec4 startAligned = alignToPixelOrigin(startPoint, viewport.zw);
      vec4 endAligned = alignToPixelOrigin(endPoint, viewport.zw);
    ${e.depthHudEnabled?e.depthHudAlignStartEnabled?a["a"]`endAligned = vec4(endAligned.xy / endAligned.w * startAligned.w, startAligned.zw);`:a["a"]`startAligned = vec4(startAligned.xy / startAligned.w * endAligned.w, endAligned.zw);`:""}
      vec4 projectedPosition = mix(startAligned, endAligned, uv0.y);
      // The direction of the line in screen space
      vec2 screenSpaceDirection = normalize(endAligned.xy / endAligned.w - startAligned.xy / startAligned.w);
      vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x);
    ${e.screenSizePerspectiveEnabled?a["a"]`
      float lineSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(lineSize, perspectiveFactor);
      float borderSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(borderSize, perspectiveFactor);
        `:a["a"]`
      float lineSizeScaled = lineSize;
      float borderSizeScaled = borderSize;
        `}
      float halfPixelSize = lineSizeScaled * 0.5;
      // Calculate a pixel offset from the edge of the pixel, s.t. we keep the line aligned
      // to pixels if it has a full pixel size. Since pixel aligned biases to the bottom-left,
      // we bias the size to the right (for odd sizes) to balance out the bias. Grow sub-pixel
      // sizes towards the left or right s.t. there is a smooth transition (e.g. from 2 to 3 px).
      float halfWholePixelSize = floor(lineSizeScaled) * 0.5;
      float halfPixelSizeInt = floor(halfWholePixelSize);

      // Sub-pixel offset if we need to grow sub-pixels to the left
      float subpixelOffset = -fract(lineSizeScaled) * float(halfWholePixelSize > 0.0);

      // Pixel offset aligning to whole pixels and adding subpixel offset if needed
      float pixelOffset = -halfPixelSizeInt + subpixelOffset;

      // Compute full ndc offset, adding 1px padding for doing anti-aliasing and the border size
      float padding = 1.0 + borderSizeScaled;
      vec2 ndcOffset = (pixelOffset - padding + uv0.x * (lineSizeScaled + padding + padding)) * pixelToNDC;

      // Offset x/y from the center of the line in screen space
      projectedPosition.xy += perpendicularScreenSpaceDirection * ndcOffset * projectedPosition.w;

      // Compute a coverage varying which we can use in the fragment shader to determine
      // how much a pixel is actually covered by the line (i.e. to anti alias the line).
      // This works by computing two coordinates that can be linearly interpolated and then
      // subtracted to find out how far away from the line edge we are.
      float edgeDirection = (uv0.x * 2.0 - 1.0);

      float halfBorderSize = 0.5 * borderSizeScaled;
      float halfPixelSizeAndBorder = halfPixelSize + halfBorderSize;
      float outerEdgeCoverageSampler = edgeDirection * (halfPixelSizeAndBorder + halfBorderSize + 1.0);

      float isOneSided = float(lineSizeScaled < 2.0 && borderSize < 2.0);

      coverageSampling = vec4(
        // Edge coordinate
        outerEdgeCoverageSampler,

        // Border edge coordinate
        outerEdgeCoverageSampler - halfPixelSizeAndBorder * isOneSided,

        // Line offset
        halfPixelSize - 0.5,

        // Border offset
        halfBorderSize - 0.5 + halfPixelSizeAndBorder * (1.0 - isOneSided)
      );

      lineSizes = vec2(lineSizeScaled, borderSizeScaled);

      gl_Position = projectedPosition;
    }
  `),t.fragment.uniforms.add("color","vec4"),t.fragment.uniforms.add("borderColor","vec4"),e.multipassGeometryEnabled&&(t.fragment.include(l["b"],e),t.fragment.uniforms.add("inverseViewport","vec2")),t.fragment.code.add(a["a"]`
    void main() {
      ${e.multipassGeometryEnabled?"if( geometryDepthTest(gl_FragCoord.xy * inverseViewport, depth) ){ discard; }":""}

      // Mix between line and border coverage offsets depending on whether we need
      // a border (based on the sidedness).
      vec2 coverage = min(1.0 - clamp(abs(coverageSampling.xy) - coverageSampling.zw, 0.0, 1.0), lineSizes);

      // Mix between border and line color based on the line coverage (conceptually the line
      // blends on top of the border background).
      //
      // Anti-alias by blending final result using the full (including optional border) coverage
      // and the color alpha
      float borderAlpha = color.a * borderColor.a * coverage.y;
      float colorAlpha = color.a * coverage.x;

      float finalAlpha = mix(borderAlpha, 1.0, colorAlpha);

    ${e.depthHudEnabled?a["a"]`
      if (finalAlpha < 0.01) {
        discard;
      }
      `:a["a"]`
      // Compute the finalRgb, but keep it pre-multiplied (for unpre-multiplied you
      // need to divide by finalAlpha). We avoid the division here by setting the
      // appropriate blending function in the material.
      vec3 finalRgb = mix(borderColor.rgb * borderAlpha, color.rgb, colorAlpha);
      gl_FragColor = vec4(finalRgb, finalAlpha);
      `}
  }
  `),t}function d(e,t,i){3===i.length?e.setUniform4f(t,i[0],i[1],i[2],1):e.setUniform4fv(t,i)}!function(e){function t(e,t,i){d(e,"color",t.color),e.setUniform1f("pixelRatio",i),e.setUniform2f("screenOffset",t.screenOffset[0]*i,t.screenOffset[1]*i),null!==t.borderColor?(d(e,"borderColor",t.borderColor),e.setUniform1f("borderSize",i)):(e.setUniform4f("borderColor",0,0,0,0),e.setUniform1f("borderSize",0))}e.bindUniforms=t}(r||(r={}));var u=Object.freeze({__proto__:null,build:h,get LineCallout(){return r}})},a6c9:function(e,t,i){"use strict";i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return c})),i.d(t,"c",(function(){return o})),i.d(t,"d",(function(){return s})),i.d(t,"e",(function(){return h})),i.d(t,"f",(function(){return a})),i.d(t,"g",(function(){return l}));i("c120");var r=i("1153");function a(e,t,i){switch(e){case"circle":return n(t,i);case"square":return s(t,i);case"cross":return c(t,i);case"x":return l(t,i);case"kite":return o(t,i);case"triangle":return h(t,i);default:return n(t,i)}}function n(e,t){const i=e,a=new Uint8Array(4*i*i),n=i/2-.5,s=t/2;for(let o=0;o<i;o++)for(let t=0;t<i;t++){const c=t+i*o,l=t-n,h=o-n;let d=Math.sqrt(l*l+h*h)-s;d=d/e+.5,Object(r["i"])(d,a,4*c)}return a}function s(e,t){return d(e,t,!1)}function o(e,t){return d(e,t,!0)}function c(e,t){return u(e,t,!1)}function l(e,t){return u(e,t,!0)}function h(e,t){const i=new Uint8Array(4*e*e),a=1,n=-.5,s=Math.sqrt(a*a+n*n),o=(e-t)/2;for(let c=0;c<e;c++)for(let l=0;l<e;l++){const h=c*e+l,d=(l-o)/t,u=(c-o+.75)/t,p=-(a*d+n*u)/s,f=(a*(d-1)+n*-u)/s,m=-u,b=Math.max(p,f,m);Object(r["i"])(b*t/e+.5,i,4*h)}return i}function d(e,t,i){i&&(t/=Math.SQRT2);const a=new Uint8Array(4*e*e);for(let n=0;n<e;n++)for(let s=0;s<e;s++){let o=s-.5*e+.25,c=.5*e-n-.75;const l=n*e+s;if(i){const e=(o+c)/Math.SQRT2;c=(c-o)/Math.SQRT2,o=e}let h=Math.max(Math.abs(o),Math.abs(c))-.5*t;h=h/e+.5,Object(r["i"])(h,a,4*l)}return a}function u(e,t,i){i&&(t*=Math.SQRT2);const a=.5*t,n=new Uint8Array(4*e*e);for(let s=0;s<e;s++)for(let t=0;t<e;t++){let o=t-.5*e,c=.5*e-s-1;const l=s*e+t;if(i){const e=(o+c)/Math.SQRT2;c=(c-o)/Math.SQRT2,o=e}let h;o=Math.abs(o),c=Math.abs(c),h=o>c?o>a?Math.sqrt((o-a)*(o-a)+c*c):c:c>a?Math.sqrt(o*o+(c-a)*(c-a)):o,h=h/e+.5,Object(r["i"])(h,n,4*l)}return n}},a7d7:function(e,t,i){"use strict";i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return o}));var r=i("3886"),a=i("47f8"),n=i("7cb4");const s=Object(a["d"])(0,.6,.2);function o(e,t){const i=e.fragment,a=t.hasMetalnessAndRoughnessTexture||t.hasEmissionTexture||t.hasOcclusionTexture;1===t.pbrMode&&a&&e.include(n["a"],t),2!==t.pbrMode?(0===t.pbrMode&&i.code.add(r["a"]`
      float getBakedOcclusion() { return 1.0; }
  `),1===t.pbrMode&&(i.uniforms.add("emissionFactor","vec3"),i.uniforms.add("mrrFactors","vec3"),i.code.add(r["a"]`
      vec3 mrr;
      vec3 emission;
      float occlusion;
    `),t.hasMetalnessAndRoughnessTexture&&(i.uniforms.add("texMetallicRoughness","sampler2D"),t.supportsTextureAtlas&&i.uniforms.add("texMetallicRoughnessSize","vec2"),i.code.add(r["a"]`
      void applyMetallnessAndRoughness(TextureLookupParameter params) {
        vec3 metallicRoughness = textureLookup(texMetallicRoughness, params).rgb;

        mrr[0] *= metallicRoughness.b;
        mrr[1] *= metallicRoughness.g;
      }`)),t.hasEmissionTexture&&(i.uniforms.add("texEmission","sampler2D"),t.supportsTextureAtlas&&i.uniforms.add("texEmissionSize","vec2"),i.code.add(r["a"]`
      void applyEmission(TextureLookupParameter params) {
        emission *= textureLookup(texEmission, params).rgb;
      }`)),t.hasOcclusionTexture?(i.uniforms.add("texOcclusion","sampler2D"),t.supportsTextureAtlas&&i.uniforms.add("texOcclusionSize","vec2"),i.code.add(r["a"]`
      void applyOcclusion(TextureLookupParameter params) {
        occlusion *= textureLookup(texOcclusion, params).r;
      }

      float getBakedOcclusion() {
        return occlusion;
      }
      `)):i.code.add(r["a"]`
      float getBakedOcclusion() { return 1.0; }
      `),i.code.add(r["a"]`
    void applyPBRFactors() {
      mrr = mrrFactors;
      emission = emissionFactor;
      occlusion = 1.0;
      ${a?"vtc.uv = vuv0;":""}
      ${t.hasMetalnessAndRoughnessTexture?t.supportsTextureAtlas?"vtc.size = texMetallicRoughnessSize; applyMetallnessAndRoughness(vtc);":"applyMetallnessAndRoughness(vtc);":""}
      ${t.hasEmissionTexture?t.supportsTextureAtlas?"vtc.size = texEmissionSize; applyEmission(vtc);":"applyEmission(vtc);":""}
      ${t.hasOcclusionTexture?t.supportsTextureAtlas?"vtc.size = texOcclusionSize; applyOcclusion(vtc);":"applyOcclusion(vtc);":""}
    }
  `))):i.code.add(r["a"]`
      const vec3 mrr = vec3(0.0, 0.6, 0.2);
      const vec3 emission = vec3(0.0);
      float occlusion = 1.0;

      void applyPBRFactors() {}

      float getBakedOcclusion() { return 1.0; }
    `)}!function(e){function t(e,t,i=!1){i||(e.setUniform3fv("mrrFactors",t.mrrFactors),e.setUniform3fv("emissionFactor",t.emissiveFactor))}e.bindUniforms=t}(o||(o={}))},a803:function(e,t,i){"use strict";i.d(t,"a",(function(){return u})),i.d(t,"b",(function(){return h})),i.d(t,"c",(function(){return f})),i.d(t,"d",(function(){return m})),i.d(t,"e",(function(){return l})),i.d(t,"f",(function(){return d}));var r=i("6c97"),a=i("b2b2"),n=i("8c11"),s=i("9ac8"),o=i("ec13"),c=i("f33e");const l={primitivesPerFeature:0,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!0,memory:{bytesPerFeature:0,bytesPerCoordinate:0,bytesPerFeatureLabel:0,draped:{bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0}}};function h(e){return"web-style"===e.type?l:d(e.symbolLayers.toArray().map(t=>f(e,t)))}function d(e){let t=0,i=0,r=0,n=!1,s=0;const o={bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0,draped:{bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0}};for(const c of e)Object(a["j"])(c)||(t+=c.primitivesPerFeature,i+=c.primitivesPerCoordinate,r+=c.drawCallsPerFeature,o.bytesPerFeature+=c.memory.bytesPerFeature,o.bytesPerFeatureLabel+=c.memory.bytesPerFeatureLabel,o.bytesPerCoordinate+=c.memory.bytesPerCoordinate,o.draped.bytesPerFeature+=c.memory.bytesPerFeature,o.draped.bytesPerFeatureLabel+=c.memory.bytesPerFeatureLabel,o.draped.bytesPerCoordinate+=c.memory.bytesPerCoordinate,n=n||c.estimated,++s);return{primitivesPerFeature:t,primitivesPerCoordinate:i,drawCallsPerFeature:r,estimated:n,memory:o,numComplexities:s}}function u(e){const t=d(e);return t.numComplexities>0&&(t.primitivesPerFeature/=t.numComplexities,t.primitivesPerCoordinate/=t.numComplexities,t.drawCallsPerFeature/=t.numComplexities,t.memory.bytesPerFeature/=t.numComplexities,t.memory.bytesPerFeatureLabel/=t.numComplexities,t.memory.bytesPerCoordinate/=t.numComplexities,t.memory.draped.bytesPerFeature/=t.numComplexities,t.memory.draped.bytesPerFeatureLabel/=t.numComplexities,t.memory.draped.bytesPerCoordinate/=t.numComplexities),t}const p={};function f(e,t){const i=m(e,t),s=Object(o["d"])(t)?2:0;switch(t.type){case"extrude":return{primitivesPerFeature:-4,primitivesPerCoordinate:4,drawCallsPerFeature:s,estimated:!1,memory:i};case"fill":return"mesh-3d"===e.type?{primitivesPerFeature:0,primitivesPerCoordinate:0,drawCallsPerFeature:s,estimated:!1,memory:i}:Object(a["k"])(t.outline)&&t.outline.size>0?{primitivesPerFeature:-4,primitivesPerCoordinate:3,drawCallsPerFeature:0,estimated:!1,memory:i}:{primitivesPerFeature:-2,primitivesPerCoordinate:1,drawCallsPerFeature:0,estimated:!1,memory:i};case"water":return{primitivesPerFeature:-2,primitivesPerCoordinate:1,drawCallsPerFeature:0,estimated:!1,memory:i};case"line":return{primitivesPerFeature:-2,primitivesPerCoordinate:2,drawCallsPerFeature:0,estimated:!1,memory:i};case"object":return t.resource&&t.resource.href?{primitivesPerFeature:16,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!0,memory:i}:{...b(t.resource&&t.resource.primitive||n["b"]),memory:i};case"path":{const e=3,a=3,n=10;let s=0,o=0;switch(t.profile){case"circle":s=n;break;case"quad":s=4;break;default:return void Object(r["a"])(t.profile)}switch(t.join){case"round":o=e;break;case"miter":case"bevel":o=1;break;default:return void Object(r["a"])(t.join)}const c=2*s,l=s*o*2;let h=-2*l-c;switch(t.cap){case"none":break;case"butt":case"square":h+=2*(s-1);break;case"round":h+=2*(s*(a-1)*2+s);break;default:return void Object(r["a"])(t.cap)}return{primitivesPerFeature:h,primitivesPerCoordinate:l+c,drawCallsPerFeature:0,estimated:!1,memory:i}}case"text":case"icon":return{primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:i};default:return}}function m(e,t){const i="point-3d"===e.type;switch(t.type){case"extrude":return t.edges&&t.edges.size>0?g.EXTRUDE_EDGES:g.EXTRUDE;case"fill":return Object(a["k"])(t.outline)&&t.outline.size>0?g.FILL_OUTLINE:g.FILL;case"water":return g.FILL;case"line":return"round"===t.join?g.LINE_ROUND:g.LINE_MITER;case"path":switch(t.join){case"round":switch(t.profile){case"circle":return g.PATH_ROUND_CIRCLE;case"quad":return g.PATH_ROUND_QUAD;default:return void Object(r["a"])(t.profile)}case"miter":case"bevel":switch(t.profile){case"circle":return g.PATH_MITER_CIRCLE;case"quad":return g.PATH_MITER_QUAD;default:return void Object(r["a"])(t.profile)}default:return void Object(r["a"])(t.join)}case"object":return i?g.OBJECT_POINT:g.OBJECT_POLYGON;case"icon":case"text":return i?g.ICON_POINT:g.ICON_POLYGON;default:return}}function b(e){let t=p[e];if(t)return t;const i=Object(s["b"])(e,null);return t={primitivesPerFeature:Object(c["b"])(i.levels[0]).reduce((e,t)=>e+t.indices.get("position").length/3,0),primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1},p[e]=t,t}const g={ICON_POINT:{bytesPerFeature:7127.413186968842,bytesPerFeatureLabel:4826.302896296296,bytesPerCoordinate:0,draped:{bytesPerFeature:3929.4396628895197,bytesPerFeatureLabel:3550.1332222222227,bytesPerCoordinate:0}},ICON_POLYGON:{bytesPerFeature:9329.452613976147,bytesPerFeatureLabel:3675.3372604938268,bytesPerCoordinate:60.177252982212096,draped:{bytesPerFeature:6190.247450139383,bytesPerFeatureLabel:3744.074358024691,bytesPerCoordinate:59.488211068026104}},OBJECT_POINT:{bytesPerFeature:2350.5884192634558,bytesPerFeatureLabel:4446.651003703703,bytesPerCoordinate:0,draped:{bytesPerFeature:2350.5884192634558,bytesPerFeatureLabel:4446.651003703703,bytesPerCoordinate:0}},OBJECT_POLYGON:{bytesPerFeature:4583.807620302299,bytesPerFeatureLabel:3665.342685185186,bytesPerCoordinate:60.11621818101506,draped:{bytesPerFeature:4583.807620302299,bytesPerFeatureLabel:3665.342685185186,bytesPerCoordinate:60.11621818101506}},LINE_MITER:{bytesPerFeature:7321.028181375921,bytesPerFeatureLabel:4048.0226716049388,bytesPerCoordinate:186.55621386363578,draped:{bytesPerFeature:4246.856619435009,bytesPerFeatureLabel:3852.3737679012347,bytesPerCoordinate:163.47884002621583}},LINE_ROUND:{bytesPerFeature:7482.205842738954,bytesPerFeatureLabel:4045.886987654321,bytesPerCoordinate:191.5452524171851,draped:{bytesPerFeature:4473.481387957992,bytesPerFeatureLabel:3842.1112395061728,bytesPerCoordinate:167.27703460226945}},PATH_MITER_CIRCLE:{bytesPerFeature:9010.489006415351,bytesPerFeatureLabel:4230.9109,bytesPerCoordinate:4618.2594178027275,draped:{bytesPerFeature:9010.489006415351,bytesPerFeatureLabel:4230.9109,bytesPerCoordinate:4618.2594178027275}},PATH_ROUND_CIRCLE:{bytesPerFeature:4104.727250200398,bytesPerFeatureLabel:4251.8525,bytesPerCoordinate:8019.043777064957,draped:{bytesPerFeature:4104.727250200398,bytesPerFeatureLabel:4251.8525,bytesPerCoordinate:8019.043777064957}},PATH_MITER_QUAD:{bytesPerFeature:9416.372942261387,bytesPerFeatureLabel:4241.2757,bytesPerCoordinate:3176.7222742582203,draped:{bytesPerFeature:9416.372942261387,bytesPerFeatureLabel:4241.2757,bytesPerCoordinate:3176.7222742582203}},PATH_ROUND_QUAD:{bytesPerFeature:6614.431545308682,bytesPerFeatureLabel:4206.7461,bytesPerCoordinate:5141.817789093826,draped:{bytesPerFeature:6614.431545308682,bytesPerFeatureLabel:4206.7461,bytesPerCoordinate:5141.817789093826}},FILL:{bytesPerFeature:9478.244183633637,bytesPerFeatureLabel:3713.816824691358,bytesPerCoordinate:95.9343604185578,draped:{bytesPerFeature:6287.911108168086,bytesPerFeatureLabel:3790.785032098766,bytesPerCoordinate:83.08783220478168}},FILL_OUTLINE:{bytesPerFeature:13085.871870349445,bytesPerFeatureLabel:3392.613241975309,bytesPerCoordinate:118.63968023169875,draped:{bytesPerFeature:8437.199992480122,bytesPerFeatureLabel:3973.5431172839503,bytesPerCoordinate:106.33556817014312}},EXTRUDE:{bytesPerFeature:19459.53727140414,bytesPerFeatureLabel:3743.7045209876546,bytesPerCoordinate:372.6819978900477,draped:{bytesPerFeature:19459.53727140414,bytesPerFeatureLabel:3743.7045209876546,bytesPerCoordinate:372.6819978900477}},EXTRUDE_EDGES:{bytesPerFeature:22266.888534913724,bytesPerFeatureLabel:3064.3193358024696,bytesPerCoordinate:374.3725221561312,draped:{bytesPerFeature:22266.888534913724,bytesPerFeatureLabel:3064.3193358024696,bytesPerCoordinate:374.3725221561312}}}},a978:function(e,t,i){"use strict";i.d(t,"a",(function(){return O})),i.d(t,"b",(function(){return w})),i.d(t,"c",(function(){return j})),i.d(t,"d",(function(){return _})),i.d(t,"e",(function(){return z})),i.d(t,"f",(function(){return V})),i.d(t,"g",(function(){return I})),i.d(t,"h",(function(){return F})),i.d(t,"i",(function(){return y}));var r=i("b2b2"),a=i("0b2d"),n=i("e431"),s=i("d791"),o=i("dae5"),c=i("afe1"),l=i("b139"),h=i("0fc4"),d=i("1c92"),u=i("7577"),p=i("04f0"),f=i("47f8"),m=i("f895"),b=i("0d9f"),g=i("d0ac"),v=i("5a22");function y(e){return(t,i,r)=>(Object(n["j"])(U,t,i,r),!Object(b["c"])(e,U))}class O{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.store=2}}class _{constructor(){this._transform=Object(c["b"])(),this._transformInverse=new x({value:this._transform},s["a"],c["b"]),this._transformInverseTranspose=new x(this._transformInverse,s["b"],c["b"]),this._transformTranspose=new x({value:this._transform},s["b"],c["b"]),this._transformInverseRotation=new x({value:this._transform},d["b"],o["a"])}invalidateLazyTransforms(){this._transformInverse.invalidate(),this._transformInverseTranspose.invalidate(),this._transformTranspose.invalidate(),this._transformInverseRotation.invalidate()}get transform(){return this._transform}get inverse(){return this._transformInverse.value}get inverseTranspose(){return this._transformInverseTranspose.value}get inverseRotation(){return this._transformInverseRotation.value}get transpose(){return this._transformTranspose.value}setTransformMatrix(e){Object(s["c"])(this._transform,e)}multiplyTransform(e){Object(s["m"])(this._transform,this._transform,e)}set(e){Object(s["c"])(this._transform,e),this.invalidateLazyTransforms()}setAndInvalidateLazyTransforms(e,t){this.setTransformMatrix(e),this.multiplyTransform(t),this.invalidateLazyTransforms()}}class x{constructor(e,t,i){this.original=e,this.update=t,this.dirty=!0,this.transform=i()}invalidate(){this.dirty=!0}get value(){return this.dirty&&(this.update(this.transform,this.original.value),this.dirty=!1),this.transform}}class j{constructor(){this.min=new w,this.max=new w,this.hud=new w,this.ground=new w}init(e){this.min.init(e),this.max.init(e),this.hud.init(e),this.ground.init(e),this.all=[]}}class w{constructor(e){this.normal=Object(a["e"])(),this.transformation=Object(c["b"])(),this._ray=g["g"].create(),this.init(e)}get ray(){return this._ray}get hasIntersectionPoint(){return null!=this.dist}get distanceInRenderSpace(){if(null!=this.dist)return Object(n["f"])(G,this.ray.direction,this.dist),Object(n["q"])(G)}getIntersectionPoint(e){return!!this.hasIntersectionPoint&&(Object(n["f"])(G,this.ray.direction,this.dist),Object(n["g"])(e,this.ray.origin,G),!0)}getTransformedNormal(e){return Object(n["l"])(B,this.normal),B[3]=0,Object(u["m"])(B,B,this.transformation),Object(n["l"])(e,B),Object(n["s"])(e,e),e}init(e){this.dist=void 0,this.target=void 0,this.name=void 0,this.drapedLayerOrder=void 0,this.drapedLayerGraphicOrder=void 0,this.center=null,this.geometryId=null,this.triangleNr=null,this.intersector="Stage",e?g["g"].copy(e,this._ray):this._ray=g["g"].create()}set(e,t,i,r,o,c,l,h,d,u){e instanceof v["a"]&&(e={type:"stage",obj:e}),this.dist=i,Object(n["l"])(this.normal,r),Object(s["c"])(this.transformation,o),this.target=e,this.name=t,this.drapedLayerOrder=c,this.center=l?Object(a["d"])(l):null,this.geometryId=h,this.triangleNr=d,this.drapedLayerGraphicOrder=u}copyFrom(e){g["g"].copy(e._ray,this._ray),this.dist=e.dist,this.target=e.target,this.name=e.name,this.drapedLayerOrder=e.drapedLayerOrder,this.center=e.center?Object(a["d"])(e.center):null,this.geometryId=e.geometryId,this.triangleNr=e.triangleNr,this.intersector=e.intersector,this.drapedLayerGraphicOrder=e.drapedLayerGraphicOrder,Object(n["l"])(this.normal,e.normal),Object(s["c"])(this.transformation,e.transformation)}toOwner(e){if(!this.target)return null;switch(this.target.type){case"stage":return S(this.target.obj.metadata,e);case"external":switch(this.intersector){case"PointRenderer":return P(this.target,e);case"I3S":case"IM":case"LodRenderer":case"OverlayRenderer":return S(this.target.metadata,e);case"TerrainRenderer":return e.map&&e.map.ground}}return null}toGraphic(e){if(!this.target)return null;switch(this.target.type){case"stage":return C(this.target.obj.metadata,e);case"external":switch(this.intersector){case"PointRenderer":return A(this.target);case"I3S":case"IM":case"LodRenderer":case"OverlayRenderer":return C(this.target.metadata,e)}}return null}}function S(e,t){return Object(r["j"])(e)||null==e.layerUid?null:Object(r["k"])(t.graphicsView)&&e.layerUid===t.graphicsView.graphics3d.layer.id?t.graphics:t.map.findLayerByUid(e.layerUid)}function C(e,t){if(Object(r["j"])(e))return null;const i=S(e,t);if(Object(r["j"])(i))return null;if(i===t.graphics)return Object(r["k"])(t.graphicsView)?Object(r["t"])(t.graphicsView.getGraphicFromGraphicUid(e.graphicUid)):null;const a=t.allLayerViews.find(e=>e.layer===i);return a?T(a,e):null}function T(e,t){return!e||e.suspended?null:"getGraphicFromIntersectorMetadata"in e&&t?e.getGraphicFromIntersectorMetadata(t):"getGraphicFromGraphicUid"in e&&null!=t.graphicUid?e.getGraphicFromGraphicUid(t.graphicUid):null}function P(e,t){const i=e.metadata.layerUid;return null!=i?t.map.findLayerByUid(i):null}function A(e){return e.metadata.createGraphic()}class R{constructor(e=0){this.offset=e,this.tmpVertex=Object(a["e"])()}applyToVertex(e,t,i){const r=e+this.localOrigin[0],a=t+this.localOrigin[1],n=i+this.localOrigin[2],s=this.offset/Math.sqrt(r*r+a*a+n*n);return this.tmpVertex[0]=e+r*s,this.tmpVertex[1]=t+a*s,this.tmpVertex[2]=i+n*s,this.tmpVertex}applyToAabb(e){const t=e[0]+this.localOrigin[0],i=e[1]+this.localOrigin[1],r=e[2]+this.localOrigin[2],a=e[3]+this.localOrigin[0],n=e[4]+this.localOrigin[1],s=e[5]+this.localOrigin[2],o=this.offset/Math.sqrt(t*t+i*i+r*r);e[0]+=t*o,e[1]+=i*o,e[2]+=r*o;const c=this.offset/Math.sqrt(a*a+n*n+s*s);return e[3]+=a*c,e[4]+=n*c,e[5]+=s*c,e}}class M{constructor(e=0){this.offset=e,this.componentLocalOriginLength=0,this.tmpVertex=Object(a["e"])(),this.mbs=Object(h["c"])(),this.obb={center:Object(a["e"])(),halfSize:Object(f["c"])(),quaternion:null}}set localOrigin(e){this.componentLocalOriginLength=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2])}applyToVertex(e,t,i){const r=e,a=t,n=i+this.componentLocalOriginLength,s=this.offset/Math.sqrt(r*r+a*a+n*n);return this.tmpVertex[0]=e+r*s,this.tmpVertex[1]=t+a*s,this.tmpVertex[2]=i+n*s,this.tmpVertex}applyToAabb(e){const t=e[0],i=e[1],r=e[2]+this.componentLocalOriginLength,a=e[3],n=e[4],s=e[5]+this.componentLocalOriginLength,o=this.offset/Math.sqrt(t*t+i*i+r*r);e[0]+=t*o,e[1]+=i*o,e[2]+=r*o;const c=this.offset/Math.sqrt(a*a+n*n+s*s);return e[3]+=a*c,e[4]+=n*c,e[5]+=s*c,e}applyToMbs(e){const t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]),i=this.offset/t;return this.mbs[0]=e[0]+e[0]*i,this.mbs[1]=e[1]+e[1]*i,this.mbs[2]=e[2]+e[2]*i,this.mbs[3]=e[3]+e[3]*this.offset/t,this.mbs}applyToObb(e){const t=e.center,i=this.offset/Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);this.obb.center[0]=t[0]+t[0]*i,this.obb.center[1]=t[1]+t[1]*i,this.obb.center[2]=t[2]+t[2]*i,Object(n["v"])(this.obb.halfSize,e.halfSize,e.quaternion),Object(n["g"])(this.obb.halfSize,this.obb.halfSize,e.center);const r=this.offset/Math.sqrt(this.obb.halfSize[0]*this.obb.halfSize[0]+this.obb.halfSize[1]*this.obb.halfSize[1]+this.obb.halfSize[2]*this.obb.halfSize[2]);return this.obb.halfSize[0]+=this.obb.halfSize[0]*r,this.obb.halfSize[1]+=this.obb.halfSize[1]*r,this.obb.halfSize[2]+=this.obb.halfSize[2]*r,Object(n["k"])(this.obb.halfSize,this.obb.halfSize,e.center),Object(p["b"])(H,e.quaternion),Object(n["v"])(this.obb.halfSize,this.obb.halfSize,H),this.obb.halfSize[0]*=this.obb.halfSize[0]<0?-1:1,this.obb.halfSize[1]*=this.obb.halfSize[1]<0?-1:1,this.obb.halfSize[2]*=this.obb.halfSize[2]<0?-1:1,this.obb.quaternion=e.quaternion,this.obb}}class E{constructor(e=0){this.offset=e,this.sphere=Object(m["b"])(),this.tmpVertex=Object(a["e"])()}applyToVertex(e,t,i){const r=this.objectTransform.transform;let a=r[0]*e+r[4]*t+r[8]*i+r[12],n=r[1]*e+r[5]*t+r[9]*i+r[13],s=r[2]*e+r[6]*t+r[10]*i+r[14];const o=this.offset/Math.sqrt(a*a+n*n+s*s);a+=a*o,n+=n*o,s+=s*o;const c=this.objectTransform.inverse;return this.tmpVertex[0]=c[0]*a+c[4]*n+c[8]*s+c[12],this.tmpVertex[1]=c[1]*a+c[5]*n+c[9]*s+c[13],this.tmpVertex[2]=c[2]*a+c[6]*n+c[10]*s+c[14],this.tmpVertex}applyToMinMax(e,t){const i=this.offset/Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);e[0]+=e[0]*i,e[1]+=e[1]*i,e[2]+=e[2]*i;const r=this.offset/Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);t[0]+=t[0]*r,t[1]+=t[1]*r,t[2]+=t[2]*r}applyToAabb(e){const t=this.offset/Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);e[0]+=e[0]*t,e[1]+=e[1]*t,e[2]+=e[2]*t;const i=this.offset/Math.sqrt(e[3]*e[3]+e[4]*e[4]+e[5]*e[5]);return e[3]+=e[3]*i,e[4]+=e[4]*i,e[5]+=e[5]*i,e}applyToBoundingSphere(e){const t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]),i=this.offset/t;return this.sphere[0]=e[0]+e[0]*i,this.sphere[1]=e[1]+e[1]*i,this.sphere[2]=e[2]+e[2]*i,this.sphere[3]=e[3]+e[3]*this.offset/t,this.sphere}}const D=new E;function I(e){return Object(r["k"])(e)?(D.offset=e,D):null}const L=new M;function V(e){return Object(r["k"])(e)?(L.offset=e,L):null}const k=new R;function F(e){return Object(r["k"])(e)?(k.offset=e,k):null}const z="terrain",U=Object(a["e"])(),G=Object(a["e"])(),B=Object(h["c"])(),H=Object(l["a"])()},a997:function(e,t,i){"use strict";i.d(t,"a",(function(){return h})),i.d(t,"b",(function(){return l})),i.d(t,"c",(function(){return c}));var r=i("38a4"),a=i("3886"),n=i("690a"),s=i("2aad"),o=i("9e77");const c=Object(r["f"])(6);function l(e){const t=new n["a"];return t.extensions.add("GL_OES_standard_derivatives"),t.include(s["a"]),t.include(o["a"],e),t.fragment.uniforms.add("angleCutoff","vec2"),t.fragment.uniforms.add("globalAlpha","float"),e.heightManifoldEnabled&&t.fragment.uniforms.add("heightPlane","vec4"),e.pointDistanceEnabled&&t.fragment.uniforms.add("pointDistanceSphere","vec4"),e.lineVerticalPlaneEnabled&&t.fragment.uniforms.add("lineVerticalPlane","vec4").add("lineVerticalStart","vec3").add("lineVerticalEnd","vec3"),(e.heightManifoldEnabled||e.pointDistanceEnabled||e.lineVerticalPlaneEnabled)&&t.fragment.uniforms.add("maxPixelDistance","float"),e.intersectsLineEnabled&&t.fragment.uniforms.add("intersectsLineStart","vec3").add("intersectsLineEnd","vec3").add("intersectsLineDirection","vec3").add("intersectsLineRadius","float").add("perScreenPixelRatio","float"),(e.lineVerticalPlaneEnabled||e.heightManifoldEnabled)&&t.fragment.code.add(a["a"]`
      float planeDistancePixels(vec4 plane, vec3 pos) {
        float dist = dot(plane.xyz, pos) + plane.w;
        float width = fwidth(dist);
        dist /= min(width, maxPixelDistance);
        return abs(dist);
      }`),e.pointDistanceEnabled&&t.fragment.code.add(a["a"]`
    float sphereDistancePixels(vec4 sphere, vec3 pos) {
      float dist = distance(sphere.xyz, pos) - sphere.w;
      float width = fwidth(dist);
      dist /= min(width, maxPixelDistance);
      return abs(dist);
    }
    `),e.intersectsLineEnabled&&t.fragment.code.add(a["a"]`
    float lineDistancePixels(vec3 start, vec3 dir, float radius, vec3 pos) {
      float dist = length(cross(dir, pos - start)) / (length(pos) * perScreenPixelRatio);
      return abs(dist) - radius;
    }
    `),(e.lineVerticalPlaneEnabled||e.intersectsLineEnabled)&&t.fragment.code.add(a["a"]`
    bool pointIsWithinLine(vec3 pos, vec3 start, vec3 end) {
      vec3 dir = end - start;
      float t2 = dot(dir, pos - start);
      float l2 = dot(dir, dir);
      return t2 >= 0.0 && t2 <= l2;
    }
    `),t.fragment.code.add(a["a"]`
  void main() {
    vec3 pos;
    vec3 normal;
    float depthDiscontinuityAlpha;

    if (!laserlineReconstructFromDepth(pos, normal, depthDiscontinuityAlpha)) {
      discard;
    }

    vec4 color = vec4(0, 0, 0, 0);
  `),e.heightManifoldEnabled&&t.fragment.code.add(a["a"]`
    {
      float heightManifoldAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, abs(dot(normal, heightPlane.xyz)));
      vec4 heightManifoldColor = laserlineProfile(planeDistancePixels(heightPlane, pos));
      color = max(color, heightManifoldColor * heightManifoldAlpha);
    }
    `),e.pointDistanceEnabled&&t.fragment.code.add(a["a"]`
    {
      // distance to sphere
      float pointDistanceSphereDistance = sphereDistancePixels(pointDistanceSphere, pos);
      vec4 pointDistanceSphereColor = laserlineProfile(pointDistanceSphereDistance);
      float pointDistanceSphereAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, abs(dot(normal, normalize(pos - pointDistanceSphere.xyz))));

      color = max(color, pointDistanceSphereColor * pointDistanceSphereAlpha);
    }
    `),e.lineVerticalPlaneEnabled&&t.fragment.code.add(a["a"]`
    {
      if (pointIsWithinLine(pos, lineVerticalStart, lineVerticalEnd)) {
        float lineVerticalDistance = planeDistancePixels(lineVerticalPlane, pos);

        vec4 lineVerticalColor = laserlineProfile(lineVerticalDistance);
        float lineVerticalAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, abs(dot(normal, lineVerticalPlane.xyz)));

        color = max(color, lineVerticalColor * lineVerticalAlpha);
      }
    }
    `),e.intersectsLineEnabled&&t.fragment.code.add(a["a"]`
    {
      if (pointIsWithinLine(pos, intersectsLineStart, intersectsLineEnd)) {
        float intersectsLineDistance = lineDistancePixels(intersectsLineStart, intersectsLineDirection, intersectsLineRadius, pos);
        vec4 intersectsLineColor = laserlineProfile(intersectsLineDistance);
        float intersectsLineAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, 1.0 - abs(dot(normal, intersectsLineDirection)));

        color = max(color, intersectsLineColor * intersectsLineAlpha);
      }
    }
    `),t.fragment.code.add(a["a"]`
    gl_FragColor = laserlineOutput(color * depthDiscontinuityAlpha);
  }
  `),t}var h=Object.freeze({__proto__:null,defaultAngleCutoff:c,build:l})},aab5:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i("3886");function a(e,t){const i=e.fragment;i.code.add(r["a"]`
    struct ShadingNormalParameters {
      vec3 normalView;
      vec3 viewDirection;
    } shadingParams;
    `),1===t.doubleSidedMode?i.code.add(r["a"]`
      vec3 shadingNormal(ShadingNormalParameters params) {
        return dot(params.normalView, params.viewDirection) > 0.0 ? normalize(-params.normalView) : normalize(params.normalView);
      }
    `):2===t.doubleSidedMode?i.code.add(r["a"]`
      vec3 shadingNormal(ShadingNormalParameters params) {
        return gl_FrontFacing ? normalize(params.normalView) : normalize(-params.normalView);
      }
    `):i.code.add(r["a"]`
      vec3 shadingNormal(ShadingNormalParameters params) {
        return normalize(params.normalView);
      }
    `)}},ab68:function(e,t,i){"use strict";i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return a}));var r=i("dff3");const a={type:r["a"],json:{origins:{service:{read:{source:["tileInfo","minScale","maxScale","minLOD","maxLOD"],reader:n}}}}};function n(e,t,i,a){if(!e)return null;const{minScale:n,maxScale:s,minLOD:o,maxLOD:c}=t;if(null!=o&&null!=c)return a&&a.ignoreMinMaxLOD?r["a"].fromJSON(e):r["a"].fromJSON({...e,lods:e.lods.filter(({level:e})=>null!=e&&e>=o&&e<=c)});if(0!==n&&0!==s){const t=e=>Math.round(1e4*e)/1e4,i=n?t(n):1/0,a=s?t(s):-1/0;return r["a"].fromJSON({...e,lods:e.lods.filter(e=>{const r=t(e.scale);return r<=i&&r>=a})})}return r["a"].fromJSON(e)}},adf1:function(e,t,i){"use strict";var r=i("b2b2"),a=i("5996"),n=i("0b2d"),s=i("e431"),o=i("8188"),c=i("afe1"),l=i("0278"),h=i("5a22"),d=i("7abc"),u=i("748f"),p=i("86ba");let f=0;const m="rg_";class b{constructor(){this.ROOT_ORIGIN_ID=m+"root_"+f++,this._origins=new Map,this._gridSize=42e5}getOrigin(e){const t=this._origins.get(this.ROOT_ORIGIN_ID);if(null==t){if(Object(r["k"])(b.testOrigin)){const t=b.testOrigin;return this._origins.set(this.ROOT_ORIGIN_ID,Object(d["a"])(t[0],t[1],t[2],this.ROOT_ORIGIN_ID)),this.getOrigin(e)}const t=Object(d["a"])(e[0]+Math.random()-.5,e[1]+Math.random()-.5,e[2]+Math.random()-.5,this.ROOT_ORIGIN_ID);return this._origins.set(this.ROOT_ORIGIN_ID,t),t}Object(s["k"])(g,e,t.vec3),g[0]=Math.abs(g[0]),g[1]=Math.abs(g[1]),g[2]=Math.abs(g[2]);const i=this._gridSize;if(g[0]<i&&g[1]<i&&g[2]<i)return t;const a=Math.round(e[0]/i),n=Math.round(e[1]/i),o=Math.round(e[2]/i),c=`${m}${a}/${n}/${o}`;let l=this._origins.get(c);return l||(l=Object(d["a"])(a*i,n*i,o*i,c),this._origins.set(c,l)),l}_drawOriginBox(e){const t=window.view,i=t._stage;if(null==this._object){this._material=new p["a"]({width:2,color:[0,1,0,1]}),i.add(this._material);const e=new u["a"]({isPickable:!1});this._object=new h["a"]({castShadow:!1}),i.add(this._object),e.add(this._object),i.add(e)}const r=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],n=r.length,s=new Array(3*n),d=new Uint16Array(2*(n-1)),f=.5*this._gridSize;for(let a=0;a<n;a++)s[3*a+0]=e[0]+(1&r[a]?f:-f),s[3*a+1]=e[1]+(2&r[a]?f:-f),s[3*a+2]=e[2]+(4&r[a]?f:-f),a>0&&(d[2*a+0]=a-1,d[2*a+1]=a);Object(o["q"])(s,a["a"].WebMercator,0,s,t.spatialReference,0,n);const m=new l["a"]([["position",{size:3,data:s,exclusive:!0}]],[["position",d]],2);i.add(m),this._object.addGeometry(m,this._material,c["a"]),console.log(this._origins.size,e)}}const g=Object(n["e"])();!function(e){e.testOrigin=null}(b||(b={}));var v=b;t["a"]=v},ae0b:function(e,t,i){"use strict";class r{constructor(e){this._array=[],e<=0&&console.error("strideInBytes must be positive!"),this._stride=e}get array(){return this._array}get index(){return 4*this._array.length/this._stride}get itemSize(){return this._stride}get sizeInBytes(){return 4*this._array.length}reset(){this.array.length=0}toBuffer(){return new Uint32Array(this._array).buffer}static i1616to32(e,t){return 65535&e|t<<16}static i8888to32(e,t,i,r){return 255&e|(255&t)<<8|(255&i)<<16|r<<24}static i8816to32(e,t,i){return 255&e|(255&t)<<8|i<<16}}t["a"]=r},aeb3:function(e,t,i){"use strict";i.d(t,"a",(function(){return y})),i.d(t,"b",(function(){return g}));var r=i("3886"),a=i("4db9"),n=i("690a"),s=i("4377"),o=i("d272"),c=i("d047"),l=i("6a07"),h=i("ebd5"),d=i("c6d7"),u=i("c2d1"),p=i("6d5b");const f=.70710678118,m=f,b=.08715574274;function g(e){const t=new n["a"];e.draped||t.extensions.add("GL_OES_standard_derivatives");const i=1===e.output;t.include(a["a"],{linearDepth:i}),t.include(p["a"],e),t.vertex.uniforms.add("proj","mat4"),t.vertex.uniforms.add("view","mat4"),i&&(t.include(u["a"],e),t.vertex.uniforms.add("cameraNearFar","vec2"),t.varyings.add("linearDepth","float")),e.draped?t.vertex.uniforms.add("worldToScreenRatio","float"):(t.vertex.uniforms.add("worldToScreenPerDistanceRatio","float"),t.vertex.uniforms.add("camPos","vec3"),t.attributes.add("boundingRect","mat3")),t.attributes.add("position","vec3"),t.attributes.add("uvMapSpace","vec4"),t.varyings.add("vpos","vec3"),t.varyings.add("vuv","vec2"),e.multipassTerrainEnabled&&t.varyings.add("depth","float");const g=3===e.style||4===e.style||5===e.style;return g&&t.vertex.code.add(r["a"]`
      const mat2 rotate45 = mat2(${r["a"].float(f)}, ${r["a"].float(-m)},
                                 ${r["a"].float(m)}, ${r["a"].float(f)});
    `),e.draped||(t.vertex.code.add(r["a"]`
      vec3 projectPointToLineSegment(vec3 center, vec3 halfVector, vec3 point) {
        float projectedLength = dot(halfVector, point - center) / dot(halfVector, halfVector);
        return center + halfVector * clamp(projectedLength, -1.0, 1.0);
      }
    `),t.vertex.code.add(r["a"]`
      vec3 intersectRayPlane(vec3 rayDir, vec3 rayOrigin, vec3 planeNormal, vec3 planePoint) {
        float d = dot(planeNormal, planePoint);
        float t = (d - dot(planeNormal, rayOrigin)) / dot(planeNormal, rayDir);

        return rayOrigin + t * rayDir;
      }
    `),t.vertex.code.add(r["a"]`
      float boundingRectDistanceToCamera() {
        vec3 center = vec3(boundingRect[0][0], boundingRect[0][1], boundingRect[0][2]);
        vec3 halfU = vec3(boundingRect[1][0], boundingRect[1][1], boundingRect[1][2]);
        vec3 halfV = vec3(boundingRect[2][0], boundingRect[2][1], boundingRect[2][2]);
        vec3 n = normalize(cross(halfU, halfV));

        vec3 viewDir = - vec3(view[0][2], view[1][2], view[2][2]);

        float viewAngle = dot(viewDir, n);
        float minViewAngle = ${r["a"].float(b)};

        if (abs(viewAngle) < minViewAngle) {
          // view direction is (almost) parallel to plane -> clamp it to min angle
          float normalComponent = sign(viewAngle) * minViewAngle - viewAngle;
          viewDir = normalize(viewDir + normalComponent * n);
        }

        // intersect view direction with infinite plane that contains bounding rect
        vec3 planeProjected = intersectRayPlane(viewDir, camPos, n, center);

        // clip to bounds by projecting to u and v line segments individually
        vec3 uProjected = projectPointToLineSegment(center, halfU, planeProjected);
        vec3 vProjected = projectPointToLineSegment(center, halfV, planeProjected);

        // use to calculate the closest point to camera on bounding rect
        vec3 closestPoint = uProjected + vProjected - center;

        return length(closestPoint - camPos);
      }
    `)),t.vertex.code.add(r["a"]`
    vec2 scaledUV() {
      vec2 uv = uvMapSpace.xy ${g?" * rotate45":""};
      vec2 uvCellOrigin = uvMapSpace.zw ${g?" * rotate45":""};

      ${e.draped?r["a"]`
            float ratio = worldToScreenRatio;
          `:r["a"]`
            float distanceToCamera = boundingRectDistanceToCamera();
            float ratio = worldToScreenPerDistanceRatio / distanceToCamera;

            // Logarithmically discretize ratio to avoid jittering
            float step = 0.1;
            ratio = log(ratio);
            ratio = ceil(ratio / step) * step;
            ratio = exp(ratio);
          `}

      vec2 uvOffset = mod(uvCellOrigin * ratio, ${r["a"].float(e.patternSpacing)});
      return uvOffset + (uv * ratio);
    }
  `),t.vertex.code.add(r["a"]`
    void main(void) {
      vuv = scaledUV();
      vpos = position;
      ${e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
      forwardNormalizedVertexColor();
      gl_Position = ${i?r["a"]`transformPositionWithDepth(proj, view, vpos, cameraNearFar, linearDepth);`:r["a"]`transformPosition(proj, view, vpos);`}
    }
  `),t.include(o["a"],e),t.fragment.include(s["a"]),t.fragment.uniforms.add("matColor","vec4"),e.draped&&t.fragment.uniforms.add("texelSize","float"),4===e.output&&t.include(l["a"]),e.multipassTerrainEnabled&&(t.fragment.include(c["a"]),t.include(d["b"],e)),4!==e.output&&(t.fragment.code.add(r["a"]`
      const float lineWidth = ${r["a"].float(e.lineWidth)};
      const float spacing = ${r["a"].float(e.patternSpacing)};
      const float spacingINV = ${r["a"].float(1/e.patternSpacing)};

      float coverage(float p, float txlSize) {
        p = mod(p, spacing);

        float halfTxlSize = txlSize / 2.0;

        float start = p - halfTxlSize;
        float end = p + halfTxlSize;

        float coverage = (ceil(end * spacingINV) - floor(start * spacingINV)) * lineWidth;
        coverage -= min(lineWidth, mod(start, spacing));
        coverage -= max(lineWidth - mod(end, spacing), 0.0);

        return coverage / txlSize;
      }
    `),e.draped||t.fragment.code.add(r["a"]`
        const int maxSamples = 5;

        float sample(float p) {
          vec2 dxdy = abs(vec2(dFdx(p), dFdy(p)));
          float fwidth = dxdy.x + dxdy.y;

          ivec2 samples = 1 + ivec2(clamp(dxdy, 0.0, float(maxSamples - 1)));
          vec2 invSamples = 1.0 / vec2(samples);

          float accumulator = 0.0;

          for (int j = 0; j < maxSamples; j++) {
            if(j >= samples.y) {
              break;
            }

            for (int i = 0; i < maxSamples; i++) {
              if(i >= samples.x) {
                break;
              }

              vec2 step = vec2(i,j) * invSamples - 0.5;
              accumulator += coverage(p + step.x * dxdy.x + step.y * dxdy.y, fwidth);
            }
          }

          accumulator /= float(samples.x * samples.y);
          return accumulator;
        }
      `)),t.fragment.code.add(r["a"]`
    void main() {
      discardBySlice(vpos);
      ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
      vec4 color = ${e.attributeColor?"vColor * matColor;":"matColor;"}
      color = highlightSlice(color, vpos);

      ${4!==e.output?r["a"]`color.a *= ${v(e)};`:""}

      if (color.a < ${r["a"].float(h["c"])}) {
        discard;
      }

      ${7===e.output?r["a"]`gl_FragColor = vec4(color.a);`:""}

      ${0===e.output?r["a"]`gl_FragColor = color; ${e.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
      ${4===e.output?r["a"]`outputHighlight();`:""}
      ${1===e.output?r["a"]`outputDepth(linearDepth);`:""};
    }
  `),t}function v(e){function t(t){return e.draped?r["a"]`coverage(vuv.${t}, texelSize)`:r["a"]`sample(vuv.${t})`}switch(e.style){case 3:case 0:return t("y");case 4:case 1:return t("x");case 5:case 2:return r["a"]`
        1.0 - (1.0 - ${t("x")}) * (1.0 - ${t("y")})
      `;default:return"0.0"}}var y=Object.freeze({__proto__:null,build:g})},af20:function(e,t,i){"use strict";i.d(t,"a",(function(){return O})),i.d(t,"b",(function(){return y}));var r=i("3886"),a=i("4db9"),n=i("690a"),s=i("4377"),o=i("d272"),c=i("d047"),l=i("6a07"),h=i("c6d7"),d=i("c2d1"),u=i("d017"),p=i("bd75"),f=i("040b"),m=i("7088"),b=i("ea4b"),g=i("aab5"),v=i("b49d");function y(e){const t=new n["a"];return t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("camPos","vec3").add("localOrigin","vec3"),t.varyings.add("vpos","vec3"),t.include(v["a"],e),0!==e.output&&7!==e.output||(t.include(a["a"],{linearDepth:!1}),e.receiveShadows&&t.include(u["a"],e),t.include(p["a"],e),t.varyings.add("vnormal","vec3"),t.varyings.add("vcolor","vec4"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),t.vertex.code.add(r["a"]`
      void main() {
        vpos = calculateVPos();
        vnormal = normalize(localNormal());

        ${e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
        gl_Position = transformPosition(proj, view, vpos);

        ${0===e.output?"forwardLinearDepth();":""}

        vcolor = getColor();
      }
    `)),e.multipassTerrainEnabled&&(t.fragment.include(c["a"]),t.include(h["b"],e)),7===e.output&&(t.include(o["a"],e),t.fragment.uniforms.add("camPos","vec3"),t.fragment.uniforms.add("localOrigin","vec3"),t.fragment.uniforms.add("opacity","float"),t.fragment.code.add(r["a"]`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
        float combinedOpacity = vcolor.a * opacity;
        gl_FragColor = vec4(combinedOpacity);
      }
    `)),0===e.output&&(t.include(o["a"],e),t.include(b["a"],e),t.include(m["a"],e),e.receiveShadows&&t.include(u["a"],e),t.include(g["a"],e),t.fragment.uniforms.add("camPos","vec3").add("localOrigin","vec3").add("ambient","vec3").add("diffuse","vec3").add("specular","vec3").add("opacity","float"),t.fragment.include(s["a"]),t.fragment.code.add(r["a"]`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}

        shadingParams.viewDirection = normalize(vpos - camPos);
        shadingParams.normalView = vnormal;
        vec3 normal = shadingNormal(shadingParams);
        float ssao = evaluateAmbientOcclusionInverse();

        float additionalAmbientScale = _oldHeuristicLighting(vpos + localOrigin);
        vec3 additionalLight = ssao * lightingMainIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;
    `),e.receiveShadows?t.fragment.code.add(r["a"]`
        float shadow = readShadowMap(vpos, linearDepth);
      `):1===e.viewingMode?t.fragment.code.add(r["a"]`
        float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);
      `):t.fragment.code.add(r["a"]`
        float shadow = 0.0;
      `),t.fragment.code.add(r["a"]`
        vec3 albedo = vcolor.rgb * max(ambient, diffuse); // combine the old material parameters into a single one
        float combinedOpacity = vcolor.a * opacity;
        albedo += 0.25 * specular; // don't completely ignore specular for now

        vec3 shadedColor = evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight);
        gl_FragColor = vec4(shadedColor, combinedOpacity);
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
        ${e.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),1!==e.output&&3!==e.output||(t.include(a["a"],{linearDepth:!0}),t.vertex.uniforms.add("nearFar","vec2"),t.varyings.add("depth","float"),t.vertex.code.add(r["a"]`
        void main() {
          vpos = calculateVPos();
          gl_Position = transformPositionWithDepth(proj, view, vpos, nearFar, depth);
        }
    `),t.include(o["a"],e),t.include(d["a"],e),t.fragment.uniforms.add("timeElapsed","float"),t.fragment.code.add(r["a"]`
        void main() {
          discardBySlice(vpos);
          outputDepth(depth);
        }
    `)),2===e.output&&(t.include(a["a"],{linearDepth:!1}),t.include(f["a"],e),t.vertex.uniforms.add("viewNormal","mat4"),t.varyings.add("vnormal","vec3"),t.vertex.code.add(r["a"]`
        void main(void) {
          vpos = calculateVPos();
          vnormal = normalize((viewNormal * vec4(localNormal(), 1.0)).xyz);
          gl_Position = transformPosition(proj, view, vpos);
        }
    `),t.include(o["a"],e),t.fragment.uniforms.add("waterColor","vec4"),t.fragment.code.add(r["a"]`
        void main() {
          discardBySlice(vpos);
          vec3 normal = normalize(vnormal);
          if (gl_FrontFacing == false) normal = -normal;
          gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);
        }
    `)),4===e.output&&(t.include(a["a"],{linearDepth:!1}),t.include(f["a"],e),t.vertex.uniforms.add("viewNormal","mat4"),t.varyings.add("vnormal","vec3"),t.vertex.code.add(r["a"]`
        void main(void) {
          vpos = calculateVPos();
          gl_Position = transformPosition(proj, view, vpos);
        }
    `),t.include(o["a"],e),t.include(l["a"]),t.fragment.code.add(r["a"]`
      void main() {
        discardBySlice(vpos);
        outputHighlight();
      }
    `)),t}var O=Object.freeze({__proto__:null,build:y})},af3d:function(e,t,i){"use strict";i.d(t,"a",(function(){return l})),i.d(t,"b",(function(){return n}));i("c120");var r=i("0b2d"),a=i("4261");function n(e,{isPrimitive:t,width:i,depth:a,height:n}){const s=t?10:1;if(null==i&&null==n&&null==a)return[s*e[0],s*e[1],s*e[2]];const o=Object(r["g"])(i,a,n);let c;for(let r=0;r<3;r++){const t=o[r];if(null!=t){c=t/e[r];break}}for(let r=0;r<3;r++)null==o[r]&&(o[r]=e[r]*c);return o}const s=Object(a["t"])(-.5,-.5,-.5,.5,.5,.5),o=Object(a["t"])(-.5,-.5,0,.5,.5,1),c=Object(a["t"])(-.5,-.5,0,.5,.5,.5);function l(e){switch(e){case"sphere":case"cube":case"diamond":return s;case"cylinder":case"cone":case"inverted-cone":return o;case"tetrahedron":return c;default:return}}},affb:function(e,t,i){"use strict";i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return n}));var r=i("3886"),a=i("690a");function n(){const e=new a["a"];return e.attributes.add("position","vec2"),e.attributes.add("uv0","vec2"),e.vertex.uniforms.add("scale","float"),e.vertex.uniforms.add("offset","vec2"),e.varyings.add("uv","vec2"),e.vertex.code.add(r["a"]`
    void main(void) {
      gl_Position = vec4(position, 0.0, 1.0);
      uv = uv0 * scale + offset;
    }
  `),e.fragment.uniforms.add("tex","sampler2D"),e.fragment.uniforms.add("opacity","float"),e.fragment.code.add(r["a"]`
    void main() {
      vec4 color = texture2D(tex, uv);

      // Note: output in pre-multiplied alpha for correct alpha compositing
      gl_FragColor = vec4(color.xyz, 1.0) * color.a * opacity;
    }
  `),e}var s=Object.freeze({__proto__:null,build:n})},b09a:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i("3886");function a(e){e.attributes.add("position","vec3"),e.vertex.code.add(r["a"]`
    vec3 positionModel() { return position; }
  `)}},b0ab:function(e,t,i){"use strict";i.d(t,"a",(function(){return P})),i.d(t,"b",(function(){return T}));var r=i("3886"),a=i("4db9"),n=i("690a"),s=i("d272"),o=i("d047"),c=i("be24"),l=i("ebd5"),h=i("17b0"),d=i("c6d7"),u=i("d017"),p=i("bd75"),f=i("5d5f"),m=i("d539"),b=i("dfaf"),g=i("a7d7"),v=i("17ca"),y=i("c332"),O=i("b09a"),_=i("6cb2"),x=i("6d5b"),j=i("7e21"),w=i("7088"),S=i("ea4b"),C=i("3626");function T(e){const t=new n["a"],i=t.vertex.code,T=t.fragment.code;return t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("camPos","vec3").add("localOrigin","vec3"),t.include(O["a"]),t.varyings.add("vpos","vec3"),t.include(c["a"],e),t.include(m["a"],e),t.include(h["a"],e),0!==e.output&&7!==e.output||(t.include(y["a"],e),t.include(a["a"],{linearDepth:!1}),e.offsetBackfaces&&t.include(v["a"]),e.instancedColor&&t.attributes.add("instanceColor","vec4"),t.varyings.add("vNormalWorld","vec3"),t.varyings.add("localvpos","vec3"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),t.include(b["a"],e),t.include(p["a"],e),t.include(_["a"],e),t.include(x["a"],e),t.vertex.uniforms.add("externalColor","vec4"),t.varyings.add("vcolorExt","vec4"),i.add(r["a"]`
        void main(void) {
          forwardNormalizedVertexColor();
          vcolorExt = externalColor;
          ${e.instancedColor?"vcolorExt *= instanceColor;":""}
          vcolorExt *= vvColor();
          vcolorExt *= getSymbolColor();
          forwardColorMixMode();

          if (vcolorExt.a < ${r["a"].float(l["c"])}) {
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          }
          else {
            vpos = calculateVPos();
            localvpos = vpos - view[3].xyz;
            vpos = subtractOrigin(vpos);
            vNormalWorld = dpNormal(vvLocalNormal(normalModel()));
            vpos = addVerticalOffset(vpos, localOrigin);
            gl_Position = transformPosition(proj, view, vpos);
            ${e.offsetBackfaces?"gl_Position = offsetBackfacingClipPosition(gl_Position, vpos, vNormalWorld, camPos);":""}
          }
          ${e.multipassTerrainEnabled?r["a"]`depth = (view * vec4(vpos, 1.0)).z;`:""}
          forwardLinearDepth();
          forwardTextureCoordinates();
        }
      `)),7===e.output&&(t.include(s["a"],e),t.include(l["a"],e),e.multipassTerrainEnabled&&(t.fragment.include(o["a"]),t.include(d["b"],e)),t.fragment.uniforms.add("camPos","vec3").add("localOrigin","vec3").add("opacity","float").add("layerOpacity","float"),t.fragment.uniforms.add("view","mat4"),e.hasColorTexture&&t.fragment.uniforms.add("tex","sampler2D"),t.fragment.include(C["a"]),T.add(r["a"]`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?r["a"]`terrainDepthTest(gl_FragCoord, depth);`:""}
        ${e.hasColorTexture?r["a"]`
        vec4 texColor = texture2D(tex, vuv0);
        ${e.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
        discardOrAdjustAlpha(texColor);`:r["a"]`vec4 texColor = vec4(1.0);`}
        ${e.attributeColor?r["a"]`
        float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:r["a"]`
        float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));
        `}

        gl_FragColor = vec4(opacity_);
      }
    `)),0===e.output&&(t.include(s["a"],e),t.include(S["a"],e),t.include(w["a"],e),t.include(l["a"],e),e.receiveShadows&&t.include(u["a"],e),e.multipassTerrainEnabled&&(t.fragment.include(o["a"]),t.include(d["b"],e)),t.fragment.uniforms.add("camPos","vec3").add("localOrigin","vec3").add("ambient","vec3").add("diffuse","vec3").add("opacity","float").add("layerOpacity","float"),t.fragment.uniforms.add("view","mat4"),e.hasColorTexture&&t.fragment.uniforms.add("tex","sampler2D"),t.include(g["b"],e),t.include(f["a"],e),t.fragment.include(C["a"]),T.add(r["a"]`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?r["a"]`terrainDepthTest(gl_FragCoord, depth);`:""}
        ${e.hasColorTexture?r["a"]`
        vec4 texColor = texture2D(tex, vuv0);
        ${e.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
        discardOrAdjustAlpha(texColor);`:r["a"]`vec4 texColor = vec4(1.0);`}
        vec3 viewDirection = normalize(vpos - camPos);
        ${1===e.pbrMode?"applyPBRFactors();":""}
        float ssao = evaluateAmbientOcclusionInverse();
        ssao *= getBakedOcclusion();

        float additionalAmbientScale = _oldHeuristicLighting(vpos + localOrigin);
        vec3 additionalLight = ssao * lightingMainIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;
        ${e.receiveShadows?"float shadow = readShadowMap(vpos, linearDepth);":1===e.viewingMode?"float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);":"float shadow = 0.0;"}
        vec3 matColor = max(ambient, diffuse);
        ${e.attributeColor?r["a"]`
        vec3 albedo_ = mixExternalColor(vColor.rgb * matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
        float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:r["a"]`
        vec3 albedo_ = mixExternalColor(matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
        float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));
        `}
        ${r["a"]`
        vec3 shadedNormal = normalize(vNormalWorld);
        albedo_ *= 1.2;
        vec3 viewForward = - vec3(view[0][2], view[1][2], view[2][2]);
        float alignmentLightView = clamp(dot(-viewForward, lightingMainDirection), 0.0, 1.0);
        float transmittance = 1.0 - clamp(dot(-viewForward, shadedNormal), 0.0, 1.0);
        float treeRadialFalloff = vColor.r;
        float backLightFactor = 0.5 * treeRadialFalloff * alignmentLightView * transmittance * (1.0 - shadow);
        additionalLight += backLightFactor * lightingMainIntensity;`}
        ${1===e.pbrMode||2===e.pbrMode?1===e.viewingMode?r["a"]`vec3 normalGround = normalize(vpos + localOrigin);`:r["a"]`vec3 normalGround = vec3(0.0, 0.0, 1.0);`:r["a"]``}
        ${1===e.pbrMode||2===e.pbrMode?r["a"]`
            float additionalAmbientIrradiance = additionalAmbientIrradianceFactor * lightingMainIntensity[2];
            vec3 shadedColor = evaluateSceneLightingPBR(shadedNormal, albedo_, shadow, 1.0 - ssao, additionalLight, viewDirection, normalGround, mrr, emission, additionalAmbientIrradiance);`:"vec3 shadedColor = evaluateSceneLighting(shadedNormal, albedo_, shadow, 1.0 - ssao, additionalLight);"}
        gl_FragColor = highlightSlice(vec4(shadedColor, opacity_), vpos);
        ${e.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),t.include(j["a"],e),t}var P=Object.freeze({__proto__:null,build:T})},b33e:function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));class r{constructor(e,t,i){this._initialVelocity=e,this._stopVelocity=t,this._friction=i,this._duration=Math.abs(Math.log(Math.abs(this._initialVelocity)/this._stopVelocity)/Math.log(1-this._friction))}get duration(){return this._duration}isFinished(e){return e>this.duration}get friction(){return this._friction}value(e){return this.valueFromInitialVelocity(this._initialVelocity,e)}valueDelta(e,t){const i=this.value(e);return this.value(e+t)-i}valueFromInitialVelocity(e,t){t=Math.min(t,this.duration);const i=1-this.friction;return e*(i**t-1)/Math.log(i)}}},b3a9:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i("3886"),a=i("ee2c");function n(e,t){const i=e.vertex;switch(e.include(a["a"],t),e.attributes.add("sideness","vec2"),2===t.mode?i.code.add(r["a"]`
      struct UnpackedAttributes {
        vec2 sideness;
        vec2 sidenessNorm;
        float lineWidthPixels;
        float extensionLengthPixels;
        float type;
      };
    `):i.code.add(r["a"]`
      struct UnpackedAttributes {
        vec2 sideness;
        vec2 sidenessNorm;
        float lineWidthPixels;
        float extensionLengthPixels;
      };
  `),t.mode){case 2:i.code.add(r["a"]`
        UnpackedAttributes unpackAttributes(ComponentData component) {
          vec2 sidenessNorm = sideness;
          vec2 sideness = sidenessNorm * 2.0 - 1.0;
          float fType = component.type;
          float extensionLengthPixels = component.extensionLength;
          float lineWidth = component.lineWidth;

          if (fType <= 0.0) {
            extensionLengthPixels *= variantExtension * 2.0 - 1.0;
          }

          return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels, fType);
        }
      `);break;case 1:i.code.add(r["a"]`
        UnpackedAttributes unpackAttributes(ComponentData component) {
          vec2 sidenessNorm = sideness;
          vec2 sideness = sidenessNorm * 2.0 - 1.0;
          float extensionLengthPixels = component.extensionLength;
          extensionLengthPixels *= variantExtension * 2.0 - 1.0;
          float lineWidth = component.lineWidth;

          return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);
        }
      `);break;case 0:i.code.add(r["a"]`
        UnpackedAttributes unpackAttributes(ComponentData component) {
          vec2 sidenessNorm = sideness;
          vec2 sideness = sidenessNorm * 2.0 - 1.0;
          float extensionLengthPixels = component.extensionLength;
          float lineWidth = component.lineWidth;

          return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);
        }
      `)}}},b418:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));var r=i("3886"),a=i("6d5b"),n=i("3626");function s(e,t){e.include(a["a"],t),e.fragment.include(n["a"]);const i=e.fragment;i.uniforms.add("uBaseColor","vec4"),i.uniforms.add("uObjectOpacity","float"),t.attributeColor?i.code.add(r["a"]`
      vec3 _baseColor() {
        // combine the old material parameters into a single one
        return uBaseColor.rgb * vColor.rgb;
      }

      float _baseOpacity() {
        return uBaseColor.a * vColor.a;
      }
    `):i.code.add(r["a"]`
      vec3 _baseColor() {
        // combine the old material parameters into a single one
        return uBaseColor.rgb;
      }

      float _baseOpacity() {
        return uBaseColor.a;
      }
    `),i.code.add(r["a"]`
    vec4 computeMaterialColor(vec4 textureColor, vec4 externalColor, int externalColorMixMode) {
      vec3 baseColor = _baseColor();
      float baseOpacity = _baseOpacity();

      vec3 color = mixExternalColor(
        baseColor,
        textureColor.rgb,
        externalColor.rgb,
        externalColorMixMode
      );
      float opacity = uObjectOpacity * mixExternalOpacity(
        baseOpacity,
        textureColor.a,
        externalColor.a,
        externalColorMixMode
      );

      return vec4(color, opacity);
    }
  `)}},b485:function(e,t,i){"use strict";i.d(t,"a",(function(){return h}));var r=i("a4ee"),a=(i("c120"),i("e92d"),i("cea0"),i("59b2")),n=i("afcf"),s=i("d386"),o=(i("e041"),i("8eed"),i("f402"),i("5996")),c=(i("e06a"),i("ab68")),l=i("9651");const h=e=>{let t=class extends e{constructor(){super(...arguments),this.copyright=null,this.minScale=0,this.maxScale=0,this.spatialReference=null,this.tileInfo=null,this.tilemapCache=null}readMinScale(e,t){return null!=t.minLOD&&null!=t.maxLOD?e:0}readMaxScale(e,t){return null!=t.minLOD&&null!=t.maxLOD?e:0}get supportsBlankTile(){return this.version>=10.2}readTilemapCache(e,t){return t.capabilities&&t.capabilities.indexOf("Tilemap")>-1?new l["a"]({layer:this}):null}};return Object(r["a"])([Object(a["b"])({json:{read:{source:"copyrightText"}}})],t.prototype,"copyright",void 0),Object(r["a"])([Object(a["b"])()],t.prototype,"minScale",void 0),Object(r["a"])([Object(n["a"])("service","minScale")],t.prototype,"readMinScale",null),Object(r["a"])([Object(a["b"])()],t.prototype,"maxScale",void 0),Object(r["a"])([Object(n["a"])("service","maxScale")],t.prototype,"readMaxScale",null),Object(r["a"])([Object(a["b"])({type:o["a"]})],t.prototype,"spatialReference",void 0),Object(r["a"])([Object(a["b"])({readOnly:!0})],t.prototype,"supportsBlankTile",null),Object(r["a"])([Object(a["b"])(c["b"])],t.prototype,"tileInfo",void 0),Object(r["a"])([Object(a["b"])()],t.prototype,"tilemapCache",void 0),Object(r["a"])([Object(n["a"])("service","tilemapCache",["capabilities"])],t.prototype,"readTilemapCache",null),Object(r["a"])([Object(a["b"])()],t.prototype,"version",void 0),t=Object(r["a"])([Object(s["a"])("esri.layers.mixins.ArcGISCachedService")],t),t}},b48e:function(e,t,i){"use strict";var r,a=i("a4ee"),n=(i("c120"),i("e92d"),i("cea0"),i("59b2")),s=i("d386"),o=(i("e041"),i("8eed"),i("f402"),i("2c81")),c=i("9786"),l=i("4ae5"),h=i("1219"),d=i("f694"),u=i("8048"),p=i("40b6");let f=r=class extends h["a"]{constructor(...e){super(...e),this.center=null,this.geodesic=!1,this.numberOfPoints=60,this.radius=1e3,this.radiusUnit="meters"}normalizeCtorArgs(e,t){let i;if(e&&e.center)i=e;else{if(e&&e.rings)return super.normalizeCtorArgs(e,t);i={center:e}}return{...super.normalizeCtorArgs(),...i,...t}}initialize(){const e=this.center,t=this.numberOfPoints;if(this.hasZ=e&&e.hasZ,0!==this.rings.length||!e)return;const i=Object(u["c"])(this.radius,this.radiusUnit,"meters"),r=e.spatialReference;let a,n="geographic";if(r.isWebMercator?n="webMercator":(null!=o["a"][r.wkid]||r.wkt&&0===r.wkt.indexOf("PROJCS"))&&(n="projected"),this.geodesic){let r;switch(n){case"webMercator":r=Object(c["e"])(e);break;case"projected":console.error("Creating a geodesic circle requires the center to be specified in web mercator or geographic coordinate system");break;case"geographic":r=e}a=this._createGeodesicCircle(r,i,t),"webMercator"===n&&(a=Object(c["b"])(a))}else{let r;"webMercator"===n||"projected"===n?r=i/this._convert2Meters(1,e.spatialReference):"geographic"===n&&(r=Object(u["k"])(i,"meters",Object(d["e"])(e.spatialReference).radius)),a=this._createPlanarCircle(e,r,t)}this.spatialReference=a.spatialReference,this.addRing(a.rings[0])}clone(){const{center:e,numberOfPoints:t,radius:i,radiusUnit:a,geodesic:n}=this;return new r({center:e.clone(),numberOfPoints:t,radius:i,radiusUnit:a,geodesic:n})}_createGeodesicCircle(e,t,i){let r=0;const a=[];for(;r<360;){const n=[0,0],s=[e.x,e.y];Object(p["a"])(n,s,r,t),this.hasZ&&n.push(e.z),a.push(n),r+=360/i}return a.push(a[0]),new h["a"](a)}_createPlanarCircle(e,t,i){let r=0;const a=[];for(;r<2*Math.PI;){const n=[e.x+Math.cos(-r)*t,e.y+Math.sin(-r)*t];this.hasZ&&n.push(e.z),a.push(n),r+=Math.PI/(i/2)}return a.push(a[0]),new h["a"]({spatialReference:e.spatialReference,rings:[a]})}_convert2Meters(e,t){let i;if(null!=o["a"][t.wkid])i=o["a"].values[o["a"][t.wkid]];else{const e=t.wkt,r=e.lastIndexOf(",")+1,a=e.lastIndexOf("]]");i=parseFloat(e.substring(r,a))}return e*i}};Object(a["a"])([Object(n["b"])({type:l["a"]})],f.prototype,"center",void 0),Object(a["a"])([Object(n["b"])()],f.prototype,"geodesic",void 0),Object(a["a"])([Object(n["b"])()],f.prototype,"numberOfPoints",void 0),Object(a["a"])([Object(n["b"])()],f.prototype,"radius",void 0),Object(a["a"])([Object(n["b"])()],f.prototype,"radiusUnit",void 0),f=r=Object(a["a"])([Object(s["a"])("esri.geometry.Circle")],f);var m=f;t["a"]=m},b49d:function(e,t,i){"use strict";i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return s}));var r=i("3886"),a=i("b09a");function n(e,t){e.attributes.add("featureValue","vec4"),e.vertex.code.add(r["a"]`
  bool isCapVertex() {
    return featureValue.w == 1.0;
  }
  `),e.vertex.uniforms.add("size","vec3"),t.vvSize?(e.vertex.uniforms.add("vvSizeMinSize","vec3"),e.vertex.uniforms.add("vvSizeMaxSize","vec3"),e.vertex.uniforms.add("vvSizeOffset","vec3"),e.vertex.uniforms.add("vvSizeFactor","vec3"),e.vertex.code.add(r["a"]`
    vec2 getSize() {
      return size.xy*clamp(vvSizeOffset + featureValue.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).xz;
    }
    `)):e.vertex.code.add(r["a"]`
    vec2 getSize(){
      return size.xy;
    }
    `),t.vvOpacity?(e.vertex.constants.add("vvOpacityNumber","int",8),e.vertex.code.add(r["a"]`
    uniform float vvOpacityValues[vvOpacityNumber];
    uniform float vvOpacityOpacities[vvOpacityNumber];

    vec4 applyOpacity(vec4 color) {
      float value = featureValue.z;
      if (value <= vvOpacityValues[0]) {
        return vec4( color.xyz, vvOpacityOpacities[0]);
      }

      for (int i = 1; i < vvOpacityNumber; ++i) {
        if (vvOpacityValues[i] >= value) {
          float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
          return vec4( color.xyz, mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f));
        }
      }

      return vec4( color.xyz, vvOpacityOpacities[vvOpacityNumber - 1]);
    }
    `)):e.vertex.code.add(r["a"]`
    vec4 applyOpacity(vec4 color){
      return color;
    }
    `),t.vvColor?(e.vertex.constants.add("vvColorNumber","int",8),e.vertex.code.add(r["a"]`
    uniform float vvColorValues[vvColorNumber];
    uniform vec4 vvColorColors[vvColorNumber];

    vec4 getColor() {
      float value = featureValue.y;
      if (value <= vvColorValues[0]) {
        return applyOpacity(vvColorColors[0]);
      }

      for (int i = 1; i < vvColorNumber; ++i) {
        if (vvColorValues[i] >= value) {
          float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
          return applyOpacity(mix(vvColorColors[i-1], vvColorColors[i], f));
        }
      }

      return applyOpacity(vvColorColors[vvColorNumber - 1]);
    }
    `)):e.vertex.code.add(r["a"]`
    vec4 getColor(){
      return applyOpacity(vec4(1, 1, 1, 1));
    }
    `),e.include(a["a"]),e.attributes.add("profileRight","vec4"),e.attributes.add("profileUp","vec4"),e.attributes.add("profileVertexAndNormal","vec4"),e.vertex.code.add(r["a"]`
  vec3 calculateVPos() {
    vec2 size = getSize();
    vec3 origin = position;
    vec3 right = profileRight.xyz;
    vec3 up = profileUp.xyz;
    vec3 forward = cross(up, right);
    vec2 profileVertex = profileVertexAndNormal.xy * size;
    vec2 profileNormal = profileVertexAndNormal.zw;
    float positionOffsetAlongProfilePlaneNormal = 0.0;
    float normalOffsetAlongProfilePlaneNormal = 0.0;
    `),e.vertex.code.add(r["a"]`
    if(!isCapVertex()) {
      vec2 rotationRight = vec2(profileRight.w, profileUp.w);
      float maxDistance = length(rotationRight);
  `),e.vertex.code.add(r["a"]`
      rotationRight = maxDistance > 0.0 ? normalize(rotationRight) : vec2(0, 0);

      // decompose vertex into rotationRight and rotationUp
      // limit rotation right component to maxDistance
      // and reassemble profile vertex from rotationRight and rotationUp
      float rx = dot(profileVertex, rotationRight);
      if (abs(rx) > maxDistance) {
        // NB: we do the tangent by x=-y and y=x
        vec2 rotationUp = vec2(-rotationRight.y, rotationRight.x);
        float ry = dot(profileVertex, rotationUp);
        profileVertex = rotationRight * maxDistance * sign(rx) + rotationUp * ry;
      }
    }else{
       positionOffsetAlongProfilePlaneNormal = profileRight.w * size[0];
       normalOffsetAlongProfilePlaneNormal = profileUp.w;
    }

    vec3 offset = right * profileVertex.x + up * profileVertex.y + forward * positionOffsetAlongProfilePlaneNormal;

    return origin + offset; // localPosition
  }
  `),e.vertex.code.add(r["a"]`
  vec3 localNormal() {
    vec3 right = profileRight.xyz;
    vec3 up = profileUp.xyz;
    vec3 forward = cross(up, right);
    vec2 profileNormal = profileVertexAndNormal.zw;

    vec3 normal = right * profileNormal.x + up * profileNormal.y;

    if(isCapVertex()) {
      normal += forward * profileUp.w;
    }

    return normal;
  }
  `)}function s(e,t){t.vvSizeEnabled&&(e.setUniform3fv("vvSizeMinSize",t.vvSizeMinSize),e.setUniform3fv("vvSizeMaxSize",t.vvSizeMaxSize),e.setUniform3fv("vvSizeOffset",t.vvSizeOffset),e.setUniform3fv("vvSizeFactor",t.vvSizeFactor)),t.vvColorEnabled&&(e.setUniform1fv("vvColorValues",t.vvColorValues),e.setUniform4fv("vvColorColors",t.vvColorColors)),t.vvOpacityEnabled&&(e.setUniform1fv("vvOpacityValues",t.vvOpacityValues),e.setUniform1fv("vvOpacityOpacities",t.vvOpacityOpacities))}},b4c2:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i("3886");function a(e){e.vertex.code.add(r["a"]`
    vec3 applySkirts(inout vec2 uv, vec3 vpos, vec3 vnormal, float skirtScale) {
      float skirtLength = 0.0;

      if (uv.x >= 2.0) {
        skirtLength = uv.y * skirtScale;
        // decode original uv-coordinates (see "encodeSkirtPos")
        vec2 x = vec2(uv.x) - vec2(3.5, 4.5);
        uv = clamp(vec2(1.5) - abs(x), vec2(0.0), vec2(1.0));
      }

      return vpos - vnormal * skirtLength;
    }
    `)}},b4c8:function(e,t,i){"use strict";var r,a=i("dae5"),n=i("47f8");!function(e){e.Default={vvSizeEnabled:!1,vvSizeMinSize:Object(n["d"])(1,1,1),vvSizeMaxSize:Object(n["d"])(100,100,100),vvSizeOffset:Object(n["d"])(0,0,0),vvSizeFactor:Object(n["d"])(1,1,1),vvSizeValue:Object(n["d"])(1,1,1),vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],vvOpacityEnabled:!1,vvOpacityValues:[0,0,0,0,0,0,0,0],vvOpacityOpacities:[1,1,1,1,1,1,1,1],vvSymbolAnchor:[0,0,0],vvSymbolRotationMatrix:Object(a["a"])()}}(r||(r={}));var s=r;t["a"]=s},b63c:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i("6706"),a=i("7dcb");class n extends a["a"]{constructor(e){super(),this.point=e}equals(e){return e instanceof n&&Object(r["d"])(this.point,e.point)}}},b65e:function(e,t,i){"use strict";function r(e,t){if(!t||!e||!e.map)return;const{map:i}=e;i.layers.find(e=>e===t)||i.add(t)}i.d(t,"a",(function(){return r}))},b852:function(e,t,i){"use strict";i.d(t,"a",(function(){return d})),i.d(t,"b",(function(){return l}));var r=i("b2b2"),a=i("4c37"),n=i("2ff3"),s=i("a326");const o=["prepare","shadowmap","lineardepth","normals","ssao","opaque","opaque edges","transparent","transparent edges","hudvisibility","transparent terrain","atmosphere","laserline","occluded","antialiasing","highlights","hudOccluded","hudNotoccluded"];class c{constructor(){this.triangles=0,this.drawCalls=0}reset(){this.triangles=0,this.drawCalls=0}}function l(e,t,i){Object(r["k"])(i)&&(i.drawCalls+=e,i.triangles+=t)}class h extends n["a"]{constructor(){super("total"),this.total=0,this.frameCount=0}}class d{constructor(){this._startTime=0,this._lastSample=0,this._enableGPUTimer=0,this.totalTime=new h,this.gpuTime=new n["a"]("gpu",9),this.renderPassTimings=o.map(e=>new n["a"](e)),this.stats=new c}enableGPUTimer(){return++this._enableGPUTimer,{remove:Object(a["d"])(()=>--this._enableGPUTimer)}}prerender(e){this._startTime=this._lastSample=performance.now(),this._enableGPUTimer&&(this._gpuTimer=Object(s["a"])(e))}advance(e){const t=performance.now();this.renderPassTimings[e].record(t-this._lastSample),this._lastSample=t}postrender(){Object(r["k"])(this._gpuTimer)&&(this._gpuTimer.stop(e=>Object(r["k"])(e)&&this.gpuTime.record(e),16),this._gpuTimer=null);const e=performance.now()-this._startTime;this.totalTime.record(e),this.totalTime.total+=e,this.totalTime.frameCount++}}},ba58:function(e,t,i){"use strict";i.d(t,"a",(function(){return v})),i.d(t,"b",(function(){return M})),i.d(t,"c",(function(){return T})),i.d(t,"d",(function(){return E})),i.d(t,"e",(function(){return j})),i.d(t,"f",(function(){return R})),i.d(t,"g",(function(){return S})),i.d(t,"h",(function(){return D})),i.d(t,"i",(function(){return C})),i.d(t,"j",(function(){return w})),i.d(t,"k",(function(){return A}));var r=i("b2b2"),a=i("32ed"),n=i("57e5"),s=i("38a4"),o=i("0b2d"),c=i("d791"),l=i("9180"),h=i("8188"),d=i("afe1"),u=i("02f1"),p=i("0fc4"),f=i("7577"),m=i("4261"),b=i("1a54"),g=i("d3cf");function v(e,t){if("point"===e.type)return x(e,t,!1);if(Object(g["d"])(e))switch(e.type){case"extent":return x(e.center,t,!1);case"polygon":return x(e.centroid,t,!1);case"polyline":return x(y(e),t,!0);case"mesh":return x(e.extent.center,t,!1)}else switch(e.type){case"extent":return x(O(e),t,!0);case"polygon":return x(_(e),t,!0);case"polyline":return x(y(e),t,!0)}}function y(e){const t=e.paths[0];if(!t||0===t.length)return null;const i=Object(a["f"])(t,Object(a["e"])(t)/2);return Object(b["k"])(i[0],i[1],i[2],e.spatialReference)}function O(e){const t=Object(s["j"])(e.zmin);return Object(b["k"])(.5*(e.xmax+e.xmin),.5*(e.ymax+e.ymin),t?.5*(e.zmax+e.zmin):void 0,e.spatialReference)}function _(e){const t=e.rings[0];if(!t||0===t.length)return null;const i=Object(n["b"])(e.rings,e.hasZ);return Object(b["k"])(i[0],i[1],i[2],e.spatialReference)}function x(e,t,i){const r=i?e:Object(g["a"])(e);return t&&e?Object(h["s"])(e,r,t)?r:null:r}function j(e,t,i,r=0){if(e){t||(t=Object(l["l"])());const a=e;let n=.5*a.width*(i-1),s=.5*a.height*(i-1);return a.width<1e-7*a.height?n+=s/20:a.height<1e-7*a.width&&(s+=n/20),Object(f["l"])(t,a.xmin-n-r,a.ymin-s-r,a.xmax+n+r,a.ymax+s+r),t}return null}function w(e,t){for(let i=0;i<e.geometries.length;++i){const r=e.geometries[i].getMutableAttribute("auxpos1");r&&r.data[3]!==t&&(r.data[3]=t,e.geometryVertexAttrsUpdated(i))}}function S(e,t){const i=Object(p["f"])(p["a"]);return Object(r["k"])(e)&&(i[0]=e[0],i[1]=e[1],i[2]=e[2]),Object(r["k"])(t)?i[3]=t:Object(r["k"])(e)&&e.length>3&&(i[3]=e[3]),i}function C(e,t,i,a,n,s=[0,0,0,0]){for(let o=0;o<3;++o)Object(r["k"])(e)&&null!=e[o]?s[o]=e[o]:Object(r["k"])(i)&&null!=i[o]?s[o]=i[o]:s[o]=n[o];return Object(r["k"])(t)?s[3]=t:Object(r["k"])(a)?s[3]=a:s[3]=n[3],s}function T(e=o["a"],t,i,a=1){const n=new Array(3);if(Object(r["j"])(t)||Object(r["j"])(i))n[0]=1,n[1]=1,n[2]=1;else{let r,a=0;for(let s=2;s>=0;s--){const o=e[s];let c;const l=null!=o,h=0===s&&!r&&!l,d=i[s];"symbol-value"===o||h?c=0!==d?t[s]/d:1:l&&"proportional"!==o&&isFinite(o)&&(c=0!==d?o/d:1),null!=c&&(n[s]=c,r=c,a=Math.max(a,Math.abs(c)))}for(let e=2;e>=0;e--)null==n[e]?n[e]=r:0===n[e]&&(n[e]=.001*a)}for(let r=2;r>=0;r--)n[r]/=a;return Object(o["f"])(n)}function P(e){return null!=e.isPrimitive}function A(e){return P(e)&&(e=[e.width,e.depth,e.height]),R(e)?null:"Symbol sizes may not be negative values"}function R(e){if(Array.isArray(e)){for(const t of e)if(!R(t))return!1;return!0}return null==e||e>=0}function M(e,t,i,r=Object(d["b"])()){const a=e||0,n=t||0,s=i||0;return 0!==a&&Object(c["g"])(r,r,-a/180*Math.PI),0!==n&&Object(c["e"])(r,r,n/180*Math.PI),0!==s&&Object(c["f"])(r,r,s/180*Math.PI),r}function E(e,t){return null!=t.minDemResolution?t.minDemResolution:Object(m["y"])(e)?t.minDemResolutionForPoints:.01*Object(m["z"])(e)}const D={"bottom-left":Object(u["f"])(0,0),bottom:Object(u["f"])(.5,0),"bottom-right":Object(u["f"])(1,0),left:Object(u["f"])(0,.5),center:Object(u["f"])(.5,.5),right:Object(u["f"])(1,.5),"top-left":Object(u["f"])(0,1),top:Object(u["f"])(.5,1),"top-right":Object(u["f"])(1,1)}},bc05:function(e,t,i){"use strict";i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return s})),i.d(t,"c",(function(){return a})),i.d(t,"d",(function(){return o}));i("b2b2");var r=i("cba1");function a(e,t,i,r,a,n){const s=i-a;if(s>=0)return(t>>s)+(r-(n<<s))*(e>>s);const o=-s;return t-(n-(r<<o))*(e>>o)<<o}class n{constructor(e,t,i){this._rows=Math.ceil(t/i),this._columns=Math.ceil(e/i),this._cellSize=i,this.cells=new Array(this._rows);for(let r=0;r<this._rows;r++){this.cells[r]=new Array(this._columns);for(let e=0;e<this._columns;e++)this.cells[r][e]=[]}}getCell(e,t){const i=Math.min(Math.max(Math.floor(t/this._cellSize),0),this._rows-1),r=Math.min(Math.max(Math.floor(e/this._cellSize),0),this._columns-1);return this.cells[i]&&this.cells[i][r]||null}getCellSpan(e,t,i,r){return[Math.min(Math.max(Math.floor(e/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(t/this._cellSize),0),this.rows-1),Math.min(Math.max(Math.floor(i/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(r/this._cellSize),0),this.rows-1)]}get cellSize(){return this._cellSize}get columns(){return this._columns}get rows(){return this._rows}}function s(e,t,i,a,n,s){const o=t[a++];for(let c=0;c<o;c++){const o=new r["a"](s);o.xTile=t[a++],o.yTile=t[a++],o.hash=t[a++],o.priority=t[a++];const c=t[a++];for(let e=0;e<c;e++){const e=t[a++],r=t[a++],n=t[a++],s=t[a++],c=!!t[a++],l=t[a++],h=i[a++],d=i[a++],u=t[a++],p=t[a++];o.colliders.push({xTile:e,yTile:r,dxPixels:n,dyPixels:s,hard:c,partIndex:l,width:u,height:p,minLod:h,maxLod:d})}const l=e[a++];for(let t=0;t<l;t++)o.textVertexRanges.push([e[a++],e[a++]]);const h=e[a++];for(let t=0;t<h;t++)o.iconVertexRanges.push([e[a++],e[a++]]);n.push(o)}return a}function o(e,t,i){for(const[r,a]of e.symbols)c(e,t,i,a,r)}function c(e,t,i,r,a){const n=e.layerData.get(a);if(3===n.type){for(const t of r){const r=t.unique;let a;if(t.selectedForRendering){const t=r.parts[0],n=t.startOpacity,s=t.targetOpacity;e.allSymbolsFadingOut=e.allSymbolsFadingOut&&0===s;const o=i?Math.floor(127*n)|s<<7:s?255:0;a=o<<24|o<<16|o<<8|o}else a=0;for(const[e,i]of t.iconVertexRanges)for(let t=e;t<e+i;t+=4)n.iconOpacity[t/4]=a;if(t.selectedForRendering){const t=r.parts[1],n=t.startOpacity,s=t.targetOpacity;e.allSymbolsFadingOut=e.allSymbolsFadingOut&&0===s;const o=i?Math.floor(127*n)|s<<7:s?255:0;a=o<<24|o<<16|o<<8|o}else a=0;for(const[e,i]of t.textVertexRanges)for(let t=e;t<e+i;t+=4)n.textOpacity[t/4]=a}n.lastOpacityUpdate=t,n.opacityChanged=!0}}},bc40:function(e,t,i){"use strict";i.d(t,"a",(function(){return l}));var r=i("0b2d"),a=i("dae5"),n=i("afe1"),s=i("3886"),o=i("6a21"),c=i("b09a");function l(e,t){e.include(c["a"]),e.vertex.include(o["a"],t),e.varyings.add("vPositionWorldCameraRelative","vec3"),e.varyings.add("vPosition_view","vec3"),e.vertex.uniforms.add("uTransform_WorldFromModel_RS","mat3"),e.vertex.uniforms.add("uTransform_WorldFromModel_TH","vec3"),e.vertex.uniforms.add("uTransform_WorldFromModel_TL","vec3"),e.vertex.uniforms.add("uTransform_WorldFromView_TH","vec3"),e.vertex.uniforms.add("uTransform_WorldFromView_TL","vec3"),e.vertex.uniforms.add("uTransform_ViewFromCameraRelative_RS","mat3"),e.vertex.uniforms.add("uTransform_ProjFromView","mat4"),e.vertex.code.add(s["a"]`
    // compute position in world space orientation, but relative to the camera position
    vec3 positionWorldCameraRelative() {
      vec3 rotatedModelPosition = uTransform_WorldFromModel_RS * positionModel();

      vec3 transform_CameraRelativeFromModel = dpAdd(
        uTransform_WorldFromModel_TL,
        uTransform_WorldFromModel_TH,
        -uTransform_WorldFromView_TL,
        -uTransform_WorldFromView_TH
      );

      return transform_CameraRelativeFromModel + rotatedModelPosition;
    }

    // position in view space, that is relative to the camera position and orientation
    vec3 position_view() {
      return uTransform_ViewFromCameraRelative_RS * positionWorldCameraRelative();
    }

    // compute gl_Position and forward related varyings to fragment shader
    void forwardPosition() {
      vPositionWorldCameraRelative = positionWorldCameraRelative();
      vPosition_view = position_view();
      gl_Position = uTransform_ProjFromView * vec4(vPosition_view, 1.0);
    }

    vec3 positionWorld() {
      return uTransform_WorldFromView_TL + vPositionWorldCameraRelative;
    }
  `),e.fragment.uniforms.add("uTransform_WorldFromView_TL","vec3"),e.fragment.code.add(s["a"]`
    vec3 positionWorld() {
      return uTransform_WorldFromView_TL + vPositionWorldCameraRelative;
    }
  `)}!function(e){class t{constructor(){this.worldFromModel_RS=Object(a["a"])(),this.worldFromModel_TH=Object(r["e"])(),this.worldFromModel_TL=Object(r["e"])()}}e.ModelTransform=t;class i{constructor(){this.worldFromView_TH=Object(r["e"])(),this.worldFromView_TL=Object(r["e"])(),this.viewFromCameraRelative_RS=Object(a["a"])(),this.projFromView=Object(n["b"])()}}function s(e,t){e.setUniformMatrix3fv("uTransform_WorldFromModel_RS",t.worldFromModel_RS),e.setUniform3fv("uTransform_WorldFromModel_TH",t.worldFromModel_TH),e.setUniform3fv("uTransform_WorldFromModel_TL",t.worldFromModel_TL)}function o(e,t){e.setUniform3fv("uTransform_WorldFromView_TH",t.worldFromView_TH),e.setUniform3fv("uTransform_WorldFromView_TL",t.worldFromView_TL),e.setUniformMatrix4fv("uTransform_ProjFromView",t.projFromView),e.setUniformMatrix3fv("uTransform_ViewFromCameraRelative_RS",t.viewFromCameraRelative_RS)}e.ViewProjectionTransform=i,e.bindModelTransform=s,e.bindViewProjTransform=o}(l||(l={}))},bd75:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i("3886");function a(e,t){0===t.output&&t.receiveShadows?(e.varyings.add("linearDepth","float"),e.vertex.code.add(r["a"]`
      void forwardLinearDepth() { linearDepth = gl_Position.w; }
    `)):1===t.output||3===t.output?(e.varyings.add("linearDepth","float"),e.vertex.uniforms.add("cameraNearFar","vec2"),e.vertex.code.add(r["a"]`
      void forwardLinearDepth() {
        linearDepth = (-position_view().z - cameraNearFar[0]) / (cameraNearFar[1] - cameraNearFar[0]);
      }
    `)):e.vertex.code.add(r["a"]`
      void forwardLinearDepth() {}
    `)}},c20d:function(e,t,i){"use strict";i.d(t,"a",(function(){return x})),i.d(t,"b",(function(){return y})),i.d(t,"c",(function(){return O})),i.d(t,"d",(function(){return d})),i.d(t,"e",(function(){return h})),i.d(t,"f",(function(){return _})),i.d(t,"g",(function(){return p})),i.d(t,"h",(function(){return f})),i.d(t,"i",(function(){return b})),i.d(t,"j",(function(){return g})),i.d(t,"k",(function(){return v}));var r=i("7ffa"),a=i("b2b2"),n=(i("c649"),i("9786")),s=i("38a4"),o=i("a915"),c=i("cdc1");function l(e,t){let i=null,r=null;return n=>{if("cancel"===n.action)return void(Object(a["k"])(r)&&(r.execute({action:"cancel"}),i=null,r=null));const s={action:n.action,screenStart:n.start,screenEnd:n.screenPoint};"start"===n.action&&Object(a["j"])(i)&&(i=new x,r=new x,t(e,i,r,n.pointerType,s)),Object(a["k"])(i)&&i.execute(s),"end"===n.action&&Object(a["k"])(i)&&(i=null,r=null)}}function h(e,t){return e.events.on("drag",l(e,t))}function d(e,t){const i=[e.x,e.y,e.z],r=t,a=[Math.cos(r),Math.sin(r)],n=Math.sqrt(a[0]*a[0]+a[1]*a[1]);if(0===n)return null;a[0]/=n,a[1]/=n;const s=e=>{const t=(e.x-i[0])*a[0]+(e.y-i[1])*a[1];e.x=i[0]+t*a[0],e.y=i[1]+t*a[1]};return e=>(s(e.mapStart),s(e.mapEnd),e)}function u(e,t){let i=null;const r=Object(a["k"])(e[t])?e[t].spatialReference:null;function s(e,t){return Object(a["j"])(e)||"mesh"===e.type?null:e.spatialReference.equals(t)?e.clone():Object(n["a"])(e,t)?Object(n["d"])(e,t):null}return o=>{if("start"===o.action&&Object(a["k"])(e[t])&&(i=s(e[t],o.mapStart.spatialReference)),Object(a["j"])(i))return null;const l=o.mapEnd.x-o.mapStart.x,h=o.mapEnd.y-o.mapStart.y,d=o.mapEnd.z-o.mapStart.z,u=Object(c["d"])(i.clone(),l,h,d);return u.spatialReference.equals(r)?e[t]=u:e[t]=Object(n["d"])(u,r),{...o,translationX:l,translationY:h,translationZ:d}}}function p(e){return u(e,"geometry")}function f(e){const t=e.map(e=>Object(a["t"])(p(e))).filter(e=>Object(a["k"])(e));return e=>{const i=e.mapEnd.x-e.mapStart.x,r=e.mapEnd.y-e.mapStart.y,a=e.mapEnd.z-e.mapStart.z;return t.forEach(t=>t(e)),{...e,translationX:i,translationY:r,translationZ:a}}}function m(e,t){const i=new Map;for(const a of t)i.set(a,Object(r["a"])(e[a]));return t=>(i.forEach((t,i)=>{e[i]=t}),t)}function b(e){return m(e,["geometry"])}function g(e){const t=e.map(e=>Object(a["t"])(b(e))).filter(e=>Object(a["k"])(e));return e=>(t.forEach(t=>t(e)),e)}function v(e){const t=Object(a["k"])(e.symbol)?e.symbol.clone():null;return i=>(e.symbol=t,i)}function y(){let e=0,t=0,i=0;return r=>{"start"===r.action&&(e=r.mapStart.x,t=r.mapStart.y,i=r.mapStart.z);const a=r.mapEnd.x-e,n=r.mapEnd.y-t,s=r.mapEnd.z-i;return e=r.mapEnd.x,t=r.mapEnd.y,i=r.mapEnd.z,{...r,mapDeltaX:a,mapDeltaY:n,mapDeltaZ:s,mapDeltaSpatialReference:r.mapStart.spatialReference}}}function O(){let e=0,t=0;return i=>{"start"===i.action&&(e=i.screenStart.x,t=i.screenStart.y);const r=i.screenEnd.x-e,a=i.screenEnd.y-t;return e=i.screenEnd.x,t=i.screenEnd.y,{...i,screenDeltaX:r,screenDeltaY:a}}}function _(e,t){let i=null,r=0,a=0;return n=>{if("start"===n.action&&(i=e.toScreen(t),i.x<0||i.x>e.width||i.y<0||i.y>e.height?i=null:(r=n.screenStart.x-i.x,a=n.screenStart.y-i.y)),null==i)return null;const c=Object(s["d"])(n.screenEnd.x-r,0,e.width),l=Object(s["d"])(n.screenEnd.y-a,0,e.height),h=Object(o["f"])(c,l);return n.screenStart=i,n.screenEnd=h,n}}class x{constructor(){this.execute=()=>{}}next(e,t=new x){return Object(a["k"])(e)&&(this.execute=i=>{const r=e(i);Object(a["k"])(r)&&t.execute(r)}),t}}},c332:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i("3886");function a(e){const t=r["a"]`
    vec3 decodeNormal(vec2 f) {
      float z = 1.0 - abs(f.x) - abs(f.y);
      return vec3(f + sign(f) * min(z, 0.0), z);
    }
  `;e.fragment.code.add(t),e.vertex.code.add(t)}function n(e,t){0===t.normalType&&(e.attributes.add("normal","vec3"),e.vertex.code.add(r["a"]`
      vec3 normalModel() {
        return normal;
      }
    `)),1===t.normalType&&(e.include(a),e.attributes.add("normalCompressed","vec2"),e.vertex.code.add(r["a"]`
      vec3 normalModel() {
        return decodeNormal(normalCompressed);
      }
    `)),3===t.normalType&&(e.extensions.add("GL_OES_standard_derivatives"),e.fragment.code.add(r["a"]`
      vec3 screenDerivativeNormal(vec3 positionView) {
        return normalize(cross(dFdx(positionView), dFdy(positionView)));
      }
    `))}},c332f:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i("3886");function a(e,t){const i=e.vertex;t.silhouette?(i.code.add(r["a"]`
      bool isSilhouetteEdge(vec3 viewDir, vec3 normalA, vec3 normalB) {
        float faceAVisible = dot(viewDir, normalA);
        float faceBVisible = dot(viewDir, normalB);
        return faceAVisible * faceBVisible < 0.0;
      }
    `),t.legacy?i.code.add(r["a"]`
        bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
          vec3 viewNormalA = _modelToViewNormal(normalA);
          vec3 viewNormalB = _modelToViewNormal(normalB);
          vec3 viewDir = -viewPos;

          if (isSilhouetteEdge(viewDir, viewNormalA, viewNormalB)) {
            return false;
          }

          gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
          return true;
        }
      `):i.code.add(r["a"]`
        bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
          vec3 worldNormalA = _modelToWorldNormal(normalA);
          vec3 worldNormalB = _modelToWorldNormal(normalB);
          vec3 viewDir = -worldPos;

          if (isSilhouetteEdge(viewDir, worldNormalA, worldNormalB)) {
            return false;
          }

          gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
          return true;
        }
      `)):i.code.add(r["a"]`
      bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
        return false;
      }
    `)}},c3a3:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i("3886");function a(e,t){const i=e.fragment;i.constants.add("coverageTestThreshold","float",.01),t.antialiasing?i.code.add(r["a"]`
      #define discardByCoverage(radius, coverage) { if (coverage < coverageTestThreshold) discard; }
    `):i.code.add(r["a"]`
      #define discardByCoverage(radius, coverage) { float coverageLimit = radius <= 0.5 ? coverageTestThreshold : 0.75; if (coverage < coverageLimit) discard; }
    `)}},c49d:function(e,t,i){"use strict";i.d(t,"a",(function(){return o})),i.d(t,"b",(function(){return s}));var r=i("3886"),a=i("690a"),n=i("4377");function s(e){const t=new a["a"];return t.attributes.add("position","vec2"),t.attributes.add("uv0","vec2"),t.varyings.add("worldRay","vec3"),t.varyings.add("vtc","vec2"),e.haze&&t.varyings.add("eyeDir","vec3"),t.vertex.uniforms.add("projectionInverse","mat4"),t.vertex.uniforms.add("viewInverse","mat4"),t.vertex.code.add(r["a"]`
    void main(void) {
      vec3 posViewNear = (projectionInverse * vec4(position, -1, 1)).xyz;

      worldRay = (viewInverse * vec4(posViewNear, 0)).xyz;
      vtc = uv0;

      ${e.haze?r["a"]`eyeDir = posViewNear;`:""}

      gl_Position = vec4(position, 1, 1);
    }
  `),t.fragment.uniforms.add("lightingMainDirection","vec3").add("invWavelength","vec3").add("invWavelengthScaled","vec3").add("radii","vec2").add("atmosphereParameters1","vec4").add("atmosphereParameters2","vec4").add("cameraPosition","vec3").add("nearFar","vec2").add("heightParameters","vec4"),e.haze?t.fragment.uniforms.add("depthTex","sampler2D"):t.fragment.uniforms.add("atmosphereParameters3","vec3").add("innerFadeDistance","float").add("altitudeFade","float"),t.fragment.include(n["a"]),t.fragment.code.add(r["a"]`
  // Atmosphere
  const float krESun = 0.075;        // Kr * ESun = 0.005 * 15.0
  const float kmESun = 0.015;        // Km * ESun = 0.005 * 15

  // The inner (planetary) radius
  #define innerRadius radii[0]
  // The outer (atmosphere) radius
  #define outerRadius radii[1]

  // Atmosphere parameters:

  // shellScale:               1.0 / (outerRadius - innerRadius)
  #define shellScale atmosphereParameters1.x

  // shellDepth:               The scale depth (i.e. the altitude at which the atmosphere's average density is found)
  // scaleDepthBlue:           The scale depth (i.e. the altitude at which the atmosphere's average density is found)
  #define shellDepth vec2(atmosphereParameters1.y, atmosphereParameters2.y)

  // scaleOverScaleDepth:      scale / shellDepth
  // scaleOverScaleDepthBlue:  scale / scaleDepthBlue
  #define scaleOverScaleDepth vec2(atmosphereParameters1.z, atmosphereParameters2.z)

  // oneOverScaleDepth:        1.0 / shellDepth
  // oneOverScaleDepthBlue;    1.0 / scaleDepthBlue
  #define oneOverScaleDepth vec2(atmosphereParameters1.w, atmosphereParameters2.w)
  `),e.haze||t.fragment.code.add(r["a"]`
      #define g atmosphereParameters2.x
      #define gSq atmosphereParameters3.x
      #define miePhaseCoefficients atmosphereParameters3.y
      #define lowerAlphaBlendBound atmosphereParameters3.z
    `),t.fragment.code.add(r["a"]`
  // The camera's current height
  #define cameraHeight heightParameters[0]
  // cameraHeight^2
  #define cameraHeightSq heightParameters[1]
  // cameraHeightSq - outerRadiusSq; // C = ||o-c||^2 - r^2
  #define C heightParameters[2]
  // cameraHeightSq - (innerRadiusSq - 63756370000.0); // C = ||o-c||^2 - r^2
  #define CSur heightParameters[3]

  ${e.haze?"// Camera HDR\n        const float exposure = 1.5;\n        const vec3 oneOverGamma = vec3(1.0); //Gamma = 1.0":"const float exposure = 2.0;\n        const vec3 oneOverGamma = vec3(0.454545); // Gamma = 2.2\n        vec3 reinhardTM(vec3 inputColor, float _exposure) {\n          vec3 intermediate = inputColor * _exposure;\n          intermediate /= ( 1.0 + intermediate );\n          return pow(intermediate, oneOverGamma);\n        }\n        "}
    // Loop constants for integral approximation
    const float samples = 5.0;
    const int maxSamples = 5;

    // ToneMapping operators
    vec3 expTM(vec3 inputColor,float _exposure) {
        return pow(1.0 - exp(inputColor * -_exposure), oneOverGamma);
    }

    // Approximation for inner integral based on a radii ratio of 10.25:10
    float scale(float _cos) {
      float x = 1.0 - _cos;
      return exp( -0.00287 + x * ( 0.459 + x * ( 3.83 + x * (-6.80 + x * 5.25 ))));
    }

    void main() {
      // Obtain ray from Camera
      vec3 worldSpaceRay = normalize(worldRay);

      // Compute Atmosphere intersection; i.e. ray/sphere intersection
      float B = 2.0 * dot(cameraPosition, worldSpaceRay); // B = 2(l * (o-c))
      float det = B * B - 4.0 * C; // det = B^2 - 4.0* C

      // idealized sphere intersection to discard early some pixels
      float detSur = B * B - 4.0 * CSur; // det = B^2 - 4.0* C

      // the minimal sample start position:
      // at the camera by default, on the earth radius surface if the camera is underground.
      float minRayStart = 0.0;
  `),e.haze||t.fragment.code.add(r["a"]`
      float surfaceBlend = 0.0;
      vec4 surfaceColor = vec4(0.0);
      if (detSur >= 0.0) {
        float nearSurface = max(0.0, 0.5 *(-B - sqrt(detSur)));
        float farSurface = max(0.0, 0.5 *(-B + sqrt(detSur)));

        if (nearSurface == 0.0) {
          minRayStart = farSurface;
        }

        // Compute lighting at the point where the ray enters the earth surface
        // Lighting computation is copied from the terrain shader.
        vec3 vPos = cameraPosition + worldSpaceRay * nearSurface;
        float lightAngle = dot(-lightingMainDirection, normalize(vPos));
        float brightness = max(0.0, (smoothstep(-1.0, 0.8, 2.0 * lightAngle)));

        // Make the surface transparent based on altitude
        surfaceColor = vec4(brightness, brightness, brightness, 1.0 - altitudeFade);

        // Fade based on the distance the ray travels below the earth surface
        float relDist = (farSurface - nearSurface) / innerFadeDistance;

        // early exit
        if (relDist > 1.0) {
          gl_FragColor = surfaceColor;
          return;
        }

        surfaceBlend = smoothstep(0.0, 1.0, relDist * relDist);
      }
    `),t.fragment.code.add(r["a"]`
    if (det >= 0.0) {
    ${e.haze?"\n          float depthSample = texture2D(depthTex, vtc).r;\n\n          float zNear = nearFar[0];\n          float zFar = nearFar[1];\n\n          // http://web.archive.org/web/20130416194336/http://olivers.posterous.com/linear-depth-in-glsl-for-real\n          float zNorm = 2.0 * depthSample - 1.0;\n          float linDepth = 2.0 * zNear * zFar /\n            (zFar + zNear - zNorm * (zFar - zNear));\n\n          float rayEnd;\n          float altitudeAlpha = 1.0;\n\n          // find intersections with ground, but only between the near and far\n          // clipping planes.\n          if (depthSample < 1.0 && depthSample > 0.0) {\n            vec3 cameraSpaceRay = normalize(eyeDir);\n            cameraSpaceRay /= cameraSpaceRay.z;\n            cameraSpaceRay *= linDepth;\n\n            float cameraSpaceRayLength = length(cameraSpaceRay);\n\n            vec3 world = cameraPosition + worldSpaceRay * cameraSpaceRayLength;\n            float worldRadiusSq = dot(world, world);\n\n            // Handle tall structures:\n            // https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/5450\n            float transitionStart = innerRadius + 20000.0;\n            float transitionHeight = 25000.0;\n            float transitionEnd = transitionStart + transitionHeight;\n\n            float edge0 = transitionStart * transitionStart;\n            float edge1 = transitionEnd * transitionEnd;\n\n            altitudeAlpha = 1.0 - clamp((worldRadiusSq - edge0) / (edge1 - edge0), 0.0, 1.0);\n            rayEnd = cameraSpaceRayLength;\n\n            if (altitudeAlpha > 0.0 && detSur > 0.0) {\n              float nearSurface = 0.5 * ( -B - sqrt(detSur) );\n              float interp = clamp(((cameraHeight - innerRadius) - 2000000.0) / 6000000.0, 0.0, 1.0);\n              rayEnd = mix(cameraSpaceRayLength, nearSurface, interp);\n            }\n          }":""}
    float rayStart = 0.5 *(-B - sqrt(det)); //near intersection with atmosphere
    ${e.haze?"float near = abs(rayStart);\n        float far = abs(rayEnd);":"float rayEnd = 0.5 *(-B + sqrt(det)); //far intersection with atmosphere"}

    float scatterDistance; // calculate its scattering offset
    // Calculate the ray's starting position
    if (rayStart < minRayStart)
    { // ray starts from camera or inner radius sphere to far
      rayStart = minRayStart;
      ${e.haze?"":"// clamp to value at inner radius altitude\n          scatterDistance = shellScale * min(0.0, innerRadius - cameraHeight);"}
    }
    ${e.haze?"":"else { // outside atmosphere\n          scatterDistance = -1.0;\n        }"}
    // Initialize the scattering loop variables
    vec3 start = cameraPosition + worldSpaceRay * rayStart;
  `),e.haze&&t.fragment.code.add(r["a"]`
      vec3 end = cameraPosition + worldSpaceRay * rayEnd;

      float endLength = length(end);
      //altitudeStart, altitudeEnd
      vec2 altitudeInterval = vec2(length(start) - innerRadius, endLength - innerRadius);

      // for camera positions below altitude 0, invert the altitudes, to achieve
      // a similar haze as above ground. Note that there is a small but visible change
      // when the camera passes altitude 0.
      if (altitudeInterval.x < 0.0) {
        altitudeInterval = -altitudeInterval;
      }

      // computed for the original end point to get consistent light angles after possible inversions
      float lightAngle = dot(-lightingMainDirection, end) / endLength;

      if (near > far)
      {
        if (altitudeInterval.x < altitudeInterval.y)
        {
          // Switch positive slopes for flipped rays
          end = cameraPosition + worldSpaceRay * rayStart;
          start = cameraPosition + worldSpaceRay * rayEnd;
          worldSpaceRay *= -1.0;
          float tmp = altitudeInterval.x;
          altitudeInterval.x = altitudeInterval.y;
          altitudeInterval.y = tmp;
        }
        else if (altitudeInterval.x == altitudeInterval.y)
        { // create minuscule fake slope for integration if the slope is zero
          altitudeInterval.x += 1.0; //BUGFIX, if the height of camera and ground is equal the equation breaks, add fake meter to camera height to get
          // slope for the camera function
        }
      }

      // Calculate its scattering offset
      // Assumes camera constrains of WSV 3.8
      if (altitudeInterval.x > outerRadius - innerRadius)
      { // outside atmosphere
        scatterDistance = innerRadius - outerRadius;
      } else
      {
        scatterDistance = altitudeInterval.y - altitudeInterval.x;
      }
    `),t.fragment.code.add(r["a"]`
    vec2 opticalStartDepth = exp(scatterDistance * oneOverScaleDepth);

    float rayLength = rayEnd - rayStart;
    float sampleLength = rayLength / samples;
    float scaledLength = sampleLength * shellScale;
    vec3 sampleRay = worldSpaceRay * sampleLength;
    vec3 samplePoint = start + sampleRay * 0.5;
  `),e.haze?t.fragment.code.add(r["a"]`
      float cameraAngle = dot(-worldSpaceRay, end) / length(end);
      float scaleCameraAngle = scale(cameraAngle);
      vec2 cameraOffset = scaleCameraAngle * opticalStartDepth;

      float scaledValues = scale(lightAngle) + scaleCameraAngle;
      vec2 scaledValuesDepth = scaledValues * shellDepth;
    `):t.fragment.code.add(r["a"]`
      float cameraAngle = dot(worldSpaceRay, start / length(start));
      float angleMultiplier = cameraAngle > 0.0 ? cameraAngle : 0.0;

      float scaleCameraAngle = scale(cameraAngle);
      vec2 cameraOffset = scaleCameraAngle * opticalStartDepth * shellDepth;
    `),t.fragment.code.add(r["a"]`
    // Loop variables
    vec3 frontColor = vec3(0.0);
    vec3 frontColorBlue = vec3(0.0);
    vec3 attenuate = vec3(0.0);
    vec3 attenuateBlue = vec3(0.0);

    // Now loop through the sample rays
    for(int i=0; i<maxSamples; i++) {
      float height = length(samplePoint);
      float altitude = abs(height - innerRadius);

      vec2 depth = exp(-altitude * scaleOverScaleDepth);
  `),e.haze?t.fragment.code.add(r["a"]`
      vec2 scatter = depth * scaledValuesDepth - cameraOffset;
    `):t.fragment.code.add(r["a"]`
      float lightAngle = dot(-lightingMainDirection, samplePoint) / height;
      float cameraAngle = dot(worldSpaceRay, samplePoint) / height;
      float tmpScaledValues = scale(lightAngle) - scale(cameraAngle);
      vec2 scatter = cameraOffset + tmpScaledValues * depth * shellDepth;
    `),t.fragment.code.add(r["a"]`
      attenuate = exp(-scatter.x * invWavelengthScaled);
      attenuateBlue = exp(-scatter.y * invWavelengthScaled);

      frontColor += attenuate * depth.x;
      frontColorBlue += attenuateBlue * depth.y;

      samplePoint += sampleRay;
    }

    // Phase computation
    // clamp to avoid numerical instability at fCos == -1.0 (and close values) to display fake sun
    float LdotR = clamp(dot(-lightingMainDirection, -worldSpaceRay ),-0.9999999,1.0);
    float LdotRSq = LdotR * LdotR + 1.0;
  `),e.haze?t.fragment.code.add(r["a"]`
      // Finally, scale the Rayleigh colors and set up the varying variables for the pixel shader
      vec3 colorCoefficients = (scaledLength * 0.75 * LdotRSq) * (krESun * invWavelength + kmESun );

      // Scaled Length is only applied afterwards to save multiplications
      vec3 color = colorCoefficients * frontColor;
      vec3 colorBlue = colorCoefficients * frontColorBlue;
    `):t.fragment.code.add(r["a"]`
      vec3 rayleighCoefficients = (scaledLength * 0.75 * LdotRSq * krESun) * invWavelength;
      float mieCoefficients = scaledLength * kmESun * miePhaseCoefficients * LdotRSq / pow(1.0 + gSq - 2.0 * g * LdotR, 1.5);

      // Calculate the attenuation factor for the ground
      vec3 color = rayleighCoefficients * frontColor + mieCoefficients * frontColor;
      vec3 colorBlue = rayleighCoefficients * frontColorBlue + mieCoefficients * frontColorBlue;
    `),t.fragment.code.add(r["a"]`
    // HDR to LDR conversion
    vec3 ldrBlue = expTM(colorBlue, 2.0 * exposure);
    vec3 ldrRed = expTM(color, exposure);

    // mix reddish and blueish atmosphere
    vec3 LDR = mix(ldrBlue, ldrRed, 0.2);
  `),e.haze?t.fragment.code.add(r["a"]`
      LDR *= (1.0 - cameraAngle);
      vec3 hsv = rgb2hsv(LDR);
      hsv.y = clamp(hsv.y * 1.5, 0.0, 1.0); // boost haze saturation by 50%
      LDR = hsv2rgb(hsv);
      vec3 finalColor = LDR;
      // when rendering we specify the blend functions such that
      // newDestColor = oldDestColor*(1.0-finalColor) + finalColor
    `):t.fragment.code.add(r["a"]`
      // reinhard tonemapper for looking upwards
      vec3 ldrReinhard = reinhardTM(color, exposure);
      LDR += angleMultiplier * ldrReinhard;

      // height dependent parameter to smooth out reddish atmosphere
      float side = (rayEnd + rayStart) * 0.5;
      float atmoHeight = sqrt(cameraHeightSq - side * side);
      float h2 = clamp(1.0 - ( atmoHeight - lowerAlphaBlendBound ) / ( outerRadius - lowerAlphaBlendBound ), 0.0, 1.0);

      vec3 finalColor = LDR * h2;
      vec3 hsv = rgb2hsv(finalColor);
      hsv.y = clamp(hsv.y * 1.5, 0.0, 1.0); // boost sky saturation by 50%
      finalColor = hsv2rgb(hsv);
    `),t.fragment.code.add(r["a"]`
    ${e.haze?"gl_FragColor = vec4(finalColor, 1.0) * altitudeAlpha;":"float atmosStrength = clamp((length(ldrRed) - 0.05) * 1.05, 0.0, 1.0);\n          gl_FragColor = vec4(finalColor, atmosStrength * clamp(1.0 - ( atmoHeight - innerRadius ) / (outerRadius - innerRadius), 0.0, 1.0));\n          if (surfaceBlend > 0.0) {\n            gl_FragColor = mix(gl_FragColor, surfaceColor, surfaceBlend);\n          }"}
      } else { // Outside Atmosphere
        gl_FragColor = vec4(0.0);
      }
    }
  `),t}var o=Object.freeze({__proto__:null,build:s})},c9fb:function(e,t,i){"use strict";i.d(t,"a",(function(){return h}));var r=i("a4ee"),a=i("59b2"),n=i("d386"),s=i("6a0e"),o=i("9ef0");let c=class extends s["a"]{constructor(){super(...arguments),this.enabled=!0}};Object(r["a"])([Object(a["b"])({type:Boolean})],c.prototype,"enabled",void 0),c=Object(r["a"])([Object(n["a"])("esri.views.interactive.snapping.Settings.DefaultSnappingAlgorithm")],c);let l=class extends s["a"]{constructor(e){super(e),this.lineSnapper=new c,this.parallelLineSnapper=new c,this.rightAngleSnapper=new c,this.rightAngleTriangleSnapper=new c,this.shortLineThreshold=15,this.distance=5,this.pointThreshold=1e-6,this.intersectionParallelLineThreshold=1e-6,this.parallelLineThreshold=1e-6,this.touchSensitivityMultiplier=1.5,this.pointOnLineThreshold=1e-6,this.orange=new o["a"]([255,127,0]),this.lineHintWidthReference=3,this.lineHintWidthTarget=3,this.lineHintFadedExtensions=.3,this.parallelLineHintWidth=2,this.parallelLineHintLength=24,this.parallelLineHintOffset=1.5,this.rightAngleHintSize=24,this.rightAngleHintOutlineSize=1.5}};Object(r["a"])([Object(a["b"])({type:c,constructOnly:!0,nonNullable:!0,json:{write:!0}})],l.prototype,"lineSnapper",void 0),Object(r["a"])([Object(a["b"])({type:c,constructOnly:!0,nonNullable:!0,json:{write:!0}})],l.prototype,"parallelLineSnapper",void 0),Object(r["a"])([Object(a["b"])({type:c,constructOnly:!0,nonNullable:!0,json:{write:!0}})],l.prototype,"rightAngleSnapper",void 0),Object(r["a"])([Object(a["b"])({type:c,constructOnly:!0,nonNullable:!0,json:{write:!0}})],l.prototype,"rightAngleTriangleSnapper",void 0),Object(r["a"])([Object(a["b"])({type:Number,nonNullable:!0,range:{min:-1,max:50,step:1},json:{write:!0}})],l.prototype,"shortLineThreshold",void 0),Object(r["a"])([Object(a["b"])({type:Number,nonNullable:!0,range:{min:-1,max:50,step:1},json:{write:!0}})],l.prototype,"distance",void 0),Object(r["a"])([Object(a["b"])({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],l.prototype,"pointThreshold",void 0),Object(r["a"])([Object(a["b"])({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],l.prototype,"intersectionParallelLineThreshold",void 0),Object(r["a"])([Object(a["b"])({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],l.prototype,"parallelLineThreshold",void 0),Object(r["a"])([Object(a["b"])({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],l.prototype,"touchSensitivityMultiplier",void 0),Object(r["a"])([Object(a["b"])({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],l.prototype,"pointOnLineThreshold",void 0),Object(r["a"])([Object(a["b"])({type:o["a"],nonNullable:!0})],l.prototype,"orange",void 0),Object(r["a"])([Object(a["b"])({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],l.prototype,"lineHintWidthReference",void 0),Object(r["a"])([Object(a["b"])({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],l.prototype,"lineHintWidthTarget",void 0),Object(r["a"])([Object(a["b"])({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],l.prototype,"lineHintFadedExtensions",void 0),Object(r["a"])([Object(a["b"])({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],l.prototype,"parallelLineHintWidth",void 0),Object(r["a"])([Object(a["b"])({type:Number,nonNullable:!0,range:{min:0,max:50},json:{write:!0}})],l.prototype,"parallelLineHintLength",void 0),Object(r["a"])([Object(a["b"])({type:Number,nonNullable:!0,range:{min:0,max:5},json:{write:!0}})],l.prototype,"parallelLineHintOffset",void 0),Object(r["a"])([Object(a["b"])({type:Number,nonNullable:!0,range:{min:0,max:46},json:{write:!0}})],l.prototype,"rightAngleHintSize",void 0),Object(r["a"])([Object(a["b"])({type:Number,nonNullable:!0,range:{min:0,max:6},json:{write:!0}})],l.prototype,"rightAngleHintOutlineSize",void 0),l=Object(r["a"])([Object(n["a"])("esri.views.interactive.snapping.Settings.Defaults")],l);const h=new l},caca:function(e,t,i){"use strict";var r=i("b2b2"),a=i("e92d"),n=i("1153");const s=[{output:0,name:"color"},{output:1,name:"depth"},{output:2,name:"normal"},{output:3,name:"depthShadowMap"},{output:4,name:"highlight"},{output:5,name:"draped"},{output:6,name:"occlusion"},{output:7,name:"alpha"}];function o(e,t){return e+"_"+s.find(e=>e.output===t).name}const c=a["a"].getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRep");class l{constructor(e){this.refCnt=0,this.glMaterial=e}incRefCnt(){++this.refCnt}decRefCnt(){--this.refCnt,Object(n["a"])(this.refCnt>=0)}getRefCnt(){return this.refCnt}getGLMaterial(){return this.glMaterial}}class h{constructor(e,t,i){this._textureRep=e,this._techniqueRep=t,this.onMaterialChanged=i,this._id2glMaterialRef=new Map}dispose(){this._textureRep.dispose()}acquire(e,t){this.ownMaterial(e);const i=o(e.id,t);let r=this._id2glMaterialRef.get(i);if(null==r){const a=e.getGLMaterial({material:e,techniqueRep:this._techniqueRep,textureRep:this._textureRep,output:t});return r=new l(a),r.incRefCnt(),this._id2glMaterialRef.set(i,r),a}return r.incRefCnt(),r.getGLMaterial()}release(e,t){const i=o(e.id,t),r=this._id2glMaterialRef.get(i);if(r.decRefCnt(),0===r.getRefCnt()){const e=r.getGLMaterial();e&&e.dispose(),this._id2glMaterialRef.delete(i)}}materialChanged(e){for(const t of s)if(5!==t.output&&6!==t.output){const i=this._id2glMaterialRef.get(o(e.id,t.output));if(i&&i.getGLMaterial()){const e=i.getGLMaterial();e.updateParameters&&e.updateParameters()}}this.onMaterialChanged&&this.onMaterialChanged(e)}ownMaterial(e){Object(r["k"])(e.materialRepository)&&e.materialRepository!==this&&c.error("Material is already owned by a different material repository"),e.materialRepository=this}}t["a"]=h},caf1:function(e,t,i){"use strict";i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return n}));var r=i("b2b2"),a=i("38a4");function n(e){switch(e){case"multiply":return 1;case"ignore":return 2;case"replace":return 3;case"tint":return 4;default:return 1}}function s(e,t,i){if(Object(r["j"])(e)||2===t)return i[0]=255,i[1]=255,i[2]=255,void(i[3]=255);const n=Object(a["d"])(Math.round(e[3]*c),0,c),s=0===n||4===t?0:3===t?l:h;i[0]=Object(a["d"])(Math.round(e[0]*o),0,o),i[1]=Object(a["d"])(Math.round(e[1]*o),0,o),i[2]=Object(a["d"])(Math.round(e[2]*o),0,o),i[3]=n+s}const o=255,c=85,l=c,h=2*c},caf7:function(e,t,i){"use strict";var r,a=i("0b2d"),n=i("e431"),s=i("47f8"),o=i("d0ac");!function(e){function t(e,t){const i=e[t],r=e[t+1],a=e[t+2];return Math.sqrt(i*i+r*r+a*a)}function i(e,t){const i=e[t],r=e[t+1],a=e[t+2],n=1/Math.sqrt(i*i+r*r+a*a);e[t]*=n,e[t+1]*=n,e[t+2]*=n}function r(e,t,i){e[t]*=i,e[t+1]*=i,e[t+2]*=i}function a(e,t,i,r,a,n=t){(a=a||e)[n]=e[t]+i[r],a[n+1]=e[t+1]+i[r+1],a[n+2]=e[t+2]+i[r+2]}function n(e,t,i,r,a,n=t){(a=a||e)[n]=e[t]-i[r],a[n+1]=e[t+1]-i[r+1],a[n+2]=e[t+2]-i[r+2]}e.length=t,e.normalize=i,e.scale=r,e.add=a,e.subtract=n}(r||(r={}));var c=i("1153"),l=i("1038"),h=i("0278");const d=r;var u,p,f,m;!function(e){const t=.5,i=[[-t,-t,t],[t,-t,t],[t,t,t],[-t,t,t],[-t,-t,-t],[t,-t,-t],[t,t,-t],[-t,t,-t]],r=[0,0,1,-1,0,0,1,0,0,0,-1,0,0,1,0,0,0,-1],a=[0,0,1,0,1,1,0,1],n=new Uint16Array([0,1,2,2,3,0,4,0,3,3,7,4,1,5,6,6,2,1,1,0,4,4,5,1,3,2,6,6,7,3,5,4,7,7,6,5]),s=new Uint16Array(36);for(let l=0;l<6;l++)for(let e=0;e<6;e++)s[6*l+e]=l;const o=new Uint16Array(36);for(let l=0;l<6;l++)o[6*l+0]=0,o[6*l+1]=1,o[6*l+2]=2,o[6*l+3]=2,o[6*l+4]=3,o[6*l+5]=0;function c(e){Array.isArray(e)||(e=[e,e,e]);const t=new Array(24);for(let r=0;r<8;r++)t[3*r]=i[r][0]*e[0],t[3*r+1]=i[r][1]*e[1],t[3*r+2]=i[r][2]*e[2];return new h["a"]([["position",{size:3,data:t,exclusive:!0}],["normal",{size:3,data:r}],["uv0",{size:2,data:a}]],[["position",n],["normal",s],["uv0",o]])}e.createGeometry=c}(u||(u={})),function(e){const t=.5,i=[[-t,0,-t],[t,0,-t],[t,0,t],[-t,0,t],[0,-t,0],[0,t,0]],r=[0,1,-1,1,1,0,0,1,1,-1,1,0,0,-1,-1,1,-1,0,0,-1,1,-1,-1,0],a=new Uint16Array([5,1,0,5,2,1,5,3,2,5,0,3,4,0,1,4,1,2,4,2,3,4,3,0]),n=new Uint16Array([0,0,0,1,1,1,2,2,2,3,3,3,4,4,4,5,5,5,6,6,6,7,7,7]);function s(e){Array.isArray(e)||(e=[e,e,e]);const t=new Array(18);for(let r=0;r<6;r++)t[3*r]=i[r][0]*e[0],t[3*r+1]=i[r][1]*e[1],t[3*r+2]=i[r][2]*e[2];return new h["a"]([["position",{size:3,data:t,exclusive:!0}],["normal",{size:3,data:r}]],[["position",a],["normal",n]])}e.createGeometry=s}(p||(p={})),function(e){const t=.5,i=0,r=Object(s["d"])(-t,i,-t),a=Object(s["d"])(t,i,-t),o=Object(s["d"])(0,i,t),c=Object(s["d"])(0,i+t,0),l=Object(s["c"])(),d=Object(s["c"])(),u=Object(s["c"])(),p=Object(s["c"])(),f=Object(s["c"])();Object(n["k"])(l,r,c),Object(n["k"])(d,r,a),Object(n["h"])(u,l,d),Object(n["s"])(u,u),Object(n["k"])(l,a,c),Object(n["k"])(d,a,o),Object(n["h"])(p,l,d),Object(n["s"])(p,p),Object(n["k"])(l,o,c),Object(n["k"])(d,o,r),Object(n["h"])(f,l,d),Object(n["s"])(f,f);const m=[r,a,o,c],b=[0,-1,0,u[0],u[1],u[2],p[0],p[1],p[2],f[0],f[1],f[2]],g=[0,1,2,3,1,0,3,2,1,3,0,2],v=[0,0,0,1,1,1,2,2,2,3,3,3];function y(e){Array.isArray(e)||(e=[e,e,e]);const t=new Array(12);for(let i=0;i<4;i++)t[3*i]=m[i][0]*e[0],t[3*i+1]=m[i][1]*e[1],t[3*i+2]=m[i][2]*e[2];return new h["a"]([["position",{size:3,data:t,exclusive:!0}],["normal",{size:3,data:b}]],[["position",new Uint16Array(g)],["normal",new Uint16Array(v)]])}e.createGeometry=y}(f||(f={})),function(e){function t(e,t,i,r={uv:!0}){const a=-Math.PI,n=2*Math.PI,s=-Math.PI/2,o=Math.PI,c=Math.max(3,Math.floor(t)),l=Math.max(2,Math.floor(i)),d=(c+1)*(l+1),u=new Float32Array(3*d),p=new Float32Array(3*d),f=new Float32Array(2*d),m=[];let b=0;for(let h=0;h<=l;h++){const t=[],i=h/l,r=s+i*o,d=Math.cos(r);for(let s=0;s<=c;s++){const o=s/c,l=a+o*n,h=Math.cos(l)*d,m=Math.sin(r),g=-Math.sin(l)*d;u[3*b]=h*e,u[3*b+1]=m*e,u[3*b+2]=g*e,p[3*b]=h,p[3*b+1]=m,p[3*b+2]=g,f[2*b]=o,f[2*b+1]=i,t.push(b),++b}m.push(t)}const g=new Uint32Array(2*c*(l-1)*3);b=0;for(let h=0;h<l;h++)for(let e=0;e<c;e++){const t=m[h][e],i=m[h][e+1],r=m[h+1][e+1],a=m[h+1][e];0===h?(g[b++]=t,g[b++]=r,g[b++]=a):h===l-1?(g[b++]=t,g[b++]=i,g[b++]=r):(g[b++]=t,g[b++]=i,g[b++]=r,g[b++]=r,g[b++]=a,g[b++]=t)}const v=[["position",g],["normal",g]],y=[["position",{size:3,data:u,exclusive:!0}],["normal",{size:3,data:p,exclusive:!0}]];return r.uv&&(y.push(["uv0",{size:2,data:f,exclusive:!0}]),v.push(["uv0",g])),r.offset&&(v[0][0]="offset",y[0][0]="offset",v.push(["position",new Uint32Array(g.length)]),y.push(["position",{size:3,data:Float64Array.from(r.offset),exclusive:!0}])),new h["a"](y,v)}function i(e,t,i){const r=e;let a,n;if(i)a=[0,-1,0,1,0,0,0,0,1,-1,0,0,0,0,-1,0,1,0],n=new Uint32Array([0,1,2,0,2,3,0,3,4,0,4,1,1,5,2,2,5,3,3,5,4,4,5,1]);else{const e=r*(1+Math.sqrt(5))/2;a=[-r,e,0,r,e,0,-r,-e,0,r,-e,0,0,-r,e,0,r,e,0,-r,-e,0,r,-e,e,0,-r,e,0,r,-e,0,-r,-e,0,r],n=new Uint32Array([0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1])}for(let h=0;h<a.length;h+=3)d.scale(a,h,e/d.length(a,h));let s={};function o(t,i){t>i&&([t,i]=[i,t]);const r=t.toString()+"."+i.toString();if(s[r])return s[r];let n=a.length;return a.length+=3,d.add(a,3*t,a,3*i,a,n),d.scale(a,n,e/d.length(a,n)),n/=3,s[r]=n,n}for(let h=0;h<t;h++){const e=n.length,t=new Uint32Array(4*e);for(let i=0;i<e;i+=3){const e=n[i],r=n[i+1],a=n[i+2],s=o(e,r),c=o(r,a),l=o(a,e),h=4*i;t[h]=e,t[h+1]=s,t[h+2]=l,t[h+3]=r,t[h+4]=c,t[h+5]=s,t[h+6]=a,t[h+7]=l,t[h+8]=c,t[h+9]=s,t[h+10]=c,t[h+11]=l}n=t,s={}}const c=new Float32Array(a);for(let h=0;h<c.length;h+=3)d.normalize(c,h);const l=[["position",n],["normal",n]],u=[["position",{size:3,data:new Float32Array(a),exclusive:!0}],["normal",{size:3,data:c,exclusive:!0}]];return new h["a"](u,l)}function r(e,t,i,r,a,n,s){const o=t?[t[0],t[1],t[2]]:[0,0,0],c=e?[e[0],e[1],e[2]]:[0,0,1];n=n||[0,0];const l=i?[255*i[0],255*i[1],255*i[2],i.length>3?255*i[3]:255]:[255,255,255,255],d=null!=r&&2===r.length?r:[1,1],u=[["position",{size:3,data:o,exclusive:!0}],["normal",{size:3,data:c,exclusive:!0}],["uv0",{size:n.length,data:n}],["color",{size:4,data:l,exclusive:!0}],["size",{size:2,data:d}]];if(null!=a){const e=new Float32Array([a[0],a[1],a[2],a[3]]);u.push(["auxpos1",{size:4,data:e}])}if(null!=s){const e=new Float32Array([s[0],s[1],s[2],s[3]]);u.push(["auxpos2",{size:4,data:e}])}return new h["a"](u,null,1)}function m(e,t,i,r,a,n,s,o){if(null!=e){const{data:t}=o.getMutableAttribute("normal");t[0]=e[0],t[1]=e[1],t[2]=e[2]}if(null!=t){const{data:e}=o.getMutableAttribute("position");e[0]=t[0],e[1]=t[1],e[2]=t[2]}if(null!=i){const{data:e}=o.getMutableAttribute("color");e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3]}if(null!=r){const{data:e}=o.getMutableAttribute("size");e[0]=r[0],e[1]=r[1]}if(null!=a){const{data:e}=o.getMutableAttribute("auxpos1");e[0]=a[0],e[1]=a[1],e[2]=a[2],e[3]=a[3]}if(null!=n){const{data:e}=o.getMutableAttribute("uv0");e[0]=n[0],e[1]=n[1]}if(null!=s){const{data:e}=o.getMutableAttribute("auxpos2");e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=s[3]}}function v(e,t){const i=new Float32Array(3*e.length),r=new Float32Array(t?3*e.length:3),a=new Uint32Array(e.length),n=new Uint32Array(e.length);for(let s=0;s<e.length;s++)i[3*s]=e[s][0],i[3*s+1]=e[s][1],i[3*s+2]=e[s][2],t&&(r[3*s]=t[s][0],r[3*s+1]=t[s][1],r[3*s+2]=t[s][2]),a[s]=s,n[s]=0;return t||(r[0]=0,r[1]=1,r[2]=0),new h["a"]([["position",{size:3,data:i,exclusive:!0}],["normal",{size:3,data:r,exclusive:!0}],["uv0",{size:2,data:[0,0],exclusive:!0}]],[["position",a],["normal",t?a:n],["uv0",n]],1)}function y(){const e=[0,0,0,0,0,100,100,0,0],t=new Uint16Array([0,1,2]),i=[0,1,0],r=new Uint16Array([0,0,0]),a=[0,0],n=new Uint16Array([0,0,0]);return new h["a"]([["position",{size:3,data:e,exclusive:!0}],["normal",{size:3,data:i,exclusive:!0}],["uv0",{size:2,data:a,exclusive:!0}]],[["position",t],["normal",r],["uv0",n]])}e.createBoxGeometry=u.createGeometry,e.createDiamondGeometry=p.createGeometry,e.createTetrahedronGeometry=f.createGeometry,e.createSphereGeometry=t,e.createPolySphereGeometry=i,e.createPointGeometry=r,e.updatePointGeometry=m,e.createPointArrayGeometry=v,e.createTriangleGeometry=y;const O=[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0]];function _(e=O){const t=new Array(12);for(let n=0;n<4;n++)for(let i=0;i<3;i++)t[3*n+i]=e[n][i];const i=new Uint32Array([0,1,2,2,3,0]),r=[0,0,1],a=new Uint32Array([0,0,0,0,0,0]);return new h["a"]([["position",{size:3,data:t,exclusive:!0}],["normal",{size:3,data:r,exclusive:!0}],["uv0",{size:2,data:[0,0,1,0,1,1,0,1],exclusive:!0}],["color",{size:4,data:[255,255,255,255],exclusive:!0}]],[["position",i],["normal",a],["uv0",i],["color",a]])}function x(e,t,i,r,a=!0,n=!0){let o=0;const c=t,l=e;let d=Object(s["d"])(0,o,0),u=Object(s["d"])(0,o+l,0),p=Object(s["d"])(0,-1,0),f=Object(s["d"])(0,1,0);r&&(o=l,u=Object(s["d"])(0,0,0),d=Object(s["d"])(0,o,0),p=Object(s["d"])(0,1,0),f=Object(s["d"])(0,-1,0));const m=[u,d],b=[p,f],g=i+2,v=Math.sqrt(l*l+c*c);if(r)for(let h=i-1;h>=0;h--){const e=h*(2*Math.PI/i),t=Object(s["d"])(Math.cos(e)*c,o,Math.sin(e)*c);m.push(t);const r=Object(s["d"])(l*Math.cos(e)/v,-c/v,l*Math.sin(e)/v);b.push(r)}else for(let h=0;h<i;h++){const e=h*(2*Math.PI/i),t=Object(s["d"])(Math.cos(e)*c,o,Math.sin(e)*c);m.push(t);const r=Object(s["d"])(l*Math.cos(e)/v,c/v,l*Math.sin(e)/v);b.push(r)}const y=new Uint32Array(2*(i+2)*3),O=new Uint32Array(2*(i+2)*3);let _=0,x=0;if(a){for(let e=3;e<m.length;e++)y[_++]=1,y[_++]=e-1,y[_++]=e,O[x++]=0,O[x++]=0,O[x++]=0;y[_++]=m.length-1,y[_++]=2,y[_++]=1,O[x++]=0,O[x++]=0,O[x++]=0}if(n){for(let e=3;e<m.length;e++)y[_++]=e,y[_++]=e-1,y[_++]=0,O[x++]=e,O[x++]=e-1,O[x++]=1;y[_++]=0,y[_++]=2,y[_++]=m.length-1,O[x++]=1,O[x++]=2,O[x++]=b.length-1}const j=new Float32Array(3*g);for(let s=0;s<g;s++)j[3*s]=m[s][0],j[3*s+1]=m[s][1],j[3*s+2]=m[s][2];const w=new Float32Array(3*g);for(let s=0;s<g;s++)w[3*s]=b[s][0],w[3*s+1]=b[s][1],w[3*s+2]=b[s][2];return new h["a"]([["position",{size:3,data:j,exclusive:!0}],["normal",{size:3,data:w,exclusive:!0}]],[["position",y],["normal",O]])}function j(e,t,i,r,a,o){const c=r?Object(s["a"])(r):Object(s["d"])(1,0,0),l=a?Object(s["a"])(a):Object(s["d"])(0,0,0);o=null==o||o;const d=Object(s["c"])();Object(n["s"])(d,c);const u=Object(s["c"])();Object(n["f"])(u,d,Math.abs(e));const p=Object(s["c"])();Object(n["f"])(p,u,-.5),Object(n["g"])(p,p,l);const f=Object(s["d"])(0,1,0);Math.abs(1-Object(n["i"])(d,f))<.2&&Object(n["x"])(f,0,0,1);const m=Object(s["c"])();Object(n["h"])(m,d,f),Object(n["s"])(m,m),Object(n["h"])(f,m,d);const b=2*i+(o?2:0),g=i+(o?2:0),v=new Float32Array(3*b),y=new Float32Array(3*g),O=new Float32Array(2*b),_=new Uint32Array(3*i*(o?4:2)),x=new Uint32Array(3*i*(o?4:2));o&&(v[3*(b-2)+0]=p[0],v[3*(b-2)+1]=p[1],v[3*(b-2)+2]=p[2],O[2*(b-2)]=0,O[2*(b-2)+1]=0,v[3*(b-1)+0]=v[3*(b-2)+0]+u[0],v[3*(b-1)+1]=v[3*(b-2)+1]+u[1],v[3*(b-1)+2]=v[3*(b-2)+2]+u[2],O[2*(b-1)]=1,O[2*(b-1)+1]=1,y[3*(g-2)+0]=-d[0],y[3*(g-2)+1]=-d[1],y[3*(g-2)+2]=-d[2],y[3*(g-1)+0]=d[0],y[3*(g-1)+1]=d[1],y[3*(g-1)+2]=d[2]);const j=function(e,t,i){_[e]=t,x[e]=i};let w=0;const S=Object(s["c"])(),C=Object(s["c"])();for(let s=0;s<i;s++){const e=s*(2*Math.PI/i);Object(n["f"])(S,f,Math.sin(e)),Object(n["f"])(C,m,Math.cos(e)),Object(n["g"])(S,S,C),y[3*s+0]=S[0],y[3*s+1]=S[1],y[3*s+2]=S[2],Object(n["f"])(S,S,t),Object(n["g"])(S,S,p),v[3*s+0]=S[0],v[3*s+1]=S[1],v[3*s+2]=S[2],O[2*s+0]=s/i,O[2*s+1]=0,v[3*(s+i)+0]=v[3*s+0]+u[0],v[3*(s+i)+1]=v[3*s+1]+u[1],v[3*(s+i)+2]=v[3*s+2]+u[2],O[2*(s+i)+0]=s/i,O[2*s+1]=1;const r=(s+1)%i;j(w++,s,s),j(w++,s+i,s),j(w++,r,r),j(w++,r,r),j(w++,s+i,s),j(w++,r+i,r)}if(o){for(let e=0;e<i;e++){const t=(e+1)%i;j(w++,b-2,g-2),j(w++,e,g-2),j(w++,t,g-2)}for(let e=0;e<i;e++){const t=(e+1)%i;j(w++,e+i,g-1),j(w++,b-1,g-1),j(w++,t+i,g-1)}}return new h["a"]([["position",{size:3,data:v,exclusive:!0}],["normal",{size:3,data:y,exclusive:!0}],["uv0",{size:2,data:O,exclusive:!0}]],[["position",_],["normal",x],["uv0",_]])}function w(t,i,r,a,n){r=r||10,a=null==a||a,Object(c["a"])(t.length>1);const s=[[0,0,0]],o=[],l=[];for(let e=0;e<r;e++){o.push([0,-e-1,-(e+1)%r-1]);const t=e/r*2*Math.PI;l.push([Math.cos(t)*i,Math.sin(t)*i])}return e.createPathExtrusionGeometry(l,t,s,o,a,n)}function S(e,t,i,r,c,l=Object(s["d"])(0,0,0)){const d=e.length,u=new Float32Array(t.length*d*3+(6*i.length||0)),p=new Float32Array(t.length*d*3+(i?6:0)),f=(t.length-1)*d*6+3*r.length*2,m=new Uint32Array(f),g=new Uint32Array(f);let v=0,y=0,O=0,_=0;const x=Object(s["c"])(),j=Object(s["c"])(),w=Object(s["c"])(),S=Object(s["c"])(),C=Object(s["c"])(),T=Object(s["c"])(),P=Object(s["c"])(),A=Object(a["e"])(),R=Object(s["c"])(),E=Object(s["c"])(),D=Object(s["c"])(),I=Object(s["c"])(),L=Object(s["c"])(),V=o["f"].create();Object(n["x"])(R,0,1,0),Object(n["k"])(j,t[1],t[0]),Object(n["s"])(j,j),c?(Object(n["g"])(A,t[0],l),Object(n["s"])(w,A)):Object(n["x"])(w,0,0,1),M(j,w,R,R,C,w,b),Object(n["l"])(S,w),Object(n["l"])(I,C);for(let a=0;a<i.length;a++)Object(n["f"])(T,C,i[a][0]),Object(n["f"])(A,w,i[a][2]),Object(n["g"])(T,T,A),Object(n["g"])(T,T,t[0]),u[v++]=T[0],u[v++]=T[1],u[v++]=T[2];p[y++]=-j[0],p[y++]=-j[1],p[y++]=-j[2];for(let a=0;a<r.length;a++)m[O++]=r[a][0]>0?r[a][0]:-r[a][0]-1+i.length,m[O++]=r[a][1]>0?r[a][1]:-r[a][1]-1+i.length,m[O++]=r[a][2]>0?r[a][2]:-r[a][2]-1+i.length,g[_++]=0,g[_++]=0,g[_++]=0;let k=i.length;const F=i.length-1;for(let a=0;a<t.length;a++){let i=!1;a>0&&(Object(n["l"])(x,j),a<t.length-1?(Object(n["k"])(j,t[a+1],t[a]),Object(n["s"])(j,j)):i=!0,Object(n["g"])(E,x,j),Object(n["s"])(E,E),Object(n["g"])(D,t[a-1],S),o["f"].fromPositionAndNormal(t[a],E,V),o["f"].intersectRay(V,o["g"].wrap(D,x),A)?(Object(n["k"])(A,A,t[a]),Object(n["s"])(w,A),Object(n["h"])(C,E,w),Object(n["s"])(C,C)):M(E,S,I,R,C,w,b),Object(n["l"])(S,w),Object(n["l"])(I,C)),c&&(Object(n["g"])(A,t[a],l),Object(n["s"])(L,A));for(let r=0;r<d;r++)if(Object(n["f"])(T,C,e[r][0]),Object(n["f"])(A,w,e[r][1]),Object(n["g"])(T,T,A),Object(n["s"])(P,T),p[y++]=P[0],p[y++]=P[1],p[y++]=P[2],Object(n["g"])(T,T,t[a]),u[v++]=T[0],u[v++]=T[1],u[v++]=T[2],!i){const e=(r+1)%d;m[O++]=k+r,m[O++]=k+d+r,m[O++]=k+e,m[O++]=k+e,m[O++]=k+d+r,m[O++]=k+d+e;for(let t=0;t<6;t++)g[_++]=m[O-6+t]-F}k+=d}const z=t[t.length-1];for(let a=0;a<i.length;a++)Object(n["f"])(T,C,i[a][0]),Object(n["f"])(A,w,i[a][1]),Object(n["g"])(T,T,A),Object(n["g"])(T,T,z),u[v++]=T[0],u[v++]=T[1],u[v++]=T[2];const U=y/3;p[y++]=j[0],p[y++]=j[1],p[y++]=j[2];const G=k-d;for(let a=0;a<r.length;a++)m[O++]=r[a][0]>=0?k+r[a][0]:-r[a][0]-1+G,m[O++]=r[a][2]>=0?k+r[a][2]:-r[a][2]-1+G,m[O++]=r[a][1]>=0?k+r[a][1]:-r[a][1]-1+G,g[_++]=U,g[_++]=U,g[_++]=U;return new h["a"]([["position",{size:3,data:u,exclusive:!0}],["normal",{size:3,data:p,exclusive:!0}]],[["position",m],["normal",g]])}function C(e,t,i){Object(c["a"])(e.length>1,"createPolylineGeometry(): polyline needs at least 2 points"),Object(c["a"])(3===e[0].length,"createPolylineGeometry(): malformed vertex"),Object(c["a"])(null==t||t.length===e.length,"createPolylineGeometry: need same number of points and normals"),Object(c["a"])(null==t||3===t[0].length,"createPolylineGeometry(): malformed normal");const r=new Float64Array(3*e.length),a=new Uint32Array(2*(e.length-1));let n=0,s=0;for(let c=0;c<e.length;c++){for(let t=0;t<3;t++)r[n++]=e[c][t];c>0&&(a[s++]=c-1,a[s++]=c)}const o=[],d=[];if(o.push(["position",a]),d.push(["position",{size:3,data:r,exclusive:!0}]),t){const i=new Float32Array(3*t.length);let r=0;for(let a=0;a<e.length;a++)for(let e=0;e<3;e++)i[r++]=t[a][e];o.push(["normal",a]),d.push(["normal",{size:3,data:i,exclusive:!0}])}return i&&(d.push(["color",{size:4,data:i}]),o.push(["color",Object(l["d"])(i.length/4)])),new h["a"](d,o,2)}function T(e,t,i,r){const a=new Array(18),n=[[-t,0,r/2],[i,0,r/2],[0,e,r/2],[-t,0,-r/2],[i,0,-r/2],[0,e,-r/2]],s=new Uint16Array([0,1,2,3,0,2,2,5,3,1,4,5,5,2,1,1,0,3,3,4,1,4,3,5]);for(let o=0;o<6;o++)a[3*o]=n[o][0],a[3*o+1]=n[o][1],a[3*o+2]=n[o][2];return new h["a"]([["position",{size:3,data:a,exclusive:!0}]],[["position",s]])}function P(e,t){const i=e.getMutableAttribute("position").data;for(let r=0;r<i.length;r+=3){const e=i[r],a=i[r+1],s=i[r+2];Object(n["x"])(g,e,a,s),Object(n["n"])(g,g,t),i[r]=g[0],i[r+1]=g[1],i[r+2]=g[2]}}function A(e,t=e){const i=e.vertexAttributes,r=i.get("position").data,a=i.get("normal").data;if(a){const e=t.getMutableAttribute("normal").data;for(let t=0;t<a.length;t+=3){const i=a[t+1];e[t+1]=-a[t+2],e[t+2]=i}}if(r){const e=t.getMutableAttribute("position").data;for(let t=0;t<r.length;t+=3){const i=r[t+1];e[t+1]=-r[t+2],e[t+2]=i}}return t}function R(e,t,i,r,a){return!(Math.abs(Object(n["i"])(t,e))>a)&&(Object(n["h"])(i,e,t),Object(n["s"])(i,i),Object(n["h"])(r,i,e),Object(n["s"])(r,r),!0)}function M(e,t,i,r,a,n,s){return R(e,t,a,n,s)||R(e,i,a,n,s)||R(e,r,a,n,s)}e.createSquareGeometry=_,e.createConeGeometry=x,e.createCylinderGeometry=j,e.createTubeGeometry=w,e.createPathExtrusionGeometry=S,e.createPolylineGeometry=C,e.createExtrudedTriangle=T,e.transformInPlace=P,e.cgToGIS=A,e.makeOrthoBasisDirUp=R,e.makeOrthoBasisDirUpFallback=M}(m||(m={}));const b=.99619469809,g=Object(s["c"])();var v=m;t["a"]=v},cba1:function(e,t,i){"use strict";i.d(t,"a",(function(){return r})),i.d(t,"b",(function(){return a}));class r{constructor(e){this.xTile=0,this.yTile=0,this.hash=0,this.priority=1,this.colliders=[],this.textVertexRanges=[],this.iconVertexRanges=[],this.tile=e}}class a{constructor(){this.tileSymbols=[],this.parts=[{startTime:0,startOpacity:0,targetOpacity:0,show:!1},{startTime:0,startOpacity:0,targetOpacity:0,show:!1}],this.show=!1}}},ccac:function(e,t,i){"use strict";i.r(t),i.d(t,"createLabelFunction",(function(){return f})),i.d(t,"formatField",(function(){return m}));var r=i("e92d"),a=i("ce50"),n=i("82fa"),s=i("c1da"),o=i("4653"),c=i("21e2"),l=i("80b7"),h=i("7b39");const d=r["a"].getLogger("esri.layers.support.labelFormatUtils"),u={type:"simple",evaluate:()=>null},p={getAttribute:(e,t)=>e.field(t)};async function f(e,t,r){if(!e||!e.symbol)return u;const o=e.where,c=Object(h["b"])(e),f=o?await i.e("chunk-2d0d03a7").then(i.bind(null,"66a2")):null;let b;if("arcade"===c.type){const e=await Object(n["c"])(c.expression,r,t);b={type:"arcade",evaluate(i){try{const t=e.evaluate({$feature:"attributes"in i?e.repurposeFeature(i):e.repurposeAdapter(i)});if(null!=t)return t.toString()}catch(t){d.error(new a["a"]("bad-arcade-expression","Encountered an error when evaluating label expression for feature",{feature:i,expression:c}))}return null},needsHydrationToEvaluate:()=>null==Object(h["e"])(c.expression)}}else b={type:"simple",evaluate:e=>c.expression.replace(/{[^}]*}/g,i=>{const r=i.slice(1,-1),a=Object(s["n"])(t,r);if(!a)return i;let n=null;return"attributes"in e?e&&e.attributes&&(n=e.attributes[a.name]):n=e.field(a.name),null==n?"":m(n,a)})};if(o){let e;try{e=f.WhereClause.create(o,new l["a"](t))}catch(g){return u}const i=b.evaluate;b.evaluate=t=>{const r="attributes"in t?void 0:p;return e.testFeature(t,r)?i(t):null}}return b}function m(e,t){if(null==e)return"";const i=t.domain;if(i)if("codedValue"===i.type||"coded-value"===i.type){const t=e;for(const e of i.codedValues)if(e.code===t)return e.name}else if("range"===i.type){const t=+e,r="range"in i?i.range[0]:i.minValue,a="range"in i?i.range[1]:i.maxValue;if(r<=t&&t<=a)return i.name}let r=e;return"date"===t.type||"esriFieldTypeDate"===t.type?r=Object(o["b"])(r,Object(o["a"])("short-date")):Object(s["r"])(t)&&(r=Object(c["b"])(+r)),r||""}},cd26:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));var r=i("3886"),a=i("e550"),n=i("dea3");function s(e,t){3!==t.pbrMode&&4!==t.pbrMode||e.include(a["a"],t),e.vertex.uniforms.add("overlayTexOffset","vec4"),e.vertex.uniforms.add("overlayTexScale","vec4"),e.varyings.add("vtcOverlay","vec4"),e.vertex.code.add(r["a"]`
    void setOverlayVTC(in vec2 uv) {
      vtcOverlay = vec4(uv, uv) * overlayTexScale + overlayTexOffset;
    }
  `),e.fragment.uniforms.add("ovInnerColorTex","sampler2D"),e.fragment.uniforms.add("ovOuterColorTex","sampler2D"),e.fragment.uniforms.add("overlayOpacity","float"),e.fragment.code.add(r["a"]`
    vec4 getOverlayColor(sampler2D ov0Tex, sampler2D ov1Tex, vec4 texCoords) {
      // read textures outside of conditions, to avoid artifacts likely related to non-uniform flow control:
      // - https://www.khronos.org/opengl/wiki/Sampler_(GLSL)#Non-uniform_flow_control
      // - https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/13657
      vec4 color0 = texture2D(ov0Tex, texCoords.xy);
      vec4 color1 = texture2D(ov1Tex, texCoords.zw);

      float valid0 = float((texCoords.x >= 0.0) && (texCoords.x <= 1.0) && (texCoords.y >= 0.0) && (texCoords.y <= 1.0));
      float valid1 = float((texCoords.z >= 0.0) && (texCoords.z <= 1.0) && (texCoords.w >= 0.0) && (texCoords.w <= 1.0));

      // Pick color0 if valid, otherwise color1 if valid, otherwise vec4(0)
      return mix(color1 * valid1, color0, valid0);
    }
  `),e.fragment.code.add(r["a"]`
    vec4 getCombinedOverlayColor() {
      return overlayOpacity * getOverlayColor(ovInnerColorTex, ovOuterColorTex, vtcOverlay);
    }
  `),3!==t.pbrMode&&4!==t.pbrMode||(e.include(n["a"]),e.fragment.code.add(r["a"]`
    vec4 getOverlayWaterColor(vec4 maskInput, vec4 colorInput, vec3 vposEyeDir,
       float shadow, vec3 localUp, mat3 tbn, vec3 position) {

      // reproject normal from 0...1 => -1...1
      // and project it to worldspace.
      vec3 n = normalize(tbn *  (2.0 * maskInput.rgb - vec3(1.0)));
      vec3 v = vposEyeDir;
      vec3 l = normalize(-lightingMainDirection);
      vec3 final = getSeaColor(n, v, l, colorInput.rgb, lightingMainIntensity, localUp, 1.0 - shadow, maskInput.w, position);

      // the terrain renderer assumes a premultiplied color output without gamma.
      return vec4(final, colorInput.w);
    }
    `))}},cdc1:function(e,t,i){"use strict";i.d(t,"a",(function(){return o})),i.d(t,"b",(function(){return h})),i.d(t,"c",(function(){return l})),i.d(t,"d",(function(){return s})),i.d(t,"e",(function(){return c}));var r=i("32ed"),a=i("28b1"),n=i("9180");function s(e,t,i,a){if(null==a||e.hasZ||(a=void 0),"point"===e.type)return e.x+=t,e.y+=i,e.hasZ&&null!=a&&(e.z+=a),e;if("multipoint"===e.type){const r=e.points;for(let e=0;e<r.length;e++)r[e]=d(r[e],t,i,a);return e}if("extent"===e.type)return e.xmin+=t,e.xmax+=t,e.ymin+=i,e.ymax+=i,null!=a&&(e.zmin+=a,e.zmax+=a),e;const n=Object(r["b"])(e),s="polyline"===e.type?e.paths:e.rings;for(let r=0;r<n.length;r++){const e=n[r];for(let r=0;r<e.length;r++)e[r]=d(e[r],t,i,a)}return"paths"in e?e.paths=s:e.rings=s,e}function o(e,t,i,a,n){const o=e.clone(),c=a.resolution;if("point"===o.type){if(n)s(o,t*c,-i*c);else{const e=a.state.transform,r=a.state.inverseTransform,n=e[0]*o.x+e[2]*o.y+e[4],s=e[1]*o.x+e[3]*o.y+e[5];o.x=r[0]*(n+t)+r[2]*(s+i)+r[4],o.y=r[1]*(n+t)+r[3]*(s+i)+r[5]}return o}if("multipoint"===o.type){if(n)s(o,t*c,-i*c);else{const e=o.points,r=a.state.transform,n=a.state.inverseTransform;for(let a=0;a<e.length;a++){const s=e[a],o=r[0]*s[0]+r[2]*s[1]+r[4],c=r[1]*s[0]+r[3]*s[1]+r[5],l=n[0]*(o+t)+n[2]*(c+i)+n[4],h=n[1]*(o+t)+n[3]*(c+i)+n[5];e[a]=u(s,l,h,void 0)}}return o}if("extent"===o.type){if(n)s(o,t*c,-i*c);else{const e=a.state.transform,r=a.state.inverseTransform,n=e[0]*o.xmin+e[2]*o.ymin+e[4],s=e[1]*o.xmin+e[3]*o.ymin+e[5],c=e[0]*o.xmax+e[2]*o.ymax+e[4],l=e[1]*o.xmax+e[3]*o.ymax+e[5];o.xmin=r[0]*(n+t)+r[2]*(s+i)+r[4],o.ymin=r[1]*(n+t)+r[3]*(s+i)+r[5],o.xmax=r[0]*(c+t)+r[2]*(l+i)+r[4],o.ymax=r[1]*(c+t)+r[3]*(l+i)+r[5]}return o}if(n)s(o,t*c,-i*c);else{const e=Object(r["b"])(o),n="polyline"===o.type?o.paths:o.rings,s=a.state.transform,c=a.state.inverseTransform;for(let r=0;r<e.length;r++){const a=e[r];for(let e=0;e<a.length;e++){const r=a[e],n=s[0]*r[0]+s[2]*r[1]+s[4],o=s[1]*r[0]+s[3]*r[1]+s[5],l=c[0]*(n+t)+c[2]*(o+i)+c[4],h=c[1]*(n+t)+c[3]*(o+i)+c[5];a[e]=u(r,l,h,void 0)}}"paths"in o?o.paths=n:o.rings=n}return o}function c(e,t,i,s){if("point"===e.type){const{x:r,y:a}=e,n=s?s[0]:r,o=s?s[1]:a,c=e.clone(),l=(r-n)*t+n,h=(a-o)*i+o;return c.x=l,c.y=h,c}if("multipoint"===e.type){const o=Object(r["b"])(e),c=Object(n["l"])(),[l,h,d,p]=Object(a["d"])(c,[o]),f=s?s[0]:(l+d)/2,m=s?s[1]:(p+h)/2,b=e.clone(),g=b.points;for(let e=0;e<g.length;e++){const r=g[e],[a,n]=r,s=(a-f)*t+f,o=(n-m)*i+m;g[e]=u(r,s,o,void 0)}return b}if("extent"===e.type){const{xmin:r,xmax:a,ymin:n,ymax:o}=e,c=s?s[0]:(r+a)/2,l=s?s[1]:(o+n)/2,h=e.clone();if(h.xmin=(r-c)*t+c,h.ymax=(o-l)*i+l,h.xmax=(a-c)*t+c,h.ymin=(n-l)*i+l,h.xmin>h.xmax){const e=h.xmin,t=h.xmax;h.xmin=t,h.xmax=e}if(h.ymin>h.ymax){const e=h.ymin,t=h.ymax;h.ymin=t,h.ymax=e}return h}const o=Object(r["b"])(e),c=Object(n["l"])(),[l,h,d,p]=Object(a["d"])(c,o),f=s?s[0]:(l+d)/2,m=s?s[1]:(p+h)/2,b=e.clone(),g="polyline"===b.type?b.paths:b.rings;for(let r=0;r<o.length;r++){const e=o[r];for(let a=0;a<e.length;a++){const n=e[a],[s,o]=n,c=(s-f)*t+f,l=(o-m)*i+m;g[r][a]=u(n,c,l,void 0)}}return"paths"in b?b.paths=g:b.rings=g,b}function l(e,t,i,r,a,n){const s=Math.sqrt((i-e)*(i-e)+(r-t)*(r-t));return Math.sqrt((a-e)*(a-e)+(n-t)*(n-t))/s}function h(e,t,i,r,a,n){const s=180*Math.atan2(t-r,e-i)/Math.PI;return 180*Math.atan2(t-n,e-a)/Math.PI-s}function d(e,t,i,r){return u(e,e[0]+t,e[1]+i,null!=e[2]&&null!=r?e[2]+r:void 0)}function u(e,t,i,r){const a=[t,i];return e.length>2&&a.push(null!=r?r:e[2]),e.length>3&&a.push(e[3]),a}},ce0b:function(e,t,i){"use strict";var r=i("a4ee"),a=(i("c120"),i("e92d"),i("cea0"),i("59b2")),n=i("d386"),s=(i("e041"),i("8eed"),i("f402"),i("a6a3")),o=i("fd14"),c=i("997b"),l=i("5a62"),h=i("f626");let d=class extends(Object(c["a"])(Object(l["a"])(s["a"]))){constructor(e){super(e),this.elevationInfo=null,this.graphics=new h["b"],this.screenSizePerspectiveEnabled=!0,this.type="graphics",this.internal=!1}destroy(){this.removeAll(),this.graphics.destroy()}add(e){return this.graphics.add(e),this}addMany(e){return this.graphics.addMany(e),this}removeAll(){return this.graphics.removeAll(),this}remove(e){this.graphics.remove(e)}removeMany(e){this.graphics.removeMany(e)}on(e,t){return super.on(e,t)}graphicChanged(e){this.emit("graphic-update",e)}};Object(r["a"])([Object(a["b"])({type:o["a"]})],d.prototype,"elevationInfo",void 0),Object(r["a"])([Object(a["b"])(Object(h["c"])())],d.prototype,"graphics",void 0),Object(r["a"])([Object(a["b"])({type:["show","hide"]})],d.prototype,"listMode",void 0),Object(r["a"])([Object(a["b"])()],d.prototype,"screenSizePerspectiveEnabled",void 0),Object(r["a"])([Object(a["b"])({readOnly:!0})],d.prototype,"type",void 0),Object(r["a"])([Object(a["b"])({constructOnly:!0})],d.prototype,"internal",void 0),d=Object(r["a"])([Object(n["a"])("esri.layers.GraphicsLayer")],d);var u=d;t["a"]=u},ce99:function(e,t,i){"use strict";i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return n}));var r=i("3886"),a=i("690a");function n(e){const t=new a["a"],i=t.vertex.code,n=t.fragment.code;return t.attributes.add("position","vec2"),2===e.highlightStage&&(i.add(r["a"]`
    void main() {
      gl_Position = vec4(vec2(1.0) - position * 2.0, 0.0, 1.0);
    }`),t.fragment.uniforms.add("tex","sampler2D"),t.fragment.uniforms.add("invFramebufferDim","vec2"),n.add(r["a"]`
      void main() {
        vec2 coord = gl_FragCoord.xy * invFramebufferDim;
        vec4 value = texture2D(tex, coord);
        float mx = floor(max(value.g, value.b));
        gl_FragColor = vec4(ceil(value.r), mx, mx, 1.0);
      }`)),0===e.highlightStage&&(t.attributes.add("uv0","vec2"),e.gridOptimization?(t.vertex.uniforms.add("coverageTex","sampler2D"),t.fragment.uniforms.add("blurSize","vec2"),t.varyings.add("blurCoordinate","vec3")):(t.vertex.uniforms.add("blurSize","vec2"),t.varyings.add("blurCoordinates[5]","vec2")),i.add(r["a"]`
    void main() {
      gl_Position = vec4(position, 0.0, 1.0);
      ${e.gridOptimization?r["a"]`
      vec4 cov = texture2D(coverageTex, uv0);
      if (cov.r == 0.0) {
        gl_Position = vec4(0.0);
      }
      blurCoordinate = vec3(gl_Position.xy * 0.5 + vec2(0.5), max(cov.g, cov.b));
      `:r["a"]`
      vec2 uv = position.xy * 0.5 + vec2(0.5);
      blurCoordinates[0] = uv;
      blurCoordinates[1] = uv + blurSize * 1.407333;
      blurCoordinates[2] = uv - blurSize * 1.407333;
      blurCoordinates[3] = uv + blurSize * 3.294215;
      blurCoordinates[4] = uv - blurSize * 3.294215;
          `}
    }`),t.fragment.uniforms.add("tex","sampler2D"),n.add(r["a"]`
    void main() {
      ${e.gridOptimization?r["a"]`
          vec2 uv = blurCoordinate.xy;
          vec4 center = texture2D(tex, uv);

          // do not blur if no pixel or all pixels in neighborhood are set
          if (blurCoordinate.z == 1.0) {
            gl_FragColor = center;
          } else {
            vec4 sum = vec4(0.0);
            sum += center * 0.204164;
            sum += texture2D(tex, uv + blurSize * 1.407333) * 0.304005;
            sum += texture2D(tex, uv - blurSize * 1.407333) * 0.304005;
            sum += texture2D(tex, uv + blurSize * 3.294215) * 0.093913;
            sum += texture2D(tex, uv - blurSize * 3.294215) * 0.093913;
            gl_FragColor = sum;
          }`:r["a"]`
          vec4 sum = vec4(0.0);
          sum += texture2D(tex, blurCoordinates[0]) * 0.204164;
          sum += texture2D(tex, blurCoordinates[1]) * 0.304005;
          sum += texture2D(tex, blurCoordinates[2]) * 0.304005;
          sum += texture2D(tex, blurCoordinates[3]) * 0.093913;
          sum += texture2D(tex, blurCoordinates[4]) * 0.093913;
          gl_FragColor = sum;`}
    }`)),1===e.highlightStage&&(t.varyings.add("uv","vec2"),e.gridOptimization&&(t.attributes.add("uv0","vec2"),t.vertex.uniforms.add("coverageTex","sampler2D")),i.add(r["a"]`
      void main() {
        ${e.gridOptimization?r["a"]`
            vec4 cov = texture2D(coverageTex, uv0);
            // if no highlight pixel set in this block, hide block
            if (cov.r == 0.0) {
              gl_Position = vec4(0.0);
              return;
            }`:""}
        gl_Position = vec4(position, 0.0, 1.0);
        uv = position.xy * 0.5 + vec2(0.5);
      }`),t.fragment.uniforms.add("tex","sampler2D"),t.fragment.uniforms.add("origin","sampler2D"),t.fragment.uniforms.add("color","vec4"),t.fragment.uniforms.add("haloColor","vec4"),t.fragment.uniforms.add("outlineSize","float"),t.fragment.uniforms.add("blurSize","float"),t.fragment.uniforms.add("opacities","vec4"),n.add(r["a"]`
      void main() {
        // Read the highlight intensity from the blurred highlight image
        vec4 blurredHighlightValue = texture2D(tex, uv);
        float highlightIntensity = blurredHighlightValue.a;

        // Discard all pixels which are not affected by highlight
        if (highlightIntensity == 0.0) {
          discard;
        }

        vec4 origin_color = texture2D(origin, uv);

        float outlineIntensity;
        float fillIntensity;

        // if occluded
        if (blurredHighlightValue.g > blurredHighlightValue.b) {
          outlineIntensity = haloColor.w * opacities[1];
          fillIntensity = color.w * opacities[3];
        }
        // if unoccluded
        else {
          outlineIntensity = haloColor.w * opacities[0];
          fillIntensity = color.w * opacities[2];
        }

        float inner = 1.0 - outlineSize / 9.0;
        float outer = 1.0 - (outlineSize + blurSize) / 9.0;

        float outlineFactor = smoothstep(outer, inner, highlightIntensity);
        //float fillFactor = smoothstep(0.6, 0.72, highlightIntensity);
        float fillFactor = any(notEqual(origin_color, vec4(0.0, 0.0, 0.0, 0.0))) ? 1.0 : 0.0;
        float intensity = outlineIntensity * outlineFactor * (1.0 - fillFactor) + fillIntensity * fillFactor;

        // Blending equation: gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
        // I.e., color should not be premultiplied with alpha
        gl_FragColor = vec4(mix(haloColor.rgb, color.rgb, fillFactor), intensity);
      }`)),t}var s=Object.freeze({__proto__:null,build:n})},cee3:function(e,t,i){"use strict";i.d(t,"a",(function(){return Oe})),i.d(t,"b",(function(){return xe})),i.d(t,"c",(function(){return we})),i.d(t,"d",(function(){return Ee})),i.d(t,"e",(function(){return _e})),i.d(t,"f",(function(){return Re})),i.d(t,"g",(function(){return Se})),i.d(t,"h",(function(){return Ae})),i.d(t,"i",(function(){return Pe})),i.d(t,"j",(function(){return Te})),i.d(t,"k",(function(){return Me})),i.d(t,"l",(function(){return je})),i.d(t,"m",(function(){return Ce}));var r=i("0b2d"),a=i("e431"),n=i("dae5"),s=i("b139"),o=i("0fc4"),c=i("1c92"),l=(i("7577"),i("04f0")),h=i("4261"),d=i("47f8"),u=i("d0ac"),p=i("e764");const f=1e-6,m=[0,0,0],b=[0,0,0];function g(e,t){const{data:i,size:r}=e,a=i.length/r;if(a<=0)return;const n=new re(e);se(m,n.minProj,n.maxProj),ce(m,m,.5),oe(b,n.maxProj,n.minProj);const s=ne(b),o=new ae;o.quality=s,a<14&&(e={data:new Float64Array(n.buffer,112,42),size:3});const c=[0,0,0],l=[0,0,0],h=[0,0,0],d=[0,0,0],u=[0,0,0],p=[0,0,0],f=[0,0,0];switch(v(n,e,f,c,l,h,d,u,p,o)){case 1:return void H(m,b,t);case 2:return void X(e,d,t)}T(e,f,c,l,h,d,u,p,o),Y(e,o.b0,o.b1,o.b2,Z,$);const g=[0,0,0];oe(g,$,Z),o.quality=ne(g),o.quality<s?te(o.b0,o.b1,o.b2,Z,$,g,t):H(m,b,t)}function v(e,t,i,r,a,n,s,o,c,l){return P(e,r,a),pe(r,a)<f?1:(oe(s,r,a),de(s,s),R(t,r,s,n)<f?2:(oe(o,a,n),de(o,o),oe(c,n,r),de(c,c),he(i,o,s),de(i,i),z(t,i,s,o,c,l),0))}const y=[0,0,0],O=[0,0,0],_=[0,0,0],x=[0,0,0],j=[0,0,0],w=[0,0,0],S=[0,0,0],C=[0,0,0];function T(e,t,i,r,a,n,s,o,c){E(e,t,i,y,O),void 0!==y[0]&&(oe(_,y,i),de(_,_),oe(x,y,r),de(x,x),oe(j,y,a),de(j,j),he(w,x,n),de(w,w),he(S,j,s),de(S,S),he(C,_,o),de(C,C),z(e,w,n,x,_,c),z(e,S,s,j,x,c),z(e,C,o,_,j,c)),void 0!==O[0]&&(oe(_,O,i),de(_,_),oe(x,O,r),de(x,x),oe(j,O,a),de(j,j),he(w,x,n),de(w,w),he(S,j,s),de(S,S),he(C,_,o),de(C,C),z(e,w,n,x,_,c),z(e,S,s,j,x,c),z(e,C,o,_,j,c))}function P(e,t,i){let r=pe(e.maxVert[0],e.minVert[0]),a=0;for(let n=1;n<7;++n){const t=pe(e.maxVert[n],e.minVert[n]);t>r&&(r=t,a=n)}le(t,e.minVert[a]),le(i,e.maxVert[a])}const A=[0,0,0];function R(e,t,i,r){const{data:a,size:n}=e;let s=Number.NEGATIVE_INFINITY,o=0;for(let c=0;c<a.length;c+=n){A[0]=a[c]-t[0],A[1]=a[c+1]-t[1],A[2]=a[c+2]-t[2];const e=i[0]*A[0]+i[1]*A[1]+i[2]*A[2],r=i[0]*i[0]+i[1]*i[1]+i[2]*i[2],n=A[0]*A[0]+A[1]*A[1]+A[2]*A[2]-e*e/r;n>s&&(s=n,o=c)}return le(r,a,o),s}const M=[0,0];function E(e,t,i,r,a){B(e,t,M,a,r);const n=fe(i,t);M[1]-f<=n&&(r[0]=void 0),M[0]+f>=n&&(a[0]=void 0)}const D=[0,0,0],I=[0,0,0],L=[0,0,0],V=[0,0,0],k=[0,0,0],F=[0,0,0];function z(e,t,i,r,a,n){if(ue(t)<f)return;he(D,i,t),he(I,r,t),he(L,a,t),G(e,t,M),k[1]=M[0],V[1]=M[1],F[1]=V[1]-k[1];const s=[i,r,a],o=[D,I,L];for(let c=0;c<3;++c){G(e,s[c],M),k[0]=M[0],V[0]=M[1],G(e,o[c],M),k[2]=M[0],V[2]=M[1],F[0]=V[0]-k[0],F[2]=V[2]-k[2];const i=ne(F);i<n.quality&&(le(n.b0,s[c]),le(n.b1,t),le(n.b2,o[c]),n.quality=i)}}const U=[0,0,0];function G(e,t,i){const{data:r,size:a}=e;i[0]=Number.POSITIVE_INFINITY,i[1]=Number.NEGATIVE_INFINITY;for(let n=0;n<r.length;n+=a){const e=r[n]*t[0]+r[n+1]*t[1]+r[n+2]*t[2];i[0]=Math.min(i[0],e),i[1]=Math.max(i[1],e)}}function B(e,t,i,r,a){const{data:n,size:s}=e;le(r,n),le(a,r),i[0]=fe(U,t),i[1]=i[0];for(let o=s;o<n.length;o+=s){const e=n[o]*t[0]+n[o+1]*t[1]+n[o+2]*t[2];e<i[0]&&(i[0]=e,le(r,n,o)),e>i[1]&&(i[1]=e,le(a,n,o))}}function H(e,t,i){le(i.center,e),ce(i.halfSize,t,.5),i.quaternion[0]=0,i.quaternion[1]=0,i.quaternion[2]=0,i.quaternion[3]=1}const N=[0,0,0],q=[0,0,0],W=[0,0,0],Z=[0,0,0],$=[0,0,0],Q=[0,0,0];function X(e,t,i){le(N,t),Math.abs(t[0])>Math.abs(t[1])&&Math.abs(t[0])>Math.abs(t[2])?N[0]=0:Math.abs(t[1])>Math.abs(t[2])?N[1]=0:N[2]=0,ue(N)<f&&(N[0]=N[1]=N[2]=1),he(q,t,N),de(q,q),he(W,t,q),de(W,W),Y(e,t,q,W,Z,$),oe(Q,$,Z),te(t,q,W,Z,$,Q,i)}function Y(e,t,i,r,a,n){G(e,t,M),a[0]=M[0],n[0]=M[1],G(e,i,M),a[1]=M[0],n[1]=M[1],G(e,r,M),a[2]=M[0],n[2]=M[1]}const K=[0,0,0],J=[1,0,0,0,1,0,0,0,1],ee=[0,0,0];function te(e,t,i,r,a,n,s){J[0]=e[0],J[1]=e[1],J[2]=e[2],J[3]=t[0],J[4]=t[1],J[5]=t[2],J[6]=i[0],J[7]=i[1],J[8]=i[2],me(s.quaternion,J),se(ee,r,a),ce(ee,ee,.5),ce(s.center,e,ee[0]),ce(K,t,ee[1]),se(s.center,s.center,K),ce(K,i,ee[2]),se(s.center,s.center,K),ce(s.halfSize,n,.5)}const ie=7;class re{constructor(e){this.minVert=new Array(ie),this.maxVert=new Array(ie);const t=64*ie;this.buffer=new ArrayBuffer(t);let i=0;this.minProj=new Float64Array(this.buffer,i,ie),i+=8*ie,this.maxProj=new Float64Array(this.buffer,i,ie),i+=8*ie;for(let o=0;o<ie;++o)this.minVert[o]=new Float64Array(this.buffer,i,3),i+=24;for(let o=0;o<ie;++o)this.maxVert[o]=new Float64Array(this.buffer,i,3),i+=24;for(let o=0;o<ie;++o)this.minProj[o]=Number.POSITIVE_INFINITY,this.maxProj[o]=Number.NEGATIVE_INFINITY;const r=new Array(ie),a=new Array(ie),{data:n,size:s}=e;for(let o=0;o<n.length;o+=s){let e=n[o];e<this.minProj[0]&&(this.minProj[0]=e,r[0]=o),e>this.maxProj[0]&&(this.maxProj[0]=e,a[0]=o),e=n[o+1],e<this.minProj[1]&&(this.minProj[1]=e,r[1]=o),e>this.maxProj[1]&&(this.maxProj[1]=e,a[1]=o),e=n[o+2],e<this.minProj[2]&&(this.minProj[2]=e,r[2]=o),e>this.maxProj[2]&&(this.maxProj[2]=e,a[2]=o),e=n[o]+n[o+1]+n[o+2],e<this.minProj[3]&&(this.minProj[3]=e,r[3]=o),e>this.maxProj[3]&&(this.maxProj[3]=e,a[3]=o),e=n[o]+n[o+1]-n[o+2],e<this.minProj[4]&&(this.minProj[4]=e,r[4]=o),e>this.maxProj[4]&&(this.maxProj[4]=e,a[4]=o),e=n[o]-n[o+1]+n[o+2],e<this.minProj[5]&&(this.minProj[5]=e,r[5]=o),e>this.maxProj[5]&&(this.maxProj[5]=e,a[5]=o),e=n[o]-n[o+1]-n[o+2],e<this.minProj[6]&&(this.minProj[6]=e,r[6]=o),e>this.maxProj[6]&&(this.maxProj[6]=e,a[6]=o)}for(let o=0;o<ie;++o){let e=r[o];le(this.minVert[o],n,e),e=a[o],le(this.maxVert[o],n,e)}}}class ae{constructor(){this.b0=[1,0,0],this.b1=[0,1,0],this.b2=[0,0,1],this.quality=0}}function ne(e){return e[0]*e[1]+e[0]*e[2]+e[1]*e[2]}function se(e,t,i){e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2]}function oe(e,t,i){e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2]}function ce(e,t,i){e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i}function le(e,t,i=0){e[0]=t[i+0],e[1]=t[i+1],e[2]=t[i+2]}function he(e,t,i){const r=t[0],a=t[1],n=t[2],s=i[0],o=i[1],c=i[2];e[0]=a*c-n*o,e[1]=n*s-r*c,e[2]=r*o-a*s}function de(e,t){const i=t[0]*t[0]+t[1]*t[1]+t[2]*t[2];if(i>0){const r=1/Math.sqrt(i);e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r}}function ue(e){return e[0]*e[0]+e[1]*e[1]+e[2]*e[2]}function pe(e,t){const i=t[0]-e[0],r=t[1]-e[1],a=t[2]-e[2];return i*i+r*r+a*a}function fe(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function me(e,t){const i=t[0]+t[4]+t[8];if(i>0){let r=Math.sqrt(i+1);e[3]=.5*r,r=.5/r,e[0]=(t[5]-t[7])*r,e[1]=(t[6]-t[2])*r,e[2]=(t[1]-t[3])*r}else{let i=0;t[4]>t[0]&&(i=1),t[8]>t[3*i+i]&&(i=2);const r=(i+1)%3,a=(i+2)%3;let n=Math.sqrt(t[3*i+i]-t[3*r+r]-t[3*a+a]+1);e[i]=.5*n,n=.5/n,e[3]=(t[3*r+a]-t[3*a+r])*n,e[r]=(t[3*r+i]+t[3*i+r])*n,e[a]=(t[3*a+i]+t[3*i+a])*n}}const be=Object(s["a"])(),ge=Object(r["e"])(),ve=Object(r["e"])(),ye=(Object(o["c"])(),Object(n["a"])());class Oe{constructor(e){const t=56,i=0,a=24,n=36,s=e*t;this.buffer=new ArrayBuffer(s),this.obbs=new Array(e);for(let o=0;o<e;o++)this.obbs[o]={center:Object(r["c"])(this.buffer,t*o+i),halfSize:Object(d["b"])(this.buffer,t*o+a),quaternion:Object(p["c"])(this.buffer,t*o+n)}}}function _e(e=[0,0,0],t=[-1,-1,-1],i=[0,0,0,1]){return{center:Object(r["d"])(e),halfSize:Object(d["a"])(t),quaternion:Object(p["a"])(i)}}function xe(e){return _e(e.center,e.halfSize,e.quaternion)}function je(e,t){Object(a["l"])(t.center,e.center),Object(a["l"])(t.halfSize,e.halfSize),Object(l["a"])(t.quaternion,e.quaternion)}function we(e,t){return t=t||_e(),g(e,t),t}function Se(e,t){const i=u["f"].signedDistance(t,e.center),r=Me(e,u["f"].normal(t));return i>r?1:i<-r?-1:0}function Ce(e,t){t||(t=Object(h["h"])());const i=Object(c["g"])(ye,e.quaternion),r=e.halfSize[0]*Math.abs(i[0])+e.halfSize[1]*Math.abs(i[3])+e.halfSize[2]*Math.abs(i[6]),a=e.halfSize[0]*Math.abs(i[1])+e.halfSize[1]*Math.abs(i[4])+e.halfSize[2]*Math.abs(i[7]),n=e.halfSize[0]*Math.abs(i[2])+e.halfSize[1]*Math.abs(i[5])+e.halfSize[2]*Math.abs(i[8]);return t[0]=e.center[0]-r,t[1]=e.center[1]-a,t[2]=e.center[2]-n,t[3]=e.center[0]+r,t[4]=e.center[1]+a,t[5]=e.center[2]+n,t}function Te(e,t){return u["f"].signedDistance(t,e.center)-Me(e,u["f"].normal(t))}function Pe(e,t){return u["f"].signedDistance(t,e.center)+Me(e,u["f"].normal(t))}function Ae(e,t){return Se(e,t[0])<=0&&Se(e,t[1])<=0&&Se(e,t[2])<=0&&Se(e,t[3])<=0&&Se(e,t[4])<=0&&Se(e,t[5])<=0}function Re(e,t,i,r=0){Object(l["b"])(be,e.quaternion),Object(a["k"])(ge,t,e.center);const n=Object(a["v"])(ge,ge,be),s=Object(a["v"])(ve,i,be);let o=-1/0,c=1/0;for(let a=0;a<3;a++)if(Math.abs(s[a])>1e-6){const t=(r+e.halfSize[a]-n[a])/s[a],i=(-r-e.halfSize[a]-n[a])/s[a];o=Math.max(o,Math.min(t,i)),c=Math.min(c,Math.max(t,i))}else if(n[a]>e.halfSize[a]+r||n[a]<-e.halfSize[a]-r)return!1;return o<=c}(()=>{const e=new Int8Array(162);let t=0;const i=i=>{for(let r=0;r<i.length;r++)e[t+r]=i[r];t+=6};i([6,2,3,1,5,4]),i([0,2,3,1,5,4]),i([0,2,3,7,5,4]),i([0,1,3,2,6,4]),i([0,1,3,2,0,0]),i([0,1,5,7,3,2]),i([0,1,3,7,6,4]),i([0,1,3,7,6,2]),i([0,1,5,7,6,2]),i([0,1,5,4,6,2]),i([0,1,5,4,0,0]),i([0,1,3,7,5,4]),i([0,2,6,4,0,0]),i([0,0,0,0,0,0]),i([1,3,7,5,0,0]),i([2,3,7,6,4,0]),i([2,3,7,6,0,0]),i([2,3,1,5,7,6]),i([0,1,5,7,6,2]),i([0,1,5,7,6,4]),i([0,1,3,7,6,4]),i([4,5,7,6,2,0]),i([4,5,7,6,0,0]),i([4,5,1,3,7,6]),i([0,2,3,7,5,4]),i([6,2,3,7,5,4]),i([6,2,3,1,5,4])})();function Me(e,t){Object(l["b"])(be,e.quaternion),Object(a["v"])(ge,t,be);const i=e.halfSize;return Math.abs(ge[0]*i[0])+Math.abs(ge[1]*i[1])+Math.abs(ge[2]*i[2])}function Ee(e,t){for(let i=0;i<8;++i){const r=t[i];r[0]=1&i?-e.halfSize[0]:e.halfSize[0],r[1]=2&i?-e.halfSize[1]:e.halfSize[1],r[2]=4&i?-e.halfSize[2]:e.halfSize[2],Object(a["v"])(r,r,e.quaternion),Object(a["g"])(r,r,e.center)}}},d017:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i("3886"),a=i("501b");function n(e){e.fragment.include(a["a"]),e.fragment.uniforms.add("uShadowMapTex","sampler2D"),e.fragment.uniforms.add("uShadowMapNum","int"),e.fragment.uniforms.add("uShadowMapDistance","vec4"),e.fragment.uniforms.add("uShadowMapMatrix","mat4",4),e.fragment.uniforms.add("uDepthHalfPixelSz","float"),e.fragment.code.add(r["a"]`
    int chooseCascade(float _linearDepth, out mat4 mat) {
      vec4 distance = uShadowMapDistance;
      float depth = _linearDepth;

      //choose correct cascade
      int i = depth < distance[1] ? 0 : depth < distance[2] ? 1 : depth < distance[3] ? 2 : 3;

      mat = i == 0 ? uShadowMapMatrix[0] : i == 1 ? uShadowMapMatrix[1] : i == 2 ? uShadowMapMatrix[2] : uShadowMapMatrix[3];

      return i;
    }

    vec3 lightSpacePosition(vec3 _vpos, mat4 mat) {
      vec4 lv = mat * vec4(_vpos, 1.0);
      lv.xy /= lv.w;
      return 0.5 * lv.xyz + vec3(0.5);
    }

    vec2 cascadeCoordinates(int i, vec3 lvpos) {
      return vec2(float(i - 2 * (i / 2)) * 0.5, float(i / 2) * 0.5) + 0.5 * lvpos.xy;
    }

    float readShadowMapDepth(vec2 uv, sampler2D _depthTex) {
      return rgba2float(texture2D(_depthTex, uv));
    }

    float posIsInShadow(vec2 uv, vec3 lvpos, sampler2D _depthTex) {
      return readShadowMapDepth(uv, _depthTex) < lvpos.z ? 1.0 : 0.0;
    }

    float filterShadow(vec2 uv, vec3 lvpos, float halfPixelSize, sampler2D _depthTex) {
      float texSize = 0.5 / halfPixelSize;

      // filter, offset by half pixels
      vec2 st = fract((vec2(halfPixelSize) + uv) * texSize);

      float s00 = posIsInShadow(uv + vec2(-halfPixelSize, -halfPixelSize), lvpos, _depthTex);
      float s10 = posIsInShadow(uv + vec2(halfPixelSize, -halfPixelSize), lvpos, _depthTex);
      float s11 = posIsInShadow(uv + vec2(halfPixelSize, halfPixelSize), lvpos, _depthTex);
      float s01 = posIsInShadow(uv + vec2(-halfPixelSize, halfPixelSize), lvpos, _depthTex);

      return mix(mix(s00, s10, st.x), mix(s01, s11, st.x), st.y);
    }

    float readShadowMap(const in vec3 _vpos, float _linearDepth) {
      mat4 mat;
      int i = chooseCascade(_linearDepth, mat);

      if (i >= uShadowMapNum) { return 0.0; }

      vec3 lvpos = lightSpacePosition(_vpos, mat);

      // vertex completely outside? -> no shadow
      if (lvpos.z >= 1.0) { return 0.0; }
      if (lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) { return 0.0; }

      // calc coord in cascade texture
      vec2 uv = cascadeCoordinates(i, lvpos);

      return filterShadow(uv, lvpos, uDepthHalfPixelSz, uShadowMapTex);
    }
  `)}!function(e){function t(e,t,i){t.shadowMappingEnabled&&(t.shadowMap.bind(e,i),t.shadowMap.bindView(e,t.origin))}function i(e,t,i){t.shadowMappingEnabled&&t.shadowMap.bindView(e,i)}function r(e,t){t.shadowMappingEnabled&&t.shadowMap.bindView(e,t.origin)}e.bindUniforms=t,e.bindViewCustomOrigin=i,e.bindView=r}(n||(n={}))},d0cb:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i("3886"),a=i("2f98");function n(e,t){const i=e;i.include(a["a"]),i.attributes.add("position","vec3"),i.attributes.add("normal","vec3"),i.attributes.add("auxpos1","vec4"),i.vertex.uniforms.add("proj","mat4"),i.vertex.uniforms.add("view","mat4"),i.vertex.uniforms.add("viewNormal","mat4"),i.vertex.uniforms.add("viewport","vec4"),i.vertex.uniforms.add("camPos","vec3"),i.vertex.uniforms.add("polygonOffset","float"),i.vertex.uniforms.add("cameraGroundRelative","float"),i.vertex.uniforms.add("pixelRatio","float"),i.vertex.uniforms.add("perDistancePixelRatio","float"),i.vertex.uniforms.add("uRenderTransparentlyOccludedHUD","float"),t.verticalOffsetEnabled&&i.vertex.uniforms.add("verticalOffset","vec4"),t.screenSizePerspectiveEnabled&&i.vertex.uniforms.add("screenSizePerspectiveAlignment","vec4"),i.vertex.uniforms.add("hudVisibilityTexture","sampler2D"),i.vertex.constants.add("smallOffsetAngle","float",.984807753012208),i.vertex.code.add(r["a"]`
    struct ProjectHUDAux {
      vec3 posModel;
      vec3 posView;
      vec3 vnormal;

      float distanceToCamera;
      float absCosAngle;
    };
  `),i.vertex.code.add(r["a"]`
    float applyHUDViewDependentPolygonOffset(float pointGroundDistance, float absCosAngle, inout vec3 posView) {
      float pointGroundSign = sign(pointGroundDistance);

      if (pointGroundSign == 0.0) {
        pointGroundSign = cameraGroundRelative;
      }

      // cameraGroundRelative is -1 if camera is below ground, 1 if above ground
      // groundRelative is 1 if both camera and symbol are on the same side of the ground, -1 otherwise
      float groundRelative = cameraGroundRelative * pointGroundSign;

      // view angle dependent part of polygon offset emulation
      // we take the absolute value because the sign that is dropped is
      // instead introduced using the ground-relative position of the symbol and the camera
      if (polygonOffset > .0) {
        float cosAlpha = clamp(absCosAngle, 0.01, 1.0);

        float tanAlpha = sqrt(1.0 - cosAlpha * cosAlpha) / cosAlpha;
        float factor = (1.0 - tanAlpha / viewport[2]);

        // same side of the terrain
        if (groundRelative > 0.0) {
          posView *= factor;
        }
        // opposite sides of the terrain
        else {
          posView /= factor;
        }
      }

      return groundRelative;
    }
  `),t.isDraped||i.vertex.code.add(r["a"]`
    void applyHUDVerticalGroundOffset(vec3 normalModel, inout vec3 posModel, inout vec3 posView) {
      float distanceToCamera = length(posView);

      // Compute offset in world units for a half pixel shift
      float pixelOffset = distanceToCamera * perDistancePixelRatio * 0.5;

      // Apply offset along normal in the direction away from the ground surface
      vec3 modelOffset = normalModel * cameraGroundRelative * pixelOffset;

      // Apply the same offset also on the view space position
      vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;

      posModel += modelOffset;
      posView += viewOffset;
    }
  `),i.vertex.code.add(r["a"]`
    vec4 projectPositionHUD(out ProjectHUDAux aux) {
      // centerOffset is in view space and is used to implement world size offsetting
      // of labels with respect to objects. It also pulls the label towards the viewer
      // so that the label is visible in front of the object.
      vec3 centerOffset = auxpos1.xyz;

      // The pointGroundDistance is the distance of the geometry to the ground and is
      // negative if the point is below the ground, or positive if the point is above
      // ground.
      float pointGroundDistance = auxpos1.w;

      aux.posModel = position;
      aux.posView = (view * vec4(aux.posModel, 1.0)).xyz;
      aux.vnormal = normal;
      ${t.isDraped?"":"applyHUDVerticalGroundOffset(aux.vnormal, aux.posModel, aux.posView);"}

      // Screen sized offset in world space, used for example for line callouts
      // Note: keep this implementation in sync with the CPU implementation, see
      //   - MaterialUtil.verticalOffsetAtDistance
      //   - HUDMaterial.applyVerticalOffsetTransformation

      aux.distanceToCamera = length(aux.posView);

      vec3 viewDirObjSpace = normalize(camPos - aux.posModel);
      float cosAngle = dot(aux.vnormal, viewDirObjSpace);

      aux.absCosAngle = abs(cosAngle);

      ${t.screenSizePerspectiveEnabled&&(t.verticalOffsetEnabled||1===t.screenCenterOffsetUnitsEnabled)?"vec4 perspectiveFactor = screenSizePerspectiveScaleFactor(aux.absCosAngle, aux.distanceToCamera, screenSizePerspectiveAlignment);":""}

      ${t.verticalOffsetEnabled?t.screenSizePerspectiveEnabled?"float verticalOffsetScreenHeight = applyScreenSizePerspectiveScaleFactorFloat(verticalOffset.x, perspectiveFactor);":"float verticalOffsetScreenHeight = verticalOffset.x;":""}

      ${t.verticalOffsetEnabled?r["a"]`
            float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * aux.distanceToCamera, verticalOffset.z, verticalOffset.w);
            vec3 modelOffset = aux.vnormal * worldOffset;
            aux.posModel += modelOffset;
            vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;
            aux.posView += viewOffset;
            // Since we elevate the object, we need to take that into account
            // in the distance to ground
            pointGroundDistance += worldOffset;`:""}

      float groundRelative = applyHUDViewDependentPolygonOffset(pointGroundDistance, aux.absCosAngle, aux.posView);

      ${1!==t.screenCenterOffsetUnitsEnabled?r["a"]`
            // Apply x/y in view space, but z in screen space (i.e. along posView direction)
            aux.posView += vec3(centerOffset.x, centerOffset.y, 0.0);

            // Same material all have same z != 0.0 condition so should not lead to
            // branch fragmentation and will save a normalization if it's not needed
            if (centerOffset.z != 0.0) {
              aux.posView -= normalize(aux.posView) * centerOffset.z;
            }
          `:""}

      vec4 posProj = proj * vec4(aux.posView, 1.0);

      ${1===t.screenCenterOffsetUnitsEnabled?t.screenSizePerspectiveEnabled?"float centerOffsetY = applyScreenSizePerspectiveScaleFactorFloat(centerOffset.y, perspectiveFactor);":"float centerOffsetY = centerOffset.y;":""}

      ${1===t.screenCenterOffsetUnitsEnabled?"posProj.xy += vec2(centerOffset.x, centerOffsetY) * pixelRatio * 2.0 / viewport.zw * posProj.w;":""}

      // constant part of polygon offset emulation
      posProj.z -= groundRelative * polygonOffset * posProj.w;
      return posProj;
    }
  `),i.vertex.code.add(r["a"]`
    bool testVisibilityHUD(vec4 posProj) {
      // For occlusion testing, use the nearest pixel center to avoid
      // subpixel filtering messing up the color we use to test for
      vec4 posProjCenter = alignToPixelCenter(posProj, viewport.zw);

      vec4 occlusionPixel = texture2D(hudVisibilityTexture, .5 + .5 * posProjCenter.xy / posProjCenter.w);

      // the red pixel here indicates that the occlusion pixel passed the depth test against solid geometry and was written
      // the green pixel stores transparency of transparent geometry (1.0 -> fully transparent)
      // note that we also check against green == 0.0, i.e. transparent geometry that has opaque parts

      // thus we render visible pixels that are occluded by semi-transparent (but not fully transparent!) geometry here
      if (uRenderTransparentlyOccludedHUD > 0.5) {
        // multiplying by uRenderTransparentlyOccludedHUD allows us to ignore the second condition if
        // uRenderTransparentlyOccludedHUD = 0.75
        return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g * uRenderTransparentlyOccludedHUD < 1.0;
      }

      // and visible pixels that are not occluded by semi-transparent geometry here
      return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g == 1.0;
    }
  `)}!function(e){function t(e,t){e.setUniform1f("uRenderTransparentlyOccludedHUD",0===t.renderTransparentlyOccludedHUD?1:1===t.renderTransparentlyOccludedHUD?0:.75)}function i(e,t,i){t.setUniform1i("hudVisibilityTexture",4),e.bindTexture(i.hudVisibilityTexture,4),e.setActiveTexture(0)}e.bindUniforms=t,e.bindVisibilityTexture=i}(n||(n={}))},d1ac:function(e,t,i){"use strict";i.d(t,"a",(function(){return d})),i.d(t,"b",(function(){return u})),i.d(t,"c",(function(){return c})),i.d(t,"d",(function(){return h}));var r=i("b2b2"),a=i("9ef0"),n=i("d297");function s(e,t){if(!e||e.symbol)return null;const i=t&&t.renderer;return e&&Object(r["k"])(i)&&i.getObservationRenderer?i.getObservationRenderer(e):i}function o(e,t){if(Object(r["k"])(e.symbol))return e.symbol;const i=s(e,t);return Object(r["k"])(i)&&"dot-density"!==i.type?i.getSymbol(e,t):null}function c(e,t){const i=s(e,t),a=o(e,t);if(Object(r["j"])(a))return null;const c={renderer:i,symbol:a};if(Object(r["j"])(i)||!("visualVariables"in i)||!i.visualVariables)return c;const l=Object(n["getVisualVariableValues"])(i,e,t),h=["proportional","proportional","proportional"];for(const{variable:r,value:n}of l)switch(r.type){case"color":c.color=n.toRgba();break;case"size":if("outline"===r.target)c.outlineSize=n;else{const e=r.axis,t=r.useSymbolValue?"symbol-value":n;switch(e){case"width":h[0]=t;break;case"depth":h[1]=t;break;case"height":h[2]=t;break;case"width-and-depth":h[0]=h[1]=t;break;default:h[0]=h[1]=h[2]=t}}break;case"opacity":c.opacity=n;break;case"rotation":switch(r.axis){case"tilt":c.tilt=n;break;case"roll":c.roll=n;break;default:c.heading=n}}return"proportional"===h[0]&&"proportional"===h[1]&&"proportional"===h[2]||(c.size=h),c}async function l(e,t){if(Object(r["k"])(e.symbol))return e.symbol;const i=s(e,t);return Object(r["k"])(i)&&i.getSymbolAsync(e,{...t,abortOptions:{signal:t.signal}})}async function h(e,t){const i=s(e,t),r=await l(e,t);if(!r)return null;const o={renderer:i,symbol:r};if(!i||!("visualVariables"in i)||!i.visualVariables)return o;const c=Object(n["getVisualVariableValues"])(i,e,t),h=["proportional","proportional","proportional"];for(const{variable:n,value:s}of c)if("color"===n.type)o.color=a["a"].toUnitRGBA(s);else if("size"===n.type)if("outline"===n.target)o.outlineSize=s;else{const e=n.axis,t=n.useSymbolValue?"symbol-value":s;"width"===e?h[0]=t:"depth"===e?h[1]=t:"height"===e?h[2]=t:h[0]=h[1]="width-and-depth"===e?t:h[2]=t}else"opacity"===n.type?o.opacity=s:"rotation"===n.type&&"tilt"===n.axis?o.tilt=s:"rotation"===n.type&&"roll"===n.axis?o.roll=s:"rotation"===n.type&&(o.heading=s);return(isFinite(h[0])||isFinite(h[1])||isFinite(h[2]))&&(o.size=h),o}function d(e,t=0){const i=e[t];return"number"==typeof i&&isFinite(i)?i:null}function u(e){for(let t=0;t<3;t++){const i=e[t];if("number"==typeof i)return isFinite(i)?i:0}return 0}},d232:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));i("c120");var r=i("e92d"),a=i("6706"),n=i("7dcb");r["a"].getLogger("esri.views.interactive.snapping.hints.ParallelSnappingHint");class s extends n["a"]{constructor(e,t){super(),this.lineStart=e,this.lineEnd=t}equals(e){return e instanceof s&&Object(a["d"])(this.lineStart,e.lineStart)&&Object(a["d"])(this.lineEnd,e.lineEnd)}}},d329:function(e,t,i){"use strict";function r(e){return"r"in e&&"g"in e&&"b"in e}function a(e){return"h"in e&&"s"in e&&"v"in e}function n(e){return"l"in e&&"a"in e&&"b"in e}function s(e){return"l"in e&&"c"in e&&"h"in e}function o(e){return"x"in e&&"y"in e&&"z"in e}i.d(t,"a",(function(){return T})),i.d(t,"b",(function(){return w})),i.d(t,"c",(function(){return S})),i.d(t,"d",(function(){return C})),i.d(t,"e",(function(){return j}));const c=[[.4124,.3576,.1805],[.2126,.7152,.0722],[.0193,.1192,.9505]],l=[[3.2406,-1.5372,-.4986],[-.9689,1.8758,.0415],[.0557,-.204,1.057]];function h(e,t){const i=[];let r,a;if(e[0].length!==t.length)throw"dimensions do not match";const n=e.length,s=e[0].length;let o=0;for(r=0;r<n;r++){for(o=0,a=0;a<s;a++)o+=e[r][a]*t[a];i.push(o)}return i}function d(e){const t=[e.r/255,e.g/255,e.b/255].map(e=>e<=.04045?e/12.92:((e+.055)/1.055)**2.4),i=h(c,t);return{x:100*i[0],y:100*i[1],z:100*i[2]}}function u(e){const t=h(l,[e.x/100,e.y/100,e.z/100]).map(e=>{const t=e<=.0031308?12.92*e:1.055*e**(1/2.4)-.055;return Math.min(1,Math.max(t,0))});return{r:Math.round(255*t[0]),g:Math.round(255*t[1]),b:Math.round(255*t[2])}}function p(e){const t=[e.x/95.047,e.y/100,e.z/108.883].map(e=>e>(6/29)**3?e**(1/3):1/3*(29/6)**2*e+4/29);return{l:116*t[1]-16,a:500*(t[0]-t[1]),b:200*(t[1]-t[2])}}function f(e){const t=e.l,i=[(t+16)/116+e.a/500,(t+16)/116,(t+16)/116-e.b/200].map(e=>e>6/29?e**3:3*(6/29)**2*(e-4/29));return{x:95.047*i[0],y:100*i[1],z:108.883*i[2]}}function m(e){const t=e.l,i=e.a,r=e.b,a=Math.sqrt(i*i+r*r);let n=Math.atan2(r,i);return n=n>0?n:n+2*Math.PI,{l:t,c:a,h:n}}function b(e){const t=e.l,i=e.c,r=e.h;return{l:t,a:i*Math.cos(r),b:i*Math.sin(r)}}function g(e){return p(d(e))}function v(e){return u(f(e))}function y(e){return m(p(d(e)))}function O(e){return u(f(b(e)))}function _(e){const t=e.r,i=e.g,r=e.b,a=Math.max(t,i,r),n=a-Math.min(t,i,r);let s=a,o=0===n?0:a===t?(i-r)/n%6:a===i?(r-t)/n+2:(t-i)/n+4,c=0===n?0:n/s;return o<0&&(o+=6),o*=60,c*=100,s*=100/255,{h:o,s:c,v:s}}function x(e){const t=(e.h+360)%360/60,i=e.s/100,r=e.v/100*255,a=r*i,n=a*(1-Math.abs(t%2-1));let s;switch(Math.floor(t)){case 0:s={r:a,g:n,b:0};break;case 1:s={r:n,g:a,b:0};break;case 2:s={r:0,g:a,b:n};break;case 3:s={r:0,g:n,b:a};break;case 4:s={r:n,g:0,b:a};break;case 5:case 6:s={r:a,g:0,b:n};break;default:s={r:0,g:0,b:0}}return s.r=Math.round(s.r+r-a),s.g=Math.round(s.g+r-a),s.b=Math.round(s.b+r-a),s}function j(e){return r(e)?e:s(e)?O(e):n(e)?v(e):o(e)?u(e):a(e)?x(e):e}function w(e){return a(e)?e:_(j(e))}function S(e){return n(e)?e:g(j(e))}function C(e){return s(e)?e:y(j(e))}function T(e,t){const i=g(e);return i.l*=1-t,v(i)}},d36e:function(e,t,i){"use strict";i.d(t,"a",(function(){return w}));var r=i("d7f7"),a=i("7c51"),n=i("35b3"),s=i("7438"),o=i("8675"),c=i("a4ee"),l=i("c3a4"),h=i("ca98"),d=i("da35"),u=i("fa1e"),p=i("8e37"),f=i("189c"),m=i("8e97"),b=i("d272"),g=i("6a07"),v=i("c6d7"),y=i("87b7"),O=i("1962");class _ extends h["a"]{initializeProgram(e){const t=_.shader.get(),i=this.configuration,r=t.build({output:i.output,OITEnabled:0===i.transparencyPassType,attributeColor:i.vertexColors,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new p["a"](e.rctx,r.generateSource("vertex"),r.generateSource("fragment"),u["a"])}bindPass(e,t,i){m["a"].bindProjectionMatrix(this.program,i.camera.projectionMatrix),this.program.setUniform4fv("eColor",t.color),4===this.configuration.output&&g["a"].bindOutputHighlight(e,this.program,i),(1===this.configuration.output||i.multipassTerrainEnabled)&&this.program.setUniform2fv("cameraNearFar",i.camera.nearFar),i.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",i.inverseViewport),Object(v["a"])(this.program,e,i))}bindDraw(e){m["a"].bindView(this.program,e),b["a"].bindUniformsWithOrigin(this.program,this.configuration,e)}setPipelineState(e,t){const i=this.configuration,r=3===e,a=2===e,n=e=>0!==e&&{face:1===e?1028:1029,mode:2305};return Object(f["e"])({blending:0!==i.output&&7!==i.output||!i.transparent?null:r?s["f"]:Object(s["a"])(e),culling:n(i.cullFace),depthTest:{func:Object(s["b"])(e)},depthWrite:r||a?i.writeDepth&&f["d"]:null,colorWrite:f["c"],stencilWrite:i.sceneHasOcludees?y["j"]:null,stencilTest:i.sceneHasOcludees?t?y["f"]:y["e"]:null,polygonOffset:r||a?i.polygonOffset&&x:Object(s["g"])(i.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this.setPipelineState(this.configuration.transparencyPassType,!0),this.setPipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(e){return e?this._occludeePipelineState:this.pipeline}}_.shader=new l["a"](O["a"],()=>i.e("chunk-2d0de726").then(i.bind(null,"864f")));const x={factor:1,units:1};class j extends d["a"]{constructor(){super(...arguments),this.output=0,this.cullFace=0,this.slicePlaneEnabled=!1,this.vertexColors=!1,this.transparent=!1,this.polygonOffset=!1,this.enableOffset=!0,this.writeDepth=!0,this.sceneHasOcludees=!1,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!0}}Object(c["a"])([Object(d["b"])({count:8})],j.prototype,"output",void 0),Object(c["a"])([Object(d["b"])({count:3})],j.prototype,"cullFace",void 0),Object(c["a"])([Object(d["b"])()],j.prototype,"slicePlaneEnabled",void 0),Object(c["a"])([Object(d["b"])()],j.prototype,"vertexColors",void 0),Object(c["a"])([Object(d["b"])()],j.prototype,"transparent",void 0),Object(c["a"])([Object(d["b"])()],j.prototype,"polygonOffset",void 0),Object(c["a"])([Object(d["b"])()],j.prototype,"enableOffset",void 0),Object(c["a"])([Object(d["b"])()],j.prototype,"writeDepth",void 0),Object(c["a"])([Object(d["b"])()],j.prototype,"sceneHasOcludees",void 0),Object(c["a"])([Object(d["b"])({count:4})],j.prototype,"transparencyPassType",void 0),Object(c["a"])([Object(d["b"])()],j.prototype,"multipassTerrainEnabled",void 0),Object(c["a"])([Object(d["b"])()],j.prototype,"cullAboveGround",void 0);class w extends n["a"]{constructor(e){super(e,C),this.supportsEdges=!0,this.techniqueConfig=new j}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.cullFace=this.params.cullFace,this.techniqueConfig.vertexColors=this.params.vertexColors,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.transparent=this.params.transparent,this.techniqueConfig.polygonOffset=this.params.polygonOffset,this.techniqueConfig.writeDepth=this.params.writeDepth,this.techniqueConfig.sceneHasOcludees=this.params.sceneHasOcludees,this.techniqueConfig.transparencyPassType=t?t.transparencyPassType:3,this.techniqueConfig.enableOffset=!t||t.camera.relativeElevation<s["e"],this.techniqueConfig.multipassTerrainEnabled=!!t&&t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=!t||t.cullAboveGround,this.techniqueConfig}getPassParameters(){return this.params}intersect(e,t,i,r,n,s,o){Object(a["i"])(e,t,r,n,s,void 0,o)}getGLMaterial(e){return 0===e.output||7===e.output||4===e.output||1===e.output&&this.params.writeLinearDepth?new S(e):void 0}createBufferWriter(){return new o["a"](o["b"])}}class S extends r["a"]{constructor(e){super(e),this.updateParameters()}updateParameters(e){this.technique=this.techniqueRep.acquireAndReleaseExisting(_,this.material.getTechniqueConfig(this.output,e),this.technique)}beginSlot(e){return 4===this.output?3===e:e===(this.technique.configuration.transparent?this.technique.configuration.writeDepth?5:8:3)}_updateOccludeeState(e){e.hasOccludees!==this.material.params.sceneHasOcludees&&this.material.setParameterValues({sceneHasOcludees:e.hasOccludees})}ensureParameters(e){0!==this.output&&7!==this.output||this._updateOccludeeState(e),this.updateParameters(e)}bind(e,t){e.bindProgram(this.technique.program),this.technique.bindPass(e,this.material.getPassParameters(),t)}getPipelineState(e,t){return this.technique.getPipelineState(t)}}const C={color:[1,1,1,1],transparent:!1,writeDepth:!0,writeLinearDepth:!1,vertexColors:!1,polygonOffset:!1,slicePlaneEnabled:!1,cullFace:0,sceneHasOcludees:!1,...n["b"]}},d378:function(e,t,i){"use strict";i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return o}));var r=i("78ba");class a extends r["a"]{constructor(e){super("LercWorker","_decode",e,{strategy:"dedicated"}),this.scheduler=e}decode(e,t,i){return e&&0!==e.byteLength?this.invoke({buffer:e,options:t},i):Promise.resolve(null)}getTransferList(e){return[e.buffer]}}const n=new Map;function s(e){let t=n.get(e);return t||(t={instance:new a(e),ref:0},n.set(e,t)),++t.ref,t.instance}function o(e){if(null==e)return;const t=e.scheduler,i=n.get(t);i&&--i.ref<=0&&(i.instance.destroy(),n.delete(t))}},d3cf:function(e,t,i){"use strict";i.d(t,"a",(function(){return y})),i.d(t,"b",(function(){return p})),i.d(t,"c",(function(){return u})),i.d(t,"d",(function(){return l}));i("c120");var r=i("a21b"),a=i("7ffa"),n=i("b2b2"),s=i("a9ab"),o=i("8d60"),c=i("1a54");function l(e){return"declaredClass"in e}function h(e){return"declaredClass"in e}function d(e){return"declaredClass"in e}function u(e,t){if(!e)return null;if(d(e))return e;const i=new o["a"]({layer:t,sourceLayer:t});return i.visible=e.visible,i.symbol=Object(a["a"])(e.symbol),i.attributes=Object(a["a"])(e.attributes),i.geometry=p(e.geometry),i}function p(e){return Object(n["j"])(e)?null:l(e)?e:Object(s["a"])(f(e))}function f(e){const t=e.spatialReference.toJSON();switch(e.type){case"point":{const{x:i,y:r,z:a,m:n}=e;return{x:i,y:r,z:a,m:n,spatialReference:t}}case"polygon":{const{rings:i,hasZ:r,hasM:a}=e;return{rings:m(i),hasZ:r,hasM:a,spatialReference:t}}case"polyline":{const{paths:i,hasZ:r,hasM:a}=e;return{paths:m(i),hasZ:r,hasM:a,spatialReference:t}}case"extent":{const{xmin:i,xmax:r,ymin:a,ymax:n,zmin:s,zmax:o,mmin:c,mmax:l,hasZ:h,hasM:d}=e;return{xmin:i,xmax:r,ymin:a,ymax:n,zmin:s,zmax:o,mmin:c,mmax:l,hasZ:h,hasM:d,spatialReference:t}}case"multipoint":{const{points:i,hasZ:r,hasM:a}=e;return{points:v(i)?b(i):i,hasZ:r,hasM:a,spatialReference:t}}default:return}}function m(e){return g(e)?e.map(e=>b(e)):e}function b(e){return e.map(e=>Object(r["n"])(e))}function g(e){for(const t of e)if(0!==t.length)return v(t);return!1}function v(e){return e.length&&(Object(r["d"])(e[0])||Object(r["e"])(e[0]))}function y(e,t){if(!e)return null;let i;if(h(e)){if(null==t)return e.clone();if(h(t))return t.copy(e)}return null!=t?(i=t,i.x=e.x,i.y=e.y,i.spatialReference=e.spatialReference,e.hasZ?(i.z=e.z,i.hasZ=e.hasZ):(i.z=null,i.hasZ=!1),e.hasM?(i.m=e.m,i.hasM=!0):(i.m=null,i.hasM=!1)):(i=Object(c["k"])(e.x,e.y,e.z,e.spatialReference),e.hasM&&(i.m=e.m,i.hasM=!0)),i}},d408:function(e,t,i){"use strict";i.d(t,"a",(function(){return f})),i.d(t,"b",(function(){return m})),i.d(t,"c",(function(){return g}));var r=i("a21b"),a=i("b2b2"),n=i("38a4"),s=i("0b2d"),o=i("e431"),c=i("8188"),l=i("1666"),h=i("0278"),d=i("2e0f"),u=i("7585"),p=i("ed70");function f(e){const t=[],i=[];v(e,i,t);const r=i[0][1].data,a=t[0][1].length,n=new Uint16Array(a);return y(e,i,t),O(e,i,t,n),x(e,i,t,n),_(e,i,t,n),j(e,i,t,n),w(e,i,t,n),S(e,i,t,r),new h["a"](i,t,2)}function m(e,t,i,r){const a="polygon"===e.type?1:0,n="polygon"===e.type?e.rings:e.paths,{position:s,outlines:o}=Object(l["a"])(n,e.hasZ,a),c=new Float64Array(s.length),h=Object(d["c"])(s,e.spatialReference,0,c,0,s,0,s.length/3,t,i,r),u=null!=h;return{lines:u?b(o,s,c):[],projectionSuccess:u,sampledElevation:h}}function b(e,t,i){const r=new Array;for(const{index:a,count:n}of e){if(n<=1)continue;const e=3*a,s=e+3*n;r.push({position:t.subarray(e,s),mapPosition:i?i.subarray(e,s):void 0})}return r}function g(e,t){const i="polygon"===e.type?1:0,r="polygon"===e.type?e.rings:e.paths,{position:a,outlines:n}=Object(l["a"])(r,!1,i),s=Object(c["q"])(a,e.spatialReference,0,a,t,0,a.length/3);for(let o=2;o<a.length;o+=3)a[o]=u["a"];return{lines:s?b(n,a):[],projectionSuccess:s}}function v(e,t,i){const{attributeData:{position:a},removeDuplicateStartEnd:n}=e,s=T(a)&&1===n,o=a.length/3-(s?1:0),c=new Uint32Array(2*(o-1)),l=s?Object(r["m"])(a,0,a.length-3):a;let h=0;for(let r=0;r<o-1;r++)c[h++]=r,c[h++]=r+1;t.push(["position",{size:3,data:l,exclusive:s}]),i.push(["position",c])}function y(e,t,i){const r=e.attributeData.mapPosition;Object(a["j"])(r)||(i.push(["mapPos",i[0][1]]),t.push(["mapPos",{size:3,data:r}]))}function O(e,t,i,r){if(Object(a["k"])(e.attributeData.colorFeature))return;const n=e.attributeData.color;t.push(["color",{size:4,data:Object(a["u"])(n,p["c"])}]),i.push(["color",r])}function _(e,t,i,r){const n=e.attributeData.colorFeature;Object(a["j"])(n)||(t.push(["colorFeatureAttribute",{size:1,data:new Float32Array([n])}]),i.push(["color",r]))}function x(e,t,i,r){if(Object(a["k"])(e.attributeData.sizeFeature))return;const n=e.attributeData.size;t.push(["size",{size:1,data:[Object(a["u"])(n,1)]}]),i.push(["size",r])}function j(e,t,i,r){const n=e.attributeData.sizeFeature;Object(a["j"])(n)||(t.push(["sizeFeatureAttribute",{size:1,data:new Float32Array([n])}]),i.push(["sizeFeatureAttribute",r]))}function w(e,t,i,r){const n=e.attributeData.opacityFeature;Object(a["j"])(n)||(t.push(["opacityFeatureAttribute",{size:1,data:new Float32Array([n])}]),i.push(["opacityFeatureAttribute",r]))}function S(e,t,i,r){if("round"!==e.join)return;const s=r.length/3,c=new Float32Array(s),l=P,h=A;Object(o["x"])(l,0,0,0);const d=Object(a["u"])(e.uniformSize,1);for(let a=-1;a<s;++a){const e=a<0?s+a:a,t=(a+1)%s;if(Object(o["x"])(h,r[3*t+0]-r[3*e+0],r[3*t+1]-r[3*e+1],r[3*t+2]-r[3*e+2]),Object(o["s"])(h,h),a>=0){const e=(Math.PI-Object(n["b"])(Object(o["i"])(l,h)))*R*1*C(d);c[a]=Math.max(Math.floor(e),0)}Object(o["f"])(l,h,-1)}t.push(["subdivisions",{size:1,data:c}]),i.push(["subdivisions",i[0][1]])}function C(e){return 1.863798+-2.0062872/(1+e/18.2313)**.8856294}function T(e){const t=e.length;return e[0]===e[t-3]&&e[1]===e[t-2]&&e[2]===e[t-1]}const P=Object(s["e"])(),A=Object(s["e"])(),R=4/Math.PI},d409:function(e,t,i){"use strict";i.d(t,"a",(function(){return v}));var r=i("a4ee"),a=(i("c120"),i("e92d")),n=(i("cea0"),i("4c37")),s=i("59b2"),o=i("d386"),c=i("ce50"),l=(i("e041"),i("8eed"),i("92ef")),h=(i("f402"),i("2c4f")),d=i("4d10"),u=i("e9d0"),p=i("2258");const f=a["a"].getLogger("esri.layers.TileLayer");function m(e,t){const i=[],r={};return e?(e.forEach(e=>{const a=new u["a"];if(a.read(e,t),r[a.id]=a,null!=e.parentLayerId&&-1!==e.parentLayerId){const t=r[e.parentLayerId];t.sublayers||(t.sublayers=[]),t.sublayers.unshift(a)}else i.unshift(a)}),i):i}const b=h["a"].ofType(u["a"]);function g(e,t){e&&e.forEach(e=>{t(e),e.sublayers&&e.sublayers.length&&g(e.sublayers,t)})}const v=e=>{let t=class extends e{constructor(...e){super(...e),this.allSublayers=new d["a"]({root:this,rootCollectionNames:["sublayers"],getChildrenFunction:e=>e.sublayers}),this.sublayersSourceJSON={2:{},3:{},4:{},5:{}},this.watch("sublayers",(e,t)=>this._handleSublayersChange(e,t),!0)}readSublayers(e,t){if(!t||!e)return;const{sublayersSourceJSON:i}=this,r=Object(l["d"])(t.origin);if(r<2)return;if(i[r]={context:t,visibleLayers:e.visibleLayers||i[r].visibleLayers,layers:e.layers||i[r].layers},r>2)return;this._set("serviceSublayers",this.createSublayersForOrigin("service").sublayers);const{sublayers:a,origin:s}=this.createSublayersForOrigin("web-document"),o=Object(n["a"])(this);o.setDefaultOrigin(s),this._set("sublayers",new b(a)),o.setDefaultOrigin("user")}findSublayerById(e){return this.allSublayers.find(t=>t.id===e)}createServiceSublayers(){return this.createSublayersForOrigin("service").sublayers}createSublayersForOrigin(e){const t=Object(l["d"])("web-document"===e?"web-map":e);let i=2,r=this.sublayersSourceJSON[2].layers,a=this.sublayersSourceJSON[2].context,n=null;const s=[3,4,5].filter(e=>e<=t);for(const l of s){const e=this.sublayersSourceJSON[l];Object(p["b"])(e.layers)&&(i=l,r=e.layers,a=e.context,e.visibleLayers&&(n={visibleLayers:e.visibleLayers,context:e.context}))}const o=[3,4,5].filter(e=>e>i&&e<=t);let c=null;for(const l of o){const{layers:e,visibleLayers:t,context:i}=this.sublayersSourceJSON[l];e&&(c={layers:e,context:i}),t&&(n={visibleLayers:t,context:i})}const h=m(r,a),d=new Map,u=new Set;if(c)for(const l of c.layers)d.set(l.id,l);if(n)for(const l of n.visibleLayers)u.add(l);return g(h,e=>{c&&e.read(d.get(e.id),c.context),n&&e.read({defaultVisibility:u.has(e.id)},n.context)}),{origin:Object(l["b"])(i),sublayers:new b({items:h})}}read(e,t){super.read(e,t),this.readSublayers(e,t)}_handleSublayersChange(e,t){t&&(t.forEach(e=>{e.parent=null,e.layer=null}),this.handles.remove("sublayers-owner")),e&&(e.forEach(e=>{e.parent=this,e.layer=this}),this.handles.add([e.on("after-add",({item:e})=>{e.parent=this,e.layer=this}),e.on("after-remove",({item:e})=>{e.parent=null,e.layer=null})],"sublayers-owner"),"tile"===this.type&&this.handles.add(e.on("before-changes",e=>{f.error(new c["a"]("tilelayer:sublayers-non-modifiable","Sublayer can't be added, moved, or removed from the layer's sublayers",{layer:this})),e.preventDefault()}),"sublayers-owner"))}};return Object(r["a"])([Object(s["b"])({readOnly:!0})],t.prototype,"allSublayers",void 0),Object(r["a"])([Object(s["b"])({readOnly:!0,type:h["a"].ofType(u["a"])})],t.prototype,"serviceSublayers",void 0),Object(r["a"])([Object(s["b"])({value:null,type:b,json:{read:!1,write:{allowNull:!0,ignoreOrigin:!0}}})],t.prototype,"sublayers",void 0),Object(r["a"])([Object(s["b"])({readOnly:!0})],t.prototype,"sublayersSourceJSON",void 0),t=Object(r["a"])([Object(o["a"])("esri.layers.mixins.SublayersOwner")],t),t}},d4de:function(e,t,i){"use strict";var r=i("b2b2"),a=i("beba");const n={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,type:"stretch"};class s{constructor(e,t,i=null,r=null){this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.symbolizerRenderer=null,this.rawPixelData=null,this.lij=null,this.scale=1,this.offset=[0,0],this.opacity=1,this.lij=e,this.source=t,this.width=i||t.width,this.height=r||t.height}get source(){return this._source}set source(e){this._source=e,this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null,this._memoryUsed=null)}get symbolizerParameters(){return this._symbolizerParameters||n}set symbolizerParameters(e){this._symbolizerParameters=e}get bandIds(){return this._bandIds}set bandIds(e){Object(r["k"])(e)&&e.length>0?this._bandIds&&e.every((e,t)=>!!this._bandIds[t]&&e===this._bandIds[t])||(this._bandIds=e,this._dirty=!0):this._bandIds=null}get interpolation(){return this._interpolation}set interpolation(e){this._interpolation=e,this._rasterTexture&&this._rasterTexture.setSamplingMode("bilinear"===e?9729:9728)}get transformGrid(){return this._transformGrid}set transformGrid(e){this._transformGrid=e,this._transformGridTexture&&(this._transformGridTexture.dispose(),this._transformGridTexture=null,this._memoryUsed=null)}bind(e){return!!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&(this._rasterTexture&&!this._dirty||this._updateRasterTexture(e,this.bandIds),this._rasterTexture&&(this._updateColormapTexture(e),this.transformGrid&&!this._transformGridTexture&&(this._transformGridTexture=Object(a["c"])(e,this.transformGrid))),!0)}getUniforms(){const e=Object(a["d"])(this.scale,this.offset),{symbolizerParameters:t,transformGrid:i,width:r,height:n,opacity:s}=this;return{basic:e,common:Object(a["f"])(i,[r,n],[this.source.width,this.source.height],s),colormap:t.colormap?Object(a["e"])(t.colormap,t.colormapOffset):null,stretch:"stretch"===this.symbolizerParameters.type?Object(a["h"])(this.symbolizerParameters):null,hillshade:"hillshade"===this.symbolizerParameters.type?Object(a["g"])(this.symbolizerParameters):null}}getTextures(){if(!this._rasterTexture)return null;const e=[],t=[];return this._transformGridTexture&&(t.push(this._transformGridTexture),e.push("u_transformGrid")),this._rasterTexture&&(t.push(this._rasterTexture),e.push("u_image")),this._colormapTexture&&(t.push(this._colormapTexture),e.push("u_colormap")),{names:e,textures:t}}getMemoryUsage(){if(Object(r["j"])(this._memoryUsed)){const e=this.getTextures();if(null==e)return 0;this._memoryUsed=e.textures.map(e=>e.descriptor.width*e.descriptor.height*4).reduce((e,t)=>e+t)}return this._memoryUsed}release(){return this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null),this._transformGridTexture&&(this._transformGridTexture.dispose(),this._transformGridTexture=null),this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0}_updateRasterTexture(e,t){const i=this.source?this.source.extractBands(t):null;if(!(i&&i.pixels&&i.pixels.length>0))return void(this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null));const n=Object(r["j"])(t)&&Object(r["j"])(this.bandIds)||Object(r["k"])(t)&&Object(r["k"])(this.bandIds)&&t.join("")===this.bandIds.join("");if(this._rasterTexture){if(n)return;this._rasterTexture.dispose(),this._rasterTexture=null}this._rasterTexture=Object(a["b"])(e,i,this.interpolation||"nearest")}_updateColormapTexture(e){const t=this._colormap,i=this.symbolizerParameters.colormap;return i?t?i.length!==t.length||i.some((e,i)=>e!==t[i])?(this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),this._colormapTexture=Object(a["a"])(e,i),void(this._colormap=i)):void 0:(this._colormapTexture=Object(a["a"])(e,i),void(this._colormap=i)):(this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),void(this._colormap=null))}}t["a"]=s},d539:function(e,t,i){"use strict";i.d(t,"a",(function(){return o}));var r=i("0b2d"),a=i("3886"),n=i("9a64"),s=i("6a21");function o(e,t){t.instanced&&t.instancedDoublePrecision&&(e.attributes.add("modelOriginHi","vec3"),e.attributes.add("modelOriginLo","vec3"),e.attributes.add("model","mat3"),e.attributes.add("modelNormal","mat3")),t.instancedDoublePrecision&&(e.vertex.include(s["a"],t),e.vertex.uniforms.add("viewOriginHi","vec3"),e.vertex.uniforms.add("viewOriginLo","vec3"));const i=[a["a"]`
    vec3 calculateVPos() {
      ${t.instancedDoublePrecision?"return model * localPosition().xyz;":"return localPosition().xyz;"}
    }
    `,a["a"]`
    vec3 subtractOrigin(vec3 _pos) {
      ${t.instancedDoublePrecision?a["a"]`
          vec3 originDelta = dpAdd(viewOriginHi, viewOriginLo, -modelOriginHi, -modelOriginLo);
          return _pos - originDelta;`:"return vpos;"}
    }
    `,a["a"]`
    vec3 dpNormal(vec4 _normal) {
      ${t.instancedDoublePrecision?"return normalize(modelNormal * _normal.xyz);":"return normalize(_normal.xyz);"}
    }
    `,a["a"]`
    vec3 dpNormalView(vec4 _normal) {
      ${t.instancedDoublePrecision?"return normalize((viewNormal * vec4(modelNormal * _normal.xyz, 1.0)).xyz);":"return normalize((viewNormal * _normal).xyz);"}
    }
    `,t.vertexTangets?a["a"]`
    vec4 dpTransformVertexTangent(vec4 _tangent) {
      ${t.instancedDoublePrecision?"return vec4(modelNormal * _tangent.xyz, _tangent.w);":"return _tangent;"}

    }
    `:a["a"]``];e.vertex.code.add(i[0]),e.vertex.code.add(i[1]),e.vertex.code.add(i[2]),2===t.output&&e.vertex.code.add(i[3]),e.vertex.code.add(i[4])}!function(e){class t{}function i(e,t){Object(n["b"])(t,c,l,3),e.setUniform3fv("viewOriginHi",c),e.setUniform3fv("viewOriginLo",l)}e.Uniforms=t,e.bindCustomOrigin=i}(o||(o={}));const c=Object(r["e"])(),l=Object(r["e"])()},d56e:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));i("c120");var r=i("3886");function a(e,t){r["a"]`
  /*
  *  ${t.name}
  *  ${0===t.output?"RenderOutput: Color":1===t.output?"RenderOutput: Depth":3===t.output?"RenderOutput: Shadow":2===t.output?"RenderOutput: Normal":4===t.output?"RenderOutput: Highlight":""}
  */
  `}},d6e5:function(e,t,i){"use strict";var r=i("171c");class a{constructor(e,t,i,a,s,o){this.rctx=e,this.offscreenRenderingHelper=t,this.scenelightingData=i,this.shadowMap=a,this.ssaoHelper=s,this.sliceHelper=o,this.camera=null,this.lastFrameCamera=new r["a"],this.pass=0,this.slot=0,this.highlightDepthTexture=null,this.renderOccludedMask=n,this.hasOccludees=!1}resetRenderOccludedMask(){this.renderOccludedMask=n}get isHighlightPass(){return 5===this.pass}}const n=13;t["a"]=a},d981:function(e,t,i){"use strict";i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return a}));var r=i("3886");function a(e){e.fragment.code.add(r["a"]`
    float normals2FoamIntensity(vec3 n, float waveStrength){
      float normalizationFactor =  max(0.015, waveStrength);
      return max((n.x + n.y)*0.3303545/normalizationFactor + 0.3303545, 0.0);
    }
  `)}function n(e){e.fragment.code.add(r["a"]`
    vec3 foamIntensity2FoamColor(float foamIntensityExternal, float foamPixelIntensity, vec3 skyZenitColor, float dayMod){
      return foamIntensityExternal * (0.075 * skyZenitColor * pow(foamPixelIntensity, 4.) +  50.* pow(foamPixelIntensity, 23.0)) * dayMod;
    }
  `)}},da6c:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i("e92d");const a=r["a"].getLogger("esri.views.3d.support.buffer.math")},dbad:function(e,t,i){"use strict";i.d(t,"a",(function(){return G})),i.d(t,"b",(function(){return z}));var r=i("0b2d"),a=i("e431"),n=i("dae5"),s=i("fc00"),o=i("a978"),c=i("68af"),l=i("7c51"),h=i("35b3"),d=i("5957"),u=i("ebd5"),p=i("7438"),f=i("a4ee"),m=i("c3a4"),b=i("ca98"),g=i("da35"),v=i("fa1e"),y=i("8e37"),O=i("189c"),_=i("8e97"),x=i("d272"),j=i("6a07"),w=i("be24"),S=i("17b0"),C=i("c6d7"),T=i("87b7"),P=i("d017"),A=i("6a21"),R=i("d539"),M=i("a7d7"),E=i("0310");class D extends b["a"]{initializeProgram(e){const t=D.shader.get(),i=this.configuration,r=t.build({OITEnabled:0===i.transparencyPassType,output:i.output,viewingMode:e.viewingMode,receiveShadows:i.receiveShadows,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:i.sliceHighlightDisabled,sliceEnabledForVertexPrograms:!1,symbolColor:i.symbolColors,vvSize:i.vvSize,vvColor:i.vvColor,vvInstancingEnabled:!0,instanced:i.instanced,instancedColor:i.instancedColor,instancedDoublePrecision:i.instancedDoublePrecision,useOldSceneLightInterface:!1,pbrMode:i.usePBR?i.isSchematic?2:1:0,hasMetalnessAndRoughnessTexture:i.hasMetalnessAndRoughnessTexture,hasEmissionTexture:i.hasEmissionTexture,hasOcclusionTexture:i.hasOcclusionTexture,hasNormalTexture:i.hasNormalTexture,hasColorTexture:i.hasColorTexture,receiveAmbientOcclusion:i.receiveAmbientOcclusion,useCustomDTRExponentForWater:!1,normalType:i.normalsTypeDerivate?3:0,doubleSidedMode:i.doubleSidedMode,vertexTangets:i.vertexTangents,attributeTextureCoordinates:i.hasMetalnessAndRoughnessTexture||i.hasEmissionTexture||i.hasOcclusionTexture||i.hasNormalTexture||i.hasColorTexture?1:0,textureAlphaPremultiplied:i.textureAlphaPremultiplied,attributeColor:i.vertexColors,screenSizePerspectiveEnabled:i.screenSizePerspective,verticalOffsetEnabled:i.verticalOffset,offsetBackfaces:i.offsetBackfaces,doublePrecisionRequiresObfuscation:Object(A["b"])(e.rctx),alphaDiscardMode:i.alphaDiscardMode,supportsTextureAtlas:!1,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new y["a"](e.rctx,r.generateSource("vertex"),r.generateSource("fragment"),v["a"])}bindPass(e,t,i){_["a"].bindProjectionMatrix(this.program,i.camera.projectionMatrix);const r=this.configuration.output;(1===this.configuration.output||i.multipassTerrainEnabled||3===r)&&this.program.setUniform2fv("cameraNearFar",i.camera.nearFar),i.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",i.inverseViewport),Object(C["a"])(this.program,e,i)),7===r&&(this.program.setUniform1f("opacity",t.opacity),this.program.setUniform1f("layerOpacity",t.layerOpacity),this.program.setUniform4fv("externalColor",t.externalColor),this.program.setUniform1i("colorMixMode",l["b"][t.colorMixMode])),0===r?(i.lighting.setUniforms(this.program,!1),this.program.setUniform3fv("ambient",t.ambient),this.program.setUniform3fv("diffuse",t.diffuse),this.program.setUniform4fv("externalColor",t.externalColor),this.program.setUniform1i("colorMixMode",l["b"][t.colorMixMode]),this.program.setUniform1f("opacity",t.opacity),this.program.setUniform1f("layerOpacity",t.layerOpacity),this.configuration.usePBR&&M["b"].bindUniforms(this.program,t,this.configuration.isSchematic)):4===r&&j["a"].bindOutputHighlight(e,this.program,i),w["a"].bindUniformsForSymbols(this.program,t),S["a"].bindUniforms(this.program,t,i),Object(l["a"])(t.screenSizePerspective,this.program,"screenSizePerspectiveAlignment"),2!==t.textureAlphaMode&&3!==t.textureAlphaMode||this.program.setUniform1f("textureAlphaCutoff",t.textureAlphaCutoff)}bindDraw(e){const t=this.configuration.instancedDoublePrecision?Object(r["g"])(e.camera.viewInverseTransposeMatrix[3],e.camera.viewInverseTransposeMatrix[7],e.camera.viewInverseTransposeMatrix[11]):e.origin;_["a"].bindViewCustomOrigin(this.program,t,e.camera.viewMatrix),(0===this.configuration.output||7===this.configuration.output||1===this.configuration.output&&this.configuration.screenSizePerspective||2===this.configuration.output&&this.configuration.screenSizePerspective||4===this.configuration.output&&this.configuration.screenSizePerspective)&&_["a"].bindCamPosition(this.program,t,e.camera.viewInverseTransposeMatrix),2===this.configuration.output&&this.program.setUniformMatrix4fv("viewNormal",e.camera.viewInverseTransposeMatrix),this.configuration.instancedDoublePrecision&&R["a"].bindCustomOrigin(this.program,t),x["a"].bindUniforms(this.program,this.configuration,e.slicePlane,t),0===this.configuration.output&&P["a"].bindViewCustomOrigin(this.program,e,t)}setPipeline(e,t){const i=this.configuration,r=3===e,a=2===e;return Object(O["e"])({blending:0!==i.output&&7!==i.output||!i.transparent?null:r?p["f"]:Object(p["a"])(e),culling:L(i),depthTest:{func:Object(p["b"])(e)},depthWrite:r||a?i.writeDepth&&O["d"]:null,colorWrite:O["c"],stencilWrite:i.sceneHasOcludees?T["j"]:null,stencilTest:i.sceneHasOcludees?t?T["f"]:T["e"]:null,polygonOffset:r||a?null:Object(p["g"])(i.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this.setPipeline(this.configuration.transparencyPassType,!0),this.setPipeline(this.configuration.transparencyPassType,!1)}getPipelineState(e){return e?this._occludeePipelineState:this.pipeline}}function I(e){return e.cullFace?0!==e.cullFace:!e.slicePlaneEnabled&&!e.transparent&&!e.doubleSidedMode}D.shader=new m["a"](E["a"],()=>i.e("chunk-2d0cb6c5").then(i.bind(null,"4a35")));const L=e=>I(e)&&{face:1===e.cullFace?1028:1029,mode:2305};class V extends g["a"]{constructor(){super(...arguments),this.output=0,this.alphaDiscardMode=1,this.doubleSidedMode=0,this.isSchematic=!1,this.vertexColors=!1,this.offsetBackfaces=!1,this.symbolColors=!1,this.vvSize=!1,this.vvColor=!1,this.verticalOffset=!1,this.receiveShadows=!1,this.slicePlaneEnabled=!1,this.sliceHighlightDisabled=!1,this.receiveAmbientOcclusion=!1,this.screenSizePerspective=!1,this.textureAlphaPremultiplied=!1,this.hasColorTexture=!1,this.usePBR=!1,this.hasMetalnessAndRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.instanced=!1,this.instancedColor=!1,this.instancedDoublePrecision=!1,this.vertexTangents=!1,this.normalsTypeDerivate=!1,this.writeDepth=!0,this.sceneHasOcludees=!1,this.transparent=!1,this.enableOffset=!0,this.cullFace=0,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!0}}Object(f["a"])([Object(g["b"])({count:8})],V.prototype,"output",void 0),Object(f["a"])([Object(g["b"])({count:4})],V.prototype,"alphaDiscardMode",void 0),Object(f["a"])([Object(g["b"])({count:3})],V.prototype,"doubleSidedMode",void 0),Object(f["a"])([Object(g["b"])()],V.prototype,"isSchematic",void 0),Object(f["a"])([Object(g["b"])()],V.prototype,"vertexColors",void 0),Object(f["a"])([Object(g["b"])()],V.prototype,"offsetBackfaces",void 0),Object(f["a"])([Object(g["b"])()],V.prototype,"symbolColors",void 0),Object(f["a"])([Object(g["b"])()],V.prototype,"vvSize",void 0),Object(f["a"])([Object(g["b"])()],V.prototype,"vvColor",void 0),Object(f["a"])([Object(g["b"])()],V.prototype,"verticalOffset",void 0),Object(f["a"])([Object(g["b"])()],V.prototype,"receiveShadows",void 0),Object(f["a"])([Object(g["b"])()],V.prototype,"slicePlaneEnabled",void 0),Object(f["a"])([Object(g["b"])()],V.prototype,"sliceHighlightDisabled",void 0),Object(f["a"])([Object(g["b"])()],V.prototype,"receiveAmbientOcclusion",void 0),Object(f["a"])([Object(g["b"])()],V.prototype,"screenSizePerspective",void 0),Object(f["a"])([Object(g["b"])()],V.prototype,"textureAlphaPremultiplied",void 0),Object(f["a"])([Object(g["b"])()],V.prototype,"hasColorTexture",void 0),Object(f["a"])([Object(g["b"])()],V.prototype,"usePBR",void 0),Object(f["a"])([Object(g["b"])()],V.prototype,"hasMetalnessAndRoughnessTexture",void 0),Object(f["a"])([Object(g["b"])()],V.prototype,"hasEmissionTexture",void 0),Object(f["a"])([Object(g["b"])()],V.prototype,"hasOcclusionTexture",void 0),Object(f["a"])([Object(g["b"])()],V.prototype,"hasNormalTexture",void 0),Object(f["a"])([Object(g["b"])()],V.prototype,"instanced",void 0),Object(f["a"])([Object(g["b"])()],V.prototype,"instancedColor",void 0),Object(f["a"])([Object(g["b"])()],V.prototype,"instancedDoublePrecision",void 0),Object(f["a"])([Object(g["b"])()],V.prototype,"vertexTangents",void 0),Object(f["a"])([Object(g["b"])()],V.prototype,"normalsTypeDerivate",void 0),Object(f["a"])([Object(g["b"])()],V.prototype,"writeDepth",void 0),Object(f["a"])([Object(g["b"])()],V.prototype,"sceneHasOcludees",void 0),Object(f["a"])([Object(g["b"])()],V.prototype,"transparent",void 0),Object(f["a"])([Object(g["b"])()],V.prototype,"enableOffset",void 0),Object(f["a"])([Object(g["b"])({count:3})],V.prototype,"cullFace",void 0),Object(f["a"])([Object(g["b"])({count:4})],V.prototype,"transparencyPassType",void 0),Object(f["a"])([Object(g["b"])()],V.prototype,"multipassTerrainEnabled",void 0),Object(f["a"])([Object(g["b"])()],V.prototype,"cullAboveGround",void 0);var k=i("b0ab");class F extends D{initializeProgram(e){const t=F.shader.get(),i=this.configuration,r=t.build({OITEnabled:0===i.transparencyPassType,output:i.output,viewingMode:e.viewingMode,receiveShadows:i.receiveShadows,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:i.sliceHighlightDisabled,sliceEnabledForVertexPrograms:!1,symbolColor:i.symbolColors,vvSize:i.vvSize,vvColor:i.vvColor,vvInstancingEnabled:!0,instanced:i.instanced,instancedColor:i.instancedColor,instancedDoublePrecision:i.instancedDoublePrecision,useOldSceneLightInterface:!1,pbrMode:i.usePBR?1:0,hasMetalnessAndRoughnessTexture:!1,hasEmissionTexture:!1,hasOcclusionTexture:!1,hasNormalTexture:!1,hasColorTexture:i.hasColorTexture,receiveAmbientOcclusion:i.receiveAmbientOcclusion,useCustomDTRExponentForWater:!1,normalType:0,doubleSidedMode:2,vertexTangets:!1,attributeTextureCoordinates:i.hasColorTexture?1:0,textureAlphaPremultiplied:i.textureAlphaPremultiplied,attributeColor:i.vertexColors,screenSizePerspectiveEnabled:i.screenSizePerspective,verticalOffsetEnabled:i.verticalOffset,offsetBackfaces:i.offsetBackfaces,doublePrecisionRequiresObfuscation:Object(A["b"])(e.rctx),alphaDiscardMode:i.alphaDiscardMode,supportsTextureAtlas:!1,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new y["a"](e.rctx,r.generateSource("vertex"),r.generateSource("fragment"),v["a"])}}F.shader=new m["a"](k["a"],()=>i.e("chunk-2d0ab897").then(i.bind(null,"1662")));class z extends h["a"]{constructor(e){super(e,B),this.supportsEdges=!0,this.techniqueConfig=new V,this.vertexBufferLayout=z.getVertexBufferLayout(this.params),this.instanceBufferLayout=e.instanced?z.getInstanceBufferLayout(this.params):null}isVisibleInPass(e){return 4!==e&&6!==e&&7!==e||this.params.castShadows}isVisible(){const e=this.params;if(!super.isVisible()||0===e.layerOpacity)return!1;const t=e.instanced,i=e.vertexColors,r=e.symbolColors,a=!!t&&t.indexOf("color")>-1,n=e.vvColorEnabled,s="replace"===e.colorMixMode,o=e.opacity>0,c=e.externalColor&&e.externalColor[3]>0;return i&&(a||n||r)?!!s||o:i?s?c:o:a||n||r?!!s||o:s?c:o}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.hasNormalTexture=!!this.params.normalTextureId,this.techniqueConfig.hasColorTexture=!!this.params.textureId,this.techniqueConfig.vertexTangents=this.params.vertexTangents,this.techniqueConfig.instanced=!!this.params.instanced,this.techniqueConfig.instancedDoublePrecision=this.params.instancedDoublePrecision,this.techniqueConfig.vvSize=this.params.vvSizeEnabled,this.techniqueConfig.verticalOffset=null!==this.params.verticalOffset,this.techniqueConfig.screenSizePerspective=null!==this.params.screenSizePerspective,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.sliceHighlightDisabled=this.params.sliceHighlightDisabled,this.techniqueConfig.alphaDiscardMode=this.params.textureAlphaMode,this.techniqueConfig.normalsTypeDerivate="screenDerivative"===this.params.normals,this.techniqueConfig.transparent=this.params.transparent,this.techniqueConfig.writeDepth=this.params.writeDepth,this.techniqueConfig.sceneHasOcludees=this.params.sceneHasOcludees,this.techniqueConfig.cullFace=null!=this.params.cullFace?this.params.cullFace:0,this.techniqueConfig.multipassTerrainEnabled=!!t&&t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=!t||t.cullAboveGround,0!==e&&7!==e||(this.techniqueConfig.vertexColors=this.params.vertexColors,this.techniqueConfig.symbolColors=this.params.symbolColors,this.params.treeRendering?this.techniqueConfig.doubleSidedMode=2:this.techniqueConfig.doubleSidedMode=this.params.doubleSided&&"normal"===this.params.doubleSidedType?1:this.params.doubleSided&&"winding-order"===this.params.doubleSidedType?2:0,this.techniqueConfig.instancedColor=!!this.params.instanced&&this.params.instanced.indexOf("color")>-1,this.techniqueConfig.receiveShadows=this.params.receiveShadows&&this.params.shadowMappingEnabled,this.techniqueConfig.receiveAmbientOcclusion=!(!t||!t.ssaoEnabled)&&this.params.receiveSSAO,this.techniqueConfig.vvColor=this.params.vvColorEnabled,this.techniqueConfig.textureAlphaPremultiplied=!!this.params.textureAlphaPremultiplied,this.techniqueConfig.usePBR=this.params.usePBR,this.techniqueConfig.hasMetalnessAndRoughnessTexture=!!this.params.metallicRoughnessTextureId,this.techniqueConfig.hasEmissionTexture=!!this.params.emissiveTextureId,this.techniqueConfig.hasOcclusionTexture=!!this.params.occlusionTextureId,this.techniqueConfig.offsetBackfaces=!(!this.params.transparent||!this.params.offsetTransparentBackfaces),this.techniqueConfig.isSchematic=this.params.usePBR&&this.params.isSchematic,this.techniqueConfig.transparencyPassType=t?t.transparencyPassType:3,this.techniqueConfig.enableOffset=!t||t.camera.relativeElevation<p["e"]),this.techniqueConfig}intersect(e,t,i,r,n,s,c){if(null!==this.params.verticalOffset){const e=r.camera;Object(a["x"])(Q,i[12],i[13],i[14]);let t=null;switch(r.viewingMode){case 1:t=Object(a["s"])(Z,Q);break;case 2:t=Object(a["l"])(Z,W)}let o=0;if(null!==this.params.verticalOffset){const i=Object(a["k"])(X,Q,e.eye),r=Object(a["q"])(i),n=Object(a["f"])(i,i,1/r);let s=null;this.params.screenSizePerspective&&(s=Object(a["i"])(t,n)),o+=Object(l["l"])(e,r,this.params.verticalOffset,s,this.params.screenSizePerspective)}Object(a["f"])(t,t,o),Object(a["y"])($,t,r.transform.inverseRotation),n=Object(a["k"])(N,n,$),s=Object(a["k"])(q,s,$)}Object(l["i"])(e,t,r,n,s,Object(o["g"])(r.verticalOffset),c)}getGLMaterial(e){if(0===e.output||7===e.output||1===e.output||2===e.output||3===e.output||4===e.output)return new U(e)}createBufferWriter(){return new H(this.vertexBufferLayout,this.instanceBufferLayout)}static getVertexBufferLayout(e){const t=e.textureId||e.normalTextureId||e.metallicRoughnessTextureId||e.emissiveTextureId||e.occlusionTextureId,i=Object(s["a"])().vec3f("position").vec3f("normal");return e.vertexTangents&&i.vec4f("tangent"),t&&i.vec2f("uv0"),e.vertexColors&&i.vec4u8("color"),e.symbolColors&&i.vec4u8("symbolColor"),i}static getInstanceBufferLayout(e){let t=Object(s["a"])();return t=e.instancedDoublePrecision?t.vec3f("modelOriginHi").vec3f("modelOriginLo").mat3f("model").mat3f("modelNormal"):t.mat4f("model").mat4f("modelNormal"),e.instanced&&e.instanced.indexOf("color")>-1&&(t=t.vec4f("instanceColor")),e.instanced&&e.instanced.indexOf("featureAttribute")>-1&&(t=t.vec4f("instanceFeatureAttribute")),t}}class U extends c["a"]{constructor(e){const t=e.material;super({...e,...t.params}),this.updateParameters()}updateParameters(e){const t=this.material.params;this.updateTexture(t.textureId),this.technique=t.treeRendering?this.techniqueRep.acquireAndReleaseExisting(F,this.material.getTechniqueConfig(this.output,e),this.technique):this.techniqueRep.acquireAndReleaseExisting(D,this.material.getTechniqueConfig(this.output,e),this.technique)}selectPipelines(){}_updateShadowState(e){e.shadowMappingEnabled!==this.material.params.shadowMappingEnabled&&this.material.setParameterValues({shadowMappingEnabled:e.shadowMappingEnabled})}_updateOccludeeState(e){e.hasOccludees!==this.material.params.sceneHasOcludees&&this.material.setParameterValues({sceneHasOcludees:e.hasOccludees})}ensureParameters(e){0!==this.output&&7!==this.output||(this._updateShadowState(e),this._updateOccludeeState(e)),this.updateParameters(e)}bind(e,t){e.bindProgram(this.technique.program),this.technique.bindPass(e,this.material.params,t),this.bindTexture(e,this.technique.program)}beginSlot(e){return e===(this.material.params.transparent?this.material.params.writeDepth?5:8:3)}getPipelineState(e,t){return this.technique.getPipelineState(t)}}const G=2.1,B={textureId:void 0,initTextureTransparent:!1,isSchematic:!1,usePBR:!1,normalTextureId:void 0,vertexTangents:!1,occlusionTextureId:void 0,emissiveTextureId:void 0,metallicRoughnessTextureId:void 0,emissiveFactor:[0,0,0],mrrFactors:[0,1,.5],ambient:[.2,.2,.2],diffuse:[.8,.8,.8],externalColor:[1,1,1,1],colorMixMode:"multiply",opacity:1,layerOpacity:1,vertexColors:!1,symbolColors:!1,doubleSided:!1,doubleSidedType:"normal",cullFace:void 0,instanced:void 0,instancedDoublePrecision:!1,normals:"default",receiveSSAO:!0,receiveShadows:!0,castShadows:!0,shadowMappingEnabled:!1,verticalOffset:null,screenSizePerspective:null,slicePlaneEnabled:!1,sliceHighlightDisabled:!1,offsetTransparentBackfaces:!1,vvSizeEnabled:!1,vvSizeMinSize:[1,1,1],vvSizeMaxSize:[100,100,100],vvSizeOffset:[0,0,0],vvSizeFactor:[1,1,1],vvSizeValue:[1,1,1],vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],vvSymbolAnchor:[0,0,0],vvSymbolRotationMatrix:Object(n["a"])(),transparent:!1,writeDepth:!0,textureAlphaMode:0,textureAlphaCutoff:u["b"],textureAlphaPremultiplied:!1,sceneHasOcludees:!1,...h["b"]};class H{constructor(e,t){this.vertexBufferLayout=e,this.instanceBufferLayout=t}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get("position").length}write(e,t,i,r){Object(d["c"])(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,i,r)}}const N=Object(r["e"])(),q=Object(r["e"])(),W=Object(r["g"])(0,0,1),Z=Object(r["e"])(),$=Object(r["e"])(),Q=Object(r["e"])(),X=Object(r["e"])()},dd63:function(e,t,i){"use strict";i.d(t,"a",(function(){return o}));var r=i("b2b2"),a=i("3795"),n=i("5a22"),s=i("748f");class o{constructor(e){this.resourceFactory=e,this._resources=null,this._visible=!0,this._attached=!1}destroy(){this._destroyResources()}get object(){return Object(r["k"])(this._resources)?this._resources.object:null}get resources(){return Object(r["k"])(this._resources)?this._resources.external:null}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._syncVisible())}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}recreate(){this.attached&&this._createResources()}recreateGeometry(){if(!this.resourceFactory.recreateGeometry)return void this.recreate();const e=this.resourceFactory.view._stage;if(Object(r["j"])(this._resources)||!e)return;const t=this._resources.object;this._resources.external.forEach(t=>{2===t.type&&e.remove(t)}),t.removeAllGeometries();const i=this.resourceFactory.recreateGeometry(this._resources.external,t,this._resources.layer);e.addMany(i),this._resources.layer.commit()}_createOrDestroyResources(){this._attached?this._resources||this._createResources():this._destroyResources()}_createResources(){this._destroyResources();const e=this.resourceFactory.view._stage;if(!e)return;const t=new s["a"]({isPickable:!1});e.add(t);const i=new n["a"]({castShadow:!1}),r=this.resourceFactory.createResources(i,t);r.forEach(t=>e.add(t)),e.add(i),t.add(i),t.commit(),this._syncVisible();const o=this.resourceFactory.cameraChanged?Object(a["a"])(this.resourceFactory.view.state,"camera",e=>this.resourceFactory.cameraChanged(e)):null;this._resources={layer:t,object:i,external:r,cameraHandle:o}}_destroyResources(){if(Object(r["j"])(this._resources))return;const e=this.resourceFactory.view._stage;null==e||e.remove(this._resources.object),null==e||e.remove(this._resources.layer),this._resources.external.forEach(t=>{null==e||e.remove(t),"dispose"in t&&t.dispose()}),this._resources.object.dispose(),this._resources.cameraHandle&&this._resources.cameraHandle.remove(),this._resources=null}_syncVisible(){Object(r["j"])(this._resources)||(this._resources.object.setVisible(this._visible),this._resources.layer.commit())}}},de47:function(e,t,i){"use strict";i.d(t,"a",(function(){return o}));var r=i("3886"),a=i("501b"),n=i("ee2c"),s=i("b3a9");function o(e,t){const i=e.vertex;e.include(s["a"],t);const o=e.fragment;switch(n["a"].usesSketchLogic(t)&&(i.uniforms.add("uStrokesTextureScale","vec2"),i.uniforms.add("uStrokesLog2Resolution","float"),i.uniforms.add("uStrokeVariants","float"),e.varyings.add("vStrokeUV","vec2"),o.uniforms.add("uStrokesTexture","sampler2D"),o.uniforms.add("uStrokesNormalizationScale","float"),i.code.add(r["a"]`
      void calculateStyleOutputsSketch(float lineLength, UnpackedAttributes unpackedAttributes) {
        vec2 sidenessNorm = unpackedAttributes.sidenessNorm;

        float lineIndex = clamp(ceil(log2(lineLength)), 0.0, uStrokesLog2Resolution);

        vStrokeUV = vec2(exp2(lineIndex) * sidenessNorm.y, lineIndex * uStrokeVariants + variantStroke + 0.5) * uStrokesTextureScale;
        vStrokeUV.x += variantOffset;
      }
    `),e.fragment.include(a["a"]),o.code.add(r["a"]`
      float calculateLineOffsetSketch() {
        float offsetNorm = rgba2float(texture2D(uStrokesTexture, vStrokeUV));
        return (offsetNorm - 0.5) * uStrokesNormalizationScale;
      }

      float calculateLinePressureSketch() {
        return rgba2float(texture2D(uStrokesTexture, vStrokeUV + vec2(0.0, 0.5)));
      }
    `)),t.mode){case 0:i.code.add(r["a"]`
        void calculateStyleOutputs(UnpackedAttributes unpackedAttributes) {}
      `),o.code.add(r["a"]`
        float calculateLineOffset() {
          return 0.0;
        }

        float calculateLinePressure() {
          return 1.0;
        }
      `);break;case 1:i.code.add(r["a"]`
        void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)
        {
          calculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);
        }
      `),o.code.add(r["a"]`
        float calculateLineOffset() {
          return calculateLineOffsetSketch();
        }

        float calculateLinePressure() {
          return calculateLinePressureSketch();
        }
      `);break;case 2:e.varyings.add("vType","float"),i.code.add(r["a"]`
        void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)
        {
          vType = unpackedAttributes.type;

          if (unpackedAttributes.type <= 0.0) {
            calculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);
          }
        }
      `),o.code.add(r["a"]`
        float calculateLineOffset() {
          if (vType <= 0.0) {
            return calculateLineOffsetSketch();
          }
          else {
            return 0.0;
          }
        }

        float calculateLinePressure() {
          if (vType <= 0.0) {
            return calculateLinePressureSketch();
          }
          else {
            return 1.0;
          }
        }
      `)}}},de58:function(e,t,i){"use strict";i.d(t,"a",(function(){return c})),i.d(t,"b",(function(){return o}));var r=i("0b2d"),a=i("e431"),n=i("02f1"),s=i("d0ac");function o(e,t,i,r){return u(e,t,i,h(r,t,i,!0))}function c(e,t,i,r){const n=Object(a["i"])(t,Object(a["k"])(r,i,e));return Object(a["g"])(r,e,Object(a["f"])(r,t,n)),r}const l={dir:Object(r["e"])(),len:0,clip:Object(n["b"])()};function h(e,t,i,r){const n=l;return e?(i&&r&&(n.len=Object(a["p"])(t,i)),Object(a["l"])(n.dir,e)):r?(n.len=Object(a["p"])(t,i),Object(a["k"])(n.dir,i,t),Object(a["f"])(n.dir,n.dir,1/n.len)):(Object(a["k"])(n.dir,i,t),Object(a["s"])(n.dir,n.dir)),n}function d(e,t,i){const r=Object(a["i"])(s["f"].normal(e),i.dir),n=-s["f"].signedDistance(e,t);if(n<0&&r>=0)return!1;if(r>-1e-6&&r<1e-6)return n>0;if((n<0||r<0)&&!(n<0&&r<0))return!0;const o=n/r;return r>0?o<i.clip[1]&&(i.clip[1]=o):o>i.clip[0]&&(i.clip[0]=o),i.clip[0]<=i.clip[1]}function u(e,t,i,r){r.clip[0]=0,r.clip[1]=i?r.len:Number.MAX_VALUE;for(let a=0;a<e.length;a++)if(!d(e[a],t,r))return!1;return!0}},dea3:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i("3886");function a(e){const t=e.fragment;t.uniforms.add("lightingMainDirection","vec3"),t.uniforms.add("lightingMainIntensity","vec3"),t.uniforms.add("lightingFixedFactor","float"),t.code.add(r["a"]`
    vec3 evaluateMainLighting(vec3 normal_global, float shadowing) {
      float dotVal = clamp(-dot(normal_global, lightingMainDirection), 0.0, 1.0);

      // move lighting towards (1.0, 1.0, 1.0) if requested
      dotVal = mix(dotVal, 1.0, lightingFixedFactor);

      return lightingMainIntensity * ((1.0 - shadowing) * dotVal);
    }
  `)}},df3b:function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));class r{constructor(e,t,i){this.coordinateHelper=e,this.targetPoint=t,this.constraint=i}}},df77:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));var r=i("3886"),a=i("d047");function n(e){e.fragment.uniforms.add("lastFrameColorMap","sampler2D"),e.fragment.uniforms.add("reprojectionMat","mat4"),e.fragment.uniforms.add("rpProjectionMat","mat4"),e.fragment.code.add(r["a"]`
  vec2 reprojectionCoordinate(vec3 projectionCoordinate)
  {
    vec4 zw = rpProjectionMat * vec4(0.0, 0.0, -projectionCoordinate.z, 1.0);
    vec4 reprojectedCoord = reprojectionMat * vec4(zw.w * (projectionCoordinate.xy * 2.0 - 1.0), zw.z, zw.w);
    reprojectedCoord.xy /= reprojectedCoord.w;
    return reprojectedCoord.xy*0.5 + 0.5;
  }
  `)}function s(e,t){e.fragment.uniforms.add("nearFar","vec2"),e.fragment.uniforms.add("depthMapView","sampler2D"),e.fragment.uniforms.add("ssrViewMat","mat4"),e.fragment.uniforms.add("invResolutionHeight","float"),e.fragment.include(a["a"]),e.include(n),e.fragment.code.add(r["a"]`
  const int maxSteps = ${t.highStepCount?"150;":"75;"}

  vec4 applyProjectionMat(mat4 projectionMat, vec3 x)
  {
    vec4 projectedCoord =  projectionMat * vec4(x, 1.0);
    projectedCoord.xy /= projectedCoord.w;
    projectedCoord.xy = projectedCoord.xy*0.5 + 0.5;
    return projectedCoord;
  }

  vec3 screenSpaceIntersection(vec3 dir, vec3 startPosition, vec3 viewDir, vec3 normal)
  {
    vec3 viewPos = startPosition;
    vec3 viewPosEnd = startPosition;

    // Project the start position to the screen
    vec4 projectedCoordStart = applyProjectionMat(rpProjectionMat, viewPos);
    vec3  Q0 = viewPos / projectedCoordStart.w; // homogeneous camera space
    float k0 = 1.0/ projectedCoordStart.w;

    // advance the position in the direction of the reflection
    viewPos += dir;

    vec4 projectedCoordVanishingPoint = applyProjectionMat(rpProjectionMat, dir);

    // Project the advanced position to the screen
    vec4 projectedCoordEnd = applyProjectionMat(rpProjectionMat, viewPos);
    vec3  Q1 = viewPos / projectedCoordEnd.w; // homogeneous camera space
    float k1 = 1.0/ projectedCoordEnd.w;

    // calculate the reflection direction in the screen space
    vec2 projectedCoordDir = (projectedCoordEnd.xy - projectedCoordStart.xy);
    vec2 projectedCoordDistVanishingPoint = (projectedCoordVanishingPoint.xy - projectedCoordStart.xy);

    float yMod = min(abs(projectedCoordDistVanishingPoint.y), 1.0);

    float projectedCoordDirLength = length(projectedCoordDir);
    float maxSt = float(maxSteps);

    // normalize the projection direction depending on maximum steps
    // this determines how blocky the reflection looks
    vec2 dP = yMod * (projectedCoordDir)/(maxSt * projectedCoordDirLength);

    // Normalize the homogeneous camera space coordinates
    vec3  dQ = yMod * (Q1 - Q0)/(maxSt * projectedCoordDirLength);
    float dk = yMod * (k1 - k0)/(maxSt * projectedCoordDirLength);

    // initialize the variables for ray marching
    vec2 P = projectedCoordStart.xy;
    vec3 Q = Q0;
    float k = k0;
    float rayStartZ = -startPosition.z; // estimated ray start depth value
    float rayEndZ = -startPosition.z;   // estimated ray end depth value
    float prevEstimateZ = -startPosition.z;
    float rayDiffZ = 0.0;
    float dDepth;
    float depth;
    float rayDiffZOld = 0.0;

    // early outs
    if (dot(normal, dir) < 0.0 || dot(-viewDir, normal) < 0.0)
      return vec3(P, 0.0);

    for(int i = 0; i < maxSteps-1; i++)
    {
      depth = -linearDepthFromTexture(depthMapView, P, nearFar); // get linear depth from the depth buffer

      // estimate depth of the marching ray
      rayStartZ = prevEstimateZ;
      dDepth = -rayStartZ - depth;
      rayEndZ = (dQ.z * 0.5 + Q.z)/ ((dk * 0.5 + k));
      rayDiffZ = rayEndZ- rayStartZ;
      prevEstimateZ = rayEndZ;

      if(-rayEndZ > nearFar[1] || -rayEndZ < nearFar[0] || P.y < 0.0  || P.y > 1.0 )
      {
        return vec3(P, 0.);
      }

      // If we detect a hit - return the intersection point, two conditions:
      //  - dDepth > 0.0 - sampled point depth is in front of estimated depth
      //  - if difference between dDepth and rayDiffZOld is not too large
      //  - if difference between dDepth and 0.025/abs(k) is not too large
      //  - if the sampled depth is not behind far plane or in front of near plane

      if((dDepth) < 0.025/abs(k) + abs(rayDiffZ) && dDepth > 0.0 && depth > nearFar[0] && depth < nearFar[1] && abs(P.y - projectedCoordStart.y) > invResolutionHeight)
      {
          return vec3(P, depth);
      }

      // continue with ray marching
      P += dP;
      Q.z += dQ.z;
      k += dk;
      rayDiffZOld = rayDiffZ;
    }
    return vec3(P, 0.0);
  }
  `)}!function(e){function t(e,t,i){e.setUniform1i("lastFrameColorMap",i.lastFrameColorTextureUnit),t.bindTexture(i.lastFrameColorTexture,i.lastFrameColorTextureUnit),e.setUniformMatrix4fv("reprojectionMat",i.reprojectionMat),e.setUniformMatrix4fv("rpProjectionMat",i.camera.projectionMatrix)}e.bindUniforms=t}(n||(n={})),function(e){function t(e,t,i){i.ssrEnabled&&(e.setUniform1i("depthMapView",i.linearDepthTextureUnit),t.bindTexture(i.linearDepthTexture,i.linearDepthTextureUnit),e.setUniform2fv("nearFar",i.camera.nearFar),e.setUniformMatrix4fv("ssrViewMat",i.camera.viewMatrix),e.setUniform1f("invResolutionHeight",1/i.camera.height),n.bindUniforms(e,t,i))}e.bindUniforms=t}(s||(s={}))},dfaf:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i("3886");function a(e,t){1===t.attributeTextureCoordinates&&(e.attributes.add("uv0","vec2"),e.varyings.add("vuv0","vec2"),e.vertex.code.add(r["a"]`
      void forwardTextureCoordinates() {
        vuv0 = uv0;
      }
    `)),2===t.attributeTextureCoordinates&&(e.attributes.add("uv0","vec2"),e.varyings.add("vuv0","vec2"),e.attributes.add("uvRegion","vec4"),e.varyings.add("vuvRegion","vec4"),e.vertex.code.add(r["a"]`
      void forwardTextureCoordinates() {
        vuv0 = uv0;
        vuvRegion = uvRegion;
      }
    `)),0===t.attributeTextureCoordinates&&e.vertex.code.add(r["a"]`
      void forwardTextureCoordinates() {}
    `)}},e1e0:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i("b50f"),a=i("34f2");class n extends a["a"]{constructor(e,t,i,r=0){super(e),this.origin=t,this.angle=i,this.accumulationType=r}rotate(e,t){this.helper.rotate(e.pos,this.origin,t)}apply(e){this.rotate(e,this.angle)}undo(e){this.rotate(e,-this.angle)}canAccumulate(e){return e instanceof n&&Object(r["e"])(this.origin,e.origin)}accumulate(e,t){const i=1===t.accumulationType;this.rotate(e,i?t.angle-this.angle:t.angle)}accumulateParams(e){const t=1===e.accumulationType;this.angle=t?e.angle:this.angle+e.angle}}},e2e8:function(e,t,i){"use strict";i.r(t),i.d(t,"create",(function(){return o})),i.d(t,"projectGeometry",(function(){return c}));var r=i("1325"),a=i("ce50"),n=i("0224"),s=i("0024");async function o(e=null,t){if(r["a"].geometryServiceUrl)return new(0,(await i.e("chunk-771a1f22").then(i.bind(null,"d44e9"))).default)({url:r["a"].geometryServiceUrl});if(!e)throw new a["a"]("internal:geometry-service-url-not-configured");let s;if(s="portal"in e?e.portal||n["a"].getDefault():e,await s.load({signal:t}),s.helperServices&&s.helperServices.geometry&&s.helperServices.geometry.url)return new(0,(await i.e("chunk-771a1f22").then(i.bind(null,"d44e9"))).default)({url:s.helperServices.geometry.url});throw new a["a"]("internal:geometry-service-url-not-configured")}async function c(e,t,i=null,r){const n=await o(i,r),c=new s["a"];c.geometries=[e],c.outSpatialReference=t;const l=await n.project(c,{signal:r});if(l&&Array.isArray(l)&&1===l.length)return l[0];throw new a["a"]("internal:geometry-service-projection-failed")}},e384:function(e,t,i){"use strict";var r=i("b2b2"),a=i("5e82"),n=i("a803");class s extends a["a"]{constructor(e,t){super(),this.symbol=e,this.convert=t,this.graphics3DSymbol=null,this.referenced=0}getSymbolLayerSize(e){return Object(r["k"])(this.graphics3DSymbol)?this.graphics3DSymbol.getSymbolLayerSize(e):null}get extentPadding(){return Object(r["k"])(this.graphics3DSymbol)?this.graphics3DSymbol.extentPadding:0}async doLoad(e){const t=await this.symbol.fetchSymbol({signal:e});t.id=this.symbol.id,this.graphics3DSymbol=this.convert(t),await this.graphics3DSymbol.load()}createGraphics3DGraphic(e){return Object(r["k"])(this.graphics3DSymbol)?this.graphics3DSymbol.createGraphics3DGraphic(e,this):null}get complexity(){return Object(r["k"])(this.graphics3DSymbol)?this.graphics3DSymbol.complexity:n["e"]}globalPropertyChanged(e,t){return!!Object(r["k"])(this.graphics3DSymbol)&&this.graphics3DSymbol.globalPropertyChanged(e,t)}applyRendererDiff(e,t){return!!Object(r["k"])(this.graphics3DSymbol)&&this.graphics3DSymbol.applyRendererDiff(e,t)}prepareSymbolPatch(e){Object(r["k"])(this.graphics3DSymbol)&&this.graphics3DSymbol.prepareSymbolPatch(e)}updateGeometry(e,t){return!!Object(r["k"])(this.graphics3DSymbol)&&this.graphics3DSymbol.updateGeometry(e,t)}onRemoveGraphic(){}getFastUpdateStatus(){return Object(r["k"])(this.graphics3DSymbol)?this.graphics3DSymbol.getFastUpdateStatus():{loading:1,fast:0,slow:0}}destroy(){Object(r["k"])(this.graphics3DSymbol)&&this.graphics3DSymbol.destroy(),this.graphics3DSymbol=void 0,this.abortLoad()}get destroyed(){return void 0===this.graphics3DSymbol}}t["a"]=s},e4b1:function(e,t,i){"use strict";i.d(t,"a",(function(){return o}));i("c120");var r=i("1c92"),a=i("ae54"),n=i("8c71"),s=i("7c4b");class o extends s["a"]{constructor(e,t,i,r=i){super(),this.triangleCountReportedInDebug=0,this.transforms={dvs:Object(n["b"])(),tileMat3:Object(n["b"])()},this.triangleCount=0,this.key=new a["a"](e),this.bounds=t,this.size=i,this.coordRange=r}destroy(){this.texture&&(this.texture.dispose(),this.texture=null)}get coords(){return this._coords}get bounds(){return this._bounds}set bounds(e){this._coords=[e[0],e[3]],this._bounds=e}setTransform(e,t){const i=t/(e.resolution*e.pixelRatio),a=this.transforms.tileMat3,[n,s]=e.toScreenNoRotation([0,0],this.coords),o=this.size[0]/this.coordRange[0]*i,c=this.size[1]/this.coordRange[1]*i;Object(r["m"])(a,o,0,0,0,c,0,n,s,1),Object(r["j"])(this.transforms.dvs,e.displayViewMat3,a)}}},e508:function(e,t,i){"use strict";i.d(t,"a",(function(){return o})),i.d(t,"b",(function(){return s}));var r=i("3886"),a=i("690a"),n=i("2aad");function s(e){const t=new a["a"];return t.include(n["a"]),t.fragment.uniforms.add("tex","sampler2D"),0===e.function&&(e.hasOpacityFactor?(t.fragment.uniforms.add("opacity","float"),t.fragment.code.add(r["a"]`
      void main() {
        gl_FragColor = texture2D(tex, uv) * opacity;
      }`)):t.fragment.code.add(r["a"]`
      void main() {
        gl_FragColor = texture2D(tex, uv);
      }`)),2===e.function&&t.fragment.code.add(r["a"]`
    void main() {
      gl_FragColor = vec4(1.0 - texture2D(tex, uv).a);
    }`),3===e.function&&(t.fragment.uniforms.add("colorTexture","sampler2D"),t.fragment.uniforms.add("alphaTexture","sampler2D"),t.fragment.uniforms.add("frontFaceTexture","sampler2D"),t.fragment.code.add(r["a"]`
    void main() {
      vec4 srcColor = texture2D(colorTexture, uv);
      float srcAlpha = texture2D(alphaTexture, uv).r;
      vec4 frontFace = texture2D(frontFaceTexture, uv);
      if(srcColor.a <= 1e-5){
        discard;
      }
      gl_FragColor = vec4(mix(srcColor.rgb/srcColor.a, frontFace.rgb, frontFace.a), 1.0 - srcAlpha);
    }`)),t}var o=Object.freeze({__proto__:null,build:s})},e550:function(e,t,i){"use strict";i.d(t,"a",(function(){return c}));var r=i("3886"),a=i("df77"),n=i("d981");function s(e){e.fragment.code.add(r["a"]`
    const float GAMMA = 2.2;
    const float INV_GAMMA = 0.4545454545;

    vec4 delinearizeGamma(vec4 color) {
      return vec4(pow(color.rgb, vec3(INV_GAMMA)), color.w);
    }

    vec3 linearizeGamma(vec3 color) {
      return pow(color, vec3(GAMMA));
    }
  `)}var o=i("5d5f");function c(e,t){e.include(o["a"],t),e.include(s),e.include(n["a"]),t.ssrEnabled&&e.include(a["a"],t),e.fragment.constants.add("fresnelSky","vec3",[.02,1,15]).add("fresnelMaterial","vec2",[.02,.1]).add("roughness","float",.015).add("foamIntensityExternal","float",1.7).add("ssrIntensity","float",.65).add("ssrHeightFadeStart","float",3e5).add("ssrHeightFadeEnd","float",5e5).add("waterDiffusion","float",.775).add("waterSeeColorMod","float",.8).add("correctionViewingPowerFactor","float",.4).add("skyZenitColor","vec3",[.52,.68,.9]).add("skyColor","vec3",[.67,.79,.9]),e.fragment.code.add(r["a"]`
    PBRShadingWater shadingInfo;

    /*
    *   This function is an approximation for the sky gradient reflected
    *   the water surface and describes a combination of two fresnel terms.
    *   @parameter: cosTheta = is the result of max(dot(n,v), 0.0)
    *   @parameter: horizon = the dominant color of the sky horizon
    *   @parameter: cosTheta = the dominant color of the sky zenit
    */
    vec3 getSkyGradientColor(in float cosTheta, in vec3 horizon, in vec3 zenit) {
      float exponent = pow((1.0 - cosTheta), fresnelSky[2]);
      return mix(zenit, horizon, exponent);
    }

    /*
    *   This function determines the water color per pixel.
    *   @parameter: n = normal facing away from the surface
    *   @parameter: v = view direction facing away from the surface.
    *   @parameter: l = light direction facing away from the surface
    *   @parameter: lightIntensity = light intensity, currently between 0...PI
    *   @parameter: localUp = a normal for the general direction of the surface
    *   @parameter: shadow = the amount of shadow at this pixel (0 = no shadow)
    */
    vec3 getSeaColor(in vec3 n, in vec3 v, in vec3 l, vec3 color, in vec3 lightIntensity, in vec3 localUp, in float shadow, float foamIntensity, vec3 positionView) {

      float reflectionHit = 0.;
      vec3 seaWaterColor = linearizeGamma(color);
      // using half vector to determine the specular light
      vec3 h = normalize(l + v);
      shadingInfo.NdotL = clamp(dot(n, l), 0.0, 1.0);
      shadingInfo.NdotV = clamp(dot(n, v), 0.001, 1.0);
      shadingInfo.VdotN = clamp(dot(v, n), 0.001, 1.0);
      shadingInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);
      shadingInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);
      shadingInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);

      // angle between vertex normal and view direction
      float upDotV = max(dot(localUp,v), 0.0);
      // reflected sky color: the reflected sky color consists of two main colors, the
      // reflected color at the horizon and the reflected color of the zenit.
      // the reflected sky color is then an approximation based on the fresnel term.
      vec3 skyHorizon = linearizeGamma(skyColor);
      vec3 skyZenit = linearizeGamma(skyZenitColor);
      vec3 skyColor = getSkyGradientColor(upDotV, skyHorizon, skyZenit );

      // we use the upDotL to smoothen out the
      // reflected color of the water
      float upDotL = max(dot(localUp,l),0.0);

      // The approximated sky color is adjusted according to the sun position.
      // This is done as approximation for e.g. night views.
      float daytimeMod = 0.1 + upDotL * 0.9;
      skyColor *= daytimeMod;

      // If a water surface is in shadow we just use a slight darkening of the
      // water surface expressed with this shadowModifier.
      float shadowModifier = clamp(shadow, 0.8, 1.0);

      // The reflected sky color consists of the fresnel reflection multiplied with the approximated sky color.
      // The shadow is influencing the frensel term to keep the shadow impression for really near views. As long
      // as reflection are absent there is a need to have a slight shadow for depth perception.
      vec3 fresnelModifier = fresnelReflection(shadingInfo.VdotN, vec3(fresnelSky[0]), fresnelSky[1]);
      vec3 reflSky = fresnelModifier * skyColor * shadowModifier;

      // The reflected sea color is the input water color combined with the reflected sky color.
      // The reflected sky color is modified by the incoming light.
      vec3 reflSea = seaWaterColor * mix(skyColor, upDotL * lightIntensity * LIGHT_NORMALIZATION, 2.0 / 3.0) * shadowModifier;

      vec3 specular = vec3(0.0);
      // This prevents the specular light to be rendered when:
      // - sun is behind a polygon (e.g. sundown for elevated polygons where nDotL might be still ok)
      // - viewer is under water (for this localUp is better than n)
      if(upDotV > 0.0 && upDotL > 0.0) {
        // calculate the cook torrance BRDF but with simplified occlusion
        vec3 specularSun = brdfSpecularWater(shadingInfo, roughness, vec3(fresnelMaterial[0]), fresnelMaterial[1]);

        // Normalize light intensity to be between 0...1. Shadow cancels out specular light here
        vec3 incidentLight = lightIntensity * LIGHT_NORMALIZATION * shadow;

        specular = shadingInfo.NdotL * incidentLight * specularSun;
      }

      vec3 foam = vec3(0.0);
      if(upDotV > 0.0) {
        foam = foamIntensity2FoamColor(foamIntensityExternal, foamIntensity, skyZenitColor, daytimeMod);
      }
      `),t.ssrEnabled?e.fragment.code.add(r["a"]`
      // Convert the world position to view position
      vec4 viewPosition = vec4(positionView.xyz, 1.0);
      vec3 viewDir = normalize(viewPosition.xyz);
      vec4 viewNormalVectorCoordinate = ssrViewMat *vec4(n, 0.0);
      vec3 viewNormal = normalize(viewNormalVectorCoordinate.xyz);
      vec4 viewUp = ssrViewMat *vec4(localUp, 0.0);

      // at steeper viewing angles we use more of a vertex normal (in this case up) then the wave normal
      // this removes some artifacts of normal mapping
      float correctionViewingFactor = pow(max(dot(-viewDir, viewUp.xyz), 0.0), correctionViewingPowerFactor);
      vec3 viewNormalCorrected = mix(viewUp.xyz, viewNormal, correctionViewingFactor);

      vec3 reflected = normalize(reflect(viewDir, viewNormalCorrected));

      // perform screen space reflection to detect hit
      vec3 hitCoordinate = screenSpaceIntersection( normalize(reflected), viewPosition.xyz, viewDir, viewUp.xyz);
      vec3 reflectedColor = vec3(0.0);

      // if there is a hit with ssr find reflected color from the reprojeted frame
      if (hitCoordinate.z > 0.0)
      {
        vec2 reprojectedCoordinate = reprojectionCoordinate(hitCoordinate);

        // fade out if there if the hit is near end of Y axis
        vec2 dCoords = smoothstep(0.3, 0.6, abs(vec2(0.5, 0.5) - hitCoordinate.xy));
        float heightMod = smoothstep(ssrHeightFadeEnd, ssrHeightFadeStart, -positionView.z);
        reflectionHit = waterDiffusion * clamp(1.0 - (1.3*dCoords.y), 0.0, 1.0) * heightMod;

        reflectedColor = linearizeGamma(texture2D(lastFrameColorMap, reprojectedCoordinate).xyz)* reflectionHit * fresnelModifier.y * ssrIntensity;
      }
      float seeColorMod =  mix(waterSeeColorMod, waterSeeColorMod*0.5, reflectionHit);
      // combining reflected sky, reflected sea, specular highlight and SSR reflections.
      return tonemapACES((1. - reflectionHit) * reflSky + reflectedColor + reflSea * seeColorMod + specular + foam);
    }
  `):e.fragment.code.add(r["a"]`
      // combining reflected sky, reflected sea, specular highlight and SSR reflections.
      return tonemapACES(reflSky + reflSea * waterSeeColorMod + specular + foam);
    }
  `)}},e66f:function(e,t,i){"use strict";i.d(t,"a",(function(){return A})),i.d(t,"b",(function(){return T})),i.d(t,"c",(function(){return P}));var r=i("2255"),a=i("3886"),n=i("690a"),s=i("d272"),o=i("d047"),c=i("6a07"),l=i("ebd5"),h=i("c6d7"),d=i("c2d1"),u=i("d017"),p=i("bd75"),f=i("dfaf"),m=i("a7d7"),b=i("6d5b"),g=i("bc40"),v=i("7d11"),y=i("0d7a"),O=i("ea4b"),_=i("cd26"),x=i("7304"),j=i("21ed"),w=i("b418"),S=i("6316"),C=i("73d4");const T={position:0,normal:1,normalCompressed:1,color:2,uv0:3,uvRegion:4,componentIndex:5};function P(e){const t=new n["a"];t.include(g["a"],e),t.include(v["a"],e),t.include(b["a"],e),t.include(f["a"],e),t.include(p["a"],e),t.include(x["a"],e),t.include(l["a"],e),t.include(s["a"],e),t.include(C["a"],e),t.include(j["a"],e),t.fragment.uniforms.add("view","mat4"),1!==e.pbrMode&&2!==e.pbrMode||(t.include(m["b"],e),t.include(y["a"],e)),3===e.output&&1===e.componentData?t.vertex.code.add(a["a"]`
      #define discardShadows(castShadows) { if(!castShadows) { gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }
    `):t.vertex.code.add(a["a"]`
      #define discardShadows(castShadows) {}
    `);const i=e.overlayEnabled&&0===e.output&&4===e.pbrMode;return e.overlayEnabled&&(t.include(_["a"],e),1===e.viewingMode?t.vertex.code.add(a["a"]`
      const float invEllipsoidRadius = ${a["a"].float(1/(1===e.ellipsoidMode?r["a"].radius:2===e.ellipsoidMode?r["b"].radius:r["c"].radius))};
      vec2 projectOverlay(vec3 pos) {
        return pos.xy / (1.0 + invEllipsoidRadius * pos.z);
      }
      `):t.vertex.code.add(a["a"]`
      vec2 projectOverlay(vec3 pos) { return pos.xy; }
      `)),i&&(t.varyings.add("tbnTangent","vec3"),t.varyings.add("tbnBiTangent","vec3"),t.varyings.add("groundNormal","vec3"),t.varyings.add("positionView","vec3")),t.vertex.code.add(a["a"]`
    void main() {
      bool castShadows;
      vec4 externalColor = forwardExternalColor(castShadows);
      discardShadows(castShadows);

      vertexDiscardByOpacity(externalColor.a);

      if (externalColor.a < ${a["a"].float(l["c"])}) {
        // Discard this vertex
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }
      forwardPosition();
      forwardNormal();
      ${i?a["a"]`
        positionView = position_view();
        ${1===e.viewingMode?a["a"]`
        groundNormal = normalize(positionWorld());
        tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), groundNormal));
        tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`:a["a"]`
        groundNormal = vec3(0.0, 0.0, 1.0);
        tbnTangent = vec3(1.0, 0.0, 0.0);
        tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`}
        `:""}

      ${e.overlayEnabled?a["a"]`setOverlayVTC(projectOverlay(position));`:""}
      forwardTextureCoordinates();
      forwardVertexColor();
      forwardLinearDepth(); // depends on forwardPosition()
    }
  `),7===e.output&&(t.fragment.include(o["a"]),e.multipassTerrainEnabled&&t.include(h["b"],e),t.include(w["a"],e),t.fragment.code.add(a["a"]`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);
        ${e.multipassTerrainEnabled?a["a"]`terrainDepthTest(gl_FragCoord, vPosition_view.z);`:""}

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${e.overlayEnabled?a["a"]`
        vec4 overlayColorOpaque = getOverlayColor(ovInnerColorTex, ovOuterColorTex, vtcOverlay);
        vec4 overlayColor = overlayOpacity * overlayColorOpaque;
        materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        gl_FragColor = vec4(materialColor.a);
      }
    `)),0===e.output&&(t.fragment.include(o["a"]),e.multipassTerrainEnabled&&t.include(h["b"],e),t.include(w["a"],e),t.include(S["a"],e),t.include(O["a"],e),i&&(t.fragment.uniforms.add("ovInnerNormalTex","sampler2D"),t.fragment.uniforms.add("ovOuterNormalTex","sampler2D")),e.receiveShadows?(t.include(u["a"],e),t.fragment.code.add(a["a"]`
        float evaluateShadow() {
          return readShadowMap(vPositionWorldCameraRelative, linearDepth);
        }
      `)):t.fragment.code.add(a["a"]`
        float evaluateShadow() { return 0.0; }
      `),t.fragment.code.add(a["a"]`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);
        ${e.multipassTerrainEnabled?a["a"]`terrainDepthTest(gl_FragCoord, vPosition_view.z);`:""}

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${e.overlayEnabled?a["a"]`
        vec4 overlayColorOpaque = getOverlayColor(ovInnerColorTex, ovOuterColorTex, vtcOverlay);
        vec4 overlayColor = overlayOpacity * overlayColorOpaque;
        materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}
    `),1===e.pbrMode||2===e.pbrMode?(t.fragment.code.add(a["a"]`
        ${1===e.pbrMode?a["a"]`
        applyPBRFactors();
        if (int(externalColorMixMode) == 3) {
          mrr = vec3(0.0, 0.6, 0.2);
        }`:""}
        vec3 normalVertex = shadingNormalWorld();
        float additionalIrradiance = 0.02 * lightingMainIntensity[2];
      `),e.hasNormalTexture?t.fragment.code.add(a["a"]`
        mat3 tangentSpace = computeTangentSpace(normalVertex, vPositionWorldCameraRelative, vuv0);
        vec3 shadingNormal = computeTextureNormal(tangentSpace, vuv0);
        `):t.fragment.code.add(a["a"]`
        vec3 shadingNormal = normalVertex;
        `),t.fragment.code.add(a["a"]`${1===e.viewingMode?a["a"]`vec3 normalGround = normalize(positionWorld());`:a["a"]`vec3 normalGround = vec3(0.0, 0.0, 1.0);`}
      `),t.fragment.code.add(a["a"]`
        vec3 viewDir = normalize(vPositionWorldCameraRelative);
        float ssao = 1.0 - occlusion * (1.0 - evaluateAmbientOcclusion());
        vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());
        vec4 shadedColor = vec4(evaluateSceneLightingPBR(shadingNormal, materialColor.rgb, evaluateShadow(), ssao, additionalLight, viewDir, normalGround, mrr, emission, additionalIrradiance), materialColor.a);
        `)):(e.receiveShadows?t.fragment.code.add(a["a"]`
      float shadow = evaluateShadow();
        `):1===e.viewingMode?t.fragment.code.add(a["a"]`
      float additionalAmbientScale = _oldHeuristicLighting(positionWorld());
      float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);
        `):t.fragment.code.add(a["a"]`
      float shadow = 0.0;
      `),t.fragment.code.add(a["a"]`
      float ambientOcclusion = evaluateAmbientOcclusion();
      // At global scale we create some additional ambient light based on the main light to simulate global illumination
      vec3 additionalLight = evaluateAdditionalLighting(ambientOcclusion, positionWorld());
      vec4 shadedColor = vec4(evaluateSceneLighting(shadingNormalWorld(), materialColor.rgb, shadow, ambientOcclusion, additionalLight), materialColor.a);
      ${i?a["a"]`
          vec4 overlayWaterMask = getOverlayColor(ovInnerNormalTex, ovOuterNormalTex, vtcOverlay);
          float waterNormalLength = length(overlayWaterMask);
          if (waterNormalLength > 0.95) {
            mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, groundNormal);
            vec4 waterOverlayColor = vec4(overlayColorOpaque.xyz, overlayColor.w);
            vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vPositionWorldCameraRelative), shadow, groundNormal, tbnMatrix, positionView);
            vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
            // un-gamma the ground color to mix in linear space
            shadedColor = mix(shadedColor, waterColorNonLinear, waterColorLinear.w);
          }`:""}
      `)),t.fragment.code.add(a["a"]`
        gl_FragColor = highlightSlice(shadedColor, vPositionWorldCameraRelative);
        ${e.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),1!==e.output&&3!==e.output||(t.include(d["a"],e),t.fragment.code.add(a["a"]`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        outputDepth(linearDepth);
      }
    `)),2===e.output&&(t.include(S["a"],e),t.fragment.code.add(a["a"]`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        // note: the alpha component needs to be 1.0 in order for this material
        // to influence ambient occlusion, see the ssao fragment shader
        float alpha = ${2===e.normalType?"0.0":"1.0"};
        gl_FragColor = vec4(vec3(.5) + .5 * shadingNormal_view(), alpha);
      }
    `)),4===e.output&&(t.include(c["a"]),t.fragment.code.add(a["a"]`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        ${e.overlayEnabled?a["a"]`
        vec4 overlayColor = getCombinedOverlayColor();

        if (overlayColor.a == 0.0) {
          gl_FragColor = vec4(0.0);
          return;
        }`:""}

        outputHighlight();
      }
    `)),t}var A=Object.freeze({__proto__:null,attributeLocations:T,build:P})},e6aa:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i("3886");function a(e,t){e.vertex.uniforms.add("intrinsicWidth","float"),t.vvSize?(e.attributes.add("sizeFeatureAttribute","float"),e.vertex.uniforms.add("vvSizeMinSize","vec3"),e.vertex.uniforms.add("vvSizeMaxSize","vec3"),e.vertex.uniforms.add("vvSizeOffset","vec3"),e.vertex.uniforms.add("vvSizeFactor","vec3"),e.vertex.code.add(r["a"]`
    float getSize() {
      return intrinsicWidth * clamp(vvSizeOffset + sizeFeatureAttribute * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).x;
    }
    `)):(e.attributes.add("size","float"),e.vertex.code.add(r["a"]`
    float getSize(){
      return intrinsicWidth * size;
    }
    `)),t.vvOpacity?(e.attributes.add("opacityFeatureAttribute","float"),e.vertex.constants.add("vvOpacityNumber","int",8),e.vertex.code.add(r["a"]`
    uniform float vvOpacityValues[vvOpacityNumber];
    uniform float vvOpacityOpacities[vvOpacityNumber];

    float interpolateOpacity( float value ){
      if (value <= vvOpacityValues[0]) {
        return vvOpacityOpacities[0];
      }

      for (int i = 1; i < vvOpacityNumber; ++i) {
        if (vvOpacityValues[i] >= value) {
          float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
          return mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f);
        }
      }

      return vvOpacityOpacities[vvOpacityNumber - 1];
    }

    vec4 applyOpacity( vec4 color ){
      return vec4(color.xyz, interpolateOpacity(opacityFeatureAttribute));
    }
    `)):e.vertex.code.add(r["a"]`
    vec4 applyOpacity( vec4 color ){
      return color;
    }
    `),t.vvColor?(e.attributes.add("colorFeatureAttribute","float"),e.vertex.constants.add("vvColorNumber","int",8),e.vertex.code.add(r["a"]`
    uniform float vvColorValues[vvColorNumber];
    uniform vec4 vvColorColors[vvColorNumber];

    vec4 interpolateColor( float value ) {
      if (value <= vvColorValues[0]) {
        return vvColorColors[0];
      }

      for (int i = 1; i < vvColorNumber; ++i) {
        if (vvColorValues[i] >= value) {
          float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
          return mix(vvColorColors[i-1], vvColorColors[i], f);
        }
      }

      return vvColorColors[vvColorNumber - 1];
    }

    vec4 getColor(){
      return applyOpacity(interpolateColor(colorFeatureAttribute));
    }
    `)):(e.attributes.add("color","vec4"),e.vertex.code.add(r["a"]`
    vec4 getColor(){
      return applyOpacity(color);
    }
    `))}},e6b5:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));i("c120");var r=i("e92d"),a=i("6706"),n=i("7dcb");r["a"].getLogger("esri.views.interactive.snapping.hints.LineSnappingHint");class s extends n["a"]{constructor(e,t,i,r=!0,a=!0){super(),this.type=e,this.lineStart=t,this.lineEnd=i,this.fadeLeft=r,this.fadeRight=a}equals(e){return e instanceof s&&this.type===e.type&&Object(a["d"])(this.lineStart,e.lineStart)&&Object(a["d"])(this.lineEnd,e.lineEnd)&&this.fadeLeft===e.fadeLeft&&this.fadeRight===e.fadeRight}}},e6bc:function(e,t,i){"use strict";class r{constructor(e,t,i){this.graphic=e,this.renderingInfo=t,this.layer=i}}t["a"]=r},e746:function(e,t,i){"use strict";class r{constructor(e){this._texture=e,this._refCount=1}retain(){++this._refCount}release(){--this._refCount,0===this._refCount&&this._texture.dispose()}get texture(){return this._texture}generateMipmap(){this._texture.generateMipmap()}get descriptor(){return this._texture.descriptor}}t["a"]=r},e753:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i("6706"),a=i("7dcb");class n extends a["a"]{constructor(e){super(),this.intersectionPoint=e}equals(e){return e instanceof n&&Object(r["d"])(this.intersectionPoint,e.intersectionPoint)}}},e764:function(e,t,i){"use strict";function r(){const e=new Float32Array(4);return e[3]=1,e}function a(e){const t=new Float32Array(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function n(e,t,i,r){const a=new Float32Array(4);return a[0]=e,a[1]=t,a[2]=i,a[3]=r,a}function s(e,t){return new Float32Array(e,t,4)}i.d(t,"a",(function(){return a})),i.d(t,"b",(function(){return r})),i.d(t,"c",(function(){return s}));Object.freeze({__proto__:null,create:r,clone:a,fromValues:n,createView:s})},e9d6:function(e,t,i){"use strict";i.d(t,"a",(function(){return o})),i.d(t,"b",(function(){return l})),i.d(t,"c",(function(){return c})),i.d(t,"d",(function(){return h})),i.d(t,"e",(function(){return u})),i.d(t,"f",(function(){return p})),i.d(t,"g",(function(){return d})),i.d(t,"h",(function(){return f}));var r=i("e92d"),a=i("82fa"),n=i("d3cf");const s=r["a"].getLogger("esri.views.3d.layers.graphics.featureExpressionInfoUtils");function o(e){return{cachedResult:e.cachedResult,arcade:e.arcade?{func:e.arcade.func,context:e.arcade.modules.arcadeUtils.createExecContext(null,{sr:e.arcade.context.spatialReference}),modules:e.arcade.modules}:null}}function c(e){const t=e&&e.expression;if("string"==typeof t){const e=b(t);if(null!=e)return{cachedResult:e}}return null}async function l(e,t,i){const r=e&&e.expression;if("string"!=typeof r)return null;const n=b(r);if(null!=n)return{cachedResult:n};const s=await Object(a["e"])(),o=s.arcadeUtils,c=o.createSyntaxTree(r);return o.dependsOnView(c)?(null!=i&&i.error("Expressions containing '$view' are not supported on ElevationInfo"),{cachedResult:0}):{arcade:{func:o.createFunction(c),context:o.createExecContext(null,{sr:t}),modules:s}}}function h(e,t,i){return e.arcadeUtils.createFeature(t.attributes,t.geometry,i)}function d(e,t){if(null!=e&&!m(e)){if(!t||!e.arcade)return void s.errorOncePerTick("Arcade support required but not provided");const i=t;i._geometry&&(i._geometry=Object(n["b"])(i._geometry)),e.arcade.modules.arcadeUtils.updateExecContext(e.arcade.context,t)}}function u(e){if(null!=e){if(m(e))return e.cachedResult;const t=e.arcade;let i=e.arcade.modules.arcadeUtils.executeFunction(t.func,t.context);return"number"!=typeof i&&(e.cachedResult=0,i=0),i}return 0}function p(e,t=!1){let i=e&&e.featureExpressionInfo;const r=i&&i.expression;return t||"0"===r||(i=null),i}const f={cachedResult:0};function m(e){return null!=e.cachedResult}function b(e){return"0"===e?0:null}},ea44:function(e,t,i){"use strict";i.d(t,"a",(function(){return v})),i.d(t,"b",(function(){return g}));var r=i("3886"),a=i("4db9"),n=i("690a"),s=i("4377"),o=i("d272"),c=i("d047"),l=i("6a07"),h=i("ebd5"),d=i("c6d7"),u=i("d017"),p=i("33e2"),f=i("bd75"),m=i("040b"),b=i("e550");function g(e){const t=new n["a"];return t.include(a["a"],{linearDepth:!1}),t.attributes.add("position","vec3"),t.attributes.add("uv0","vec2"),t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("localOrigin","vec3"),t.vertex.uniforms.add("waterColor","vec4"),0!==e.output&&7!==e.output||(t.include(m["a"],e),t.include(f["a"],e),t.varyings.add("vuv","vec2"),t.varyings.add("vpos","vec3"),t.varyings.add("vnormal","vec3"),t.varyings.add("vtbnMatrix","mat3"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),t.vertex.code.add(r["a"]`
      void main(void) {
        if (waterColor.a < ${r["a"].float(h["c"])}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vuv = uv0;
        vpos = position;

        vnormal = getLocalUp(vpos, localOrigin);
        vtbnMatrix = getTBNMatrix(vnormal);

        ${e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}

        gl_Position = transformPosition(proj, view, vpos);
        ${0===e.output?"forwardLinearDepth();":""}
      }
    `)),e.multipassTerrainEnabled&&(t.fragment.include(c["a"]),t.include(d["b"],e)),7===e.output&&(t.include(o["a"],e),t.fragment.uniforms.add("waterColor","vec4"),t.fragment.code.add(r["a"]`
        void main() {
          discardBySlice(vpos);
          ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}

          gl_FragColor = vec4(waterColor.a);
        }
      `)),0===e.output&&(t.include(p["a"],e),t.include(o["a"],e),e.receiveShadows&&t.include(u["a"],e),t.include(b["a"],e),t.fragment.uniforms.add("waterColor","vec4").add("lightingMainDirection","vec3").add("lightingMainIntensity","vec3").add("camPos","vec3").add("timeElapsed","float").add("view","mat4"),t.fragment.include(s["a"]),t.fragment.code.add(r["a"]`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
        vec3 localUp = vnormal;
        // the created normal is in tangent space
        vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);

        // we rotate the normal according to the tangent-bitangent-normal-Matrix
        vec3 n = normalize(vtbnMatrix * tangentNormalFoam.xyz);
        vec3 v = -normalize(vpos - camPos);
        vec3 l = normalize(-lightingMainDirection);
        float shadow = ${e.receiveShadows?r["a"]`1.0 - readShadowMap(vpos, linearDepth)`:"1.0"};
        vec4 vPosView = view*vec4(vpos, 1.0);
        vec4 final = vec4(getSeaColor(n, v, l, waterColor.rgb, lightingMainIntensity, localUp, shadow, tangentNormalFoam.w, vPosView.xyz), waterColor.w);

        // gamma correction
        gl_FragColor = delinearizeGamma(final);
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
        ${e.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),2===e.output&&(t.include(m["a"],e),t.include(p["a"],e),t.include(o["a"],e),t.varyings.add("vpos","vec3"),t.varyings.add("vuv","vec2"),t.vertex.code.add(r["a"]`
        void main(void) {
          if (waterColor.a < ${r["a"].float(h["c"])}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vuv = uv0;
          vpos = position;

          gl_Position = transformPosition(proj, view, vpos);
        }
    `),t.fragment.uniforms.add("timeElapsed","float"),t.fragment.code.add(r["a"]`
        void main() {
          discardBySlice(vpos);

          // the created normal is in tangent space and foam
          vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);
          tangentNormalFoam.xyz = normalize(tangentNormalFoam.xyz);

          gl_FragColor = vec4((tangentNormalFoam.xyz + vec3(1.0)) * 0.5, tangentNormalFoam.w);
        }
    `)),5===e.output&&(t.varyings.add("vpos","vec3"),t.vertex.code.add(r["a"]`
        void main(void) {
          if (waterColor.a < ${r["a"].float(h["c"])}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vpos = position;
          gl_Position = transformPosition(proj, view, vpos);
        }
    `),t.fragment.uniforms.add("waterColor","vec4"),t.fragment.code.add(r["a"]`
        void main() {
          gl_FragColor = waterColor;
        }
    `)),4===e.output&&(t.include(l["a"]),t.varyings.add("vpos","vec3"),t.vertex.code.add(r["a"]`
      void main(void) {
        if (waterColor.a < ${r["a"].float(h["c"])}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vpos = position;
        gl_Position = transformPosition(proj, view, vpos);
      }
    `),t.include(o["a"],e),t.fragment.code.add(r["a"]`
      void main() {
        discardBySlice(vpos);
        outputHighlight();
      }
    `)),t}var v=Object.freeze({__proto__:null,build:g})},ea4b:function(e,t,i){"use strict";i.d(t,"a",(function(){return h}));var r=i("3886"),a=i("c51b"),n=i("d017"),s=i("5d5f"),o=i("7088");function c(e,t){const i=e.fragment,a=void 0!==t.lightingSphericalHarmonicsOrder?t.lightingSphericalHarmonicsOrder:2;0===a?(i.uniforms.add("lightingAmbientSH0","vec3"),i.code.add(r["a"]`
      vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
        vec3 ambientLight = 0.282095 * lightingAmbientSH0;
        return ambientLight * (1.0 - ambientOcclusion);
      }
    `)):1===a?(i.uniforms.add("lightingAmbientSH_R","vec4"),i.uniforms.add("lightingAmbientSH_G","vec4"),i.uniforms.add("lightingAmbientSH_B","vec4"),i.code.add(r["a"]`
      vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
        vec4 sh0 = vec4(
          0.282095,
          0.488603 * normal.x,
          0.488603 * normal.z,
          0.488603 * normal.y
        );
        vec3 ambientLight = vec3(
          dot(lightingAmbientSH_R, sh0),
          dot(lightingAmbientSH_G, sh0),
          dot(lightingAmbientSH_B, sh0)
        );
        return ambientLight * (1.0 - ambientOcclusion);
      }
    `)):2===a&&(i.uniforms.add("lightingAmbientSH0","vec3"),i.uniforms.add("lightingAmbientSH_R1","vec4"),i.uniforms.add("lightingAmbientSH_G1","vec4"),i.uniforms.add("lightingAmbientSH_B1","vec4"),i.uniforms.add("lightingAmbientSH_R2","vec4"),i.uniforms.add("lightingAmbientSH_G2","vec4"),i.uniforms.add("lightingAmbientSH_B2","vec4"),i.code.add(r["a"]`
      vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
        vec3 ambientLight = 0.282095 * lightingAmbientSH0;

        vec4 sh1 = vec4(
          0.488603 * normal.x,
          0.488603 * normal.z,
          0.488603 * normal.y,
          1.092548 * normal.x * normal.y
        );
        vec4 sh2 = vec4(
          1.092548 * normal.y * normal.z,
          0.315392 * (3.0 * normal.z * normal.z - 1.0),
          1.092548 * normal.x * normal.z,
          0.546274 * (normal.x * normal.x - normal.y * normal.y)
        );
        ambientLight += vec3(
          dot(lightingAmbientSH_R1, sh1),
          dot(lightingAmbientSH_G1, sh1),
          dot(lightingAmbientSH_B1, sh1)
        );
        ambientLight += vec3(
          dot(lightingAmbientSH_R2, sh2),
          dot(lightingAmbientSH_G2, sh2),
          dot(lightingAmbientSH_B2, sh2)
        );
        return ambientLight * (1.0 - ambientOcclusion);
      }
    `),1!==t.pbrMode&&2!==t.pbrMode||i.code.add(r["a"]`
        const vec3 skyTransmittance = vec3(0.9, 0.9, 1.0);

        vec3 calculateAmbientRadiance(float ambientOcclusion)
        {
          vec3 ambientLight = 1.2 * (0.282095 * lightingAmbientSH0) - 0.2;
          return ambientLight *= (1.0 - ambientOcclusion) * skyTransmittance;
        }
      `))}var l=i("dea3");function h(e,t){const i=e.fragment;e.include(l["a"]),e.include(o["a"],t),0!==t.pbrMode&&e.include(s["a"],t),e.include(c,t),t.receiveShadows&&e.include(n["a"],t),i.uniforms.add("lightingGlobalFactor","float"),i.uniforms.add("ambientBoostFactor","float"),e.include(a["a"]),i.code.add(r["a"]`
    const float GAMMA_SRGB = 2.1;
    const float INV_GAMMA_SRGB = 0.4761904;
    ${0===t.pbrMode?"":"const vec3 GROUND_REFLECTANCE = vec3(0.2);"}
  `),t.useOldSceneLightInterface?i.code.add(r["a"]`
    vec3 evaluateSceneLightingExt(vec3 normal, vec3 albedo, float shadow, float ssao, vec3 additionalLight) {
      // evaluate the main light
      #if defined(TREE_RENDERING)
        // Special case for tree rendering:
        // We shift the Lambert lobe to the back, allowing it to reach part of the hemisphere
        // facing away from the light. The idea is to get an effect where light is transmitted
        // through the tree.
        float minDot = -0.5;
        float dotRange = 1.0 - minDot;
        float dotNormalization = 0.66; // guessed & hand tweaked value, for an exact value we could precompute an integral over the sphere

        float dotVal = dotNormalization * (clamp(-dot(normal, lightingMainDirection), 1.0 - dotRange, 1.0) - minDot) * (1.0 / dotRange);
      #else
        float dotVal = clamp(-dot(normal, lightingMainDirection), 0.0, 1.0);
      #endif

      // move lighting towards (1.0, 1.0, 1.0) if requested
      dotVal = mix(dotVal, 1.0, lightingFixedFactor);

      vec3 mainLight = (1.0 - shadow) * lightingMainIntensity * dotVal;
      vec3 ambientLight = calculateAmbientIrradiance(normal, ssao);

      // inverse gamma correction on the albedo color
      vec3 albedoGammaC = pow(albedo, vec3(GAMMA_SRGB));

      // physically correct BRDF normalizes by PI
      vec3 totalLight = mainLight + ambientLight + additionalLight;
      totalLight = min(totalLight, vec3(PI));
      vec3 outColor = vec3((albedoGammaC / PI) * (totalLight));

      // apply gamma correction to the computed color
      outColor = pow(outColor, vec3(INV_GAMMA_SRGB));

      return outColor;
    }
  `):(1===t.viewingMode?i.code.add(r["a"]`
      float _oldHeuristicLighting(vec3 vPosWorld) {
        vec3 shadingNormalWorld = normalize(vPosWorld);
        float vndl = -dot(shadingNormalWorld, lightingMainDirection);

        return smoothstep(0.0, 1.0, clamp(vndl * 2.5, 0.0, 1.0));
      }
    `):i.code.add(r["a"]`
      float _oldHeuristicLighting(vec3 vPosWorld) {
        float vndl = -dot(vec3(0.0, 0.0, 1.0), lightingMainDirection);
        return smoothstep(0.0, 1.0, clamp(vndl * 2.5, 0.0, 1.0));
      }
    `),i.code.add(r["a"]`
      vec3 evaluateAdditionalLighting(float ambientOcclusion, vec3 vPosWorld) {
        float additionalAmbientScale = _oldHeuristicLighting(vPosWorld);
        return (1.0 - ambientOcclusion) * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor * lightingMainIntensity;
      }
    `),0===t.pbrMode||4===t.pbrMode?i.code.add(r["a"]`
      vec3 evaluateSceneLighting(vec3 normalWorld, vec3 baseColor, float mainLightShadow, float ambientOcclusion, vec3 additionalLight)
      {
        vec3 mainLighting = evaluateMainLighting(normalWorld, mainLightShadow);
        vec3 ambientLighting = calculateAmbientIrradiance(normalWorld, ambientOcclusion);
        // inverse gamma correction on the base color
        vec3 baseColorLinear = pow(baseColor, vec3(GAMMA_SRGB));

        // physically correct BRDF normalizes by PI
        vec3 totalLight = mainLighting + ambientLighting + additionalLight;
        totalLight = min(totalLight, vec3(PI));
        vec3 outColor = vec3((baseColorLinear / PI) * totalLight);

        // apply gamma correction to the computed color
        outColor = pow(outColor, vec3(INV_GAMMA_SRGB));

        return outColor;
      }
      `):1!==t.pbrMode&&2!==t.pbrMode||(i.code.add(r["a"]`
      const float fillLightIntensity = 0.25;
      const float horizonLightDiffusion = 0.4;
      const float additionalAmbientIrradianceFactor = 0.02;

      vec3 evaluateSceneLightingPBR(vec3 normal, vec3 albedo, float shadow, float ssao, vec3 additionalLight, vec3 viewDir, vec3 normalGround, vec3 mrr, vec3 _emission, float additionalAmbientIrradiance)
      {
        // Calculate half vector between view and light direction
        vec3 viewDirection = -viewDir;
        vec3 mainLightDirection = -lightingMainDirection;
        vec3 h = normalize(viewDirection + mainLightDirection);

        PBRShadingInfo inputs;
        inputs.NdotL = clamp(dot(normal, mainLightDirection), 0.001, 1.0);
        inputs.NdotV = clamp(abs(dot(normal, viewDirection)), 0.001, 1.0);
        inputs.NdotH = clamp(dot(normal, h), 0.0, 1.0);
        inputs.VdotH = clamp(dot(viewDirection, h), 0.0, 1.0);
        inputs.NdotNG = clamp(dot(normal, normalGround), -1.0, 1.0);
        vec3 reflectedView = normalize(reflect(viewDirection, normal));
        inputs.RdotNG = clamp(dot(reflectedView, normalGround), -1.0, 1.0);

        inputs.albedoLinear = pow(albedo, vec3(GAMMA_SRGB));
        inputs.ssao = ssao;

        inputs.metalness = mrr[0];
        inputs.roughness = clamp(mrr[1] * mrr[1], 0.001, 0.99);
      `),i.code.add(r["a"]`
        inputs.f0 = (0.16 * mrr[2] * mrr[2]) * (1.0 - inputs.metalness) + inputs.albedoLinear * inputs.metalness;
        inputs.f90 = vec3(clamp(dot(inputs.f0, vec3(50.0 * 0.33)), 0.0, 1.0)); // more accurate then using  f90 = 1.0
        inputs.diffuseColor = inputs.albedoLinear * (vec3(1.0) - inputs.f0) * (1.0 - inputs.metalness);
      `),i.code.add(r["a"]`
        vec3 ambientDir = vec3(5.0 * normalGround[1] - normalGround[0] * normalGround[2], - 5.0 * normalGround[0] - normalGround[2] * normalGround[1], normalGround[1] * normalGround[1] + normalGround[0] * normalGround[0]);
        ambientDir = ambientDir != vec3(0.0)? normalize(ambientDir) : normalize(vec3(5.0, -1.0, 0.0));

        inputs.NdotAmbDir = abs(dot(normal, ambientDir));

        // Calculate the irradiance components: sun, fill lights and the sky.
        vec3 mainLightIrradianceComponent  = inputs.NdotL * (1.0 - shadow) * lightingMainIntensity;
        vec3 fillLightsIrradianceComponent = inputs.NdotAmbDir * lightingMainIntensity * fillLightIntensity;
        // calculateAmbientIrradiance for localView and additionalLight for gloabalView
        vec3 ambientLightIrradianceComponent = calculateAmbientIrradiance(normal, ssao) + additionalLight;

        // Assemble the overall irradiance of the sky that illuminates the surface
        inputs.skyIrradianceToSurface    = ambientLightIrradianceComponent + mainLightIrradianceComponent + fillLightsIrradianceComponent ;
        // Assemble the overall irradiance of the ground that illuminates the surface. for this we use the simple model that changes only the sky irradiance by the groundReflectance
        inputs.groundIrradianceToSurface = GROUND_REFLECTANCE * ambientLightIrradianceComponent + mainLightIrradianceComponent + fillLightsIrradianceComponent ;
      `),i.code.add(r["a"]`
        vec3 horizonRingDir = inputs.RdotNG * normalGround - reflectedView;
        vec3 horizonRingH = normalize(viewDirection + horizonRingDir);
        inputs.NdotH_Horizon = dot(normal, horizonRingH);

        vec3 mainLightRadianceComponent  = normalDistribution(inputs.NdotH, inputs.roughness) * lightingMainIntensity * (1.0 - shadow);
        vec3 horizonLightRadianceComponent = normalDistribution(inputs.NdotH_Horizon, min(inputs.roughness + horizonLightDiffusion, 1.0)) * lightingMainIntensity * fillLightIntensity;
        vec3 ambientLightRadianceComponent = calculateAmbientRadiance(ssao) + additionalLight; // calculateAmbientRadiance for localView and additionalLight for gloabalView

        // Assemble the overall radiance of the sky that illuminates the surface
        inputs.skyRadianceToSurface    =  ambientLightRadianceComponent + mainLightRadianceComponent + horizonLightRadianceComponent;
        // Assemble the overall radiance of the ground that illuminates the surface. for this we use the simple model that changes only the sky radince by the groundReflectance
        inputs.groundRadianceToSurface = GROUND_REFLECTANCE * (ambientLightRadianceComponent + horizonLightRadianceComponent) + mainLightRadianceComponent;

        // Calculate average ambient radiance - this is used int the gamut mapping part to deduce the black level that is soft compressed
        inputs.averageAmbientRadiance = ambientLightIrradianceComponent[1] * (1.0 + GROUND_REFLECTANCE[1]);
        `),i.code.add(r["a"]`
        vec3 reflectedColorComponent = evaluateEnvironmentIllumination(inputs);
        vec3 additionalMaterialReflectanceComponent = inputs.albedoLinear * additionalAmbientIrradiance;
        vec3 emissionComponent = pow(_emission, vec3(GAMMA_SRGB));
        vec3 outColorLinear = reflectedColorComponent + additionalMaterialReflectanceComponent + emissionComponent;
        ${2===t.pbrMode?r["a"]`vec3 outColor = pow(max(vec3(0.0), outColorLinear - 0.005 * inputs.averageAmbientRadiance), vec3(INV_GAMMA_SRGB));`:r["a"]`vec3 outColor = pow(blackLevelSoftCompression(outColorLinear, inputs), vec3(INV_GAMMA_SRGB));`}
        return outColor;
      }
    `)))}},eaa4:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i("b50f");class a{constructor(){this._uniforms={proj:[],uShadowMapDistance:[],viewportPixelSz:[],lightingMainDirection:[]}}dispose(){this._uniforms=null}getPrograms(e){return this._uniforms[e]||[]}subscribeProgram(e){for(const t in this._uniforms)e.hasUniform(t)&&this._uniforms[t].push(e)}unsubscribeProgram(e){for(const t in this._uniforms)Object(r["l"])(this._uniforms[t],e)}}},ec13:function(e,t,i){"use strict";i.d(t,"a",(function(){return d})),i.d(t,"b",(function(){return u})),i.d(t,"c",(function(){return p})),i.d(t,"d",(function(){return l}));i("c120");var r=i("b2b2"),a=i("9ef0"),n=i("a915"),s=i("0fc4");function o(e){return"fill"===e.type}function c(e){return"extrude"===e.type}function l(e){return e&&e.enabled&&(c(e)||o(e))&&Object(r["k"])(e.edges)}function h(e){return e&&e.enabled&&e.edges||null}function d(e,t){return u(h(e),t)}function u(e,t){if(Object(r["j"])(e))return null;const i=Object(r["k"])(e.color)?Object(s["g"])(a["a"].toUnitRGBA(e.color)):Object(s["d"])(0,0,0,0),o=Object(n["h"])(e.size),c=Object(n["h"])(e.extensionLength);switch(e.type){case"solid":return p({color:i,size:o,extensionLength:c,...t});case"sketch":return f({color:i,size:o,extensionLength:c,...t});default:return}}function p(e){return{...m,...e,type:"solid"}}function f(e){return{...b,...e,type:"sketch"}}const m={color:Object(s["d"])(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:2},b={color:Object(s["d"])(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:2}},ed70:function(e,t,i){"use strict";i.d(t,"a",(function(){return a})),i.d(t,"b",(function(){return n})),i.d(t,"c",(function(){return s}));var r=i("0fc4");const a=1.2,n=r["b"],s=r["a"]},ee2c:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i("3886"),a=i("6a21");function n(e,t){const i=e.vertex;i.uniforms.add("uDistanceFalloffFactor","float"),i.code.add(r["a"]`
    float distanceBasedPerspectiveFactor(float distance) {
      return clamp(sqrt(uDistanceFalloffFactor / distance), 0.0, 1.0);
    }
  `),i.uniforms.add("uComponentDataTex","sampler2D"),i.uniforms.add("uComponentDataTexInvDim","vec2"),e.attributes.add("componentIndex","float"),i.constants.add("componentColorFieldOffset","float",0),i.constants.add("componentOtherFieldOffset","float",1),i.constants.add("componentFieldCount","float",2),i.constants.add("lineWidthFractionFactor","float",8),i.constants.add("extensionLengthOffset","float",128),i.constants.add("componentTexWidth","float",4096),i.code.add(r["a"]`
    vec2 _componentTextureCoords(float componentIndex, float fieldOffset) {
      float fieldIndex = componentFieldCount * componentIndex + fieldOffset;

      float rowIndex = floor(fieldIndex / componentTexWidth);
      float colIndex = mod(fieldIndex, componentTexWidth);

      vec2 linearIndex = vec2(
        (colIndex + 0.5) / componentTexWidth,
        (rowIndex + 0.5) * uComponentDataTexInvDim.y
      );

      return linearIndex;
    }

    struct ComponentData {
      vec4 color;
      float lineWidth;
      float extensionLength;
      float type;
    };

    ComponentData readComponentData() {
      vec2 colorIndex = _componentTextureCoords(componentIndex, componentColorFieldOffset);
      vec2 otherIndex = _componentTextureCoords(componentIndex, componentOtherFieldOffset);

      vec4 colorValue = texture2D(uComponentDataTex, colorIndex);
      vec4 otherValue = texture2D(uComponentDataTex, otherIndex);

      return ComponentData(
        vec4(colorValue.rgb, colorValue.a * otherValue.w), // otherValue.w stores separate opacity
        otherValue.x * (255.0 / lineWidthFractionFactor),
        otherValue.y * 255.0 - extensionLengthOffset,
        -(otherValue.z * 255.0) + 0.5 // SOLID (=0/255) needs to be > 0.0, SKETCHY (=1/255) needs to be <= 0;
      );
    }
  `),t.legacy?i.code.add(r["a"]`
      vec3 _modelToWorldNormal(vec3 normal) {
        return (uModel * vec4(normal, 0.0)).xyz;
      }

      vec3 _modelToViewNormal(vec3 normal) {
        return (uView * uModel * vec4(normal, 0.0)).xyz;
      }
    `):(i.uniforms.add("uTransformNormal_GlobalFromModel ","mat3"),i.code.add(r["a"]`
      vec3 _modelToWorldNormal(vec3 normal) {
        return uTransformNormal_GlobalFromModel * normal;
      }
    `)),t.silhouette?(e.attributes.add("normalA","vec3"),e.attributes.add("normalB","vec3"),i.code.add(r["a"]`
      vec3 worldNormal() {
        return _modelToWorldNormal(normalize(normalA + normalB));
      }
    `)):(e.attributes.add("normal","vec3"),i.code.add(r["a"]`
      vec3 worldNormal() {
        return _modelToWorldNormal(normal);
      }
    `)),t.legacy?i.code.add(r["a"]`
      vec3 worldFromModelPosition(vec3 position) {
        return (uModel * vec4(position, 1.0)).xyz;
      }

      vec3 viewFromModelPosition(vec3 position) {
        return (uView * vec4(worldFromModelPosition(position), 1.0)).xyz;
      }

      vec4 projFromViewPosition(vec3 position) {
        return uProj * vec4(position, 1.0);
      }
    `):(e.vertex.include(a["a"],t),i.code.add(r["a"]`
      vec3 worldFromModelPosition(vec3 position) {
        vec3 rotatedModelPosition = uTransform_WorldFromModel_RS * position;

        vec3 transform_CameraRelativeFromModel = dpAdd(
          uTransform_WorldFromModel_TL,
          uTransform_WorldFromModel_TH,
          -uTransform_WorldFromView_TL,
          -uTransform_WorldFromView_TH
        );

        return transform_CameraRelativeFromModel + rotatedModelPosition;
      }

      vec3 viewFromModelPosition(vec3 position) {
        return uTransform_ViewFromCameraRelative_RS * worldFromModelPosition(position);
      }

      vec4 projFromViewPosition(vec3 position) {
        return uTransform_ProjFromView * vec4(position, 1.0);
      }
    `)),i.code.add(r["a"]`
    float calculateExtensionLength(float extensionLength, float lineLength) {
      return extensionLength / (log2(max(1.0, 256.0 / lineLength)) * 0.2 + 1.0);
    }
  `)}!function(e){function t(e){return 1===e.mode||2===e.mode}function i(e){return 0===e.mode||2===e.mode}e.usesSketchLogic=t,e.usesSolidLogic=i}(n||(n={}))},ee83:function(e,t,i){"use strict";var r=i("b2b2"),a=i("ce50"),n=i("7f83"),s=i("5996"),o=i("9786"),c=i("3af1"),l=(i("e06a"),i("38a4")),h=i("8048"),d=i("9180"),u=i("8188"),p=i("dff3");const f=12;class m{constructor(e){const t=m.checkUnsupported(e);if(t)throw t;this.spatialReference=e.spatialReference,this._isWebMercator=this.spatialReference.isWebMercator,this._isGCS=Object(u["a"])(this.spatialReference)||Object(n["h"])(this.spatialReference)||Object(n["i"])(this.spatialReference),this.origin=[e.origin.x,e.origin.y],this.pixelSize=e.size[0],this.dpi=e.dpi;const i=e.lods.reduce((function(e,t,i){return t.level<e.min&&(e.min=t.level,e.minIndex=i),e.max=Math.max(e.max,t.level),e}),{min:1/0,minIndex:0,max:-1/0}),r=e.lods[i.minIndex],a=2**r.level;let s=r.resolution*a,o=r.scale*a;this.levels=new Array(i.max+1);for(let n=0;n<this.levels.length;n++)this.levels[n]={resolution:s,scale:o,tileSize:[s*e.size[0],s*e.size[1]]},s/=2,o/=2}clone(){return new m(this.toTileInfo())}toTileInfo(){return new p["a"]({dpi:this.dpi,origin:{x:this.origin[0],y:this.origin[1],spatialReference:this.spatialReference},size:[this.pixelSize,this.pixelSize],spatialReference:this.spatialReference,lods:this.levels.map((e,t)=>({level:t,scale:e.scale,resolution:e.resolution}))})}getExtent(e,t,i,r){const a=this.levels[e],n=a.tileSize[0],s=a.tileSize[1];r[0]=this.origin[0]+i*n,r[2]=r[0]+n,r[3]=this.origin[1]-t*s,r[1]=r[3]-s}convertExtentToRadians(e,t){this._isWebMercator?(t[0]=Object(o["f"])(e[0]),t[1]=Object(o["h"])(e[1]),t[2]=Object(o["f"])(e[2]),t[3]=Object(o["h"])(e[3])):this._isGCS&&(t[0]=Object(l["f"])(e[0]),t[1]=Object(l["f"])(e[1]),t[2]=Object(l["f"])(e[2]),t[3]=Object(l["f"])(e[3]))}getExtentGeometry(e,t,i,r=new c["a"]){return this.getExtent(e,t,i,b),r.spatialReference=this.spatialReference,r.xmin=b[0],r.ymin=b[1],r.xmax=b[2],r.ymax=b[3],r.zmin=void 0,r.zmax=void 0,r}ensureMaxLod(e){if(null==e)return!1;let t=!1;for(;this.levels.length<=e;){const e=this.levels[this.levels.length-1],i=e.resolution/2;this.levels.push({resolution:i,scale:e.scale/2,tileSize:[i*this.pixelSize,i*this.pixelSize]}),t=!0}return t}capMaxLod(e){this.levels.length>e+1&&(this.levels.length=e+1)}getMaxLod(){return this.levels.length-1}scaleAtLevel(e){return this.levels[0].scale/2**e}levelAtScale(e){const t=this.levels[0].scale;return e>=t?0:Math.log(t/e)*Math.LOG2E}resolutionAtLevel(e){return this.levels[0].resolution/2**e}compatibleWith(e){if(!(e instanceof m)){if(m.checkUnsupported(e))return!1;e=new m(e)}if(!e.spatialReference.equals(this.spatialReference))return!1;if(e.pixelSize!==this.pixelSize)return!1;const t=Math.min(this.levels.length,e.levels.length)-1,i=this.levels[t].resolution;let r=.5*i;return!(!Object(l["g"])(e.origin[0],this.origin[0],r)||!Object(l["g"])(e.origin[1],this.origin[1],r))&&(r=.5*i/2**t/this.pixelSize*f,Object(l["g"])(i,e.levels[t].resolution,r))}rootTilesInExtent(e,t=null,i=1/0){const a=this.levels[0].tileSize;if(0===a[0]||0===a[1])return[];m.computeRowColExtent(e,a,this.origin,b);let n=b[1],s=b[3],o=b[0],c=b[2];const l=c-o,h=s-n;if(l*h>i){const e=Math.floor(Math.sqrt(i));h>e&&(n=n+Math.floor(.5*h)-Math.floor(.5*e),s=n+e),l>e&&(o=o+Math.floor(.5*l)-Math.floor(.5*e),c=o+e)}const d=[];for(let r=n;r<s;r++)for(let e=o;e<c;e++)d.push([0,r,e]);return Object(r["k"])(t)&&(t[0]=this.origin[0]+o*a[0],t[1]=this.origin[1]-s*a[1],t[2]=this.origin[0]+c*a[0],t[3]=this.origin[1]-n*a[1]),d}static computeRowColExtent(e,t,i,r){const a=.001*(e[2]-e[0]+(e[3]-e[1]));r[0]=Math.max(0,Math.floor((e[0]+a-i[0])/t[0])),r[2]=Math.max(0,Math.ceil((e[2]-a-i[0])/t[0])),r[1]=Math.max(0,Math.floor((i[1]-e[3]+a)/t[1])),r[3]=Math.max(0,Math.ceil((i[1]-e[1]-a)/t[1]))}static isPowerOfTwo(e){const t=e.lods,i=t[0].resolution*2**t[0].level;return!t.some((function(e){return!Object(l["h"])(e.resolution,i/2**e.level)}))}static hasGapInLevels(e){const t=e.lods.map((function(e){return e.level}));t.sort((function(e,t){return e-t}));for(let i=1;i<t.length;i++)if(t[i]!==t[0]+i)return!0;return!1}static tileSizeSupported(e){const t=e.size[1];return t===e.size[0]&&0==(t&t-1)&&t>=128&&t<=512}static checkUnsupported(e){return e?e.lods.length<1?new a["a"]("tilingscheme:generic","Tiling scheme must have at least one level"):m.isPowerOfTwo(e)?m.hasGapInLevels(e)?new a["a"]("tilingscheme:gaps","Tiling scheme levels must not have gaps between min and max level"):m.tileSizeSupported(e)?null:new a["a"]("tilingscheme:tile-size","Tiles must be square and size must be one of [128, 256, 512]"):new a["a"]("tilingscheme:power-of-two","Tiling scheme must be power of two"):new a["a"]("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}static fromExtent(e,t){const i=e[2]-e[0],r=e[3]-e[1],a=Object(h["e"])(t),n=1.2*Math.max(i,r),s=256,o=96,c=.0254,l=new m(new p["a"]({size:[s,s],origin:{x:e[0]-.5*(n-i),y:e[3]+.5*(n-r)},lods:[{level:0,resolution:n/s,scale:1/(s/o*c/(n*a))}],spatialReference:t}));return l.ensureMaxLod(20),l}static makeWebMercatorAuxiliarySphere(e){const t=new m(m.WebMercatorAuxiliarySphereTileInfo);return t.ensureMaxLod(e),t}static makeGCSWithTileSize(e,t=256,i=16){const r=256/t,a=new m(new p["a"]({size:[t,t],origin:{x:-180,y:90,spatialReference:e},spatialReference:e,lods:[{level:0,resolution:.703125*r,scale:295497598.570834*r}]}));return a.ensureMaxLod(i),a}get test(){return{isWebMercator:this._isWebMercator,isGCS:this._isGCS}}}m.WebMercatorAuxiliarySphereTileInfo=new p["a"]({size:[256,256],origin:{x:-20037508.342787,y:20037508.342787,spatialReference:s["a"].WebMercator},spatialReference:s["a"].WebMercator,lods:[{level:0,resolution:156543.03392800014,scale:591657527.591555}]}),m.WebMercatorAuxiliarySphere=m.makeWebMercatorAuxiliarySphere(19);const b=Object(d["l"])();t["a"]=m},f0b9:function(e,t,i){"use strict";function r(e){return 32+e.length}function a(){return 16}function n(e){if(!e)return 0;let t=32;for(const i in e)if(e.hasOwnProperty(i)){const n=e[i];switch(typeof n){case"string":t+=r(n);break;case"number":t+=a();break;case"boolean":t+=4}}return t}function s(e,t){return 32+e.length*t}i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return s})),i.d(t,"c",(function(){return a})),i.d(t,"d",(function(){return r}))},f20e:function(e,t,i){"use strict";i.r(t);var r=i("a4ee"),a=(i("c120"),i("b2b2")),n=i("e92d"),s=(i("cea0"),i("59b2")),o=i("afcf"),c=i("d386"),l=i("ce50"),h=i("e041"),d=(i("8eed"),i("f402"),i("f4cc")),u=i("2eab"),p=i("a6a3"),f=i("e694"),m=i("e64d"),b=i("22f4"),g=i("b911"),v=i("3d59"),y=i("0db5"),O=i("b485"),_=i("d378");const x=n["a"].getLogger("esri.layers.ElevationLayer");let j=class extends(Object(O["a"])(Object(v["a"])(Object(g["a"])(Object(y["a"])(Object(f["a"])(p["a"])))))){constructor(...e){super(...e),this.copyright=null,this.heightModelInfo=null,this.path=null,this.opacity=1,this.operationalLayerType="ArcGISTiledElevationServiceLayer",this.sourceJSON=null,this.type="elevation",this.url=null,this.version=null,this._lercDecoder=Object(_["a"])()}normalizeCtorArgs(e,t){return"string"==typeof e?{url:e,...t}:e}destroy(){Object(_["b"])(this._lercDecoder),this._lercDecoder=null}set minScale(e){this.constructed&&x.warn(this.declaredClass+".minScale support has been removed (since 4.5)")}get minScale(){}set maxScale(e){this.constructed&&x.warn(this.declaredClass+".maxScale support has been removed (since 4.5)")}get maxScale(){}readVersion(e,t){let i=t.currentVersion;return i||(i=9.3),i}load(e){const t=Object(a["k"])(e)?e.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["Image Service"],supportsData:!1,validateItem:e=>{for(let t=0;t<e.typeKeywords.length;t++)if("elevation 3d layer"===e.typeKeywords[t].toLowerCase())return!0;throw new l["a"]("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}' ",{type:"Image Service",expectedType:"Image Service Elevation 3D Layer"})}},e).then(()=>this._fetchImageService(t),()=>this._fetchImageService(t))),Promise.resolve(this)}fetchTile(e,t,i,r){const n=Object(a["k"])((r=r||{signal:null}).signal)?r.signal:r.signal=Object(d["e"])().signal,s={responseType:"array-buffer",signal:n},o={noDataValue:r.noDataValue,returnFileInfo:!0};return this.load().then(()=>this._fetchTileAvailability(e,t,i,r)).then(()=>Object(u["default"])(this.getTileUrl(e,t,i),s)).then(e=>this._lercDecoder.decode(e.data,o,n)).then(e=>({values:e.pixelData,width:e.width,height:e.height,maxZError:e.fileInfo.maxZError,noDataValue:e.noDataValue,minValue:e.minValue,maxValue:e.maxValue}))}getTileUrl(e,t,i){const r=!this.tilemapCache&&this.supportsBlankTile,a=Object(h["D"])({...this.parsedUrl.query,blankTile:!r&&null});return`${this.parsedUrl.path}/tile/${e}/${t}/${i}${a?"?"+a:""}`}async queryElevation(e,t){const{ElevationQuery:r}=await i.e("chunk-c6bbf30e").then(i.bind(null,"2df6"));return Object(d["w"])(t),(new r).query(this,e,t)}async createElevationSampler(e,t){const{ElevationQuery:r}=await i.e("chunk-c6bbf30e").then(i.bind(null,"2df6"));return Object(d["w"])(t),(new r).createSampler(this,e,t)}_fetchTileAvailability(e,t,i,r){return this.tilemapCache?this.tilemapCache.fetchAvailability(e,t,i,r):Promise.resolve("unknown")}async _fetchImageService(e){if(this.sourceJSON)return this.sourceJSON;const t={query:{f:"json",...this.parsedUrl.query},responseType:"json",signal:e},i=await Object(u["default"])(this.parsedUrl.path,t);i.ssl&&(this.url=this.url.replace(/^http:/i,"https:")),this.sourceJSON=i.data,this.read(i.data,{origin:"service",url:this.parsedUrl})}};Object(r["a"])([Object(s["b"])({json:{read:{source:"copyrightText"}}})],j.prototype,"copyright",void 0),Object(r["a"])([Object(s["b"])({readOnly:!0,type:m["a"]})],j.prototype,"heightModelInfo",void 0),Object(r["a"])([Object(s["b"])({type:String,json:{origins:{"web-scene":{read:!0,write:!0}},read:!1}})],j.prototype,"path",void 0),Object(r["a"])([Object(s["b"])({type:["show","hide"]})],j.prototype,"listMode",void 0),Object(r["a"])([Object(s["b"])({json:{read:!1,write:!1,origins:{service:{read:!1,write:!1},"portal-item":{read:!1,write:!1},"web-document":{read:!1,write:!1}}}})],j.prototype,"minScale",null),Object(r["a"])([Object(s["b"])({json:{read:!1,write:!1,origins:{service:{read:!1,write:!1},"portal-item":{read:!1,write:!1},"web-document":{read:!1,write:!1}}}})],j.prototype,"maxScale",null),Object(r["a"])([Object(s["b"])({json:{read:!1,write:!1,origins:{"web-document":{read:!1,write:!1}}}})],j.prototype,"opacity",void 0),Object(r["a"])([Object(s["b"])({type:["ArcGISTiledElevationServiceLayer"]})],j.prototype,"operationalLayerType",void 0),Object(r["a"])([Object(s["b"])()],j.prototype,"sourceJSON",void 0),Object(r["a"])([Object(s["b"])({json:{read:!1},value:"elevation",readOnly:!0})],j.prototype,"type",void 0),Object(r["a"])([Object(s["b"])(b["n"])],j.prototype,"url",void 0),Object(r["a"])([Object(s["b"])()],j.prototype,"version",void 0),Object(r["a"])([Object(o["a"])("version",["currentVersion"])],j.prototype,"readVersion",null),j=Object(r["a"])([Object(c["a"])("esri.layers.ElevationLayer")],j);var w=j;t["default"]=w},f33e:function(e,t,i){"use strict";i.d(t,"a",(function(){return c})),i.d(t,"b",(function(){return s})),i.d(t,"c",(function(){return o})),i.d(t,"d",(function(){return a})),i.d(t,"e",(function(){return n}));var r=i("b50f");function a(e){const t=[];return e.levels.forEach(e=>{e.components.forEach(e=>{t.push(e.material)})}),Object(r["p"])(t)}function n(e){const t=[];return e.levels.forEach(e=>{e.components.forEach(e=>{e.textures&&t.push(...e.textures)})}),Object(r["p"])(t)}function s(e){const t=[];return e.components.forEach(e=>{t.push(e.geometry)}),Object(r["p"])(t)}function o(e){const t=[];return e.levels.forEach(e=>{e.components.forEach(e=>{t.push(e.geometry)})}),Object(r["p"])(t)}function c(e){return s(e).reduce((e,t)=>e+t.indexCount/3,0)}},f408:function(e,t,i){"use strict";i.d(t,"a",(function(){return u})),i.d(t,"b",(function(){return p})),i.d(t,"c",(function(){return n})),i.d(t,"d",(function(){return c})),i.d(t,"e",(function(){return o})),i.d(t,"f",(function(){return d})),i.d(t,"g",(function(){return l}));var r=i("b2b2"),a=i("8076");function n(e,t){return Object(r["j"])(t)||!t.mode?e?"absolute-height":"on-the-ground":t.mode}function s(e,t){return n(!!Object(r["k"])(e)&&e.hasZ,t)}function o(e){const t=h(e);return s(e.geometry,t)}function c(e){const t=h(e),i=s(e.geometry,t);return{mode:i,offset:Object(r["k"])(t)&&"on-the-ground"!==i?Object(r["u"])(t.offset,0)*Object(a["a"])(Object(r["u"])(t.unit,"meters")):0}}function l(e){if("on-the-ground"===o(e))return!1;const t=h(e),i=Object(r["k"])(t)&&t.featureExpressionInfo?t.featureExpressionInfo.expression:null;return!(!i||"0"===i)}function h(e){return e.layer&&"elevationInfo"in e.layer?e.layer.elevationInfo:null}function d(e,t,i){if(Object(r["j"])(i)||!i.mode)return;const a=e.hasZ?e.z:0,n=Object(r["k"])(i.offset)?i.offset:0;switch(i.mode){case"absolute-height":return a-n;case"on-the-ground":return 0;case"relative-to-ground":return a-(Object(r["u"])(t.elevationProvider.getElevation(e.x,e.y,e.z,e.spatialReference,"ground"),0)+n);case"relative-to-scene":return a-(Object(r["u"])(t.elevationProvider.getElevation(e.x,e.y,e.z,e.spatialReference,"scene"),0)+n)}}function u(e,t,i,r=null){return f(e,t.x,t.y,t.hasZ?t.z:0,t.spatialReference,i,r)}function p(e,t,i,r,a=null){return f(e,t[0],t[1],t.length>2?t[2]:0,i,r,a)}function f(e,t,i,a,n,s,o=null){if(Object(r["j"])(s))return;const c=Object(r["k"])(o)?o.mode:"absolute-height";return"on-the-ground"===c?0:b(m(t,i,a,n,e,s),t,i,a,n,e,o,c)}function m(e,t,i,a,n,s){const o=Object(r["k"])(s.offset)?s.offset:0;switch(s.mode){case"absolute-height":return i+o;case"on-the-ground":return Object(r["u"])(n.elevationProvider.getElevation(e,t,0,a,"ground"),0);case"relative-to-ground":return i+Object(r["u"])(n.elevationProvider.getElevation(e,t,i,a,"ground"),0)+o;case"relative-to-scene":return i+Object(r["u"])(n.elevationProvider.getElevation(e,t,i,a,"scene"),0)+o}}function b(e,t,i,a,n,s,o,c){const l=Object(r["k"])(o)&&Object(r["k"])(o.offset)?o.offset:0;switch(c){case"absolute-height":return e-l;case"relative-to-ground":return e-(Object(r["u"])(s.elevationProvider.getElevation(t,i,a,n,"ground"),0)+l);case"relative-to-scene":return e-(Object(r["u"])(s.elevationProvider.getElevation(t,i,a,n,"scene"),0)+l)}}},f498:function(e,t,i){"use strict";i.d(t,"a",(function(){return O})),i.d(t,"b",(function(){return _}));var r=i("a4ee"),a=i("c3a4"),n=i("ca98"),s=i("da35"),o=i("fa1e"),c=i("8e37"),l=i("189c"),h=i("8e97"),d=i("8dd3"),u=i("d272"),p=i("6a07"),f=i("7438"),m=i("c6d7"),b=i("d017"),g=i("df77"),v=i("33e2"),y=i("ea44");class O extends n["a"]{constructor(e,t){super(e,t),this.waterTextureRepository=e.waterTextureRepository}initializeProgram(e){const t=O.shader.get(),i=this.configuration,r=t.build({OITEnabled:0===i.transparencyPassType,output:i.output,viewingMode:e.viewingMode,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,receiveShadows:i.receiveShadows,pbrMode:3,useCustomDTRExponentForWater:!0,ssrEnabled:i.useSSR,highStepCount:!0,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new c["a"](e.rctx,r.generateSource("vertex"),r.generateSource("fragment"),o["a"])}ensureResource(e){return this.waterTextureRepository.ready||this.waterTextureRepository.updating||this.waterTextureRepository.loadTextures(e),this.waterTextureRepository.ready?2:1}bindPass(e,t,i){h["a"].bindProjectionMatrix(this.program,i.camera.projectionMatrix),i.multipassTerrainEnabled&&(this.program.setUniform2fv("cameraNearFar",i.camera.nearFar),this.program.setUniform2fv("inverseViewport",i.inverseViewport),Object(m["a"])(this.program,e,i)),0===this.configuration.output&&(i.lighting.setUniforms(this.program,!1),g["a"].bindUniforms(this.program,e,i)),0!==this.configuration.output&&2!==this.configuration.output||(v["a"].bindUniforms(this.program,t),this.waterTextureRepository.bindRepo(e)),this.program.setUniform4fv("waterColor",t.color),4===this.configuration.output&&p["a"].bindOutputHighlight(e,this.program,i)}bindDraw(e){h["a"].bindView(this.program,e),0!==this.configuration.output&&7!==this.configuration.output||h["a"].bindCamPosition(this.program,e.origin,e.camera.viewInverseTransposeMatrix),0===this.configuration.output&&b["a"].bindUniforms(this.program,e,d["a"].SHADOW_MAP),0!==this.configuration.output&&7!==this.configuration.output&&4!==this.configuration.output||u["a"].bindUniformsWithOrigin(this.program,this.configuration,e)}setPipelineState(e){const t=this.configuration,i=3===e,r=2===e;return Object(l["e"])({blending:2!==t.output&&4!==t.output&&t.transparent?i?f["f"]:Object(f["a"])(e):null,depthTest:{func:Object(f["b"])(e)},depthWrite:i?t.writeDepth&&l["d"]:Object(f["c"])(e),colorWrite:l["c"],polygonOffset:i||r?null:Object(f["g"])(t.enableOffset)})}initializePipeline(){return this.setPipelineState(this.configuration.transparencyPassType)}}O.shader=new a["a"](y["a"],()=>i.e("chunk-2d0a5169").then(i.bind(null,"08e0")));class _ extends s["a"]{constructor(){super(...arguments),this.output=0,this.receiveShadows=!1,this.slicePlaneEnabled=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!1,this.useSSR=!1,this.isDraped=!1,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!0}}Object(r["a"])([Object(s["b"])({count:8})],_.prototype,"output",void 0),Object(r["a"])([Object(s["b"])()],_.prototype,"receiveShadows",void 0),Object(r["a"])([Object(s["b"])()],_.prototype,"slicePlaneEnabled",void 0),Object(r["a"])([Object(s["b"])()],_.prototype,"transparent",void 0),Object(r["a"])([Object(s["b"])()],_.prototype,"enableOffset",void 0),Object(r["a"])([Object(s["b"])()],_.prototype,"writeDepth",void 0),Object(r["a"])([Object(s["b"])()],_.prototype,"useSSR",void 0),Object(r["a"])([Object(s["b"])()],_.prototype,"isDraped",void 0),Object(r["a"])([Object(s["b"])({count:4})],_.prototype,"transparencyPassType",void 0),Object(r["a"])([Object(s["b"])()],_.prototype,"multipassTerrainEnabled",void 0),Object(r["a"])([Object(s["b"])()],_.prototype,"cullAboveGround",void 0)},f53a:function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));class r{constructor(e){this._attached=!1,this._resourcesCreated=!1,this._visible=!0,this.view=e,this.view.watch("ready",e=>{this._resourcesCreated&&(e?this._createResources():this._destroyResources())})}applyProps(e){let t=!1;for(const i in e)i in this?"attached"===i?t=e[i]:this[i]=e[i]:console.error("Cannot set unknown property",i);this.attached=t}destroy(){this.attached=!1}get attached(){return this._attached}set attached(e){e!==this._attached&&this.view._stage&&(this._attached=e,this._attached&&!this._resourcesCreated?this._createResources():!this._attached&&this._resourcesCreated&&this._destroyResources())}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this.attached&&this.updateVisibility(e))}_createResources(){this.createResources(),this._resourcesCreated=!0,this.visible||this.updateVisibility(!1)}_destroyResources(){this.destroyResources(),this._resourcesCreated=!1}}},f6ac:function(e,t,i){"use strict";i.d(t,"a",(function(){return p})),i.d(t,"b",(function(){return l}));var r=i("3886"),a=i("690a"),n=i("4377"),s=i("2f00"),o=i("2eb0"),c=i("7697");function l(e){const t=new a["a"];return t.include(s["a"]),t.include(c["a"]),t.include(o["a"]),0===e.output?d(t,e.applyColormap):1===e.output?h(t):2===e.output&&u(t,e.applyColormap),t}function h(e){e.fragment.code.add(r["a"]`
      void main() {
        // get pixel location
        vec2 pixelLocation = getPixelLocation(v_texcoord);
        if (isOutside(pixelLocation)) {
          gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
          return;
        }

        vec4 currentPixel = getPixel(pixelLocation);
        // apply colormap we use float texture here
        gl_FragColor = colormap(currentPixel, true);
      }
    `)}function d(e,t){e.fragment.uniforms.add("u_bandCount","int"),e.fragment.uniforms.add("u_minCutOff","float",3),e.fragment.uniforms.add("u_maxCutOff","float",3),e.fragment.uniforms.add("u_factor","float",3),e.fragment.uniforms.add("u_minOutput","float"),e.fragment.uniforms.add("u_maxOutput","float"),e.fragment.uniforms.add("u_useGamma","bool"),e.fragment.uniforms.add("u_gamma","float",3),e.fragment.uniforms.add("u_gammaCorrection","float",3),e.fragment.code.add(r["a"]`
      float stretchOneValue(float val, float minCutOff, float maxCutOff, float minOutput, float maxOutput, float factor, bool useGamma, float gamma, float gammaCorrection) {
        // clamp values
        if (val >= maxCutOff) {
          return maxOutput;
        } else if (val <= minCutOff) {
          return minOutput;
        }

        // stretch a single value based on whether to use gamma
        float stretchedVal;
        if (useGamma) {
          float tempf = 1.0;
          float outRange = maxOutput - minOutput;
          float relativeVal = (val - minCutOff) / (maxCutOff - minCutOff);
          if (gamma > 1.0) {
            tempf -= pow(1.0 / outRange, relativeVal * gammaCorrection);
          }
          stretchedVal = (tempf * outRange * pow(relativeVal, 1.0 / gamma) + minOutput) / 255.0;
        } else {
          stretchedVal = minOutput + (val - minCutOff) * factor;
        }
        return stretchedVal;
      }
    `);const i=t?r["a"]`gl_FragColor = colormap(vec4(grayVal, grayVal, grayVal, currentPixel.a), !u_useGamma);`:r["a"]`gl_FragColor = vec4(grayVal, grayVal, grayVal, 1.0) * currentPixel.a * u_opacity;`;e.fragment.code.add(r["a"]`
      void main() {
        vec2 pixelLocation = getPixelLocation(v_texcoord);
        if (isOutside(pixelLocation)) {
          gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
          return;
        }

        vec4 currentPixel = getPixel(pixelLocation);
        if (currentPixel.a == 0.0) {
          gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
          return;
        }

        if (u_bandCount == 1) {
          float grayVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          ${i}
        } else {
          float redVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          float greenVal = stretchOneValue(currentPixel.g, u_minCutOff[1], u_maxCutOff[1], u_minOutput, u_maxOutput, u_factor[1], u_useGamma, u_gamma[1], u_gammaCorrection[1]);
          float blueVal = stretchOneValue(currentPixel.b, u_minCutOff[2], u_maxCutOff[2], u_minOutput, u_maxOutput, u_factor[2], u_useGamma, u_gamma[2], u_gammaCorrection[2]);
          gl_FragColor = vec4(redVal, greenVal, blueVal, 1.0) * currentPixel.a * u_opacity;
        }
      }
    `)}function u(e,t){e.fragment.uniforms.add("u_hillshadeType","int"),e.fragment.uniforms.add("u_sinZcosAs","float",6),e.fragment.uniforms.add("u_sinZsinAs","float",6),e.fragment.uniforms.add("u_cosZs","float",6),e.fragment.uniforms.add("u_weights","float",6),e.fragment.uniforms.add("u_factor","vec2"),e.fragment.uniforms.add("u_applyColormap","bool"),e.fragment.uniforms.add("u_minValue","float"),e.fragment.uniforms.add("u_maxValue","float"),e.fragment.uniforms.add("u_srcImageSize","vec2"),e.fragment.include(n["a"]),e.fragment.code.add(r["a"]`
  vec4 overlay(float val, float minValue, float maxValue, float hillshade, float alpha) {
    val = clamp((val - minValue) / (maxValue - minValue), 0.0, 1.0);
    vec4 rgb = colormap(vec4(val, val, val, 1.0), false);
    vec3 hsv = rgb2hsv(rgb.xyz);
    hsv.z = hillshade;
    return vec4(hsv2rgb(hsv) * alpha, alpha);
  }
`),e.fragment.code.add(r["a"]`
    float getNeighborHoodAlpha(float a, float b, float c, float d, float e, float f, float g, float h, float i){
      if (a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0) {
        return 0.0;
      }  else {
        return e;
      }
    }
  `);const i=t?r["a"]`gl_FragColor = overlay(ve.r, u_minValue, u_maxValue, hillshade, alpha);`:r["a"]`
       hillshade *= alpha;
       gl_FragColor = vec4(hillshade, hillshade, hillshade, alpha);
       `;e.fragment.code.add(r["a"]`
    void main() {
      vec2 pixelLocation = getPixelLocation(v_texcoord);
      if (isOutside(pixelLocation)) {
        gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
        return;
      }

      vec4 currentPixel = getPixel(pixelLocation);
      if (currentPixel.a == 0.0) {
        gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
        return;
      }

      //mirror edge pixels
      vec2 axy = vec2(-1.0, -1.0);
      vec2 bxy = vec2(0.0, -1.0);
      vec2 cxy = vec2(1.0, -1.0);
      vec2 dxy = vec2(-1.0, 0.0);
      vec2 fxy = vec2(1.0, 0.0);
      vec2 gxy = vec2(-1.0, 1.0);
      vec2 hxy = vec2(0.0, 1.0);
      vec2 ixy = vec2(1.0, 1.0);
      vec2 onePixel = 1.0 / u_srcImageSize;
      if (pixelLocation.s < onePixel.s) {
        axy[0] = 1.0;
        dxy[0] = 1.0;
        gxy[0] = 1.0;
      }
      if (pixelLocation.t < onePixel.t) {
        axy[1] = 1.0;
        bxy[1] = 1.0;
        cxy[1] = 1.0;
      }
      if (pixelLocation.s > 1.0 - onePixel.s) {
        cxy[0] = -1.0;
        fxy[0] = -1.0;
        ixy[0] = -1.0;
      }
      if (pixelLocation.t > 1.0 - onePixel.t) {
        gxy[1] = -1.0;
        hxy[1] = -1.0;
        ixy[1] = -1.0;
      }

      // calculate hillshade
      vec4 va = texture2D(u_image, pixelLocation + onePixel * axy);
      vec4 vb = texture2D(u_image, pixelLocation + onePixel * bxy);
      vec4 vc = texture2D(u_image, pixelLocation + onePixel * cxy);
      vec4 vd = texture2D(u_image, pixelLocation + onePixel * dxy);
      vec4 ve = texture2D(u_image, pixelLocation);
      vec4 vf = texture2D(u_image, pixelLocation + onePixel * fxy);
      vec4 vg = texture2D(u_image, pixelLocation + onePixel * gxy);
      vec4 vh = texture2D(u_image, pixelLocation + onePixel * hxy);
      vec4 vi = texture2D(u_image, pixelLocation + onePixel * ixy);

      // calculate the rate of z change along the x, y, and diagonal direction
      float dzx = (vc + 2.0 * vf + vi - va - 2.0 * vd - vg).r * u_factor.s;
      float dzy = (vg + 2.0 * vh + vi - va - 2.0 * vb - vc).r * u_factor.t;
      float dzd = sqrt(1.0 + dzx * dzx + dzy * dzy);
      float hillshade = 0.0;

      // traditional single light source
      if (u_hillshadeType == 0){
        float cosDelta = u_sinZsinAs[0] * dzy - u_sinZcosAs[0] * dzx;
        float z = (u_cosZs[0] + cosDelta) / dzd;
        if (z < 0.0)  z = 0.0;
        hillshade = z;
      } else {
        // multi-directional with 6 light sources
        for (int k = 0; k < 6; k++) {
        float cosDelta = u_sinZsinAs[k] * dzy - u_sinZcosAs[k] * dzx;
        float z = (u_cosZs[k] + cosDelta) / dzd;
        if (z < 0.0) z = 0.0;
        hillshade = hillshade + z * u_weights[k];
        if (k == 5) break;
        }
      }

      // set color
      float alpha = getNeighborHoodAlpha(va.a, vb.a, vc.a, vd.a, ve.a, vf.a, vg.a, vh.a, vi.a);
      alpha *= u_opacity;
      ${i}
    }
  `)}var p=Object.freeze({__proto__:null,build:l})},fbd0:function(e,t,i){"use strict";i.d(t,"a",(function(){return o}));var r=i("b50f"),a=i("02f1"),n=i("3349"),s=i("34f2");class o extends s["a"]{constructor(e,t,i,r,s,o=0){super(e),this.origin=t,this.axis1=i,this.factor1=r,this.factor2=s,this.accumulationType=o,this.axis2=Object(n["s"])(Object(a["b"])(),i[1],-i[0])}scale(e,t,i){this.helper.scale(e.pos,this.origin,this.axis1,t),this.helper.scale(e.pos,this.origin,this.axis2,i)}apply(e){this.scale(e,this.factor1,this.factor2)}undo(e){this.scale(e,1/this.factor1,1/this.factor2)}canAccumulate(e){return e instanceof o&&Object(r["e"])(this.origin,e.origin)&&Object(r["e"])(this.axis1,e.axis1)}accumulate(e,t){1===t.accumulationType?this.scale(e,t.factor1/this.factor1,t.factor2/this.factor2):this.scale(e,t.factor1,t.factor2)}accumulateParams(e){const t=1===e.accumulationType;this.factor1=t?e.factor1:this.factor1*e.factor1,this.factor2=t?e.factor2:this.factor2*e.factor2}}},fdc9:function(e,t,i){"use strict";i.d(t,"a",(function(){return a})),i.d(t,"b",(function(){return s}));var r=i("8a44");class a{constructor(){this.adds=new r["a"],this.removes=new r["a"],this.updates=new r["a"]({allocator:e=>e||new n,deallocator:e=>(e.renderGeometry=null,e)})}clear(){this.adds.clear(),this.removes.clear(),this.updates.clear()}prune(){this.adds.prune(),this.removes.prune(),this.updates.prune()}}class n{}class s{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array}}},feba:function(e,t,i){"use strict";i.d(t,"a",(function(){return R}));i("c120");var r=i("c649"),a=i("9ef0"),n=i("0b2d"),s=i("e431"),o=i("c9fb"),c=i("6706"),l=i("65a7"),h=i("8f1c"),d=i("b2b2"),u=i("a915"),p=i("af40"),f=i("afe1"),m=i("3349"),b=i("7577"),g=i("5ef2"),v=i("caf7"),y=i("86ba"),O=i("5fae");class _ extends O["a"]{constructor(e){super(e),this._handles=new p["a"],this._location=Object(n["e"])(),this._direction=Object(n["g"])(1,0,0),this._width=1,this._offset=1,this._length=18,this._color=Object(g["c"])(1,0,1,1),this._renderOccluded=4,this.applyProps(e)}get location(){return this._location}set location(e){Object(s["r"])(this._location,e)||(Object(s["l"])(this._location,e),this.updateGeometry())}get direction(){return this._direction}set direction(e){Object(s["r"])(this._direction,e)||(Object(s["l"])(this._direction,e),this.updateGeometry())}setDirectionFromPoints(e,t){Object(s["s"])(this._direction,Object(s["k"])(this._direction,t,e)),this.updateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this.updateMaterial())}get offset(){return this._offset}set offset(e){e!==this._offset&&(this._offset=e,this.updateGeometry())}get length(){return this._length}set length(e){e!==this._length&&(this._length=e,this.updateGeometry())}get color(){return this._color}set color(e){Object(b["g"])(e,this._color)||(Object(b["c"])(this._color,e),this.updateMaterial())}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this.updateMaterial())}createExternalResources(){const e=new y["a"](this.materialParameters);this._handles.add(this.view.state.watch("camera",()=>{this.updateGeometry()})),this._externalResources={material:e}}destroyExternalResources(){this._handles.removeAll(),this._externalResources=null}createGeometries(e){const t=v["a"].createPolylineGeometry([Object(n["e"])(),Object(n["e"])()]),i=v["a"].createPolylineGeometry([Object(n["e"])(),Object(n["e"])()]),r=Object(d["t"])(this._externalResources).material;e.addGeometry(t,r,f["a"]),e.addGeometry(i,r,f["a"]),this.updateVertices(e)}forEachExternalMaterial(e){Object(d["k"])(this._externalResources)&&e(this._externalResources.material)}updateMaterial(){Object(d["j"])(this._externalResources)||this._externalResources.material.setParameterValues(this.materialParameters)}get materialParameters(){return{width:this._width,color:this._color,renderOccluded:this._renderOccluded}}updateGeometry(){const e=this.object;Object(d["j"])(e)||this.updateVertices(e)}updateVertices(e){const t=this.view.state.camera;t.projectToScreen(this.location,j),Object(s["g"])(x,this.location,this.direction),t.projectToScreen(x,w),Object(m["e"])(w,Object(m["d"])(w,w,j)),this.updateVertexAttributes(t,e,0,j,w,1),this.updateVertexAttributes(t,e,1,j,w,-1)}updateVertexAttributes(e,t,i,r,a,n){const s=t.geometryRecords[i].geometry.getMutableAttribute("position").data,o=Object(m["a"])(S,Object(m["s"])(S,a[1]*n,a[0]*-n),this.offset+this.width/2),c=Object(m["h"])(C,Object(m["h"])(C,Object(m["h"])(C,r,Object(m["a"])(C,a,this.length/2)),o),o),l=Object(m["h"])(T,c,Object(m["a"])(T,a,-this.length));e.unprojectFromScreen(c,x),s[0]=x[0],s[1]=x[1],s[2]=x[2],e.unprojectFromScreen(l,x),s[3]=x[0],s[4]=x[1],s[5]=x[2],t.geometryVertexAttrsUpdated(i)}}const x=Object(n["e"])(),j=Object(u["g"])(),w=Object(u["g"])(),S=Object(u["g"])(),C=Object(u["g"])(),T=Object(u["g"])();var P=i("002c"),A=i("45a1");class R extends l["a"]{visualizeIntersectionPoint(e,t){const{coordinateHelper:i,elevationInfo:n,view:s}=t;return Object(r["a"])(new P["a"]({view:s,primitive:"circle",geometry:i.createPoint(e.intersectionPoint),elevationInfo:n,size:20,outlineSize:2,color:[0,0,0,0],outlineColor:a["a"].toUnitRGBA(o["a"].orange),pixelSnappingEnabled:!1}))}visualizePoint(e,t){const{coordinateHelper:i,elevationInfo:n,view:s}=t;return Object(r["a"])(new P["a"]({view:s,primitive:"circle",geometry:i.createPoint(e.point),elevationInfo:n,size:20,outlineSize:2,color:[0,0,0,0],outlineColor:a["a"].toUnitRGBA(o["a"].orange),pixelSnappingEnabled:!1}))}visualizeLine(e,t){const{coordinateHelper:i,elevationInfo:a,view:n}=t;return Object(r["a"])(this.createLineSegmentHintFromMap(e.type,e.lineStart,e.lineEnd,i,a,n,e.fadeLeft,e.fadeRight))}visualizeParallelSign(e,t){const{coordinateHelper:i,elevationInfo:n,view:l}=t,h=Object(c["a"])(e.lineStart,i,n,t.view),d=Object(c["a"])(e.lineEnd,i,n,t.view),u=Object(s["j"])(d,h,d,.5),p=new _({view:l,attached:!1,offset:o["a"].parallelLineHintOffset,length:o["a"].parallelLineHintLength,width:o["a"].parallelLineHintWidth,color:a["a"].toUnitRGBA(o["a"].orange),location:u,renderOccluded:16});return p.setDirectionFromPoints(h,u),p.attached=!0,Object(r["a"])(p)}visualizeRightAngleQuad(e,t){const{coordinateHelper:i,elevationInfo:n,view:s}=t;return Object(r["a"])(new A["a"]({view:s,attached:!0,color:a["a"].toUnitRGBA(o["a"].orange),renderOccluded:2,outlineRenderOccluded:16,outlineColor:a["a"].toUnitRGBA(o["a"].orange),outlineSize:o["a"].rightAngleHintOutlineSize,size:o["a"].rightAngleHintSize,geometry:{previous:Object(c["a"])(e.previousVertex,i,n,s),center:Object(c["a"])(e.centerVertex,i,n,s),next:Object(c["a"])(e.nextVertex,i,n,s)}}))}createLineSegmentHintFromMap(e,t,i,r,a,s,o=!0,l=!0){const h=Object(n["e"])(),d=Object(n["e"])();return Object(c["c"])(t,i,r,a,s,h,d),this.createLineSegmentHint(e,s,h,d,o,l)}createLineSegmentHint(e,t,i,r,n=!0,s=!0){const c=new h["a"]({view:t,extensionType:3,start:i,end:r,color:a["a"].toUnitRGBA(o["a"].orange),renderOccluded:16});switch(e){case 0:c.width=o["a"].lineHintWidthTarget,c.fadedExtensions={start:0,end:o["a"].lineHintFadedExtensions};break;case 2:c.width=o["a"].lineHintWidthReference,c.fadedExtensions={start:0,end:0};break;case 1:c.width=o["a"].lineHintWidthReference,c.fadedExtensions={start:n?o["a"].lineHintFadedExtensions:0,end:s?o["a"].lineHintFadedExtensions:0}}return c.attached=!0,c}}}}]);
//# sourceMappingURL=chunk-7f51cf1f.ed4bb976.js.map